{"pr_number": 3349, "pr_title": "Add gauges for queue channel size", "pr_author": "artembilan", "pr_createdAt": "2020-07-28T15:41:46Z", "pr_url": "https://github.com/spring-projects/spring-integration/pull/3349", "timeline": [{"oid": "558dea45ab3aedfa18acab495b5d755ad74a773c", "url": "https://github.com/spring-projects/spring-integration/commit/558dea45ab3aedfa18acab495b5d755ad74a773c", "message": "Add gauges for queue channel size\n\nThe `QueueChannel` provides a current size and remaining capacity metrics\n\n* Add Micrometer gauges into `QueueChannel` to expose the current values\nof the size and remaining capacity\n\n**Cherry-pick to 5.3.x, 5.2.x & 5.1.x**", "committedDate": "2020-07-28T15:41:21Z", "type": "commit"}, {"oid": "e14ef35f101d8189dc6af37e0fefb8bf371dc579", "url": "https://github.com/spring-projects/spring-integration/commit/e14ef35f101d8189dc6af37e0fefb8bf371dc579", "message": "* Revert `@SuppressWarnings(\"unchecked\")` for test\n* Document new gauges for queue channel", "committedDate": "2020-07-28T16:21:56Z", "type": "commit"}, {"oid": "101387132c2056b3a1b3af7fa32cd000330de165", "url": "https://github.com/spring-projects/spring-integration/commit/101387132c2056b3a1b3af7fa32cd000330de165", "message": "* Fix IntegrationManagementConfigurer for NPE on `metricsCaptor`", "committedDate": "2020-07-28T19:42:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1NDAzNA==", "url": "https://github.com/spring-projects/spring-integration/pull/3349#discussion_r461854034", "body": "```suggestion\r\n\t\t\t\t\t\t.description(\"The remaining capacity of the queue channel\")\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t.description(\"The remaining.capacity of queue channel\")\n          \n          \n            \n            \t\t\t\t\t\t.description(\"The remaining capacity of the queue channel\")", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t\t\t\t\t.description(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The remaining<span class=\"x x-first x-last\">.</span>capacity of queue channel<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t\t\t\t\t.description(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The remaining<span class=\"x x-first x-last\"> </span>capacity of<span class=\"x x-first x-last\"> the</span> queue channel<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "micheljung", "createdAt": "2020-07-28T20:19:58Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java", "diffHunk": "@@ -79,6 +87,26 @@ public QueueChannel() {\n \t\tthis(new LinkedBlockingQueue<>());\n \t}\n \n+\t@Override\n+\tpublic void registerMetricsCaptor(MetricsCaptor metricsCaptor) {\n+\t\tsuper.registerMetricsCaptor(metricsCaptor);\n+\t\tthis.sizeGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.size\", this,\n+\t\t\t\t\t\t(channel) -> getQueueSize())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The size of queue channel\")\n+\t\t\t\t\t\t.build();\n+\n+\t\tthis.remainingCapacityGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.remaining.capacity\", this,\n+\t\t\t\t\t\t(channel) -> getRemainingCapacity())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The remaining.capacity of queue channel\")", "originalCommit": "101387132c2056b3a1b3af7fa32cd000330de165", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1NTMzMw==", "url": "https://github.com/spring-projects/spring-integration/pull/3349#discussion_r461855333", "body": "```suggestion\r\n\t\t\t\t\t\t.description(\"The size of the queue channel\")\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t.description(\"The size of queue channel\")\n          \n          \n            \n            \t\t\t\t\t\t.description(\"The size of the queue channel\")", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t\t\t\t\t.description(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The size of queue channel<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t\t\t\t\t.description(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The size of <span class=\"x x-first x-last\">the </span>queue channel<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "artembilan", "createdAt": "2020-07-28T20:22:31Z", "path": "spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java", "diffHunk": "@@ -79,6 +87,26 @@ public QueueChannel() {\n \t\tthis(new LinkedBlockingQueue<>());\n \t}\n \n+\t@Override\n+\tpublic void registerMetricsCaptor(MetricsCaptor metricsCaptor) {\n+\t\tsuper.registerMetricsCaptor(metricsCaptor);\n+\t\tthis.sizeGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.size\", this,\n+\t\t\t\t\t\t(channel) -> getQueueSize())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The size of queue channel\")", "originalCommit": "101387132c2056b3a1b3af7fa32cd000330de165", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "79038289ab4bc2e0baaff68b8c98def825129a30", "url": "https://github.com/spring-projects/spring-integration/commit/79038289ab4bc2e0baaff68b8c98def825129a30", "message": "Fix wording in meter descriptions\n\nCo-authored-by: Michel Jung <michel.jung89@gmail.com>", "committedDate": "2020-07-28T20:23:05Z", "type": "commit"}]}