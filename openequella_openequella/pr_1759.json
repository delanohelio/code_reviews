{"pr_number": 1759, "pr_title": "Simplify VisibilityScriptingBugTest and add test retries to TestNG tests", "pr_author": "SammyIsConfused", "pr_createdAt": "2020-05-25T03:10:45Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/1759", "timeline": [{"oid": "1ee5de7b023949fe9fc2f4afc873b07693e61987", "url": "https://github.com/openequella/openEQUELLA/commit/1ee5de7b023949fe9fc2f4afc873b07693e61987", "message": "Revert \"Update vanilla institution to support the new test\"\n\nThis reverts commit 808ed8a9cc1c11df05065416523334bce18c3e5a.", "committedDate": "2020-05-25T00:27:30Z", "type": "commit"}, {"oid": "eed28eade0d1feaa5776c6a2483d7da141c90376", "url": "https://github.com/openequella/openEQUELLA/commit/eed28eade0d1feaa5776c6a2483d7da141c90376", "message": "Only modify the necessary files within vanilla institution to work the test", "committedDate": "2020-05-25T01:16:33Z", "type": "commit"}, {"oid": "9650f8003a7687ef86d0bc4702a2630cdd165288", "url": "https://github.com/openequella/openEQUELLA/commit/9650f8003a7687ef86d0bc4702a2630cdd165288", "message": "Simplify the test\n\nOnly use one control for testing - the name control.", "committedDate": "2020-05-25T01:17:10Z", "type": "commit"}, {"oid": "015b3cd51b32b012a4578b6c7f003d3a0e9fb567", "url": "https://github.com/openequella/openEQUELLA/commit/015b3cd51b32b012a4578b6c7f003d3a0e9fb567", "message": "Add new annotation MaxRetryCount", "committedDate": "2020-05-25T02:52:05Z", "type": "commit"}, {"oid": "0acdccca08c1accfdedda6d382ddc1feaef82c5d", "url": "https://github.com/openequella/openEQUELLA/commit/0acdccca08c1accfdedda6d382ddc1feaef82c5d", "message": "Add new RetryAnalyzer and TestAnnotationTransformer\n\nIncludes logging of retry information. (max number of retries,\ncurrent retry, stacktrace of the failure that caused the retry)", "committedDate": "2020-05-25T02:53:51Z", "type": "commit"}, {"oid": "3cceb67a1afea37c171d52f3e8952e0fe4347ccf", "url": "https://github.com/openequella/openEQUELLA/commit/3cceb67a1afea37c171d52f3e8952e0fe4347ccf", "message": "Add retry listener to textng.xml", "committedDate": "2020-05-25T02:54:34Z", "type": "commit"}, {"oid": "795bce714015ae2f0b3e7fc9eea79bb7479d70d9", "url": "https://github.com/openequella/openEQUELLA/commit/795bce714015ae2f0b3e7fc9eea79bb7479d70d9", "message": "Add retries to VisibilityScriptingBugTest.java", "committedDate": "2020-05-25T02:54:53Z", "type": "commit"}, {"oid": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "url": "https://github.com/openequella/openEQUELLA/commit/ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "message": "Set default vanilla institution UI mode to false", "committedDate": "2020-05-25T04:24:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNDYzMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429734631", "body": "How about a default of 3?\r\n\r\nSeems odd to have 0 for a Max.\r\n\r\nOr should we have a DefaultRetry annotation that stacks on this and has the value as zero?", "bodyText": "How about a default of 3?\nSeems odd to have 0 for a Max.\nOr should we have a DefaultRetry annotation that stacks on this and has the value as zero?", "bodyHTML": "<p dir=\"auto\">How about a default of 3?</p>\n<p dir=\"auto\">Seems odd to have 0 for a Max.</p>\n<p dir=\"auto\">Or should we have a DefaultRetry annotation that stacks on this and has the value as zero?</p>", "author": "edalex-ian", "createdAt": "2020-05-25T05:16:54Z", "path": "autotest/OldTests/src/test/java/retry/MaxRetryCount.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package retry;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface MaxRetryCount {\n+  int value() default 0;", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc3OTk4MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429779981", "bodyText": "I'll rename this to RetryTest with a default of three.\n@RetryTest would just give the default.\n@RetryTest(5) would override that.", "author": "SammyIsConfused", "createdAt": "2020-05-25T07:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNDYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNDcyMw==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429734723", "body": "5 seems rather high. 3?", "bodyText": "5 seems rather high. 3?", "bodyHTML": "<p dir=\"auto\">5 seems rather high. 3?</p>", "author": "edalex-ian", "createdAt": "2020-05-25T05:17:21Z", "path": "autotest/OldTests/src/test/java/com/tle/webtests/test/contribute/bugs/VisibilityScriptingBugTest.java", "diffHunk": "@@ -27,23 +26,11 @@\n   private static final String COLLECTION = \"Test Wizard Issue\";\n   private static final String ITEM_NAME = \"VisibilityScriptingBugTest - Lost Metadata Test Item 1\";\n \n-  private static final Date DATE = new Date(1589256742342L);\n-  private static final String DATE_AS_STRING = new SimpleDateFormat(\"yyyy-MM-dd\").format(DATE);\n+  private static final String RADIO = \"Yes\";\n \n-  private static final String CHECKBOX = \"one\";\n-  private static final String DROPDOWN = \"List 2\";\n-  private static final String EMAIL = \"test@test.com\";\n-  private static final String ROLE = \"System Administrator\";\n-\n-  private static final String RADIO1 = \"Radio 1\";\n-  private static final String RADIO2 = \"Yes\";\n-  private static final String SHUFFLE1 = \"Shuffle 1\";\n-  private static final String SHUFFLE2 = \"Shuffle 2\";\n-\n-  private static final String XML_PATH = \"item/itembody/\";\n-  private static final String ROLE_ID = \"ROLE_SYSTEM_ADMINISTRATOR\";\n-  private static final String USER_ID = \"4026b550-9a1f-4521-9b56-9ec737c02526\";\n+  private static final String XML_PATH = \"item/\";\n \n+  @MaxRetryCount(5)", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNTQ5NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429735495", "body": "Is this required? If so, does that mean this is instantiated as a singleton? If so, does that mean we have concurrency issues with this?", "bodyText": "Is this required? If so, does that mean this is instantiated as a singleton? If so, does that mean we have concurrency issues with this?", "bodyHTML": "<p dir=\"auto\">Is this required? If so, does that mean this is instantiated as a singleton? If so, does that mean we have concurrency issues with this?</p>", "author": "edalex-ian", "createdAt": "2020-05-25T05:21:37Z", "path": "autotest/OldTests/src/test/java/retry/FailureRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package retry;\n+\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestResult;\n+\n+public class FailureRetryAnalyzer implements IRetryAnalyzer {\n+  int currentRetry = 0;\n+  Logger LOGGER = Logger.getLogger(FailureRetryAnalyzer.class.getName());\n+\n+  @Override\n+  public boolean retry(ITestResult result) {\n+    MaxRetryCount failureRetryCount =\n+        result.getMethod().getConstructorOrMethod().getMethod().getAnnotation(MaxRetryCount.class);\n+    int maxRetryCount = (failureRetryCount == null) ? 0 : failureRetryCount.value();\n+    if (++currentRetry > maxRetryCount) {\n+      currentRetry = 0;", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0NDM4NA==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429744384", "bodyText": "I don't think it's required. Each individual test that requires one instantiates a FailureRetryAnalyzer of its own.", "author": "SammyIsConfused", "createdAt": "2020-05-25T05:59:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNTQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2MTE2NA==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429761164", "bodyText": "Phew, in that case might as well drop it.", "author": "edalex-ian", "createdAt": "2020-05-25T06:55:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNTQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjIwNw==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429736207", "body": "```suggestion\r\n    LOGGER.warning(result.getThrowable().getMessage(), result.getThrowable());\r\n```\r\n\r\nor can you\r\n\r\n```suggestion\r\n    LOGGER.warning(result.getThrowable());\r\n```\r\n\r\nActually, do we even need to log this? Seems excessively verbose.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOGGER.log(Level.WARNING, result.getThrowable().getMessage(), result.getThrowable());\n          \n          \n            \n                LOGGER.warning(result.getThrowable().getMessage(), result.getThrowable());\n          \n      \n    \n    \n  \n\nor can you\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOGGER.log(Level.WARNING, result.getThrowable().getMessage(), result.getThrowable());\n          \n          \n            \n                LOGGER.warning(result.getThrowable());\n          \n      \n    \n    \n  \n\nActually, do we even need to log this? Seems excessively verbose.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span><span class=\"x x-first\">log(</span><span class=\"pl-smi x\">Level</span><span class=\"pl-c1\"><span class=\"pl-k x\">.</span><span class=\"x\">WARNING</span></span><span class=\"x x-last\">, </span>result<span class=\"pl-k\">.</span>getThrowable()<span class=\"pl-k\">.</span>getMessage(), result<span class=\"pl-k\">.</span>getThrowable());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">warning(</span>result<span class=\"pl-k\">.</span>getThrowable()<span class=\"pl-k\">.</span>getMessage(), result<span class=\"pl-k\">.</span>getThrowable());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">or can you</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span><span class=\"x x-first\">log(</span><span class=\"pl-smi x\">Level</span><span class=\"pl-c1\"><span class=\"pl-k x\">.</span><span class=\"x\">WARNING</span></span><span class=\"x\">, result</span><span class=\"pl-k x\">.</span><span class=\"x\">getThrowable()</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getMessage(), </span>result<span class=\"pl-k\">.</span>getThrowable());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">warning(</span>result<span class=\"pl-k\">.</span>getThrowable());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Actually, do we even need to log this? Seems excessively verbose.</p>", "author": "edalex-ian", "createdAt": "2020-05-25T05:25:05Z", "path": "autotest/OldTests/src/test/java/retry/FailureRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package retry;\n+\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestResult;\n+\n+public class FailureRetryAnalyzer implements IRetryAnalyzer {\n+  int currentRetry = 0;\n+  Logger LOGGER = Logger.getLogger(FailureRetryAnalyzer.class.getName());\n+\n+  @Override\n+  public boolean retry(ITestResult result) {\n+    MaxRetryCount failureRetryCount =\n+        result.getMethod().getConstructorOrMethod().getMethod().getAnnotation(MaxRetryCount.class);\n+    int maxRetryCount = (failureRetryCount == null) ? 0 : failureRetryCount.value();\n+    if (++currentRetry > maxRetryCount) {\n+      currentRetry = 0;\n+      return false;\n+    } else {\n+      logRetryInfo(result, maxRetryCount);\n+      return true;\n+    }\n+  }\n+\n+  private void logRetryInfo(ITestResult result, int maxRetryCount) {\n+    LOGGER.warning(\"Test with retry analyser failed.\\n\\n\");\n+    // print failure stack trace\n+    LOGGER.log(Level.WARNING, result.getThrowable().getMessage(), result.getThrowable());", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MzMyNg==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429743326", "bodyText": "Your suggestion will not work.\nLOGGER.warning() helper function doesn't have a stack trace method like LOGGER.error does. In order to get a stack trace, and a warning label, you must LOGGER.log(level, message, throwable)", "author": "SammyIsConfused", "createdAt": "2020-05-25T05:56:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MzY3NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429743675", "bodyText": "The purpose here was so that when a TestNG method fails and retries, the initial failure will still log a stack trace.", "author": "SammyIsConfused", "createdAt": "2020-05-25T05:56:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0Njg1OA==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429746858", "bodyText": "Your suggestion will not work.\n\nYup, as it appears we're not using log4j, just vanilla JRE logging. We should be using log4j\n\nThe purpose here was so that when a TestNG method fails and retries, the initial failure will still log a stack trace.\n\nBut what does that offer when we already have the report that test t from class c is retrying? We don't want our logs for testing even more verbose unless it serves a purpose.", "author": "edalex-ian", "createdAt": "2020-05-25T06:08:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0Nzg5NA==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429747894", "bodyText": "The idea I had for that is that if some test is flakey, we can look into why it was breaking without letting it fail the whole run. But if you don't think that's worthwhile I'm happy to remove it.", "author": "SammyIsConfused", "createdAt": "2020-05-25T06:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjIwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc2MDkyNw==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429760927", "bodyText": "Okay, so as discussed just now, this is to capture initial details of a test that eventually passes but we may want to go back at a later date an look into the flakiness.\nSeeing this would really be the exception to the norm, let's log the stacktrace at 'debug' once the logger is changed over to log4j.", "author": "edalex-ian", "createdAt": "2020-05-25T06:54:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjIwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjQ2Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429736466", "body": "This message is kind of redundant isn't it?", "bodyText": "This message is kind of redundant isn't it?", "bodyHTML": "<p dir=\"auto\">This message is kind of redundant isn't it?</p>", "author": "edalex-ian", "createdAt": "2020-05-25T05:26:20Z", "path": "autotest/OldTests/src/test/java/retry/FailureRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package retry;\n+\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestResult;\n+\n+public class FailureRetryAnalyzer implements IRetryAnalyzer {\n+  int currentRetry = 0;\n+  Logger LOGGER = Logger.getLogger(FailureRetryAnalyzer.class.getName());\n+\n+  @Override\n+  public boolean retry(ITestResult result) {\n+    MaxRetryCount failureRetryCount =\n+        result.getMethod().getConstructorOrMethod().getMethod().getAnnotation(MaxRetryCount.class);\n+    int maxRetryCount = (failureRetryCount == null) ? 0 : failureRetryCount.value();\n+    if (++currentRetry > maxRetryCount) {\n+      currentRetry = 0;\n+      return false;\n+    } else {\n+      logRetryInfo(result, maxRetryCount);\n+      return true;\n+    }\n+  }\n+\n+  private void logRetryInfo(ITestResult result, int maxRetryCount) {\n+    LOGGER.warning(\"Test with retry analyser failed.\\n\\n\");", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MjU3MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429742571", "bodyText": "This was just for logging purposes - without this it would go straight to the stack trace, and that could potentially look too similar to a standard failed test.", "author": "SammyIsConfused", "createdAt": "2020-05-25T05:53:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MzAxOA==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429743018", "bodyText": "Gotcha. Well, let's remove this and the stack trace.", "author": "edalex-ian", "createdAt": "2020-05-25T05:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjk2Mw==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429736963", "body": "Does this get called before the first test run, of before the first retry?\r\n\r\n(As we don't want any log message for a single successful run.)", "bodyText": "Does this get called before the first test run, of before the first retry?\n(As we don't want any log message for a single successful run.)", "bodyHTML": "<p dir=\"auto\">Does this get called before the first test run, of before the first retry?</p>\n<p dir=\"auto\">(As we don't want any log message for a single successful run.)</p>", "author": "edalex-ian", "createdAt": "2020-05-25T05:28:46Z", "path": "autotest/OldTests/src/test/java/retry/FailureRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package retry;\n+\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import org.testng.IRetryAnalyzer;\n+import org.testng.ITestResult;\n+\n+public class FailureRetryAnalyzer implements IRetryAnalyzer {\n+  int currentRetry = 0;\n+  Logger LOGGER = Logger.getLogger(FailureRetryAnalyzer.class.getName());\n+\n+  @Override\n+  public boolean retry(ITestResult result) {\n+    MaxRetryCount failureRetryCount =\n+        result.getMethod().getConstructorOrMethod().getMethod().getAnnotation(MaxRetryCount.class);\n+    int maxRetryCount = (failureRetryCount == null) ? 0 : failureRetryCount.value();\n+    if (++currentRetry > maxRetryCount) {\n+      currentRetry = 0;\n+      return false;\n+    } else {\n+      logRetryInfo(result, maxRetryCount);", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MjI1NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429742255", "bodyText": "this gets called after a run that has @MaxRetryCount annotation fails, before it retries.", "author": "SammyIsConfused", "createdAt": "2020-05-25T05:52:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MjgzMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429742831", "bodyText": "Cool. \ud83d\udc4d", "author": "edalex-ian", "createdAt": "2020-05-25T05:55:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNjk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczNzUyNg==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429737526", "body": "```suggestion\r\n    if (maxRetryCount == null && maxRetryCount.value() < 1) return;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (maxRetryCount == null) return;\n          \n          \n            \n                if (maxRetryCount == null && maxRetryCount.value() < 1) return;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">if</span> (maxRetryCount <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span>) <span class=\"pl-k\">return</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (maxRetryCount <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span><span class=\"x x-first\"> </span><span class=\"pl-k x\">&amp;&amp;</span><span class=\"x\"> maxRetryCount</span><span class=\"pl-k x\">.</span><span class=\"x\">value() </span><span class=\"pl-k x\">&lt;</span><span class=\"x\"> </span><span class=\"pl-c1 x x-last\">1</span>) <span class=\"pl-k\">return</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "edalex-ian", "createdAt": "2020-05-25T05:31:31Z", "path": "autotest/OldTests/src/test/java/retry/TestAnnotationTransformer.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package retry;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Method;\n+import org.testng.IAnnotationTransformer;\n+import org.testng.annotations.ITestAnnotation;\n+\n+public class TestAnnotationTransformer implements IAnnotationTransformer {\n+\n+  @Override\n+  public void transform(\n+      ITestAnnotation annotation, Class testClass, Constructor testConstructor, Method testMethod) {\n+    if (testMethod == null) return;\n+    MaxRetryCount maxRetryCount = testMethod.getAnnotation(MaxRetryCount.class);\n+    if (maxRetryCount == null) return;", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczODE4MQ==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429738181", "body": "Do we have the log4j framework overhere? (Or Slf4j?)", "bodyText": "Do we have the log4j framework overhere? (Or Slf4j?)", "bodyHTML": "<p dir=\"auto\">Do we have the log4j framework overhere? (Or Slf4j?)</p>", "author": "edalex-ian", "createdAt": "2020-05-25T05:34:44Z", "path": "autotest/OldTests/src/test/java/retry/FailureRetryAnalyzer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package retry;\n+\n+import java.util.logging.Level;\n+import java.util.logging.Logger;", "originalCommit": "ae9cc2b695f10982b70c5609a5ea7bc5f1d8be57", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc4MTg2Ng==", "url": "https://github.com/openequella/openEQUELLA/pull/1759#discussion_r429781866", "bodyText": "Changed over to slf4j.", "author": "SammyIsConfused", "createdAt": "2020-05-25T07:44:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTczODE4MQ=="}], "type": "inlineReview"}, {"oid": "2380bca4c66cef24f82775c79b81002ea73ec945", "url": "https://github.com/openequella/openEQUELLA/commit/2380bca4c66cef24f82775c79b81002ea73ec945", "message": "Add back items and acls related to DRMPrivilegeTest", "committedDate": "2020-05-25T07:22:32Z", "type": "commit"}, {"oid": "c64d70ade595f5717aa6ecfc9da1ba3ca7fd2584", "url": "https://github.com/openequella/openEQUELLA/commit/c64d70ade595f5717aa6ecfc9da1ba3ca7fd2584", "message": "Use slf4j rather than standard logger", "committedDate": "2020-05-25T07:30:42Z", "type": "commit"}, {"oid": "66dc390d03c1c454a8a286762c9188485ce78a49", "url": "https://github.com/openequella/openEQUELLA/commit/66dc390d03c1c454a8a286762c9188485ce78a49", "message": "Rename MaxRetryCount.java annotation to RetryTest.java\n\nMakes more sense when used - add @RetryTest to a test\nmethod for a default 3 retries.", "committedDate": "2020-05-25T07:38:33Z", "type": "commit"}, {"oid": "30a46706a1296b3bc52d1e37009d8ccb32292eb0", "url": "https://github.com/openequella/openEQUELLA/commit/30a46706a1296b3bc52d1e37009d8ccb32292eb0", "message": "Remove currentRetry reset", "committedDate": "2020-05-25T07:46:23Z", "type": "commit"}, {"oid": "9bed610a4cf6023e80e1aeb504dcf3e404b650d5", "url": "https://github.com/openequella/openEQUELLA/commit/9bed610a4cf6023e80e1aeb504dcf3e404b650d5", "message": "Handle RetryTest(0) as an annotation\n\nSimply gets ignored.", "committedDate": "2020-05-25T07:48:25Z", "type": "commit"}, {"oid": "4de0eb372fa5c0e6d28401915c8cad23b92b698b", "url": "https://github.com/openequella/openEQUELLA/commit/4de0eb372fa5c0e6d28401915c8cad23b92b698b", "message": "Add back resources in vanilla institution required for other tests\n\nNamely FavouriteItemsTest, PortalTest and TokenLoginTest.", "committedDate": "2020-05-26T01:41:17Z", "type": "commit"}]}