{"pr_number": 1141, "pr_title": "Add error tag to spans for Jaeger exporter", "pr_author": "sleighzy", "pr_createdAt": "2020-04-25T09:01:27Z", "pr_url": "https://github.com/open-telemetry/opentelemetry-java/pull/1141", "timeline": [{"oid": "dfd47f8db800cb05a88b4e9d9d0a7069afcffda7", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/dfd47f8db800cb05a88b4e9d9d0a7069afcffda7", "message": "Add error tag to spans for Jaeger exporter\n\nThe auto-instrumentation libraries add errors to the spans when they occur. The error tag is not added to the spans by the Jaeger exporter if the span status is not OK.\nWhen sending these spans to the OpenTelemetry Collector it will add the error tag when it translates them and sends them to the Jaeger collector. This process does not\ntake place when sending spans directly to a Jaeger collector (not using the OTel collector) and so the Jaeger UI does not display visual indicators for spans with errors.\nAdding the error tag in the adapter if the span.status.code is not OK, and this tag hasn't already been set, means that it will be present when using either the OTel collector\nor the Jaeger collector directly. The Otel collector will remove this tag automatically when it receives the span and sets the status code so this will not be sent as a duplicate.", "committedDate": "2020-04-25T05:34:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNDE4Mg==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1141#discussion_r415134182", "body": "```suggestion\r\n    if (!span.getStatus().isOk()) {\r\n```\r\nI think it may be more important that the jaeger `error` tag always maps to span status, than preserve an attribute named `error` that the user may set on the span.\r\n\r\nUnfortunately, we don't have a spec to resolve this kind of thing yet (see https://github.com/open-telemetry/opentelemetry-specification/issues/414), but that issue does reference the python implementation, and I think this is how they've implemented it (+/- my python reading skill).", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!span.getStatus().isOk() && !span.getAttributes().containsKey(KEY_ERROR)) {\n          \n          \n            \n                if (!span.getStatus().isOk()) {\n          \n      \n    \n    \n  \n\nI think it may be more important that the jaeger error tag always maps to span status, than preserve an attribute named error that the user may set on the span.\nUnfortunately, we don't have a spec to resolve this kind of thing yet (see open-telemetry/opentelemetry-specification#414), but that issue does reference the python implementation, and I think this is how they've implemented it (+/- my python reading skill).", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>span<span class=\"pl-k\">.</span>getStatus()<span class=\"pl-k\">.</span>isOk()<span class=\"x x-first\"> </span><span class=\"pl-k x\">&amp;&amp;</span><span class=\"x\"> </span><span class=\"pl-k x\">!</span><span class=\"x\">span</span><span class=\"pl-k x\">.</span><span class=\"x\">getAttributes()</span><span class=\"pl-k x\">.</span><span class=\"x\">containsKey(</span><span class=\"pl-c1 x\">KEY_ERROR</span><span class=\"x x-last\">)</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>span<span class=\"pl-k\">.</span>getStatus()<span class=\"pl-k\">.</span>isOk()) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I think it may be more important that the jaeger <code>error</code> tag always maps to span status, than preserve an attribute named <code>error</code> that the user may set on the span.</p>\n<p dir=\"auto\">Unfortunately, we don't have a spec to resolve this kind of thing yet (see <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"552392393\" data-permission-text=\"Title is private\" data-url=\"https://github.com/open-telemetry/opentelemetry-specification/issues/414\" data-hovercard-type=\"issue\" data-hovercard-url=\"/open-telemetry/opentelemetry-specification/issues/414/hovercard\" href=\"https://github.com/open-telemetry/opentelemetry-specification/issues/414\">open-telemetry/opentelemetry-specification#414</a>), but that issue does reference the python implementation, and I think this is how they've implemented it (+/- my python reading skill).</p>", "author": "trask", "createdAt": "2020-04-25T20:07:07Z", "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -111,6 +112,10 @@ private Adapter() {}\n             .setVType(Model.ValueType.INT64)\n             .build());\n \n+    if (!span.getStatus().isOk() && !span.getAttributes().containsKey(KEY_ERROR)) {", "originalCommit": "dfd47f8db800cb05a88b4e9d9d0a7069afcffda7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTE1OTExNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1141#discussion_r415159115", "bodyText": "You are correct @trask, we don't want to add new semantic conventions for Jaeger only.", "author": "bogdandrutu", "createdAt": "2020-04-25T22:37:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNDE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTIyMjMzMw==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1141#discussion_r415222333", "bodyText": "The logic there should be based on the span status as per the suggested change. The additional check was just because it is possible to add duplicate Model.KeyValue entries as it is a List, unlike the attributes Map that it is built from. I'll accept your suggested changes as the Otel Collector and Jaeger appear to accept this behaviour without failure. Thanks for that.", "author": "sleighzy", "createdAt": "2020-04-26T05:37:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNDE4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM1NzkzNQ==", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1141#discussion_r415357935", "bodyText": "Btw, thanks @sleighzy for all of the auto-instrumentation related testing you've been doing!", "author": "trask", "createdAt": "2020-04-26T17:23:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNDE4Mg=="}], "type": "inlineReview"}, {"oid": "d42c2629b6fb3d4ce1e511454c8e853403cecec7", "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d42c2629b6fb3d4ce1e511454c8e853403cecec7", "message": "Remove additional attribute check in span status condition\n\nCo-Authored-By: Trask Stalnaker <trask.stalnaker@gmail.com>", "committedDate": "2020-04-26T05:37:54Z", "type": "commit"}]}