{"pr_number": 7302, "pr_title": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods acro\u2026", "pr_author": "martin-kanis", "pr_createdAt": "2020-07-29T13:10:02Z", "pr_url": "https://github.com/keycloak/keycloak/pull/7302", "timeline": [{"oid": "74b7fbc22b2aead8013202c76b347c1231ae4ad8", "url": "https://github.com/keycloak/keycloak/commit/74b7fbc22b2aead8013202c76b347c1231ae4ad8", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-07-30T07:58:09Z", "type": "forcePushed"}, {"oid": "dd088fc7c63bb0064ec41285b5fffa5bcc50ecc7", "url": "https://github.com/keycloak/keycloak/commit/dd088fc7c63bb0064ec41285b5fffa5bcc50ecc7", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-07-30T14:27:34Z", "type": "forcePushed"}, {"oid": "5a3cfd0c08455f4f50f15fea3adf98cb138934c8", "url": "https://github.com/keycloak/keycloak/commit/5a3cfd0c08455f4f50f15fea3adf98cb138934c8", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-07-31T06:24:37Z", "type": "forcePushed"}, {"oid": "9f48916752c48aff5bbbfcb52dc8236b2d41c78d", "url": "https://github.com/keycloak/keycloak/commit/9f48916752c48aff5bbbfcb52dc8236b2d41c78d", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-07-31T15:25:11Z", "type": "forcePushed"}, {"oid": "6a549eee6b1e8e2c0b188bd52a24c047b0ecc209", "url": "https://github.com/keycloak/keycloak/commit/6a549eee6b1e8e2c0b188bd52a24c047b0ecc209", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-08-04T11:47:53Z", "type": "forcePushed"}, {"oid": "fc0c2cc17ab655db5a7834f64e5f9a2b9e751bfd", "url": "https://github.com/keycloak/keycloak/commit/fc0c2cc17ab655db5a7834f64e5f9a2b9e751bfd", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-08-04T12:47:01Z", "type": "forcePushed"}, {"oid": "478c6d87e91dd557920e842f7af7a95634c9c5e6", "url": "https://github.com/keycloak/keycloak/commit/478c6d87e91dd557920e842f7af7a95634c9c5e6", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-08-10T12:05:53Z", "type": "forcePushed"}, {"oid": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "url": "https://github.com/keycloak/keycloak/commit/a20d0ef10d44f94262abb9d4c613902d84cdec80", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-08-18T13:33:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ2MzE1NA==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r472463154", "body": "```suggestion\r\n                        .forEach(c -> {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    .peek(c -> {\n          \n          \n            \n                                    .forEach(c -> {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        .<span class=\"x x-first x-last\">peek</span>(c <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        .<span class=\"x x-first x-last\">forEach</span>(c <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hmlnarik", "createdAt": "2020-08-18T20:20:11Z", "path": "server-spi-private/src/main/java/org/keycloak/migration/migrators/MigrateTo4_0_0.java", "diffHunk": "@@ -94,40 +94,40 @@ protected void migrateRealm(KeycloakSession session, RealmModel realm, boolean j\n         // If client has scope for offline_access role (either directly or through fullScopeAllowed), then add offline_access client\n         // scope as optional scope to the client. If it's indirectly (no fullScopeAllowed), then remove role from the scoped roles\n         RoleModel offlineAccessRole = realm.getRole(OAuth2Constants.OFFLINE_ACCESS);\n-        ClientScopeModel offlineAccessScope = null;\n+        ClientScopeModel offlineAccessScope;\n         if (offlineAccessRole == null) {\n             LOG.infof(\"Role 'offline_access' not available in realm '%s'. Skip migration of offline_access client scope.\", realm.getName());\n         } else {\n             offlineAccessScope = KeycloakModelUtils.getClientScopeByName(realm, OAuth2Constants.OFFLINE_ACCESS);\n             if (offlineAccessScope == null) {\n                 LOG.infof(\"Client scope 'offline_access' not available in realm '%s'. Skip migration of offline_access client scope.\", realm.getName());\n             } else {\n-                for (ClientModel client : realm.getClients()) {\n-                    if (\"openid-connect\".equals(client.getProtocol())\n-                            && !client.isBearerOnly()\n-                            && client.hasScope(offlineAccessRole)\n-                            && !client.getClientScopes(false, true).containsKey(OAuth2Constants.OFFLINE_ACCESS)) {\n-                        LOG.debugf(\"Adding client scope 'offline_access' as optional scope to client '%s' in realm '%s'.\", client.getClientId(), realm.getName());\n-                        client.addClientScope(offlineAccessScope, false);\n-\n-                        if (!client.isFullScopeAllowed()) {\n-                            LOG.debugf(\"Removing role scope mapping for role 'offline_access' from client '%s' in realm '%s'.\", client.getClientId(), realm.getName());\n-                            client.deleteScopeMapping(offlineAccessRole);\n-                        }\n-                    }\n-                }\n+                session.clients().getClientsStream(realm)\n+                        .filter(MigrationUtils::isOIDCNonBearerOnlyClient)\n+                        .filter(c -> c.hasScope(offlineAccessRole))\n+                        .filter(c -> !c.getClientScopes(false, true).containsKey(OAuth2Constants.OFFLINE_ACCESS))\n+                        .peek(c -> {\n+                            LOG.debugf(\"Adding client scope 'offline_access' as optional scope to client '%s' in realm '%s'.\", c.getClientId(), realm.getName());\n+                            c.addClientScope(offlineAccessScope, false);\n+                        })\n+                        .filter(c -> !c.isFullScopeAllowed())\n+                        .peek(c -> {", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ3MDU5MQ==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r472470591", "body": "```suggestion\r\n        return role.map(RoleModel::getId).orElse(null);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (role.isPresent()) {\n          \n          \n            \n                        return role.get().getId();\n          \n          \n            \n                    }\n          \n          \n            \n                    return null;\n          \n          \n            \n                    return role.map(RoleModel::getId).orElse(null);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (role<span class=\"pl-k\">.</span>isPresent()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">return</span> role<span class=\"pl-k\">.</span>get()<span class=\"pl-k\">.</span>getId();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> role<span class=\"pl-k\">.</span>map(<span class=\"pl-smi\">RoleModel</span><span class=\"pl-k\">::</span>getId)<span class=\"pl-k\">.</span>orElse(<span class=\"pl-c1\">null</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hmlnarik", "createdAt": "2020-08-18T20:28:00Z", "path": "services/src/main/java/org/keycloak/partialimport/RealmRolesPartialImport.java", "diffHunk": "@@ -56,20 +58,17 @@ public String getName(RoleRepresentation roleRep) {\n \n     @Override\n     public String getModelId(RealmModel realm, KeycloakSession session, RoleRepresentation roleRep) {\n-        for (RoleModel role : realm.getRoles()) {\n-            if (getName(roleRep).equals(role.getName())) return role.getId();\n-        }\n+        Optional<RoleModel> role = realm.getRolesStream().filter(r -> Objects.equals(getName(roleRep), r.getName())).findFirst();\n \n+        if (role.isPresent()) {\n+            return role.get().getId();\n+        }\n         return null;", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0MzgwMQ==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r473043801", "body": "Can this be broken down to remove dependency on offlineClients and extracted to a named method rather than anonymous method?", "bodyText": "Can this be broken down to remove dependency on offlineClients and extracted to a named method rather than anonymous method?", "bodyHTML": "<p dir=\"auto\">Can this be broken down to remove dependency on offlineClients and extracted to a named method rather than anonymous method?</p>", "author": "hmlnarik", "createdAt": "2020-08-19T13:49:16Z", "path": "services/src/main/java/org/keycloak/services/resources/admin/UserResource.java", "diffHunk": "@@ -465,40 +465,39 @@ public void removeFederatedIdentity(final @PathParam(\"provider\") String provider\n     @Produces(MediaType.APPLICATION_JSON)\n     public List<Map<String, Object>> getConsents() {\n         auth.users().requireView(user);\n-        List<Map<String, Object>> result = new LinkedList<>();\n \n         Set<ClientModel> offlineClients = new UserSessionManager(session).findClientsWithOfflineToken(realm, user);\n \n-        for (ClientModel client : realm.getClients()) {\n-            UserConsentModel consent = session.users().getConsentByClient(realm, user.getId(), client.getId());\n-            boolean hasOfflineToken = offlineClients.contains(client);\n-\n-            if (consent == null && !hasOfflineToken) {\n-                continue;\n-            }\n-\n-            UserConsentRepresentation rep = (consent == null) ? null : ModelToRepresentation.toRepresentation(consent);\n-\n-            Map<String, Object> currentRep = new HashMap<>();\n-            currentRep.put(\"clientId\", client.getClientId());\n-            currentRep.put(\"grantedClientScopes\", (rep==null ? Collections.emptyList() : rep.getGrantedClientScopes()));\n-            currentRep.put(\"createdDate\", (rep==null ? null : rep.getCreatedDate()));\n-            currentRep.put(\"lastUpdatedDate\", (rep==null ? null : rep.getLastUpdatedDate()));\n-\n-            List<Map<String, String>> additionalGrants = new LinkedList<>();\n-            if (hasOfflineToken) {\n-                Map<String, String> offlineTokens = new HashMap<>();\n-                offlineTokens.put(\"client\", client.getId());\n-                // TODO: translate\n-                offlineTokens.put(\"key\", \"Offline Token\");\n-                additionalGrants.add(offlineTokens);\n-            }\n-            currentRep.put(\"additionalGrants\", additionalGrants);\n-\n-            result.add(currentRep);\n-        }\n-\n-        return result;\n+        return session.clients().getClientsStream(realm)\n+                .map(client -> {\n+                    UserConsentModel consent = session.users().getConsentByClient(realm, user.getId(), client.getId());\n+                    boolean hasOfflineToken = offlineClients.contains(client);\n+\n+                    if (consent == null && !hasOfflineToken) {\n+                        return null;\n+                    }\n+\n+                    UserConsentRepresentation rep = (consent == null) ? null : ModelToRepresentation.toRepresentation(consent);\n+\n+                    Map<String, Object> currentRep = new HashMap<>();\n+                    currentRep.put(\"clientId\", client.getClientId());\n+                    currentRep.put(\"grantedClientScopes\", (rep == null ? Collections.emptyList() : rep.getGrantedClientScopes()));\n+                    currentRep.put(\"createdDate\", (rep == null ? null : rep.getCreatedDate()));\n+                    currentRep.put(\"lastUpdatedDate\", (rep == null ? null : rep.getLastUpdatedDate()));\n+\n+                    List<Map<String, String>> additionalGrants = new LinkedList<>();\n+                    if (hasOfflineToken) {\n+                        Map<String, String> offlineTokens = new HashMap<>();\n+                        offlineTokens.put(\"client\", client.getId());\n+                        // TODO: translate\n+                        offlineTokens.put(\"key\", \"Offline Token\");\n+                        additionalGrants.add(offlineTokens);\n+                    }\n+                    currentRep.put(\"additionalGrants\", additionalGrants);\n+                    return currentRep;\n+                })\n+                .filter(Objects::nonNull)\n+                .collect(Collectors.toList());", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0ODkyOQ==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r473048929", "body": "```suggestion\r\n            List<RoleRepresentation> roles = new LinkedList<>();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        List<RoleRepresentation> roles = new ArrayList<>();\n          \n          \n            \n                        List<RoleRepresentation> roles = new LinkedList<>();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">RoleRepresentation</span>&gt;</span> roles <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">ArrayList</span>&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">RoleRepresentation</span>&gt;</span> roles <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">LinkedList</span>&lt;&gt;</span>();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hmlnarik", "createdAt": "2020-08-19T13:56:17Z", "path": "services/src/main/java/org/keycloak/services/util/ScopeMappedUtil.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.services.util;\n+\n+import org.keycloak.models.ClientModel;\n+import org.keycloak.models.RoleModel;\n+import org.keycloak.models.ScopeContainerModel;\n+import org.keycloak.models.utils.KeycloakModelUtils;\n+import org.keycloak.models.utils.ModelToRepresentation;\n+import org.keycloak.representations.idm.ClientMappingsRepresentation;\n+import org.keycloak.representations.idm.RoleRepresentation;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class ScopeMappedUtil {\n+    public static ClientMappingsRepresentation toClientMappingsRepresentation(ClientModel client, ScopeContainerModel scopeContainer) {\n+        Set<RoleModel> roleMappings = KeycloakModelUtils.getClientScopeMappings(client, scopeContainer);\n+\n+        if (roleMappings.size() > 0) {\n+\n+            ClientMappingsRepresentation mappings = new ClientMappingsRepresentation();\n+            mappings.setId(client.getId());\n+            mappings.setClient(client.getClientId());\n+            List<RoleRepresentation> roles = new ArrayList<>();", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA0OTM2Mg==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r473049362", "body": "For performance, prefer:\r\n```suggestion\r\n        if (! roleMappings.isEmpty()) {\r\n```", "bodyText": "For performance, prefer:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (roleMappings.size() > 0) {\n          \n          \n            \n                    if (! roleMappings.isEmpty()) {", "bodyHTML": "<p dir=\"auto\">For performance, prefer:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (roleMappings<span class=\"pl-k\">.</span><span class=\"x x-first\">size() </span><span class=\"pl-k x\">&gt;</span><span class=\"x\"> </span><span class=\"pl-c1 x x-last\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (<span class=\"pl-k x x-first\">!</span><span class=\"x x-last\"> </span>roleMappings<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">isEmpty()</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hmlnarik", "createdAt": "2020-08-19T13:56:50Z", "path": "services/src/main/java/org/keycloak/services/util/ScopeMappedUtil.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.services.util;\n+\n+import org.keycloak.models.ClientModel;\n+import org.keycloak.models.RoleModel;\n+import org.keycloak.models.ScopeContainerModel;\n+import org.keycloak.models.utils.KeycloakModelUtils;\n+import org.keycloak.models.utils.ModelToRepresentation;\n+import org.keycloak.representations.idm.ClientMappingsRepresentation;\n+import org.keycloak.representations.idm.RoleRepresentation;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class ScopeMappedUtil {\n+    public static ClientMappingsRepresentation toClientMappingsRepresentation(ClientModel client, ScopeContainerModel scopeContainer) {\n+        Set<RoleModel> roleMappings = KeycloakModelUtils.getClientScopeMappings(client, scopeContainer);\n+\n+        if (roleMappings.size() > 0) {", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0ODgzNw==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r473248837", "body": "Can this code be simplified?", "bodyText": "Can this code be simplified?", "bodyHTML": "<p dir=\"auto\">Can this code be simplified?</p>", "author": "hmlnarik", "createdAt": "2020-08-19T18:50:09Z", "path": "services/src/main/java/org/keycloak/services/resources/admin/UserResource.java", "diffHunk": "@@ -465,40 +465,39 @@ public void removeFederatedIdentity(final @PathParam(\"provider\") String provider\n     @Produces(MediaType.APPLICATION_JSON)\n     public List<Map<String, Object>> getConsents() {\n         auth.users().requireView(user);\n-        List<Map<String, Object>> result = new LinkedList<>();\n \n         Set<ClientModel> offlineClients = new UserSessionManager(session).findClientsWithOfflineToken(realm, user);\n \n-        for (ClientModel client : realm.getClients()) {\n-            UserConsentModel consent = session.users().getConsentByClient(realm, user.getId(), client.getId());\n-            boolean hasOfflineToken = offlineClients.contains(client);\n-\n-            if (consent == null && !hasOfflineToken) {\n-                continue;\n-            }\n-\n-            UserConsentRepresentation rep = (consent == null) ? null : ModelToRepresentation.toRepresentation(consent);\n-\n-            Map<String, Object> currentRep = new HashMap<>();\n-            currentRep.put(\"clientId\", client.getClientId());\n-            currentRep.put(\"grantedClientScopes\", (rep==null ? Collections.emptyList() : rep.getGrantedClientScopes()));\n-            currentRep.put(\"createdDate\", (rep==null ? null : rep.getCreatedDate()));\n-            currentRep.put(\"lastUpdatedDate\", (rep==null ? null : rep.getLastUpdatedDate()));\n-\n-            List<Map<String, String>> additionalGrants = new LinkedList<>();\n-            if (hasOfflineToken) {\n-                Map<String, String> offlineTokens = new HashMap<>();\n-                offlineTokens.put(\"client\", client.getId());\n-                // TODO: translate\n-                offlineTokens.put(\"key\", \"Offline Token\");\n-                additionalGrants.add(offlineTokens);\n-            }\n-            currentRep.put(\"additionalGrants\", additionalGrants);\n-\n-            result.add(currentRep);\n-        }\n-\n-        return result;\n+        return session.clients().getClientsStream(realm)\n+                .map(client -> {", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI0OTY0MA==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r473249640", "body": "```suggestion\r\n            List<RoleRepresentation> realmRep = new LinkedList<>();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        List<RoleRepresentation> realmRep = new ArrayList<>();\n          \n          \n            \n                        List<RoleRepresentation> realmRep = new LinkedList<>();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">RoleRepresentation</span>&gt;</span> realmRep <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">ArrayList</span>&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">RoleRepresentation</span>&gt;</span> realmRep <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">LinkedList</span>&lt;&gt;</span>();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hmlnarik", "createdAt": "2020-08-19T18:51:48Z", "path": "services/src/main/java/org/keycloak/services/resources/admin/ScopeMappedResource.java", "diffHunk": "@@ -98,31 +102,21 @@ public MappingsRepresentation getScopeMappings() {\n         MappingsRepresentation all = new MappingsRepresentation();\n         Set<RoleModel> realmMappings = scopeContainer.getRealmScopeMappings();\n         if (realmMappings.size() > 0) {\n-            List<RoleRepresentation> realmRep = new ArrayList<RoleRepresentation>();\n+            List<RoleRepresentation> realmRep = new ArrayList<>();", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI1MDEzOA==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r473250138", "body": "```suggestion\r\n        try (Stream<ClientModel> clients = session.clients().getClientsStream(realm)) {\r\n            Map<String, ClientMappingsRepresentation> clientMappings = clients\r\n                    .map(c -> ScopeMappedUtil.toClientMappingsRepresentation(c, scopeContainer))\r\n                    .filter(Objects::nonNull)\r\n                    .collect(Collectors.toMap(ClientMappingsRepresentation::getClient, Function.identity()));\r\n\r\n            if (clientMappings.size() > 0) {\r\n                all.setClientMappings(clientMappings);\r\n            }\r\n        }\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Stream<ClientModel> clients = session.clients().getClientsStream(realm);\n          \n          \n            \n                    Map<String, ClientMappingsRepresentation> clientMappings = clients\n          \n          \n            \n                            .map(c -> ScopeMappedUtil.toClientMappingsRepresentation(c, scopeContainer))\n          \n          \n            \n                            .filter(Objects::nonNull)\n          \n          \n            \n                            .collect(Collectors.toMap(ClientMappingsRepresentation::getClient, Function.identity()));\n          \n          \n            \n            \n          \n          \n            \n                    if (clientMappings.size() > 0) {\n          \n          \n            \n                        all.setClientMappings(clientMappings);\n          \n          \n            \n                    }\n          \n          \n            \n                    try (Stream<ClientModel> clients = session.clients().getClientsStream(realm)) {\n          \n          \n            \n                        Map<String, ClientMappingsRepresentation> clientMappings = clients\n          \n          \n            \n                                .map(c -> ScopeMappedUtil.toClientMappingsRepresentation(c, scopeContainer))\n          \n          \n            \n                                .filter(Objects::nonNull)\n          \n          \n            \n                                .collect(Collectors.toMap(ClientMappingsRepresentation::getClient, Function.identity()));\n          \n          \n            \n            \n          \n          \n            \n                        if (clientMappings.size() > 0) {\n          \n          \n            \n                            all.setClientMappings(clientMappings);\n          \n          \n            \n                        }\n          \n          \n            \n                    }", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"120\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">Stream&lt;<span class=\"pl-smi\">ClientModel</span>&gt;</span> clients <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>clients()<span class=\"pl-k\">.</span>getClientsStream(realm);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"121\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">ClientMappingsRepresentation</span>&gt;</span> clientMappings <span class=\"pl-k\">=</span> clients</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"122\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                .map(c <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">ScopeMappedUtil</span><span class=\"pl-k\">.</span>toClientMappingsRepresentation(c, scopeContainer))</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"123\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                .filter(<span class=\"pl-smi\">Objects</span><span class=\"pl-k\">::</span>nonNull)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"124\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                .collect(<span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>toMap(<span class=\"pl-smi\">ClientMappingsRepresentation</span><span class=\"pl-k\">::</span>getClient, <span class=\"pl-smi\">Function</span><span class=\"pl-k\">.</span>identity()));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"125\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"126\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (clientMappings<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"127\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            all<span class=\"pl-k\">.</span>setClientMappings(clientMappings);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"128\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"120\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">try</span> (<span class=\"pl-k\">Stream&lt;<span class=\"pl-smi\">ClientModel</span>&gt;</span> clients <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>clients()<span class=\"pl-k\">.</span>getClientsStream(realm)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"121\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">ClientMappingsRepresentation</span>&gt;</span> clientMappings <span class=\"pl-k\">=</span> clients</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"122\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    .map(c <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">ScopeMappedUtil</span><span class=\"pl-k\">.</span>toClientMappingsRepresentation(c, scopeContainer))</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"123\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    .filter(<span class=\"pl-smi\">Objects</span><span class=\"pl-k\">::</span>nonNull)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"124\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    .collect(<span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>toMap(<span class=\"pl-smi\">ClientMappingsRepresentation</span><span class=\"pl-k\">::</span>getClient, <span class=\"pl-smi\">Function</span><span class=\"pl-k\">.</span>identity()));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"125\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"126\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (clientMappings<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"127\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                all<span class=\"pl-k\">.</span>setClientMappings(clientMappings);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"128\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"129\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hmlnarik", "createdAt": "2020-08-19T18:52:54Z", "path": "services/src/main/java/org/keycloak/services/resources/admin/ScopeMappedResource.java", "diffHunk": "@@ -98,31 +102,21 @@ public MappingsRepresentation getScopeMappings() {\n         MappingsRepresentation all = new MappingsRepresentation();\n         Set<RoleModel> realmMappings = scopeContainer.getRealmScopeMappings();\n         if (realmMappings.size() > 0) {\n-            List<RoleRepresentation> realmRep = new ArrayList<RoleRepresentation>();\n+            List<RoleRepresentation> realmRep = new ArrayList<>();\n             for (RoleModel roleModel : realmMappings) {\n                 realmRep.add(ModelToRepresentation.toBriefRepresentation(roleModel));\n             }\n             all.setRealmMappings(realmRep);\n         }\n \n-        List<ClientModel> clients = realm.getClients();\n-        if (clients.size() > 0) {\n-            Map<String, ClientMappingsRepresentation> clientMappings = new HashMap<String, ClientMappingsRepresentation>();\n-            for (ClientModel client : clients) {\n-                Set<RoleModel> roleMappings = KeycloakModelUtils.getClientScopeMappings(client, this.scopeContainer); //client.getClientScopeMappings(this.client);\n-                if (roleMappings.size() > 0) {\n-                    ClientMappingsRepresentation mappings = new ClientMappingsRepresentation();\n-                    mappings.setId(client.getId());\n-                    mappings.setClient(client.getClientId());\n-                    List<RoleRepresentation> roles = new ArrayList<RoleRepresentation>();\n-                    mappings.setMappings(roles);\n-                    for (RoleModel role : roleMappings) {\n-                        roles.add(ModelToRepresentation.toBriefRepresentation(role));\n-                    }\n-                    clientMappings.put(client.getClientId(), mappings);\n-                    all.setClientMappings(clientMappings);\n-                }\n-            }\n+        Stream<ClientModel> clients = session.clients().getClientsStream(realm);\n+        Map<String, ClientMappingsRepresentation> clientMappings = clients\n+                .map(c -> ScopeMappedUtil.toClientMappingsRepresentation(c, scopeContainer))\n+                .filter(Objects::nonNull)\n+                .collect(Collectors.toMap(ClientMappingsRepresentation::getClient, Function.identity()));\n+\n+        if (clientMappings.size() > 0) {\n+            all.setClientMappings(clientMappings);\n         }", "originalCommit": "a20d0ef10d44f94262abb9d4c613902d84cdec80", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "09a946ab52c9d7f5d7add3584746b5e6f6196d0e", "url": "https://github.com/keycloak/keycloak/commit/09a946ab52c9d7f5d7add3584746b5e6f6196d0e", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-08-26T13:59:53Z", "type": "forcePushed"}, {"oid": "64746b742f24cc02899d91d8fcba20c7520b0899", "url": "https://github.com/keycloak/keycloak/commit/64746b742f24cc02899d91d8fcba20c7520b0899", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-08-26T14:13:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5Njc4MA==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r481996780", "body": "Are we going to replace any other occurrence of `RealmModel.getClientByClientId(String)` with `session.clients().getClientByClientId(RealmModel, String)`? It's not clear to me why we update it here but not on all other places. Are all other occurrences used becouse we don't have access to keycloak session there?\r\n\r\nThe same question applies to `RealmModel.getClientById(String)`.", "bodyText": "Are we going to replace any other occurrence of RealmModel.getClientByClientId(String) with session.clients().getClientByClientId(RealmModel, String)? It's not clear to me why we update it here but not on all other places. Are all other occurrences used becouse we don't have access to keycloak session there?\nThe same question applies to RealmModel.getClientById(String).", "bodyHTML": "<p dir=\"auto\">Are we going to replace any other occurrence of <code>RealmModel.getClientByClientId(String)</code> with <code>session.clients().getClientByClientId(RealmModel, String)</code>? It's not clear to me why we update it here but not on all other places. Are all other occurrences used becouse we don't have access to keycloak session there?</p>\n<p dir=\"auto\">The same question applies to <code>RealmModel.getClientById(String)</code>.</p>", "author": "vramik", "createdAt": "2020-09-02T11:27:21Z", "path": "authz/policy/common/src/main/java/org/keycloak/authorization/policy/provider/role/RolePolicyProviderFactory.java", "diffHunk": "@@ -163,7 +164,7 @@ private void updateRoles(Policy policy, AuthorizationProvider authorization, Set\n                         role = realm.getRoleById(roleName);\n                     }\n                 } else {\n-                    ClientModel client = realm.getClientByClientId(clientId);\n+                    ClientModel client = session.clients().getClientByClientId(realm, clientId);", "originalCommit": "64746b742f24cc02899d91d8fcba20c7520b0899", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc5MDA3OQ==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r482790079", "bodyText": "@vramik Good question. I guess I somehow assumed that I'll only change those occurrences which are relevant to this PR and the rest is/will be changed in a different PR. I'll revert these changes and it can be done in a separate task. WDYT?", "author": "martin-kanis", "createdAt": "2020-09-03T08:10:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5Njc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzAwMTAyOA==", "url": "https://github.com/keycloak/keycloak/pull/7302#discussion_r483001028", "bodyText": "The original version (via realm) should serve as a shortcut to the new version (via session), so they are effectively equivalent. There is no strong rule which drives which use when though.\nFrom readability perspective, the physical storage layer, it may be preferrable to use the latter approach with session, but in the logical layer (e.g. from services), the former would likely prevail.\nWe could perhaps add a comment in the javadoc to these shortcuts similar to This call is effectively the same as {@code session.clients().getClientByClientId(this, clientId);}..", "author": "hmlnarik", "createdAt": "2020-09-03T14:00:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5Njc4MA=="}], "type": "inlineReview"}, {"oid": "a6e771c5846c46ccc790a928ae2cbf3402f0ed3b", "url": "https://github.com/keycloak/keycloak/commit/a6e771c5846c46ccc790a928ae2cbf3402f0ed3b", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-09-03T11:29:02Z", "type": "commit"}, {"oid": "a6e771c5846c46ccc790a928ae2cbf3402f0ed3b", "url": "https://github.com/keycloak/keycloak/commit/a6e771c5846c46ccc790a928ae2cbf3402f0ed3b", "message": "KEYCLOAK-14901 Replace deprecated ClientProvider related methods across Keycloak", "committedDate": "2020-09-03T11:29:02Z", "type": "forcePushed"}]}