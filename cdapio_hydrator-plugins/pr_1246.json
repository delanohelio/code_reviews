{"pr_number": 1246, "pr_title": "Backwards compatibility", "pr_author": "vjosadika", "pr_createdAt": "2020-11-05T13:04:55Z", "pr_url": "https://github.com/cdapio/hydrator-plugins/pull/1246", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4NzEyMQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518287121", "body": "we shouldnt do it. the exception should be logged. Please take a look at other places where we handle this case in the codebase", "bodyText": "we shouldnt do it. the exception should be logged. Please take a look at other places where we handle this case in the codebase", "bodyHTML": "<p dir=\"auto\">we shouldnt do it. the exception should be logged. Please take a look at other places where we handle this case in the codebase</p>", "author": "CuriousVini", "createdAt": "2020-11-05T18:55:14Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -99,7 +101,18 @@ public StructuredRecord getRecord() {\n    */\n   public void readFields(ResultSet resultSet) throws SQLException {\n     ResultSetMetaData metadata = resultSet.getMetaData();\n-    List<Schema.Field> originalSchema = DBUtils.getOriginalSchema(resultSet);\n+    String outputSchemaString = conf.get(DBUtils.OVERRIDE_SCHEMA, null);\n+    Schema outputSchema = null;\n+\n+    if (!Strings.isNullOrEmpty(outputSchemaString)) {\n+      try {\n+        outputSchema = Schema.parseJson(outputSchemaString);\n+      } catch (IOException e) {\n+        e.printStackTrace();", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4Nzk0Nw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518287947", "body": "these changes are not needed. please revert them", "bodyText": "these changes are not needed. please revert them", "bodyHTML": "<p dir=\"auto\">these changes are not needed. please revert them</p>", "author": "CuriousVini", "createdAt": "2020-11-05T18:56:42Z", "path": "database-plugins/src/main/java/io/cdap/plugin/db/batch/source/DBSource.java", "diffHunk": "@@ -318,20 +319,20 @@ private Connection getConnection() throws SQLException {\n     @Nullable\n     @Name(PATTERN_TO_REPLACE)\n     @Description(\"The pattern to replace in the field name in the table, it is typically used with the \" +\n-                   \"Replace With config. If Replace With is not set, the pattern will be removed in the field name.\")\n+      \"Replace With config. If Replace With is not set, the pattern will be removed in the field name.\")", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4ODMxMA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518288310", "body": "these changes are not needed . Please revert them", "bodyText": "these changes are not needed . Please revert them", "bodyHTML": "<p dir=\"auto\">these changes are not needed . Please revert them</p>", "author": "CuriousVini", "createdAt": "2020-11-05T18:57:22Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -283,7 +312,7 @@ private void writeToDB(PreparedStatement stmt, Schema.Field field, int fieldInde\n         break;\n       default:\n         throw new SQLException(String.format(\"Column %s with value %s has an unsupported datatype %s\",\n-          field.getName(), fieldValue, fieldType));\n+                                             field.getName(), fieldValue, fieldType));", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5NTI1NA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518295254", "body": "not needed. Please remove.", "bodyText": "not needed. Please remove.", "bodyHTML": "<p dir=\"auto\">not needed. Please remove.</p>", "author": "CuriousVini", "createdAt": "2020-11-05T19:09:30Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -232,13 +246,23 @@ private static Schema getSchema(String typeName, int sqlType, int precision, int\n         break;\n \n       case Types.NUMERIC:\n-      case Types.DECIMAL:\n+        //variation", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5NTYzMQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r518295631", "body": "This does not cover all cases. The schema type changes depending on precision and scale values:\r\n```\r\ntype = scale != 0 ? Schema.Type.DOUBLE :\r\n          // with 10 digits we can represent 2^32 and LONG is required\r\n          precision > 9 ? Schema.Type.LONG : Schema.Type.INT;", "bodyText": "This does not cover all cases. The schema type changes depending on precision and scale values:\ntype = scale != 0 ? Schema.Type.DOUBLE :\n          // with 10 digits we can represent 2^32 and LONG is required\n          precision > 9 ? Schema.Type.LONG : Schema.Type.INT;", "bodyHTML": "<p dir=\"auto\">This does not cover all cases. The schema type changes depending on precision and scale values:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"type = scale != 0 ? Schema.Type.DOUBLE :\n          // with 10 digits we can represent 2^32 and LONG is required\n          precision &gt; 9 ? Schema.Type.LONG : Schema.Type.INT;\n\"><pre><code>type = scale != 0 ? Schema.Type.DOUBLE :\n          // with 10 digits we can represent 2^32 and LONG is required\n          precision &gt; 9 ? Schema.Type.LONG : Schema.Type.INT;\n</code></pre></div>", "author": "CuriousVini", "createdAt": "2020-11-05T19:10:07Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -124,23 +137,39 @@ public void readFields(ResultSet resultSet) throws SQLException {\n       int sqlType = metadata.getColumnType(i + 1);\n       int sqlPrecision = metadata.getPrecision(i + 1);\n       int sqlScale = metadata.getScale(i + 1);\n+      // handles backwards compatibility\n+      boolean handleDecimalAsDouble = false;\n+      if (sqlType == Types.DECIMAL && outputSchema != null) {\n+        Schema outputFieldSchema = field.getSchema();\n+        if (outputFieldSchema != null) {\n+          outputFieldSchema = outputFieldSchema.isNullable() ? outputFieldSchema.getNonNullable() : outputFieldSchema;\n+          handleDecimalAsDouble = outputFieldSchema.getType() == Schema.Type.DOUBLE;", "originalCommit": "48f286f552bb9c6d638d416c8bed8ff72150dfbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg2MTg2Ng==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r519861866", "bodyText": "@CuriousVini fixed", "author": "vjosadika", "createdAt": "2020-11-09T14:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI5NTYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5OTIwNw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521599207", "body": "not needed ", "bodyText": "not needed", "bodyHTML": "<p dir=\"auto\">not needed</p>", "author": "CuriousVini", "createdAt": "2020-11-11T19:49:02Z", "path": "database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java", "diffHunk": "@@ -351,8 +416,8 @@ public void testNonExistentDBTable() throws Exception {\n       .addConnection(sourceBadName.getName(), sink.getName())\n       .build();\n     ApplicationId appId = NamespaceId.DEFAULT.app(\"dbSourceNonExistingTest\");\n-    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because of a \" +\n-      \"non-existent source table.\");\n+    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because \"\n+      + \"of a \" + \"non-existent source table.\");", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5OTI5MQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521599291", "body": "Is this unintended? ", "bodyText": "Is this unintended?", "bodyHTML": "<p dir=\"auto\">Is this unintended?</p>", "author": "CuriousVini", "createdAt": "2020-11-11T19:49:13Z", "path": "database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java", "diffHunk": "@@ -374,7 +439,7 @@ public void testNonExistentDBTable() throws Exception {\n       .addStage(sink)\n       .addConnection(sourceBadConn.getName(), sink.getName())\n       .build();\n-    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because of a \" +\n-      \"non-existent source database.\");\n+    assertDeploymentFailure(appId, etlConfig, \"ETL Application with DB Source should have failed because \"\n+      + \"of a \" + \"non-existent source database.\");", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5OTQxNA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521599414", "body": "same here. unintended? ", "bodyText": "same here. unintended?", "bodyHTML": "<p dir=\"auto\">same here. unintended?</p>", "author": "CuriousVini", "createdAt": "2020-11-11T19:49:25Z", "path": "database-plugins/src/test/java/io/cdap/plugin/db/batch/source/DBSourceTestRun.java", "diffHunk": "@@ -298,7 +362,8 @@ public void testUserNamePasswordCombinations() throws Exception {\n     // as source\n     Map<String, String> noUser = new HashMap<>(baseSourceProps);\n     noUser.put(DBConfig.PASSWORD, \"password\");\n-    database = new ETLStage(\"databaseSource\", new ETLPlugin(\"Database\", BatchSource.PLUGIN_TYPE, noUser, null));\n+    database = new ETLStage(\"databaseSource\", new ETLPlugin(\"Database\", BatchSource.PLUGIN_TYPE, noUser,", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjEyOQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846129", "body": "Mark `Schema outputSchema` as nullable", "bodyText": "Mark Schema outputSchema as nullable", "bodyHTML": "<p dir=\"auto\">Mark <code>Schema outputSchema</code> as nullable</p>", "author": "CuriousVini", "createdAt": "2020-11-12T05:21:06Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -149,21 +149,21 @@ public static DriverCleanup ensureJDBCDriverIsAvailable(Class<? extends Driver>\n    * Given the result set, get the metadata of the result set and return\n    * list of {@link io.cdap.cdap.api.data.schema.Schema.Field},\n    * where name of the field is same as column name and type of the field is obtained using\n-   * {@link DBUtils#getSchema(String, int, int, int, String)}\n+   * {@link DBUtils#getSchema(String, int, int, int, String, boolean)}\n    *\n    * @param resultSet result set of executed query\n    * @return list of schema fields\n    * @throws SQLException\n    */\n-  public static List<Schema.Field> getOriginalSchema(ResultSet resultSet) throws SQLException {\n-    return getSchemaFields(resultSet, null, null);\n+  public static List<Schema.Field> getOriginalSchema(ResultSet resultSet, Schema outputSchema) throws SQLException {", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjIxNQ==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846215", "bodyText": "Javadoc should be updated and should have same params as number of params in the method", "author": "CuriousVini", "createdAt": "2020-11-12T05:21:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjEyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjI2Mg==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846262", "body": "Mark outpuschema as nullable", "bodyText": "Mark outpuschema as nullable", "bodyHTML": "<p dir=\"auto\">Mark outpuschema as nullable</p>", "author": "CuriousVini", "createdAt": "2020-11-12T05:21:35Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -172,7 +172,8 @@ public static DriverCleanup ensureJDBCDriverIsAvailable(Class<? extends Driver>\n    * @throws SQLException\n    */\n   public static List<Schema.Field> getSchemaFields(ResultSet resultSet, @Nullable String patternToReplace,\n-                                                   @Nullable String replaceWith) throws SQLException {\n+                                                   @Nullable String replaceWith, Schema outputSchema)", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NjcwOA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521846708", "body": "What is the difference between numeric and decimal type? Does this change need to be applied to numeric too?", "bodyText": "What is the difference between numeric and decimal type? Does this change need to be applied to numeric too?", "bodyHTML": "<p dir=\"auto\">What is the difference between numeric and decimal type? Does this change need to be applied to numeric too?</p>", "author": "CuriousVini", "createdAt": "2020-11-12T05:22:53Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -232,13 +247,21 @@ private static Schema getSchema(String typeName, int sqlType, int precision, int\n         break;\n \n       case Types.NUMERIC:", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0NzMwMw==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521847303", "body": "should not have duplicate code. Please refactor it. ", "bodyText": "should not have duplicate code. Please refactor it.", "bodyHTML": "<p dir=\"auto\">should not have duplicate code. Please refactor it.</p>", "author": "CuriousVini", "createdAt": "2020-11-12T05:24:41Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -232,13 +247,21 @@ private static Schema getSchema(String typeName, int sqlType, int precision, int\n         break;\n \n       case Types.NUMERIC:\n-      case Types.DECIMAL:\n         // if there are no digits after the point, use integer types\n         type = scale != 0 ? Schema.Type.DOUBLE :\n           // with 10 digits we can represent 2^32 and LONG is required\n           precision > 9 ? Schema.Type.LONG : Schema.Type.INT;\n         break;\n-\n+      case Types.DECIMAL:\n+        if (handleAsDecimal) {\n+          return Schema.decimalOf(precision, scale);\n+        } else {\n+          // if there are no digits after the point, use integer types\n+          type = scale != 0 ? Schema.Type.DOUBLE :", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0ODczMA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521848730", "body": "shouldnt duplicate the logic. Please refactor it. ", "bodyText": "shouldnt duplicate the logic. Please refactor it.", "bodyHTML": "<p dir=\"auto\">shouldnt duplicate the logic. Please refactor it.</p>", "author": "CuriousVini", "createdAt": "2020-11-12T05:29:07Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBUtils.java", "diffHunk": "@@ -293,6 +316,23 @@ public static Object transformValue(int sqlType, int precision, int scale,\n           } else {\n             return decimal.intValue();\n           }\n+        }\n+        case Types.DECIMAL: {\n+          if (handleAsDecimal) {\n+            return original;\n+          } else {\n+            BigDecimal decimal = (BigDecimal) original;\n+            if (scale != 0) {", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg0OTMxNA==", "url": "https://github.com/cdapio/hydrator-plugins/pull/1246#discussion_r521849314", "body": "There is no need for `handleAsDecimal ` variable in this method. We can just pass `Schema.Field field` to the method and get the type of field to derive if decimal type needs to be handled. ", "bodyText": "There is no need for handleAsDecimal  variable in this method. We can just pass Schema.Field field to the method and get the type of field to derive if decimal type needs to be handled.", "bodyHTML": "<p dir=\"auto\">There is no need for <code>handleAsDecimal </code> variable in this method. We can just pass <code>Schema.Field field</code> to the method and get the type of field to derive if decimal type needs to be handled.</p>", "author": "CuriousVini", "createdAt": "2020-11-12T05:31:09Z", "path": "database-plugins/src/main/java/io/cdap/plugin/DBRecord.java", "diffHunk": "@@ -124,23 +137,37 @@ public void readFields(ResultSet resultSet) throws SQLException {\n       int sqlType = metadata.getColumnType(i + 1);\n       int sqlPrecision = metadata.getPrecision(i + 1);\n       int sqlScale = metadata.getScale(i + 1);\n+      // handles backwards compatibility\n+      boolean handleAsDecimal = false;\n+      Schema outputFieldSchema = field.getSchema();\n+      outputFieldSchema = outputFieldSchema.isNullable() ? outputFieldSchema.getNonNullable() : outputFieldSchema;\n+      if (sqlType == Types.DECIMAL && (outputSchema == null ||\n+        outputFieldSchema.getLogicalType() == Schema.LogicalType.DECIMAL)) {\n+        handleAsDecimal = true;\n+      }\n       setField(resultSet, recordBuilder, field, sqlType, sqlPrecision, sqlScale, nameMap.getOrDefault(field.getName(),\n-                                                                                                      field.getName()));\n+                                                                                                      field.getName()),\n+               handleAsDecimal);\n     }\n     record = recordBuilder.build();\n   }\n \n   private void setField(ResultSet resultSet, StructuredRecord.Builder recordBuilder, Schema.Field field, int sqlType,\n-                        int sqlPrecision, int sqlScale, String originalName) throws SQLException {\n+                        int sqlPrecision, int sqlScale, String originalName, boolean handleAsDecimal)\n+    throws SQLException {\n     // original name has to be used to get result from result set\n-    Object o = DBUtils.transformValue(sqlType, sqlPrecision, sqlScale, resultSet, originalName);\n+    Object o = DBUtils.transformValue(sqlType, sqlPrecision, sqlScale, resultSet, originalName,\n+                                      handleAsDecimal);", "originalCommit": "84efa6168f9c775b744acd7e10a3bbf111a51b2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f7708e09423dc28243776565f557832d270d40c", "url": "https://github.com/cdapio/hydrator-plugins/commit/6f7708e09423dc28243776565f557832d270d40c", "message": "Backwards compatibility", "committedDate": "2020-11-17T18:33:29Z", "type": "commit"}, {"oid": "6f7708e09423dc28243776565f557832d270d40c", "url": "https://github.com/cdapio/hydrator-plugins/commit/6f7708e09423dc28243776565f557832d270d40c", "message": "Backwards compatibility", "committedDate": "2020-11-17T18:33:29Z", "type": "forcePushed"}]}