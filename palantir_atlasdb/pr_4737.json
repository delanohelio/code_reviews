{"pr_number": 4737, "pr_title": "[PaxosLog] Expose batch write method", "pr_author": "gmaretic", "pr_createdAt": "2020-04-27T14:35:39Z", "pr_url": "https://github.com/palantir/atlasdb/pull/4737", "timeline": [{"oid": "93c165dda003aedd212a3e6fbc6e26e075dbea87", "url": "https://github.com/palantir/atlasdb/commit/93c165dda003aedd212a3e6fbc6e26e075dbea87", "message": "Use JDBI", "committedDate": "2020-04-22T15:53:59Z", "type": "commit"}, {"oid": "2dadde4e2d42e9f5c256e783ab06b2a4fd3407b4", "url": "https://github.com/palantir/atlasdb/commit/2dadde4e2d42e9f5c256e783ab06b2a4fd3407b4", "message": "Package private", "committedDate": "2020-04-22T15:59:19Z", "type": "commit"}, {"oid": "521a3eec0ba99a626c2e899e44336d60e07234cb", "url": "https://github.com/palantir/atlasdb/commit/521a3eec0ba99a626c2e899e44336d60e07234cb", "message": "Prevent test connection from closing so we don't need to have funky factory in production code", "committedDate": "2020-04-23T11:28:13Z", "type": "commit"}, {"oid": "df3cfc6a11b38b3be2ec40c3705953d497038728", "url": "https://github.com/palantir/atlasdb/commit/df3cfc6a11b38b3be2ec40c3705953d497038728", "message": "Add batching support", "committedDate": "2020-04-23T12:55:39Z", "type": "commit"}, {"oid": "b88059c5da41ac7d6d1f7657e564786298ca8c80", "url": "https://github.com/palantir/atlasdb/commit/b88059c5da41ac7d6d1f7657e564786298ca8c80", "message": "Address CR", "committedDate": "2020-04-23T15:35:59Z", "type": "commit"}, {"oid": "7bcb706435d6b1e0dd85495103a6a2a824681d0c", "url": "https://github.com/palantir/atlasdb/commit/7bcb706435d6b1e0dd85495103a6a2a824681d0c", "message": "Merge branch 'psl/jdbi' of github.com:palantir/atlasdb into psl/batch-write", "committedDate": "2020-04-23T15:36:52Z", "type": "commit"}, {"oid": "635cf6eab4d55d3f4a4bfc33d1cc35686e1560df", "url": "https://github.com/palantir/atlasdb/commit/635cf6eab4d55d3f4a4bfc33d1cc35686e1560df", "message": "Fix merge conflicts", "committedDate": "2020-04-27T14:07:02Z", "type": "commit"}, {"oid": "bba27db26f00241b1714126bb42a190768c94e53", "url": "https://github.com/palantir/atlasdb/commit/bba27db26f00241b1714126bb42a190768c94e53", "message": "Oops", "committedDate": "2020-04-27T14:30:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk2OTk4Mw==", "url": "https://github.com/palantir/atlasdb/pull/4737#discussion_r415969983", "body": "```suggestion\r\n    /**\r\n     * Implementations of this method MUST obey the following:\r\n     * 1) The end state of the log should be equivalent to applying the operations in \r\n     *    iteration order.\r\n     * 2) Implementations need not be atomic. However, if they fail, they should apply only\r\n     *    prefixes of the input iterable.\r\n     */\r\n    default void writeBatchOfRounds(Iterable<PaxosRound<V>> rounds) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                default void writeBatchOfRounds(Iterable<PaxosRound<V>> rounds) {\n          \n          \n            \n                /**\n          \n          \n            \n                 * Implementations of this method MUST obey the following:\n          \n          \n            \n                 * 1) The end state of the log should be equivalent to applying the operations in \n          \n          \n            \n                 *    iteration order.\n          \n          \n            \n                 * 2) Implementations need not be atomic. However, if they fail, they should apply only\n          \n          \n            \n                 *    prefixes of the input iterable.\n          \n          \n            \n                 */\n          \n          \n            \n                default void writeBatchOfRounds(Iterable<PaxosRound<V>> rounds) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"42\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">default</span><span class=\"x\"> </span><span class=\"pl-k x\">void</span><span class=\"x\"> writeBatchOfRounds(</span><span class=\"pl-k\"><span class=\"x\">Iterable&lt;</span><span class=\"pl-k\"><span class=\"x\">PaxosRound&lt;</span><span class=\"pl-smi x\">V</span><span class=\"x\">&gt;</span></span><span class=\"x\">&gt;</span></span><span class=\"x x-last\"> rounds) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"42\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c x x-first x-last\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"43\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Implementations</span> of <span class=\"pl-c1\">this</span> method <span class=\"pl-c1\">MUST</span> obey the following<span class=\"pl-k\">:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"44\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-c1\">1</span>) <span class=\"pl-smi\">The</span> end state of the log should be equivalent to applying the operations in </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"45\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span>    iteration order.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"46\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-c1\">2</span>) <span class=\"pl-smi\">Implementations</span> need not be atomic. <span class=\"pl-smi\">However</span>, <span class=\"pl-k\">if</span> they fail, they should apply only</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"47\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span>    prefixes of the input iterable.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"48\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"49\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">default</span> <span class=\"pl-k\">void</span> writeBatchOfRounds(<span class=\"pl-k\">Iterable&lt;<span class=\"pl-k\">PaxosRound&lt;<span class=\"pl-smi\">V</span>&gt;</span>&gt;</span> rounds) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jeremyk-91", "createdAt": "2020-04-27T16:37:48Z", "path": "leader-election-api/src/main/java/com/palantir/paxos/PaxosStateLog.java", "diffHunk": "@@ -33,6 +33,10 @@\n      */\n     void writeRound(long seq, V round);\n \n+    default void writeBatchOfRounds(Iterable<PaxosRound<V>> rounds) {", "originalCommit": "bba27db26f00241b1714126bb42a190768c94e53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTk3MTk1Mw==", "url": "https://github.com/palantir/atlasdb/pull/4737#discussion_r415971953", "body": "Discussed why this must be `boolean[]` offline: required because of the signature of `execute()`", "bodyText": "Discussed why this must be boolean[] offline: required because of the signature of execute()", "bodyHTML": "<p dir=\"auto\">Discussed why this must be <code>boolean[]</code> offline: required because of the signature of <code>execute()</code></p>", "author": "jeremyk-91", "createdAt": "2020-04-27T16:40:26Z", "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -100,5 +109,9 @@ public void truncate(long toDeleteInclusive) {\n \n         @SqlUpdate(\"DELETE FROM <table> WHERE seq <= :seq\")\n         boolean truncate(@Define(\"table\") String table, @Bind(\"seq\") long seq);\n+\n+        @SqlBatch(\"INSERT OR REPLACE INTO <table> (seq, val) VALUES (:round.sequence, :round.valueBytes)\")\n+        <V extends Persistable & Versionable> boolean[] writeBatchOfRounds(@Define(\"table\") String table,", "originalCommit": "bba27db26f00241b1714126bb42a190768c94e53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "645d2e849096aa4ea98f1997d1baa11de01e1bae", "url": "https://github.com/palantir/atlasdb/commit/645d2e849096aa4ea98f1997d1baa11de01e1bae", "message": "Update leader-election-api/src/main/java/com/palantir/paxos/PaxosStateLog.java\n\nCo-Authored-By: Jeremy Kong <jeremykong@hotmail.com>", "committedDate": "2020-04-28T09:49:25Z", "type": "commit"}, {"oid": "c0d3b7f78f73ed7e0efac99fcca85ec0eaadc2e6", "url": "https://github.com/palantir/atlasdb/commit/c0d3b7f78f73ed7e0efac99fcca85ec0eaadc2e6", "message": "Checkstyle is a joke", "committedDate": "2020-04-28T10:13:44Z", "type": "commit"}]}