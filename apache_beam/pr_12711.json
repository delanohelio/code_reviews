{"pr_number": 12711, "pr_title": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "pr_author": "robinyqiu", "pr_createdAt": "2020-08-27T23:48:04Z", "pr_url": "https://github.com/apache/beam/pull/12711", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzczNA==", "url": "https://github.com/apache/beam/pull/12711#discussion_r487193734", "body": "It's possible for users of BigQueryIO to hit this code path through `BigQueryIO.readTableRowsWithSchema()` right? This will be a breaking change since the Java type for a DATETIME field changes from Instant to LocalDateTime. I think that's ok since it's experimental, but we should add a note to CHANGES.md", "bodyText": "It's possible for users of BigQueryIO to hit this code path through BigQueryIO.readTableRowsWithSchema() right? This will be a breaking change since the Java type for a DATETIME field changes from Instant to LocalDateTime. I think that's ok since it's experimental, but we should add a note to CHANGES.md", "bodyHTML": "<p dir=\"auto\">It's possible for users of BigQueryIO to hit this code path through <code>BigQueryIO.readTableRowsWithSchema()</code> right? This will be a breaking change since the Java type for a DATETIME field changes from Instant to LocalDateTime. I think that's ok since it's experimental, but we should add a note to CHANGES.md</p>", "author": "TheNeuralBit", "createdAt": "2020-09-11T17:40:59Z", "path": "sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtils.java", "diffHunk": "@@ -257,10 +263,9 @@ private static FieldType fromTableFieldSchemaType(\n       case \"DATE\":\n         return FieldType.logicalType(SqlTypes.DATE);\n       case \"DATETIME\":\n-        // TODO[BEAM-10240]: map to the new logical type when ZetaSQL DATETIME type is supported\n-        return FieldType.logicalType(\n-            new PassThroughLogicalType<Instant>(\n-                \"SqlTimestampWithLocalTzType\", FieldType.STRING, \"\", FieldType.DATETIME) {});\n+        return FieldType.logicalType(SqlTypes.DATETIME);", "originalCommit": "705046e2c5275c3efcc3d0f6f541ae53d72df252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMyNzY2NA==", "url": "https://github.com/apache/beam/pull/12711#discussion_r516327664", "bodyText": "Done. Thanks for catching this.", "author": "robinyqiu", "createdAt": "2020-11-02T23:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzgyOQ==", "url": "https://github.com/apache/beam/pull/12711#discussion_r487193829", "body": "Could you make sure that `BigQueryUtils.fromTableSchema` is tested with NUMERIC and DATETIME? It looks like only TIMESTAMP may be tested now (as part of `testTableFromSchema_flat`): https://github.com/apache/beam/blob/738a9100ec5ce09870729b64e1ef483f692134c2/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtilsTest.java#L91-L106", "bodyText": "Could you make sure that BigQueryUtils.fromTableSchema is tested with NUMERIC and DATETIME? It looks like only TIMESTAMP may be tested now (as part of testTableFromSchema_flat): \n  \n    \n      beam/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtilsTest.java\n    \n    \n        Lines 91 to 106\n      in\n      738a910\n    \n    \n    \n    \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT1 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant1\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString()); \n        \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT2 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant2\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString()); \n        \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT3 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant3\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString()); \n        \n\n        \n          \n           private static final TableFieldSchema TIMESTAMP_VARIANT4 = \n        \n\n        \n          \n               new TableFieldSchema() \n        \n\n        \n          \n                   .setName(\"timestamp_variant4\") \n        \n\n        \n          \n                   .setType(StandardSQLTypeName.TIMESTAMP.toString());", "bodyHTML": "<p dir=\"auto\">Could you make sure that <code>BigQueryUtils.fromTableSchema</code> is tested with NUMERIC and DATETIME? It looks like only TIMESTAMP may be tested now (as part of <code>testTableFromSchema_flat</code>): <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/apache/beam/blob/738a9100ec5ce09870729b64e1ef483f692134c2/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtilsTest.java#L91-L106\">beam/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtilsTest.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 91 to 106\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/apache/beam/commit/738a9100ec5ce09870729b64e1ef483f692134c2\">738a910</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L91\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"91\"></td>\n          <td id=\"LC91\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">TableFieldSchema</span> <span class=\"pl-c1\">TIMESTAMP_VARIANT1</span> <span class=\"pl-k\">=</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L92\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"92\"></td>\n          <td id=\"LC92\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">new</span> <span class=\"pl-smi\">TableFieldSchema</span>() </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L93\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"93\"></td>\n          <td id=\"LC93\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setName(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>timestamp_variant1<span class=\"pl-pds\">\"</span></span>) </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L94\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"94\"></td>\n          <td id=\"LC94\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setType(<span class=\"pl-smi\">StandardSQLTypeName</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>TIMESTAMP</span><span class=\"pl-k\">.</span>toString()); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L95\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"95\"></td>\n          <td id=\"LC95\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">TableFieldSchema</span> <span class=\"pl-c1\">TIMESTAMP_VARIANT2</span> <span class=\"pl-k\">=</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L96\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"96\"></td>\n          <td id=\"LC96\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">new</span> <span class=\"pl-smi\">TableFieldSchema</span>() </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L97\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"97\"></td>\n          <td id=\"LC97\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setName(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>timestamp_variant2<span class=\"pl-pds\">\"</span></span>) </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L98\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"98\"></td>\n          <td id=\"LC98\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setType(<span class=\"pl-smi\">StandardSQLTypeName</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>TIMESTAMP</span><span class=\"pl-k\">.</span>toString()); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L99\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"99\"></td>\n          <td id=\"LC99\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">TableFieldSchema</span> <span class=\"pl-c1\">TIMESTAMP_VARIANT3</span> <span class=\"pl-k\">=</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L100\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"100\"></td>\n          <td id=\"LC100\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">new</span> <span class=\"pl-smi\">TableFieldSchema</span>() </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L101\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"101\"></td>\n          <td id=\"LC101\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setName(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>timestamp_variant3<span class=\"pl-pds\">\"</span></span>) </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L102\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"102\"></td>\n          <td id=\"LC102\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setType(<span class=\"pl-smi\">StandardSQLTypeName</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>TIMESTAMP</span><span class=\"pl-k\">.</span>toString()); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L103\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"103\"></td>\n          <td id=\"LC103\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">TableFieldSchema</span> <span class=\"pl-c1\">TIMESTAMP_VARIANT4</span> <span class=\"pl-k\">=</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L104\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"104\"></td>\n          <td id=\"LC104\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">new</span> <span class=\"pl-smi\">TableFieldSchema</span>() </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L105\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"105\"></td>\n          <td id=\"LC105\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setName(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>timestamp_variant4<span class=\"pl-pds\">\"</span></span>) </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L106\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"106\"></td>\n          <td id=\"LC106\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .setType(<span class=\"pl-smi\">StandardSQLTypeName</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>TIMESTAMP</span><span class=\"pl-k\">.</span>toString()); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "TheNeuralBit", "createdAt": "2020-09-11T17:41:09Z", "path": "sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryUtilsTest.java", "diffHunk": "@@ -452,6 +457,27 @@ public void testMicroPrecisionTimeType() {\n         equalTo(t));\n   }\n \n+  @Test\n+  public void testMicroPrecisionDateTimeType() {\n+    LocalDateTime dt = LocalDateTime.parse(\"2020-06-04T12:34:56.789876\");\n+    assertThat(\n+        BigQueryUtils.convertAvroFormat(\n+            FieldType.logicalType(SqlTypes.DATETIME), new Utf8(dt.toString()), REJECT_OPTIONS),\n+        equalTo(dt));\n+  }\n+\n+  @Test\n+  public void testNumericType() {\n+    // BigQuery NUMERIC type has precision 38 and scale 9\n+    BigDecimal n = new BigDecimal(\"123456789.987654321\").setScale(9);\n+    assertThat(\n+        BigQueryUtils.convertAvroFormat(\n+            FieldType.DECIMAL,\n+            new Conversions.DecimalConversion().toBytes(n, null, LogicalTypes.decimal(38, 9)),\n+            REJECT_OPTIONS),\n+        equalTo(n));\n+  }\n+", "originalCommit": "705046e2c5275c3efcc3d0f6f541ae53d72df252", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMyNzg4Nw==", "url": "https://github.com/apache/beam/pull/12711#discussion_r516327887", "bodyText": "Done. Added test for new types: DATE, TIME, and DATETIME.\nTests for NUMERICS is already added in #12730", "author": "robinyqiu", "createdAt": "2020-11-02T23:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE5MzgyOQ=="}], "type": "inlineReview"}, {"oid": "3e373cad7192cd23317acc538ce1d4b3ca0d1e8d", "url": "https://github.com/apache/beam/commit/3e373cad7192cd23317acc538ce1d4b3ca0d1e8d", "message": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "committedDate": "2020-11-02T19:03:54Z", "type": "forcePushed"}, {"oid": "8ff1deca30c34658d81e1190e58b513df24e07be", "url": "https://github.com/apache/beam/commit/8ff1deca30c34658d81e1190e58b513df24e07be", "message": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "committedDate": "2020-11-02T21:15:17Z", "type": "commit"}, {"oid": "8ff1deca30c34658d81e1190e58b513df24e07be", "url": "https://github.com/apache/beam/commit/8ff1deca30c34658d81e1190e58b513df24e07be", "message": "Support read/write ZetaSQL DATETIME/NUMERIC types from/to BigQuery", "committedDate": "2020-11-02T21:15:17Z", "type": "forcePushed"}, {"oid": "e96168a4428ac13fb54e65f8c052da1da9100fd2", "url": "https://github.com/apache/beam/commit/e96168a4428ac13fb54e65f8c052da1da9100fd2", "message": "Address comments", "committedDate": "2020-11-02T23:22:07Z", "type": "commit"}]}