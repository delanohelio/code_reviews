{"pr_number": 13240, "pr_title": "[BEAM-11146] Add fasterCopy option to Flink runner", "pr_author": "rHermes", "pr_createdAt": "2020-10-31T16:33:12Z", "pr_url": "https://github.com/apache/beam/pull/13240", "timeline": [{"oid": "91cf254b091f1aeb83c1be2b9506bc3b056e518d", "url": "https://github.com/apache/beam/commit/91cf254b091f1aeb83c1be2b9506bc3b056e518d", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases.", "committedDate": "2020-10-31T17:33:08Z", "type": "forcePushed"}, {"oid": "52943de2c1e6afbd2d752ccf0549126d42476c00", "url": "https://github.com/apache/beam/commit/52943de2c1e6afbd2d752ccf0549126d42476c00", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases.", "committedDate": "2020-10-31T17:40:16Z", "type": "commit"}, {"oid": "52943de2c1e6afbd2d752ccf0549126d42476c00", "url": "https://github.com/apache/beam/commit/52943de2c1e6afbd2d752ccf0549126d42476c00", "message": "[BEAM-11146] Add copyFaster option to Flink runner\n\nThe copyFaster option, removes an unnecessary deep copy in the Flink\nrunner between each operator. This should lead to improved performance\nin all cases.", "committedDate": "2020-10-31T17:40:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NTQyNA==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516185424", "body": "```suggestion\r\n    private final SerializablePipelineOptions pipelineOptions;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private SerializablePipelineOptions pipelineOptions;\n          \n          \n            \n                private final SerializablePipelineOptions pipelineOptions;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">SerializablePipelineOptions</span> pipelineOptions;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">SerializablePipelineOptions</span> pipelineOptions;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mxm", "createdAt": "2020-11-02T18:49:20Z", "path": "runners/flink/src/main/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperator.java", "diffHunk": "@@ -1194,29 +1200,35 @@ public void verifyDeterministic() throws NonDeterministicException {\n     private Map<TupleTag<?>, Integer> tagsToIds;\n     private Map<TupleTag<?>, OutputTag<WindowedValue<?>>> tagsToOutputTags;\n     private Map<TupleTag<?>, Coder<WindowedValue<?>>> tagsToCoders;\n+    private SerializablePipelineOptions pipelineOptions;", "originalCommit": "52943de2c1e6afbd2d752ccf0549126d42476c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjE4NjU3MA==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516186570", "body": "Perhaps, create a static factory method for all of these defaults? E.g. `FlinkPipelineOptions.default()`", "bodyText": "Perhaps, create a static factory method for all of these defaults? E.g. FlinkPipelineOptions.default()", "bodyHTML": "<p dir=\"auto\">Perhaps, create a static factory method for all of these defaults? E.g. <code>FlinkPipelineOptions.default()</code></p>", "author": "mxm", "createdAt": "2020-11-02T18:51:31Z", "path": "runners/flink/src/test/java/org/apache/beam/runners/flink/translation/wrappers/streaming/DoFnOperatorTest.java", "diffHunk": "@@ -761,7 +797,9 @@ void testSideInputs(boolean keyed) throws Exception {\n               doFnOperator,\n               keySelector,\n               null,\n-              new CoderTypeInformation<>(FlinkKeyUtils.ByteBufferCoder.of()));\n+              new CoderTypeInformation<>(\n+                  FlinkKeyUtils.ByteBufferCoder.of(),\n+                  PipelineOptionsFactory.as(FlinkPipelineOptions.class)));", "originalCommit": "52943de2c1e6afbd2d752ccf0549126d42476c00", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "504f4df1e0986414df2b9104b53af931f46c34a6", "url": "https://github.com/apache/beam/commit/504f4df1e0986414df2b9104b53af931f46c34a6", "message": "Merge remote-tracking branch 'upstream/master' into BEAM-11146-faster-copy", "committedDate": "2020-11-02T19:25:28Z", "type": "commit"}, {"oid": "c8ff19db299dc3c231939efdce140bb33185e121", "url": "https://github.com/apache/beam/commit/c8ff19db299dc3c231939efdce140bb33185e121", "message": "Add defaults() function to FlinkPipelineOptions\n\nThis was requested in the pull request, to make things neater.", "committedDate": "2020-11-03T07:27:22Z", "type": "commit"}, {"oid": "c8ff19db299dc3c231939efdce140bb33185e121", "url": "https://github.com/apache/beam/commit/c8ff19db299dc3c231939efdce140bb33185e121", "message": "Add defaults() function to FlinkPipelineOptions\n\nThis was requested in the pull request, to make things neater.", "committedDate": "2020-11-03T07:27:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516513864", "body": "Small suggestion, can we name this `zeroCopy`, as that is actually what it is.", "bodyText": "Small suggestion, can we name this zeroCopy, as that is actually what it is.", "bodyHTML": "<p dir=\"auto\">Small suggestion, can we name this <code>zeroCopy</code>, as that is actually what it is.</p>", "author": "je-ik", "createdAt": "2020-11-03T09:07:41Z", "path": "runners/flink/1.8/src/main/java/org/apache/beam/runners/flink/translation/types/CoderTypeSerializer.java", "diffHunk": "@@ -49,20 +50,18 @@\n    * org.apache.beam.sdk.io.FileSystems} registration needed for {@link\n    * org.apache.beam.sdk.transforms.Reshuffle} translation.\n    */\n-  @SuppressWarnings(\"unused\")\n-  private final @Nullable SerializablePipelineOptions pipelineOptions;\n+  private final SerializablePipelineOptions pipelineOptions;\n \n-  public CoderTypeSerializer(Coder<T> coder) {\n-    Preconditions.checkNotNull(coder);\n-    this.coder = coder;\n-    this.pipelineOptions = null;\n-  }\n+  private final boolean fasterCopy;", "originalCommit": "c8ff19db299dc3c231939efdce140bb33185e121", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU4MDQxMQ==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516580411", "bodyText": "I thought about zeroCopy as a name, but for me this is associated with the lower level concept and I thought it might create confusion. The name fasterCopy came from the idea that it is making the copying faster, but I am very much open to other names!", "author": "rHermes", "createdAt": "2020-11-03T10:55:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU4MjM2NA==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516582364", "bodyText": "Okay, what about disableValueClone, I think that fasterCopy is a little misleading as well. Faster than what? And why it was slower before? :) It would be good for the flag to describe direct effect (disable, enable something), not a consequence (being faster).", "author": "je-ik", "createdAt": "2020-11-03T10:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU4ODE5Mg==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516588192", "bodyText": "Very much agree with the name being descriptive. How about we go more opinionated, something like disableExcessCopy? There where some back and forth on the mailing list about this point, so I don't want to sneak in my opinion if that is not right. What do you think @mxm ?", "author": "rHermes", "createdAt": "2020-11-03T11:09:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYwNzgyNg==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516607826", "bodyText": "Folks, this is an internal boolean flag which is only used at a single place. If in doubt, one can clearly see what it does. We could add a /** */ Javadoc field comment for it if you will. IMHO the name is really personal preference and I have nothing against fasterCopy as it clearly indicates that the copy() method will return faster. Nothing semantically wrong about that. zeroCopy is not 100% true because we will perform a copy for primitive types but please let's not argue about that. DisableExcessCopy is too opinionated IMHO \ud83d\ude07", "author": "mxm", "createdAt": "2020-11-03T11:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYyOTg3Mg==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516629872", "bodyText": "I agree with DisableExcessCopy being too opinionated. My vote is for fasterCopy, but it is not a hill I will die on :P", "author": "rHermes", "createdAt": "2020-11-03T12:28:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzNjU0OA==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516636548", "bodyText": "To make it clear - although I put my comment to the internal field, I was having in mind mostly the flag in PipelineOptions. These should be aligned.", "author": "je-ik", "createdAt": "2020-11-03T12:40:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzOTEyNA==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516639124", "bodyText": "Agree that this is not 100% important, but if possible, we should make options passed in PipelineOptions the most self-explanatory as possible, because these options are user-facing.", "author": "je-ik", "createdAt": "2020-11-03T12:44:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0MTg2Mw==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516641863", "bodyText": "I've been talking about the user facing flag from the beginning, so I understood you.", "author": "rHermes", "createdAt": "2020-11-03T12:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxMzg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNDE1Ng==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516514156", "body": "Maybe rename to `copyIfNeeded`, as when the flag is on, it doesn't copy anything.", "bodyText": "Maybe rename to copyIfNeeded, as when the flag is on, it doesn't copy anything.", "bodyHTML": "<p dir=\"auto\">Maybe rename to <code>copyIfNeeded</code>, as when the flag is on, it doesn't copy anything.</p>", "author": "je-ik", "createdAt": "2020-11-03T09:08:12Z", "path": "runners/flink/1.8/src/main/java/org/apache/beam/runners/flink/translation/types/CoderTypeSerializer.java", "diffHunk": "@@ -82,10 +81,14 @@ public T createInstance() {\n \n   @Override\n   public T copy(T t) {", "originalCommit": "c8ff19db299dc3c231939efdce140bb33185e121", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUzMTI2Ng==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516531266", "bodyText": "This is a Flink interface method which we can't rename.", "author": "mxm", "createdAt": "2020-11-03T09:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNDE1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU0NzE3Mw==", "url": "https://github.com/apache/beam/pull/13240#discussion_r516547173", "bodyText": "Ah, I missed the @Override annotation. Understood.", "author": "je-ik", "createdAt": "2020-11-03T10:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjUxNDE1Ng=="}], "type": "inlineReview"}]}