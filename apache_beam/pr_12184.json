{"pr_number": 12184, "pr_title": "[BEAM-10392] Make sure that messages that are unroutable are returned to the sender and redelivered.", "pr_author": "lukecwik", "pr_createdAt": "2020-07-06T21:17:08Z", "pr_url": "https://github.com/apache/beam/pull/12184", "timeline": [{"oid": "af1ce25cf9aaf99ae94a98a25fe8287c884d5f2d", "url": "https://github.com/apache/beam/commit/af1ce25cf9aaf99ae94a98a25fe8287c884d5f2d", "message": "[BEAM-10392] Make sure that messages that are unroutable are returned to the sender and redelivered.", "committedDate": "2020-07-06T21:15:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4OTgwMA==", "url": "https://github.com/apache/beam/pull/12184#discussion_r450789800", "body": "I think this has to be:\r\n\r\n```suggestion\r\n    waitForExchangeToBeDeclared.await();\r\n```", "bodyText": "I think this has to be:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                waitForExchangeToBeDeclared.countDown();\n          \n          \n            \n                waitForExchangeToBeDeclared.await();", "bodyHTML": "<p dir=\"auto\">I think this has to be:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    waitForExchangeToBeDeclared<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">countDown</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    waitForExchangeToBeDeclared<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">await</span>();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mxm", "createdAt": "2020-07-07T11:18:12Z", "path": "sdks/java/io/rabbitmq/src/test/java/org/apache/beam/sdk/io/rabbitmq/RabbitMqIOTest.java", "diffHunk": "@@ -196,59 +200,74 @@ private void doExchangeTest(ExchangeTestPlan testPlan, boolean simulateIncompati\n         exchangeType = \"fanout\";\n       }\n     }\n+    final String finalExchangeType = exchangeType;\n+    final CountDownLatch waitForExchangeToBeDeclared = new CountDownLatch(1);\n+    final BlockingQueue<byte[]> recordsToPublish = new LinkedBlockingQueue<>();\n+    recordsToPublish.addAll(RabbitMqTestUtils.generateRecords(testPlan.getNumRecordsToPublish()));\n+    Thread publisher =\n+        new Thread(\n+            () -> {\n+              Connection connection = null;\n+              Channel channel = null;\n+              try {\n+                ConnectionFactory connectionFactory = new ConnectionFactory();\n+                connectionFactory.setAutomaticRecoveryEnabled(false);\n+                connectionFactory.setUri(uri);\n+                connection = connectionFactory.newConnection();\n+                channel = connection.createChannel();\n+                channel.exchangeDeclare(exchange, finalExchangeType);\n+                // We are relying on the pipeline to declare the queue and messages that are\n+                // published without a queue being declared are \"unroutable\". Since there is a race\n+                // between when the pipeline declares and when we can start publishing, we add a\n+                // handler to republish messages that are returned to us.\n+                channel.addReturnListener(\n+                    (replyCode, replyText, exchange1, routingKey, properties, body) -> {\n+                      try {\n+                        recordsToPublish.put(body);\n+                      } catch (Exception e) {\n+                        throw new RuntimeException(e);\n+                      }\n+                    });\n+                waitForExchangeToBeDeclared.countDown();\n+                while (true) {\n+                  byte[] record = recordsToPublish.take();\n+                  if (record == terminalRecord) {\n+                    return;\n+                  }\n+                  channel.basicPublish(\n+                      exchange,\n+                      testPlan.publishRoutingKeyGen().get(),\n+                      true, // ensure that messages are returned to sender\n+                      testPlan.getPublishProperties(),\n+                      record);\n+                }\n \n-    ConnectionFactory connectionFactory = new ConnectionFactory();\n-    connectionFactory.setAutomaticRecoveryEnabled(false);\n-    connectionFactory.setUri(uri);\n-    Connection connection = null;\n-    Channel channel = null;\n-\n-    try {\n-      connection = connectionFactory.newConnection();\n-      channel = connection.createChannel();\n-      channel.exchangeDeclare(exchange, exchangeType);\n-      final Channel finalChannel = channel;\n-      Thread publisher =\n-          new Thread(\n-              () -> {\n-                try {\n-                  Thread.sleep(5000);\n-                } catch (Exception e) {\n-                  LOG.error(e.getMessage(), e);\n+              } catch (Exception e) {\n+                throw new RuntimeException(e);\n+              } finally {\n+                if (channel != null) {\n+                  // channel may have already been closed automatically due to protocol failure\n+                  try {\n+                    channel.close();\n+                  } catch (Exception e) {\n+                    /* ignored */\n+                  }\n                 }\n-                for (int i = 0; i < testPlan.getNumRecordsToPublish(); i++) {\n+                if (connection != null) {\n+                  // connection may have already been closed automatically due to protocol failure\n                   try {\n-                    finalChannel.basicPublish(\n-                        exchange,\n-                        testPlan.publishRoutingKeyGen().get(),\n-                        testPlan.getPublishProperties(),\n-                        RabbitMqTestUtils.generateRecord(i));\n+                    connection.close();\n                   } catch (Exception e) {\n-                    LOG.error(e.getMessage(), e);\n+                    /* ignored */\n                   }\n                 }\n-              });\n-      publisher.start();\n-      p.run();\n-      publisher.join();\n-    } finally {\n-      if (channel != null) {\n-        // channel may have already been closed automatically due to protocol failure\n-        try {\n-          channel.close();\n-        } catch (Exception e) {\n-          /* ignored */\n-        }\n-      }\n-      if (connection != null) {\n-        // connection may have already been closed automatically due to protocol failure\n-        try {\n-          connection.close();\n-        } catch (Exception e) {\n-          /* ignored */\n-        }\n-      }\n-    }\n+              }\n+            });\n+    publisher.start();\n+    waitForExchangeToBeDeclared.countDown();", "originalCommit": "af1ce25cf9aaf99ae94a98a25fe8287c884d5f2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTEyMzczOQ==", "url": "https://github.com/apache/beam/pull/12184#discussion_r451123739", "bodyText": "Your right.", "author": "lukecwik", "createdAt": "2020-07-07T20:27:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc4OTgwMA=="}], "type": "inlineReview"}, {"oid": "b675acaf9093a1e0edf5c1ce181be95405227c09", "url": "https://github.com/apache/beam/commit/b675acaf9093a1e0edf5c1ce181be95405227c09", "message": "Update sdks/java/io/rabbitmq/src/test/java/org/apache/beam/sdk/io/rabbitmq/RabbitMqIOTest.java\n\nCo-authored-by: Maximilian Michels <mxm@apache.org>", "committedDate": "2020-07-07T20:27:28Z", "type": "commit"}]}