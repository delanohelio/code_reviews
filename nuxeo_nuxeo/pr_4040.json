{"pr_number": 4040, "pr_title": "NXP-29107: make explorer ftest using new window more robust", "pr_author": "atchertchian", "pr_createdAt": "2020-05-15T10:20:07Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4040", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDAzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425710037", "body": "Can't a lambda be used here?", "bodyText": "Can't a lambda be used here?", "bodyHTML": "<p dir=\"auto\">Can't a lambda be used here?</p>", "author": "efge", "createdAt": "2020-05-15T10:25:48Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -196,9 +202,27 @@ protected void storeWindowHandle() {\n     }\n \n     protected void switchToNewWindow() {\n-        for (String winHandle : driver.getWindowHandles()) {\n-            driver.switchTo().window(winHandle);\n+        Wait<WebDriver> wait = Locator.getFluentWait();\n+        wait.until((new Function<WebDriver, Boolean>() {", "originalCommit": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxODM4Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425718382", "bodyText": "Maybe, but we need to cleanup these logics in Locator then (where we use this everywhere so i took example on it).\nI can clean this up later if needed.", "author": "atchertchian", "createdAt": "2020-05-15T10:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDAzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcyMzg1OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425723859", "bodyText": "Actually we can't use a lambda as com.google.common.base.Function is not a SAM-type (single abstract method) required for lambda use despite being annotated @FunctionalInterface", "author": "efge", "createdAt": "2020-05-15T10:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDc0Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425710746", "body": "Remove debug println", "bodyText": "Remove debug println", "bodyHTML": "<p dir=\"auto\">Remove debug println</p>", "author": "efge", "createdAt": "2020-05-15T10:27:14Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -196,9 +202,27 @@ protected void storeWindowHandle() {\n     }\n \n     protected void switchToNewWindow() {\n-        for (String winHandle : driver.getWindowHandles()) {\n-            driver.switchTo().window(winHandle);\n+        Wait<WebDriver> wait = Locator.getFluentWait();\n+        wait.until((new Function<WebDriver, Boolean>() {\n+            @Override\n+            public Boolean apply(WebDriver driver) {\n+                try {\n+                    // wait for one more window to be opened\n+                    return driver.getWindowHandles().size() > 1;\n+                } catch (StaleElementReferenceException e) {\n+                    return null;\n+                }\n+            }\n+        }));\n+        // select last handle\n+        String handle = null;\n+        Iterator<String> handleIt = driver.getWindowHandles().iterator();\n+        while (handleIt.hasNext()) {\n+            handle = handleIt.next();\n         }\n+        System.err.println(driver.getWindowHandles());", "originalCommit": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxNTczMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425715731", "bodyText": "oops, thanks", "author": "atchertchian", "createdAt": "2020-05-15T10:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMDc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMzIyOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425713228", "body": "You can use\r\n\r\n    for (String h : driver.getWindowHandles()) {\r\n        handle = h;\r\n    }\r\n\r\nOr if you feel fancy\r\n\r\n    String handle = driver.getWindowHandles().stream().reduce((prev, next) -> next).orElse(null);\r\n", "bodyText": "You can use\nfor (String h : driver.getWindowHandles()) {\n    handle = h;\n}\n\nOr if you feel fancy\nString handle = driver.getWindowHandles().stream().reduce((prev, next) -> next).orElse(null);", "bodyHTML": "<p dir=\"auto\">You can use</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"for (String h : driver.getWindowHandles()) {\n    handle = h;\n}\"><pre><code>for (String h : driver.getWindowHandles()) {\n    handle = h;\n}\n</code></pre></div>\n<p dir=\"auto\">Or if you feel fancy</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"String handle = driver.getWindowHandles().stream().reduce((prev, next) -&gt; next).orElse(null);\"><pre><code>String handle = driver.getWindowHandles().stream().reduce((prev, next) -&gt; next).orElse(null);\n</code></pre></div>", "author": "efge", "createdAt": "2020-05-15T10:32:24Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -196,9 +202,27 @@ protected void storeWindowHandle() {\n     }\n \n     protected void switchToNewWindow() {\n-        for (String winHandle : driver.getWindowHandles()) {\n-            driver.switchTo().window(winHandle);\n+        Wait<WebDriver> wait = Locator.getFluentWait();\n+        wait.until((new Function<WebDriver, Boolean>() {\n+            @Override\n+            public Boolean apply(WebDriver driver) {\n+                try {\n+                    // wait for one more window to be opened\n+                    return driver.getWindowHandles().size() > 1;\n+                } catch (StaleElementReferenceException e) {\n+                    return null;\n+                }\n+            }\n+        }));\n+        // select last handle\n+        String handle = null;\n+        Iterator<String> handleIt = driver.getWindowHandles().iterator();\n+        while (handleIt.hasNext()) {\n+            handle = handleIt.next();", "originalCommit": "8f3286998dbbb73daf2daeb1f9f75477aa48dec4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxNzI1OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425717259", "bodyText": "\ud83d\udc4d i won't be fancy for clarity :)", "author": "atchertchian", "createdAt": "2020-05-15T10:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMzIyOA=="}], "type": "inlineReview"}, {"oid": "e3106e77e3f2590b24ebb2d7f2489602d303179b", "url": "https://github.com/nuxeo/nuxeo/commit/e3106e77e3f2590b24ebb2d7f2489602d303179b", "message": "NXP-29107: make explorer ftest using new window more robust", "committedDate": "2020-05-15T10:39:00Z", "type": "forcePushed"}, {"oid": "bde1043bab16ddf980fe3df6bba6b2360ac65dd6", "url": "https://github.com/nuxeo/nuxeo/commit/bde1043bab16ddf980fe3df6bba6b2360ac65dd6", "message": "NXP-29107: make explorer ftest using new window more robust", "committedDate": "2020-05-15T10:40:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcyMjk2NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4040#discussion_r425722964", "body": "Import not needed anymore", "bodyText": "Import not needed anymore", "bodyHTML": "<p dir=\"auto\">Import not needed anymore</p>", "author": "efge", "createdAt": "2020-05-15T10:53:27Z", "path": "ftests/nuxeo-platform-explorer-ftests/src/test/java/org/nuxeo/functionaltests/explorer/AbstractExplorerTest.java", "diffHunk": "@@ -24,6 +24,7 @@\n import java.io.IOException;\n import java.net.URL;\n import java.nio.charset.StandardCharsets;\n+import java.util.Iterator;", "originalCommit": "bde1043bab16ddf980fe3df6bba6b2360ac65dd6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "url": "https://github.com/nuxeo/nuxeo/commit/51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "message": "NXP-29107: make explorer ftest using new window more robust", "committedDate": "2020-05-15T13:07:49Z", "type": "commit"}, {"oid": "51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "url": "https://github.com/nuxeo/nuxeo/commit/51bbfe6fb2e0dc4d5d326b8a36c51acefd0f3d36", "message": "NXP-29107: make explorer ftest using new window more robust", "committedDate": "2020-05-15T13:07:49Z", "type": "forcePushed"}]}