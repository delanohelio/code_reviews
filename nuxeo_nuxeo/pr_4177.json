{"pr_number": 4177, "pr_title": "fix-NXP-29292-s3-transfer-manager", "pr_author": "nuxeojenkins", "pr_createdAt": "2020-06-23T23:38:29Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4177", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcyNjgyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444726829", "body": "Eclipse formatter puts `com` imports after `org` (and a blank line between the two sections)", "bodyText": "Eclipse formatter puts com imports after org (and a blank line between the two sections)", "bodyHTML": "<p dir=\"auto\">Eclipse formatter puts <code>com</code> imports after <code>org</code> (and a blank line between the two sections)</p>", "author": "efge", "createdAt": "2020-06-24T08:22:41Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3BlobProvider.java", "diffHunk": "@@ -31,6 +31,7 @@\n \n import javax.servlet.http.HttpServletRequest;\n \n+import com.amazonaws.services.s3.transfer.TransferManager;", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc5MTYzOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444791638", "bodyText": "Forgot to setup nuxeo.importorder in IDEA, thx.", "author": "nelsonsilva", "createdAt": "2020-06-24T10:15:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcyNjgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcyNzM2NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444727365", "body": "Please add Javadoc to interface and method, and blank lines around the method.", "bodyText": "Please add Javadoc to interface and method, and blank lines around the method.", "bodyHTML": "<p dir=\"auto\">Please add Javadoc to interface and method, and blank lines around the method.</p>", "author": "efge", "createdAt": "2020-06-24T08:23:38Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3ManagedTransfer.java", "diffHunk": "@@ -12,22 +12,12 @@\n  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n- *\n- * Contributors:\n- *     pierre\n- */\n-package org.nuxeo.ecm.core.storage.sql;\n-\n-/**\n- * Mocked S3 Direct Upload handler to be tested.\n- *\n- * @since 10.2\n  */\n-public class MockedS3DirectBatchHandler extends S3DirectBatchHandler {\n+package org.nuxeo.ecm.blob.s3;\n \n-    @Override\n-    protected long lowerThresholdToUseMultipartCopy() {\n-        return TestS3DirectBatchHandler.MULTIPART_THRESHOLD + 1;\n-    }\n+import com.amazonaws.services.s3.transfer.TransferManager;\n \n+/** @since 11.1 */\n+public interface S3ManagedTransfer {\n+    TransferManager getTransferManager();", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcyNzQ3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444727471", "body": "11.2", "bodyText": "11.2", "bodyHTML": "<p dir=\"auto\">11.2</p>", "author": "efge", "createdAt": "2020-06-24T08:23:48Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3ManagedTransfer.java", "diffHunk": "@@ -12,22 +12,12 @@\n  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n- *\n- * Contributors:\n- *     pierre\n- */\n-package org.nuxeo.ecm.core.storage.sql;\n-\n-/**\n- * Mocked S3 Direct Upload handler to be tested.\n- *\n- * @since 10.2\n  */\n-public class MockedS3DirectBatchHandler extends S3DirectBatchHandler {\n+package org.nuxeo.ecm.blob.s3;\n \n-    @Override\n-    protected long lowerThresholdToUseMultipartCopy() {\n-        return TestS3DirectBatchHandler.MULTIPART_THRESHOLD + 1;\n-    }\n+import com.amazonaws.services.s3.transfer.TransferManager;\n \n+/** @since 11.1 */", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczMDE3MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444730171", "body": "It's enough to do \r\n```suggestion\r\n            Copy copy = transferManager.copy(copyObjectRequest);\r\n```", "bodyText": "It's enough to do\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Copy copy = getTransferManager().copy(copyObjectRequest, amazonS3, null);\n          \n          \n            \n                        Copy copy = transferManager.copy(copyObjectRequest);", "bodyHTML": "<p dir=\"auto\">It's enough to do</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">Copy</span> copy <span class=\"pl-k\">=</span> <span class=\"x x-first x-last\">getTransferManager()</span><span class=\"pl-k\">.</span>copy(copyObjectRequest<span class=\"x x-first\">, amazonS3, </span><span class=\"pl-c1 x x-last\">null</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">Copy</span> copy <span class=\"pl-k\">=</span> <span class=\"x x-first x-last\">transferManager</span><span class=\"pl-k\">.</span>copy(copyObjectRequest);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "efge", "createdAt": "2020-06-24T08:28:06Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3BinaryManager.java", "diffHunk": "@@ -556,17 +564,24 @@ protected String copyBlob(S3BinaryManager sourceBlobProvider, String blobKey) th\n         }\n         long length = sourceMetadata.getContentLength();\n         try {\n-            String sseAlgorithm;\n+            CopyObjectRequest copyObjectRequest = new CopyObjectRequest(sourceBucketName, sourceKey, bucketName, key);\n             if (useServerSideEncryption) {\n                 if (isNotBlank(serverSideKMSKeyID)) { // TODO\n                     log.warn(\"S3 copy not supported with KMS, falling back to regular copy\");\n                     return null;\n                 }\n-                sseAlgorithm = ObjectMetadata.AES_256_SERVER_SIDE_ENCRYPTION;\n-            } else {\n-                sseAlgorithm = null;\n+                // SSE-S3\n+                ObjectMetadata newObjectMetadata = new ObjectMetadata();\n+                newObjectMetadata.setSSEAlgorithm(ObjectMetadata.AES_256_SERVER_SIDE_ENCRYPTION);\n+                copyObjectRequest.setNewObjectMetadata(newObjectMetadata);\n+            }\n+            Copy copy = getTransferManager().copy(copyObjectRequest, amazonS3, null);", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczMTE4NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444731184", "body": "`com` imports after `org`", "bodyText": "com imports after org", "bodyHTML": "<p dir=\"auto\"><code>com</code> imports after <code>org</code></p>", "author": "efge", "createdAt": "2020-06-24T08:29:52Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -34,24 +34,27 @@\n import static org.nuxeo.ecm.core.storage.sql.S3BinaryManager.BUCKET_REGION_PROPERTY;\n import static org.nuxeo.ecm.core.storage.sql.S3BinaryManager.ENDPOINT_PROPERTY;\n import static org.nuxeo.ecm.core.storage.sql.S3BinaryManager.PATHSTYLEACCESS_PROPERTY;\n-import static org.nuxeo.ecm.core.storage.sql.S3Utils.NON_MULTIPART_COPY_MAX_SIZE;\n \n import java.io.IOException;\n import java.io.Serializable;\n import java.util.HashMap;\n import java.util.Map;\n import java.util.Objects;\n-import java.util.regex.Pattern;\n \n+import com.amazonaws.services.s3.model.CopyObjectRequest;\n+import com.amazonaws.services.s3.transfer.Copy;\n+import com.amazonaws.services.s3.transfer.TransferManager;", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczMjgzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444732835", "body": "```suggestion\r\n        Copy copy = getTransferManager().copy(copyObjectRequest);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    TransferManager transferManager = getTransferManager();\n          \n          \n            \n                    Copy copy = transferManager.copy(copyObjectRequest, amazonS3, null);\n          \n          \n            \n                    Copy copy = getTransferManager().copy(copyObjectRequest);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">TransferManager</span> transferManager <span class=\"pl-k\">=</span> getTransferManager();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">Copy</span> copy <span class=\"pl-k\">=</span> transferManager<span class=\"pl-k\">.</span>copy(copyObjectRequest, amazonS3, <span class=\"pl-c1\">null</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">Copy</span> copy <span class=\"pl-k\">=</span> getTransferManager()<span class=\"pl-k\">.</span>copy(copyObjectRequest);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "efge", "createdAt": "2020-06-24T08:32:45Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -258,29 +257,28 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         blobInfo.filename = fileInfo.getFilename();\n         blobInfo.length = metadata.getContentLength();\n \n+        CopyObjectRequest copyObjectRequest = new CopyObjectRequest(bucket, fileKey, bucket, bucketKey);\n         // server-side encryption\n-        String targetSSEAlgorithm;\n         if (useServerSideEncryption) { // TODO KMS\n-            targetSSEAlgorithm = ObjectMetadata.AES_256_SERVER_SIDE_ENCRYPTION;\n-        } else {\n-            targetSSEAlgorithm = null;\n+            // SSE-S3\n+            ObjectMetadata newObjectMetadata = new ObjectMetadata();\n+            newObjectMetadata.setSSEAlgorithm(ObjectMetadata.AES_256_SERVER_SIDE_ENCRYPTION);\n+            copyObjectRequest.setNewObjectMetadata(newObjectMetadata);\n         }\n \n-        ObjectMetadata newMetadata;\n-        if (metadata.getContentLength() > lowerThresholdToUseMultipartCopy()) {\n-            newMetadata = S3Utils.copyFileMultipart(amazonS3, metadata, bucket, fileKey, bucket, bucketKey,\n-                    targetSSEAlgorithm, true);\n-        } else {\n-            newMetadata = S3Utils.copyFile(amazonS3, metadata, bucket, fileKey, bucket, bucketKey, targetSSEAlgorithm, true);\n-            boolean isMultipartUpload = REGEX_MULTIPART_ETAG.matcher(key).find();\n-            if (isMultipartUpload) {\n-                key = newMetadata.getETag();\n-                String previousBucketKey = bucketKey;\n-                bucketKey = bucketPrefix + key;\n-                newMetadata = S3Utils.copyFile(amazonS3, metadata, bucket, previousBucketKey, bucket, bucketKey, true);\n-            }\n+        TransferManager transferManager = getTransferManager();\n+        Copy copy = transferManager.copy(copyObjectRequest, amazonS3, null);", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczNzEzOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444737138", "body": "Instead of `copy.waitForCompletion` if you call `copy.waitForCopyResult` it will a return a `CopyResult` object with a `getETag` method. It's better than doing an additional round-trip but it doesn't do the same as `newMetadata.getContentMD5()`... as the ETag may not be an MD5.\r\nI see internal AWS SDK code that just checks for the presence of `-` to determine if it's an ETag from multipart upload... I think we could just say that if it's 32 chars en length then it's a proper MD5 and we can use it as the digest. Or maybe keep it for now and refactor later.", "bodyText": "Instead of copy.waitForCompletion if you call copy.waitForCopyResult it will a return a CopyResult object with a getETag method. It's better than doing an additional round-trip but it doesn't do the same as newMetadata.getContentMD5()... as the ETag may not be an MD5.\nI see internal AWS SDK code that just checks for the presence of - to determine if it's an ETag from multipart upload... I think we could just say that if it's 32 chars en length then it's a proper MD5 and we can use it as the digest. Or maybe keep it for now and refactor later.", "bodyHTML": "<p dir=\"auto\">Instead of <code>copy.waitForCompletion</code> if you call <code>copy.waitForCopyResult</code> it will a return a <code>CopyResult</code> object with a <code>getETag</code> method. It's better than doing an additional round-trip but it doesn't do the same as <code>newMetadata.getContentMD5()</code>... as the ETag may not be an MD5.<br>\nI see internal AWS SDK code that just checks for the presence of <code>-</code> to determine if it's an ETag from multipart upload... I think we could just say that if it's 32 chars en length then it's a proper MD5 and we can use it as the digest. Or maybe keep it for now and refactor later.</p>", "author": "efge", "createdAt": "2020-06-24T08:40:17Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -258,29 +257,28 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         blobInfo.filename = fileInfo.getFilename();\n         blobInfo.length = metadata.getContentLength();\n \n+        CopyObjectRequest copyObjectRequest = new CopyObjectRequest(bucket, fileKey, bucket, bucketKey);\n         // server-side encryption\n-        String targetSSEAlgorithm;\n         if (useServerSideEncryption) { // TODO KMS\n-            targetSSEAlgorithm = ObjectMetadata.AES_256_SERVER_SIDE_ENCRYPTION;\n-        } else {\n-            targetSSEAlgorithm = null;\n+            // SSE-S3\n+            ObjectMetadata newObjectMetadata = new ObjectMetadata();\n+            newObjectMetadata.setSSEAlgorithm(ObjectMetadata.AES_256_SERVER_SIDE_ENCRYPTION);\n+            copyObjectRequest.setNewObjectMetadata(newObjectMetadata);\n         }\n \n-        ObjectMetadata newMetadata;\n-        if (metadata.getContentLength() > lowerThresholdToUseMultipartCopy()) {\n-            newMetadata = S3Utils.copyFileMultipart(amazonS3, metadata, bucket, fileKey, bucket, bucketKey,\n-                    targetSSEAlgorithm, true);\n-        } else {\n-            newMetadata = S3Utils.copyFile(amazonS3, metadata, bucket, fileKey, bucket, bucketKey, targetSSEAlgorithm, true);\n-            boolean isMultipartUpload = REGEX_MULTIPART_ETAG.matcher(key).find();\n-            if (isMultipartUpload) {\n-                key = newMetadata.getETag();\n-                String previousBucketKey = bucketKey;\n-                bucketKey = bucketPrefix + key;\n-                newMetadata = S3Utils.copyFile(amazonS3, metadata, bucket, previousBucketKey, bucket, bucketKey, true);\n-            }\n+        TransferManager transferManager = getTransferManager();\n+        Copy copy = transferManager.copy(copyObjectRequest, amazonS3, null);\n+        try {\n+            copy.waitForCompletion();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new NuxeoException(e);\n+        } finally {\n+            amazonS3.deleteObject(bucket, fileKey);\n         }\n \n+        ObjectMetadata newMetadata = amazonS3.getObjectMetadata(bucket, bucketKey);", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc5NTkzNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444795934", "bodyText": "I plan to do another PR where the usage of a generic etag vs md5 is possible behind a flag, will take that into account", "author": "nelsonsilva", "createdAt": "2020-06-24T10:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczNzEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczNzQ0OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444737448", "body": "11.2, but not needed for `protected` methods", "bodyText": "11.2, but not needed for protected methods", "bodyHTML": "<p dir=\"auto\">11.2, but not needed for <code>protected</code> methods</p>", "author": "efge", "createdAt": "2020-06-24T08:40:47Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3DirectBatchHandler.java", "diffHunk": "@@ -302,8 +300,13 @@ public boolean completeUpload(String batchId, String fileIndex, BatchFileInfo fi\n         return true;\n     }\n \n-    protected long lowerThresholdToUseMultipartCopy() {\n-        return NON_MULTIPART_COPY_MAX_SIZE;\n+    /** @since 11.1 */", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDczODM2Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444738366", "body": "`@since` -> `@deprecated since`", "bodyText": "@since -> @deprecated since", "bodyHTML": "<p dir=\"auto\"><code>@since</code> -&gt; <code>@deprecated since</code></p>", "author": "efge", "createdAt": "2020-06-24T08:42:24Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3Utils.java", "diffHunk": "@@ -168,7 +170,9 @@ public static ObjectMetadata copyFileMultipart(AmazonS3 amazonS3, ObjectMetadata\n      * @param targetSSEAlgorithm the target SSE Algorithm to use, or {@code null}\n      * @param deleteSource whether to delete the source object if the copy is successful\n      * @since 11.1\n+     * @since 11.2", "originalCommit": "8f913b9f30ce6e03db14776b47c83b7c9256c94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "url": "https://github.com/nuxeo/nuxeo/commit/afe272961c1961ac826c1f78bf102bbb7fa3e765", "message": "NXP-29292: use aws transfermanager for s3 copy", "committedDate": "2020-06-24T10:25:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5MjQ2Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444892463", "body": "There should be a blank line before the tags.", "bodyText": "There should be a blank line before the tags.", "bodyHTML": "<p dir=\"auto\">There should be a blank line before the tags.</p>", "author": "troger", "createdAt": "2020-06-24T13:27:53Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3ManagedTransfer.java", "diffHunk": "@@ -12,22 +12,21 @@\n  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n- *\n- * Contributors:\n- *     pierre\n  */\n-package org.nuxeo.ecm.core.storage.sql;\n+package org.nuxeo.ecm.blob.s3;\n+\n+import com.amazonaws.services.s3.transfer.TransferManager;\n \n /**\n- * Mocked S3 Direct Upload handler to be tested.\n- *\n- * @since 10.2\n+ * S3 transfers relying on {@link TransferManager}\n+ * @since 11.2", "originalCommit": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5MjYyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444892622", "body": "```suggestion\r\n * S3 transfers relying on {@link TransferManager}.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * S3 transfers relying on {@link TransferManager}\n          \n          \n            \n             * S3 transfers relying on {@link TransferManager}.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-c1\">S3</span> transfers relying on {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">TransferManager</span>}</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-c1\">S3</span> transfers relying on {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">TransferManager</span>}<span class=\"pl-c1 x x-first x-last\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-24T13:28:07Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3ManagedTransfer.java", "diffHunk": "@@ -12,22 +12,21 @@\n  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n- *\n- * Contributors:\n- *     pierre\n  */\n-package org.nuxeo.ecm.core.storage.sql;\n+package org.nuxeo.ecm.blob.s3;\n+\n+import com.amazonaws.services.s3.transfer.TransferManager;\n \n /**\n- * Mocked S3 Direct Upload handler to be tested.\n- *\n- * @since 10.2\n+ * S3 transfers relying on {@link TransferManager}", "originalCommit": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5Mjc1Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444892756", "body": "```suggestion\r\n     * Returns the {@link TransferManager}.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns the {@link TransferManager}\n          \n          \n            \n                 * Returns the {@link TransferManager}.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Returns</span> the {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">TransferManager</span>}</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Returns</span> the {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">TransferManager</span>}<span class=\"pl-c1 x x-first x-last\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-24T13:28:17Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3ManagedTransfer.java", "diffHunk": "@@ -12,22 +12,21 @@\n  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n- *\n- * Contributors:\n- *     pierre\n  */\n-package org.nuxeo.ecm.core.storage.sql;\n+package org.nuxeo.ecm.blob.s3;\n+\n+import com.amazonaws.services.s3.transfer.TransferManager;\n \n /**\n- * Mocked S3 Direct Upload handler to be tested.\n- *\n- * @since 10.2\n+ * S3 transfers relying on {@link TransferManager}\n+ * @since 11.2\n  */\n-public class MockedS3DirectBatchHandler extends S3DirectBatchHandler {\n+public interface S3ManagedTransfer {\n \n-    @Override\n-    protected long lowerThresholdToUseMultipartCopy() {\n-        return TestS3DirectBatchHandler.MULTIPART_THRESHOLD + 1;\n-    }\n+    /**\n+     * Returns the {@link TransferManager}", "originalCommit": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5Mjg1NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444892854", "body": "Blank line before.", "bodyText": "Blank line before.", "bodyHTML": "<p dir=\"auto\">Blank line before.</p>", "author": "troger", "createdAt": "2020-06-24T13:28:26Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/blob/s3/S3ManagedTransfer.java", "diffHunk": "@@ -12,22 +12,21 @@\n  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n- *\n- * Contributors:\n- *     pierre\n  */\n-package org.nuxeo.ecm.core.storage.sql;\n+package org.nuxeo.ecm.blob.s3;\n+\n+import com.amazonaws.services.s3.transfer.TransferManager;\n \n /**\n- * Mocked S3 Direct Upload handler to be tested.\n- *\n- * @since 10.2\n+ * S3 transfers relying on {@link TransferManager}\n+ * @since 11.2\n  */\n-public class MockedS3DirectBatchHandler extends S3DirectBatchHandler {\n+public interface S3ManagedTransfer {\n \n-    @Override\n-    protected long lowerThresholdToUseMultipartCopy() {\n-        return TestS3DirectBatchHandler.MULTIPART_THRESHOLD + 1;\n-    }\n+    /**\n+     * Returns the {@link TransferManager}\n+     * @since 11.2", "originalCommit": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5NDIyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444894222", "body": "Specify what to use instead.\r\n\r\n```\r\n@deprecated since 11.2, use XXXX instead\r\n```", "bodyText": "Specify what to use instead.\n@deprecated since 11.2, use XXXX instead", "bodyHTML": "<p dir=\"auto\">Specify what to use instead.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"@deprecated since 11.2, use XXXX instead\"><pre><code>@deprecated since 11.2, use XXXX instead\n</code></pre></div>", "author": "troger", "createdAt": "2020-06-24T13:30:22Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3Utils.java", "diffHunk": "@@ -125,7 +125,9 @@ public static void processSlices(long slice, long length, SliceConsumer consumer\n      * @param targetSSEAlgorithm the target SSE Algorithm to use, or {@code null}\n      * @param deleteSource whether to delete the source object if the copy is successful\n      * @since 11.1\n+     * @deprecated since 11.2", "originalCommit": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5NDMyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444894322", "body": "Same as above.", "bodyText": "Same as above.", "bodyHTML": "<p dir=\"auto\">Same as above.</p>", "author": "troger", "createdAt": "2020-06-24T13:30:32Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3Utils.java", "diffHunk": "@@ -168,7 +170,9 @@ public static ObjectMetadata copyFileMultipart(AmazonS3 amazonS3, ObjectMetadata\n      * @param targetSSEAlgorithm the target SSE Algorithm to use, or {@code null}\n      * @param deleteSource whether to delete the source object if the copy is successful\n      * @since 11.1\n+     * @deprecated since 11.2", "originalCommit": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg5NDQzNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4177#discussion_r444894437", "body": "Same as above.", "bodyText": "Same as above.", "bodyHTML": "<p dir=\"auto\">Same as above.</p>", "author": "troger", "createdAt": "2020-06-24T13:30:40Z", "path": "modules/core/nuxeo-core-binarymanager-cloud/nuxeo-core-binarymanager-s3/src/main/java/org/nuxeo/ecm/core/storage/sql/S3Utils.java", "diffHunk": "@@ -249,7 +253,9 @@ public static ObjectMetadata copyFile(AmazonS3 amazonS3, ObjectMetadata objectMe\n      * @param targetSSEAlgorithm the target SSE Algorithm to use, or {@code null}\n      * @param deleteSource whether to delete the source object if the copy is successful\n      * @since 11.1\n+     * @deprecated since 11.2", "originalCommit": "afe272961c1961ac826c1f78bf102bbb7fa3e765", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1a18e8ab9f2bdbc4242590aa7dc718584afbdde", "url": "https://github.com/nuxeo/nuxeo/commit/e1a18e8ab9f2bdbc4242590aa7dc718584afbdde", "message": "NXP-29292: use aws transfermanager for s3 copy", "committedDate": "2020-06-24T13:39:24Z", "type": "commit"}, {"oid": "e1a18e8ab9f2bdbc4242590aa7dc718584afbdde", "url": "https://github.com/nuxeo/nuxeo/commit/e1a18e8ab9f2bdbc4242590aa7dc718584afbdde", "message": "NXP-29292: use aws transfermanager for s3 copy", "committedDate": "2020-06-24T13:39:24Z", "type": "forcePushed"}]}