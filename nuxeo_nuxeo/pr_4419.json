{"pr_number": 4419, "pr_title": "NXP-29759: Make the task endpoint use the UserManagerResolver", "pr_author": "charlesboidot", "pr_createdAt": "2020-10-28T14:48:40Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4419", "timeline": [{"oid": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "url": "https://github.com/nuxeo/nuxeo/commit/bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-10T09:00:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwODUxOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520408519", "body": "Format issue.", "bodyText": "Format issue.", "bodyHTML": "<p dir=\"auto\">Format issue.</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:21:39Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1240,11 +1240,17 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if(initiatorNode.get(\"isPartial\").booleanValue()==false) {\n+                assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n+                assertEquals(1, groups.size());\n+                assertEquals(\"administrators\", groups.get(0).textValue());\n+            }\n+            else {\n+                assertFalse(initiatorNode.get(\"isAdministrator\").booleanValue());\n+                assertTrue(groups.isEmpty());\n+            }", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQwOTQzMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520409432", "body": "Please use `!` as it is boolean.", "bodyText": "Please use ! as it is boolean.", "bodyHTML": "<p dir=\"auto\">Please use <code>!</code> as it is boolean.</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:22:57Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1240,11 +1240,17 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if(initiatorNode.get(\"isPartial\").booleanValue()==false) {", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMDMzMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520410333", "body": "Can you move it at the end of field declarations? No need to init it to `false` it is already the default value.", "bodyText": "Can you move it at the end of field declarations? No need to init it to false it is already the default value.", "bodyHTML": "<p dir=\"auto\">Can you move it at the end of field declarations? No need to init it to <code>false</code> it is already the default value.</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:24:16Z", "path": "modules/platform/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/NuxeoPrincipalImpl.java", "diffHunk": "@@ -59,6 +59,11 @@\n \n     protected UserConfig config = UserConfig.DEFAULT;\n \n+    /**\n+     * @since 11.4\n+     */\n+    protected boolean isPartial = false;\n+", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMjgwMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520412801", "body": "Could you move it to its getter?", "bodyText": "Could you move it to its getter?", "bodyHTML": "<p dir=\"auto\">Could you move it to its getter?</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:27:48Z", "path": "modules/core/nuxeo-core-api/src/main/java/org/nuxeo/ecm/core/api/NuxeoPrincipal.java", "diffHunk": "@@ -149,6 +149,11 @@\n      */\n     void setPrincipalId(String principalId);\n \n+    /**\n+     * @since 11.4\n+     */\n+    void setIsPartial(boolean partial);\n+", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMzEwOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520413108", "body": "Missing a `@Override` no?", "bodyText": "Missing a @Override no?", "bodyHTML": "<p dir=\"auto\">Missing a <code>@Override</code> no?</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:28:18Z", "path": "modules/platform/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/NuxeoPrincipalImpl.java", "diffHunk": "@@ -179,6 +184,13 @@ public void setLastName(String lastName) {\n         dataModel.setData(config.lastNameKey, lastName);\n     }\n \n+    /**\n+     * @since 11.4\n+     */\n+    public void setIsPartial(boolean partial) {\n+        isPartial = partial;\n+    }", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMzIyNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520413224", "body": "Could you move it before the `TransferableClone`? Also, could you move its setter close to it?", "bodyText": "Could you move it before the TransferableClone? Also, could you move its setter close to it?", "bodyHTML": "<p dir=\"auto\">Could you move it before the <code>TransferableClone</code>? Also, could you move its setter close to it?</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:28:28Z", "path": "modules/platform/nuxeo-platform-usermanager-api/src/main/java/org/nuxeo/ecm/platform/usermanager/NuxeoPrincipalImpl.java", "diffHunk": "@@ -493,4 +505,9 @@ private Object writeReplace() throws ObjectStreamException {\n             return new DataTransferObject(this);\n         }\n     }\n+\n+    @Override\n+    public boolean isPartial() {\n+        return isPartial;\n+    }", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxNDU4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520414589", "body": "Can you move it to other `is..` fields and keep the same order as the one you use in the `NuxoePrincipal` interface?", "bodyText": "Can you move it to other is.. fields and keep the same order as the one you use in the NuxoePrincipal interface?", "bodyHTML": "<p dir=\"auto\">Can you move it to other <code>is..</code> fields and keep the same order as the one you use in the <code>NuxoePrincipal</code> interface?</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:30:18Z", "path": "modules/platform/nuxeo-platform-usermanager-core/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -111,6 +111,7 @@ public NuxeoPrincipalJsonWriter() {\n \n     @Override\n     protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throws IOException {\n+        jg.writeBooleanField(\"isPartial\", principal.isPartial());", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxNDc2OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r520414769", "body": "To remove I think?", "bodyText": "To remove I think?", "bodyHTML": "<p dir=\"auto\">To remove I think?</p>", "author": "kevinleturc", "createdAt": "2020-11-10T09:30:35Z", "path": "modules/platform/nuxeo-platform-usermanager-core/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -50,8 +50,9 @@ public NuxeoPrincipalJsonWriterTest() {\n     public void test() throws Exception {\n         NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n         JsonAssert json = jsonAssert(principal);\n+        System.out.println(json.toString());", "originalCommit": "bbac3f47b9155ff1d63441bba1f4c9345ff0fd1e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d648975e19fcdcb86d9b845b7c713d3edb5efb62", "url": "https://github.com/nuxeo/nuxeo/commit/d648975e19fcdcb86d9b845b7c713d3edb5efb62", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-13T15:01:44Z", "type": "forcePushed"}, {"oid": "281e2ba77df14061a04500ed8c1fa14bc0d8c43c", "url": "https://github.com/nuxeo/nuxeo/commit/281e2ba77df14061a04500ed8c1fa14bc0d8c43c", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-13T15:03:58Z", "type": "forcePushed"}, {"oid": "374c733d29dada518e6630f32b37091a2a58f13d", "url": "https://github.com/nuxeo/nuxeo/commit/374c733d29dada518e6630f32b37091a2a58f13d", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-13T15:07:57Z", "type": "forcePushed"}, {"oid": "c5bccd4c0b8410ba5f37b9fc6ce8da85823a2a53", "url": "https://github.com/nuxeo/nuxeo/commit/c5bccd4c0b8410ba5f37b9fc6ce8da85823a2a53", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-13T15:09:12Z", "type": "forcePushed"}, {"oid": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "url": "https://github.com/nuxeo/nuxeo/commit/cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-13T15:13:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NTUyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523055523", "body": "Space before `(`. Also after the other changes below `initiatorNode.get(\"isPartial\")` may be null so this must be checked.", "bodyText": "Space before (. Also after the other changes below initiatorNode.get(\"isPartial\") may be null so this must be checked.", "bodyHTML": "<p dir=\"auto\">Space before <code>(</code>. Also after the other changes below <code>initiatorNode.get(\"isPartial\")</code> may be null so this must be checked.</p>", "author": "efge", "createdAt": "2020-11-13T16:18:56Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1239,11 +1239,16 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if(!initiatorNode.get(\"isPartial\").booleanValue()) {", "originalCommit": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NjE5MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523056191", "body": "Space before `(` and around `!=`.", "bodyText": "Space before ( and around !=.", "bodyHTML": "<p dir=\"auto\">Space before <code>(</code> and around <code>!=</code>.</p>", "author": "efge", "createdAt": "2020-11-13T16:19:47Z", "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1259,7 +1259,11 @@ protected DocumentModel getUserModel(String userName, DocumentModel context, boo\n         }\n \n         try (Session userDir = dirService.open(userDirectoryName, context)) {\n-            return userDir.getEntry(userName, fetchReferences);\n+            DocumentModel userModel = userDir.getEntry(userName, fetchReferences);\n+            if(userModel!=null) {", "originalCommit": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1NzkyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523057929", "body": "Please put `\"userHasPartialContent\"` in a constant in `UserManagerImpl` (so, internal for now), and use it also from `NuxeoPrincipalJsonWriter`.", "bodyText": "Please put \"userHasPartialContent\" in a constant in UserManagerImpl (so, internal for now), and use it also from NuxeoPrincipalJsonWriter.", "bodyHTML": "<p dir=\"auto\">Please put <code>\"userHasPartialContent\"</code> in a constant in <code>UserManagerImpl</code> (so, internal for now), and use it also from <code>NuxeoPrincipalJsonWriter</code>.</p>", "author": "efge", "createdAt": "2020-11-13T16:22:33Z", "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1259,7 +1259,11 @@ protected DocumentModel getUserModel(String userName, DocumentModel context, boo\n         }\n \n         try (Session userDir = dirService.open(userDirectoryName, context)) {\n-            return userDir.getEntry(userName, fetchReferences);\n+            DocumentModel userModel = userDir.getEntry(userName, fetchReferences);\n+            if(userModel!=null) {\n+                userModel.putContextData(\"userHasPartialContent\", !fetchReferences);", "originalCommit": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA1ODkwOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523058909", "body": "I'd rather we put nothing in the context if the user is \"normal\", so just:\r\n```\r\n            if (userModel != null && !fetchReferences) {\r\n                userModel.putContextData(USER_HAS_PARTIAL_CONTENT, true);\r\n            }\r\n```", "bodyText": "I'd rather we put nothing in the context if the user is \"normal\", so just:\n            if (userModel != null && !fetchReferences) {\n                userModel.putContextData(USER_HAS_PARTIAL_CONTENT, true);\n            }", "bodyHTML": "<p dir=\"auto\">I'd rather we put nothing in the context if the user is \"normal\", so just:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"            if (userModel != null &amp;&amp; !fetchReferences) {\n                userModel.putContextData(USER_HAS_PARTIAL_CONTENT, true);\n            }\"><pre><code>            if (userModel != null &amp;&amp; !fetchReferences) {\n                userModel.putContextData(USER_HAS_PARTIAL_CONTENT, true);\n            }\n</code></pre></div>", "author": "efge", "createdAt": "2020-11-13T16:24:07Z", "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/UserManagerImpl.java", "diffHunk": "@@ -1259,7 +1259,11 @@ protected DocumentModel getUserModel(String userName, DocumentModel context, boo\n         }\n \n         try (Session userDir = dirService.open(userDirectoryName, context)) {\n-            return userDir.getEntry(userName, fetchReferences);\n+            DocumentModel userModel = userDir.getEntry(userName, fetchReferences);\n+            if(userModel!=null) {", "originalCommit": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2MzY3Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523063677", "body": "Let's not write anything if the user is \"normal\".\r\nAlso the model and the context data are never null.\r\nFinally let's be more robust about the boolean check, check explicitly for true.\r\n```\r\n        Serializable isPartial = principal.getModel().getContextData().get(USER_HAS_PARTIAL_CONTENT);\r\n        if (Boolean.TRUE.equals(isPartial)) {\r\n            jg.writeBooleanField(\"isPartial\", true);\r\n        }\r\n```", "bodyText": "Let's not write anything if the user is \"normal\".\nAlso the model and the context data are never null.\nFinally let's be more robust about the boolean check, check explicitly for true.\n        Serializable isPartial = principal.getModel().getContextData().get(USER_HAS_PARTIAL_CONTENT);\n        if (Boolean.TRUE.equals(isPartial)) {\n            jg.writeBooleanField(\"isPartial\", true);\n        }", "bodyHTML": "<p dir=\"auto\">Let's not write anything if the user is \"normal\".<br>\nAlso the model and the context data are never null.<br>\nFinally let's be more robust about the boolean check, check explicitly for true.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"        Serializable isPartial = principal.getModel().getContextData().get(USER_HAS_PARTIAL_CONTENT);\n        if (Boolean.TRUE.equals(isPartial)) {\n            jg.writeBooleanField(&quot;isPartial&quot;, true);\n        }\"><pre><code>        Serializable isPartial = principal.getModel().getContextData().get(USER_HAS_PARTIAL_CONTENT);\n        if (Boolean.TRUE.equals(isPartial)) {\n            jg.writeBooleanField(\"isPartial\", true);\n        }\n</code></pre></div>", "author": "efge", "createdAt": "2020-11-13T16:31:47Z", "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -111,6 +111,13 @@ public NuxeoPrincipalJsonWriter() {\n \n     @Override\n     protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throws IOException {\n+        jg.writeBooleanField(\"isPartial\", false);\n+        if (principal.getModel() != null && principal.getModel().getContextData() != null) {\n+            Serializable isPartial = principal.getModel().getContextData().get(\"userHasPartialContent\");\n+            if (isPartial != null) {\n+                jg.writeBooleanField(\"isPartial\", (boolean) isPartial);\n+            }\n+        }", "originalCommit": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2ODAxNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523068017", "bodyText": "Also @kevinleturc remarked that this should be moved below, with other is* properties.", "author": "efge", "createdAt": "2020-11-13T16:38:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA3NTQxMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523075413", "bodyText": "@charlesboidot asked me about the doc being null.\nAs we have a nullity check in writeProperties, I advised doing the same.\nIn the end, I'm in favor of adding the nullity check or remove the one present in writeProperties, wdyt?", "author": "kevinleturc", "createdAt": "2020-11-13T16:49:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2MzY3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA5ODg1Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523098857", "bodyText": "Yes ok for the model we should be a bit careful, as for instance SystemPrincipal has a null model. Ok to re-add the check:\n        DocumentModel model = principal.getModel();\n        if (model != null) {\n            if (Boolean.TRUE.equals(model.getContextData().get(USER_HAS_PARTIAL_CONTENT))) {\n                jg.writeBooleanField(\"isPartial\", true);\n            }\n        }", "author": "efge", "createdAt": "2020-11-13T17:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2MzY3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2NDMxOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r523064318", "body": "Will probably be `6` if there's no partial content. It would be good to make sure that in this test class we have a test with and without partial content (and check `json.has(\"isPartial\").isTrue()` in that case).", "bodyText": "Will probably be 6 if there's no partial content. It would be good to make sure that in this test class we have a test with and without partial content (and check json.has(\"isPartial\").isTrue() in that case).", "bodyHTML": "<p dir=\"auto\">Will probably be <code>6</code> if there's no partial content. It would be good to make sure that in this test class we have a test with and without partial content (and check <code>json.has(\"isPartial\").isTrue()</code> in that case).</p>", "author": "efge", "createdAt": "2020-11-13T16:32:50Z", "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -51,7 +51,7 @@ public void test() throws Exception {\n         NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n         JsonAssert json = jsonAssert(principal);\n         json.isObject();\n-        json.properties(6);\n+        json.properties(7);", "originalCommit": "cf0c172179c1dffde1d48cbb95294f5dbd8156a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "140d7d82944043cbcbc19a027e68ea10c0065380", "url": "https://github.com/nuxeo/nuxeo/commit/140d7d82944043cbcbc19a027e68ea10c0065380", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-16T15:53:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM3OTU0NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524379544", "body": "Format issue.", "bodyText": "Format issue.", "bodyHTML": "<p dir=\"auto\">Format issue.</p>", "author": "kevinleturc", "createdAt": "2020-11-16T16:02:00Z", "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -88,4 +88,32 @@ public void testSystemUser() throws Exception {\n         exGroup.has(\"url\").isEquals(\"group/administrators\");\n     }\n \n+    @Test\n+    public void testPartialUser() throws Exception {\n+        NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n+\n+        //Get principal without fetching references\n+        NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(),false);", "originalCommit": "140d7d82944043cbcbc19a027e68ea10c0065380", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "url": "https://github.com/nuxeo/nuxeo/commit/9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-16T16:03:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQwNjM4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524406387", "body": "Please put `initiatorNode.get(\"isPartial\")` in a local variable", "bodyText": "Please put initiatorNode.get(\"isPartial\") in a local variable", "bodyHTML": "<p dir=\"auto\">Please put <code>initiatorNode.get(\"isPartial\")</code> in a local variable</p>", "author": "efge", "createdAt": "2020-11-16T16:38:05Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-rest-api/src/test/java/org/nuxeo/ecm/restapi/server/WorkflowEndpointTest.java", "diffHunk": "@@ -1239,11 +1239,17 @@ public void testTaskWorkflowInfo() throws IOException {\n             JsonNode initiatorNode = taskNode.get(\"workflowInitiator\");\n             assertEquals(\"user\", initiatorNode.get(\"entity-type\").textValue());\n             assertEquals(\"Administrator\", initiatorNode.get(\"id\").textValue());\n-            assertTrue(initiatorNode.get(\"isAdministrator\").booleanValue());\n             JsonNode properties = initiatorNode.get(\"properties\");\n             ArrayNode groups = (ArrayNode) properties.get(\"groups\");\n-            assertEquals(1, groups.size());\n-            assertEquals(\"administrators\", groups.get(0).textValue());\n+            if (initiatorNode.get(\"isPartial\") != null && initiatorNode.get(\"isPartial\").booleanValue()) {", "originalCommit": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQwNzgyMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524407821", "body": "Please merge the two `if` statements into one using `&&`", "bodyText": "Please merge the two if statements into one using &&", "bodyHTML": "<p dir=\"auto\">Please merge the two <code>if</code> statements into one using <code>&amp;&amp;</code></p>", "author": "efge", "createdAt": "2020-11-16T16:39:55Z", "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -114,6 +114,12 @@ protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throw\n         jg.writeStringField(\"id\", principal.getName());\n         writeProperties(jg, principal);\n         writeExtendedGroups(jg, principal);\n+        DocumentModel model = principal.getModel();\n+        if (model != null) {\n+            if (Boolean.TRUE.equals(model.getContextData().get(USER_HAS_PARTIAL_CONTENT))) {", "originalCommit": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQwODQ1Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524408457", "body": "I'd put the ` json.properties(7)` check before all the `json.has` checks.", "bodyText": "I'd put the  json.properties(7) check before all the json.has checks.", "bodyHTML": "<p dir=\"auto\">I'd put the <code> json.properties(7)</code> check before all the <code>json.has</code> checks.</p>", "author": "efge", "createdAt": "2020-11-16T16:40:44Z", "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -88,4 +88,32 @@ public void testSystemUser() throws Exception {\n         exGroup.has(\"url\").isEquals(\"group/administrators\");\n     }\n \n+    @Test\n+    public void testPartialUser() throws Exception {\n+        NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n+\n+        // Get principal without fetching references\n+        NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(), false);\n+        JsonAssert json = jsonAssert(partialPrincipal);\n+\n+        // Check the 'isPartial' flag is added\n+        json.has(\"isPartial\").isTrue();\n+        json.properties(7);", "originalCommit": "9e6c8988e4dee8c78e05af0b75891c76a69bd27b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04deb106e7931b42aa28f28dcb1701600b0b4593", "url": "https://github.com/nuxeo/nuxeo/commit/04deb106e7931b42aa28f28dcb1701600b0b4593", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-16T16:44:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyMzQyNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524423426", "body": "```suggestion\r\n        if (model != null && Boolean.TRUE.equals(model.getContextData(USER_HAS_PARTIAL_CONTENT))) {\r\n```\r\n?", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (model != null && Boolean.TRUE.equals(model.getContextData().get(USER_HAS_PARTIAL_CONTENT))) {\n          \n          \n            \n                    if (model != null && Boolean.TRUE.equals(model.getContextData(USER_HAS_PARTIAL_CONTENT))) {\n          \n      \n    \n    \n  \n\n?", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (model <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-smi\">Boolean</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>TRUE</span><span class=\"pl-k\">.</span>equals(model<span class=\"pl-k\">.</span>getContextData(<span class=\"x x-first\">)</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">get(</span><span class=\"pl-c1\">USER_HAS_PARTIAL_CONTENT</span>))) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (model <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-smi\">Boolean</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>TRUE</span><span class=\"pl-k\">.</span>equals(model<span class=\"pl-k\">.</span>getContextData(<span class=\"pl-c1\">USER_HAS_PARTIAL_CONTENT</span>))) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">?</p>", "author": "troger", "createdAt": "2020-11-16T16:59:57Z", "path": "modules/platform/nuxeo-platform-usermanager/src/main/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriter.java", "diffHunk": "@@ -114,6 +112,10 @@ protected void writeEntityBody(NuxeoPrincipal principal, JsonGenerator jg) throw\n         jg.writeStringField(\"id\", principal.getName());\n         writeProperties(jg, principal);\n         writeExtendedGroups(jg, principal);\n+        DocumentModel model = principal.getModel();\n+        if (model != null && Boolean.TRUE.equals(model.getContextData().get(USER_HAS_PARTIAL_CONTENT))) {", "originalCommit": "04deb106e7931b42aa28f28dcb1701600b0b4593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQyNTAwMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4419#discussion_r524425002", "body": "```suggestion\r\n        // Get principal without fetching references\r\n        NuxeoPrincipal partialPrincipal = userManager.getPrincipal(\"Administrator\", false);\r\n```\r\n?", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n          \n          \n            \n            \n          \n          \n            \n                    // Get principal without fetching references\n          \n          \n            \n                    NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(), false);\n          \n          \n            \n                    // Get principal without fetching references\n          \n          \n            \n                    NuxeoPrincipal partialPrincipal = userManager.getPrincipal(\"Administrator\", false);\n          \n      \n    \n    \n  \n\n?", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">NuxeoPrincipal</span> principal <span class=\"pl-k\">=</span> userManager<span class=\"pl-k\">.</span>getPrincipal(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Administrator<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> Get principal without fetching references</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">NuxeoPrincipal</span> partialPrincipal <span class=\"pl-k\">=</span> userManager<span class=\"pl-k\">.</span>getPrincipal(principal<span class=\"pl-k\">.</span>getName(), <span class=\"pl-c1\">false</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> Get principal without fetching references</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">NuxeoPrincipal</span> partialPrincipal <span class=\"pl-k\">=</span> userManager<span class=\"pl-k\">.</span>getPrincipal(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Administrator<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">false</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">?</p>", "author": "troger", "createdAt": "2020-11-16T17:02:04Z", "path": "modules/platform/nuxeo-platform-usermanager/src/test/java/org/nuxeo/ecm/platform/usermanager/io/NuxeoPrincipalJsonWriterTest.java", "diffHunk": "@@ -88,4 +88,32 @@ public void testSystemUser() throws Exception {\n         exGroup.has(\"url\").isEquals(\"group/administrators\");\n     }\n \n+    @Test\n+    public void testPartialUser() throws Exception {\n+        NuxeoPrincipal principal = userManager.getPrincipal(\"Administrator\");\n+\n+        // Get principal without fetching references\n+        NuxeoPrincipal partialPrincipal = userManager.getPrincipal(principal.getName(), false);", "originalCommit": "04deb106e7931b42aa28f28dcb1701600b0b4593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "81740634b614062a603a08adfa6781a9db2146dd", "url": "https://github.com/nuxeo/nuxeo/commit/81740634b614062a603a08adfa6781a9db2146dd", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-16T17:16:00Z", "type": "commit"}, {"oid": "81740634b614062a603a08adfa6781a9db2146dd", "url": "https://github.com/nuxeo/nuxeo/commit/81740634b614062a603a08adfa6781a9db2146dd", "message": "NXP-29759: Make the task endpoint use the UserManagerResolver", "committedDate": "2020-11-16T17:16:00Z", "type": "forcePushed"}]}