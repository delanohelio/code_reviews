{"pr_number": 3813, "pr_title": "10.10-HF/fix-NXP-28727-Document-created-under-a-placeless-document-is-placeless-too", "pr_author": "nuxeojenkins", "pr_createdAt": "2020-03-05T02:30:10Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/3813", "timeline": [{"oid": "817088b66c4a994a33068f7eec840900f5992b21", "url": "https://github.com/nuxeo/nuxeo/commit/817088b66c4a994a33068f7eec840900f5992b21", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-05T08:43:23Z", "type": "forcePushed"}, {"oid": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "url": "https://github.com/nuxeo/nuxeo/commit/7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-05T08:52:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI0Nzc1OA==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388247758", "body": "I would prefer\r\n\r\n    String parentPath = parentRef == null ? null : resolveReference(parentRef).getPath();\r\n\r\nbut up to you", "bodyText": "I would prefer\nString parentPath = parentRef == null ? null : resolveReference(parentRef).getPath();\n\nbut up to you", "bodyHTML": "<p dir=\"auto\">I would prefer</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"String parentPath = parentRef == null ? null : resolveReference(parentRef).getPath();\"><pre><code>String parentPath = parentRef == null ? null : resolveReference(parentRef).getPath();\n</code></pre></div>\n<p dir=\"auto\">but up to you</p>", "author": "efge", "createdAt": "2020-03-05T11:56:05Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2672,6 +2676,25 @@ public DocumentModel getOrCreateDocument(DocumentModel docModel,\n         });\n     }\n \n+    @Override\n+    public DocumentModel newDocumentModel(DocumentRef parentRef, String name, String typeName) {\n+        if (parentRef == null && name == null) {\n+            return createDocumentModel(typeName);\n+        }\n+\n+        String parentPath = null;\n+        if (parentRef != null) {\n+            parentPath = resolveReference(parentRef).getPath();", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MDg5Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388250897", "body": "We should audit our code for usage of `PARENT_PATH` because as this code shows it's now meaningless in some cases so we may as well try avoid using it completely (and replace it with something else depending on needs)\r\n", "bodyText": "We should audit our code for usage of PARENT_PATH because as this code shows it's now meaningless in some cases so we may as well try avoid using it completely (and replace it with something else depending on needs)", "bodyHTML": "<p dir=\"auto\">We should audit our code for usage of <code>PARENT_PATH</code> because as this code shows it's now meaningless in some cases so we may as well try avoid using it completely (and replace it with something else depending on needs)</p>", "author": "efge", "createdAt": "2020-03-05T12:02:52Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -2672,6 +2676,25 @@ public DocumentModel getOrCreateDocument(DocumentModel docModel,\n         });\n     }\n \n+    @Override\n+    public DocumentModel newDocumentModel(DocumentRef parentRef, String name, String typeName) {\n+        if (parentRef == null && name == null) {\n+            return createDocumentModel(typeName);\n+        }\n+\n+        String parentPath = null;\n+        if (parentRef != null) {\n+            parentPath = resolveReference(parentRef).getPath();\n+        }\n+        Map<String, Serializable> options = new HashMap<>();\n+        options.put(CoreEventConstants.PARENT_PATH, parentPath);", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MTkwNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388251906", "bodyText": "Hm actually it's even worse, for the moveDocument case the value is a DocumentRef and not a String... and this is used by quotas...", "author": "efge", "createdAt": "2020-03-05T12:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MDg5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODgxOTUyMg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388819522", "bodyText": "yes I agree :(", "author": "RSalem07", "createdAt": "2020-03-06T10:14:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI1MDg5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyOTY3OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388429679", "body": "```suggestion\r\n    public void testCreateDocumentsHierarchy() {\r\n```\r\n?", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testBasicsCreateDocsWithHierarchy() {\n          \n          \n            \n                public void testCreateDocumentsHierarchy() {\n          \n      \n    \n    \n  \n\n?", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">testBasicsCreateDocsWithHierarchy</span>() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">testCreateDocumentsHierarchy</span>() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">?</p>", "author": "troger", "createdAt": "2020-03-05T16:59:15Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -272,6 +272,51 @@ public void testBasics() {\n         assertEquals(cal, modified);\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testBasicsCreateDocsWithHierarchy() {", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMDQ1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388430452", "body": "Could you use `DocumentModel#setPropertyValue` and `DocumentModel#getPropertyValue`?\r\n\r\nI know the class mix both, but let's add \"correct\" code :)", "bodyText": "Could you use DocumentModel#setPropertyValue and DocumentModel#getPropertyValue?\nI know the class mix both, but let's add \"correct\" code :)", "bodyHTML": "<p dir=\"auto\">Could you use <code>DocumentModel#setPropertyValue</code> and <code>DocumentModel#getPropertyValue</code>?</p>\n<p dir=\"auto\">I know the class mix both, but let's add \"correct\" code :)</p>", "author": "troger", "createdAt": "2020-03-05T17:00:29Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -272,6 +272,51 @@ public void testBasics() {\n         assertEquals(cal, modified);\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testBasicsCreateDocsWithHierarchy() {\n+        DocumentModel root = session.getRootDocument();\n+\n+        // create the parent doc under the root\n+        DocumentModel parent = session.newDocumentModel(new PathRef(\"/\"), \"domain\", \"MyDocType\");\n+        Calendar parentModifTime = GregorianCalendar.getInstance();\n+        parent.setProperty(\"dublincore\", \"title\", \"Title of parent\");", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTIxMA==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431210", "body": "```suggestion\r\n        DocumentModel parent = session.newDocumentModel(null, \"parent\", \"File\");\r\n```\r\n`parent` and `child`, simpler,  like in the other test method you added.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n          \n          \n            \n                    DocumentModel parent = session.newDocumentModel(null, \"parent\", \"File\");\n          \n      \n    \n    \n  \n\nparent and child, simpler,  like in the other test method you added.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">parentFile</span> <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>newDocumentModel(<span class=\"pl-c1\">null</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">parentFile</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>File<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">parent</span> <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>newDocumentModel(<span class=\"pl-c1\">null</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">parent</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>File<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\"><code>parent</code> and <code>child</code>, simpler,  like in the other test method you added.</p>", "author": "troger", "createdAt": "2020-03-05T17:01:38Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTMzNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431336", "body": "```suggestion\r\n        DocumentModel child = session.newDocumentModel(parentFile.getRef(), \"child\", \"File\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n          \n          \n            \n                    DocumentModel child = session.newDocumentModel(parentFile.getRef(), \"child\", \"File\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">childFile</span> <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>newDocumentModel(parentFile<span class=\"pl-k\">.</span>getRef(), <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">childFile</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>File<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">child</span> <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>newDocumentModel(parentFile<span class=\"pl-k\">.</span>getRef(), <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">child</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>File<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-03-05T17:01:49Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTY4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431687", "body": "```suggestion\r\n        parentFile = session.getDocument(parentFile.getRef());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    parentFile = session.getDocument(new IdRef(parentFile.getId()));\n          \n          \n            \n                    parentFile = session.getDocument(parentFile.getRef());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        parentFile <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>getDocument(<span class=\"pl-k x x-first\">new</span><span class=\"x\"> </span><span class=\"pl-smi x\">IdRef</span><span class=\"x x-last\">(</span>parentFile<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">getId()</span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        parentFile <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>getDocument(parentFile<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">getRef(</span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-03-05T17:02:20Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n+        childFile = session.createDocument(childFile);\n+        session.save();\n+\n+        reopenSession();\n+\n+        // the parent file must be a placeless\n+        parentFile = session.getDocument(new IdRef(parentFile.getId()));", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMTg0Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388431842", "body": "```suggestion\r\n        childFile = session.getDocument(childFile.getRef());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    childFile = session.getDocument(new IdRef(childFile.getId()));\n          \n          \n            \n                    childFile = session.getDocument(childFile.getRef());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        childFile <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>getDocument(<span class=\"pl-k x x-first\">new</span><span class=\"x\"> </span><span class=\"pl-smi x\">IdRef</span><span class=\"x x-last\">(</span>childFile<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">getId()</span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        childFile <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>getDocument(childFile<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">getRef(</span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-03-05T17:02:35Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n+        childFile = session.createDocument(childFile);\n+        session.save();\n+\n+        reopenSession();\n+\n+        // the parent file must be a placeless\n+        parentFile = session.getDocument(new IdRef(parentFile.getId()));\n+        assertNull(parentFile.getParentRef());\n+\n+        // the child file mustn't be a placeless\n+        childFile = session.getDocument(new IdRef(childFile.getId()));", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQzMjkxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388432916", "body": "Not sure of the pertinence of the messages here... \r\n```java\r\nassertFalse(session.exists(parentFile.getRef()));\r\nassertFalse(session.exists(childFile.getRef()));\r\n```\r\nIt seems enough.", "bodyText": "Not sure of the pertinence of the messages here...\nassertFalse(session.exists(parentFile.getRef()));\nassertFalse(session.exists(childFile.getRef()));\nIt seems enough.", "bodyHTML": "<p dir=\"auto\">Not sure of the pertinence of the messages here...</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"assertFalse(session.exists(parentFile.getRef()));\nassertFalse(session.exists(childFile.getRef()));\"><pre>assertFalse(session<span class=\"pl-k\">.</span>exists(parentFile<span class=\"pl-k\">.</span>getRef()));\nassertFalse(session<span class=\"pl-k\">.</span>exists(childFile<span class=\"pl-k\">.</span>getRef()));</pre></div>\n<p dir=\"auto\">It seems enough.</p>", "author": "troger", "createdAt": "2020-03-05T17:04:22Z", "path": "nuxeo-core/nuxeo-core-test/src/test/java/org/nuxeo/ecm/core/TestSQLRepositoryAPI.java", "diffHunk": "@@ -4017,6 +4062,38 @@ public void testPlacelessDocument() {\n         session.save();\n     }\n \n+    /*\n+     * NXP-28727\n+     */\n+    @Test\n+    public void testCreateDocumentUnderPlacelessDoc() {\n+        DocumentModel parentFile = session.newDocumentModel(null, \"parentFile\", \"File\");\n+        parentFile = session.createDocument(parentFile);\n+        assertNull(parentFile.getParentRef());\n+        session.save();\n+\n+        DocumentModel childFile = session.newDocumentModel(parentFile.getRef(), \"childFile\", \"File\");\n+        childFile = session.createDocument(childFile);\n+        session.save();\n+\n+        reopenSession();\n+\n+        // the parent file must be a placeless\n+        parentFile = session.getDocument(new IdRef(parentFile.getId()));\n+        assertNull(parentFile.getParentRef());\n+\n+        // the child file mustn't be a placeless\n+        childFile = session.getDocument(new IdRef(childFile.getId()));\n+        assertEquals(parentFile.getRef(), childFile.getParentRef());\n+\n+        // remove the parent\n+        session.removeDocument(parentFile.getRef());\n+        session.save();\n+\n+        assertFalse(\"parentFile should be removed\", session.exists(parentFile.getRef()));\n+        assertFalse(\"childFile should be removed\", session.exists(childFile.getRef()));", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0MTI0OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/3813#discussion_r388441249", "body": "```suggestion\r\n    private DocumentModel createDocumentModelFromParentAndType(DocumentRef parentRef, String typeName,\r\n```\r\n?", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private DocumentModel createDocumentModelByParentAndType(DocumentRef parentRef, String typeName,\n          \n          \n            \n                private DocumentModel createDocumentModelFromParentAndType(DocumentRef parentRef, String typeName,\n          \n      \n    \n    \n  \n\n?", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">createDocumentModelByParentAndType</span>(<span class=\"pl-smi\">DocumentRef</span> parentRef, <span class=\"pl-smi\">String</span> typeName,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">createDocumentModelFromParentAndType</span>(<span class=\"pl-smi\">DocumentRef</span> parentRef, <span class=\"pl-smi\">String</span> typeName,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">?</p>", "author": "troger", "createdAt": "2020-03-05T17:17:24Z", "path": "nuxeo-core/nuxeo-core/src/main/java/org/nuxeo/ecm/core/api/AbstractSession.java", "diffHunk": "@@ -616,12 +616,16 @@ public void cancel() {\n     }\n \n     private DocumentModel createDocumentModelFromTypeName(String typeName, Map<String, Serializable> options) {\n-        SchemaManager schemaManager = Framework.getService(SchemaManager.class);\n-        DocumentType docType = schemaManager.getDocumentType(typeName);\n+        return createDocumentModelByParentAndType(null, typeName, options);\n+    }\n+\n+    private DocumentModel createDocumentModelByParentAndType(DocumentRef parentRef, String typeName,", "originalCommit": "7126cda252ab2da7073eb98892b6bdbc5e56d3e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea591eced7b9cc7bcc115e6c8b01298218fdfcce", "url": "https://github.com/nuxeo/nuxeo/commit/ea591eced7b9cc7bcc115e6c8b01298218fdfcce", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T10:15:12Z", "type": "forcePushed"}, {"oid": "aa7a4b9daebc135ac90421a6462e087ebf6f7112", "url": "https://github.com/nuxeo/nuxeo/commit/aa7a4b9daebc135ac90421a6462e087ebf6f7112", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T10:20:26Z", "type": "forcePushed"}, {"oid": "2b82c9f096b9c62ec54af7b246152c708d90c235", "url": "https://github.com/nuxeo/nuxeo/commit/2b82c9f096b9c62ec54af7b246152c708d90c235", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T14:32:19Z", "type": "commit"}, {"oid": "2b82c9f096b9c62ec54af7b246152c708d90c235", "url": "https://github.com/nuxeo/nuxeo/commit/2b82c9f096b9c62ec54af7b246152c708d90c235", "message": "NXP-28727: Document created under a placeless document Mustn't be a placeless", "committedDate": "2020-03-06T14:32:19Z", "type": "forcePushed"}]}