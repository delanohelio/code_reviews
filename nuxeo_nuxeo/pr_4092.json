{"pr_number": 4092, "pr_title": "fix-NXP-28634-faulty-infinite-scroll-in-HISTORY-tab", "pr_author": "nuxeojenkins", "pr_createdAt": "2020-05-28T19:14:23Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4092", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1Mjg0OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433152848", "body": "```suggestion\r\n        logEntries.add(buildLogEntry(doc, \"One\", \"secondEvent\", \"leela\", firstDate));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logEntries.add(buildLogEntry(doc, \"One\", \"secondEvent\", \"leela\", secondDate));\n          \n          \n            \n                    logEntries.add(buildLogEntry(doc, \"One\", \"secondEvent\", \"leela\", firstDate));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        logEntries<span class=\"pl-k\">.</span>add(buildLogEntry(doc, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>One<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>secondEvent<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>leela<span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">secondDate</span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        logEntries<span class=\"pl-k\">.</span>add(buildLogEntry(doc, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>One<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>secondEvent<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>leela<span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">firstDate</span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ataillefer", "createdAt": "2020-06-01T10:16:56Z", "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/AuditTest.java", "diffHunk": "@@ -304,38 +277,13 @@ public void shouldFilterLogEntriesOnMultipleCriteria() throws Exception {\n         ZonedDateTime secondDate = firstDate.plusDays(10);\n \n         List<LogEntry> logEntries = new ArrayList<>();\n-        LogEntry logEntry = auditLogger.newLogEntry();\n-        logEntry.setDocUUID(doc.getRef());\n-        logEntry.setCategory(\"One\");\n-        logEntry.setEventId(\"firstEvent\");\n-        logEntry.setPrincipalName(\"bender\");\n-        logEntry.setEventDate(DateUtils.toDate(firstDate));\n-        logEntries.add(logEntry);\n-        logEntry = auditLogger.newLogEntry();\n-        logEntry.setDocUUID(doc.getRef());\n-        logEntry.setCategory(\"One\");\n-        logEntry.setEventId(\"secondEvent\");\n-        logEntry.setPrincipalName(\"leela\");\n-        logEntry.setEventDate(DateUtils.toDate(firstDate));\n-        logEntries.add(logEntry);\n-        logEntry = auditLogger.newLogEntry();\n-        logEntry.setDocUUID(doc.getRef());\n-        logEntry.setCategory(\"One\");\n-        logEntry.setEventId(\"firstEvent\");\n-        logEntry.setPrincipalName(\"leela\");\n-        logEntry.setEventDate(DateUtils.toDate(secondDate));\n-        logEntries.add(logEntry);\n-        logEntry = auditLogger.newLogEntry();\n-        logEntry.setDocUUID(doc.getRef());\n-        logEntry.setCategory(\"One\");\n-        logEntry.setEventId(\"thirdEvent\");\n-        logEntry.setPrincipalName(\"leela\");\n-        logEntry.setEventDate(DateUtils.toDate(secondDate));\n-        logEntries.add(logEntry);\n+        logEntries.add(buildLogEntry(doc, \"One\", \"firstEvent\", \"bender\", firstDate));\n+        logEntries.add(buildLogEntry(doc, \"One\", \"secondEvent\", \"leela\", secondDate));", "originalCommit": "7f0d78d24c2649da49df4d800a4a78bffc9b6ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NTU1OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433155558", "body": "Are we sure of the impacts other than related to the PaginableAdapter?", "bodyText": "Are we sure of the impacts other than related to the PaginableAdapter?", "bodyHTML": "<p dir=\"auto\">Are we sure of the impacts other than related to the PaginableAdapter?</p>", "author": "ataillefer", "createdAt": "2020-06-01T10:23:48Z", "path": "modules/platform/nuxeo-platform-query-api/src/main/java/org/nuxeo/ecm/platform/query/api/AbstractPageProvider.java", "diffHunk": "@@ -355,7 +355,6 @@ public void addQuickFilter(QuickFilter quickFilter) {\n     public void setSortInfos(List<SortInfo> sortInfo) {\n         if (sortInfoChanged(this.sortInfos, sortInfo)) {\n             this.sortInfos = sortInfo;\n-            refresh();", "originalCommit": "b9fd9a68fd676f201e30622267a3a3db2e69f9ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5OTc1Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433199757", "bodyText": "I asked my self the same question,\nAt the beginning To minimise this impact, I created a new method that use a boolean param, to refresh at demande. But after that some tests fails on my local machine (test where  index = 1). Because the tests was a false positive, as each set of sort reset the index and I had some Page Provider Cache issue...\nTo be honest, the TP passe on default and mongoDB. But perhpas it will impact others things. But I don't know why we call refresh when set the sorter because this method will reset index and do other things.\nTo avoid any breaking changes if any. We can override the setSorter for the AuditPageProvider to avoid refresh only for this provider.", "author": "RSalem07", "createdAt": "2020-06-01T12:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NTU1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NzM4OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433157389", "body": "Is this really useful? If `sortBy` isn't blank, then `sortBy.split(\",\")` should always return a non empty array no?", "bodyText": "Is this really useful? If sortBy isn't blank, then sortBy.split(\",\") should always return a non empty array no?", "bodyHTML": "<p dir=\"auto\">Is this really useful? If <code>sortBy</code> isn't blank, then <code>sortBy.split(\",\")</code> should always return a non empty array no?</p>", "author": "ataillefer", "createdAt": "2020-06-01T10:28:20Z", "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/adapters/PaginableAdapter.java", "diffHunk": "@@ -114,22 +118,27 @@ protected DocumentModel getSearchDocument() {\n         PageProviderService pps = Framework.getService(PageProviderService.class);\n         Map<String, Serializable> props = new HashMap<>();\n         props.put(CoreQueryDocumentPageProvider.CORE_SESSION_PROPERTY, (Serializable) ctx.getCoreSession());\n-        PageProvider<T> pp = (PageProvider<T>) pps.getPageProvider(\"\", ppDefinition, getSearchDocument(), null,\n-                pageSize, currentPageIndex, props, getParams());\n+        List<SortInfo> sortersInfos = null;\n         if (!StringUtils.isBlank(sortBy)) {\n             String[] sorts = sortBy.split(\",\");\n             String[] orders = null;\n             if (!StringUtils.isBlank(sortOrder)) {\n                 orders = sortOrder.split(\",\");\n             }\n-            // clear potential default sort infos first\n-            pp.setSortInfos(null);\n-            for (int i = 0; i < sorts.length; i++) {\n-                String sort = sorts[i];\n-                boolean sortAscending = orders != null && orders.length > i && \"asc\".equals(orders[i].toLowerCase());\n-                pp.addSortInfo(sort, sortAscending);\n+\n+            if (ArrayUtils.isNotEmpty(sorts)) {", "originalCommit": "b9fd9a68fd676f201e30622267a3a3db2e69f9ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwMzc1OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433203758", "bodyText": "Yep, I added the check to avoid passing an empty sorters to underline provide have a look at here From what I saw is if we pass empty array it will consider it as an empty sorter and it will end by not sorting (will not use the default ones).", "author": "RSalem07", "createdAt": "2020-06-01T12:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NzM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwNDcyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433204725", "bodyText": "But I re-check  a second time we can remove it, thx", "author": "RSalem07", "createdAt": "2020-06-01T12:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NzM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2MjkyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433162923", "body": "Sounds weird to have \"firstEvent\" or \"thirdEvent\" occur several times.\r\nMaybe call them \"eventA\", \"eventB\", ...", "bodyText": "Sounds weird to have \"firstEvent\" or \"thirdEvent\" occur several times.\nMaybe call them \"eventA\", \"eventB\", ...", "bodyHTML": "<p dir=\"auto\">Sounds weird to have \"firstEvent\" or \"thirdEvent\" occur several times.<br>\nMaybe call them \"eventA\", \"eventB\", ...</p>", "author": "ataillefer", "createdAt": "2020-06-01T10:41:53Z", "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/AuditTest.java", "diffHunk": "@@ -420,6 +421,64 @@ public void shouldEnrichWithLatestDocumentLogEntries() throws IOException {\n         }\n     }\n \n+    @Test\n+    public void shouldHandleSortingAndPagination() throws Exception {\n+        DocumentModel doc = RestServerInit.getFile(1, session);\n+\n+        List<LogEntry> logEntries = new ArrayList<>();\n+        logEntries.add(buildLogEntry(doc, \"Two\", \"secondEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"Two\", \"firstEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"Two\", \"thirdEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"Two\", \"thirdEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"Two\", \"thirdEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"Two\", \"thirdEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"One\", \"secondEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"One\", \"thirdEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"One\", \"firstEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"One\", \"thirdEvent\", \"james\", null));\n+        logEntries.add(buildLogEntry(doc, \"One\", \"firstEvent\", \"james\", null));", "originalCommit": "b9fd9a68fd676f201e30622267a3a3db2e69f9ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NTI4MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433195281", "bodyText": "Yes, It was my first idea, but I tried to be consistent with the exiting tests where the pattern is to have this kind of name. But I can change them", "author": "RSalem07", "createdAt": "2020-06-01T12:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2MjkyMw=="}], "type": "inlineReview"}, {"oid": "a167a1ce52596575ff3a4900dec5af681d562fe5", "url": "https://github.com/nuxeo/nuxeo/commit/a167a1ce52596575ff3a4900dec5af681d562fe5", "message": "NXP-28634: Fix sorting and pagination (infinit scroll) in page provider", "committedDate": "2020-06-01T14:10:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMxNjYxOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4092#discussion_r433316618", "body": "```suggestion\r\n        List<SortInfo> sortInfos = null;\r\n```\r\n?", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<SortInfo> sortersInfos = null;\n          \n          \n            \n                    List<SortInfo> sortInfos = null;\n          \n      \n    \n    \n  \n\n?", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">SortInfo</span>&gt;</span> <span class=\"x x-first x-last\">sortersInfos</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">SortInfo</span>&gt;</span> <span class=\"x x-first x-last\">sortInfos</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">?</p>", "author": "troger", "createdAt": "2020-06-01T15:41:52Z", "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/adapters/PaginableAdapter.java", "diffHunk": "@@ -114,25 +117,24 @@ protected DocumentModel getSearchDocument() {\n         PageProviderService pps = Framework.getService(PageProviderService.class);\n         Map<String, Serializable> props = new HashMap<>();\n         props.put(CoreQueryDocumentPageProvider.CORE_SESSION_PROPERTY, (Serializable) ctx.getCoreSession());\n-        PageProvider<T> pp = (PageProvider<T>) pps.getPageProvider(\"\", ppDefinition, getSearchDocument(), null,\n-                pageSize, currentPageIndex, props, getParams());\n+        List<SortInfo> sortersInfos = null;", "originalCommit": "a167a1ce52596575ff3a4900dec5af681d562fe5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "40e2141fd3be83c4bc6f72de1165de0860617d0f", "url": "https://github.com/nuxeo/nuxeo/commit/40e2141fd3be83c4bc6f72de1165de0860617d0f", "message": "NXP-28634: Cleanup / Format", "committedDate": "2020-06-01T16:59:32Z", "type": "commit"}, {"oid": "5293f4163a7531a3d9d659b4047fc8c68ba88be7", "url": "https://github.com/nuxeo/nuxeo/commit/5293f4163a7531a3d9d659b4047fc8c68ba88be7", "message": "NXP-28634: Fix sorting and pagination (infinit scroll) in page provider", "committedDate": "2020-06-01T16:59:32Z", "type": "forcePushed"}, {"oid": "90f5ba434ed20bd0e093121794c4b177c0b360c1", "url": "https://github.com/nuxeo/nuxeo/commit/90f5ba434ed20bd0e093121794c4b177c0b360c1", "message": "NXP-28634: Fix sorting and pagination (infinit scroll) in page provider", "committedDate": "2020-06-01T17:05:43Z", "type": "commit"}, {"oid": "90f5ba434ed20bd0e093121794c4b177c0b360c1", "url": "https://github.com/nuxeo/nuxeo/commit/90f5ba434ed20bd0e093121794c4b177c0b360c1", "message": "NXP-28634: Fix sorting and pagination (infinit scroll) in page provider", "committedDate": "2020-06-01T17:05:43Z", "type": "forcePushed"}]}