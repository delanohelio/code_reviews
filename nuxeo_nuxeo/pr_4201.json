{"pr_number": 4201, "pr_title": "10.10-HF/fix-NXP-29246-import-MHTLM-in-chrome", "pr_author": "nuxeojenkins", "pr_createdAt": "2020-07-06T12:03:28Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4201", "timeline": [{"oid": "7e090ad507a83d7630c58fadef54fd7d79cbaf82", "url": "https://github.com/nuxeo/nuxeo/commit/7e090ad507a83d7630c58fadef54fd7d79cbaf82", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-07T17:48:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0ODE3OA==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r451048178", "body": "new lines removed in next push", "bodyText": "new lines removed in next push", "bodyHTML": "<p dir=\"auto\">new lines removed in next push</p>", "author": "NourNuxeo", "createdAt": "2020-07-07T18:02:40Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -130,6 +137,8 @@\n \n     public static final String MD5 = \"md5\";\n \n+\n+", "originalCommit": "7e090ad507a83d7630c58fadef54fd7d79cbaf82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3OTcyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r451079723", "body": "comment removed in next push", "bodyText": "comment removed in next push", "bodyHTML": "<p dir=\"auto\">comment removed in next push</p>", "author": "NourNuxeo", "createdAt": "2020-07-07T19:02:14Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1045,6 +1046,33 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testUploadMHTML() throws Exception {\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + initializeNewBatch() + \"/0\",\n+                \"dummy\", Collections.singletonMap(\"Content-Type\", \"multipart/related\"))) {\n+            assertEquals(Status.INTERNAL_SERVER_ERROR.getStatusCode(), response.getStatus());\n+        }\n+    }\n+\n+    @Test\n+    @Deploy(\"org.nuxeo.ecm.platform.restapi.server:batch-upload-contrib-test.xml\")\n+    public void testUploadMHTMLMultipartDisabled() throws Exception {\n+        String batchId = initializeNewBatch();\n+        Map<String, String> headers = new HashMap<>();\n+        headers.put(\"Content-Type\", \"multipart/related\");\n+        headers.put(\"X-File-Name\", \"dummy.mhtml\");\n+        // typed via mime-type", "originalCommit": "7e090ad507a83d7630c58fadef54fd7d79cbaf82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e1f9695141e3da596b4b504a9b9c9ef8a2101138", "url": "https://github.com/nuxeo/nuxeo/commit/e1f9695141e3da596b4b504a9b9c9ef8a2101138", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-08T09:40:44Z", "type": "forcePushed"}, {"oid": "f99385045a8d9652e6a4854cc5f984da3490196b", "url": "https://github.com/nuxeo/nuxeo/commit/f99385045a8d9652e6a4854cc5f984da3490196b", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-08T13:42:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxNDg2Mw==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r452214863", "body": "add nxp ticket in jdoc", "bodyText": "add nxp ticket in jdoc", "bodyHTML": "<p dir=\"auto\">add nxp ticket in jdoc</p>", "author": "NourNuxeo", "createdAt": "2020-07-09T13:25:21Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1045,6 +1046,32 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test", "originalCommit": "f99385045a8d9652e6a4854cc5f984da3490196b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxODg2MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r452218861", "body": "check isMultipartDisabled first to short-circuit", "bodyText": "check isMultipartDisabled first to short-circuit", "bodyHTML": "<p dir=\"auto\">check isMultipartDisabled first to short-circuit</p>", "author": "NourNuxeo", "createdAt": "2020-07-09T13:31:05Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -232,7 +239,7 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = contentType != null && contentType.contains(\"multipart\");\n+        boolean isMultipart = contentType != null && contentType.contains(\"multipart\") && !isMultipartDisabled();", "originalCommit": "f99385045a8d9652e6a4854cc5f984da3490196b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6603f4fae2ca110843679c0ea839fa94121f1706", "url": "https://github.com/nuxeo/nuxeo/commit/6603f4fae2ca110843679c0ea839fa94121f1706", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-15T11:09:52Z", "type": "forcePushed"}, {"oid": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "url": "https://github.com/nuxeo/nuxeo/commit/ee04e2f516f9e7f6300044755b1e196e2ccedac5", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-15T17:06:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMTgyMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457401823", "body": "As this property does not exist in `11.2`, I would update the since for the next HF.", "bodyText": "As this property does not exist in 11.2, I would update the since for the next HF.", "bodyHTML": "<p dir=\"auto\">As this property does not exist in <code>11.2</code>, I would update the since for the next HF.</p>", "author": "troger", "createdAt": "2020-07-20T13:49:41Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -116,6 +117,9 @@\n \n     protected static final String REQUEST_HANDLER_NAME = \"handlerName\";\n \n+    /** @since 11.2 */", "originalCommit": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwODYzMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457708632", "bodyText": "aligned with 10.10-HF30", "author": "NourNuxeo", "createdAt": "2020-07-20T21:43:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMTgyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMjg3MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457402870", "body": "```suggestion\r\n    protected static final String MULTIPART_DISABLED_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected static final String MULTIPART_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";\n          \n          \n            \n                protected static final String MULTIPART_DISABLED_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">protected</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">MULTIPART_CONFIG_KEY</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nuxeo.batch.upload.multipart.disabled<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">protected</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">MULTIPART_DISABLED_CONFIG_KEY</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>nuxeo.batch.upload.multipart.disabled<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-07-20T13:50:48Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -116,6 +117,9 @@\n \n     protected static final String REQUEST_HANDLER_NAME = \"handlerName\";\n \n+    /** @since 11.2 */\n+    protected static final String MULTIPART_CONFIG_KEY = \"nuxeo.batch.upload.multipart.disabled\";", "originalCommit": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMzkzMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457403931", "body": "What about:\r\n```suggestion\r\n        boolean isMultipart = isMultipartEnabled() && contentType != null && contentType.contains(\"multipart\");\r\n```\r\n?", "bodyText": "What about:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    boolean isMultipart = !isMultipartDisabled() && contentType != null && contentType.contains(\"multipart\");\n          \n          \n            \n                    boolean isMultipart = isMultipartEnabled() && contentType != null && contentType.contains(\"multipart\");\n          \n      \n    \n    \n  \n\n?", "bodyHTML": "<p dir=\"auto\">What about:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">boolean</span> isMultipart <span class=\"pl-k\">=</span> <span class=\"pl-k x x-first\">!</span><span class=\"x x-last\">isMultipartDisabled</span>() <span class=\"pl-k\">&amp;&amp;</span> contentType <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> contentType<span class=\"pl-k\">.</span>contains(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>multipart<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">boolean</span> isMultipart <span class=\"pl-k\">=</span> <span class=\"x x-first x-last\">isMultipartEnabled</span>() <span class=\"pl-k\">&amp;&amp;</span> contentType <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> contentType<span class=\"pl-k\">.</span>contains(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>multipart<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">?</p>", "author": "troger", "createdAt": "2020-07-20T13:51:55Z", "path": "nuxeo-features/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -232,7 +236,7 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = contentType != null && contentType.contains(\"multipart\");\n+        boolean isMultipart = !isMultipartDisabled() && contentType != null && contentType.contains(\"multipart\");", "originalCommit": "ee04e2f516f9e7f6300044755b1e196e2ccedac5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcwODQyNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4201#discussion_r457708425", "bodyText": "d\u00f4\u00f4ne", "author": "NourNuxeo", "createdAt": "2020-07-20T21:42:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQwMzkzMQ=="}], "type": "inlineReview"}, {"oid": "d88feb7f464b7b88b4965984a8889999876723be", "url": "https://github.com/nuxeo/nuxeo/commit/d88feb7f464b7b88b4965984a8889999876723be", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-20T21:41:46Z", "type": "commit"}, {"oid": "d88feb7f464b7b88b4965984a8889999876723be", "url": "https://github.com/nuxeo/nuxeo/commit/d88feb7f464b7b88b4965984a8889999876723be", "message": "NXP-29246: add MHTML mime-type support", "committedDate": "2020-07-20T21:41:46Z", "type": "forcePushed"}]}