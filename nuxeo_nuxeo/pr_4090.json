{"pr_number": 4090, "pr_title": "NXP-29099: add an orphaned Tasks listener", "pr_author": "NourNuxeo", "pr_createdAt": "2020-05-28T17:53:26Z", "pr_url": "https://github.com/nuxeo/nuxeo/pull/4090", "timeline": [{"oid": "631bb21b5cd9921f72a7ad285d27b6c013008658", "url": "https://github.com/nuxeo/nuxeo/commit/631bb21b5cd9921f72a7ad285d27b6c013008658", "message": "NXP-29099: add an orphaned Tasks listener", "committedDate": "2020-05-28T20:43:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MTkyOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433981929", "body": "You could just use\r\n```\r\ntaskDocument.setPropertyValue(TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME, route.getId())\r\n```", "bodyText": "You could just use\ntaskDocument.setPropertyValue(TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME, route.getId())", "bodyHTML": "<p dir=\"auto\">You could just use</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"taskDocument.setPropertyValue(TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME, route.getId())\"><pre><code>taskDocument.setPropertyValue(TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME, route.getId())\n</code></pre></div>", "author": "troger", "createdAt": "2020-06-02T15:49:30Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +367,29 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");\n+        route = session.createDocument(route);\n+\n+        DocumentModel taskDocument = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",\n+                TASK_TYPE_NAME);\n+        Task task = taskDocument.getAdapter(Task.class);\n+        task.setProcessId(route.getId());", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MzUxNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433983515", "body": "What about using `session#exists`?", "bodyText": "What about using session#exists?", "bodyHTML": "<p dir=\"auto\">What about using <code>session#exists</code>?</p>", "author": "troger", "createdAt": "2020-06-02T15:51:02Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +367,29 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");\n+        route = session.createDocument(route);\n+\n+        DocumentModel taskDocument = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",\n+                TASK_TYPE_NAME);\n+        Task task = taskDocument.getAdapter(Task.class);\n+        task.setProcessId(route.getId());\n+        taskDocument = session.createDocument(taskDocument);\n+        session.save();\n+        session.removeDocument(route.getRef());\n+        try {\n+            session.getDocument(taskDocument.getRef());\n+            // Orphan tasks should not be found\n+            fail();\n+        } catch (DocumentNotFoundException e) {\n+            // Success\n+        }", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4NDgzNQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433984835", "body": "Not needed.", "bodyText": "Not needed.", "bodyHTML": "<p dir=\"auto\">Not needed.</p>", "author": "troger", "createdAt": "2020-06-02T15:52:18Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.task.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ *", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4NzgwMg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433987802", "body": "```suggestion\r\n            if (DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (docModel.getType().equals(DOCUMENT_ROUTE_DOCUMENT_TYPE)) {\n          \n          \n            \n                        if (DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (docModel<span class=\"pl-k\">.</span>getType()<span class=\"pl-k x x-first\">.</span><span class=\"x\">equals(</span><span class=\"pl-c1 x x-last\">DOCUMENT_ROUTE_DOCUMENT_TYPE</span>)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (<span class=\"pl-c1 x x-first\">DOCUMENT_ROUTE_DOCUMENT_TYPE</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">equals(</span>docModel<span class=\"pl-k\">.</span>getType())) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-02T15:55:14Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.task.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ *\n+ * @since 11.1\n+ */\n+public class DeleteTaskForDeletedDocumentRouteListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE %s = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            CoreSession session = context.getCoreSession();\n+            if (docModel.getType().equals(DOCUMENT_ROUTE_DOCUMENT_TYPE)) {", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4ODE3Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433988172", "body": "No need to extract it to a var.", "bodyText": "No need to extract it to a var.", "bodyHTML": "<p dir=\"auto\">No need to extract it to a var.</p>", "author": "troger", "createdAt": "2020-06-02T15:55:34Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.task.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ *\n+ * @since 11.1\n+ */\n+public class DeleteTaskForDeletedDocumentRouteListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE %s = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            CoreSession session = context.getCoreSession();", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4ODM3NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433988375", "body": "```suggestion\r\n                deleteOrphanTasks(context.getCoreSession(), docModel.getId());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            deleteOrphanTasks(session, docModel.getId());\n          \n          \n            \n                            deleteOrphanTasks(context.getCoreSession(), docModel.getId());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                deleteOrphanTasks(<span class=\"x x-first x-last\">session</span>, docModel<span class=\"pl-k\">.</span>getId());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                deleteOrphanTasks(<span class=\"x x-first\">context</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getCoreSession()</span>, docModel<span class=\"pl-k\">.</span>getId());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-02T15:55:46Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.task.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ *\n+ * @since 11.1\n+ */\n+public class DeleteTaskForDeletedDocumentRouteListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE %s = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            CoreSession session = context.getCoreSession();\n+            if (docModel.getType().equals(DOCUMENT_ROUTE_DOCUMENT_TYPE)) {\n+                deleteOrphanTasks(session, docModel.getId());", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4OTg5NQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433989895", "body": "protected.", "bodyText": "protected.", "bodyHTML": "<p dir=\"auto\">protected.</p>", "author": "troger", "createdAt": "2020-06-02T15:57:16Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.task.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ *\n+ * @since 11.1\n+ */\n+public class DeleteTaskForDeletedDocumentRouteListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE %s = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            CoreSession session = context.getCoreSession();\n+            if (docModel.getType().equals(DOCUMENT_ROUTE_DOCUMENT_TYPE)) {\n+                deleteOrphanTasks(session, docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Deletes all tasks which processId matches the given id.\n+     *\n+     * @param session the session used to query.\n+     * @param id the deleted DocumentRoute id\n+     * @since 11.1\n+     */\n+    private void deleteOrphanTasks(CoreSession session, String id) {", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk5NDc0MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433994740", "body": "You could add the constant directly to `QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE`, this would avoid to always `String.format` the same constant \ud83e\udd14 ", "bodyText": "You could add the constant directly to QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE, this would avoid to always String.format the same constant \ud83e\udd14", "bodyHTML": "<p dir=\"auto\">You could add the constant directly to <code>QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE</code>, this would avoid to always <code>String.format</code> the same constant <g-emoji class=\"g-emoji\" alias=\"thinking\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f914.png\">\ud83e\udd14</g-emoji></p>", "author": "troger", "createdAt": "2020-06-02T16:02:08Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.task.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ *\n+ * @since 11.1\n+ */\n+public class DeleteTaskForDeletedDocumentRouteListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE %s = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            CoreSession session = context.getCoreSession();\n+            if (docModel.getType().equals(DOCUMENT_ROUTE_DOCUMENT_TYPE)) {\n+                deleteOrphanTasks(session, docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Deletes all tasks which processId matches the given id.\n+     *\n+     * @param session the session used to query.\n+     * @param id the deleted DocumentRoute id\n+     * @since 11.1\n+     */\n+    private void deleteOrphanTasks(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE, TASK_PROCESS_ID_PROPERTY_NAME, id);", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQzMzg5Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r434433892", "bodyText": "Thought since we are formatting anyway...concatenated it now", "author": "NourNuxeo", "createdAt": "2020-06-03T09:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk5NDc0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk5OTMxNA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r433999314", "body": "Keep it short maybe (like other listener such as `DocumentRouteCreationListener`):\r\n```suggestion\r\npublic class DocumentRouteDeletedListener implements EventListener {\r\n```\r\nAnd explain in the javadoc what the listener is doing.", "bodyText": "Keep it short maybe (like other listener such as DocumentRouteCreationListener):\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class DeleteTaskForDeletedDocumentRouteListener implements EventListener {\n          \n          \n            \n            public class DocumentRouteDeletedListener implements EventListener {\n          \n      \n    \n    \n  \n\nAnd explain in the javadoc what the listener is doing.", "bodyHTML": "<p dir=\"auto\">Keep it short maybe (like other listener such as <code>DocumentRouteCreationListener</code>):</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">DeleteTaskForDeletedDocumentRouteListener</span> <span class=\"pl-k\">implements</span> <span class=\"pl-e\">EventListener</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">DocumentRouteDeletedListener</span> <span class=\"pl-k\">implements</span> <span class=\"pl-e\">EventListener</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">And explain in the javadoc what the listener is doing.</p>", "author": "troger", "createdAt": "2020-06-02T16:07:51Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.task.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ *\n+ * @since 11.1\n+ */\n+public class DeleteTaskForDeletedDocumentRouteListener implements EventListener {", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTc4Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r434001782", "body": "Should go to `nuxeo-routing-core`... where your test lives.", "bodyText": "Should go to nuxeo-routing-core... where your test lives.", "bodyHTML": "<p dir=\"auto\">Should go to <code>nuxeo-routing-core</code>... where your test lives.</p>", "author": "troger", "createdAt": "2020-06-02T16:11:30Z", "path": "modules/platform/nuxeo-platform-task/nuxeo-platform-task-core/src/main/java/org/nuxeo/ecm/platform/task/core/listener/DeleteTaskForDeletedDocumentRouteListener.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*", "originalCommit": "631bb21b5cd9921f72a7ad285d27b6c013008658", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "url": "https://github.com/nuxeo/nuxeo/commit/1a350e0a318dd58fb4a47575e442c87a45a920dd", "message": "NXP-29099: add an orphaned Tasks listener", "committedDate": "2020-06-03T11:38:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MTk4MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436761981", "body": "```suggestion\r\n        if (ABOUT_TO_REMOVE.equals(event.getName())) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n          \n          \n            \n                    if (ABOUT_TO_REMOVE.equals(event.getName())) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (<span class=\"pl-smi x x-first\">DocumentEventTypes</span><span class=\"pl-c1\"><span class=\"pl-k x x-last\">.</span>ABOUT_TO_REMOVE</span><span class=\"pl-k\">.</span>equals(event<span class=\"pl-k\">.</span>getName())) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (<span class=\"pl-c1\">ABOUT_TO_REMOVE</span><span class=\"pl-k\">.</span>equals(event<span class=\"pl-k\">.</span>getName())) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-08T14:42:14Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MjM0Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436762347", "body": "Format", "bodyText": "Format", "bodyHTML": "<p dir=\"auto\">Format</p>", "author": "troger", "createdAt": "2020-06-08T14:42:41Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())) {\n+                deleteOrphanTasks(context.getCoreSession()  , docModel.getId());", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2MjU1Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436762556", "body": "```suggestion\r\n     * @param session the session used to query\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param session the session used to query.\n          \n          \n            \n                 * @param session the session used to query", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@param</span> session the session used to query<span class=\"x x-first x-last\">.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@param</span> session the session used to query</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-08T14:43:03Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())) {\n+                deleteOrphanTasks(context.getCoreSession()  , docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Deletes all tasks which processId matches the given id.\n+     *\n+     * @param session the session used to query.", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2NjMzMw==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436766333", "body": "Should extend `PostCommitEventListener ` for asynchronous post-commit listeners.", "bodyText": "Should extend PostCommitEventListener  for asynchronous post-commit listeners.", "bodyHTML": "<p dir=\"auto\">Should extend <code>PostCommitEventListener </code> for asynchronous post-commit listeners.</p>", "author": "troger", "createdAt": "2020-06-08T14:48:13Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements EventListener {", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwMjgzNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436802836", "bodyText": "Adapted #handleEvent accordingly", "author": "NourNuxeo", "createdAt": "2020-06-08T15:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2NjMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2ODYxOA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436768618", "body": "As you are async, use `DOCUMENT_REMOVED`.", "bodyText": "As you are async, use DOCUMENT_REMOVED.", "bodyHTML": "<p dir=\"auto\">As you are async, use <code>DOCUMENT_REMOVED</code>.</p>", "author": "troger", "createdAt": "2020-06-08T14:51:31Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2OTY2NA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436769664", "body": "```suggestion\r\n               .map(m -> m.get(ECM_UUID))\r\n               .map(id -> new IdRef((String) id))\r\n               .forEach(session::removeDocument);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                           .map(m -> m.get(ECM_UUID))\n          \n          \n            \n                           .forEach(s -> session.removeDocument(new IdRef((String) s)));\n          \n          \n            \n                           .map(m -> m.get(ECM_UUID))\n          \n          \n            \n                           .map(id -> new IdRef((String) id))\n          \n          \n            \n                           .forEach(session::removeDocument);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">               .map(m <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> m<span class=\"pl-k\">.</span>get(<span class=\"pl-c1\">ECM_UUID</span>))</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">               .forEach(s <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> session<span class=\"pl-k\">.</span>removeDocument(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">IdRef</span>((<span class=\"pl-smi\">String</span>) s)));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">               .map(m <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> m<span class=\"pl-k\">.</span>get(<span class=\"pl-c1\">ECM_UUID</span>))</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">               .map(id <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IdRef</span>((<span class=\"pl-smi\">String</span>) id))</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">               .forEach(session<span class=\"pl-k\">::</span>removeDocument);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-08T14:52:41Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.api.event.DocumentEventTypes;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements EventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(Event event) {\n+        if (DocumentEventTypes.ABOUT_TO_REMOVE.equals(event.getName())) {\n+            DocumentEventContext context = (DocumentEventContext) event.getContext();\n+            DocumentModel docModel = context.getSourceDocument();\n+            if (DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())) {\n+                deleteOrphanTasks(context.getCoreSession()  , docModel.getId());\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Deletes all tasks which processId matches the given id.\n+     *\n+     * @param session the session used to query.\n+     * @param id the deleted DocumentRoute id\n+     * @since 11.1\n+     */\n+    protected void deleteOrphanTasks(CoreSession session, String id) {\n+        String query = String.format(QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE, id);\n+        session.queryProjection(query, 0, 0)\n+               .stream()\n+               .map(m -> m.get(ECM_UUID))\n+               .forEach(s -> session.removeDocument(new IdRef((String) s)));", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwNTYwNw==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436805607", "bodyText": "applied it but renamed id as it is already a param name", "author": "NourNuxeo", "createdAt": "2020-06-08T15:42:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc2OTY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3MjYzMQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436772631", "body": "```suggestion\r\n        DocumentModel task = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DocumentModel taskDocument = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",\n          \n          \n            \n                    DocumentModel task = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">taskDocument</span> <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>createDocumentModel(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/default-domain/workspaces<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>dummyTask<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">DocumentModel</span> <span class=\"x x-first x-last\">task</span> <span class=\"pl-k\">=</span> session<span class=\"pl-k\">.</span>createDocumentModel(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/default-domain/workspaces<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>dummyTask<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "troger", "createdAt": "2020-06-08T14:55:40Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +367,25 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");\n+        route = session.createDocument(route);\n+\n+        DocumentModel taskDocument = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3MzI3MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436773270", "body": "No newline.", "bodyText": "No newline.", "bodyHTML": "<p dir=\"auto\">No newline.</p>", "author": "troger", "createdAt": "2020-06-08T14:56:19Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +367,25 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");\n+        route = session.createDocument(route);\n+", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzNDY1MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436834650", "bodyText": "Removed it and put one instead of the session.save() call", "author": "NourNuxeo", "createdAt": "2020-06-08T16:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3MzI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3NDE4MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436774181", "body": "Not needed?\r\n\r\nAnd if not needed, transform it to a newline to ease readability between test initialization and actual test.", "bodyText": "Not needed?\nAnd if not needed, transform it to a newline to ease readability between test initialization and actual test.", "bodyHTML": "<p dir=\"auto\">Not needed?</p>\n<p dir=\"auto\">And if not needed, transform it to a newline to ease readability between test initialization and actual test.</p>", "author": "troger", "createdAt": "2020-06-08T14:57:28Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +367,25 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");\n+        route = session.createDocument(route);\n+\n+        DocumentModel taskDocument = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",\n+                TASK_TYPE_NAME);\n+        taskDocument.setPropertyValue(TASK_PROCESS_ID_PROPERTY_NAME, route.getId());\n+        taskDocument = session.createDocument(taskDocument);\n+        session.save();", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgwOTkxOQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436809919", "bodyText": "not exactly sure but since I put postCommit to true and extend postCommitListener the test is broken, so I'm gonna look into it. Maybe I'll need awaitility #4090 (comment)", "author": "NourNuxeo", "createdAt": "2020-06-08T15:48:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3NDE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3NTk5Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436775997", "body": "Should use `txFeature.nextTransaction ()`just after the document removal as the listener is async postcommit, so the transaction needs to be committed.", "bodyText": "Should use txFeature.nextTransaction ()just after the document removal as the listener is async postcommit, so the transaction needs to be committed.", "bodyHTML": "<p dir=\"auto\">Should use <code>txFeature.nextTransaction ()</code>just after the document removal as the listener is async postcommit, so the transaction needs to be committed.</p>", "author": "troger", "createdAt": "2020-06-08T14:59:58Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +367,25 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");\n+        route = session.createDocument(route);\n+\n+        DocumentModel taskDocument = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",\n+                TASK_TYPE_NAME);\n+        taskDocument.setPropertyValue(TASK_PROCESS_ID_PROPERTY_NAME, route.getId());\n+        taskDocument = session.createDocument(taskDocument);\n+        session.save();\n+        session.removeDocument(route.getRef());\n+        if (session.exists(taskDocument.getRef())) {", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3NjY1Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436776652", "body": "What about `assertFalse`? \ud83d\ude04 ", "bodyText": "What about assertFalse? \ud83d\ude04", "bodyHTML": "<p dir=\"auto\">What about <code>assertFalse</code>? <g-emoji class=\"g-emoji\" alias=\"smile\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f604.png\">\ud83d\ude04</g-emoji></p>", "author": "troger", "createdAt": "2020-06-08T15:00:53Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +367,25 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");\n+        route = session.createDocument(route);\n+\n+        DocumentModel taskDocument = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyTask\",\n+                TASK_TYPE_NAME);\n+        taskDocument.setPropertyValue(TASK_PROCESS_ID_PROPERTY_NAME, route.getId());\n+        taskDocument = session.createDocument(taskDocument);\n+        session.save();\n+        session.removeDocument(route.getRef());\n+        if (session.exists(taskDocument.getRef())) {\n+            // Orphan tasks should not be found\n+            fail();\n+        }", "originalCommit": "1a350e0a318dd58fb4a47575e442c87a45a920dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyOTUxNg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436829516", "bodyText": "doh \ud83e\udd26", "author": "NourNuxeo", "createdAt": "2020-06-08T16:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3NjY1Mg=="}], "type": "inlineReview"}, {"oid": "8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "url": "https://github.com/nuxeo/nuxeo/commit/8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "message": "NXP-29099: add an orphaned Tasks listener", "committedDate": "2020-06-08T16:19:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg4MjQ5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r436882490", "body": "`CoreFeature` already includes `TransactionalFeature`, so no need to redefined the `@Features` annotation.", "bodyText": "CoreFeature already includes TransactionalFeature, so no need to redefined the @Features annotation.", "bodyHTML": "<p dir=\"auto\"><code>CoreFeature</code> already includes <code>TransactionalFeature</code>, so no need to redefined the <code>@Features</code> annotation.</p>", "author": "troger", "createdAt": "2020-06-08T17:42:25Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -46,17 +53,24 @@\n import org.nuxeo.ecm.core.api.security.impl.ACPImpl;\n import org.nuxeo.ecm.core.api.security.impl.UserEntryImpl;\n import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.test.CoreFeature;\n import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n import org.nuxeo.ecm.platform.routing.api.DocumentRouteElement;\n import org.nuxeo.ecm.platform.routing.api.DocumentRouteTableElement;\n import org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants;\n import org.nuxeo.ecm.platform.routing.api.exception.DocumentRouteAlredayLockedException;\n import org.nuxeo.ecm.platform.routing.api.exception.DocumentRouteNotLockedException;\n import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n import org.nuxeo.runtime.transaction.TransactionHelper;\n \n+@Features({ CoreFeature.class, DirectoryFeature.class, TransactionalFeature.class })", "originalCommit": "8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxMjU4Nw==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437212587", "body": "This test is not needed since the event bundle is filtered regarding the events defined to trigger the listener in its descriptor.", "bodyText": "This test is not needed since the event bundle is filtered regarding the events defined to trigger the listener in its descriptor.", "bodyHTML": "<p dir=\"auto\">This test is not needed since the event bundle is filtered regarding the events defined to trigger the listener in its descriptor.</p>", "author": "ataillefer", "createdAt": "2020-06-09T08:02:22Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.api.event.DocumentEventTypes.DOCUMENT_REMOVED;\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            if (DOCUMENT_REMOVED.equals(event.getName())) {", "originalCommit": "8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxMzc1OQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437213759", "body": "We often do a check before casting:\r\n```\r\nif (!(context instanceof DocumentEventContext)) {\r\n    return;\r\n}\r\n```\r\nbut I'm not sure it's relevant, maybe we can assume the context is always a `DocumentEventContext`.", "bodyText": "We often do a check before casting:\nif (!(context instanceof DocumentEventContext)) {\n    return;\n}\n\nbut I'm not sure it's relevant, maybe we can assume the context is always a DocumentEventContext.", "bodyHTML": "<p dir=\"auto\">We often do a check before casting:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"if (!(context instanceof DocumentEventContext)) {\n    return;\n}\"><pre><code>if (!(context instanceof DocumentEventContext)) {\n    return;\n}\n</code></pre></div>\n<p dir=\"auto\">but I'm not sure it's relevant, maybe we can assume the context is always a <code>DocumentEventContext</code>.</p>", "author": "ataillefer", "createdAt": "2020-06-09T08:04:28Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.api.event.DocumentEventTypes.DOCUMENT_REMOVED;\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            if (DOCUMENT_REMOVED.equals(event.getName())) {\n+                DocumentEventContext context = (DocumentEventContext) event.getContext();", "originalCommit": "8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI4MzQyMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437283420", "bodyText": "since it always happens in the events defined in the descriptor, I would also think it's always a DocumentEventContext. If it's ok I'll just remove the check on the event name.", "author": "NourNuxeo", "createdAt": "2020-06-09T09:47:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxMzc1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxNDM0Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437214342", "body": "```suggestion\r\n     * Deletes all tasks whose processId matches the given id.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Deletes all tasks which processId matches the given id.\n          \n          \n            \n                 * Deletes all tasks whose processId matches the given id.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Deletes</span> all tasks <span class=\"x x-first x-last\">which</span> processId matches the given id.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Deletes</span> all tasks <span class=\"x x-first x-last\">whose</span> processId matches the given id.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ataillefer", "createdAt": "2020-06-09T08:05:24Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.api.event.DocumentEventTypes.DOCUMENT_REMOVED;\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            if (DOCUMENT_REMOVED.equals(event.getName())) {\n+                DocumentEventContext context = (DocumentEventContext) event.getContext();\n+                DocumentModel docModel = context.getSourceDocument();\n+                if (DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())) {\n+                    deleteOrphanTasks(context.getCoreSession(), docModel.getId());\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Deletes all tasks which processId matches the given id.", "originalCommit": "8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxNTA5MA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437215090", "body": "I would remove the params and say in the main Javadoc \"Deletes all tasks whose process id matches the given DocumentRoute id.\".", "bodyText": "I would remove the params and say in the main Javadoc \"Deletes all tasks whose process id matches the given DocumentRoute id.\".", "bodyHTML": "<p dir=\"auto\">I would remove the params and say in the main Javadoc \"Deletes all tasks whose process id matches the given DocumentRoute id.\".</p>", "author": "ataillefer", "createdAt": "2020-06-09T08:06:46Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/main/java/org/nuxeo/ecm/platform/routing/core/listener/DocumentRouteDeletedListener.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/*\n+ * (C) Copyright 2020 Nuxeo (http://nuxeo.com/) and others.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ * Contributors:\n+ *     Nour AL KOTOB\n+ */\n+package org.nuxeo.ecm.platform.routing.core.listener;\n+\n+import static org.nuxeo.ecm.core.api.event.DocumentEventTypes.DOCUMENT_REMOVED;\n+import static org.nuxeo.ecm.core.query.sql.NXQL.ECM_UUID;\n+import static org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants.DOCUMENT_ROUTE_DOCUMENT_TYPE;\n+import static org.nuxeo.ecm.platform.task.TaskConstants.TASK_PROCESS_ID_PROPERTY_NAME;\n+\n+import org.nuxeo.ecm.core.api.CoreSession;\n+import org.nuxeo.ecm.core.api.DocumentModel;\n+import org.nuxeo.ecm.core.api.IdRef;\n+import org.nuxeo.ecm.core.event.Event;\n+import org.nuxeo.ecm.core.event.EventBundle;\n+import org.nuxeo.ecm.core.event.PostCommitEventListener;\n+import org.nuxeo.ecm.core.event.impl.DocumentEventContext;\n+\n+/**\n+ * Listener that deletes orphan Tasks.\n+ *\n+ * @since 11.1\n+ */\n+public class DocumentRouteDeletedListener implements PostCommitEventListener {\n+\n+    protected static final String QUERY_GET_TASKS_RELATED_TO_DOCUMENT_ROUTE = \"SELECT * FROM Document WHERE \"\n+            + TASK_PROCESS_ID_PROPERTY_NAME + \" = '%s'\";\n+\n+    @Override\n+    public void handleEvent(EventBundle events) {\n+        for (Event event : events) {\n+            if (DOCUMENT_REMOVED.equals(event.getName())) {\n+                DocumentEventContext context = (DocumentEventContext) event.getContext();\n+                DocumentModel docModel = context.getSourceDocument();\n+                if (DOCUMENT_ROUTE_DOCUMENT_TYPE.equals(docModel.getType())) {\n+                    deleteOrphanTasks(context.getCoreSession(), docModel.getId());\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Deletes all tasks which processId matches the given id.\n+     *\n+     * @param session the session used to query\n+     * @param id the deleted DocumentRoute id", "originalCommit": "8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxNTQzMA==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437215430", "body": "Is this needed?", "bodyText": "Is this needed?", "bodyHTML": "<p dir=\"auto\">Is this needed?</p>", "author": "ataillefer", "createdAt": "2020-06-09T08:07:22Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -361,6 +375,21 @@ public void testExecuteSimpleRouteWithConditionalStep() {\n         assertEquals(\"canceled\", children.get(2).getCurrentLifeCycleState());\n     }\n \n+    @Test\n+    public void testOrphanTasksDeletion() {\n+        DocumentModel route = session.createDocumentModel(\"/default-domain/workspaces\", \"dummyRoute\",\n+                DOCUMENT_ROUTE_DOCUMENT_TYPE);\n+        route.setPropertyValue(TITLE_PROPERTY_NAME, \"dummyRoute\");", "originalCommit": "8df4f711e9d77b8dfa8cb2c9336f34581e26c3fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5NTc5Ng==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437295796", "bodyText": "useless indeed. Removec \ud83d\udc4d", "author": "NourNuxeo", "createdAt": "2020-06-09T10:08:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIxNTQzMA=="}], "type": "inlineReview"}, {"oid": "cb595ba9fac8681d386c1dd0ad79c3be6810343e", "url": "https://github.com/nuxeo/nuxeo/commit/cb595ba9fac8681d386c1dd0ad79c3be6810343e", "message": "NXP-29099: add an orphaned Tasks listener", "committedDate": "2020-06-09T10:10:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2NjU0MQ==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437466541", "body": "Why do you need to add `@Features`? It should not be needed.", "bodyText": "Why do you need to add @Features? It should not be needed.", "bodyHTML": "<p dir=\"auto\">Why do you need to add <code>@Features</code>? It should not be needed.</p>", "author": "troger", "createdAt": "2020-06-09T14:27:51Z", "path": "modules/platform/nuxeo-platform-document-routing/nuxeo-routing-core/src/test/java/org/nuxeo/ecm/platform/routing/test/TestDocumentRoutingService.java", "diffHunk": "@@ -46,17 +53,24 @@\n import org.nuxeo.ecm.core.api.security.impl.ACPImpl;\n import org.nuxeo.ecm.core.api.security.impl.UserEntryImpl;\n import org.nuxeo.ecm.core.event.EventService;\n+import org.nuxeo.ecm.core.test.CoreFeature;\n import org.nuxeo.ecm.platform.routing.api.DocumentRoute;\n import org.nuxeo.ecm.platform.routing.api.DocumentRouteElement;\n import org.nuxeo.ecm.platform.routing.api.DocumentRouteTableElement;\n import org.nuxeo.ecm.platform.routing.api.DocumentRoutingConstants;\n import org.nuxeo.ecm.platform.routing.api.exception.DocumentRouteAlredayLockedException;\n import org.nuxeo.ecm.platform.routing.api.exception.DocumentRouteNotLockedException;\n import org.nuxeo.runtime.api.Framework;\n+import org.nuxeo.runtime.test.runner.Features;\n+import org.nuxeo.runtime.test.runner.TransactionalFeature;\n import org.nuxeo.runtime.transaction.TransactionHelper;\n \n+@Features({ CoreFeature.class, DirectoryFeature.class })", "originalCommit": "cb595ba9fac8681d386c1dd0ad79c3be6810343e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3MTg2Mg==", "url": "https://github.com/nuxeo/nuxeo/pull/4090#discussion_r437471862", "bodyText": "sorry, got focused on the txFeature, forgot I added the whole line", "author": "NourNuxeo", "createdAt": "2020-06-09T14:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2NjU0MQ=="}], "type": "inlineReview"}, {"oid": "9f5a5e8c450b0e310241ca78f7c5c8c709988a2c", "url": "https://github.com/nuxeo/nuxeo/commit/9f5a5e8c450b0e310241ca78f7c5c8c709988a2c", "message": "NXP-29099: add an orphaned Tasks listener", "committedDate": "2020-06-09T14:34:20Z", "type": "commit"}, {"oid": "9f5a5e8c450b0e310241ca78f7c5c8c709988a2c", "url": "https://github.com/nuxeo/nuxeo/commit/9f5a5e8c450b0e310241ca78f7c5c8c709988a2c", "message": "NXP-29099: add an orphaned Tasks listener", "committedDate": "2020-06-09T14:34:20Z", "type": "forcePushed"}]}