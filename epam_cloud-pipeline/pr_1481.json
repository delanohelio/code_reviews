{"pr_number": 1481, "pr_title": "Issue #1404: implemented tests for ClusterApiService", "pr_author": "YouKofan", "pr_createdAt": "2020-10-08T14:12:38Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1481", "merge_commit": "18a749f8e369606f5804285a4a445f42e9906598", "timeline": [{"oid": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "url": "https://github.com/epam/cloud-pipeline/commit/44f1669d54f99fd04970a8be0eabc30b328cabe1", "message": "Issue #1404: implemented tests for ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-12T02:02:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1NzEwOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504657109", "body": "Could you please add access modifier?", "bodyText": "Could you please add access modifier?", "bodyHTML": "<p dir=\"auto\">Could you please add access modifier?</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:01:19Z", "path": "api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java", "diffHunk": "@@ -144,6 +146,12 @@\n     @MockBean\n     protected CloudRegionManager mockCloudRegionManager;\n \n+    @MockBean\n+    protected NodeDiskManager mockNodeDiskManager;\n+\n+    @MockBean\n+    UsageMonitoringManager mockUsageMonitoringManager;", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\nindex 4585689af..befdb89c7 100644\n--- a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n", "chunk": "@@ -150,7 +151,7 @@ public class AclTestConfiguration {\n     protected NodeDiskManager mockNodeDiskManager;\n \n     @MockBean\n-    UsageMonitoringManager mockUsageMonitoringManager;\n+    protected UsageMonitoringManager mockUsageMonitoringManager;\n \n     @MockBean\n     protected EntityEventServiceManager entityEventServiceManager;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\nindex befdb89c7..9a8ad2391 100644\n--- a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n", "chunk": "@@ -147,12 +145,6 @@ public class AclTestConfiguration {\n     @MockBean\n     protected CloudRegionManager mockCloudRegionManager;\n \n-    @MockBean\n-    protected NodeDiskManager mockNodeDiskManager;\n-\n-    @MockBean\n-    protected UsageMonitoringManager mockUsageMonitoringManager;\n-\n     @MockBean\n     protected EntityEventServiceManager entityEventServiceManager;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\nindex 9a8ad2391..425b0840f 100644\n--- a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n", "chunk": "@@ -145,6 +147,12 @@ public class AclTestConfiguration {\n     @MockBean\n     protected CloudRegionManager mockCloudRegionManager;\n \n+    @MockBean\n+    protected NodeDiskManager mockNodeDiskManager;\n+\n+    @MockBean\n+    UsageMonitoringManager mockUsageMonitoringManager;\n+\n     @MockBean\n     protected EntityEventServiceManager entityEventServiceManager;\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\nindex 425b0840f..befdb89c7 100644\n--- a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n", "chunk": "@@ -151,7 +151,7 @@ public class AclTestConfiguration {\n     protected NodeDiskManager mockNodeDiskManager;\n \n     @MockBean\n-    UsageMonitoringManager mockUsageMonitoringManager;\n+    protected UsageMonitoringManager mockUsageMonitoringManager;\n \n     @MockBean\n     protected EntityEventServiceManager entityEventServiceManager;\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\nindex 4585689af..befdb89c7 100644\n--- a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n", "chunk": "@@ -150,7 +151,7 @@ public class AclTestConfiguration {\n     protected NodeDiskManager mockNodeDiskManager;\n \n     @MockBean\n-    UsageMonitoringManager mockUsageMonitoringManager;\n+    protected UsageMonitoringManager mockUsageMonitoringManager;\n \n     @MockBean\n     protected EntityEventServiceManager entityEventServiceManager;\n", "next_change": {"commit": "48c270f8b05106718d9254fc9cc90ed4a0e6dfd0", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\ndeleted file mode 100644\nindex befdb89c7..000000000\n--- a/api/src/test/java/com/epam/pipeline/app/AclTestConfiguration.java\n+++ /dev/null\n", "chunk": "@@ -1,199 +0,0 @@\n-/*\n- * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.epam.pipeline.app;\n-\n-import com.epam.pipeline.common.MessageHelper;\n-import com.epam.pipeline.dao.region.CloudRegionDao;\n-import com.epam.pipeline.manager.EntityManager;\n-import com.epam.pipeline.manager.billing.BillingManager;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n-import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n-import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n-import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n-import com.epam.pipeline.manager.datastorage.lustre.LustreFSManager;\n-import com.epam.pipeline.manager.docker.DockerRegistryManager;\n-import com.epam.pipeline.manager.event.EntityEventServiceManager;\n-import com.epam.pipeline.manager.filter.FilterManager;\n-import com.epam.pipeline.manager.git.GitManager;\n-import com.epam.pipeline.manager.issue.IssueManager;\n-import com.epam.pipeline.manager.log.LogManager;\n-import com.epam.pipeline.manager.metadata.MetadataEntityManager;\n-import com.epam.pipeline.manager.pipeline.DocumentGenerationPropertyManager;\n-import com.epam.pipeline.manager.pipeline.FolderManager;\n-import com.epam.pipeline.manager.pipeline.PipelineFileGenerationManager;\n-import com.epam.pipeline.manager.pipeline.PipelineManager;\n-import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.pipeline.PipelineVersionManager;\n-import com.epam.pipeline.manager.pipeline.RunLogManager;\n-import com.epam.pipeline.manager.pipeline.RunScheduleManager;\n-import com.epam.pipeline.manager.pipeline.ToolApiService;\n-import com.epam.pipeline.manager.pipeline.ToolGroupManager;\n-import com.epam.pipeline.manager.pipeline.ToolManager;\n-import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n-import com.epam.pipeline.manager.pipeline.runner.ConfigurationRunner;\n-import com.epam.pipeline.manager.region.CloudRegionManager;\n-import com.epam.pipeline.manager.user.UserManager;\n-import com.epam.pipeline.manager.utils.UtilsManager;\n-import com.epam.pipeline.security.acl.AclPermissionFactory;\n-import com.epam.pipeline.security.jwt.JwtTokenGenerator;\n-import org.springframework.boot.SpringBootConfiguration;\n-import org.springframework.boot.test.mock.mockito.MockBean;\n-import org.springframework.context.annotation.Bean;\n-import org.springframework.context.annotation.ComponentScan;\n-import org.springframework.context.annotation.EnableAspectJAutoProxy;\n-import org.springframework.context.annotation.Import;\n-import org.springframework.jdbc.datasource.DataSourceTransactionManager;\n-import org.springframework.security.acls.domain.PermissionFactory;\n-import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n-import org.springframework.test.context.TestPropertySource;\n-import org.springframework.transaction.PlatformTransactionManager;\n-\n-import javax.sql.DataSource;\n-\n-/**\n- * Provides basic configuration for writing tests for ACL security layers (ApiService classes).\n- * This configuration configures all ACL related beans and DB access and provides mock beans for\n- * all dependent classes. For now you can check whether bean is mock or not by checking list of mocks\n- * defined in this class.\n- */\n-@SpringBootConfiguration\n-@Import({AclSecurityConfiguration.class, DBConfiguration.class,\n-        MappersConfiguration.class, CacheConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.manager.security\"})\n-@TestPropertySource(value = {\"classpath:test-application.properties\"})\n-@EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)\n-@EnableAspectJAutoProxy\n-public class AclTestConfiguration {\n-\n-    @MockBean\n-    protected MessageHelper messageHelper;\n-\n-    @MockBean\n-    protected PipelineRunManager pipelineRunManager;\n-\n-    @MockBean\n-    protected PipelineManager pipelineManager;\n-\n-    @MockBean\n-    protected PipelineVersionManager pipelineVersionManager;\n-\n-    @MockBean\n-    protected InstanceOfferManager instanceOfferManager;\n-\n-    @MockBean\n-    protected GitManager gitManager;\n-\n-    @MockBean\n-    protected PipelineFileGenerationManager fileGenerationManager;\n-\n-    @MockBean\n-    protected DocumentGenerationPropertyManager documentGenerationPropertyManager;\n-\n-    @MockBean\n-    protected ToolManager toolManager;\n-\n-    @MockBean\n-    protected ToolGroupManager toolGroupManager;\n-\n-    @MockBean\n-    protected DockerRegistryManager dockerRegistryManager;\n-\n-    @MockBean\n-    protected EntityManager entityManager;\n-\n-    @MockBean\n-    protected JwtTokenGenerator jwtTokenGenerator;\n-\n-    @MockBean\n-    protected NodesManager nodesManager;\n-\n-    @MockBean\n-    protected UserManager userManager;\n-\n-    @MockBean\n-    protected MetadataEntityManager metadataEntityManager;\n-\n-    @MockBean\n-    protected IssueManager issueManager;\n-\n-    @MockBean\n-    protected FolderManager folderManager;\n-\n-    @MockBean\n-    protected ConfigurationProviderManager configurationProviderManager;\n-\n-    @MockBean\n-    protected RunConfigurationManager runConfigurationManager;\n-\n-    @MockBean\n-    protected LogManager mockLogManager;\n-\n-    @MockBean\n-    protected CloudRegionManager mockCloudRegionManager;\n-\n-    @MockBean\n-    protected NodeDiskManager mockNodeDiskManager;\n-\n-    @MockBean\n-    protected UsageMonitoringManager mockUsageMonitoringManager;\n-\n-    @MockBean\n-    protected EntityEventServiceManager entityEventServiceManager;\n-\n-    @MockBean\n-    protected ToolApiService toolApiService;\n-\n-    @MockBean\n-    protected FilterManager filterManager;\n-\n-    @MockBean\n-    protected RunLogManager runLogManager;\n-\n-    @MockBean\n-    protected UtilsManager utilsManager;\n-\n-    @MockBean\n-    protected ConfigurationRunner configurationRunner;\n-\n-    @MockBean\n-    protected CloudRegionDao cloudRegionDao;\n-\n-    @MockBean\n-    protected ContextualPreferenceManager contextualPreferenceManager;\n-\n-    @MockBean\n-    protected RunScheduleManager pipelineRunScheduleManager;\n-\n-    @MockBean\n-    public BillingManager billingManager;\n-\n-    @MockBean\n-    protected LustreFSManager lustreFSManager;\n-\n-    @Bean\n-    public PermissionFactory permissionFactory() {\n-        return new AclPermissionFactory();\n-    }\n-\n-    //TODO: replace with auto configuration?\n-    @Bean\n-    public PlatformTransactionManager platformTransactionManager(final DataSource dataSource) {\n-        return new DataSourceTransactionManager(dataSource);\n-    }\n-}\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "df6b911b920bcf86b1194acca20da5113707fb1f", "committedDate": "2020-10-27 17:57:15 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "9b550ed59ef67bd17097299e2fc79d8b456d60ef", "committedDate": "2020-11-10 14:15:55 +0300", "message": "Issue #1404: Tests for DataStorageApiService"}, {"oid": "0792887fca4762214a1e7554a3efecff5a51b415", "committedDate": "2020-11-12 12:57:20 +0300", "message": "Issue #1535: API shall restore pause/resume operations if it was rebooted"}, {"oid": "ebf3fb70fa5862e6e97951f25ac9a8f56015ebd5", "committedDate": "2020-11-16 17:58:25 +0300", "message": "Merge remote-tracking branch 'origin/develop' into issue_1535_continue_pause_resume_after_reboot"}, {"oid": "299df64bae5fedba84102bbed96bfa169795b0cc", "committedDate": "2020-11-18 10:05:27 +0300", "message": "Issue #1404: ToolApiServiceTest created"}, {"oid": "f8a105c83b6779b171187b79c9ee8ed188f9ee4e", "committedDate": "2020-11-26 17:53:46 +0300", "message": "Node Pool Management (#1609)"}, {"oid": "d2bde616ffe4def26a333c0bfe20730ec7547212", "committedDate": "2020-12-07 18:40:54 +0300", "message": "Issue #1404: Implemented tests for Dts package acl layer (#1587)"}, {"oid": "91c3cb3f96a43ba30ea64835d0fb1089e6f2ea4f", "committedDate": "2020-12-08 12:04:43 +0300", "message": "Issue #1404: Implemented tests for EntityApiService (#1588)"}, {"oid": "f1b246f5d0ed3e4cfdbf2523ca4909bd0503cc91", "committedDate": "2020-12-08 15:18:49 +0300", "message": "Issue #1404: Implemented tests for Metadata package acl layer (#1612)"}, {"oid": "85058f90a5183f751d68802449f7596255f07c53", "committedDate": "2020-12-08 16:11:49 +0300", "message": "Issue #1404: Implemented tests for User package acl layer (#1629)"}, {"oid": "acb312b7d7b3113d5d8c9cdd6466651d795f5296", "committedDate": "2020-12-08 17:09:12 +0300", "message": "Issue 1404: Implemented tests for PreferenceApiService (#1591)"}, {"oid": "ce1757ce109c6d018e28d23ee54821e17ff8890e", "committedDate": "2020-12-10 12:34:56 +0300", "message": "Fix failing test context"}, {"oid": "a20e9220c318621438ad62e3c6a1cdf21e9d8be3", "committedDate": "2020-12-21 20:16:51 +0300", "message": "`pipe` shall allow to import users from CSV (#1667)"}, {"oid": "48c270f8b05106718d9254fc9cc90ed4a0e6dfd0", "committedDate": "2020-12-22 13:47:34 +0300", "message": "Issue #1645: Rewrite RunApiServiceTest (#1651)"}, {"oid": "5a287c8a8c50f3bf2f65fba926dab98fb6de38df", "committedDate": "2021-01-28 16:36:28 +0300", "message": "Ontology support for the System Dictionaries (#1630)"}, {"oid": "099bf771df247dcbe2f19e8769b58abcc2eda51c", "committedDate": "2022-02-22 19:59:30 +0300", "message": "Hot nodes pools usage (#2491)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1NzUyOA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504657528", "body": "Cleanup please", "bodyText": "Cleanup please", "bodyHTML": "<p dir=\"auto\">Cleanup please</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:01:54Z", "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java", "diffHunk": "@@ -322,9 +438,9 @@ protected DataStorageManager mockDataStorageManager() {\n     }\n \n     @Bean\n-    protected FolderCrudManager mockCrudManager() {\n+    protected FolderCrudManager mockFolderCrudManager() {\n         return Mockito.mock(FolderCrudManager.class);\n-    }\n+    } /////", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex bf3f8f90d..7a768a694 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -440,7 +284,7 @@ public class AclTestBeans {\n     @Bean\n     protected FolderCrudManager mockFolderCrudManager() {\n         return Mockito.mock(FolderCrudManager.class);\n-    } /////\n+    }\n \n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7a768a694..161335e58 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -282,9 +414,9 @@ public class AclTestBeans {\n     }\n \n     @Bean\n-    protected FolderCrudManager mockFolderCrudManager() {\n+    protected FolderCrudManager folderCrudManager() {\n         return Mockito.mock(FolderCrudManager.class);\n-    }\n+    } /////\n \n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 161335e58..bf3f8f90d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -414,7 +438,7 @@ public class AclTestBeans {\n     }\n \n     @Bean\n-    protected FolderCrudManager folderCrudManager() {\n+    protected FolderCrudManager mockFolderCrudManager() {\n         return Mockito.mock(FolderCrudManager.class);\n     } /////\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex bf3f8f90d..cd8c08366 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -440,7 +444,7 @@ public class AclTestBeans {\n     @Bean\n     protected FolderCrudManager mockFolderCrudManager() {\n         return Mockito.mock(FolderCrudManager.class);\n-    } /////\n+    }\n \n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex bf3f8f90d..7a768a694 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -440,7 +284,7 @@ public class AclTestBeans {\n     @Bean\n     protected FolderCrudManager mockFolderCrudManager() {\n         return Mockito.mock(FolderCrudManager.class);\n-    } /////\n+    }\n \n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n", "next_change": {"commit": "1aab8c35fdfdc59a93df88726a5c3aa7340fc4c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7a768a694..907edf33f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -257,34 +333,152 @@ public class AclTestBeans {\n     @MockBean\n     protected ContextualPreferenceManager mockContextualPreferenceManager;\n \n+    @MockBean\n+    protected ToolVersionManager mockToolVersionManager;\n+\n+    @MockBean\n+    protected PipelineDao mockPipelineDao;\n+\n+    @MockBean\n+    protected DataStorageRuleDao mockDataStorageRuleDao;\n+\n+    @MockBean\n+    protected PipelineRunDao mockPipelineRunDao;\n+\n+    @MockBean\n+    protected RestartRunDao mockRestartRunDao;\n+\n+    @MockBean\n+    protected DtsSubmissionManager mockDtsSubmissionManager;\n+\n+    @MockBean\n+    protected PipelineLauncher mockPipelineLauncher;\n+\n+    @MockBean\n+    protected CommandBuilder mockCommandBuilder;\n+\n+    @MockBean\n+    protected CredentialsManager mockCredentialsManager;\n+\n+    @MockBean\n+    protected RunStatusDao mockRunStatusDao;\n+\n+    @MockBean\n+    protected StopServerlessRunDao mockStopServerlessRunDao;\n+\n+    @MockBean\n+    protected DockerContainerOperationManager mockDockerContainerOperationManager;\n+\n+    @MockBean\n+    protected ContextualPreferenceDao mockContextualPreferenceDao;\n+\n+    @MockBean\n+    protected ContextualPreferenceHandler mockContextualPreferenceHandler;\n+\n+    @MockBean\n+    protected MonitoringNotificationDao mockMonitoringNotificationDao;\n+\n+    @MockBean\n+    protected UserDao mockUserDao;\n+\n+    @MockBean\n+    protected RoleDao mockRoleDao;\n+\n+    @MockBean\n+    protected RunLogDao mockRunLogDao;\n+\n+    @MockBean\n+    protected GroupStatusDao mockGroupStatusDao;\n+\n+    @MockBean\n+    protected DataStorageValidator mockDataStorageValidator;\n+\n+    @MockBean\n+    protected NotificationManager mockNotificationManager;\n+\n+    @MockBean\n+    protected Pipeline mockPipeline;\n+\n     @MockBean\n     protected PipelineManager mockPipelineManager;\n \n+    @MockBean\n+    protected PipelineConfigurationManager mockPipelineConfigurationManager;\n+\n+    @MockBean\n+    protected RestartRunManager mockRestartRunManager;\n+\n+    @MockBean\n+    protected RunStatusManager mockRunStatusManager;\n+\n+    @MockBean\n+    protected PipelineRunCRUDService mockPipelineRunCRUDService;\n+\n+    @MockBean\n+    protected StopServerlessRunManager mockStopServerlessRunManager;\n+\n+    @MockBean\n+    protected ServerlessConfigurationManager mockServerlessConfigurationManager;\n+\n+    @MockBean\n+    protected ParameterMapper mockParameterMapper;\n+\n     @MockBean\n     protected UserManager mockUserManager;\n \n     @MockBean\n     protected LustreFSManager mockLustreFSManager;\n \n-    @Bean\n-    protected TemplatesScanner mockTemplatesScanner() {\n-        return Mockito.mock(TemplatesScanner.class);\n-    }\n+    @MockBean\n+    protected RunMountService mockRunMountService;\n \n-    @Bean\n-    protected JsonService mockJsonService() {\n-        return Mockito.mock(JsonService.class);\n-    }\n+    @MockBean\n+    protected TemporaryCredentialsManager mockTemporaryCredentialsManager;\n \n-    @Bean\n-    protected DataStorageManager mockDataStorageManager() {\n-        return Mockito.mock(DataStorageManager.class);\n-    }\n+    @MockBean\n+    protected NodeScheduleManager nodeScheduleManager;\n \n-    @Bean\n-    protected FolderCrudManager mockFolderCrudManager() {\n-        return Mockito.mock(FolderCrudManager.class);\n-    }\n+    @MockBean\n+    protected NodePoolManager nodePoolManager;\n+\n+    @MockBean\n+    protected InfrastructureManager infrastructureManager;\n+\n+    @MockBean\n+    protected PipelineRunDockerOperationManager pipelineRunDockerOperationManager;\n+\n+    @MockBean\n+    protected DtsListingManager mockDtsListingManager;\n+\n+    @MockBean\n+    protected CategoricalAttributeManager mockCategoricalAttributeManager;\n+\n+    @MockBean\n+    protected MetadataDownloadManager mockMetadataDownloadManager;\n+\n+    @MockBean\n+    protected UsersFileImportManager mockUsersFileImportManager;\n+\n+    @MockBean\n+    protected JsonService mockJsonService;\n+\n+    @MockBean\n+    protected DataStorageManager mockDataStorageManager;\n+\n+    @MockBean\n+    protected FolderCrudManager mockFolderCrudManager;\n+\n+    @MockBean\n+    protected RoleManager mockRoleManager;\n+\n+    @MockBean\n+    protected CloudProfileCredentialsManagerProvider mockCloudProfileCredentialsManagerProvider;\n+\n+    @MockBean\n+    protected OntologyManager mockOntologyManager;\n+\n+    @SpyBean\n+    protected HierarchicalEntityManager spyHierarchicalEntityManager;\n \n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n", "next_change": {"commit": "c88710d9137be68aa34f305895beb3391863bff8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 907edf33f..669ec6fe0 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -480,6 +474,14 @@ public class AclTestBeans {\n     @SpyBean\n     protected HierarchicalEntityManager spyHierarchicalEntityManager;\n \n+    @Bean\n+    protected FolderTemplateManager folderTemplateManager() {\n+        return new FolderTemplateManager();\n+    }\n+\n+    @MockBean\n+    protected TemplatesScanner mockTemplatesScanner;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "cd58a01c651f4d006715b134022978f0df337b9f", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 669ec6fe0..657ccf360 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -482,6 +483,9 @@ public class AclTestBeans {\n     @MockBean\n     protected TemplatesScanner mockTemplatesScanner;\n \n+    @MockBean\n+    protected ToolScanInfoManager toolScanInfoManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "8b0379c4d22db189a8a162e9b48bdc65a1a8c2d8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 657ccf360..19710b65c 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -486,6 +495,9 @@ public class AclTestBeans {\n     @MockBean\n     protected ToolScanInfoManager toolScanInfoManager;\n \n+    @MockBean\n+    protected PipelineRunKubernetesManager pipelineRunKubernetesManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "6ee23a663b1112632492ab85909b87bd801269e3", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 19710b65c..fb456178c 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -498,6 +511,9 @@ public class AclTestBeans {\n     @MockBean\n     protected PipelineRunKubernetesManager pipelineRunKubernetesManager;\n \n+    @MockBean\n+    protected UserRunnersManager mockUserRunnersManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "6883eb217f0ecf5c6385dfb69c4df4fb3c80cfb5", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex fb456178c..f59a3842d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -514,6 +515,9 @@ public class AclTestBeans {\n     @MockBean\n     protected UserRunnersManager mockUserRunnersManager;\n \n+    @MockBean\n+    protected PipelineRunAsManager mockPipelineRunAsManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "938d599a1a7d67f78ba89903ecb39ac753d52cae", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex f59a3842d..84e052c85 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -518,6 +519,9 @@ public class AclTestBeans {\n     @MockBean\n     protected PipelineRunAsManager mockPipelineRunAsManager;\n \n+    @MockBean\n+    protected EdgeServiceManager mockEdgeServiceManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "edc614e15039685d140921b1dfba3080f76c1ae5", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 84e052c85..8fbca4087 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -522,6 +527,9 @@ public class AclTestBeans {\n     @MockBean\n     protected EdgeServiceManager mockEdgeServiceManager;\n \n+    @MockBean\n+    protected NatGatewayManager natGatewayManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "3b66da04b457e0022cce3b78134bd9749a4b20ea", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 8fbca4087..0e8d9e421 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -530,6 +531,9 @@ public class AclTestBeans {\n     @MockBean\n     protected NatGatewayManager natGatewayManager;\n \n+    @MockBean\n+    protected QuotaService mockQuotaService;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "e76217d4af2581b0def66319b80ffa30b1982f0f", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 0e8d9e421..2f2e9a169 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -534,6 +536,12 @@ public class AclTestBeans {\n     @MockBean\n     protected QuotaService mockQuotaService;\n \n+    @MockBean\n+    protected UsersUsageReportService usersUsageReportService;\n+\n+    @MockBean\n+    protected OnlineUsersService onlineUsersService;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "b70b90035b21cfaf45419a1cf000309c6d041b8b", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 2f2e9a169..edaaecc69 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -542,6 +543,9 @@ public class AclTestBeans {\n     @MockBean\n     protected OnlineUsersService onlineUsersService;\n \n+    @MockBean\n+    protected NgsPreprocessingManager preprocessingManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "099bf771df247dcbe2f19e8769b58abcc2eda51c", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex edaaecc69..51aa9762d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -546,6 +548,12 @@ public class AclTestBeans {\n     @MockBean\n     protected NgsPreprocessingManager preprocessingManager;\n \n+    @MockBean\n+    protected NodePoolUsageService nodePoolUsageService;\n+\n+    @MockBean\n+    protected NodePoolReportService nodePoolReportService;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "1bf814d2d41636f574f0abd5f820a1b111faaf73", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 51aa9762d..dfc1d3d64 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -554,6 +555,9 @@ public class AclTestBeans {\n     @MockBean\n     protected NodePoolReportService nodePoolReportService;\n \n+    @MockBean\n+    protected PipelineRepositoryService pipelineRepositoryService;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "5bfc7fbf19d877e5c7cf3170a9b6f9a412a96e9d", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex dfc1d3d64..bb0e436d7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -558,6 +559,9 @@ public class AclTestBeans {\n     @MockBean\n     protected PipelineRepositoryService pipelineRepositoryService;\n \n+    @MockBean\n+    protected RunLimitsService runLimitsService;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "0de17d9b75080c4f294c64c534fb6783cd827799", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex bb0e436d7..aabf1b1f4 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -562,6 +563,9 @@ public class AclTestBeans {\n     @MockBean\n     protected RunLimitsService runLimitsService;\n \n+    @MockBean\n+    protected DataStorageLifecycleManager storageLifecycleManager;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "6bd8e8acda0b48b9550cd3339c1d366ccae6ef5e", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex aabf1b1f4..395ee74e0 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -566,6 +567,10 @@ public class AclTestBeans {\n     @MockBean\n     protected DataStorageLifecycleManager storageLifecycleManager;\n \n+    @MockBean\n+    protected DataStorageLifecycleRestoreManager storageLifecycleRestoreManager;\n+\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": {"commit": "9a79e476308c565267b10a316c3bfe127e02ce40", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 395ee74e0..f855b682e 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -570,6 +571,8 @@ public class AclTestBeans {\n     @MockBean\n     protected DataStorageLifecycleRestoreManager storageLifecycleRestoreManager;\n \n+    @MockBean\n+    protected StaticResourcesService staticResourcesService;\n \n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n", "next_change": {"commit": "b557b589e0f6977e16429e6ceee53f16ebe0f654", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex f855b682e..263c60f1a 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -574,6 +576,12 @@ public class AclTestBeans {\n     @MockBean\n     protected StaticResourcesService staticResourcesService;\n \n+    @MockBean\n+    protected UserNotificationManager userNotificationManager;\n+\n+    @MockBean\n+    protected UserNotificationRepository userNotificationRepository;\n+\n     @Bean\n     public GrantPermissionManager grantPermissionManager() {\n         GrantPermissionManager grantPermissionManager = new GrantPermissionManager();\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "0a70791f4f8fd2f6cbef4627e13bfc4c77429c53", "committedDate": "2020-10-27 17:54:14 +0300", "message": "Issue #1404: Unfinished tests for ConfigurationApiServices"}, {"oid": "4d1fa075892843422db2a569cb0baa957196c035", "committedDate": "2020-10-27 17:54:58 +0300", "message": "Issue #1404: Implemented tests for Configuration Api Services"}, {"oid": "663b6c2bf347e30b453f2d64e739bb31d49adeba", "committedDate": "2020-10-27 17:56:14 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "df6b911b920bcf86b1194acca20da5113707fb1f", "committedDate": "2020-10-27 17:57:15 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "45baaab480026d1161d1b7c631f07a610a1ca06d", "committedDate": "2020-11-10 14:17:12 +0300", "message": "Issue #1404: Tests refactored, merge conflicts resolved"}, {"oid": "0792887fca4762214a1e7554a3efecff5a51b415", "committedDate": "2020-11-12 12:57:20 +0300", "message": "Issue #1535: API shall restore pause/resume operations if it was rebooted"}, {"oid": "ebf3fb70fa5862e6e97951f25ac9a8f56015ebd5", "committedDate": "2020-11-16 17:58:25 +0300", "message": "Merge remote-tracking branch 'origin/develop' into issue_1535_continue_pause_resume_after_reboot"}, {"oid": "299df64bae5fedba84102bbed96bfa169795b0cc", "committedDate": "2020-11-18 10:05:27 +0300", "message": "Issue #1404: ToolApiServiceTest created"}, {"oid": "da987e2b7ffc2779ca80db55375582980c8dfb4e", "committedDate": "2020-11-18 10:05:36 +0300", "message": "Issue #1404: Implemented tests for ToolApiService"}, {"oid": "f8a105c83b6779b171187b79c9ee8ed188f9ee4e", "committedDate": "2020-11-26 17:53:46 +0300", "message": "Node Pool Management (#1609)"}, {"oid": "d2bde616ffe4def26a333c0bfe20730ec7547212", "committedDate": "2020-12-07 18:40:54 +0300", "message": "Issue #1404: Implemented tests for Dts package acl layer (#1587)"}, {"oid": "f1b246f5d0ed3e4cfdbf2523ca4909bd0503cc91", "committedDate": "2020-12-08 15:18:49 +0300", "message": "Issue #1404: Implemented tests for Metadata package acl layer (#1612)"}, {"oid": "c2e25eebf7dc03940471119bb731a6d092a2e49d", "committedDate": "2020-12-10 14:23:31 +0300", "message": "Issue #1404: Implemented tests for AclPermissionApiService (#1618)"}, {"oid": "e8473136642110f5366d10008796338250c9349d", "committedDate": "2020-12-21 14:38:51 +0300", "message": "Issue 1404: Implement tests for FolderApiService (#1644)"}, {"oid": "a20e9220c318621438ad62e3c6a1cdf21e9d8be3", "committedDate": "2020-12-21 20:16:51 +0300", "message": "`pipe` shall allow to import users from CSV (#1667)"}, {"oid": "d7a0194ab4fa38dad4bb977ff95d121bcf29ecde", "committedDate": "2020-12-23 20:51:12 +0300", "message": "Issue 1615 Route53 integration to be able to create custom dns records for the tools (#1624)"}, {"oid": "5a287c8a8c50f3bf2f65fba926dab98fb6de38df", "committedDate": "2021-01-28 16:36:28 +0300", "message": "Ontology support for the System Dictionaries (#1630)"}, {"oid": "de95b8a8eb0a69b47c76b97e4aa759e65ef832fe", "committedDate": "2021-01-29 14:38:23 +0300", "message": "Seamless authentication in AWS (#1765)"}, {"oid": "1aab8c35fdfdc59a93df88726a5c3aa7340fc4c8", "committedDate": "2021-02-08 16:06:42 +0300", "message": "Issue #1688: Rewrite HierarchicalEntityManager tests (#1702)"}, {"oid": "76bf1e4e1a300bf3c99831ea290eeb67134816ca", "committedDate": "2021-02-08 17:40:49 +0300", "message": "Remove unused mock bean"}, {"oid": "8a43d73f20ed44f9de2dd42dc68e2568eeae7f3c", "committedDate": "2021-02-08 19:11:12 +0300", "message": "Remove unnecessary mocks"}, {"oid": "c88710d9137be68aa34f305895beb3391863bff8", "committedDate": "2021-02-09 16:17:24 +0300", "message": "Issue-1735: Unit tests: Rewrite FolderTemplateManagerTest. (#1742)"}, {"oid": "cd58a01c651f4d006715b134022978f0df337b9f", "committedDate": "2021-02-18 22:51:45 +0300", "message": "New optimized method `/tool/{toolId}/info` to get aggregated vulnerability data (#1820)"}, {"oid": "7ce0509a04ef1d6c78ecffc99445788c926372ea", "committedDate": "2021-03-01 13:02:14 +0300", "message": "Issue 1754. Unit tests: Rewrite DockerRegistryNotificationTest (#1772)"}, {"oid": "8b0379c4d22db189a8a162e9b48bdc65a1a8c2d8", "committedDate": "2021-03-04 15:13:07 +0300", "message": "Allow to run \"hosted\" applications: API basic implementation (#1834)"}, {"oid": "99331b2e439fce5a1469051e05ad1586829dcbe7", "committedDate": "2021-03-23 20:54:19 +0300", "message": "Implement data storage object tags management (#1798)"}, {"oid": "7b4caa0e27e7c7cf711fe4bf77dae95accd5ebfa", "committedDate": "2021-03-24 16:57:17 +0300", "message": "Improve data storage object tags management (#1873)"}, {"oid": "6ee23a663b1112632492ab85909b87bd801269e3", "committedDate": "2021-05-14 12:38:21 +0300", "message": "Allow general users to run a job on behalf of the other account (#1961)"}, {"oid": "6883eb217f0ecf5c6385dfb69c4df4fb3c80cfb5", "committedDate": "2021-05-14 19:07:45 +0300", "message": "Allow to force \"run as\" and \"sharing\" options for the pipelines (#1962)"}, {"oid": "938d599a1a7d67f78ba89903ecb39ac753d52cae", "committedDate": "2021-07-12 15:48:27 +0300", "message": "Issue #1715: Multizone jobs and data access - API part (WIP) (#2019)"}, {"oid": "ebdec7d0aa8aa3ff1edfcd206246606abaeefd00", "committedDate": "2021-08-03 17:00:54 +0300", "message": "Support data storage to versioned storage conversion (#2107)"}, {"oid": "edc614e15039685d140921b1dfba3080f76c1ae5", "committedDate": "2021-11-05 23:28:03 +0300", "message": "Issue 2232 NAT gateway kube configuration (#2281)"}, {"oid": "3b66da04b457e0022cce3b78134bd9749a4b20ea", "committedDate": "2021-12-15 16:22:14 +0300", "message": "Cloud Pipeline shall allow users to configure spending quotas (#2401)"}, {"oid": "e76217d4af2581b0def66319b80ffa30b1982f0f", "committedDate": "2022-01-25 15:26:13 +0300", "message": "[Platform usage] Statistics reporting (#2473)"}, {"oid": "b70b90035b21cfaf45419a1cf000309c6d041b8b", "committedDate": "2022-02-07 17:14:49 +0300", "message": "Implementing logic for registering and de-registering of a samplesheet for special project type (#2493)"}, {"oid": "099bf771df247dcbe2f19e8769b58abcc2eda51c", "committedDate": "2022-02-22 19:59:30 +0300", "message": "Hot nodes pools usage (#2491)"}, {"oid": "1bf814d2d41636f574f0abd5f820a1b111faaf73", "committedDate": "2022-05-20 14:29:39 +0300", "message": "Bitbucket support: view and launch pipeline part (#2629)"}, {"oid": "5bfc7fbf19d877e5c7cf3170a9b6f9a412a96e9d", "committedDate": "2022-06-03 12:48:08 +0300", "message": "Issue #2642 Instance limits listing via pipe CLI (#2648)"}, {"oid": "0de17d9b75080c4f294c64c534fb6783cd827799", "committedDate": "2022-08-16 17:01:57 +0300", "message": "Issue 2721 storage lifecycle policy fine-tuned approach (#2729)"}, {"oid": "6bd8e8acda0b48b9550cd3339c1d366ccae6ef5e", "committedDate": "2022-09-06 16:34:30 +0300", "message": "Issue 2721 restore datastorage folder from 'archived' storage class (#2795)"}, {"oid": "9a79e476308c565267b10a316c3bfe127e02ce40", "committedDate": "2022-10-24 18:05:11 +0200", "message": "Allow to serve static resources from a datastorage path using `/restapi/static-resources/` endpoint"}, {"oid": "b557b589e0f6977e16429e6ceee53f16ebe0f654", "committedDate": "2023-01-27 21:47:30 +0100", "message": "Issue #3015 User notifications: minor fixes + move notifications creation to notifier service"}, {"oid": "51e3895b9414112fa85115b2d068c4e5cdb7f2ac", "committedDate": "2023-03-15 00:45:39 +0100", "message": "Introduce custom ACL deserialization for Redis Cache in order to improve performance"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1Nzg0Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504657846", "body": "Why we need such import?", "bodyText": "Why we need such import?", "bodyHTML": "<p dir=\"auto\">Why we need such import?</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:02:20Z", "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java", "diffHunk": "@@ -39,7 +41,11 @@\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 3463f89c9..76e5975c4 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,7 +41,11 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..001c030b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,10 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n @ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n         \"com.epam.pipeline.security.run\",\n         \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+        })\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 3463f89c9..76e5975c4 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,7 +41,11 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..001c030b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,10 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n @ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n         \"com.epam.pipeline.security.run\",\n         \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+        })\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2NDQ2MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504664461", "body": "Why we need `UserManager` real bean?", "bodyText": "Why we need UserManager real bean?", "bodyHTML": "<p dir=\"auto\">Why we need <code>UserManager</code> real bean?</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:11:42Z", "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java", "diffHunk": "@@ -39,7 +41,11 @@\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 3463f89c9..76e5975c4 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,7 +41,11 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..001c030b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,10 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n @ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n         \"com.epam.pipeline.security.run\",\n         \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+        })\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 3463f89c9..76e5975c4 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,7 +41,11 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..001c030b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,10 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n @ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n         \"com.epam.pipeline.security.run\",\n         \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+        })\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2ODA0Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504668047", "body": "Let's remove empty lines between fields.", "bodyText": "Let's remove empty lines between fields.", "bodyHTML": "<p dir=\"auto\">Let's remove empty lines between fields.</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:16:41Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NDA0Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504684042", "bodyText": "Also, cold you please place fields autowired fields declaration?", "author": "ekazachkova", "createdAt": "2020-10-14T13:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2ODA0Nw=="}], "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2OTU4OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504669588", "body": "Let's create a new build method in creators package. This  method may accept `id`, `name`, `owner` arguments.", "bodyText": "Let's create a new build method in creators package. This  method may accept id, name, owner arguments.", "bodyHTML": "<p dir=\"auto\">Let's create a new build method in creators package. This  method may accept <code>id</code>, <code>name</code>, <code>owner</code> arguments.</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:18:57Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n+\n+        pipelineRun.setId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER);\n+\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NTIxOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504675219", "body": "Let's not confuse packages: `PipelineRun` is not in cluster package. We need to create a new package/class for `PipelineRun` object creating methods.", "bodyText": "Let's not confuse packages: PipelineRun is not in cluster package. We need to create a new package/class for PipelineRun object creating methods.", "bodyHTML": "<p dir=\"auto\">Let's not confuse packages: <code>PipelineRun</code> is not in cluster package. We need to create a new package/class for <code>PipelineRun</code> object creating methods.</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:26:37Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -86,4 +99,20 @@ public static AllowedInstanceAndPriceTypes getDefaultAllowedInstanceAndPriceType\n     public static NodeDisk getDefaultNodeDisk() {\n         return new NodeDisk(ID, TEST_STRING, LDT);\n     }\n+\n+    public static PipelineRun getPipelineRun() {", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NTc3Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504675776", "bodyText": "The same for creators below", "author": "ekazachkova", "createdAt": "2020-10-14T13:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NTIxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 0989a10a6..48b9586b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -100,19 +103,11 @@ public final class NodeCreatorUtils {\n         return new NodeDisk(ID, TEST_STRING, LDT);\n     }\n \n-    public static PipelineRun getPipelineRun() {\n-        return new PipelineRun();\n-    }\n-\n-    public static ContextualPreference getContextualPreference() {\n-        return new ContextualPreference(\"name\", \"1\");\n-    }\n-\n-    public static ContextualPreferenceExternalResource getContextualPreferenceExternalResource() {\n-        return new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    public static List<NodeDisk> getNodeDiskList() {\n+        return Collections.singletonList(getDefaultNodeDisk());\n     }\n \n-    public static MonitoringStats getMonitoringStats() {\n-        return new MonitoringStats();\n+    public static List<InstanceType> getInstanceTypeList() {\n+        return Collections.singletonList(getDefaultInstanceType());\n     }\n }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 48b9586b7..b4bab9d13 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -102,12 +132,4 @@ public final class NodeCreatorUtils {\n     public static NodeDisk getDefaultNodeDisk() {\n         return new NodeDisk(ID, TEST_STRING, LDT);\n     }\n-\n-    public static List<NodeDisk> getNodeDiskList() {\n-        return Collections.singletonList(getDefaultNodeDisk());\n-    }\n-\n-    public static List<InstanceType> getInstanceTypeList() {\n-        return Collections.singletonList(getDefaultInstanceType());\n-    }\n }\n", "next_change": {"commit": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex b4bab9d13..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -132,4 +150,12 @@ public final class NodeCreatorUtils {\n     public static NodeDisk getDefaultNodeDisk() {\n         return new NodeDisk(ID, TEST_STRING, LDT);\n     }\n+\n+    public static List<NodeDisk> getNodeDiskList() {\n+        return Collections.singletonList(getDefaultNodeDisk());\n+    }\n+\n+    public static List<InstanceType> getInstanceTypeList() {\n+        return Collections.singletonList(getDefaultInstanceType());\n+    }\n }\n", "next_change": null}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 0989a10a6..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -100,19 +151,11 @@ public final class NodeCreatorUtils {\n         return new NodeDisk(ID, TEST_STRING, LDT);\n     }\n \n-    public static PipelineRun getPipelineRun() {\n-        return new PipelineRun();\n-    }\n-\n-    public static ContextualPreference getContextualPreference() {\n-        return new ContextualPreference(\"name\", \"1\");\n-    }\n-\n-    public static ContextualPreferenceExternalResource getContextualPreferenceExternalResource() {\n-        return new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    public static List<NodeDisk> getNodeDiskList() {\n+        return Collections.singletonList(getDefaultNodeDisk());\n     }\n \n-    public static MonitoringStats getMonitoringStats() {\n-        return new MonitoringStats();\n+    public static List<InstanceType> getInstanceTypeList() {\n+        return Collections.singletonList(getDefaultInstanceType());\n     }\n }\n", "next_change": null}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3Njg4Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504676882", "body": " Let's  inline test class field initiliazations and get rid of `setUp` method.", "bodyText": "Let's  inline test class field initiliazations and get rid of setUp method.", "bodyHTML": "<p dir=\"auto\">Let's  inline test class field initiliazations and get rid of <code>setUp</code> method.</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:28:58Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NzA3Mw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504677073", "body": "Do not forget final please", "bodyText": "Do not forget final please", "bodyHTML": "<p dir=\"auto\">Do not forget final please</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:29:16Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n+\n+        pipelineRun.setId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER);\n+\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n+\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(OWNER_USER);\n+        nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n+\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n+\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+\n+        List<NodeInstance> nodes = clusterApiService.getNodes();", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3ODY5Mw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504678693", "body": "Could we use `contains` method here?", "bodyText": "Could we use contains method here?", "bodyHTML": "<p dir=\"auto\">Could we use <code>contains</code> method here?</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:31:27Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;\n+\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n+\n+    @Before\n+    public void setUp() {\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n+\n+        pipelineRun.setId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER);\n+\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n+\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(OWNER_USER);\n+        nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n+\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n+\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1);", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3OTMwMg==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r504679302", "body": "Looks like this field was not initialized", "bodyText": "Looks like this field was not initialized", "bodyHTML": "<p dir=\"auto\">Looks like this field was not initialized</p>", "author": "ekazachkova", "createdAt": "2020-10-14T13:32:15Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,546 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+\n+    private InputStream inputStream;", "originalCommit": "44f1669d54f99fd04970a8be0eabc30b328cabe1", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,184 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-\n-        twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n-\n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n-\n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI0NzEzNA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506247134", "body": "Could you please add final to fields here and in other places?", "bodyText": "Could you please add final to fields here and in other places?", "bodyHTML": "<p dir=\"auto\">Could you please add final to fields here and in other places?</p>", "author": "ekazachkova", "createdAt": "2020-10-16T10:01:18Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -51,6 +53,24 @@ public static NodeInstance getDefaultNodeInstance() {\n         return new NodeInstance();\n     }\n \n+    public static NodeInstance getNodeInstanceWithPermission() {\n+        NodeInstance nodeInstance = new NodeInstance();", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..48b9586b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -53,20 +50,11 @@ public final class NodeCreatorUtils {\n         return new NodeInstance();\n     }\n \n-    public static NodeInstance getNodeInstanceWithPermission() {\n-        NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID);\n-        nodeInstance.setOwner(\"OWNER\");\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithPermission());\n-        nodeInstance.setName(TEST_STRING);\n-        return nodeInstance;\n-    }\n-\n-    public static NodeInstance getNodeInstanceWithoutPermission() {\n-        NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID_2);\n-        nodeInstance.setOwner(TEST_STRING);\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithoutPermission());\n+    public static NodeInstance getNodeInstance(Long id, String owner) {\n+        final NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setId(id);\n+        nodeInstance.setOwner(owner);\n+        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRun(id, owner));\n         nodeInstance.setName(TEST_STRING);\n         return nodeInstance;\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 48b9586b7..b4bab9d13 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -47,43 +69,51 @@ public final class NodeCreatorUtils {\n     }\n \n     public static NodeInstance getDefaultNodeInstance() {\n-        return new NodeInstance();\n-    }\n-\n-    public static NodeInstance getNodeInstance(Long id, String owner) {\n-        final NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(id);\n-        nodeInstance.setOwner(owner);\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRun(id, owner));\n+        final List<NodeInstanceAddress> nodeInstanceAddresses = Collections.singletonList(new NodeInstanceAddress());\n+        final Map<String, String> testMap = Collections.singletonMap(TEST_STRING, TEST_STRING);\n+        NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setClusterName(TEST_STRING);\n         nodeInstance.setName(TEST_STRING);\n+        nodeInstance.setCreationTimestamp(TEST_STRING);\n+        nodeInstance.setRegion(TEST_STRING);\n+        nodeInstance.setRunId(TEST_STRING);\n+        nodeInstance.setAddresses(nodeInstanceAddresses);\n+        nodeInstance.setAllocatable(testMap);\n+        nodeInstance.setCapacity(testMap);\n+        nodeInstance.setLabels(testMap);\n         return nodeInstance;\n     }\n \n     public static InstanceType getDefaultInstanceType() {\n-        return InstanceType.builder().name(TEST_STRING).build();\n+        return InstanceType.builder()\n+                .name(TEST_STRING)\n+                .gpu(TEST_INT)\n+                .instanceFamily(TEST_STRING)\n+                .memory(TEST_INT)\n+                .memoryUnit(TEST_STRING)\n+                .operatingSystem(TEST_STRING)\n+                .regionId(ID)\n+                .sku(TEST_STRING)\n+                .termType(TEST_STRING)\n+                .vCPU(TEST_INT)\n+                .build();\n     }\n \n     public static Node getDefaultNode() {\n         final ObjectMeta objectMeta = new ObjectMeta();\n+        objectMeta.setUid(UUID);\n         return new Node(\n                 TEST_STRING, TEST_STRING, objectMeta, new NodeSpec(), new NodeStatus());\n     }\n \n-    public static Node getEmptyNode() {\n-        return new Node();\n-    }\n-\n     public static MasterNode getDefaultMasterNode() {\n         return MasterNode.fromNode(getDefaultNode(), TEST_STRING);\n     }\n \n-    public static MasterNode getMasterNodeWithEmptyNode() {\n-        return MasterNode.fromNode(getEmptyNode(), TEST_STRING);\n-    }\n-\n     public static FilterNodesVO getDefaultFilterNodesVO() {\n         final FilterNodesVO filterNodesVO = new FilterNodesVO();\n         filterNodesVO.setAddress(TEST_STRING);\n+        filterNodesVO.setRunId(TEST_STRING);\n         return filterNodesVO;\n     }\n \n", "next_change": {"commit": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex b4bab9d13..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -106,10 +116,18 @@ public final class NodeCreatorUtils {\n                 TEST_STRING, TEST_STRING, objectMeta, new NodeSpec(), new NodeStatus());\n     }\n \n+    public static Node getEmptyNode() {\n+        return new Node();\n+    }\n+\n     public static MasterNode getDefaultMasterNode() {\n         return MasterNode.fromNode(getDefaultNode(), TEST_STRING);\n     }\n \n+    public static MasterNode getMasterNodeWithEmptyNode() {\n+        return MasterNode.fromNode(getEmptyNode(), TEST_STRING);\n+    }\n+\n     public static FilterNodesVO getDefaultFilterNodesVO() {\n         final FilterNodesVO filterNodesVO = new FilterNodesVO();\n         filterNodesVO.setAddress(TEST_STRING);\n", "next_change": null}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -50,33 +70,48 @@ public final class NodeCreatorUtils {\n     }\n \n     public static NodeInstance getDefaultNodeInstance() {\n-        return new NodeInstance();\n-    }\n-\n-    public static NodeInstance getNodeInstanceWithPermission() {\n+        final List<NodeInstanceAddress> nodeInstanceAddresses = Collections.singletonList(new NodeInstanceAddress());\n+        final Map<String, String> testMap = Collections.singletonMap(TEST_STRING, TEST_STRING);\n         NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID);\n-        nodeInstance.setOwner(\"OWNER\");\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithPermission());\n+        nodeInstance.setClusterName(TEST_STRING);\n         nodeInstance.setName(TEST_STRING);\n+        nodeInstance.setCreationTimestamp(TEST_STRING);\n+        nodeInstance.setRegion(TEST_STRING);\n+        nodeInstance.setRunId(TEST_STRING);\n+        nodeInstance.setAddresses(nodeInstanceAddresses);\n+        nodeInstance.setAllocatable(testMap);\n+        nodeInstance.setCapacity(testMap);\n+        nodeInstance.setLabels(testMap);\n         return nodeInstance;\n     }\n \n-    public static NodeInstance getNodeInstanceWithoutPermission() {\n-        NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID_2);\n-        nodeInstance.setOwner(TEST_STRING);\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithoutPermission());\n+    public static NodeInstance getNodeInstance(Long id, String owner) {\n+        final NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setId(id);\n+        nodeInstance.setOwner(owner);\n+        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRun(id, owner));\n         nodeInstance.setName(TEST_STRING);\n         return nodeInstance;\n     }\n \n     public static InstanceType getDefaultInstanceType() {\n-        return InstanceType.builder().name(TEST_STRING).build();\n+        return InstanceType.builder()\n+                .name(TEST_STRING)\n+                .gpu(TEST_INT)\n+                .instanceFamily(TEST_STRING)\n+                .memory(TEST_INT)\n+                .memoryUnit(TEST_STRING)\n+                .operatingSystem(TEST_STRING)\n+                .regionId(ID)\n+                .sku(TEST_STRING)\n+                .termType(TEST_STRING)\n+                .vCPU(TEST_INT)\n+                .build();\n     }\n \n     public static Node getDefaultNode() {\n         final ObjectMeta objectMeta = new ObjectMeta();\n+        objectMeta.setUid(UUID);\n         return new Node(\n                 TEST_STRING, TEST_STRING, objectMeta, new NodeSpec(), new NodeStatus());\n     }\n", "next_change": null}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI2MTkyNw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506261927", "body": "The `private` methods shell be after all `public` methods", "bodyText": "The private methods shell be after all public methods", "bodyHTML": "<p dir=\"auto\">The <code>private</code> methods shell be after all <code>public</code> methods</p>", "author": "ekazachkova", "createdAt": "2020-10-16T10:20:35Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI3NDU0NQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506274545", "body": "Could we use here\r\n```\r\nassertThat(resultStatsList).hasSize(1).contains(monitoringStats);\r\n```\r\nAnd in other such places too.", "bodyText": "Could we use here\nassertThat(resultStatsList).hasSize(1).contains(monitoringStats);\n\nAnd in other such places too.", "bodyHTML": "<p dir=\"auto\">Could we use here</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"assertThat(resultStatsList).hasSize(1).contains(monitoringStats);\"><pre><code>assertThat(resultStatsList).hasSize(1).contains(monitoringStats);\n</code></pre></div>\n<p dir=\"auto\">And in other such places too.</p>", "author": "ekazachkova", "createdAt": "2020-10-16T10:34:48Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        final List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -297,173 +243,155 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldTerminateNodeForAdmin() {\n         doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n \n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.terminateNode(nodeInstance.getName());\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnStatsForNodeForAdmin() {\n-        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n         final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnStatsWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-\n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(statsList).when(mockUsageMonitoringManager)\n                 .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnInstanceTypes() {\n         doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n \n-        final List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnToolInstanceTypes() {\n         doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n \n-        final List<InstanceType> resultInstanceTypesList = clusterApiService\n-                .getAllowedToolInstanceTypes(1L, true);\n-\n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnAllowedInstanceAndPriceTypes() {\n         final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n                 NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n         doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n                 .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n \n-        final AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n+                .isEqualTo(allowedInstanceAndPriceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnMasterNodes() {\n         final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n         doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n \n-        final List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n-\n-        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -297,173 +245,155 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldTerminateNodeForAdmin() {\n         doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n \n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.terminateNode(nodeInstance.getName());\n+        assertThrows(AccessDeniedException.class,\n+            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnStatsForNodeForAdmin() {\n-        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n         final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnStatsWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-\n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(statsList).when(mockUsageMonitoringManager)\n                 .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        assertThrows(AccessDeniedException.class,\n+            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n \n-        final List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n-\n-        final List<InstanceType> resultInstanceTypesList = clusterApiService\n-                .getAllowedToolInstanceTypes(1L, true);\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n \n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnAllowedInstanceAndPriceTypes() {\n         final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n                 NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n         doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        final AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n \n-        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n+                .isEqualTo(allowedInstanceAndPriceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnMasterNodes() {\n         final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n         doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n \n-        final List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n-\n-        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4NTY5Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506285696", "body": "It seems that we can just use `basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"}`", "bodyText": "It seems that we can just use basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"}", "bodyHTML": "<p dir=\"auto\">It seems that we can just use <code>basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"}</code></p>", "author": "ekazachkova", "createdAt": "2020-10-16T10:48:52Z", "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java", "diffHunk": "@@ -39,7 +39,10 @@\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 3463f89c9..76e5975c4 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,7 +41,11 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..001c030b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,10 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n @ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n         \"com.epam.pipeline.security.run\",\n         \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+        })\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 3463f89c9..76e5975c4 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,7 +41,11 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n+@Import({ContextualPreferenceHandler.class})\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n+        \"com.epam.pipeline.security.run\",\n+        \"com.epam.pipeline.manager.security\",\n+        \"com.epam.pipeline.manager.user\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 76e5975c4..001c030b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -41,11 +39,10 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@Import({ContextualPreferenceHandler.class})\n @ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n         \"com.epam.pipeline.security.run\",\n         \"com.epam.pipeline.manager.security\",\n-        \"com.epam.pipeline.manager.user\"})\n+        })\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\nindex 001c030b7..3463f89c9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestConfiguration.java\n", "chunk": "@@ -39,10 +39,7 @@ import java.lang.annotation.Target;\n @Target(ElementType.TYPE)\n @Retention(RetentionPolicy.RUNTIME)\n @ContextConfiguration(classes = {AclTestBeans.class, AclSecurityConfiguration.class})\n-@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\",\n-        \"com.epam.pipeline.security.run\",\n-        \"com.epam.pipeline.manager.security\",\n-        })\n+@ComponentScan(basePackages = {\"com.epam.pipeline.security.acl\", \"com.epam.pipeline.manager.security\"})\n @EnableAspectJAutoProxy(proxyTargetClass = true)\n @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)\n @TestPropertySource(value = {\"classpath:test-application.properties\"})\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4ODE4Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506288186", "body": "Could you please rename this class to `ClusterCreatorUtils`? This class should consist of creators for entities from `cluster` package.", "bodyText": "Could you please rename this class to ClusterCreatorUtils? This class should consist of creators for entities from cluster package.", "bodyHTML": "<p dir=\"auto\">Could you please rename this class to <code>ClusterCreatorUtils</code>? This class should consist of creators for entities from <code>cluster</code> package.</p>", "author": "ekazachkova", "createdAt": "2020-10-16T10:51:53Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -23,6 +23,7 @@\n import com.epam.pipeline.entity.cluster.MasterNode;\n import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..b4bab9d13 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -16,6 +16,7 @@\n \n package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.controller.Result;\n import com.epam.pipeline.controller.vo.FilterNodesVO;\n import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n", "next_change": null}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..b4bab9d13 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -23,7 +24,9 @@ import com.epam.pipeline.entity.cluster.InstanceType;\n import com.epam.pipeline.entity.cluster.MasterNode;\n import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import com.epam.pipeline.entity.cluster.NodeInstanceAddress;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.fasterxml.jackson.core.type.TypeReference;\n import io.fabric8.kubernetes.api.model.Node;\n import io.fabric8.kubernetes.api.model.NodeSpec;\n import io.fabric8.kubernetes.api.model.NodeStatus;\n", "next_change": {"commit": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex b4bab9d13..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -26,6 +26,7 @@ import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n import com.epam.pipeline.entity.cluster.NodeInstanceAddress;\n import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n import com.fasterxml.jackson.core.type.TypeReference;\n import io.fabric8.kubernetes.api.model.Node;\n import io.fabric8.kubernetes.api.model.NodeSpec;\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -16,6 +16,7 @@\n \n package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.controller.Result;\n import com.epam.pipeline.controller.vo.FilterNodesVO;\n import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n", "next_change": null}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -23,7 +24,10 @@ import com.epam.pipeline.entity.cluster.InstanceType;\n import com.epam.pipeline.entity.cluster.MasterNode;\n import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.NodeInstanceAddress;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import com.fasterxml.jackson.core.type.TypeReference;\n import io.fabric8.kubernetes.api.model.Node;\n import io.fabric8.kubernetes.api.model.NodeSpec;\n import io.fabric8.kubernetes.api.model.NodeStatus;\n", "next_change": null}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI4ODkyMw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506288923", "body": "Could you move this method to `ClusterCreatorUtils`?", "bodyText": "Could you move this method to ClusterCreatorUtils?", "bodyHTML": "<p dir=\"auto\">Could you move this method to <code>ClusterCreatorUtils</code>?</p>", "author": "ekazachkova", "createdAt": "2020-10-16T10:52:43Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java", "diffHunk": "@@ -55,4 +56,8 @@ public static ContextualPreferenceVO getContextualPreferenceVO() {\n                 TEST_STRING, TEST_STRING, PREFERENCE_TYPE, getCPExternalResource()\n         );\n     }\n+\n+    public static MonitoringStats getMonitoringStats() {", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\nindex 1a5771a79..106d37f95 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n", "chunk": "@@ -56,8 +62,4 @@ public final class ContextualPreferenceCreatorUtils {\n                 TEST_STRING, TEST_STRING, PREFERENCE_TYPE, getCPExternalResource()\n         );\n     }\n-\n-    public static MonitoringStats getMonitoringStats() {\n-        return new MonitoringStats();\n-    }\n }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\nindex 106d37f95..58045e714 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n", "chunk": "@@ -59,7 +59,10 @@ public final class ContextualPreferenceCreatorUtils {\n \n     public static ContextualPreferenceVO getContextualPreferenceVO() {\n         return new ContextualPreferenceVO(\n-                TEST_STRING, TEST_STRING, PREFERENCE_TYPE, getCPExternalResource()\n-        );\n+                TEST_STRING, TEST_STRING, PREFERENCE_TYPE, getCPExternalResource());\n+    }\n+\n+    public static List<ContextualPreference> getContextualPreferenceList() {\n+        return Collections.singletonList(getContextualPreference());\n     }\n }\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\nindex 58045e714..d03d11819 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n", "chunk": "@@ -65,4 +66,8 @@ public final class ContextualPreferenceCreatorUtils {\n     public static List<ContextualPreference> getContextualPreferenceList() {\n         return Collections.singletonList(getContextualPreference());\n     }\n+\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\nindex d03d11819..58045e714 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n", "chunk": "@@ -66,8 +65,4 @@ public final class ContextualPreferenceCreatorUtils {\n     public static List<ContextualPreference> getContextualPreferenceList() {\n         return Collections.singletonList(getContextualPreference());\n     }\n-\n-    public static MonitoringStats getMonitoringStats() {\n-        return new MonitoringStats();\n-    }\n }\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\nindex 1a5771a79..58045e714 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n", "chunk": "@@ -53,11 +59,10 @@ public final class ContextualPreferenceCreatorUtils {\n \n     public static ContextualPreferenceVO getContextualPreferenceVO() {\n         return new ContextualPreferenceVO(\n-                TEST_STRING, TEST_STRING, PREFERENCE_TYPE, getCPExternalResource()\n-        );\n+                TEST_STRING, TEST_STRING, PREFERENCE_TYPE, getCPExternalResource());\n     }\n \n-    public static MonitoringStats getMonitoringStats() {\n-        return new MonitoringStats();\n+    public static List<ContextualPreference> getContextualPreferenceList() {\n+        return Collections.singletonList(getContextualPreference());\n     }\n }\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\nindex 58045e714..d03d11819 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n", "chunk": "@@ -65,4 +66,8 @@ public final class ContextualPreferenceCreatorUtils {\n     public static List<ContextualPreference> getContextualPreferenceList() {\n         return Collections.singletonList(getContextualPreference());\n     }\n+\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\nindex d03d11819..58045e714 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/contextual/ContextualPreferenceCreatorUtils.java\n", "chunk": "@@ -66,8 +65,4 @@ public final class ContextualPreferenceCreatorUtils {\n     public static List<ContextualPreference> getContextualPreferenceList() {\n         return Collections.singletonList(getContextualPreference());\n     }\n-\n-    public static MonitoringStats getMonitoringStats() {\n-        return new MonitoringStats();\n-    }\n }\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5MTc4MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506291780", "body": "It is absolutely not clear what is meant `permission`", "bodyText": "It is absolutely not clear what is meant permission", "bodyHTML": "<p dir=\"auto\">It is absolutely not clear what is meant <code>permission</code></p>", "author": "ekazachkova", "createdAt": "2020-10-16T10:56:12Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+\n+public final class PipelineCreatorUtils {\n+\n+    public static PipelineRun getPipelineRunWithPermission() {", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 4d0cface3..3ff864612 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,23 +18,14 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public class PipelineCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n-        return pipelineRun;\n-    }\n-\n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\ndeleted file mode 100644\nindex 3ff864612..000000000\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ /dev/null\n", "chunk": "@@ -1,32 +0,0 @@\n-/*\n- * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.epam.pipeline.test.creator.pipeline;\n-\n-import com.epam.pipeline.entity.pipeline.PipelineRun;\n-\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-\n-public class PipelineCreatorUtils {\n-\n-    public static PipelineRun getPipelineRun(Long id, String owner) {\n-        final PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(id);\n-        pipelineRun.setOwner(owner);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n-    }\n-}\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nnew file mode 100644\nindex 000000000..a75fddf65\n--- /dev/null\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+\n+public final class PipelineCreatorUtils {\n+\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID);\n+        pipelineRun.setOwner(\"SIMPLE_USER\");\n+        return pipelineRun;\n+    }\n+\n+    public static PipelineRun getPipelineRunWithoutPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID_2);\n+        pipelineRun.setOwner(TEST_STRING);\n+        pipelineRun.setName(TEST_STRING);\n+        return pipelineRun;\n+    }\n+}\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nsimilarity index 62%\nrename from api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nrename to api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nindex a75fddf65..e3b310b1f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\n", "chunk": "@@ -14,26 +14,24 @@\n  * limitations under the License.\n  */\n \n-package com.epam.pipeline.test.creator.pipeline;\n+package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public final class ClusterCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n+        pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n     }\n }\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 4d0cface3..9661283c2 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,23 +18,18 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n public final class PipelineCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n-        return pipelineRun;\n+    private PipelineCreatorUtils() {\n+\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 9661283c2..a75fddf65 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,18 +18,21 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n \n public final class PipelineCreatorUtils {\n \n-    private PipelineCreatorUtils() {\n-\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID);\n+        pipelineRun.setOwner(\"SIMPLE_USER\");\n+        return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRun(Long id, String owner) {\n-        final PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(id);\n-        pipelineRun.setOwner(owner);\n+    public static PipelineRun getPipelineRunWithoutPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID_2);\n+        pipelineRun.setOwner(TEST_STRING);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nsimilarity index 62%\nrename from api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nrename to api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nindex a75fddf65..e3b310b1f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\n", "chunk": "@@ -14,26 +14,24 @@\n  * limitations under the License.\n  */\n \n-package com.epam.pipeline.test.creator.pipeline;\n+package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public final class ClusterCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n+        pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n     }\n }\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "c3237f3d382b414f66cb99688468c0695047be92", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Added license to the PipelineCreatorUtils and other minor style fixes"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "9b550ed59ef67bd17097299e2fc79d8b456d60ef", "committedDate": "2020-11-10 14:15:55 +0300", "message": "Issue #1404: Tests for DataStorageApiService"}, {"oid": "f480ccd0e25487d598a9c602305c090f3ae0e081", "committedDate": "2020-11-10 14:16:28 +0300", "message": "Issue #1404: Tests for DataStorageApiService"}, {"oid": "45baaab480026d1161d1b7c631f07a610a1ca06d", "committedDate": "2020-11-10 14:17:12 +0300", "message": "Issue #1404: Tests refactored, merge conflicts resolved"}, {"oid": "2f13f0aa538db6b1a8146d4a759329e245e484bd", "committedDate": "2020-11-10 14:19:06 +0300", "message": "Issue #1404: And more corrections and improvements"}, {"oid": "85058f90a5183f751d68802449f7596255f07c53", "committedDate": "2020-12-08 16:11:49 +0300", "message": "Issue #1404: Implemented tests for User package acl layer (#1629)"}, {"oid": "83cd94c75bda1064b8791e8112e552881760e687", "committedDate": "2020-12-21 13:38:29 +0300", "message": "Issue #1404: Implemented tests for acl layer PipelineApiService (#1642)"}, {"oid": "e8473136642110f5366d10008796338250c9349d", "committedDate": "2020-12-21 14:38:51 +0300", "message": "Issue 1404: Implement tests for FolderApiService (#1644)"}, {"oid": "6771635b9d3703c8c3c15a4f11d538d7d3fdf2cb", "committedDate": "2020-12-28 16:45:27 +0300", "message": "Issue #1405: Implemented tests for DetachedConfigurationScheduleController (#1670)"}, {"oid": "870fb219c2268cde49fea069c47f0f96cb130b97", "committedDate": "2020-12-28 17:42:24 +0300", "message": "Issue #1404: Implemented tests for acl layer PipelineApiService"}, {"oid": "96ecee3dafd1d54a4ab86d11bc02313f3797ccd0", "committedDate": "2020-12-28 18:31:26 +0300", "message": "Issue #1405: Implemented tests for controller layer pipeline"}, {"oid": "2c1fa97606a5f1e0d625884e11dd2bdb838a9a0c", "committedDate": "2020-12-28 18:32:00 +0300", "message": "Issue #1405: Added missing tests for controller layer pipeline"}, {"oid": "d7111212b3efd91da4a35cd3225f91eb59742942", "committedDate": "2020-12-28 18:32:02 +0300", "message": "Issue #1405: changes in assertion method"}, {"oid": "e91e9b4f005016c3acf02a5243dc5987bf6b291f", "committedDate": "2020-12-28 18:32:02 +0300", "message": "Issue #1405: improvements in the assertUnwrappedResponse method"}, {"oid": "f964ea6891036be526092bb559702594007e1248", "committedDate": "2020-12-28 18:32:20 +0300", "message": "Issue #1405: branch rebased, merge conflicts resolved"}, {"oid": "ed7ab85746e49f0e3173f03ddd97f30fc0becf26", "committedDate": "2020-12-28 18:49:57 +0300", "message": "Issue #1405: refactoring in the PipelineCreatorUtils class"}, {"oid": "29d6f7c6616aa7f49a5e4310554a5f0ac8d45d61", "committedDate": "2021-02-04 16:23:21 +0300", "message": "Issue-1743. Unit tests: PipelineConfigurationManagerTest (#1747)"}, {"oid": "a32ee200726dc69f9849919bc8cc3e6c98fc227f", "committedDate": "2021-03-01 14:13:20 +0300", "message": "Issue #1752: rewritten tests with new configuration (#1778)"}, {"oid": "8b0379c4d22db189a8a162e9b48bdc65a1a8c2d8", "committedDate": "2021-03-04 15:13:07 +0300", "message": "Allow to run \"hosted\" applications: API basic implementation (#1834)"}, {"oid": "4d31038df225f8e6bb63015bc0dba432860cd7c5", "committedDate": "2021-03-05 14:49:49 +0300", "message": "Issue 1776: Unit Tests: Refactor PipelineRunManagerTest (#1793)"}, {"oid": "2e607aa737405e6b87631af05941157ae1524e78", "committedDate": "2021-03-15 17:01:13 +0300", "message": "Issue_1776_2: [Unit Tests] Refactor PipelineRunManagerTest. Part 2. (#1841)"}, {"oid": "16344d0c075c5673f4b755dbf0ac74cff07badfa", "committedDate": "2021-03-22 13:35:55 +0300", "message": "Unit tests: Rewrite RunScheduleManagerTest #1755 (#1785)"}, {"oid": "8d20bea9506f9b9409e27622126f997a023906d6", "committedDate": "2021-07-29 12:24:47 +0300", "message": "Support per run notifications (#2096)"}, {"oid": "ebdec7d0aa8aa3ff1edfcd206246606abaeefd00", "committedDate": "2021-08-03 17:00:54 +0300", "message": "Support data storage to versioned storage conversion (#2107)"}, {"oid": "29638bff544726f0137d0b4efdce624300514388", "committedDate": "2022-07-04 15:33:51 +0300", "message": "Issue 2696: Allow to specify notifications in pipeline/tool configuration (#2707)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5NzE2OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506297168", "body": "Let's avoid some test case specific naming in such classes. For example, for current situation we need only one method  for this class - `getPipelineRun` that will return `PipelineRun` object and accepts all required argument: id, name, owner... You may take the `ObjectCreatorUtils` class as a basis.", "bodyText": "Let's avoid some test case specific naming in such classes. For example, for current situation we need only one method  for this class - getPipelineRun that will return PipelineRun object and accepts all required argument: id, name, owner... You may take the ObjectCreatorUtils class as a basis.", "bodyHTML": "<p dir=\"auto\">Let's avoid some test case specific naming in such classes. For example, for current situation we need only one method  for this class - <code>getPipelineRun</code> that will return <code>PipelineRun</code> object and accepts all required argument: id, name, owner... You may take the <code>ObjectCreatorUtils</code> class as a basis.</p>", "author": "ekazachkova", "createdAt": "2020-10-16T11:03:13Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+\n+public final class PipelineCreatorUtils {", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 4d0cface3..3ff864612 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,23 +18,14 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public class PipelineCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n-        return pipelineRun;\n-    }\n-\n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\ndeleted file mode 100644\nindex 3ff864612..000000000\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ /dev/null\n", "chunk": "@@ -1,32 +0,0 @@\n-/*\n- * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.epam.pipeline.test.creator.pipeline;\n-\n-import com.epam.pipeline.entity.pipeline.PipelineRun;\n-\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-\n-public class PipelineCreatorUtils {\n-\n-    public static PipelineRun getPipelineRun(Long id, String owner) {\n-        final PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(id);\n-        pipelineRun.setOwner(owner);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n-    }\n-}\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nnew file mode 100644\nindex 000000000..a75fddf65\n--- /dev/null\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+\n+public final class PipelineCreatorUtils {\n+\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID);\n+        pipelineRun.setOwner(\"SIMPLE_USER\");\n+        return pipelineRun;\n+    }\n+\n+    public static PipelineRun getPipelineRunWithoutPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID_2);\n+        pipelineRun.setOwner(TEST_STRING);\n+        pipelineRun.setName(TEST_STRING);\n+        return pipelineRun;\n+    }\n+}\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nsimilarity index 62%\nrename from api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nrename to api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nindex a75fddf65..e3b310b1f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\n", "chunk": "@@ -14,26 +14,24 @@\n  * limitations under the License.\n  */\n \n-package com.epam.pipeline.test.creator.pipeline;\n+package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public final class ClusterCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n+        pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n     }\n }\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 4d0cface3..9661283c2 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,23 +18,18 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n public final class PipelineCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n-        return pipelineRun;\n+    private PipelineCreatorUtils() {\n+\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 9661283c2..a75fddf65 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,18 +18,21 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n \n public final class PipelineCreatorUtils {\n \n-    private PipelineCreatorUtils() {\n-\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID);\n+        pipelineRun.setOwner(\"SIMPLE_USER\");\n+        return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRun(Long id, String owner) {\n-        final PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(id);\n-        pipelineRun.setOwner(owner);\n+    public static PipelineRun getPipelineRunWithoutPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID_2);\n+        pipelineRun.setOwner(TEST_STRING);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nsimilarity index 62%\nrename from api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nrename to api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nindex a75fddf65..e3b310b1f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\n", "chunk": "@@ -14,26 +14,24 @@\n  * limitations under the License.\n  */\n \n-package com.epam.pipeline.test.creator.pipeline;\n+package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public final class ClusterCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n+        pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n     }\n }\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "c3237f3d382b414f66cb99688468c0695047be92", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Added license to the PipelineCreatorUtils and other minor style fixes"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "9b550ed59ef67bd17097299e2fc79d8b456d60ef", "committedDate": "2020-11-10 14:15:55 +0300", "message": "Issue #1404: Tests for DataStorageApiService"}, {"oid": "f480ccd0e25487d598a9c602305c090f3ae0e081", "committedDate": "2020-11-10 14:16:28 +0300", "message": "Issue #1404: Tests for DataStorageApiService"}, {"oid": "45baaab480026d1161d1b7c631f07a610a1ca06d", "committedDate": "2020-11-10 14:17:12 +0300", "message": "Issue #1404: Tests refactored, merge conflicts resolved"}, {"oid": "2f13f0aa538db6b1a8146d4a759329e245e484bd", "committedDate": "2020-11-10 14:19:06 +0300", "message": "Issue #1404: And more corrections and improvements"}, {"oid": "85058f90a5183f751d68802449f7596255f07c53", "committedDate": "2020-12-08 16:11:49 +0300", "message": "Issue #1404: Implemented tests for User package acl layer (#1629)"}, {"oid": "83cd94c75bda1064b8791e8112e552881760e687", "committedDate": "2020-12-21 13:38:29 +0300", "message": "Issue #1404: Implemented tests for acl layer PipelineApiService (#1642)"}, {"oid": "e8473136642110f5366d10008796338250c9349d", "committedDate": "2020-12-21 14:38:51 +0300", "message": "Issue 1404: Implement tests for FolderApiService (#1644)"}, {"oid": "6771635b9d3703c8c3c15a4f11d538d7d3fdf2cb", "committedDate": "2020-12-28 16:45:27 +0300", "message": "Issue #1405: Implemented tests for DetachedConfigurationScheduleController (#1670)"}, {"oid": "870fb219c2268cde49fea069c47f0f96cb130b97", "committedDate": "2020-12-28 17:42:24 +0300", "message": "Issue #1404: Implemented tests for acl layer PipelineApiService"}, {"oid": "96ecee3dafd1d54a4ab86d11bc02313f3797ccd0", "committedDate": "2020-12-28 18:31:26 +0300", "message": "Issue #1405: Implemented tests for controller layer pipeline"}, {"oid": "2c1fa97606a5f1e0d625884e11dd2bdb838a9a0c", "committedDate": "2020-12-28 18:32:00 +0300", "message": "Issue #1405: Added missing tests for controller layer pipeline"}, {"oid": "d7111212b3efd91da4a35cd3225f91eb59742942", "committedDate": "2020-12-28 18:32:02 +0300", "message": "Issue #1405: changes in assertion method"}, {"oid": "e91e9b4f005016c3acf02a5243dc5987bf6b291f", "committedDate": "2020-12-28 18:32:02 +0300", "message": "Issue #1405: improvements in the assertUnwrappedResponse method"}, {"oid": "f964ea6891036be526092bb559702594007e1248", "committedDate": "2020-12-28 18:32:20 +0300", "message": "Issue #1405: branch rebased, merge conflicts resolved"}, {"oid": "ed7ab85746e49f0e3173f03ddd97f30fc0becf26", "committedDate": "2020-12-28 18:49:57 +0300", "message": "Issue #1405: refactoring in the PipelineCreatorUtils class"}, {"oid": "29d6f7c6616aa7f49a5e4310554a5f0ac8d45d61", "committedDate": "2021-02-04 16:23:21 +0300", "message": "Issue-1743. Unit tests: PipelineConfigurationManagerTest (#1747)"}, {"oid": "a32ee200726dc69f9849919bc8cc3e6c98fc227f", "committedDate": "2021-03-01 14:13:20 +0300", "message": "Issue #1752: rewritten tests with new configuration (#1778)"}, {"oid": "8b0379c4d22db189a8a162e9b48bdc65a1a8c2d8", "committedDate": "2021-03-04 15:13:07 +0300", "message": "Allow to run \"hosted\" applications: API basic implementation (#1834)"}, {"oid": "4d31038df225f8e6bb63015bc0dba432860cd7c5", "committedDate": "2021-03-05 14:49:49 +0300", "message": "Issue 1776: Unit Tests: Refactor PipelineRunManagerTest (#1793)"}, {"oid": "2e607aa737405e6b87631af05941157ae1524e78", "committedDate": "2021-03-15 17:01:13 +0300", "message": "Issue_1776_2: [Unit Tests] Refactor PipelineRunManagerTest. Part 2. (#1841)"}, {"oid": "16344d0c075c5673f4b755dbf0ac74cff07badfa", "committedDate": "2021-03-22 13:35:55 +0300", "message": "Unit tests: Rewrite RunScheduleManagerTest #1755 (#1785)"}, {"oid": "8d20bea9506f9b9409e27622126f997a023906d6", "committedDate": "2021-07-29 12:24:47 +0300", "message": "Support per run notifications (#2096)"}, {"oid": "ebdec7d0aa8aa3ff1edfcd206246606abaeefd00", "committedDate": "2021-08-03 17:00:54 +0300", "message": "Support data storage to versioned storage conversion (#2107)"}, {"oid": "29638bff544726f0137d0b4efdce624300514388", "committedDate": "2022-07-04 15:33:51 +0300", "message": "Issue 2696: Allow to specify notifications in pipeline/tool configuration (#2707)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5Nzk2NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506297964", "body": "see `PipelineCreatorUtils` comment", "bodyText": "see PipelineCreatorUtils comment", "bodyHTML": "<p dir=\"auto\">see <code>PipelineCreatorUtils</code> comment</p>", "author": "ekazachkova", "createdAt": "2020-10-16T11:04:09Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java", "diffHunk": "@@ -51,6 +53,24 @@ public static NodeInstance getDefaultNodeInstance() {\n         return new NodeInstance();\n     }\n \n+    public static NodeInstance getNodeInstanceWithPermission() {\n+        NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setId(ID);\n+        nodeInstance.setOwner(\"OWNER\");\n+        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithPermission());\n+        nodeInstance.setName(TEST_STRING);\n+        return nodeInstance;\n+    }\n+\n+    public static NodeInstance getNodeInstanceWithoutPermission() {", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..48b9586b7 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -53,20 +50,11 @@ public final class NodeCreatorUtils {\n         return new NodeInstance();\n     }\n \n-    public static NodeInstance getNodeInstanceWithPermission() {\n-        NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID);\n-        nodeInstance.setOwner(\"OWNER\");\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithPermission());\n-        nodeInstance.setName(TEST_STRING);\n-        return nodeInstance;\n-    }\n-\n-    public static NodeInstance getNodeInstanceWithoutPermission() {\n-        NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID_2);\n-        nodeInstance.setOwner(TEST_STRING);\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithoutPermission());\n+    public static NodeInstance getNodeInstance(Long id, String owner) {\n+        final NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setId(id);\n+        nodeInstance.setOwner(owner);\n+        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRun(id, owner));\n         nodeInstance.setName(TEST_STRING);\n         return nodeInstance;\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 48b9586b7..b4bab9d13 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -47,43 +69,51 @@ public final class NodeCreatorUtils {\n     }\n \n     public static NodeInstance getDefaultNodeInstance() {\n-        return new NodeInstance();\n-    }\n-\n-    public static NodeInstance getNodeInstance(Long id, String owner) {\n-        final NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(id);\n-        nodeInstance.setOwner(owner);\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRun(id, owner));\n+        final List<NodeInstanceAddress> nodeInstanceAddresses = Collections.singletonList(new NodeInstanceAddress());\n+        final Map<String, String> testMap = Collections.singletonMap(TEST_STRING, TEST_STRING);\n+        NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setClusterName(TEST_STRING);\n         nodeInstance.setName(TEST_STRING);\n+        nodeInstance.setCreationTimestamp(TEST_STRING);\n+        nodeInstance.setRegion(TEST_STRING);\n+        nodeInstance.setRunId(TEST_STRING);\n+        nodeInstance.setAddresses(nodeInstanceAddresses);\n+        nodeInstance.setAllocatable(testMap);\n+        nodeInstance.setCapacity(testMap);\n+        nodeInstance.setLabels(testMap);\n         return nodeInstance;\n     }\n \n     public static InstanceType getDefaultInstanceType() {\n-        return InstanceType.builder().name(TEST_STRING).build();\n+        return InstanceType.builder()\n+                .name(TEST_STRING)\n+                .gpu(TEST_INT)\n+                .instanceFamily(TEST_STRING)\n+                .memory(TEST_INT)\n+                .memoryUnit(TEST_STRING)\n+                .operatingSystem(TEST_STRING)\n+                .regionId(ID)\n+                .sku(TEST_STRING)\n+                .termType(TEST_STRING)\n+                .vCPU(TEST_INT)\n+                .build();\n     }\n \n     public static Node getDefaultNode() {\n         final ObjectMeta objectMeta = new ObjectMeta();\n+        objectMeta.setUid(UUID);\n         return new Node(\n                 TEST_STRING, TEST_STRING, objectMeta, new NodeSpec(), new NodeStatus());\n     }\n \n-    public static Node getEmptyNode() {\n-        return new Node();\n-    }\n-\n     public static MasterNode getDefaultMasterNode() {\n         return MasterNode.fromNode(getDefaultNode(), TEST_STRING);\n     }\n \n-    public static MasterNode getMasterNodeWithEmptyNode() {\n-        return MasterNode.fromNode(getEmptyNode(), TEST_STRING);\n-    }\n-\n     public static FilterNodesVO getDefaultFilterNodesVO() {\n         final FilterNodesVO filterNodesVO = new FilterNodesVO();\n         filterNodesVO.setAddress(TEST_STRING);\n+        filterNodesVO.setRunId(TEST_STRING);\n         return filterNodesVO;\n     }\n \n", "next_change": {"commit": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex b4bab9d13..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -106,10 +116,18 @@ public final class NodeCreatorUtils {\n                 TEST_STRING, TEST_STRING, objectMeta, new NodeSpec(), new NodeStatus());\n     }\n \n+    public static Node getEmptyNode() {\n+        return new Node();\n+    }\n+\n     public static MasterNode getDefaultMasterNode() {\n         return MasterNode.fromNode(getDefaultNode(), TEST_STRING);\n     }\n \n+    public static MasterNode getMasterNodeWithEmptyNode() {\n+        return MasterNode.fromNode(getEmptyNode(), TEST_STRING);\n+    }\n+\n     public static FilterNodesVO getDefaultFilterNodesVO() {\n         final FilterNodesVO filterNodesVO = new FilterNodesVO();\n         filterNodesVO.setAddress(TEST_STRING);\n", "next_change": null}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\nindex 2a204dc34..33906bc4d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/NodeCreatorUtils.java\n", "chunk": "@@ -50,33 +70,48 @@ public final class NodeCreatorUtils {\n     }\n \n     public static NodeInstance getDefaultNodeInstance() {\n-        return new NodeInstance();\n-    }\n-\n-    public static NodeInstance getNodeInstanceWithPermission() {\n+        final List<NodeInstanceAddress> nodeInstanceAddresses = Collections.singletonList(new NodeInstanceAddress());\n+        final Map<String, String> testMap = Collections.singletonMap(TEST_STRING, TEST_STRING);\n         NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID);\n-        nodeInstance.setOwner(\"OWNER\");\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithPermission());\n+        nodeInstance.setClusterName(TEST_STRING);\n         nodeInstance.setName(TEST_STRING);\n+        nodeInstance.setCreationTimestamp(TEST_STRING);\n+        nodeInstance.setRegion(TEST_STRING);\n+        nodeInstance.setRunId(TEST_STRING);\n+        nodeInstance.setAddresses(nodeInstanceAddresses);\n+        nodeInstance.setAllocatable(testMap);\n+        nodeInstance.setCapacity(testMap);\n+        nodeInstance.setLabels(testMap);\n         return nodeInstance;\n     }\n \n-    public static NodeInstance getNodeInstanceWithoutPermission() {\n-        NodeInstance nodeInstance = new NodeInstance();\n-        nodeInstance.setId(ID_2);\n-        nodeInstance.setOwner(TEST_STRING);\n-        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRunWithoutPermission());\n+    public static NodeInstance getNodeInstance(Long id, String owner) {\n+        final NodeInstance nodeInstance = new NodeInstance();\n+        nodeInstance.setId(id);\n+        nodeInstance.setOwner(owner);\n+        nodeInstance.setPipelineRun(PipelineCreatorUtils.getPipelineRun(id, owner));\n         nodeInstance.setName(TEST_STRING);\n         return nodeInstance;\n     }\n \n     public static InstanceType getDefaultInstanceType() {\n-        return InstanceType.builder().name(TEST_STRING).build();\n+        return InstanceType.builder()\n+                .name(TEST_STRING)\n+                .gpu(TEST_INT)\n+                .instanceFamily(TEST_STRING)\n+                .memory(TEST_INT)\n+                .memoryUnit(TEST_STRING)\n+                .operatingSystem(TEST_STRING)\n+                .regionId(ID)\n+                .sku(TEST_STRING)\n+                .termType(TEST_STRING)\n+                .vCPU(TEST_INT)\n+                .build();\n     }\n \n     public static Node getDefaultNode() {\n         final ObjectMeta objectMeta = new ObjectMeta();\n+        objectMeta.setUid(UUID);\n         return new Node(\n                 TEST_STRING, TEST_STRING, objectMeta, new NodeSpec(), new NodeStatus());\n     }\n", "next_change": null}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjI5ODgzNg==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506298836", "body": "Do not forget to make variables `final`", "bodyText": "Do not forget to make variables final", "bodyHTML": "<p dir=\"auto\">Do not forget to make variables <code>final</code></p>", "author": "ekazachkova", "createdAt": "2020-10-16T11:05:12Z", "path": "api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+\n+public final class PipelineCreatorUtils {\n+\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 4d0cface3..3ff864612 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,23 +18,14 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public class PipelineCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n-        return pipelineRun;\n-    }\n-\n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\ndeleted file mode 100644\nindex 3ff864612..000000000\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ /dev/null\n", "chunk": "@@ -1,32 +0,0 @@\n-/*\n- * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.epam.pipeline.test.creator.pipeline;\n-\n-import com.epam.pipeline.entity.pipeline.PipelineRun;\n-\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-\n-public class PipelineCreatorUtils {\n-\n-    public static PipelineRun getPipelineRun(Long id, String owner) {\n-        final PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(id);\n-        pipelineRun.setOwner(owner);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n-    }\n-}\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nnew file mode 100644\nindex 000000000..a75fddf65\n--- /dev/null\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.test.creator.pipeline;\n+\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+\n+public final class PipelineCreatorUtils {\n+\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID);\n+        pipelineRun.setOwner(\"SIMPLE_USER\");\n+        return pipelineRun;\n+    }\n+\n+    public static PipelineRun getPipelineRunWithoutPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID_2);\n+        pipelineRun.setOwner(TEST_STRING);\n+        pipelineRun.setName(TEST_STRING);\n+        return pipelineRun;\n+    }\n+}\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nsimilarity index 62%\nrename from api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nrename to api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nindex a75fddf65..e3b310b1f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\n", "chunk": "@@ -14,26 +14,24 @@\n  * limitations under the License.\n  */\n \n-package com.epam.pipeline.test.creator.pipeline;\n+package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public final class ClusterCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n+        pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n     }\n }\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 4d0cface3..9661283c2 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,23 +18,18 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n public final class PipelineCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n-        return pipelineRun;\n+    private PipelineCreatorUtils() {\n+\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nindex 9661283c2..a75fddf65 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n", "chunk": "@@ -18,18 +18,21 @@ package com.epam.pipeline.test.creator.pipeline;\n \n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n \n public final class PipelineCreatorUtils {\n \n-    private PipelineCreatorUtils() {\n-\n+    public static PipelineRun getPipelineRunWithPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID);\n+        pipelineRun.setOwner(\"SIMPLE_USER\");\n+        return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRun(Long id, String owner) {\n-        final PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(id);\n-        pipelineRun.setOwner(owner);\n+    public static PipelineRun getPipelineRunWithoutPermission() {\n+        PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(ID_2);\n+        pipelineRun.setOwner(TEST_STRING);\n         pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nsimilarity index 62%\nrename from api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\nrename to api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\nindex a75fddf65..e3b310b1f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/creator/pipeline/PipelineCreatorUtils.java\n+++ b/api/src/test/java/com/epam/pipeline/test/creator/cluster/ClusterCreatorUtils.java\n", "chunk": "@@ -14,26 +14,24 @@\n  * limitations under the License.\n  */\n \n-package com.epam.pipeline.test.creator.pipeline;\n+package com.epam.pipeline.test.creator.cluster;\n \n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.*;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n \n-public final class PipelineCreatorUtils {\n+public final class ClusterCreatorUtils {\n \n-    public static PipelineRun getPipelineRunWithPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID);\n-        pipelineRun.setOwner(\"SIMPLE_USER\");\n+    public static PipelineRun getPipelineRun(Long id, String owner) {\n+        final PipelineRun pipelineRun = new PipelineRun();\n+        pipelineRun.setId(id);\n+        pipelineRun.setOwner(owner);\n+        pipelineRun.setName(TEST_STRING);\n         return pipelineRun;\n     }\n \n-    public static PipelineRun getPipelineRunWithoutPermission() {\n-        PipelineRun pipelineRun = new PipelineRun();\n-        pipelineRun.setId(ID_2);\n-        pipelineRun.setOwner(TEST_STRING);\n-        pipelineRun.setName(TEST_STRING);\n-        return pipelineRun;\n+    public static MonitoringStats getMonitoringStats() {\n+        return new MonitoringStats();\n     }\n }\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "c3237f3d382b414f66cb99688468c0695047be92", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Added license to the PipelineCreatorUtils and other minor style fixes"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "9b550ed59ef67bd17097299e2fc79d8b456d60ef", "committedDate": "2020-11-10 14:15:55 +0300", "message": "Issue #1404: Tests for DataStorageApiService"}, {"oid": "f480ccd0e25487d598a9c602305c090f3ae0e081", "committedDate": "2020-11-10 14:16:28 +0300", "message": "Issue #1404: Tests for DataStorageApiService"}, {"oid": "45baaab480026d1161d1b7c631f07a610a1ca06d", "committedDate": "2020-11-10 14:17:12 +0300", "message": "Issue #1404: Tests refactored, merge conflicts resolved"}, {"oid": "2f13f0aa538db6b1a8146d4a759329e245e484bd", "committedDate": "2020-11-10 14:19:06 +0300", "message": "Issue #1404: And more corrections and improvements"}, {"oid": "85058f90a5183f751d68802449f7596255f07c53", "committedDate": "2020-12-08 16:11:49 +0300", "message": "Issue #1404: Implemented tests for User package acl layer (#1629)"}, {"oid": "83cd94c75bda1064b8791e8112e552881760e687", "committedDate": "2020-12-21 13:38:29 +0300", "message": "Issue #1404: Implemented tests for acl layer PipelineApiService (#1642)"}, {"oid": "e8473136642110f5366d10008796338250c9349d", "committedDate": "2020-12-21 14:38:51 +0300", "message": "Issue 1404: Implement tests for FolderApiService (#1644)"}, {"oid": "6771635b9d3703c8c3c15a4f11d538d7d3fdf2cb", "committedDate": "2020-12-28 16:45:27 +0300", "message": "Issue #1405: Implemented tests for DetachedConfigurationScheduleController (#1670)"}, {"oid": "870fb219c2268cde49fea069c47f0f96cb130b97", "committedDate": "2020-12-28 17:42:24 +0300", "message": "Issue #1404: Implemented tests for acl layer PipelineApiService"}, {"oid": "96ecee3dafd1d54a4ab86d11bc02313f3797ccd0", "committedDate": "2020-12-28 18:31:26 +0300", "message": "Issue #1405: Implemented tests for controller layer pipeline"}, {"oid": "2c1fa97606a5f1e0d625884e11dd2bdb838a9a0c", "committedDate": "2020-12-28 18:32:00 +0300", "message": "Issue #1405: Added missing tests for controller layer pipeline"}, {"oid": "d7111212b3efd91da4a35cd3225f91eb59742942", "committedDate": "2020-12-28 18:32:02 +0300", "message": "Issue #1405: changes in assertion method"}, {"oid": "e91e9b4f005016c3acf02a5243dc5987bf6b291f", "committedDate": "2020-12-28 18:32:02 +0300", "message": "Issue #1405: improvements in the assertUnwrappedResponse method"}, {"oid": "f964ea6891036be526092bb559702594007e1248", "committedDate": "2020-12-28 18:32:20 +0300", "message": "Issue #1405: branch rebased, merge conflicts resolved"}, {"oid": "ed7ab85746e49f0e3173f03ddd97f30fc0becf26", "committedDate": "2020-12-28 18:49:57 +0300", "message": "Issue #1405: refactoring in the PipelineCreatorUtils class"}, {"oid": "29d6f7c6616aa7f49a5e4310554a5f0ac8d45d61", "committedDate": "2021-02-04 16:23:21 +0300", "message": "Issue-1743. Unit tests: PipelineConfigurationManagerTest (#1747)"}, {"oid": "a32ee200726dc69f9849919bc8cc3e6c98fc227f", "committedDate": "2021-03-01 14:13:20 +0300", "message": "Issue #1752: rewritten tests with new configuration (#1778)"}, {"oid": "8b0379c4d22db189a8a162e9b48bdc65a1a8c2d8", "committedDate": "2021-03-04 15:13:07 +0300", "message": "Allow to run \"hosted\" applications: API basic implementation (#1834)"}, {"oid": "4d31038df225f8e6bb63015bc0dba432860cd7c5", "committedDate": "2021-03-05 14:49:49 +0300", "message": "Issue 1776: Unit Tests: Refactor PipelineRunManagerTest (#1793)"}, {"oid": "2e607aa737405e6b87631af05941157ae1524e78", "committedDate": "2021-03-15 17:01:13 +0300", "message": "Issue_1776_2: [Unit Tests] Refactor PipelineRunManagerTest. Part 2. (#1841)"}, {"oid": "16344d0c075c5673f4b755dbf0ac74cff07badfa", "committedDate": "2021-03-22 13:35:55 +0300", "message": "Unit tests: Rewrite RunScheduleManagerTest #1755 (#1785)"}, {"oid": "8d20bea9506f9b9409e27622126f997a023906d6", "committedDate": "2021-07-29 12:24:47 +0300", "message": "Support per run notifications (#2096)"}, {"oid": "ebdec7d0aa8aa3ff1edfcd206246606abaeefd00", "committedDate": "2021-08-03 17:00:54 +0300", "message": "Support data storage to versioned storage conversion (#2107)"}, {"oid": "29638bff544726f0137d0b4efdce624300514388", "committedDate": "2022-07-04 15:33:51 +0300", "message": "Issue 2696: Allow to specify notifications in pipeline/tool configuration (#2707)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwMTM5Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506301397", "body": "It seems this initialization is redundant.", "bodyText": "It seems this initialization is redundant.", "bodyHTML": "<p dir=\"auto\">It seems this initialization is redundant.</p>", "author": "ekazachkova", "createdAt": "2020-10-16T11:08:09Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -297,173 +243,155 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldTerminateNodeForAdmin() {\n         doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n \n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.terminateNode(nodeInstance.getName());\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnStatsForNodeForAdmin() {\n-        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n         final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnStatsWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-\n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(statsList).when(mockUsageMonitoringManager)\n                 .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnInstanceTypes() {\n         doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n \n-        final List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnToolInstanceTypes() {\n         doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n \n-        final List<InstanceType> resultInstanceTypesList = clusterApiService\n-                .getAllowedToolInstanceTypes(1L, true);\n-\n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnAllowedInstanceAndPriceTypes() {\n         final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n                 NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n         doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n                 .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n \n-        final AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n+                .isEqualTo(allowedInstanceAndPriceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnMasterNodes() {\n         final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n         doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n \n-        final List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n-\n-        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -297,173 +245,155 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldTerminateNodeForAdmin() {\n         doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n \n-        assertThat(resultNode).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.terminateNode(nodeInstance.getName());\n+        assertThrows(AccessDeniedException.class,\n+            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnStatsForNodeForAdmin() {\n-        final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n         final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnStatsWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-\n-        final List<MonitoringStats> resultStatsList =\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n \n-        assertThat(resultStatsList.size()).isEqualTo(1);\n-        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(statsList).when(mockUsageMonitoringManager)\n                 .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        assertThrows(AccessDeniedException.class,\n+            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final InputStream resultInputStream =\n-                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n \n-        assertThat(resultInputStream).isEqualTo(inputStream);\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n+    @Test\n+    @WithMockUser\n     public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager)\n-                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n-                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n-                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n \n-        final List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n-\n-        final List<InstanceType> resultInstanceTypesList = clusterApiService\n-                .getAllowedToolInstanceTypes(1L, true);\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n \n-        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnAllowedInstanceAndPriceTypes() {\n         final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n                 NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n         doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        final AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n \n-        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n+                .isEqualTo(allowedInstanceAndPriceTypes);\n     }\n \n     @Test\n+    @WithMockUser\n     public void shouldReturnMasterNodes() {\n         final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n         doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n \n-        final List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n-\n-        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMwMjIyMQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506302221", "body": "Format code please", "bodyText": "Format code please", "bodyHTML": "<p dir=\"auto\">Format code please</p>", "author": "ekazachkova", "createdAt": "2020-10-16T11:09:09Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -227,33 +176,32 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldReturnNodeInstanceForAdmin() {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n \n-       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(node).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n \n-        assertThat(node).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldDenyAccessToNode() {\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getNode(nodeInstance.getName());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -227,33 +178,32 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldReturnNodeInstanceForAdmin() {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n \n-       final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(node).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n+        mockUser();\n \n-        final NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n \n-        assertThat(node).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldDenyAccessToNode() {\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n-        clusterApiService.getNode(nodeInstance.getName());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxNDY3OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506314678", "body": "It seems for such simple and short cases we can merge these two lines: \r\n```\r\nassertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\r\n```", "bodyText": "It seems for such simple and short cases we can merge these two lines:\nassertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);", "bodyHTML": "<p dir=\"auto\">It seems for such simple and short cases we can merge these two lines:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\"><pre><code>assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n</code></pre></div>", "author": "ekazachkova", "createdAt": "2020-10-16T11:25:00Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNDQ0Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506334447", "bodyText": "Could you check it for other methods too?", "author": "ekazachkova", "createdAt": "2020-10-16T11:49:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxNDY3OA=="}], "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxNzg0NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506317844", "body": "Maybe we shell consider creating a common for `*ApiServiceTest` classes method to build a single user permissions?", "bodyText": "Maybe we shell consider creating a common for *ApiServiceTest classes method to build a single user permissions?", "bodyHTML": "<p dir=\"auto\">Maybe we shell consider creating a common for <code>*ApiServiceTest</code> classes method to build a single user permissions?</p>", "author": "ekazachkova", "createdAt": "2020-10-16T11:28:59Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTI4Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506321282", "body": "Looks like this initialization is redundant", "bodyText": "Looks like this initialization is redundant", "bodyHTML": "<p dir=\"auto\">Looks like this initialization is redundant</p>", "author": "ekazachkova", "createdAt": "2020-10-16T11:33:33Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMjE4MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506332181", "bodyText": "Could you check it for other methods too?", "author": "ekazachkova", "createdAt": "2020-10-16T11:47:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMTI4Mg=="}], "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +93,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,128 +95,82 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n-\n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes.size()).isEqualTo(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        final List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n \n-        assertThat(nodes).isEmpty();\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n     }\n \n     @Test\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0NjQyMw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r506346423", "body": "Maybe we shell add `@AclMask` tests? (for merging entity permissions with parent permissions)\r\n\r\nP.S.: see `AclAspect`", "bodyText": "Maybe we shell add @AclMask tests? (for merging entity permissions with parent permissions)\nP.S.: see AclAspect", "bodyHTML": "<p dir=\"auto\">Maybe we shell add <code>@AclMask</code> tests? (for merging entity permissions with parent permissions)</p>\n<p dir=\"auto\">P.S.: see <code>AclAspect</code></p>", "author": "ekazachkova", "createdAt": "2020-10-16T12:05:21Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,508 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {", "originalCommit": "b7eb321af6111982b798187dffbf70bd809998d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -24,35 +24,34 @@ import com.epam.pipeline.entity.cluster.MasterNode;\n import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n-import com.epam.pipeline.entity.contextual.ContextualPreference;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n-import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.preference.SystemPreferences;\n import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,62 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": null}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -60,19 +59,18 @@ import static org.mockito.Mockito.doReturn;\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,62 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": null}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -24,35 +24,36 @@ import com.epam.pipeline.entity.cluster.MasterNode;\n import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n-import com.epam.pipeline.entity.contextual.ContextualPreference;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n-import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.preference.SystemPreferences;\n import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.contextual.ContextualPreferenceCreatorUtils;\n import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,64 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -78,9 +81,6 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private NodesManager mockNodesManager;\n \n-    @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n     @Autowired\n     private AuthManager mockAuthManager;\n \n", "next_change": null}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex fa90c8599..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -60,19 +61,18 @@ import static org.mockito.Mockito.doReturn;\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,64 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -78,9 +81,6 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private NodesManager mockNodesManager;\n \n-    @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n     @Autowired\n     private AuthManager mockAuthManager;\n \n", "next_change": null}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExNjI3Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509116272", "body": "Could you please check if all of the changes in this class are relevant to the pull request? It seems that mocks like `PipelineDao` have nothing to do with acl tests.", "bodyText": "Could you please check if all of the changes in this class are relevant to the pull request? It seems that mocks like PipelineDao have nothing to do with acl tests.", "bodyHTML": "<p dir=\"auto\">Could you please check if all of the changes in this class are relevant to the pull request? It seems that mocks like <code>PipelineDao</code> have nothing to do with acl tests.</p>", "author": "tcibinan", "createdAt": "2020-10-21T09:09:11Z", "path": "api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java", "diffHunk": "@@ -17,47 +17,79 @@\n package com.epam.pipeline.test.acl;", "originalCommit": "4a5f096dcc4809e99c88158e87803b53a477beba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex cd22c3003..7a768a694 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -17,22 +17,8 @@\n package com.epam.pipeline.test.acl;\n \n import com.epam.pipeline.common.MessageHelper;\n-import com.epam.pipeline.dao.contextual.ContextualPreferenceDao;\n import com.epam.pipeline.dao.datastorage.DataStorageDao;\n-import com.epam.pipeline.dao.datastorage.rules.DataStorageRuleDao;\n-import com.epam.pipeline.dao.notification.MonitoringNotificationDao;\n import com.epam.pipeline.dao.pipeline.FolderDao;\n-import com.epam.pipeline.dao.pipeline.PipelineDao;\n-import com.epam.pipeline.dao.pipeline.PipelineRunDao;\n-import com.epam.pipeline.dao.pipeline.RestartRunDao;\n-import com.epam.pipeline.dao.pipeline.RunLogDao;\n-import com.epam.pipeline.dao.pipeline.RunStatusDao;\n-import com.epam.pipeline.dao.pipeline.StopServerlessRunDao;\n-import com.epam.pipeline.dao.user.GroupStatusDao;\n-import com.epam.pipeline.dao.user.RoleDao;\n-import com.epam.pipeline.dao.user.UserDao;\n-import com.epam.pipeline.entity.log.LogPagination;\n-import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7a768a694..161335e58 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -17,8 +17,22 @@\n package com.epam.pipeline.test.acl;\n \n import com.epam.pipeline.common.MessageHelper;\n+import com.epam.pipeline.dao.contextual.ContextualPreferenceDao;\n import com.epam.pipeline.dao.datastorage.DataStorageDao;\n+import com.epam.pipeline.dao.datastorage.rules.DataStorageRuleDao;\n+import com.epam.pipeline.dao.notification.MonitoringNotificationDao;\n import com.epam.pipeline.dao.pipeline.FolderDao;\n+import com.epam.pipeline.dao.pipeline.PipelineDao;\n+import com.epam.pipeline.dao.pipeline.PipelineRunDao;\n+import com.epam.pipeline.dao.pipeline.RestartRunDao;\n+import com.epam.pipeline.dao.pipeline.RunLogDao;\n+import com.epam.pipeline.dao.pipeline.RunStatusDao;\n+import com.epam.pipeline.dao.pipeline.StopServerlessRunDao;\n+import com.epam.pipeline.dao.user.GroupStatusDao;\n+import com.epam.pipeline.dao.user.RoleDao;\n+import com.epam.pipeline.dao.user.UserDao;\n+import com.epam.pipeline.entity.log.LogPagination;\n+import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 161335e58..b5b545138 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -17,22 +17,8 @@\n package com.epam.pipeline.test.acl;\n \n import com.epam.pipeline.common.MessageHelper;\n-import com.epam.pipeline.dao.contextual.ContextualPreferenceDao;\n import com.epam.pipeline.dao.datastorage.DataStorageDao;\n-import com.epam.pipeline.dao.datastorage.rules.DataStorageRuleDao;\n-import com.epam.pipeline.dao.notification.MonitoringNotificationDao;\n import com.epam.pipeline.dao.pipeline.FolderDao;\n-import com.epam.pipeline.dao.pipeline.PipelineDao;\n-import com.epam.pipeline.dao.pipeline.PipelineRunDao;\n-import com.epam.pipeline.dao.pipeline.RestartRunDao;\n-import com.epam.pipeline.dao.pipeline.RunLogDao;\n-import com.epam.pipeline.dao.pipeline.RunStatusDao;\n-import com.epam.pipeline.dao.pipeline.StopServerlessRunDao;\n-import com.epam.pipeline.dao.user.GroupStatusDao;\n-import com.epam.pipeline.dao.user.RoleDao;\n-import com.epam.pipeline.dao.user.UserDao;\n-import com.epam.pipeline.entity.log.LogPagination;\n-import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n", "next_change": null}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex cd22c3003..7a768a694 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -17,22 +17,8 @@\n package com.epam.pipeline.test.acl;\n \n import com.epam.pipeline.common.MessageHelper;\n-import com.epam.pipeline.dao.contextual.ContextualPreferenceDao;\n import com.epam.pipeline.dao.datastorage.DataStorageDao;\n-import com.epam.pipeline.dao.datastorage.rules.DataStorageRuleDao;\n-import com.epam.pipeline.dao.notification.MonitoringNotificationDao;\n import com.epam.pipeline.dao.pipeline.FolderDao;\n-import com.epam.pipeline.dao.pipeline.PipelineDao;\n-import com.epam.pipeline.dao.pipeline.PipelineRunDao;\n-import com.epam.pipeline.dao.pipeline.RestartRunDao;\n-import com.epam.pipeline.dao.pipeline.RunLogDao;\n-import com.epam.pipeline.dao.pipeline.RunStatusDao;\n-import com.epam.pipeline.dao.pipeline.StopServerlessRunDao;\n-import com.epam.pipeline.dao.user.GroupStatusDao;\n-import com.epam.pipeline.dao.user.RoleDao;\n-import com.epam.pipeline.dao.user.UserDao;\n-import com.epam.pipeline.entity.log.LogPagination;\n-import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n", "next_change": {"commit": "0a70791f4f8fd2f6cbef4627e13bfc4c77429c53", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7a768a694..8628a2466 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -17,8 +17,22 @@\n package com.epam.pipeline.test.acl;\n \n import com.epam.pipeline.common.MessageHelper;\n+import com.epam.pipeline.dao.contextual.ContextualPreferenceDao;\n import com.epam.pipeline.dao.datastorage.DataStorageDao;\n+import com.epam.pipeline.dao.datastorage.rules.DataStorageRuleDao;\n+import com.epam.pipeline.dao.notification.MonitoringNotificationDao;\n import com.epam.pipeline.dao.pipeline.FolderDao;\n+import com.epam.pipeline.dao.pipeline.PipelineDao;\n+import com.epam.pipeline.dao.pipeline.PipelineRunDao;\n+import com.epam.pipeline.dao.pipeline.RestartRunDao;\n+import com.epam.pipeline.dao.pipeline.RunLogDao;\n+import com.epam.pipeline.dao.pipeline.RunStatusDao;\n+import com.epam.pipeline.dao.pipeline.StopServerlessRunDao;\n+import com.epam.pipeline.dao.user.GroupStatusDao;\n+import com.epam.pipeline.dao.user.RoleDao;\n+import com.epam.pipeline.dao.user.UserDao;\n+import com.epam.pipeline.entity.log.LogPagination;\n+import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n", "next_change": {"commit": "45baaab480026d1161d1b7c631f07a610a1ca06d", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 8628a2466..bd2005181 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -36,6 +36,7 @@ import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n+import com.epam.pipeline.manager.cloud.TemporaryCredentialsManager;\n import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n", "next_change": {"commit": "0792887fca4762214a1e7554a3efecff5a51b415", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex bd2005181..ddbf59705 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -36,7 +36,6 @@ import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n-import com.epam.pipeline.manager.cloud.TemporaryCredentialsManager;\n import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n", "next_change": {"commit": "ebf3fb70fa5862e6e97951f25ac9a8f56015ebd5", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex ddbf59705..7b764d216 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -36,6 +36,7 @@ import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n+import com.epam.pipeline.manager.cloud.TemporaryCredentialsManager;\n import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n", "next_change": {"commit": "f8a105c83b6779b171187b79c9ee8ed188f9ee4e", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7b764d216..790fa2192 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -41,6 +41,8 @@ import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.cluster.pool.NodeScheduleManager;\n+import com.epam.pipeline.manager.cluster.pool.NodePoolManager;\n import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n", "next_change": {"commit": "f1b246f5d0ed3e4cfdbf2523ca4909bd0503cc91", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 790fa2192..fb7aaa5ba 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -41,8 +41,8 @@ import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n-import com.epam.pipeline.manager.cluster.pool.NodeScheduleManager;\n import com.epam.pipeline.manager.cluster.pool.NodePoolManager;\n+import com.epam.pipeline.manager.cluster.pool.NodeScheduleManager;\n import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n", "next_change": {"commit": "099bf771df247dcbe2f19e8769b58abcc2eda51c", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex fb7aaa5ba..51aa9762d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -31,17 +32,20 @@ import com.epam.pipeline.dao.pipeline.StopServerlessRunDao;\n import com.epam.pipeline.dao.user.GroupStatusDao;\n import com.epam.pipeline.dao.user.RoleDao;\n import com.epam.pipeline.dao.user.UserDao;\n-import com.epam.pipeline.entity.log.LogPagination;\n-import com.epam.pipeline.entity.pipeline.Pipeline;\n import com.epam.pipeline.manager.EntityManager;\n import com.epam.pipeline.manager.HierarchicalEntityManager;\n import com.epam.pipeline.manager.billing.BillingManager;\n import com.epam.pipeline.manager.cloud.TemporaryCredentialsManager;\n+import com.epam.pipeline.manager.cloud.credentials.CloudProfileCredentialsManagerProvider;\n+import com.epam.pipeline.manager.cluster.EdgeServiceManager;\n+import com.epam.pipeline.manager.cluster.InfrastructureManager;\n import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NatGatewayManager;\n import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.cluster.pool.NodePoolManager;\n+import com.epam.pipeline.manager.cluster.pool.NodePoolUsageService;\n import com.epam.pipeline.manager.cluster.pool.NodeScheduleManager;\n import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n", "next_change": null}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex ddbf59705..7b764d216 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -44,12 +45,12 @@ import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.contextual.handler.ContextualPreferenceHandler;\n-import com.epam.pipeline.manager.datastorage.DataStorageApiService;\n import com.epam.pipeline.manager.datastorage.DataStorageManager;\n import com.epam.pipeline.manager.datastorage.DataStoragePathLoader;\n import com.epam.pipeline.manager.datastorage.DataStorageRuleManager;\n import com.epam.pipeline.manager.datastorage.DataStorageValidator;\n import com.epam.pipeline.manager.datastorage.FileShareMountManager;\n+import com.epam.pipeline.manager.datastorage.RunMountService;\n import com.epam.pipeline.manager.datastorage.StorageProviderManager;\n import com.epam.pipeline.manager.datastorage.lustre.LustreFSManager;\n import com.epam.pipeline.manager.docker.DockerContainerOperationManager;\n", "next_change": {"commit": "d2bde616ffe4def26a333c0bfe20730ec7547212", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7b764d216..a2b2a11ae 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -58,6 +60,7 @@ import com.epam.pipeline.manager.docker.DockerRegistryManager;\n import com.epam.pipeline.manager.docker.ToolVersionManager;\n import com.epam.pipeline.manager.docker.scan.ToolScanManager;\n import com.epam.pipeline.manager.docker.scan.ToolScanScheduler;\n+import com.epam.pipeline.manager.dts.DtsListingManager;\n import com.epam.pipeline.manager.dts.DtsRegistryManager;\n import com.epam.pipeline.manager.dts.DtsSubmissionManager;\n import com.epam.pipeline.manager.event.EntityEventServiceManager;\n", "next_change": {"commit": "1aab8c35fdfdc59a93df88726a5c3aa7340fc4c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex a2b2a11ae..907edf33f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -69,10 +71,11 @@ import com.epam.pipeline.manager.execution.PipelineLauncher;\n import com.epam.pipeline.manager.filter.FilterManager;\n import com.epam.pipeline.manager.firecloud.FirecloudManager;\n import com.epam.pipeline.manager.git.GitManager;\n-import com.epam.pipeline.manager.git.TemplatesScanner;\n import com.epam.pipeline.manager.google.CredentialsManager;\n import com.epam.pipeline.manager.issue.IssueManager;\n import com.epam.pipeline.manager.log.LogManager;\n+import com.epam.pipeline.manager.metadata.CategoricalAttributeManager;\n+import com.epam.pipeline.manager.metadata.MetadataDownloadManager;\n import com.epam.pipeline.manager.metadata.MetadataEntityManager;\n import com.epam.pipeline.manager.metadata.MetadataManager;\n import com.epam.pipeline.manager.metadata.MetadataUploadManager;\n", "next_change": {"commit": "b557b589e0f6977e16429e6ceee53f16ebe0f654", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 907edf33f..263c60f1a 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -84,16 +95,20 @@ import com.epam.pipeline.manager.notification.NotificationManager;\n import com.epam.pipeline.manager.notification.NotificationSettingsManager;\n import com.epam.pipeline.manager.notification.NotificationTemplateManager;\n import com.epam.pipeline.manager.notification.SystemNotificationManager;\n+import com.epam.pipeline.manager.notification.UserNotificationManager;\n import com.epam.pipeline.manager.ontology.OntologyManager;\n import com.epam.pipeline.manager.pipeline.DocumentGenerationPropertyManager;\n import com.epam.pipeline.manager.pipeline.FolderCrudManager;\n import com.epam.pipeline.manager.pipeline.FolderManager;\n+import com.epam.pipeline.manager.pipeline.FolderTemplateManager;\n import com.epam.pipeline.manager.pipeline.ParameterMapper;\n import com.epam.pipeline.manager.pipeline.PipelineConfigurationManager;\n import com.epam.pipeline.manager.pipeline.PipelineFileGenerationManager;\n import com.epam.pipeline.manager.pipeline.PipelineManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunAsManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunCRUDService;\n import com.epam.pipeline.manager.pipeline.PipelineRunDockerOperationManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunKubernetesManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.pipeline.PipelineVersionManager;\n import com.epam.pipeline.manager.pipeline.RestartRunManager;\n", "next_change": null}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex bd2005181..ddbf59705 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -45,12 +44,12 @@ import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.contextual.handler.ContextualPreferenceHandler;\n+import com.epam.pipeline.manager.datastorage.DataStorageApiService;\n import com.epam.pipeline.manager.datastorage.DataStorageManager;\n import com.epam.pipeline.manager.datastorage.DataStoragePathLoader;\n import com.epam.pipeline.manager.datastorage.DataStorageRuleManager;\n import com.epam.pipeline.manager.datastorage.DataStorageValidator;\n import com.epam.pipeline.manager.datastorage.FileShareMountManager;\n-import com.epam.pipeline.manager.datastorage.RunMountService;\n import com.epam.pipeline.manager.datastorage.StorageProviderManager;\n import com.epam.pipeline.manager.datastorage.lustre.LustreFSManager;\n import com.epam.pipeline.manager.docker.DockerContainerOperationManager;\n", "next_change": {"commit": "ebf3fb70fa5862e6e97951f25ac9a8f56015ebd5", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex ddbf59705..7b764d216 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -44,12 +45,12 @@ import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.contextual.handler.ContextualPreferenceHandler;\n-import com.epam.pipeline.manager.datastorage.DataStorageApiService;\n import com.epam.pipeline.manager.datastorage.DataStorageManager;\n import com.epam.pipeline.manager.datastorage.DataStoragePathLoader;\n import com.epam.pipeline.manager.datastorage.DataStorageRuleManager;\n import com.epam.pipeline.manager.datastorage.DataStorageValidator;\n import com.epam.pipeline.manager.datastorage.FileShareMountManager;\n+import com.epam.pipeline.manager.datastorage.RunMountService;\n import com.epam.pipeline.manager.datastorage.StorageProviderManager;\n import com.epam.pipeline.manager.datastorage.lustre.LustreFSManager;\n import com.epam.pipeline.manager.docker.DockerContainerOperationManager;\n", "next_change": {"commit": "d2bde616ffe4def26a333c0bfe20730ec7547212", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7b764d216..a2b2a11ae 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -58,6 +60,7 @@ import com.epam.pipeline.manager.docker.DockerRegistryManager;\n import com.epam.pipeline.manager.docker.ToolVersionManager;\n import com.epam.pipeline.manager.docker.scan.ToolScanManager;\n import com.epam.pipeline.manager.docker.scan.ToolScanScheduler;\n+import com.epam.pipeline.manager.dts.DtsListingManager;\n import com.epam.pipeline.manager.dts.DtsRegistryManager;\n import com.epam.pipeline.manager.dts.DtsSubmissionManager;\n import com.epam.pipeline.manager.event.EntityEventServiceManager;\n", "next_change": {"commit": "1aab8c35fdfdc59a93df88726a5c3aa7340fc4c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex a2b2a11ae..907edf33f 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -69,10 +71,11 @@ import com.epam.pipeline.manager.execution.PipelineLauncher;\n import com.epam.pipeline.manager.filter.FilterManager;\n import com.epam.pipeline.manager.firecloud.FirecloudManager;\n import com.epam.pipeline.manager.git.GitManager;\n-import com.epam.pipeline.manager.git.TemplatesScanner;\n import com.epam.pipeline.manager.google.CredentialsManager;\n import com.epam.pipeline.manager.issue.IssueManager;\n import com.epam.pipeline.manager.log.LogManager;\n+import com.epam.pipeline.manager.metadata.CategoricalAttributeManager;\n+import com.epam.pipeline.manager.metadata.MetadataDownloadManager;\n import com.epam.pipeline.manager.metadata.MetadataEntityManager;\n import com.epam.pipeline.manager.metadata.MetadataManager;\n import com.epam.pipeline.manager.metadata.MetadataUploadManager;\n", "next_change": {"commit": "b557b589e0f6977e16429e6ceee53f16ebe0f654", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 907edf33f..263c60f1a 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -84,16 +95,20 @@ import com.epam.pipeline.manager.notification.NotificationManager;\n import com.epam.pipeline.manager.notification.NotificationSettingsManager;\n import com.epam.pipeline.manager.notification.NotificationTemplateManager;\n import com.epam.pipeline.manager.notification.SystemNotificationManager;\n+import com.epam.pipeline.manager.notification.UserNotificationManager;\n import com.epam.pipeline.manager.ontology.OntologyManager;\n import com.epam.pipeline.manager.pipeline.DocumentGenerationPropertyManager;\n import com.epam.pipeline.manager.pipeline.FolderCrudManager;\n import com.epam.pipeline.manager.pipeline.FolderManager;\n+import com.epam.pipeline.manager.pipeline.FolderTemplateManager;\n import com.epam.pipeline.manager.pipeline.ParameterMapper;\n import com.epam.pipeline.manager.pipeline.PipelineConfigurationManager;\n import com.epam.pipeline.manager.pipeline.PipelineFileGenerationManager;\n import com.epam.pipeline.manager.pipeline.PipelineManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunAsManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunCRUDService;\n import com.epam.pipeline.manager.pipeline.PipelineRunDockerOperationManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunKubernetesManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.pipeline.PipelineVersionManager;\n import com.epam.pipeline.manager.pipeline.RestartRunManager;\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7a768a694..8628a2466 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -27,32 +41,57 @@ import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.configuration.RunConfigurationManager;\n+import com.epam.pipeline.manager.configuration.ServerlessConfigurationManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n+import com.epam.pipeline.manager.contextual.handler.ContextualPreferenceHandler;\n+import com.epam.pipeline.manager.datastorage.DataStorageApiService;\n import com.epam.pipeline.manager.datastorage.DataStorageManager;\n import com.epam.pipeline.manager.datastorage.DataStoragePathLoader;\n+import com.epam.pipeline.manager.datastorage.DataStorageRuleManager;\n+import com.epam.pipeline.manager.datastorage.DataStorageValidator;\n import com.epam.pipeline.manager.datastorage.FileShareMountManager;\n import com.epam.pipeline.manager.datastorage.StorageProviderManager;\n-import com.epam.pipeline.manager.datastorage.lustre.LustreFSManager;\n+import com.epam.pipeline.manager.docker.DockerContainerOperationManager;\n import com.epam.pipeline.manager.docker.DockerRegistryManager;\n+import com.epam.pipeline.manager.docker.ToolVersionManager;\n+import com.epam.pipeline.manager.docker.scan.ToolScanManager;\n import com.epam.pipeline.manager.docker.scan.ToolScanScheduler;\n+import com.epam.pipeline.manager.dts.DtsRegistryManager;\n+import com.epam.pipeline.manager.dts.DtsSubmissionManager;\n import com.epam.pipeline.manager.event.EntityEventServiceManager;\n+import com.epam.pipeline.manager.execution.CommandBuilder;\n+import com.epam.pipeline.manager.execution.PipelineLauncher;\n import com.epam.pipeline.manager.filter.FilterManager;\n+import com.epam.pipeline.manager.firecloud.FirecloudManager;\n import com.epam.pipeline.manager.git.GitManager;\n import com.epam.pipeline.manager.git.TemplatesScanner;\n+import com.epam.pipeline.manager.google.CredentialsManager;\n import com.epam.pipeline.manager.issue.IssueManager;\n import com.epam.pipeline.manager.log.LogManager;\n import com.epam.pipeline.manager.metadata.MetadataEntityManager;\n import com.epam.pipeline.manager.metadata.MetadataManager;\n+import com.epam.pipeline.manager.metadata.MetadataUploadManager;\n import com.epam.pipeline.manager.metadata.processor.MetadataPostProcessorService;\n+import com.epam.pipeline.manager.notification.NotificationManager;\n+import com.epam.pipeline.manager.notification.NotificationSettingsManager;\n+import com.epam.pipeline.manager.notification.NotificationTemplateManager;\n+import com.epam.pipeline.manager.notification.SystemNotificationManager;\n import com.epam.pipeline.manager.pipeline.DocumentGenerationPropertyManager;\n+import com.epam.pipeline.manager.pipeline.FolderApiService;\n import com.epam.pipeline.manager.pipeline.FolderCrudManager;\n import com.epam.pipeline.manager.pipeline.FolderManager;\n+import com.epam.pipeline.manager.pipeline.ParameterMapper;\n+import com.epam.pipeline.manager.pipeline.PipelineConfigurationManager;\n import com.epam.pipeline.manager.pipeline.PipelineFileGenerationManager;\n import com.epam.pipeline.manager.pipeline.PipelineManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunCRUDService;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.pipeline.PipelineVersionManager;\n+import com.epam.pipeline.manager.pipeline.RestartRunManager;\n import com.epam.pipeline.manager.pipeline.RunLogManager;\n import com.epam.pipeline.manager.pipeline.RunScheduleManager;\n+import com.epam.pipeline.manager.pipeline.RunStatusManager;\n+import com.epam.pipeline.manager.pipeline.StopServerlessRunManager;\n import com.epam.pipeline.manager.pipeline.ToolApiService;\n import com.epam.pipeline.manager.pipeline.ToolGroupManager;\n import com.epam.pipeline.manager.pipeline.ToolManager;\n", "next_change": {"commit": "299df64bae5fedba84102bbed96bfa169795b0cc", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 8628a2466..7548d13b3 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -92,7 +95,7 @@ import com.epam.pipeline.manager.pipeline.RunLogManager;\n import com.epam.pipeline.manager.pipeline.RunScheduleManager;\n import com.epam.pipeline.manager.pipeline.RunStatusManager;\n import com.epam.pipeline.manager.pipeline.StopServerlessRunManager;\n-import com.epam.pipeline.manager.pipeline.ToolApiService;\n+import com.epam.pipeline.acl.docker.ToolApiService;\n import com.epam.pipeline.manager.pipeline.ToolGroupManager;\n import com.epam.pipeline.manager.pipeline.ToolManager;\n import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n", "next_change": {"commit": "da987e2b7ffc2779ca80db55375582980c8dfb4e", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 7548d13b3..565bcf280 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -95,7 +95,6 @@ import com.epam.pipeline.manager.pipeline.RunLogManager;\n import com.epam.pipeline.manager.pipeline.RunScheduleManager;\n import com.epam.pipeline.manager.pipeline.RunStatusManager;\n import com.epam.pipeline.manager.pipeline.StopServerlessRunManager;\n-import com.epam.pipeline.acl.docker.ToolApiService;\n import com.epam.pipeline.manager.pipeline.ToolGroupManager;\n import com.epam.pipeline.manager.pipeline.ToolManager;\n import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n", "next_change": {"commit": "cd58a01c651f4d006715b134022978f0df337b9f", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 565bcf280..657ccf360 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -97,6 +103,7 @@ import com.epam.pipeline.manager.pipeline.RunStatusManager;\n import com.epam.pipeline.manager.pipeline.StopServerlessRunManager;\n import com.epam.pipeline.manager.pipeline.ToolGroupManager;\n import com.epam.pipeline.manager.pipeline.ToolManager;\n+import com.epam.pipeline.manager.pipeline.ToolScanInfoManager;\n import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n import com.epam.pipeline.manager.pipeline.runner.ConfigurationRunner;\n import com.epam.pipeline.manager.preference.PreferenceManager;\n", "next_change": {"commit": "3b66da04b457e0022cce3b78134bd9749a4b20ea", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 657ccf360..0e8d9e421 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -107,6 +117,7 @@ import com.epam.pipeline.manager.pipeline.ToolScanInfoManager;\n import com.epam.pipeline.manager.pipeline.runner.ConfigurationProviderManager;\n import com.epam.pipeline.manager.pipeline.runner.ConfigurationRunner;\n import com.epam.pipeline.manager.preference.PreferenceManager;\n+import com.epam.pipeline.manager.quota.QuotaService;\n import com.epam.pipeline.manager.region.CloudRegionManager;\n import com.epam.pipeline.manager.search.SearchManager;\n import com.epam.pipeline.manager.security.AuthManager;\n", "next_change": {"commit": "e76217d4af2581b0def66319b80ffa30b1982f0f", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\nindex 0e8d9e421..2f2e9a169 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AclTestBeans.java\n", "chunk": "@@ -119,10 +119,12 @@ import com.epam.pipeline.manager.pipeline.runner.ConfigurationRunner;\n import com.epam.pipeline.manager.preference.PreferenceManager;\n import com.epam.pipeline.manager.quota.QuotaService;\n import com.epam.pipeline.manager.region.CloudRegionManager;\n+import com.epam.pipeline.manager.report.UsersUsageReportService;\n import com.epam.pipeline.manager.search.SearchManager;\n import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.manager.security.GrantPermissionManager;\n import com.epam.pipeline.manager.security.PermissionsService;\n+import com.epam.pipeline.manager.user.OnlineUsersService;\n import com.epam.pipeline.manager.user.RoleManager;\n import com.epam.pipeline.manager.user.UserManager;\n import com.epam.pipeline.manager.user.UserRunnersManager;\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "0a70791f4f8fd2f6cbef4627e13bfc4c77429c53", "committedDate": "2020-10-27 17:54:14 +0300", "message": "Issue #1404: Unfinished tests for ConfigurationApiServices"}, {"oid": "4d1fa075892843422db2a569cb0baa957196c035", "committedDate": "2020-10-27 17:54:58 +0300", "message": "Issue #1404: Implemented tests for Configuration Api Services"}, {"oid": "663b6c2bf347e30b453f2d64e739bb31d49adeba", "committedDate": "2020-10-27 17:56:14 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "df6b911b920bcf86b1194acca20da5113707fb1f", "committedDate": "2020-10-27 17:57:15 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "45baaab480026d1161d1b7c631f07a610a1ca06d", "committedDate": "2020-11-10 14:17:12 +0300", "message": "Issue #1404: Tests refactored, merge conflicts resolved"}, {"oid": "0792887fca4762214a1e7554a3efecff5a51b415", "committedDate": "2020-11-12 12:57:20 +0300", "message": "Issue #1535: API shall restore pause/resume operations if it was rebooted"}, {"oid": "ebf3fb70fa5862e6e97951f25ac9a8f56015ebd5", "committedDate": "2020-11-16 17:58:25 +0300", "message": "Merge remote-tracking branch 'origin/develop' into issue_1535_continue_pause_resume_after_reboot"}, {"oid": "299df64bae5fedba84102bbed96bfa169795b0cc", "committedDate": "2020-11-18 10:05:27 +0300", "message": "Issue #1404: ToolApiServiceTest created"}, {"oid": "da987e2b7ffc2779ca80db55375582980c8dfb4e", "committedDate": "2020-11-18 10:05:36 +0300", "message": "Issue #1404: Implemented tests for ToolApiService"}, {"oid": "f8a105c83b6779b171187b79c9ee8ed188f9ee4e", "committedDate": "2020-11-26 17:53:46 +0300", "message": "Node Pool Management (#1609)"}, {"oid": "d2bde616ffe4def26a333c0bfe20730ec7547212", "committedDate": "2020-12-07 18:40:54 +0300", "message": "Issue #1404: Implemented tests for Dts package acl layer (#1587)"}, {"oid": "f1b246f5d0ed3e4cfdbf2523ca4909bd0503cc91", "committedDate": "2020-12-08 15:18:49 +0300", "message": "Issue #1404: Implemented tests for Metadata package acl layer (#1612)"}, {"oid": "c2e25eebf7dc03940471119bb731a6d092a2e49d", "committedDate": "2020-12-10 14:23:31 +0300", "message": "Issue #1404: Implemented tests for AclPermissionApiService (#1618)"}, {"oid": "e8473136642110f5366d10008796338250c9349d", "committedDate": "2020-12-21 14:38:51 +0300", "message": "Issue 1404: Implement tests for FolderApiService (#1644)"}, {"oid": "a20e9220c318621438ad62e3c6a1cdf21e9d8be3", "committedDate": "2020-12-21 20:16:51 +0300", "message": "`pipe` shall allow to import users from CSV (#1667)"}, {"oid": "d7a0194ab4fa38dad4bb977ff95d121bcf29ecde", "committedDate": "2020-12-23 20:51:12 +0300", "message": "Issue 1615 Route53 integration to be able to create custom dns records for the tools (#1624)"}, {"oid": "5a287c8a8c50f3bf2f65fba926dab98fb6de38df", "committedDate": "2021-01-28 16:36:28 +0300", "message": "Ontology support for the System Dictionaries (#1630)"}, {"oid": "de95b8a8eb0a69b47c76b97e4aa759e65ef832fe", "committedDate": "2021-01-29 14:38:23 +0300", "message": "Seamless authentication in AWS (#1765)"}, {"oid": "1aab8c35fdfdc59a93df88726a5c3aa7340fc4c8", "committedDate": "2021-02-08 16:06:42 +0300", "message": "Issue #1688: Rewrite HierarchicalEntityManager tests (#1702)"}, {"oid": "76bf1e4e1a300bf3c99831ea290eeb67134816ca", "committedDate": "2021-02-08 17:40:49 +0300", "message": "Remove unused mock bean"}, {"oid": "8a43d73f20ed44f9de2dd42dc68e2568eeae7f3c", "committedDate": "2021-02-08 19:11:12 +0300", "message": "Remove unnecessary mocks"}, {"oid": "c88710d9137be68aa34f305895beb3391863bff8", "committedDate": "2021-02-09 16:17:24 +0300", "message": "Issue-1735: Unit tests: Rewrite FolderTemplateManagerTest. (#1742)"}, {"oid": "cd58a01c651f4d006715b134022978f0df337b9f", "committedDate": "2021-02-18 22:51:45 +0300", "message": "New optimized method `/tool/{toolId}/info` to get aggregated vulnerability data (#1820)"}, {"oid": "7ce0509a04ef1d6c78ecffc99445788c926372ea", "committedDate": "2021-03-01 13:02:14 +0300", "message": "Issue 1754. Unit tests: Rewrite DockerRegistryNotificationTest (#1772)"}, {"oid": "8b0379c4d22db189a8a162e9b48bdc65a1a8c2d8", "committedDate": "2021-03-04 15:13:07 +0300", "message": "Allow to run \"hosted\" applications: API basic implementation (#1834)"}, {"oid": "99331b2e439fce5a1469051e05ad1586829dcbe7", "committedDate": "2021-03-23 20:54:19 +0300", "message": "Implement data storage object tags management (#1798)"}, {"oid": "7b4caa0e27e7c7cf711fe4bf77dae95accd5ebfa", "committedDate": "2021-03-24 16:57:17 +0300", "message": "Improve data storage object tags management (#1873)"}, {"oid": "6ee23a663b1112632492ab85909b87bd801269e3", "committedDate": "2021-05-14 12:38:21 +0300", "message": "Allow general users to run a job on behalf of the other account (#1961)"}, {"oid": "6883eb217f0ecf5c6385dfb69c4df4fb3c80cfb5", "committedDate": "2021-05-14 19:07:45 +0300", "message": "Allow to force \"run as\" and \"sharing\" options for the pipelines (#1962)"}, {"oid": "938d599a1a7d67f78ba89903ecb39ac753d52cae", "committedDate": "2021-07-12 15:48:27 +0300", "message": "Issue #1715: Multizone jobs and data access - API part (WIP) (#2019)"}, {"oid": "ebdec7d0aa8aa3ff1edfcd206246606abaeefd00", "committedDate": "2021-08-03 17:00:54 +0300", "message": "Support data storage to versioned storage conversion (#2107)"}, {"oid": "edc614e15039685d140921b1dfba3080f76c1ae5", "committedDate": "2021-11-05 23:28:03 +0300", "message": "Issue 2232 NAT gateway kube configuration (#2281)"}, {"oid": "3b66da04b457e0022cce3b78134bd9749a4b20ea", "committedDate": "2021-12-15 16:22:14 +0300", "message": "Cloud Pipeline shall allow users to configure spending quotas (#2401)"}, {"oid": "e76217d4af2581b0def66319b80ffa30b1982f0f", "committedDate": "2022-01-25 15:26:13 +0300", "message": "[Platform usage] Statistics reporting (#2473)"}, {"oid": "b70b90035b21cfaf45419a1cf000309c6d041b8b", "committedDate": "2022-02-07 17:14:49 +0300", "message": "Implementing logic for registering and de-registering of a samplesheet for special project type (#2493)"}, {"oid": "099bf771df247dcbe2f19e8769b58abcc2eda51c", "committedDate": "2022-02-22 19:59:30 +0300", "message": "Hot nodes pools usage (#2491)"}, {"oid": "1bf814d2d41636f574f0abd5f820a1b111faaf73", "committedDate": "2022-05-20 14:29:39 +0300", "message": "Bitbucket support: view and launch pipeline part (#2629)"}, {"oid": "5bfc7fbf19d877e5c7cf3170a9b6f9a412a96e9d", "committedDate": "2022-06-03 12:48:08 +0300", "message": "Issue #2642 Instance limits listing via pipe CLI (#2648)"}, {"oid": "0de17d9b75080c4f294c64c534fb6783cd827799", "committedDate": "2022-08-16 17:01:57 +0300", "message": "Issue 2721 storage lifecycle policy fine-tuned approach (#2729)"}, {"oid": "6bd8e8acda0b48b9550cd3339c1d366ccae6ef5e", "committedDate": "2022-09-06 16:34:30 +0300", "message": "Issue 2721 restore datastorage folder from 'archived' storage class (#2795)"}, {"oid": "9a79e476308c565267b10a316c3bfe127e02ce40", "committedDate": "2022-10-24 18:05:11 +0200", "message": "Allow to serve static resources from a datastorage path using `/restapi/static-resources/` endpoint"}, {"oid": "b557b589e0f6977e16429e6ceee53f16ebe0f654", "committedDate": "2023-01-27 21:47:30 +0100", "message": "Issue #3015 User notifications: minor fixes + move notifications creation to notifier service"}, {"oid": "51e3895b9414112fa85115b2d068c4e5cdb7f2ac", "committedDate": "2023-03-15 00:45:39 +0100", "message": "Introduce custom ACL deserialization for Redis Cache in order to improve performance"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExODkyNw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509118927", "body": "I'm afraid that this change can be harmful if some api method has `NodeInstance` class in request body. For example as part of `PipelineRun` class. Let's revert the change until we have implemented tests for all the controllers.", "bodyText": "I'm afraid that this change can be harmful if some api method has NodeInstance class in request body. For example as part of PipelineRun class. Let's revert the change until we have implemented tests for all the controllers.", "bodyHTML": "<p dir=\"auto\">I'm afraid that this change can be harmful if some api method has <code>NodeInstance</code> class in request body. For example as part of <code>PipelineRun</code> class. Let's revert the change until we have implemented tests for all the controllers.</p>", "author": "tcibinan", "createdAt": "2020-10-21T09:13:20Z", "path": "api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java", "diffHunk": "@@ -45,7 +45,6 @@\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n-    private String name;", "originalCommit": "4a5f096dcc4809e99c88158e87803b53a477beba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\nindex 49045111d..0ae304625 100644\n--- a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n+++ b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n", "chunk": "@@ -45,6 +45,7 @@ import static com.epam.pipeline.manager.cluster.KubernetesConstants.RUN_ID_LABEL\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n+    private String name;\n     private String creationTimestamp;\n     private List<NodeInstanceAddress> addresses;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\nindex 0ae304625..49045111d 100644\n--- a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n+++ b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n", "chunk": "@@ -45,7 +45,6 @@ import static com.epam.pipeline.manager.cluster.KubernetesConstants.RUN_ID_LABEL\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n-    private String name;\n     private String creationTimestamp;\n     private List<NodeInstanceAddress> addresses;\n \n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\nindex 49045111d..0ae304625 100644\n--- a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n+++ b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n", "chunk": "@@ -45,6 +45,7 @@ import static com.epam.pipeline.manager.cluster.KubernetesConstants.RUN_ID_LABEL\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n+    private String name;\n     private String creationTimestamp;\n     private List<NodeInstanceAddress> addresses;\n \n", "next_change": null}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\nindex 49045111d..0ae304625 100644\n--- a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n+++ b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n", "chunk": "@@ -45,6 +45,7 @@ import static com.epam.pipeline.manager.cluster.KubernetesConstants.RUN_ID_LABEL\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n+    private String name;\n     private String creationTimestamp;\n     private List<NodeInstanceAddress> addresses;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\nindex 0ae304625..49045111d 100644\n--- a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n+++ b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n", "chunk": "@@ -45,7 +45,6 @@ import static com.epam.pipeline.manager.cluster.KubernetesConstants.RUN_ID_LABEL\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n-    private String name;\n     private String creationTimestamp;\n     private List<NodeInstanceAddress> addresses;\n \n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\nindex 49045111d..0ae304625 100644\n--- a/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n+++ b/api/src/main/java/com/epam/pipeline/entity/cluster/NodeInstance.java\n", "chunk": "@@ -45,6 +45,7 @@ import static com.epam.pipeline.manager.cluster.KubernetesConstants.RUN_ID_LABEL\n public class NodeInstance extends AbstractSecuredEntity {\n \n     private UUID uid;\n+    private String name;\n     private String creationTimestamp;\n     private List<NodeInstanceAddress> addresses;\n \n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExOTU5Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509119597", "body": "Could you please replace the field usages with `CommonCreatorConstants.TEST_STRING`.", "bodyText": "Could you please replace the field usages with CommonCreatorConstants.TEST_STRING.", "bodyHTML": "<p dir=\"auto\">Could you please replace the field usages with <code>CommonCreatorConstants.TEST_STRING</code>.</p>", "author": "tcibinan", "createdAt": "2020-10-21T09:14:16Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";", "originalCommit": "4a5f096dcc4809e99c88158e87803b53a477beba", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3ODM1Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509178357", "bodyText": "I already have four static imports in this class, and, if i'm not mistaken, PMD avoid amount of static imports more than four.", "author": "YouKofan", "createdAt": "2020-10-21T10:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTExOTU5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,10 +47,10 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,62 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": null}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -57,21 +58,19 @@ import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,62 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": null}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,10 +47,12 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,64 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -78,9 +81,6 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private NodesManager mockNodesManager;\n \n-    @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n     @Autowired\n     private AuthManager mockAuthManager;\n \n", "next_change": null}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -57,21 +60,19 @@ import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,64 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -78,9 +81,6 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private NodesManager mockNodesManager;\n \n-    @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n     @Autowired\n     private AuthManager mockAuthManager;\n \n", "next_change": null}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEyMTYyNA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509121624", "body": "I suppose we can call the second one just `anotherNodeInstance`.", "bodyText": "I suppose we can call the second one just anotherNodeInstance.", "bodyHTML": "<p dir=\"auto\">I suppose we can call the second one just <code>anotherNodeInstance</code>.</p>", "author": "tcibinan", "createdAt": "2020-10-21T09:17:17Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);", "originalCommit": "4a5f096dcc4809e99c88158e87803b53a477beba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -57,21 +58,19 @@ import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,62 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": null}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -57,21 +60,19 @@ import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n-    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,64 +16,34 @@\n \n package com.epam.pipeline.acl.cluster;\n \n-import com.epam.pipeline.controller.vo.FilterNodesVO;\n-import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n-import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n-import com.epam.pipeline.entity.cluster.InstanceType;\n-import com.epam.pipeline.entity.cluster.MasterNode;\n-import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n-import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.contextual.ContextualPreference;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n+import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n-import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.entity.preference.PreferenceType;\n import com.epam.pipeline.manager.cluster.NodesManager;\n-import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n-import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.manager.preference.SystemPreferences;\n+import com.epam.pipeline.manager.security.CheckPermissionHelper;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n-import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n-import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n-import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n-import org.springframework.security.access.AccessDeniedException;\n-import org.springframework.security.authentication.TestingAuthenticationToken;\n-import org.springframework.security.core.Authentication;\n import org.springframework.security.test.context.support.WithMockUser;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.InputStream;\n-import java.time.Duration;\n-import java.time.LocalDateTime;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.ID_2;\n-import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n-import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, SIMPLE_USER);\n-    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(ID_2, TEST_STRING);\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(ID, SIMPLE_USER);\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n-    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n-\n-    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n-    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n-    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n-\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -16,31 +16,43 @@\n \n package com.epam.pipeline.acl.cluster;\n \n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n import com.epam.pipeline.entity.contextual.ContextualPreference;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceExternalResource;\n-import com.epam.pipeline.entity.contextual.ContextualPreferenceLevel;\n import com.epam.pipeline.entity.pipeline.PipelineRun;\n-import com.epam.pipeline.entity.preference.PreferenceType;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n import com.epam.pipeline.manager.contextual.ContextualPreferenceManager;\n import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n import com.epam.pipeline.manager.preference.SystemPreferences;\n-import com.epam.pipeline.manager.security.CheckPermissionHelper;\n+import com.epam.pipeline.manager.security.AuthManager;\n import com.epam.pipeline.security.acl.AclPermission;\n import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n import org.junit.Before;\n import org.junit.Test;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n import org.springframework.security.test.context.support.WithMockUser;\n \n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n-import static org.mockito.Mockito.when;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -50,12 +52,28 @@ import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.*;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n+    private final ContextualPreference contextualPreference =\n+            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n     @Autowired\n     private ClusterApiService clusterApiService;\n \n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -53,23 +49,23 @@ import java.util.Collections;\n import java.util.List;\n \n import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n-import static org.mockito.Mockito.*;\n+import static org.mockito.Mockito.doReturn;\n \n public class ClusterApiServiceTest extends AbstractAclTest {\n \n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstanceWithPermission();\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstanceWithoutPermission();\n-    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRunWithPermission();\n-    private final ContextualPreference contextualPreference =\n-            ContextualPreferenceCreatorUtils.getContextualPreference();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-    private final MonitoringStats monitoringStats = ContextualPreferenceCreatorUtils.getMonitoringStats();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+\n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n     private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -65,6 +67,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n     private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n     private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n     private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -46,32 +46,31 @@ import java.io.ByteArrayInputStream;\n import java.io.InputStream;\n import java.time.Duration;\n import java.time.LocalDateTime;\n-import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n \n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.mockito.Matchers.eq;\n import static org.mockito.Mockito.doReturn;\n \n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n public class ClusterApiServiceTest extends AbstractAclTest {\n \n-    private final String TEST_STRING = \"TEST\";\n     private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n     private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n     private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n     private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n     private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n     private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n     private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n     private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n \n-    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n-    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n-    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n \n     @Autowired\n     private ClusterApiService clusterApiService;\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -78,9 +81,6 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private NodesManager mockNodesManager;\n \n-    @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n     @Autowired\n     private AuthManager mockAuthManager;\n \n", "next_change": null}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -51,55 +63,78 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager pipelineRunManager;\n+    private PipelineRunManager mockPipelineRunManager;\n \n     @Autowired\n-    private CheckPermissionHelper permissionHelper;\n+    private ContextualPreferenceManager mockContextualPreferenceManager;\n \n     @Autowired\n-    private ContextualPreferenceManager preferenceManager;\n+    private AuthManager mockAuthManager;\n \n-    private NodeInstance nodeInstance;\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n \n-    private NodeInstance nodeInstanceWithoutPermission;\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n \n-    private List<NodeInstance> singleNodeInstance;\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> twoNodeInstances;\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n+\n+    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n+\n+    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n+\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n \n-    private PipelineRun pipelineRun;\n+    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n \n-    private PipelineRun pipelineRunWithoutPermission;\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n \n-    private ContextualPreference contextualPreference;\n+    private InputStream inputStream;\n \n-    private final ContextualPreferenceExternalResource resource =\n-            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n+    private List<NodeDisk> nodeDisks;\n+\n+    private List<InstanceType> instanceTypes;\n+\n+    private List<MonitoringStats> statsList;\n+\n+    private List<NodeInstance> singleNodeInstance;\n+\n+    private List<NodeInstance> twoNodeInstances;\n \n     @Before\n     public void setUp() {\n-        contextualPreference = new ContextualPreference(\n-                \"name\", \"0\", PreferenceType.STRING, null, resource);\n+        statsList = Collections.singletonList(monitoringStats);\n+\n+        instanceTypes = Collections.singletonList(instanceType);\n+\n+        nodeDisks = Collections.singletonList(nodeDisk);\n \n-        pipelineRun = new PipelineRun();\n         pipelineRun.setId(1L);\n-        pipelineRun.setPipelineId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRun.setOwner(SIMPLE_USER);\n \n-        pipelineRunWithoutPermission = new PipelineRun();\n+        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n         pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setPipelineId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n+        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n \n-        nodeInstance = new NodeInstance();\n         nodeInstance.setId(1L);\n-        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setOwner(OWNER_USER);\n         nodeInstance.setPipelineRun(pipelineRun);\n+        nodeInstance.setName(TEST_NAME);\n \n-        nodeInstanceWithoutPermission = new NodeInstance();\n         nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n         nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n+        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n \n         singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n", "next_change": {"commit": "b713464980ca18071bff2affee16237e96622694", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..e904947d1 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -80,79 +98,27 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n-\n-    private final NodeInstance nodeInstance = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getDefaultNodeInstance();\n-\n-    private final PipelineRun pipelineRun = NodeCreatorUtils.getPipelineRun();\n-\n-    private final ContextualPreference contextualPreference = NodeCreatorUtils.getContextualPreference();\n-\n-    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n-\n-    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n-\n-    private final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n-\n-    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n-\n-    private InputStream inputStream;\n-\n-    private List<NodeDisk> nodeDisks;\n-\n-    private List<InstanceType> instanceTypes;\n-\n-    private List<MonitoringStats> statsList;\n-\n-    private List<NodeInstance> singleNodeInstance;\n-\n-    private List<NodeInstance> twoNodeInstances;\n-\n-    @Before\n-    public void setUp() {\n-        statsList = Collections.singletonList(monitoringStats);\n-\n-        instanceTypes = Collections.singletonList(instanceType);\n-\n-        nodeDisks = Collections.singletonList(nodeDisk);\n-\n-        pipelineRun.setId(1L);\n-        pipelineRun.setOwner(SIMPLE_USER);\n-\n-        final PipelineRun pipelineRunWithoutPermission = NodeCreatorUtils.getPipelineRun();\n-        pipelineRunWithoutPermission.setId(2L);\n-        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_2);\n-        pipelineRunWithoutPermission.setName(TEST_NAME_2);\n-\n-        nodeInstance.setId(1L);\n-        nodeInstance.setOwner(OWNER_USER);\n-        nodeInstance.setPipelineRun(pipelineRun);\n-        nodeInstance.setName(TEST_NAME);\n-\n-        nodeInstanceWithoutPermission.setId(2L);\n-        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_2);\n-        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n-        nodeInstanceWithoutPermission.setName(TEST_NAME_2);\n-\n-        singleNodeInstance = new ArrayList<>();\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n         singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n \n-        twoNodeInstances = new ArrayList<>();\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n         twoNodeInstances.add(nodeInstance);\n         twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        List<NodeInstance> nodes = clusterApiService.getNodes();\n+        final List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(nodes).hasSize(1);\n-        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+        assertThat(nodes).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904947d1..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -98,61 +91,33 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Autowired\n     private InstanceOfferManager mockInstanceOfferManager;\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n-    }\n-\n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n     public void shouldReturnListWithNodeInstancesForAdmin() {\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        createAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        initAclEntity(nodeInstance,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n-\n-        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-\n+        createAclEntity(nodeInstance, AclPermission.READ);\n+        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n-        final List<NodeInstance> nodes = clusterApiService.getNodes();\n-\n-        assertThat(nodes).hasSize(1).contains(nodeInstance);\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n \n     @Test\n", "next_change": {"commit": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..e904acc38 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -113,8 +113,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        createAclEntity(nodeInstance, AclPermission.READ);\n-        createAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n", "next_change": {"commit": "f64b25fe398480c21040fb9e3421f798a9116097", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -110,9 +113,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n         doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -118,8 +117,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n-        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n     }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -114,8 +114,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n         doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n         initAclEntity(nodeInstance, AclPermission.READ);\n         initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n         doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n", "next_change": null}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e904acc38..dadcdc2e9 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -121,7 +125,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     }\n \n     @Test\n-    @WithMockUser(username = SIMPLE_USER)\n+    @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTEzNjQ2NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509136464", "body": "Method `initSingleNodeInstanceList()` returns list which doesn't contain `nodeInstanceWithoutPermission` so this test is not testing what it should. Probably we can even get rid of methods like `initSingleNodeInstanceList` and always initialiaze lists like the following\r\n```java\r\nCollections.singletonList(node);\r\n// or\r\nArrays.asList(node1, node2);\r\n```", "bodyText": "Method initSingleNodeInstanceList() returns list which doesn't contain nodeInstanceWithoutPermission so this test is not testing what it should. Probably we can even get rid of methods like initSingleNodeInstanceList and always initialiaze lists like the following\nCollections.singletonList(node);\n// or\nArrays.asList(node1, node2);", "bodyHTML": "<p dir=\"auto\">Method <code>initSingleNodeInstanceList()</code> returns list which doesn't contain <code>nodeInstanceWithoutPermission</code> so this test is not testing what it should. Probably we can even get rid of methods like <code>initSingleNodeInstanceList</code> and always initialiaze lists like the following</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Collections.singletonList(node);\n// or\nArrays.asList(node1, node2);\"><pre><span class=\"pl-smi\">Collections</span><span class=\"pl-k\">.</span>singletonList(node);\n<span class=\"pl-c\"><span class=\"pl-c\">//</span> or</span>\n<span class=\"pl-smi\">Arrays</span><span class=\"pl-k\">.</span>asList(node1, node2);</pre></div>", "author": "tcibinan", "createdAt": "2020-10-21T09:39:10Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();", "originalCommit": "4a5f096dcc4809e99c88158e87803b53a477beba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +126,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -127,8 +128,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission);\n-        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n \n         assertThat(clusterApiService.getNodes()).isEmpty();\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0MTgwOQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509141809", "body": "Let's specify explicitly why the access is denied like `shouldDenyAccessToNodeWhenPermissionIsNotGranted`.", "bodyText": "Let's specify explicitly why the access is denied like shouldDenyAccessToNodeWhenPermissionIsNotGranted.", "bodyHTML": "<p dir=\"auto\">Let's specify explicitly why the access is denied like <code>shouldDenyAccessToNodeWhenPermissionIsNotGranted</code>.</p>", "author": "tcibinan", "createdAt": "2020-10-21T09:47:13Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNode() {", "originalCommit": "4a5f096dcc4809e99c88158e87803b53a477beba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -197,10 +196,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n \n     @Test\n     @WithMockUser\n-    public void shouldDenyAccessToNode() {\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -197,10 +198,10 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n \n     @Test\n     @WithMockUser\n-    public void shouldDenyAccessToNode() {\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE0Nzk5MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r509147991", "body": "I wonder if we can extract all this duplicated mocking calls into some methods like the following:\r\n```java\r\nmockUser();\r\nmockStats();\r\nmockNodeInstance();\r\nmockPipelineRun();\r\n```", "bodyText": "I wonder if we can extract all this duplicated mocking calls into some methods like the following:\nmockUser();\nmockStats();\nmockNodeInstance();\nmockPipelineRun();", "bodyHTML": "<p dir=\"auto\">I wonder if we can extract all this duplicated mocking calls into some methods like the following:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"mockUser();\nmockStats();\nmockNodeInstance();\nmockPipelineRun();\"><pre>mockUser();\nmockStats();\nmockNodeInstance();\nmockPipelineRun();</pre></div>", "author": "tcibinan", "createdAt": "2020-10-21T09:56:46Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,451 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final String TEST_STRING = \"TEST\";\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance nodeInstanceWithoutPermission = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = ClusterCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InstanceType instanceType = NodeCreatorUtils.getDefaultInstanceType();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = Collections.singletonList(nodeDisk);\n+    private final List<InstanceType> instanceTypes = Collections.singletonList(instanceType);\n+    private final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(nodeInstanceWithoutPermission, AclPermission.NO_READ);\n+        doReturn(initTwoNodeInstancesList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(initSingleNodeInstanceList()).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        final List<MonitoringStats> returnedStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));", "originalCommit": "4a5f096dcc4809e99c88158e87803b53a477beba", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -293,13 +288,13 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnStatsWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n         initAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n                 nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n         final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex dadcdc2e9..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -293,13 +290,13 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser\n     public void shouldReturnStatsWhenPermissionIsGranted() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n         initAclEntity(nodeInstance, AclPermission.READ);\n         doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n                 nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n \n         final List<MonitoringStats> returnedStatsList =\n                 clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5ODQzNA==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r510698434", "body": "Could you please use generic type to return `List<T>` rather then `List<Object>`. It probably is a good idea because it increases the possibility that this method will be reused.", "bodyText": "Could you please use generic type to return List<T> rather then List<Object>. It probably is a good idea because it increases the possibility that this method will be reused.", "bodyHTML": "<p dir=\"auto\">Could you please use generic type to return <code>List&lt;T&gt;</code> rather then <code>List&lt;Object&gt;</code>. It probably is a good idea because it increases the possibility that this method will be reused.</p>", "author": "tcibinan", "createdAt": "2020-10-23T07:48:52Z", "path": "api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java", "diffHunk": "@@ -131,4 +132,10 @@ public Sid toSid() {\n             return new GrantedAuthoritySid(authorityName);\n         }\n     }\n+\n+    protected List<Object> mutableListOf(Object... objects) {", "originalCommit": "b783a146609e9b69f05d82d5e8487ce0bb6857d4", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex cdc4133bc..b1b85a743 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -133,8 +133,9 @@ public abstract class AbstractAclTest {\n         }\n     }\n \n-    protected List<Object> mutableListOf(Object... objects) {\n-        List<Object> list = new ArrayList<>();\n+    @SafeVarargs\n+    protected final <T> List<T>  mutableListOf(T... objects) {\n+        final List<T> list = new ArrayList<>();\n         Collections.addAll(list, objects);\n         return list;\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex b1b85a743..62fb85071 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -132,11 +122,4 @@ public abstract class AbstractAclTest {\n             return new GrantedAuthoritySid(authorityName);\n         }\n     }\n-\n-    @SafeVarargs\n-    protected final <T> List<T>  mutableListOf(T... objects) {\n-        final List<T> list = new ArrayList<>();\n-        Collections.addAll(list, objects);\n-        return list;\n-    }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex 62fb85071..cdc4133bc 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -122,4 +132,10 @@ public abstract class AbstractAclTest {\n             return new GrantedAuthoritySid(authorityName);\n         }\n     }\n+\n+    protected List<Object> mutableListOf(Object... objects) {\n+        List<Object> list = new ArrayList<>();\n+        Collections.addAll(list, objects);\n+        return list;\n+    }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex cdc4133bc..b1b85a743 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -133,8 +133,9 @@ public abstract class AbstractAclTest {\n         }\n     }\n \n-    protected List<Object> mutableListOf(Object... objects) {\n-        List<Object> list = new ArrayList<>();\n+    @SafeVarargs\n+    protected final <T> List<T>  mutableListOf(T... objects) {\n+        final List<T> list = new ArrayList<>();\n         Collections.addAll(list, objects);\n         return list;\n     }\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex cdc4133bc..d9be86f9d 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -133,8 +131,9 @@ public abstract class AbstractAclTest {\n         }\n     }\n \n-    protected List<Object> mutableListOf(Object... objects) {\n-        List<Object> list = new ArrayList<>();\n+    @SafeVarargs\n+    protected final <T> List<T>  mutableListOf(T... objects) {\n+        final List<T> list = new ArrayList<>();\n         Collections.addAll(list, objects);\n         return list;\n     }\n", "next_change": {"commit": "0dbca0c0a50d59c4195ce5017c258e9aec8c518d", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex d9be86f9d..d0a02949a 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -132,7 +136,7 @@ public abstract class AbstractAclTest {\n     }\n \n     @SafeVarargs\n-    protected final <T> List<T>  mutableListOf(T... objects) {\n+    protected final <T> List<T> mutableListOf(T... objects) {\n         final List<T> list = new ArrayList<>();\n         Collections.addAll(list, objects);\n         return list;\n", "next_change": {"commit": "2ab70f9ed34da8c9d110c912bc9025b218683cb4", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex d0a02949a..5eef32fd9 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -141,4 +147,8 @@ public abstract class AbstractAclTest {\n         Collections.addAll(list, objects);\n         return list;\n     }\n+\n+    protected void mockSecurityContext() {\n+        doReturn(SecurityContextHolder.getContext().getAuthentication()).when(mockAuthManager).getAuthentication();\n+    }\n }\n", "next_change": {"commit": "f1b246f5d0ed3e4cfdbf2523ca4909bd0503cc91", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex 5eef32fd9..cfd73c02b 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -148,6 +149,11 @@ public abstract class AbstractAclTest {\n         return list;\n     }\n \n+    protected void mockAuthUser(final String user) {\n+        mockSecurityContext();\n+        doReturn(user).when(mockAuthManager).getAuthorizedUser();\n+    }\n+\n     protected void mockSecurityContext() {\n         doReturn(SecurityContextHolder.getContext().getAuthentication()).when(mockAuthManager).getAuthentication();\n     }\n", "next_change": {"commit": "c2e25eebf7dc03940471119bb731a6d092a2e49d", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex cfd73c02b..4ec23cf09 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -157,4 +158,9 @@ public abstract class AbstractAclTest {\n     protected void mockSecurityContext() {\n         doReturn(SecurityContextHolder.getContext().getAuthentication()).when(mockAuthManager).getAuthentication();\n     }\n+\n+    protected void mockUser(final String username) {\n+        doReturn(username).when(mockAuthManager).getAuthorizedUser();\n+    }\n+\n }\n", "next_change": {"commit": "7395bbc7195ec8084ee73caba6c3a38f79ed4535", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\nindex 4ec23cf09..99a8ec0c1 100644\n--- a/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n+++ b/api/src/test/java/com/epam/pipeline/test/acl/AbstractAclTest.java\n", "chunk": "@@ -163,4 +200,7 @@ public abstract class AbstractAclTest {\n         doReturn(username).when(mockAuthManager).getAuthorizedUser();\n     }\n \n+    protected void mockUserContext(final UserContext userContext) {\n+        doReturn(userContext).when(mockUserManager).loadUserContext(any());\n+    }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "3dac0af668c91d7f578d4a6a5a0dc13711719df2", "committedDate": "2020-10-27 17:55:36 +0300", "message": "Issue #1404: Improvement tests for Configuration Api Services"}, {"oid": "0dbca0c0a50d59c4195ce5017c258e9aec8c518d", "committedDate": "2020-10-27 17:57:14 +0300", "message": "Issue #1404: Improvements in the tests, changes in the PMD rules"}, {"oid": "4147ed3add4e693b4719a22c35ee0748add6d465", "committedDate": "2020-11-10 14:16:38 +0300", "message": "Issue #1404: DataStorage Acl tests are separated"}, {"oid": "2ab70f9ed34da8c9d110c912bc9025b218683cb4", "committedDate": "2020-11-18 10:05:38 +0300", "message": "Issue #1404: mockSecurityContext() method added, minor refactoring"}, {"oid": "f1b246f5d0ed3e4cfdbf2523ca4909bd0503cc91", "committedDate": "2020-12-08 15:18:49 +0300", "message": "Issue #1404: Implemented tests for Metadata package acl layer (#1612)"}, {"oid": "85058f90a5183f751d68802449f7596255f07c53", "committedDate": "2020-12-08 16:11:49 +0300", "message": "Issue #1404: Implemented tests for User package acl layer (#1629)"}, {"oid": "c2e25eebf7dc03940471119bb731a6d092a2e49d", "committedDate": "2020-12-10 14:23:31 +0300", "message": "Issue #1404: Implemented tests for AclPermissionApiService (#1618)"}, {"oid": "83cd94c75bda1064b8791e8112e552881760e687", "committedDate": "2020-12-21 13:38:29 +0300", "message": "Issue #1404: Implemented tests for acl layer PipelineApiService (#1642)"}, {"oid": "1aab8c35fdfdc59a93df88726a5c3aa7340fc4c8", "committedDate": "2021-02-08 16:06:42 +0300", "message": "Issue #1688: Rewrite HierarchicalEntityManager tests (#1702)"}, {"oid": "6720cffbe9948ffb3364bc9b942a9f25f2c0b389", "committedDate": "2021-02-09 13:41:32 +0300", "message": "Issue #1736 Refactor PipelineWithPermissionTest (#1748)"}, {"oid": "c88710d9137be68aa34f305895beb3391863bff8", "committedDate": "2021-02-09 16:17:24 +0300", "message": "Issue-1735: Unit tests: Rewrite FolderTemplateManagerTest. (#1742)"}, {"oid": "7395bbc7195ec8084ee73caba6c3a38f79ed4535", "committedDate": "2021-05-27 19:57:10 +0300", "message": "Allow to force \"run as\" and \"sharing\" options for the pipelines - implementation for tools (#1973)"}, {"oid": "ce96521c9adc2fce2035b5adc78ff7b1890597d8", "committedDate": "2021-09-29 23:55:58 +0300", "message": "Implement mount status processing for folders"}, {"oid": "fe2b80257e93c405390db80a521d9ed04bf66961", "committedDate": "2022-03-17 13:25:21 +0300", "message": "Issue #762 Billing Quotas - handle READ_ONLY mode for storages and user BLOCK for users"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDcxMzA1Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r510713057", "body": "Probably this mocking call makes thing even more complicated then before. For example in this case `nodeInstance` used for acl is not the same instance that will be used in `initMocksBehavior`. Also this `true\\false` flag is not intuitive. Just imagine that there will be another boolean parameter.\r\n\r\nI still think that it will be better to use separate calls for mocks which will just remove a need to write the whole\r\n`doReturn().when().call()` chain. For example in this case we can use something like the following. It does not contain less lines then the original version. But it is not the point, isn't it? The following code is declarative as plain mockito calls but it is also much simpler. And in case f.e. pipeline run mocking mechanism will have to change in the future then we will just have to change a single method `mockRun`.\r\n```java\r\nmockUser(SIMPLE_USER); // Mock any user related calls that are used in the tests.\r\nmockNode(nodeInstance); // Mock all node instance calls that are used in the tests.\r\nmockRun(pipelineRun); // Mock all pipeline run calls that are used in the tests.\r\n```\r\n\r\n```java\r\npublic void mockNode(final NodeInstance nodeInstance) {\r\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\r\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\r\n}\r\n```\r\n\r\nWhat do you think?", "bodyText": "Probably this mocking call makes thing even more complicated then before. For example in this case nodeInstance used for acl is not the same instance that will be used in initMocksBehavior. Also this true\\false flag is not intuitive. Just imagine that there will be another boolean parameter.\nI still think that it will be better to use separate calls for mocks which will just remove a need to write the whole\ndoReturn().when().call() chain. For example in this case we can use something like the following. It does not contain less lines then the original version. But it is not the point, isn't it? The following code is declarative as plain mockito calls but it is also much simpler. And in case f.e. pipeline run mocking mechanism will have to change in the future then we will just have to change a single method mockRun.\nmockUser(SIMPLE_USER); // Mock any user related calls that are used in the tests.\nmockNode(nodeInstance); // Mock all node instance calls that are used in the tests.\nmockRun(pipelineRun); // Mock all pipeline run calls that are used in the tests.\npublic void mockNode(final NodeInstance nodeInstance) {\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n}\nWhat do you think?", "bodyHTML": "<p dir=\"auto\">Probably this mocking call makes thing even more complicated then before. For example in this case <code>nodeInstance</code> used for acl is not the same instance that will be used in <code>initMocksBehavior</code>. Also this <code>true\\false</code> flag is not intuitive. Just imagine that there will be another boolean parameter.</p>\n<p dir=\"auto\">I still think that it will be better to use separate calls for mocks which will just remove a need to write the whole<br>\n<code>doReturn().when().call()</code> chain. For example in this case we can use something like the following. It does not contain less lines then the original version. But it is not the point, isn't it? The following code is declarative as plain mockito calls but it is also much simpler. And in case f.e. pipeline run mocking mechanism will have to change in the future then we will just have to change a single method <code>mockRun</code>.</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"mockUser(SIMPLE_USER); // Mock any user related calls that are used in the tests.\nmockNode(nodeInstance); // Mock all node instance calls that are used in the tests.\nmockRun(pipelineRun); // Mock all pipeline run calls that are used in the tests.\"><pre>mockUser(<span class=\"pl-c1\">SIMPLE_USER</span>); <span class=\"pl-c\"><span class=\"pl-c\">//</span> Mock any user related calls that are used in the tests.</span>\nmockNode(nodeInstance); <span class=\"pl-c\"><span class=\"pl-c\">//</span> Mock all node instance calls that are used in the tests.</span>\nmockRun(pipelineRun); <span class=\"pl-c\"><span class=\"pl-c\">//</span> Mock all pipeline run calls that are used in the tests.</span></pre></div>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"public void mockNode(final NodeInstance nodeInstance) {\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n    doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n}\"><pre><span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> mockNode(<span class=\"pl-k\">final</span> <span class=\"pl-smi\">NodeInstance</span> nodeInstance) {\n    doReturn(nodeInstance)<span class=\"pl-k\">.</span>when(mockNodesManager)<span class=\"pl-k\">.</span>getNode(nodeInstance<span class=\"pl-k\">.</span>getName(), filterPodsRequest);\n    doReturn(nodeInstance)<span class=\"pl-k\">.</span>when(mockNodesManager)<span class=\"pl-k\">.</span>getNode(nodeInstance<span class=\"pl-k\">.</span>getName());\n}</pre></div>\n<p dir=\"auto\">What do you think?</p>", "author": "tcibinan", "createdAt": "2020-10-23T08:15:28Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,432 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+@SuppressWarnings(\"PMD.TooManyStaticImports\")\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initMocksBehavior(true);", "originalCommit": "5c317b5ac7100eac63135f3e14d1251234969cbf", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex beeef5b7f..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -218,7 +217,9 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n         final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initMocksBehavior(true);\n+        mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n+        mockUser();\n \n         final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n \n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex beeef5b7f..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -216,9 +217,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     @Test\n     @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n         initAclEntity(nodeInstance, AclPermission.READ);\n-        initMocksBehavior(true);\n+        mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n+        mockUser();\n \n         final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n \n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyNjg2OQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1481#discussion_r511826869", "body": "It does look like we can just replace it with the new method `mockNode`. Some similar cases with `terminateNode` calls in different tests too. You can just add `terminateNode` to `mockNode` and everything seems to be just fine.", "bodyText": "It does look like we can just replace it with the new method mockNode. Some similar cases with terminateNode calls in different tests too. You can just add terminateNode to mockNode and everything seems to be just fine.", "bodyHTML": "<p dir=\"auto\">It does look like we can just replace it with the new method <code>mockNode</code>. Some similar cases with <code>terminateNode</code> calls in different tests too. You can just add <code>terminateNode</code> to <code>mockNode</code> and everything seems to be just fine.</p>", "author": "tcibinan", "createdAt": "2020-10-26T09:36:52Z", "path": "api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java", "diffHunk": "@@ -0,0 +1,444 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.acl.cluster;\n+\n+import com.epam.pipeline.controller.vo.FilterNodesVO;\n+import com.epam.pipeline.entity.cluster.AllowedInstanceAndPriceTypes;\n+import com.epam.pipeline.entity.cluster.FilterPodsRequest;\n+import com.epam.pipeline.entity.cluster.InstanceType;\n+import com.epam.pipeline.entity.cluster.MasterNode;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.NodeInstance;\n+import com.epam.pipeline.entity.cluster.monitoring.MonitoringStats;\n+import com.epam.pipeline.entity.pipeline.PipelineRun;\n+import com.epam.pipeline.manager.cluster.InstanceOfferManager;\n+import com.epam.pipeline.manager.cluster.NodeDiskManager;\n+import com.epam.pipeline.manager.cluster.NodesManager;\n+import com.epam.pipeline.manager.cluster.performancemonitoring.UsageMonitoringManager;\n+import com.epam.pipeline.manager.pipeline.PipelineRunManager;\n+import com.epam.pipeline.manager.security.AuthManager;\n+import com.epam.pipeline.security.acl.AclPermission;\n+import com.epam.pipeline.test.acl.AbstractAclTest;\n+import com.epam.pipeline.test.creator.cluster.ClusterCreatorUtils;\n+import com.epam.pipeline.test.creator.cluster.NodeCreatorUtils;\n+import com.epam.pipeline.test.creator.pipeline.PipelineCreatorUtils;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.security.access.AccessDeniedException;\n+import org.springframework.security.authentication.TestingAuthenticationToken;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.test.context.support.WithMockUser;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.InputStream;\n+import java.time.Duration;\n+import java.time.LocalDateTime;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static com.epam.pipeline.test.creator.CommonCreatorConstants.TEST_STRING;\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.doReturn;\n+\n+public class ClusterApiServiceTest extends AbstractAclTest {\n+\n+    private final FilterPodsRequest filterPodsRequest = NodeCreatorUtils.getDefaultFilterPodsRequest();\n+    private final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, SIMPLE_USER);\n+    private final NodeInstance anotherNodeInstance = NodeCreatorUtils.getNodeInstance(2L, TEST_STRING);\n+    private final PipelineRun pipelineRun = PipelineCreatorUtils.getPipelineRun(1L, SIMPLE_USER);\n+    private final FilterNodesVO filterNodesVO = NodeCreatorUtils.getDefaultFilterNodesVO();\n+    private final NodeDisk nodeDisk = NodeCreatorUtils.getDefaultNodeDisk();\n+    private final MonitoringStats monitoringStats = ClusterCreatorUtils.getMonitoringStats();\n+    private final InputStream inputStream = new ByteArrayInputStream(TEST_STRING.getBytes());\n+    private final Authentication authentication = new TestingAuthenticationToken(new Object(), new Object());\n+\n+    private final List<NodeDisk> nodeDisks = NodeCreatorUtils.getNodeDiskList();\n+    private final List<InstanceType> instanceTypes = NodeCreatorUtils.getInstanceTypeList();\n+    private final List<MonitoringStats> statsList = ClusterCreatorUtils.getMonitoringStatsList();\n+\n+    @Autowired\n+    private ClusterApiService clusterApiService;\n+\n+    @Autowired\n+    private NodesManager mockNodesManager;\n+\n+    @Autowired\n+    private PipelineRunManager mockPipelineRunManager;\n+\n+    @Autowired\n+    private AuthManager mockAuthManager;\n+\n+    @Autowired\n+    private UsageMonitoringManager mockUsageMonitoringManager;\n+\n+    @Autowired\n+    private NodeDiskManager mockNodeDiskManager;\n+\n+    @Autowired\n+    private InstanceOfferManager mockInstanceOfferManager;\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n+\n+        assertThat(clusterApiService.getNodes()).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockUser();\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(authentication).when(mockAuthManager).getAuthentication();\n+        mockUser();\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(anotherNodeInstance);\n+        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n+        mockUser();\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n+        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        final List<MonitoringStats> returnedStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final List<MonitoringStats> returnedStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class,\n+                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+        mockUser();\n+\n+        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(returnedInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        mockNode(nodeInstance);\n+        mockRun(pipelineRun);\n+\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n+                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n+                .isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance, AclPermission.READ);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        mockUser();\n+        mockRun(pipelineRun);\n+\n+        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());", "originalCommit": "01febba00d8ffb21d4f4ae621c898d2bad0cec19", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..92fd30b1a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -422,9 +419,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 92fd30b1a..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -79,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(1L, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-                () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(1L, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}, "revised_code_in_main": {"commit": "18a749f8e369606f5804285a4a445f42e9906598", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..9d6ba7594 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -422,9 +421,8 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n         initAclEntity(nodeInstance);\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         mockRun(pipelineRun);\n+        mockNode(nodeInstance);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n", "next_change": {"commit": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9d6ba7594..a80223581 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -81,363 +51,127 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private NodesManager mockNodesManager;\n \n     @Autowired\n-    private PipelineRunManager mockPipelineRunManager;\n-\n-    @Autowired\n-    private AuthManager mockAuthManager;\n+    private PipelineRunManager pipelineRunManager;\n \n     @Autowired\n-    private UsageMonitoringManager mockUsageMonitoringManager;\n+    private CheckPermissionHelper permissionHelper;\n \n     @Autowired\n-    private NodeDiskManager mockNodeDiskManager;\n-\n-    @Autowired\n-    private InstanceOfferManager mockInstanceOfferManager;\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance, anotherNodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).hasSize(1).contains(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).getNodes();\n-\n-        assertThat(clusterApiService.getNodes()).isEmpty();\n-    }\n+    private ContextualPreferenceManager preferenceManager;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private NodeInstance nodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private NodeInstance nodeInstanceWithoutPermission;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockUser();\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private List<NodeInstance> singleNodeInstance;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private List<NodeInstance> twoNodeInstances;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n-        doReturn(authentication).when(mockAuthManager).getAuthentication();\n-        mockUser();\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        initAclEntity(anotherNodeInstance, AclPermission.NO_READ);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n-\n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).hasSize(1).contains(nodeInstance);\n-    }\n+    private PipelineRun pipelineRun;\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(anotherNodeInstance);\n-        doReturn(mutableListOf(nodeInstance)).when(mockNodesManager).filterNodes(filterNodesVO);\n+    private PipelineRun pipelineRunWithoutPermission;\n \n-        assertThat(clusterApiService.filterNodes(filterNodesVO)).isEmpty();\n-    }\n+    private ContextualPreference contextualPreference;\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeInstanceForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+    private final ContextualPreferenceExternalResource resource =\n+            new ContextualPreferenceExternalResource(ContextualPreferenceLevel.USER, \"1\");\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n+    @Before\n+    public void setUp() {\n+        contextualPreference = new ContextualPreference(\n+                \"name\", \"0\", PreferenceType.STRING, null, resource);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n+        pipelineRun = new PipelineRun();\n+        pipelineRun.setId(1L);\n+        pipelineRun.setPipelineId(1L);\n+        pipelineRun.setOwner(SIMPLE_USER_ROLE);\n \n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        mockRun(pipelineRun);\n+        pipelineRunWithoutPermission = new PipelineRun();\n+        pipelineRunWithoutPermission.setId(2L);\n+        pipelineRunWithoutPermission.setPipelineId(2L);\n+        pipelineRunWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n \n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getNode(nodeInstance.getName()));\n-    }\n+        nodeInstance = new NodeInstance();\n+        nodeInstance.setId(1L);\n+        nodeInstance.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstance.setPipelineRun(pipelineRun);\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeThroughRequestForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        nodeInstanceWithoutPermission = new NodeInstance();\n+        nodeInstanceWithoutPermission.setId(2L);\n+        nodeInstanceWithoutPermission.setOwner(SIMPLE_USER_ROLE);\n+        nodeInstanceWithoutPermission.setPipelineRun(pipelineRunWithoutPermission);\n \n-        assertThat(clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest)).isEqualTo(nodeInstance);\n-    }\n+        singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n \n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeThroughRequestWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest));\n+        twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n     }\n \n     @Test\n     @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldTerminateNodeForAdmin() {\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-\n-        assertThat(clusterApiService.terminateNode(nodeInstance.getName())).isEqualTo(nodeInstance);\n-    }\n-\n-    @Test\n-    @WithMockUser(username = SIMPLE_USER)\n-    public void shouldTerminateNodeWhenPermissionIsGranted() {\n-        final NodeInstance nodeInstance = NodeCreatorUtils.getNodeInstance(ID, TEST_STRING);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final NodeInstance returnedNodeInstance = clusterApiService.terminateNode(nodeInstance.getName());\n-\n-        assertThat(returnedNodeInstance).isEqualTo(nodeInstance);\n-        assertThat(returnedNodeInstance.getMask()).isEqualTo(AclPermission.READ.getMask());\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.terminateNode(nodeInstance.getName()));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnStatsForNodeForAdmin() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnStatsWhenPermissionIsGranted() {\n-        final List<MonitoringStats> statsList = Collections.singletonList(monitoringStats);\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(statsList).when(mockUsageMonitoringManager).getStatsForNode(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final List<MonitoringStats> returnedStatsList =\n-                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-\n-        assertThat(returnedStatsList).hasSize(1).contains(monitoringStats);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+    public void shouldReturnListWithNodeInstancesForAdmin() {\n         initAclEntity(nodeInstance);\n-        doReturn(statsList).when(mockUsageMonitoringManager)\n-                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThrows(AccessDeniedException.class,\n-            () -> clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX));\n-    }\n-\n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnUsageStatisticsFileForAdmin() {\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-        mockUser();\n-\n-        final InputStream returnedInputStream = clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-\n-        assertThat(returnedInputStream).isEqualTo(inputStream);\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(inputStream).when(mockUsageMonitoringManager).getStatsForNodeAsInputStream(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n-        mockNode(nodeInstance);\n-        mockRun(pipelineRun);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.getUsageStatisticsFile(\n-                nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO));\n-    }\n-\n-    @Test\n-    @WithMockUser\n-    public void shouldReturnInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(ID, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstancesWhenPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnToolInstanceTypes() {\n-        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(ID, true);\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-        assertThat(clusterApiService.getAllowedToolInstanceTypes(ID, true)).isEqualTo(instanceTypes);\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnAllowedInstanceAndPriceTypes() {\n-        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n-                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n-        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n-                .getAllowedInstanceAndPriceTypes(ID, ID_2, true);\n-\n-        assertThat(clusterApiService.getAllowedInstanceAndPriceTypes(ID, ID_2, true))\n-                .isEqualTo(allowedInstanceAndPriceTypes);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n     @Test\n-    @WithMockUser\n-    public void shouldReturnMasterNodes() {\n-        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n-        final List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n-        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnListWithNodeInstanceWhichPermissionIsGranted() {\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n \n-        assertThat(clusterApiService.getMasterNodes()).isEqualTo(masterNodes);\n-    }\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        when(permissionHelper.isAllowed(\"READ\", pipelineRun)).thenReturn(true);\n+        doReturn(twoNodeInstances).when(mockNodesManager).getNodes();\n \n-    @Test\n-    @WithMockUser(roles = ADMIN_ROLE)\n-    public void shouldReturnNodeDisksForAdmin() {\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-    @Test\n-    @WithMockUser\n-    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n-        initAclEntity(nodeInstance, AclPermission.READ);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockNode(nodeInstance);\n-        mockUser();\n-        mockRun(pipelineRun);\n-\n-        assertThat(clusterApiService.loadNodeDisks(nodeDisk.getNodeId())).hasSize(1).contains(nodeDisk);\n-    }\n \n     @Test\n-    @WithMockUser\n-    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstance);\n-        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n-        mockRun(pipelineRun);\n-        mockNode(nodeInstance);\n-\n-        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n-    }\n-\n-    private void mockNode(final NodeInstance nodeInstance) {\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n-        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n-        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n-    }\n+    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(preferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n-    private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n-    }\n+        List<NodeInstance> nodes = clusterApiService.getNodes();\n \n-    private void mockUser() {\n-        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        assertThat(nodes).isEmpty();\n     }\n }\n", "next_change": {"commit": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a80223581..e3a4484e6 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -159,19 +191,356 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n     }\n \n-\n     @Test\n-    @WithMockUser(username = SIMPLE_USER_ROLE)\n+    @WithMockUser(username = SIMPLE_USER)\n     public void shouldReturnEmptyNodeInstanceListWhenPermissionIsNotGranted() {\n-        initAclEntity(nodeInstanceWithoutPermission,\n-                Collections.singletonList(new UserPermission(SIMPLE_USER_ROLE, AclPermission.NO_READ.getMask())));\n-        doReturn(contextualPreference).when(preferenceManager).search(\n-                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n-        doReturn(pipelineRun).when(pipelineRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(nodeInstanceWithoutPermission);\n         doReturn(singleNodeInstance).when(mockNodesManager).getNodes();\n \n         List<NodeInstance> nodes = clusterApiService.getNodes();\n \n         assertThat(nodes).isEmpty();\n     }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnFilteredListWithNodeInstancesForAdmin() {\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredNodeInstanceListWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes.size()).isEqualTo(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnFilteredListWithNodeInstanceWhichPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        initAclEntity(nodeInstanceWithoutPermission,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.NO_READ.getMask())));\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(twoNodeInstances).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).hasSize(1);\n+        assertThat(nodes.get(0)).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnEmptyFilteredNodeInstanceListWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstanceWithoutPermission);\n+        doReturn(contextualPreference).when(mockContextualPreferenceManager).search(\n+                Collections.singletonList(SystemPreferences.RUN_VISIBILITY_POLICY.getKey()));\n+        doReturn(singleNodeInstance).when(mockNodesManager).filterNodes(filterNodesVO);\n+\n+        List<NodeInstance> nodes = clusterApiService.filterNodes(filterNodesVO);\n+\n+        assertThat(nodes).isEmpty();\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeInstanceForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeInstanceWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName());\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNode() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeThroughRequestForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeThroughRequestWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance node = clusterApiService.getNode(nodeInstance.getName(), filterPodsRequest);\n+\n+        assertThat(node).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeThroughRequest() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldTerminateNodeForAdmin() {\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldTerminateNodeWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.EXECUTE.getMask())));\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        NodeInstance resultNode = clusterApiService.terminateNode(nodeInstance.getName());\n+\n+        assertThat(resultNode).isEqualTo(nodeInstance);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeTerminationWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.terminateNode(nodeInstance.getName());\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnStatsForNodeForAdmin() {\n+        final MonitoringStats monitoringStats = NodeCreatorUtils.getMonitoringStats();\n+        statsList = Collections.singletonList(monitoringStats);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnStatsWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<MonitoringStats> resultStatsList =\n+                clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+\n+        assertThat(resultStatsList.size()).isEqualTo(1);\n+        assertThat(resultStatsList.get(0)).isEqualTo(monitoringStats);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToStatsWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(statsList).when(mockUsageMonitoringManager)\n+                .getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getStatsForNode(nodeInstance.getName(), LocalDateTime.MIN, LocalDateTime.MAX);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnUsageStatisticsFileForAdmin() {\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnUsageStatisticsFileWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        InputStream resultInputStream =\n+                clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+\n+        assertThat(resultInputStream).isEqualTo(inputStream);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToUsageStatisticsFileWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(inputStream).when(mockUsageMonitoringManager)\n+                .getStatsForNodeAsInputStream(nodeInstance.getName(),\n+                        LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.getUsageStatisticsFile(nodeInstance.getName(),\n+                LocalDateTime.MIN, LocalDateTime.MAX, Duration.ZERO);\n+    }\n+\n+    @Test\n+    public void shouldReturnInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService.getAllowedInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnToolInstanceTypes() {\n+        doReturn(instanceTypes).when(mockInstanceOfferManager).getAllowedToolInstanceTypes(1L, true);\n+\n+        List<InstanceType> resultInstanceTypesList = clusterApiService\n+                .getAllowedToolInstanceTypes(1L, true);\n+\n+        assertThat(resultInstanceTypesList).isEqualTo(instanceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnAllowedInstanceAndPriceTypes() {\n+        final AllowedInstanceAndPriceTypes allowedInstanceAndPriceTypes =\n+                NodeCreatorUtils.getDefaultAllowedInstanceAndPriceTypes();\n+        doReturn(allowedInstanceAndPriceTypes).when(mockInstanceOfferManager)\n+                .getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        AllowedInstanceAndPriceTypes result = clusterApiService.getAllowedInstanceAndPriceTypes(1L, 2L, true);\n+\n+        assertThat(result).isEqualTo(allowedInstanceAndPriceTypes);\n+    }\n+\n+    @Test\n+    public void shouldReturnMasterNodes() {\n+        final MasterNode masterNode = NodeCreatorUtils.getMasterNodeWithEmptyNode();\n+        List<MasterNode> masterNodes = Collections.singletonList(masterNode);\n+        doReturn(masterNodes).when(mockNodesManager).getMasterNodes();\n+\n+        List<MasterNode> resultMasterNodesList = clusterApiService.getMasterNodes();\n+\n+        assertThat(resultMasterNodesList).isEqualTo(masterNodes);\n+    }\n+\n+    @Test\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldReturnNodeDisksForAdmin() {\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldReturnNodeDisksWhenPermissionIsGranted() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        initAclEntity(nodeInstance,\n+                Collections.singletonList(new UserPermission(SIMPLE_USER, AclPermission.READ.getMask())));\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        List<NodeDisk> resultNodeDiskList = clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+\n+        assertThat(resultNodeDiskList.size()).isEqualTo(1);\n+        assertThat(resultNodeDiskList.get(0)).isEqualTo(nodeDisk);\n+    }\n+\n+    @Test(expected = AccessDeniedException.class)\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyAccessToNodeDisksWhenPermissionIsNotGranted() {\n+        initAclEntity(nodeInstance);\n+        doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+\n+        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+    }\n }\n", "next_change": {"commit": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex e3a4484e6..f55c4ca0a 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -541,6 +414,19 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n \n-        clusterApiService.loadNodeDisks(nodeDisk.getNodeId());\n+        assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n+    }\n+\n+    private List<NodeInstance> initSingleNodeInstanceList() {\n+        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n+        singleNodeInstance.add(nodeInstance);\n+        return singleNodeInstance;\n+    }\n+\n+    private List<NodeInstance> initTwoNodeInstancesList() {\n+        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n+        twoNodeInstances.add(nodeInstance);\n+        twoNodeInstances.add(nodeInstanceWithoutPermission);\n+        return twoNodeInstances;\n     }\n }\n", "next_change": {"commit": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex f55c4ca0a..a8b7cdf73 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -417,16 +420,12 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private List<NodeInstance> initSingleNodeInstanceList() {\n-        final List<NodeInstance> singleNodeInstance = new ArrayList<>();\n-        singleNodeInstance.add(nodeInstance);\n-        return singleNodeInstance;\n-    }\n-\n-    private List<NodeInstance> initTwoNodeInstancesList() {\n-        final List<NodeInstance> twoNodeInstances = new ArrayList<>();\n-        twoNodeInstances.add(nodeInstance);\n-        twoNodeInstances.add(nodeInstanceWithoutPermission);\n-        return twoNodeInstances;\n+    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n+        if (isAuthorizeNeeded) {\n+            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+        }\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n+        doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n }\n", "next_change": {"commit": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex a8b7cdf73..9c0def9ea 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -415,17 +424,21 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(nodeDisks).when(mockNodeDiskManager).loadByNodeId(nodeDisk.getNodeId());\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeDisk.getNodeId());\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        mockRun(pipelineRun);\n \n         assertThrows(AccessDeniedException.class, () -> clusterApiService.loadNodeDisks(nodeDisk.getNodeId()));\n     }\n \n-    private void initMocksBehavior(boolean isAuthorizeNeeded) {\n-        if (isAuthorizeNeeded) {\n-            doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n-        }\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n     }\n+\n+    private void mockRun(final PipelineRun pipelineRun) {\n+        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+    }\n+\n+    protected void mockUser() {\n+        doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n+    }\n }\n", "next_change": {"commit": "931c37811a89c4bfab582dde776e553cc335edac", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex 9c0def9ea..eff4f2e0d 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -438,7 +438,7 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n         doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n     }\n \n-    protected void mockUser() {\n+    private void mockUser() {\n         doReturn(SIMPLE_USER).when(mockAuthManager).getAuthorizedUser();\n     }\n }\n", "next_change": {"commit": "efbf458d50d7766aa7a107a5070d954664a50c78", "changed_code": [{"header": "diff --git a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\nindex eff4f2e0d..6ed5995b7 100644\n--- a/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n+++ b/api/src/test/java/com/epam/pipeline/acl/cluster/ClusterApiServiceTest.java\n", "chunk": "@@ -432,10 +431,11 @@ public class ClusterApiServiceTest extends AbstractAclTest {\n     private void mockNode(final NodeInstance nodeInstance) {\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName(), filterPodsRequest);\n         doReturn(nodeInstance).when(mockNodesManager).getNode(nodeInstance.getName());\n+        doReturn(nodeInstance).when(mockNodesManager).terminateNode(nodeInstance.getName());\n     }\n \n     private void mockRun(final PipelineRun pipelineRun) {\n-        doReturn(pipelineRun).when(mockPipelineRunManager).loadPipelineRun(eq(pipelineRun.getId()));\n+        doReturn(pipelineRun).when(mockRunCrudService).loadRunById(eq(pipelineRun.getId()));\n     }\n \n     private void mockUser() {\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "18a749f8e369606f5804285a4a445f42e9906598", "message": "Merge commit", "committedDate": null}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "committedDate": "2020-10-27 16:29:23 +0300", "message": "Issue #1404: tests for the first method in the ClusterApiService"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "committedDate": "2020-10-27 16:32:47 +0300", "message": "Issue #1404: implemented tests for ClusterApiService"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "committedDate": "2020-10-27 16:33:41 +0300", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "committedDate": "2020-10-27 16:34:13 +0300", "message": "Issue #1404: Minor style improvements"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Refactoring initAclEntity method"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "committedDate": "2020-10-27 16:34:30 +0300", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "committedDate": "2020-10-27 16:34:36 +0300", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "committedDate": "2020-10-27 16:34:39 +0300", "message": "Issue #1404: Refactoring in creatorUtils classes"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "committedDate": "2020-10-27 16:34:59 +0300", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor test fixes"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "committedDate": "2020-10-27 16:35:08 +0300", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "committedDate": "2020-10-27 16:35:09 +0300", "message": "Issue #1404: Style (valid indentations) fixes"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "committedDate": "2020-10-27 16:51:58 +0300", "message": "Issue #1404: Merge conflicts resolved"}, {"oid": "df852130c4f2e5ee1fb6b4558b8fb694ba3b5041", "committedDate": "2020-12-21 15:32:56 +0300", "message": "Issue #1646 Export node monitoring reports as Excel (#1657)"}, {"oid": "efbf458d50d7766aa7a107a5070d954664a50c78", "committedDate": "2021-03-24 20:14:27 +0300", "message": "Improve performance of run-related requests"}]}, {"oid": "bf67280253bcc69263b1123ccefaaa2c35d96a55", "url": "https://github.com/epam/cloud-pipeline/commit/bf67280253bcc69263b1123ccefaaa2c35d96a55", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-26T10:37:35Z", "type": "forcePushed"}, {"oid": "82c057ac723a7a40750f14e3f33dab1e67adf2fd", "url": "https://github.com/epam/cloud-pipeline/commit/82c057ac723a7a40750f14e3f33dab1e67adf2fd", "message": "Issue #1404: tests for the first method in the ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:29:23Z", "type": "commit"}, {"oid": "24a40feb30c2b790ad1c83374c4dde2c79d73f06", "url": "https://github.com/epam/cloud-pipeline/commit/24a40feb30c2b790ad1c83374c4dde2c79d73f06", "message": "Issue #1404: implemented tests for ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:32:47Z", "type": "commit"}, {"oid": "b713464980ca18071bff2affee16237e96622694", "url": "https://github.com/epam/cloud-pipeline/commit/b713464980ca18071bff2affee16237e96622694", "message": "Issue #1404: Fixes and improvements for tests for ClusterApiService\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:33:41Z", "type": "commit"}, {"oid": "6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "url": "https://github.com/epam/cloud-pipeline/commit/6c4390756ebdefd9f7767d6a188efe76ea32ce8d", "message": "Issue #1404: Minor style improvements\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:13Z", "type": "commit"}, {"oid": "d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "url": "https://github.com/epam/cloud-pipeline/commit/d5032d1116022dc0b66feaf08fe117b0aeaba5ff", "message": "Issue #1404: Improvement tests for ClusterApiService and Creator utils refactoring\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:30Z", "type": "commit"}, {"oid": "4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "url": "https://github.com/epam/cloud-pipeline/commit/4de67cae0d0b0f38fbea62d7ffedcdd4a4e993c7", "message": "Issue #1404: Refactoring initAclEntity method\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:30Z", "type": "commit"}, {"oid": "f64b25fe398480c21040fb9e3421f798a9116097", "url": "https://github.com/epam/cloud-pipeline/commit/f64b25fe398480c21040fb9e3421f798a9116097", "message": "Issue #1404: Added valid masks check and fixes @WithMockUser arguments\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:30Z", "type": "commit"}, {"oid": "d992cff3e9c7e3d8f9f820dddf711c6143d73153", "url": "https://github.com/epam/cloud-pipeline/commit/d992cff3e9c7e3d8f9f820dddf711c6143d73153", "message": "Issue #1404: Tests improvements, redundant beans deleted, etc\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:36Z", "type": "commit"}, {"oid": "7122f50a1bc793226f27aedfc96c4960675f1370", "url": "https://github.com/epam/cloud-pipeline/commit/7122f50a1bc793226f27aedfc96c4960675f1370", "message": "Issue #1404: Refactoring in creatorUtils classes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:39Z", "type": "commit"}, {"oid": "c3237f3d382b414f66cb99688468c0695047be92", "url": "https://github.com/epam/cloud-pipeline/commit/c3237f3d382b414f66cb99688468c0695047be92", "message": "Issue #1404: Added license to the PipelineCreatorUtils and other minor style fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:39Z", "type": "commit"}, {"oid": "56eb51d9abb9460ccbae1ef5702f62a8982733c8", "url": "https://github.com/epam/cloud-pipeline/commit/56eb51d9abb9460ccbae1ef5702f62a8982733c8", "message": "Issue #1404: Improvements in the tests and in the mutableListOf method, changes in the PMD rules\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:34:59Z", "type": "commit"}, {"oid": "931c37811a89c4bfab582dde776e553cc335edac", "url": "https://github.com/epam/cloud-pipeline/commit/931c37811a89c4bfab582dde776e553cc335edac", "message": "Issue #1404: Minor test fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:35:08Z", "type": "commit"}, {"oid": "7e15b144352a5a05c200d537980c996e3901c89a", "url": "https://github.com/epam/cloud-pipeline/commit/7e15b144352a5a05c200d537980c996e3901c89a", "message": "Issue #1404: Minor refactoring done and merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:35:08Z", "type": "commit"}, {"oid": "407592030a6c68e0b23dc152e1bdd18487f38e08", "url": "https://github.com/epam/cloud-pipeline/commit/407592030a6c68e0b23dc152e1bdd18487f38e08", "message": "Issue #1404: Style (valid indentations) fixes\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:35:09Z", "type": "commit"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "url": "https://github.com/epam/cloud-pipeline/commit/7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:51:58Z", "type": "commit"}, {"oid": "7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "url": "https://github.com/epam/cloud-pipeline/commit/7396f37ba76eafa6d6c7c2c986c479c73d06f0f8", "message": "Issue #1404: Merge conflicts resolved\n\nSigned-off-by: Iurii_Kofanov <youkofan@gmail.com>", "committedDate": "2020-10-27T13:51:58Z", "type": "forcePushed"}]}