{"pr_number": 1921, "pr_title": "Addition of a new AmmoType equals method that only compares AmmoType \u2026", "pr_author": "ChaoticInsanity", "pr_createdAt": "2020-05-06T18:00:46Z", "pr_url": "https://github.com/MegaMek/megamek/pull/1921", "timeline": [{"oid": "9bc3ba4e3e0b1f2f46dd105dfd887947e0ecd95d", "url": "https://github.com/MegaMek/megamek/commit/9bc3ba4e3e0b1f2f46dd105dfd887947e0ecd95d", "message": "Addition of a new AmmoType equals method that only compares AmmoType and not rack size.\nThis fixes MekHQ issue 1665.", "committedDate": "2020-05-06T17:56:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MjE3OQ==", "url": "https://github.com/MegaMek/megamek/pull/1921#discussion_r420992179", "body": "I'm almost certain this will cause issues relating to being able to reuse AC2 ammo for AC20, etc.", "bodyText": "I'm almost certain this will cause issues relating to being able to reuse AC2 ammo for AC20, etc.", "bodyHTML": "<p dir=\"auto\">I'm almost certain this will cause issues relating to being able to reuse AC2 ammo for AC20, etc.</p>", "author": "Windchild292", "createdAt": "2020-05-06T18:10:32Z", "path": "megamek/src/megamek/common/AmmoType.java", "diffHunk": "@@ -402,30 +402,43 @@ public boolean equals(Object other) {\n         }\n         // there a couple of flags that need to be checked\n         if (getAmmoType() == T_MML) {\n-            if (hasFlag(F_MML_LRM) != ((AmmoType) other).hasFlag(F_MML_LRM)) {\n+            if (!matchingMMLFlags((AmmoType) other)) {\n                 return false;\n             }\n         }\n         if (getAmmoType() == T_AR10) {\n-            if (hasFlag(F_AR10_BARRACUDA) != ((AmmoType) other)\n-                    .hasFlag(F_AR10_BARRACUDA)) {\n+            if (!matchingAR10Flags((AmmoType) other)) {\n                 return false;\n             }\n-            if (hasFlag(F_AR10_WHITE_SHARK) != ((AmmoType) other)\n-                    .hasFlag(F_AR10_WHITE_SHARK)) {\n-                return false;\n-            }\n-            if (hasFlag(F_AR10_KILLER_WHALE) != ((AmmoType) other)\n-                    .hasFlag(F_AR10_KILLER_WHALE)) {\n+        }\n+        return ((getAmmoType() == ((AmmoType) other).getAmmoType()) && (getRackSize() == ((AmmoType) other)\n+                .getRackSize()));\n+    }\n+\n+    /**\n+     * When comparing <code>AmmoType</code>s, look at the ammoType only.\n+     *\n+     * @param other the <code>Object</code> to compare to this one.\n+     * @return <code>true</code> if the other is an <code>AmmoType</code> object\n+     *         of the same <code>ammoType</code> as this object. N.B. different\n+     *         munition types are still equal.\n+     */\n+    public boolean equalsAmmoTypeOnly(Object other) {\n+        if (!(other instanceof AmmoType)) {\n+            return false;\n+        }\n+        // there a couple of flags that need to be checked\n+        if (getAmmoType() == T_MML) {\n+            if (!matchingMMLFlags((AmmoType) other)) {\n                 return false;\n             }\n-            if (hasFlag(F_NUCLEAR) != ((AmmoType) other)\n-                    .hasFlag(F_NUCLEAR)) {\n+        }\n+        if (getAmmoType() == T_AR10) {\n+            if (!matchingAR10Flags((AmmoType) other)) {\n                 return false;\n             }\n         }\n-        return ((getAmmoType() == ((AmmoType) other).getAmmoType()) && (getRackSize() == ((AmmoType) other)\n-                .getRackSize()));\n+        return getAmmoType() == ((AmmoType) other).getAmmoType();\n     }", "originalCommit": "9bc3ba4e3e0b1f2f46dd105dfd887947e0ecd95d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5Njg3NA==", "url": "https://github.com/MegaMek/megamek/pull/1921#discussion_r420996874", "bodyText": "Actually you might be right I forgot to test that use case. Let me setup a new test campaign. My debug sessions were following the code path of missile racks and not ACs. The Acs might eventually reach the same predicate and use the new equals method which would cause a different bug.", "author": "ChaoticInsanity", "createdAt": "2020-05-06T18:18:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MjE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyNzk3Mg==", "url": "https://github.com/MegaMek/megamek/pull/1921#discussion_r421027972", "bodyText": "You were absolutely correct about the AC ammo. I have made a change in MekHQ so the predicate is based on the AMMO_BY_TYPE set. With this adjustment AC ammo is being compared correctly.", "author": "ChaoticInsanity", "createdAt": "2020-05-06T19:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MjE3OQ=="}], "type": "inlineReview"}, {"oid": "254788ab20c326a2e8e2968cbfb57107a90edd4c", "url": "https://github.com/MegaMek/megamek/commit/254788ab20c326a2e8e2968cbfb57107a90edd4c", "message": "Remove equals helper methods as they are no longer needed.\nMove all original Ammo flag checks from equals to equalsAmmoTypeOnly.\nModify equals to check equalsAmmoTypeOnly && rack size.", "committedDate": "2020-05-07T14:10:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUzNzI0NQ==", "url": "https://github.com/MegaMek/megamek/pull/1921#discussion_r421537245", "body": "```suggestion\r\n```", "bodyText": "Suggested change", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-05-07T14:14:05Z", "path": "megamek/src/megamek/common/AmmoType.java", "diffHunk": "@@ -397,6 +397,20 @@ public AmmoType() {\n      */\n     @Override\n     public boolean equals(Object other) {\n+", "originalCommit": "254788ab20c326a2e8e2968cbfb57107a90edd4c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "110418f09c43deef3faee716dc3a6fb538b54856", "url": "https://github.com/MegaMek/megamek/commit/110418f09c43deef3faee716dc3a6fb538b54856", "message": "Update megamek/src/megamek/common/AmmoType.java\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-05-07T14:21:50Z", "type": "commit"}]}