{"pr_number": 6968, "pr_title": "5439: InProcessTransport optionally adds causal information to status", "pr_author": "reggiemcdonald", "pr_createdAt": "2020-04-23T22:58:39Z", "pr_url": "https://github.com/grpc/grpc-java/pull/6968", "timeline": [{"oid": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "url": "https://github.com/grpc/grpc-java/commit/7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "message": "inprocess,internal: add ability to pass status cause to client", "committedDate": "2020-04-23T08:12:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4MjMwMA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414182300", "body": "nit: We normally don't set the field explicitly to its default, because it is just noisy. It is fine, though, and no need to change.", "bodyText": "nit: We normally don't set the field explicitly to its default, because it is just noisy. It is fine, though, and no need to change.", "bodyHTML": "<p dir=\"auto\">nit: We normally don't set the field explicitly to its default, because it is just noisy. It is fine, though, and no need to change.</p>", "author": "ejona86", "createdAt": "2020-04-23T23:07:41Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessChannelBuilder.java", "diffHunk": "@@ -70,6 +70,7 @@ public static InProcessChannelBuilder forAddress(String name, int port) {\n   private final String name;\n   private ScheduledExecutorService scheduledExecutorService;\n   private int maxInboundMetadataSize = Integer.MAX_VALUE;\n+  private boolean transportIncludeStatusCause = false;", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNjkzNA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415406934", "bodyText": "Will avoid this in the future \ud83d\ude42", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:39:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4MjMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4MjU3NA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414182574", "body": "Add an empty line before the `@` parts of the javadoc.", "bodyText": "Add an empty line before the @ parts of the javadoc.", "bodyHTML": "<p dir=\"auto\">Add an empty line before the <code>@</code> parts of the javadoc.</p>", "author": "ejona86", "createdAt": "2020-04-23T23:08:23Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessChannelBuilder.java", "diffHunk": "@@ -157,11 +158,22 @@ public InProcessChannelBuilder maxInboundMetadataSize(int bytes) {\n     return this;\n   }\n \n+  /**\n+   * Sets whether to override the default behaviour of InProcessTransport to include\n+   * the cause of the status.\n+   * @param enable whether to include cause in status", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNDg0NA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415404844", "bodyText": "done", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4MjU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NTA3Mg==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414185072", "body": "It is generally helpful to include some language about what the purpose of the method is. In this case we could say this is intended to make test failures more clear and easier to debug. We can also note that the default is to strip the cause for consistency with other transports. The cause information can normally leak information to untrusted clients and is language-specific, which aren't concerns for in-process.", "bodyText": "It is generally helpful to include some language about what the purpose of the method is. In this case we could say this is intended to make test failures more clear and easier to debug. We can also note that the default is to strip the cause for consistency with other transports. The cause information can normally leak information to untrusted clients and is language-specific, which aren't concerns for in-process.", "bodyHTML": "<p dir=\"auto\">It is generally helpful to include some language about what the purpose of the method is. In this case we could say this is intended to make test failures more clear and easier to debug. We can also note that the default is to strip the cause for consistency with other transports. The cause information can normally leak information to untrusted clients and is language-specific, which aren't concerns for in-process.</p>", "author": "ejona86", "createdAt": "2020-04-23T23:14:59Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessChannelBuilder.java", "diffHunk": "@@ -157,11 +158,22 @@ public InProcessChannelBuilder maxInboundMetadataSize(int bytes) {\n     return this;\n   }\n \n+  /**\n+   * Sets whether to override the default behaviour of InProcessTransport to include\n+   * the cause of the status.", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNDMwNQ==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415404305", "bodyText": "Good point \ud83d\ude42\nI added some documentation.", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:24:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NTA3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NTgwMQ==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414185801", "body": "Hmm... The name is a bit awkward. It seems hard to figure out a good name here. Options I thought of:\r\npropagateStatusCause\r\ncommunicateStatusCause\r\npropagateCauseWithStatus (inspired by the includeCauseWithStatus)\r\n\r\nDunno...", "bodyText": "Hmm... The name is a bit awkward. It seems hard to figure out a good name here. Options I thought of:\npropagateStatusCause\ncommunicateStatusCause\npropagateCauseWithStatus (inspired by the includeCauseWithStatus)\nDunno...", "bodyHTML": "<p dir=\"auto\">Hmm... The name is a bit awkward. It seems hard to figure out a good name here. Options I thought of:<br>\npropagateStatusCause<br>\ncommunicateStatusCause<br>\npropagateCauseWithStatus (inspired by the includeCauseWithStatus)</p>\n<p dir=\"auto\">Dunno...</p>", "author": "ejona86", "createdAt": "2020-04-23T23:16:47Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessChannelBuilder.java", "diffHunk": "@@ -157,11 +158,22 @@ public InProcessChannelBuilder maxInboundMetadataSize(int bytes) {\n     return this;\n   }\n \n+  /**\n+   * Sets whether to override the default behaviour of InProcessTransport to include\n+   * the cause of the status.\n+   * @param enable whether to include cause in status\n+   * @return this\n+   */\n+  public InProcessChannelBuilder transportIncludeStatusCause(boolean enable) {", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNDQ1OA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415404458", "bodyText": "I struggled with this also. I really think propagateCauseWithStatus is the most descriptive!\nAlso it follows nicely with the field name", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NTgwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NjgxNg==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414186816", "body": "Since InProcessTransport is package-private, we don't have to preserve the old constructor. Delete it?", "bodyText": "Since InProcessTransport is package-private, we don't have to preserve the old constructor. Delete it?", "bodyHTML": "<p dir=\"auto\">Since InProcessTransport is package-private, we don't have to preserve the old constructor. Delete it?</p>", "author": "ejona86", "createdAt": "2020-04-23T23:19:30Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessTransport.java", "diffHunk": "@@ -129,26 +131,39 @@ private InProcessTransport(String name, int maxInboundMetadataSize, String autho\n         .build();\n     this.optionalServerListener = optionalServerListener;\n     logId = InternalLogId.allocate(getClass(), name);\n+    this.includeCauseWithStatus = includeCauseWithStatus;\n   }\n \n   public InProcessTransport(", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNDg3NA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415404874", "bodyText": "done", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4NjgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4Nzg0Mg==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414187842", "body": "This doesn't appear used. Please delete it.", "bodyText": "This doesn't appear used. Please delete it.", "bodyHTML": "<p dir=\"auto\">This doesn't appear used. Please delete it.</p>", "author": "ejona86", "createdAt": "2020-04-23T23:22:07Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessTransport.java", "diffHunk": "@@ -323,6 +338,10 @@ public ScheduledExecutorService getScheduledExecutorService() {\n     return ret;\n   }\n \n+  public boolean getIncludeCauseWithStatus() {", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNDk0Mw==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415404943", "bodyText": "done", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4Nzg0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4OTAzMg==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414189032", "body": "We'd like this to be final if we can. I see it is mutated for testing. But I think we can make some tweaks to avoid that. I'll comment on the tests.", "bodyText": "We'd like this to be final if we can. I see it is mutated for testing. But I think we can make some tweaks to avoid that. I'll comment on the tests.", "bodyHTML": "<p dir=\"auto\">We'd like this to be final if we can. I see it is mutated for testing. But I think we can make some tweaks to avoid that. I'll comment on the tests.</p>", "author": "ejona86", "createdAt": "2020-04-23T23:25:26Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessTransport.java", "diffHunk": "@@ -83,6 +83,7 @@\n   private final String userAgent;\n   private final Optional<ServerListener> optionalServerListener;\n   private int serverMaxInboundMetadataSize;\n+  private boolean includeCauseWithStatus;", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNDk4NA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415404984", "bodyText": "done", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE4OTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5MzQ5NA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414193494", "body": "Note that this comment doesn't matter if the test gets reworked.\r\n\r\nThe implementation of this method in InProcessTransport is pretty straight-forward; you can just copy it here. Alternatively you can make a new protected method in InProcessTransport, `newClientTransport(InternalServer server, boolean includeStatusWithCause)` and call it here. Both options seem pretty fair and allow us to always pass includeStatusWithCause in the constructor.\r\n\r\n(When the number of arguments gets out of hand, we actually have a pattern to make that cleaner by passing in the builder/transportFactory to the constructor, and letting the constructor grab the things it needs. But it's not a big enough problem here yet to force you to rework that.)", "bodyText": "Note that this comment doesn't matter if the test gets reworked.\nThe implementation of this method in InProcessTransport is pretty straight-forward; you can just copy it here. Alternatively you can make a new protected method in InProcessTransport, newClientTransport(InternalServer server, boolean includeStatusWithCause) and call it here. Both options seem pretty fair and allow us to always pass includeStatusWithCause in the constructor.\n(When the number of arguments gets out of hand, we actually have a pattern to make that cleaner by passing in the builder/transportFactory to the constructor, and letting the constructor grab the things it needs. But it's not a big enough problem here yet to force you to rework that.)", "bodyHTML": "<p dir=\"auto\">Note that this comment doesn't matter if the test gets reworked.</p>\n<p dir=\"auto\">The implementation of this method in InProcessTransport is pretty straight-forward; you can just copy it here. Alternatively you can make a new protected method in InProcessTransport, <code>newClientTransport(InternalServer server, boolean includeStatusWithCause)</code> and call it here. Both options seem pretty fair and allow us to always pass includeStatusWithCause in the constructor.</p>\n<p dir=\"auto\">(When the number of arguments gets out of hand, we actually have a pattern to make that cleaner by passing in the builder/transportFactory to the constructor, and letting the constructor grab the things it needs. But it's not a big enough problem here yet to force you to rework that.)</p>", "author": "ejona86", "createdAt": "2020-04-23T23:36:52Z", "path": "core/src/test/java/io/grpc/inprocess/InProcessTransportTestWithCause.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.inprocess;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import io.grpc.Status;\n+import io.grpc.internal.InternalServer;\n+import io.grpc.internal.ManagedClientTransport;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@RunWith(JUnit4.class)\n+public class InProcessTransportTestWithCause extends InProcessTransportTest {\n+\n+  @Override\n+  protected ManagedClientTransport newClientTransport(InternalServer server) {\n+    InProcessTransport transport = (InProcessTransport) super.newClientTransport(server);", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDM1MQ==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r414204351", "body": "Hmm... Extending creates a lot of unnecessary tests.\r\n\r\nLet's create a new test from scratch. I'd basically start with [HelloWorldServerTest](https://github.com/grpc/grpc-java/blob/master/examples/src/test/java/io/grpc/examples/helloworld/HelloWorldServerTest.java), with some replacements. We don't want to deal with generated code here, so we can use [voidMethod()](https://grpc.github.io/grpc-java/javadoc/io/grpc/testing/TestMethodDescriptors.html#voidMethod--) and ClientCalls and implement the stub stuff ourselves.\r\n\r\n```java\r\n@Rule\r\npublic final GrpcCleanupRule grpcCleanup = new GrpcCleanupRule();\r\n\r\n...\r\nfinal Throwable t = new Throwable();\r\nServerServiceDefinition def = ServerServiceDefinition.builder(\"Failing\")\r\n    .addMethod(TestMethodDescriptors.voidMethod(), new ServerCallHandler<Void, Void>() {\r\n      @Override public ServerCall.Listener<Void> startCall(ServerCall<Void, Void> call, Metadata headers) {\r\n        call.close(Status.UNAVAILABLE.withDescription(\"best error message\").withCause(t), new Metadata());\r\n        return new ServerCall.Listener() {};\r\n      }\r\n    })\r\n    .build();\r\ngrpcCleanup.register(InProcessServerBuilder.forName(\"failing-server\").directExecutor().addService(def).build().start());\r\nChannel channel = grpcCleanup.register(InProcessChannelBuilder.forName(\"failing-server\").directExecutor().build());\r\ntry {\r\n  ClientCalls.blockingUnaryCall(channel, TestMethodDescriptors.voidMethod(), CallOptions.DEFAULT);\r\n  fail(\"expected exception\");\r\n} catch (StatusRuntimeException ex) {\r\n  assertEquals(t, ex.getCause());\r\n}\r\n```\r\n\r\nI've just \"dumped\" that out there; feel free to change formatting and organization. I also don't claim it is 100% correct :smile:. But it should be close.\r\n\r\nI know there are a lot of pieces there, but they are all virtually boilerplate. The only \"interesting\" things are creating the Throwable, call.close(), and catching StatusRuntimeException (which is how the blocking stub reports errors).", "bodyText": "Hmm... Extending creates a lot of unnecessary tests.\nLet's create a new test from scratch. I'd basically start with HelloWorldServerTest, with some replacements. We don't want to deal with generated code here, so we can use voidMethod() and ClientCalls and implement the stub stuff ourselves.\n@Rule\npublic final GrpcCleanupRule grpcCleanup = new GrpcCleanupRule();\n\n...\nfinal Throwable t = new Throwable();\nServerServiceDefinition def = ServerServiceDefinition.builder(\"Failing\")\n    .addMethod(TestMethodDescriptors.voidMethod(), new ServerCallHandler<Void, Void>() {\n      @Override public ServerCall.Listener<Void> startCall(ServerCall<Void, Void> call, Metadata headers) {\n        call.close(Status.UNAVAILABLE.withDescription(\"best error message\").withCause(t), new Metadata());\n        return new ServerCall.Listener() {};\n      }\n    })\n    .build();\ngrpcCleanup.register(InProcessServerBuilder.forName(\"failing-server\").directExecutor().addService(def).build().start());\nChannel channel = grpcCleanup.register(InProcessChannelBuilder.forName(\"failing-server\").directExecutor().build());\ntry {\n  ClientCalls.blockingUnaryCall(channel, TestMethodDescriptors.voidMethod(), CallOptions.DEFAULT);\n  fail(\"expected exception\");\n} catch (StatusRuntimeException ex) {\n  assertEquals(t, ex.getCause());\n}\nI've just \"dumped\" that out there; feel free to change formatting and organization. I also don't claim it is 100% correct \ud83d\ude04. But it should be close.\nI know there are a lot of pieces there, but they are all virtually boilerplate. The only \"interesting\" things are creating the Throwable, call.close(), and catching StatusRuntimeException (which is how the blocking stub reports errors).", "bodyHTML": "<p dir=\"auto\">Hmm... Extending creates a lot of unnecessary tests.</p>\n<p dir=\"auto\">Let's create a new test from scratch. I'd basically start with <a href=\"https://github.com/grpc/grpc-java/blob/master/examples/src/test/java/io/grpc/examples/helloworld/HelloWorldServerTest.java\">HelloWorldServerTest</a>, with some replacements. We don't want to deal with generated code here, so we can use <a href=\"https://grpc.github.io/grpc-java/javadoc/io/grpc/testing/TestMethodDescriptors.html#voidMethod--\" rel=\"nofollow\">voidMethod()</a> and ClientCalls and implement the stub stuff ourselves.</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"@Rule\npublic final GrpcCleanupRule grpcCleanup = new GrpcCleanupRule();\n\n...\nfinal Throwable t = new Throwable();\nServerServiceDefinition def = ServerServiceDefinition.builder(&quot;Failing&quot;)\n    .addMethod(TestMethodDescriptors.voidMethod(), new ServerCallHandler&lt;Void, Void&gt;() {\n      @Override public ServerCall.Listener&lt;Void&gt; startCall(ServerCall&lt;Void, Void&gt; call, Metadata headers) {\n        call.close(Status.UNAVAILABLE.withDescription(&quot;best error message&quot;).withCause(t), new Metadata());\n        return new ServerCall.Listener() {};\n      }\n    })\n    .build();\ngrpcCleanup.register(InProcessServerBuilder.forName(&quot;failing-server&quot;).directExecutor().addService(def).build().start());\nChannel channel = grpcCleanup.register(InProcessChannelBuilder.forName(&quot;failing-server&quot;).directExecutor().build());\ntry {\n  ClientCalls.blockingUnaryCall(channel, TestMethodDescriptors.voidMethod(), CallOptions.DEFAULT);\n  fail(&quot;expected exception&quot;);\n} catch (StatusRuntimeException ex) {\n  assertEquals(t, ex.getCause());\n}\"><pre><span class=\"pl-k\">@Rule</span>\n<span class=\"pl-k\">public</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">GrpcCleanupRule</span> grpcCleanup <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">GrpcCleanupRule</span>();\n\n<span class=\"pl-c1\">...</span>\n<span class=\"pl-k\">final</span> <span class=\"pl-smi\">Throwable</span> t <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">Throwable</span>();\n<span class=\"pl-smi\">ServerServiceDefinition</span> def <span class=\"pl-k\">=</span> <span class=\"pl-smi\">ServerServiceDefinition</span><span class=\"pl-k\">.</span>builder(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Failing<span class=\"pl-pds\">\"</span></span>)\n    .addMethod(<span class=\"pl-smi\">TestMethodDescriptors</span><span class=\"pl-k\">.</span>voidMethod(), <span class=\"pl-k\">new</span> <span class=\"pl-k\">ServerCallHandler&lt;<span class=\"pl-smi\">Void</span>, <span class=\"pl-smi\">Void</span>&gt;</span>() {\n      <span class=\"pl-k\">@Override</span> <span class=\"pl-k\">public</span> <span class=\"pl-smi\">ServerCall</span>.<span class=\"pl-k\">Listener&lt;<span class=\"pl-smi\">Void</span>&gt;</span> <span class=\"pl-en\">startCall</span>(<span class=\"pl-k\">ServerCall&lt;<span class=\"pl-smi\">Void</span>, <span class=\"pl-smi\">Void</span>&gt;</span> <span class=\"pl-v\">call</span>, <span class=\"pl-smi\">Metadata</span> <span class=\"pl-v\">headers</span>) {\n        call<span class=\"pl-k\">.</span>close(<span class=\"pl-smi\">Status</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>UNAVAILABLE</span><span class=\"pl-k\">.</span>withDescription(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>best error message<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>withCause(t), <span class=\"pl-k\">new</span> <span class=\"pl-smi\">Metadata</span>());\n        <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ServerCall</span>.<span class=\"pl-smi\">Listener</span>() {};\n      }\n    })\n    .build();\ngrpcCleanup<span class=\"pl-k\">.</span>register(<span class=\"pl-smi\">InProcessServerBuilder</span><span class=\"pl-k\">.</span>forName(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>failing-server<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>directExecutor()<span class=\"pl-k\">.</span>addService(def)<span class=\"pl-k\">.</span>build()<span class=\"pl-k\">.</span>start());\n<span class=\"pl-smi\">Channel</span> channel <span class=\"pl-k\">=</span> grpcCleanup<span class=\"pl-k\">.</span>register(<span class=\"pl-smi\">InProcessChannelBuilder</span><span class=\"pl-k\">.</span>forName(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>failing-server<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>directExecutor()<span class=\"pl-k\">.</span>build());\n<span class=\"pl-k\">try</span> {\n  <span class=\"pl-smi\">ClientCalls</span><span class=\"pl-k\">.</span>blockingUnaryCall(channel, <span class=\"pl-smi\">TestMethodDescriptors</span><span class=\"pl-k\">.</span>voidMethod(), <span class=\"pl-smi\">CallOptions</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>DEFAULT</span>);\n  fail(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>expected exception<span class=\"pl-pds\">\"</span></span>);\n} <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">StatusRuntimeException</span> ex) {\n  assertEquals(t, ex<span class=\"pl-k\">.</span>getCause());\n}</pre></div>\n<p dir=\"auto\">I've just \"dumped\" that out there; feel free to change formatting and organization. I also don't claim it is 100% correct <g-emoji class=\"g-emoji\" alias=\"smile\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f604.png\">\ud83d\ude04</g-emoji>. But it should be close.</p>\n<p dir=\"auto\">I know there are a lot of pieces there, but they are all virtually boilerplate. The only \"interesting\" things are creating the Throwable, call.close(), and catching StatusRuntimeException (which is how the blocking stub reports errors).</p>", "author": "ejona86", "createdAt": "2020-04-24T00:06:33Z", "path": "core/src/test/java/io/grpc/inprocess/InProcessTransportTestWithCause.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 The gRPC Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.grpc.inprocess;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+import io.grpc.Status;\n+import io.grpc.internal.InternalServer;\n+import io.grpc.internal.ManagedClientTransport;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@RunWith(JUnit4.class)\n+public class InProcessTransportTestWithCause extends InProcessTransportTest {", "originalCommit": "7f6453a7d04ca5acd29cb6a4766de3efef4997eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTQwNzAzNQ==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r415407035", "bodyText": "I followed your advice with the test case. I made some small changes to it, but by and large it worked great!\nOrganization-wise, I moved the new test case into the InProcessTransportTest class because I thought that it belonged there. But for this to work, I had to expose the field server in AbstractTransportTest:\n\n  \n    \n      grpc-java/core/src/test/java/io/grpc/internal/AbstractTransportTest.java\n    \n    \n        Lines 158 to 161\n      in\n      2efad75\n    \n    \n    \n    \n\n        \n          \n              * tests in an indeterminate state. \n        \n\n        \n          \n              */ \n        \n\n        \n          \n             protected InternalServer server; \n        \n\n        \n          \n             private ServerTransport serverTransport; \n        \n    \n  \n\n\nso that I could set server=null. I had to do this because the after each hook in AbstractTransportTest would try to call server.shutdown if I didnt (which would fail since I dont start that server in the test case).\n\n  \n    \n      grpc-java/core/src/test/java/io/grpc/internal/AbstractTransportTest.java\n    \n    \n        Lines 230 to 242\n      in\n      2efad75\n    \n    \n    \n    \n\n        \n          \n           @After \n        \n\n        \n          \n           public void tearDown() throws InterruptedException { \n        \n\n        \n          \n             if (client != null) { \n        \n\n        \n          \n               client.shutdownNow(Status.UNKNOWN.withDescription(\"teardown\")); \n        \n\n        \n          \n             } \n        \n\n        \n          \n             if (serverTransport != null) { \n        \n\n        \n          \n               serverTransport.shutdownNow(Status.UNKNOWN.withDescription(\"teardown\")); \n        \n\n        \n          \n             } \n        \n\n        \n          \n             if (server != null) { \n        \n\n        \n          \n               server.shutdown(); \n        \n\n        \n          \n               assertTrue(serverListener.waitForShutdown(TIMEOUT_MS, TimeUnit.MILLISECONDS)); \n        \n\n        \n          \n             } \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nSo I'm not sure whether this was the right move. That being said I'm happy to change it!\nAnd thank you so much for all the help and pointers you've been giving me \ud83d\ude42", "author": "reggiemcdonald", "createdAt": "2020-04-26T21:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIwNDM1MQ=="}], "type": "inlineReview"}, {"oid": "c9270e24ea716af9f4c5995674cbd4db6066ce1b", "url": "https://github.com/grpc/grpc-java/commit/c9270e24ea716af9f4c5995674cbd4db6066ce1b", "message": "inprocess: improve javadocs and method name for InProcessChannelBuilder.propagateCauseWithStatus\n\nAddresses comment in PR to change method name tranportIncludeStatusCause to something more descriptive: propagateCauseWithStatus. Updates javadoc to better describe what the propagateCauseWithStatus setting does - including the default behaviour of the method.", "committedDate": "2020-04-26T07:11:59Z", "type": "commit"}, {"oid": "e85eac9c20848cb43d5dd3b7b0641522e592e68a", "url": "https://github.com/grpc/grpc-java/commit/e85eac9c20848cb43d5dd3b7b0641522e592e68a", "message": "inprocess: remove unused method\n\nAddressing PR feedback, this commit removes the getter from InProcessTransport that is not used in the codebase.", "committedDate": "2020-04-26T09:10:57Z", "type": "commit"}, {"oid": "2efad75c7b0895419d8465a1a410acb8c0b28569", "url": "https://github.com/grpc/grpc-java/commit/2efad75c7b0895419d8465a1a410acb8c0b28569", "message": "inprocess, internal: creates single test to check for propagating cause with status\n\nTo address a PR comment, this commit makes the includeCauseWithStatus field of the InProcessTransport final, and adds a single test case to verify that the cause is propagated properly when configured. The field server of AbstractTransportTest had to be made protected so that it could be nullified in the test case for the after each hook.", "committedDate": "2020-04-26T21:22:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4Mzg2MA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r419783860", "body": "Deleting these lines concerns me. Is this necessary?", "bodyText": "Deleting these lines concerns me. Is this necessary?", "bodyHTML": "<p dir=\"auto\">Deleting these lines concerns me. Is this necessary?</p>", "author": "ejona86", "createdAt": "2020-05-04T23:18:50Z", "path": "core/src/test/java/io/grpc/internal/AbstractTransportTest.java", "diffHunk": "@@ -1219,9 +1210,6 @@ public void clientCancel() throws Exception {\n     assertNotNull(clientStreamListener.trailers.get(TIMEOUT_MS, TimeUnit.MILLISECONDS));\n     Status serverStatus = serverStreamListener.status.get(TIMEOUT_MS, TimeUnit.MILLISECONDS);\n     assertNotEquals(Status.Code.OK, serverStatus.getCode());\n-    // Cause should not be transmitted between client and server", "originalCommit": "2efad75c7b0895419d8465a1a410acb8c0b28569", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM1MDY0NQ==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r420350645", "bodyText": "You're right, not necessary! I will add the assertion back in", "author": "reggiemcdonald", "createdAt": "2020-05-05T19:23:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc4Mzg2MA=="}], "type": "inlineReview"}, {"oid": "4ac7bebf950c95ec37f927cf2b1bbfc59a26d2d8", "url": "https://github.com/grpc/grpc-java/commit/4ac7bebf950c95ec37f927cf2b1bbfc59a26d2d8", "message": "internal: Add back assertnull assertion for server status\n\nThis commit addresses PR feedback by adding back a null assertion. Default behaviour for transports is to strip cause from status. So in AbstractTransportTest.clientCancel, server status should have a null cause.", "committedDate": "2020-05-05T20:16:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0MzkwNA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r420443904", "body": "The method name, the argument, and the javadoc do not match.", "bodyText": "The method name, the argument, and the javadoc do not match.", "bodyHTML": "<p dir=\"auto\">The method name, the argument, and the javadoc do not match.</p>", "author": "dapengzhang0", "createdAt": "2020-05-05T22:27:47Z", "path": "core/src/main/java/io/grpc/inprocess/InProcessTransport.java", "diffHunk": "@@ -849,13 +853,17 @@ public void appendTimeoutInsight(InsightBuilder insight) {\n    * <p>This is, so that the InProcess transport behaves in the same way as the other transports,\n    * when exchanging statuses between client and server and vice versa.\n    */\n-  private static Status stripCause(Status status) {\n+  private static Status stripCause(Status status, boolean includeCauseWithStatus) {", "originalCommit": "4ac7bebf950c95ec37f927cf2b1bbfc59a26d2d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NzU4MQ==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r420447581", "bodyText": "Not quite sure what you mean. Where is the discrepancy?", "author": "reggiemcdonald", "createdAt": "2020-05-05T22:36:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0MzkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ1MzEwMA==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r420453100", "bodyText": "I think he's referring to where it says \"but stripped of any other information (i.e. cause)\"", "author": "ejona86", "createdAt": "2020-05-05T22:50:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0MzkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3MjgyMg==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r420472822", "bodyText": "Where is the discrepancy?\n\nThe method name says \"strip cause\"\nThe javadoc says \"strip something, i.e. cause\"\nThe new argument says \"do not strip cause if true\".", "author": "dapengzhang0", "createdAt": "2020-05-05T23:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0MzkwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ3MzIxMQ==", "url": "https://github.com/grpc/grpc-java/pull/6968#discussion_r420473211", "bodyText": "Ok gotcha. I'll update the javadoc and method name", "author": "reggiemcdonald", "createdAt": "2020-05-05T23:48:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0MzkwNA=="}], "type": "inlineReview"}, {"oid": "d27e0756800079ba0325472ddedf2134f6e66b68", "url": "https://github.com/grpc/grpc-java/commit/d27e0756800079ba0325472ddedf2134f6e66b68", "message": "inprocess: rename InProccessTransport.stripCause to InProcessTransport.cleanStatus and update javadoc\n\nThis commit addresses PR feedback by renaming InProcessTransport.stripCause to InProcessTransport.cleanStatus and updating the javadoc, to better reflect the fact that the status can now optionally include cause.", "committedDate": "2020-05-06T00:31:55Z", "type": "commit"}]}