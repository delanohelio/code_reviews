{"pr_number": 2565, "pr_title": "Add docs for startup strategy information/examples (#1157)", "pr_author": "vcvitaly", "pr_createdAt": "2020-04-13T15:27:18Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/2565", "timeline": [{"oid": "49099d69fb2e6a039cbeafdb0bc0020dd78ffd93", "url": "https://github.com/testcontainers/testcontainers-java/commit/49099d69fb2e6a039cbeafdb0bc0020dd78ffd93", "message": "Add startup strategy information/examples to mkdocs #1157", "committedDate": "2020-04-13T15:13:20Z", "type": "commit"}, {"oid": "dbb06d10a779e000f3d280eff491fe523dd139f0", "url": "https://github.com/testcontainers/testcontainers-java/commit/dbb06d10a779e000f3d280eff491fe523dd139f0", "message": "Merge branch 'master' into feature/1157/startup_strategy_docs", "committedDate": "2020-04-19T09:05:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4ODU4NA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2565#discussion_r425088584", "body": "It does seem slightly odd to use a timeout with this strategy - is it intentional?\r\n\r\nI'd suggest just:\r\n```suggestion\r\n                new IndefiniteWaitOneShotStartupCheckStrategy()\r\n```\r\nshould be appropriate...", "bodyText": "It does seem slightly odd to use a timeout with this strategy - is it intentional?\nI'd suggest just:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            new IndefiniteWaitOneShotStartupCheckStrategy().withTimeout(Duration.ofSeconds(3))\n          \n          \n            \n                            new IndefiniteWaitOneShotStartupCheckStrategy()\n          \n      \n    \n    \n  \n\nshould be appropriate...", "bodyHTML": "<p dir=\"auto\">It does seem slightly odd to use a timeout with this strategy - is it intentional?</p>\n<p dir=\"auto\">I'd suggest just:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IndefiniteWaitOneShotStartupCheckStrategy</span>()<span class=\"pl-k x x-first\">.</span><span class=\"x\">withTimeout(</span><span class=\"pl-smi x\">Duration</span><span class=\"pl-k x\">.</span><span class=\"x\">ofSeconds(</span><span class=\"pl-c1 x\">3</span><span class=\"x x-last\">))</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IndefiniteWaitOneShotStartupCheckStrategy</span>()</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">should be appropriate...</p>", "author": "rnorth", "createdAt": "2020-05-14T12:13:04Z", "path": "docs/examples/junit4/generic/src/test/java/org/testcontainers/containers/startupcheck/StartupCheckStrategyTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+package org.testcontainers.containers.startupcheck;\n+\n+import java.time.Duration;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import lombok.SneakyThrows;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Suite;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.output.WaitingConsumer;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.testcontainers.containers.output.OutputFrame.OutputType.STDOUT;\n+import static org.testcontainers.containers.startupcheck.StartupCheckStrategyTest.IndefiniteOneShotStrategyTest;\n+import static org.testcontainers.containers.startupcheck.StartupCheckStrategyTest.MinimumDurationStrategyTest;\n+import static org.testcontainers.containers.startupcheck.StartupCheckStrategyTest.OneShotStrategyTest;\n+\n+@RunWith(Suite.class)\n+@Suite.SuiteClasses({OneShotStrategyTest.class, IndefiniteOneShotStrategyTest.class, MinimumDurationStrategyTest.class})\n+public class StartupCheckStrategyTest {\n+\n+    private static final String HELLO_TESTCONTAINERS = \"Hello Testcontainers!\";\n+\n+    private static void waitForHello(GenericContainer container) throws TimeoutException {\n+        WaitingConsumer consumer = new WaitingConsumer();\n+        container.followOutput(consumer, STDOUT);\n+\n+        consumer.waitUntil(frame ->\n+            frame.getUtf8String().contains(HELLO_TESTCONTAINERS), 30, TimeUnit.SECONDS);\n+    }\n+\n+    public static class OneShotStrategyTest {\n+        @Rule\n+        // withOneShotStrategy {\n+        public GenericContainer bboxWithOneShot = new GenericContainer(\"busybox:1.31.1\")\n+            .withCommand(String.format(\"echo %s\", HELLO_TESTCONTAINERS))\n+            .withStartupCheckStrategy(\n+                new OneShotStartupCheckStrategy().withTimeout(Duration.ofSeconds(3))\n+            );\n+        // }\n+\n+        @SneakyThrows\n+        @Test\n+        public void testCommandIsExecuted() {\n+            waitForHello(bboxWithOneShot);\n+\n+            assertThat(bboxWithOneShot.isRunning()).isFalse();\n+        }\n+    }\n+\n+    public static class IndefiniteOneShotStrategyTest {\n+        @Rule\n+        // withIndefiniteOneShotStrategy {\n+        public GenericContainer bboxWithIndefiniteOneShot = new GenericContainer(\"busybox:1.31.1\")\n+            .withCommand(\"sh\", \"-c\", String.format(\"sleep 5 && echo \\\"%s\\\"\", HELLO_TESTCONTAINERS))\n+            .withStartupCheckStrategy(\n+                new IndefiniteWaitOneShotStartupCheckStrategy().withTimeout(Duration.ofSeconds(3))", "originalCommit": "dbb06d10a779e000f3d280eff491fe523dd139f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczNDQwNA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2565#discussion_r428734404", "bodyText": "Will apply and merge.", "author": "rnorth", "createdAt": "2020-05-21T15:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4ODU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc1ODIyMQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/2565#discussion_r428758221", "bodyText": "@rnorth I'm sorry for not replying earlier, I was a little busy, but once I saw that you are going to merge I decided to reply straight away :)\nThat was intentional to show that even though timeout is 3 sec, the command executed on startup won't be interrupted and will continue executing as long as required (which is 5 sec)", "author": "vcvitaly", "createdAt": "2020-05-21T16:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA4ODU4NA=="}], "type": "inlineReview"}, {"oid": "839fa6c4889f74884d4213a2c7bbd45a487390cd", "url": "https://github.com/testcontainers/testcontainers-java/commit/839fa6c4889f74884d4213a2c7bbd45a487390cd", "message": "Update docs/examples/junit4/generic/src/test/java/org/testcontainers/containers/startupcheck/StartupCheckStrategyTest.java", "committedDate": "2020-05-21T15:39:01Z", "type": "commit"}, {"oid": "ad458ae32290434ca2c67c74e99f343b579fbf27", "url": "https://github.com/testcontainers/testcontainers-java/commit/ad458ae32290434ca2c67c74e99f343b579fbf27", "message": "Merge branch 'master' into feature/1157/startup_strategy_docs", "committedDate": "2020-05-21T15:39:34Z", "type": "commit"}]}