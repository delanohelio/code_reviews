{"pr_number": 3015, "pr_title": "Improve log messages when database container test query fails", "pr_author": "vcvitaly", "pr_createdAt": "2020-07-24T09:43:54Z", "pr_url": "https://github.com/testcontainers/testcontainers-java/pull/3015", "timeline": [{"oid": "8f37d452b6580c6f10718a927dc9d1bc85d1cb6c", "url": "https://github.com/testcontainers/testcontainers-java/commit/8f37d452b6580c6f10718a927dc9d1bc85d1cb6c", "message": "Refactor, remove `waitUntilContainerStarted()` where it's behaviour is not overriden", "committedDate": "2020-07-11T13:05:50Z", "type": "commit"}, {"oid": "7c266ad80fc1278c87c43cf84d2dfab4dec24f2f", "url": "https://github.com/testcontainers/testcontainers-java/commit/7c266ad80fc1278c87c43cf84d2dfab4dec24f2f", "message": "Add logger cache", "committedDate": "2020-07-11T18:04:47Z", "type": "commit"}, {"oid": "b8038b2a1b7ba7649c91f390c25147ecccfea433", "url": "https://github.com/testcontainers/testcontainers-java/commit/b8038b2a1b7ba7649c91f390c25147ecccfea433", "message": "Throw an exception if container is not accessible by jdbc url", "committedDate": "2020-07-24T09:36:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk1NTAzNQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r459955035", "body": "No sure if it was made on purpose. The local variable hides the instance variable and seemed redundant.", "bodyText": "No sure if it was made on purpose. The local variable hides the instance variable and seemed redundant.", "bodyHTML": "<p dir=\"auto\">No sure if it was made on purpose. The local variable hides the instance variable and seemed redundant.</p>", "author": "vcvitaly", "createdAt": "2020-07-24T09:45:09Z", "path": "core/src/main/java/org/testcontainers/containers/GenericContainer.java", "diffHunk": "@@ -867,7 +868,6 @@ public void setWaitStrategy(org.testcontainers.containers.wait.strategy.WaitStra\n      * @see #waitingFor(org.testcontainers.containers.wait.strategy.WaitStrategy)\n      */\n     protected void waitUntilContainerStarted() {\n-        org.testcontainers.containers.wait.strategy.WaitStrategy waitStrategy = getWaitStrategy();", "originalCommit": "b8038b2a1b7ba7649c91f390c25147ecccfea433", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8038b2a1b7ba7649c91f390c25147ecccfea433", "url": "https://github.com/testcontainers/testcontainers-java/commit/b8038b2a1b7ba7649c91f390c25147ecccfea433", "message": "Throw an exception if container is not accessible by jdbc url", "committedDate": "2020-07-24T09:36:32Z", "type": "forcePushed"}, {"oid": "60761b7f06c396cd96e2fb42d4abbf19501a122f", "url": "https://github.com/testcontainers/testcontainers-java/commit/60761b7f06c396cd96e2fb42d4abbf19501a122f", "message": "Revert changes unrelated to the issue", "committedDate": "2020-07-24T10:22:23Z", "type": "commit"}, {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e", "url": "https://github.com/testcontainers/testcontainers-java/commit/335fdec3df5915ca74a4171379e2e318b99fc87e", "message": "#2878 write a test for the <exception> case", "committedDate": "2020-08-25T05:47:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkyNzg0OQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r565927849", "body": "Just an idea: \r\nI wonder if `Unreliables` can be used in this case to reduce complexity of all that `while sleep` construction ? @bsideup @rnorth @kiview whats your opinion on that ? \r\n\r\nI know that it was historically written that way, but imho that would really helped if that test would be rewritten without any sleep in here ", "bodyText": "Just an idea:\nI wonder if Unreliables can be used in this case to reduce complexity of all that while sleep construction ? @bsideup @rnorth @kiview whats your opinion on that ?\nI know that it was historically written that way, but imho that would really helped if that test would be rewritten without any sleep in here", "bodyHTML": "<p dir=\"auto\">Just an idea:<br>\nI wonder if <code>Unreliables</code> can be used in this case to reduce complexity of all that <code>while sleep</code> construction ? <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/bsideup/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/bsideup\">@bsideup</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/rnorth/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/rnorth\">@rnorth</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/kiview/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/kiview\">@kiview</a> whats your opinion on that ?</p>\n<p dir=\"auto\">I know that it was historically written that way, but imho that would really helped if that test would be rewritten without any sleep in here</p>", "author": "artjomka", "createdAt": "2021-01-28T09:09:16Z", "path": "modules/jdbc/src/main/java/org/testcontainers/containers/JdbcDatabaseContainer.java", "diffHunk": "@@ -122,25 +124,23 @@ public SELF withInitScript(String initScriptPath) {\n         return self();\n     }\n \n+    @SneakyThrows(InterruptedException.class)\n     @Override\n     protected void waitUntilContainerStarted() {\n         logger().info(\"Waiting for database connection to become available at {} using query '{}'\", getJdbcUrl(), getTestQueryString());\n \n         // Repeatedly try and open a connection to the DB and execute a test query\n         long start = System.currentTimeMillis();\n-        try {\n-            while (System.currentTimeMillis() < start + (1000 * startupTimeoutSeconds)) {\n-                try {\n-                    if (!isRunning()) {\n-                        Thread.sleep(100L);\n-                        continue; // Don't attempt to connect yet\n-                    }\n \n-                    try (Connection connection = createConnection(\"\")) {\n-                        boolean testQuerySucceeded = connection.createStatement().execute(this.getTestQueryString());\n-                        if (testQuerySucceeded) {\n-                            break;\n-                        }\n+        while (System.currentTimeMillis() < start + (1000 * startupTimeoutSeconds)) {", "originalCommit": "335fdec3df5915ca74a4171379e2e318b99fc87e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjA5NTU2OA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r566095568", "bodyText": "This is a good question, maybe @rnorth has an idea, why Unrealiables isn't a good idea here. Else, I would suppose it is a good change.", "author": "kiview", "createdAt": "2021-01-28T13:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkyNzg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ0NzkzMQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r571447931", "bodyText": "I second that!", "author": "bsideup", "createdAt": "2021-02-06T15:24:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkyNzg0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjE2MDE2OQ==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r576160169", "bodyText": "I don't believe that Unreliables would work here since there is the clause:\ncatch (NoDriverFoundException e) {\n                    // we explicitly want this exception to fail fast without retries\n                    throw e;\n}\n\nand Unreliables waits until a timeout is reached no matter what. Don't have time now to check, but probably using Unreliables might make it only more complicated.", "author": "vcvitaly", "createdAt": "2021-02-15T12:32:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkyNzg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkzMzM0NA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r565933344", "body": "I wonder what exactly `tan` prefix means ? :) \r\nAlso I would suggest to use `should` prefix in test names for codebase consistency for example `shouldThrowProperExceptionOnUnavailableConnection` just as an idea", "bodyText": "I wonder what exactly tan prefix means ? :)\nAlso I would suggest to use should prefix in test names for codebase consistency for example shouldThrowProperExceptionOnUnavailableConnection just as an idea", "bodyHTML": "<p dir=\"auto\">I wonder what exactly <code>tan</code> prefix means ? :)<br>\nAlso I would suggest to use <code>should</code> prefix in test names for codebase consistency for example <code>shouldThrowProperExceptionOnUnavailableConnection</code> just as an idea</p>", "author": "artjomka", "createdAt": "2021-01-28T09:17:26Z", "path": "modules/jdbc/src/test/java/org/testcontainers/containers/JdbcDatabaseContainerTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.testcontainers.containers;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import lombok.NonNull;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+import static org.mockito.Mockito.mock;\n+\n+public class JdbcDatabaseContainerTest {\n+\n+    @Test\n+    public void tanExceptionIsThrownIfJdbcIsNotAvailable() {", "originalCommit": "335fdec3df5915ca74a4171379e2e318b99fc87e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjA5NDY3MA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r566094670", "bodyText": "I suppose this is a typo and it was supposed to mean anExceptionIsThrownIfJdbcIsNotAvailable \ud83d\ude42", "author": "kiview", "createdAt": "2021-01-28T13:31:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkzMzM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ0NzkxMw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r571447913", "body": "```suggestion\r\n    public void anExceptionIsThrownIfJdbcIsNotAvailable() {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void tanExceptionIsThrownIfJdbcIsNotAvailable() {\n          \n          \n            \n                public void anExceptionIsThrownIfJdbcIsNotAvailable() {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">tanExceptionIsThrownIfJdbcIsNotAvailable</span>() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">anExceptionIsThrownIfJdbcIsNotAvailable</span>() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bsideup", "createdAt": "2021-02-06T15:24:16Z", "path": "modules/jdbc/src/test/java/org/testcontainers/containers/JdbcDatabaseContainerTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.testcontainers.containers;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import lombok.NonNull;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+import static org.mockito.Mockito.mock;\n+\n+public class JdbcDatabaseContainerTest {\n+\n+    @Test\n+    public void tanExceptionIsThrownIfJdbcIsNotAvailable() {", "originalCommit": "335fdec3df5915ca74a4171379e2e318b99fc87e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjE2MTAwMw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r576161003", "bodyText": "Thanks, I committed the suggestion, that was just a typo, you are right.", "author": "vcvitaly", "createdAt": "2021-02-15T12:34:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ0NzkxMw=="}], "type": "inlineReview"}, {"oid": "e899dc4581bfc7943f1f44756a7c0d94f684ac18", "url": "https://github.com/testcontainers/testcontainers-java/commit/e899dc4581bfc7943f1f44756a7c0d94f684ac18", "message": "Fix a typo in a test method name\n\nCo-authored-by: Sergei Egorov <bsideup@gmail.com>", "committedDate": "2021-02-15T11:30:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODI1MTY0NA==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r628251644", "body": "Super tiny nit, but I think this can be reduced to:\r\n```suggestion\r\n                this.getJdbcUrl())\r\n```\r\n\r\nOther than that though, and an unfortunate merge conflict that I don't have permission to resolve, I think this PR is fine.", "bodyText": "Super tiny nit, but I think this can be reduced to:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            JdbcDatabaseContainer.this.getJdbcUrl())\n          \n          \n            \n                            this.getJdbcUrl())\n          \n      \n    \n    \n  \n\nOther than that though, and an unfortunate merge conflict that I don't have permission to resolve, I think this PR is fine.", "bodyHTML": "<p dir=\"auto\">Super tiny nit, but I think this can be reduced to:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi x x-first\">JdbcDatabaseContainer</span><span class=\"pl-k x x-last\">.</span><span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>getJdbcUrl())</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>getJdbcUrl())</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Other than that though, and an unfortunate merge conflict that I don't have permission to resolve, I think this PR is fine.</p>", "author": "rnorth", "createdAt": "2021-05-07T14:24:29Z", "path": "modules/jdbc/src/main/java/org/testcontainers/containers/JdbcDatabaseContainer.java", "diffHunk": "@@ -151,12 +151,12 @@ protected void waitUntilContainerStarted() {\n                     Thread.sleep(100L);\n                 }\n             }\n-        } catch (InterruptedException e) {\n-            Thread.currentThread().interrupt();\n-            throw new ContainerLaunchException(\"Container startup wait was interrupted\", e);\n         }\n \n-        logger().info(\"Container is started (JDBC URL: {})\", JdbcDatabaseContainer.this.getJdbcUrl());\n+        throw new IllegalStateException(\n+            String.format(\"Container is started, but cannot be accessed by (JDBC URL: %s), please check container logs\",\n+                JdbcDatabaseContainer.this.getJdbcUrl())", "originalCommit": "e899dc4581bfc7943f1f44756a7c0d94f684ac18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTM5NzIyNw==", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r629397227", "bodyText": "I updated that JdbcDatabaseContainer.this.getJdbcUrl()), also resolved the conflict. Thanks for the review.", "author": "vcvitaly", "createdAt": "2021-05-10T14:15:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODI1MTY0NA=="}], "type": "inlineReview"}, {"oid": "a67b9cf6c44fb2bc9402f464595ff1338fbdb09a", "url": "https://github.com/testcontainers/testcontainers-java/commit/a67b9cf6c44fb2bc9402f464595ff1338fbdb09a", "message": "Update as per PR review", "committedDate": "2021-05-10T14:06:24Z", "type": "commit"}, {"oid": "70b17f9365f1452b4d9046e8e3045aeb49665996", "url": "https://github.com/testcontainers/testcontainers-java/commit/70b17f9365f1452b4d9046e8e3045aeb49665996", "message": "Merge remote-tracking branch 'upstream/master' into 2878/jdbc_container_start_timeout\n\n# Conflicts:\n#\tmodules/jdbc/build.gradle", "committedDate": "2021-05-10T14:14:17Z", "type": "commit"}]}