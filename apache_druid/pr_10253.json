{"pr_number": 10253, "pr_title": "Allow forceLimitPushDown in SQL", "pr_author": "jihoonson", "pr_createdAt": "2020-08-07T05:22:51Z", "pr_url": "https://github.com/apache/druid/pull/10253", "timeline": [{"oid": "0a1081f723f4e7429702802d5b355379d3b7170d", "url": "https://github.com/apache/druid/commit/0a1081f723f4e7429702802d5b355379d3b7170d", "message": "Allow forceLimitPushDown in SQL", "committedDate": "2020-08-07T05:20:11Z", "type": "commit"}, {"oid": "04da9cfe14e23e3d5f0eea7678d8c331c9af7497", "url": "https://github.com/apache/druid/commit/04da9cfe14e23e3d5f0eea7678d8c331c9af7497", "message": "fix test", "committedDate": "2020-08-07T16:30:16Z", "type": "commit"}, {"oid": "8f63335e145685d2af61493da22ad3f6cf4c061f", "url": "https://github.com/apache/druid/commit/8f63335e145685d2af61493da22ad3f6cf4c061f", "message": "fix test", "committedDate": "2020-08-07T18:45:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ==", "url": "https://github.com/apache/druid/pull/10253#discussion_r467973549", "body": "Can we default to false instead of making this nullable?\r\n\r\n```suggestion\r\n  private boolean forceLimitPushDown;\r\n```", "bodyText": "Can we default to false instead of making this nullable?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Boolean forceLimitPushDown;\n          \n          \n            \n              private boolean forceLimitPushDown;", "bodyHTML": "<p dir=\"auto\">Can we default to false instead of making this nullable?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"130\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi x x-first x-last\">Boolean</span> forceLimitPushDown;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"130\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first x-last\">boolean</span> forceLimitPushDown;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "suneet-s", "createdAt": "2020-08-10T15:11:32Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -121,6 +120,10 @@ public static Builder builder()\n   @Nullable\n   private final DateTime universalTimestamp;\n \n+  private final boolean canPushDownLimit;\n+  @Nullable\n+  private Boolean forceLimitPushDown;", "originalCommit": "8f63335e145685d2af61493da22ad3f6cf4c061f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMTY1Ng==", "url": "https://github.com/apache/druid/pull/10253#discussion_r468811656", "bodyText": "I think this would cause extra calls to validateAndGetForceLimitPushDown whenever isApplyLimitPushdown is called because of being unable to distinguish between an actual false and the value not being computed yet. It's probably not especially harmful, but it also seems unnecessary.", "author": "clintropolis", "createdAt": "2020-08-11T19:22:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5MzAzNw==", "url": "https://github.com/apache/druid/pull/10253#discussion_r469693037", "bodyText": "Yeah, it's nullable to lazily initialize and cache it. Checking the value of forceLimitPushDown is needed a couple of times during a query. Even though it's not very harmful, I don't see any reason to not cache it.", "author": "jihoonson", "createdAt": "2020-08-13T04:43:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MzU0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMzI1Mg==", "url": "https://github.com/apache/druid/pull/10253#discussion_r468813252", "body": "super nit: it seems funny to have `...LimitPushDown` and `...PushDownLimit`, but I'm not really sure what is the best way to square these up. I guess `...LimitPushDown` is more prevalent, so maybe renaming to `canDoLimitPushDown` to be more consistent?", "bodyText": "super nit: it seems funny to have ...LimitPushDown and ...PushDownLimit, but I'm not really sure what is the best way to square these up. I guess ...LimitPushDown is more prevalent, so maybe renaming to canDoLimitPushDown to be more consistent?", "bodyHTML": "<p dir=\"auto\">super nit: it seems funny to have <code>...LimitPushDown</code> and <code>...PushDownLimit</code>, but I'm not really sure what is the best way to square these up. I guess <code>...LimitPushDown</code> is more prevalent, so maybe renaming to <code>canDoLimitPushDown</code> to be more consistent?</p>", "author": "clintropolis", "createdAt": "2020-08-11T19:25:28Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -409,7 +412,10 @@ public boolean getContextSortByDimsFirst()\n   @JsonIgnore\n   public boolean isApplyLimitPushDown()\n   {\n-    return applyLimitPushDown;\n+    if (forceLimitPushDown == null) {\n+      forceLimitPushDown = validateAndGetForceLimitPushDown();\n+    }\n+    return forceLimitPushDown || canPushDownLimit;", "originalCommit": "8f63335e145685d2af61493da22ad3f6cf4c061f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5MzA1OQ==", "url": "https://github.com/apache/druid/pull/10253#discussion_r469693059", "bodyText": "Renamed.", "author": "jihoonson", "createdAt": "2020-08-13T04:43:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxMzI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxNTE1OA==", "url": "https://github.com/apache/druid/pull/10253#discussion_r468815158", "body": "nit: this method name should probably include `LimitPushDown` or at least `Limit` somehow to make it clearer that it applies to limits, maybe `canDoLimitPushDown()` if you decide to rename the field as well?", "bodyText": "nit: this method name should probably include LimitPushDown or at least Limit somehow to make it clearer that it applies to limits, maybe canDoLimitPushDown() if you decide to rename the field as well?", "bodyHTML": "<p dir=\"auto\">nit: this method name should probably include <code>LimitPushDown</code> or at least <code>Limit</code> somehow to make it clearer that it applies to limits, maybe <code>canDoLimitPushDown()</code> if you decide to rename the field as well?</p>", "author": "clintropolis", "createdAt": "2020-08-11T19:29:11Z", "path": "processing/src/main/java/org/apache/druid/query/groupby/GroupByQuery.java", "diffHunk": "@@ -474,14 +480,12 @@ private RowSignature computeResultRowSignature()\n                   .build();\n   }\n \n-  private boolean determineApplyLimitPushDown()\n+  private boolean canPushDown()", "originalCommit": "8f63335e145685d2af61493da22ad3f6cf4c061f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5MzIyNw==", "url": "https://github.com/apache/druid/pull/10253#discussion_r469693227", "bodyText": "Added limitSpec, havingSpec, and subtotalsSpec as params and renamed.", "author": "jihoonson", "createdAt": "2020-08-13T04:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgxNTE1OA=="}], "type": "inlineReview"}, {"oid": "e3bc9b260f08fa91fcf63f4709230d354806c885", "url": "https://github.com/apache/druid/commit/e3bc9b260f08fa91fcf63f4709230d354806c885", "message": "review comments", "committedDate": "2020-08-13T04:35:10Z", "type": "commit"}, {"oid": "62f4d0080f67659c458466fb84f259e58cdde9d6", "url": "https://github.com/apache/druid/commit/62f4d0080f67659c458466fb84f259e58cdde9d6", "message": "fix test", "committedDate": "2020-08-13T17:01:43Z", "type": "commit"}]}