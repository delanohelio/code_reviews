{"pr_number": 1586, "pr_title": "Fix Accumulo hanging when TLS enabled on ZooKeeper", "pr_author": "karthick-rn", "pr_createdAt": "2020-04-13T22:31:21Z", "pr_url": "https://github.com/apache/accumulo/pull/1586", "timeline": [{"oid": "786caf1aab78a5c0170df1c36e920a31d721aafe", "url": "https://github.com/apache/accumulo/commit/786caf1aab78a5c0170df1c36e920a31d721aafe", "message": "Fix for #1578", "committedDate": "2020-04-13T21:57:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMTQ0MQ==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407831441", "body": "As I understand it, the basis of this pull request is to create this CLOSED mode. What is this CLOSED mode for? This could use a javadoc similar to the other modes.", "bodyText": "As I understand it, the basis of this pull request is to create this CLOSED mode. What is this CLOSED mode for? This could use a javadoc similar to the other modes.", "bodyHTML": "<p dir=\"auto\">As I understand it, the basis of this pull request is to create this CLOSED mode. What is this CLOSED mode for? This could use a javadoc similar to the other modes.</p>", "author": "ctubbsii", "createdAt": "2020-04-14T02:38:47Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -65,7 +65,8 @@\n      * In this mode singletons are never disabled unless the mode is set back to CLIENT. The user\n      * can do this by using util.CleanUp (an old API created for users).\n      */\n-    CONNECTOR\n+    CONNECTOR,\n+    CLOSED", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODg2NA==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r408388864", "bodyText": "Added comments to explain CLOSED mode, also updated the CLIENT mode comments.", "author": "karthick-rn", "createdAt": "2020-04-14T19:41:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMTQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzMzEzNQ==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407833135", "body": "Would it be okay to just return if the mode parameter is already the current mode?\r\n\r\n```suggestion\r\n    if (SingletonManager.mode == mode)\r\n      return;\r\n    if (SingletonManager.mode == Mode.CLOSED)\r\n      throw new IllegalStateException(\"Cannot leave closed mode once entered\");\r\n```\r\n\r\nOr is it necessary to fall through and do something if they are both `CLOSED` already?", "bodyText": "Would it be okay to just return if the mode parameter is already the current mode?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (SingletonManager.mode == Mode.CLOSED && mode != Mode.CLOSED)\n          \n          \n            \n                  throw new IllegalStateException(\"Cannot leave closed mode once entered\");\n          \n          \n            \n                if (SingletonManager.mode == mode)\n          \n          \n            \n                  return;\n          \n          \n            \n                if (SingletonManager.mode == Mode.CLOSED)\n          \n          \n            \n                  throw new IllegalStateException(\"Cannot leave closed mode once entered\");\n          \n      \n    \n    \n  \n\nOr is it necessary to fall through and do something if they are both CLOSED already?", "bodyHTML": "<p dir=\"auto\">Would it be okay to just return if the mode parameter is already the current mode?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"160\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">SingletonManager</span><span class=\"pl-k\">.</span>mode <span class=\"pl-k\">==</span> <span class=\"pl-smi\">Mode</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>CLOSED</span> <span class=\"pl-k\">&amp;&amp;</span> mode <span class=\"pl-k\">!=</span> <span class=\"pl-smi\">Mode</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>CLOSED</span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"161\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalStateException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Cannot leave closed mode once entered<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"160\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">SingletonManager</span><span class=\"pl-k\">.</span>mode <span class=\"pl-k\">==</span> mode)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"161\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">return</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"162\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">SingletonManager</span><span class=\"pl-k\">.</span>mode <span class=\"pl-k\">==</span> <span class=\"pl-smi\">Mode</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>CLOSED</span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"163\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalStateException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Cannot leave closed mode once entered<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Or is it necessary to fall through and do something if they are both <code>CLOSED</code> already?</p>", "author": "ctubbsii", "createdAt": "2020-04-14T02:45:07Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -148,6 +149,8 @@ public static long getReservationCount() {\n    * Change how singletons are managed. The default mode is {@link Mode#CLIENT}\n    */\n   public static synchronized void setMode(Mode mode) {\n+    if (SingletonManager.mode == Mode.CLOSED && mode != Mode.CLOSED)\n+      throw new IllegalStateException(\"Cannot leave closed mode once entered\");", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDA2OA==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407834068", "body": "The comment above this line covers the left hand side, but doesn't explain the right hand side of this `||` expression. Should it say something about `always allow changing state to CLOSED`?", "bodyText": "The comment above this line covers the left hand side, but doesn't explain the right hand side of this || expression. Should it say something about always allow changing state to CLOSED?", "bodyHTML": "<p dir=\"auto\">The comment above this line covers the left hand side, but doesn't explain the right hand side of this <code>||</code> expression. Should it say something about <code>always allow changing state to CLOSED</code>?</p>", "author": "ctubbsii", "createdAt": "2020-04-14T02:48:39Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -161,7 +164,7 @@ public static synchronized void setMode(Mode mode) {\n     }\n \n     // do not change from server mode, its a terminal mode that can not be left once entered\n-    if (SingletonManager.mode != Mode.SERVER) {\n+    if (SingletonManager.mode != Mode.SERVER || mode == Mode.CLOSED) {", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDc1Nw==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r407834757", "body": "Does this prevent this code from being called from a process that might have other Accumulo client Connectors? If so, this is a bit concerning as a restriction.\r\n\r\n(Same comment for ZooZap and SetGoalState)", "bodyText": "Does this prevent this code from being called from a process that might have other Accumulo client Connectors? If so, this is a bit concerning as a restriction.\n(Same comment for ZooZap and SetGoalState)", "bodyHTML": "<p dir=\"auto\">Does this prevent this code from being called from a process that might have other Accumulo client Connectors? If so, this is a bit concerning as a restriction.</p>\n<p dir=\"auto\">(Same comment for ZooZap and SetGoalState)</p>", "author": "ctubbsii", "createdAt": "2020-04-14T02:51:02Z", "path": "server/base/src/main/java/org/apache/accumulo/server/util/Admin.java", "diffHunk": "@@ -275,6 +277,8 @@ public void execute(final String[] args) {\n     } catch (Exception e) {\n       log.error(\"{}\", e.getMessage(), e);\n       System.exit(3);\n+    } finally {\n+      SingletonManager.setMode(Mode.CLOSED);", "originalCommit": "65dbef8c227a0527840a9c347db5b407339937b4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE1MDg1Mw==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r408150853", "bodyText": "Does this prevent this code from being called from a process that might have other Accumulo client Connectors?\n\nYes I think it would.  I don't think this situation happens currently.  If it ever did in the future, a clear error message would occur making it easy to track down.  Since this not public API, its always easy to change this code later if the hypothetical situation does happen.", "author": "keith-turner", "createdAt": "2020-04-14T13:49:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzgzNDc1Nw=="}], "type": "inlineReview"}, {"oid": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "url": "https://github.com/apache/accumulo/commit/c5fccb4b2db688009f49350ec09d0c727612b2b0", "message": "Update based on Christopher's comments\n\nThe comment section of SingletonManager Java class has been updated based on Christopher's comments", "committedDate": "2020-04-14T19:19:11Z", "type": "commit"}, {"oid": "c5fccb4b2db688009f49350ec09d0c727612b2b0", "url": "https://github.com/apache/accumulo/commit/c5fccb4b2db688009f49350ec09d0c727612b2b0", "message": "Update based on Christopher's comments\n\nThe comment section of SingletonManager Java class has been updated based on Christopher's comments", "committedDate": "2020-04-14T19:19:11Z", "type": "forcePushed"}, {"oid": "3df1011e210663fd11e330bd5b5f215e213b3080", "url": "https://github.com/apache/accumulo/commit/3df1011e210663fd11e330bd5b5f215e213b3080", "message": "Replace single-line with multi-line comment", "committedDate": "2020-04-14T19:49:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NDgxNw==", "url": "https://github.com/apache/accumulo/pull/1586#discussion_r408394817", "body": "This isn't a javadoc comment.\r\n\r\n```suggestion\r\n    /*\r\n```", "bodyText": "This isn't a javadoc comment.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /**\n          \n          \n            \n                /*", "bodyHTML": "<p dir=\"auto\">This isn't a javadoc comment.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">/*<span class=\"x x-first x-last\">*</span></span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">/*</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ctubbsii", "createdAt": "2020-04-14T19:52:11Z", "path": "core/src/main/java/org/apache/accumulo/core/singletons/SingletonManager.java", "diffHunk": "@@ -170,8 +170,10 @@ public static synchronized void setMode(Mode mode) {\n       transitionedFromClientToConnector = true;\n     }\n \n-    // always allow transition to closed and only allow transition to client/connector when the\n-    // current mode is not server\n+    /**", "originalCommit": "3df1011e210663fd11e330bd5b5f215e213b3080", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d765a92c07c6682ce8ec8bfd7f04594df870d4f3", "url": "https://github.com/apache/accumulo/commit/d765a92c07c6682ce8ec8bfd7f04594df870d4f3", "message": "Apply suggestions from code review", "committedDate": "2020-04-14T19:53:50Z", "type": "commit"}, {"oid": "a6763e3a118de2686fdd50205bd0e18b06c268d8", "url": "https://github.com/apache/accumulo/commit/a6763e3a118de2686fdd50205bd0e18b06c268d8", "message": "Fix import ordering", "committedDate": "2020-04-14T20:25:49Z", "type": "commit"}]}