{"pr_number": 1569, "pr_title": "Fixes #1464 - SimpleThreadPool for importtable", "pr_author": "arvindshmicrosoft", "pr_createdAt": "2020-03-23T23:36:07Z", "pr_url": "https://github.com/apache/accumulo/pull/1569", "timeline": [{"oid": "efb5aedcda621b2c1365840257a95684e0e274a0", "url": "https://github.com/apache/accumulo/commit/efb5aedcda621b2c1365840257a95684e0e274a0", "message": "Use SimpleThreadPool for importtable file renames\n\nFixes #1464 - importtable improved with parallel calls to fs.rename\nfrom multiple threads within a SimpleThreadPool. Thread pool size is\ncontrolled by new property master.importtable.rename.threadpool.size", "committedDate": "2020-03-23T23:38:08Z", "type": "commit"}, {"oid": "efb5aedcda621b2c1365840257a95684e0e274a0", "url": "https://github.com/apache/accumulo/commit/efb5aedcda621b2c1365840257a95684e0e274a0", "message": "Use SimpleThreadPool for importtable file renames\n\nFixes #1464 - importtable improved with parallel calls to fs.rename\nfrom multiple threads within a SimpleThreadPool. Thread pool size is\ncontrolled by new property master.importtable.rename.threadpool.size", "committedDate": "2020-03-23T23:38:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEzMTg5NQ==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397131895", "body": "I wonder if we can combine this with ```MASTER_BULK_RENAME_THREADS``` and just have one common value for renames in the Master.", "bodyText": "I wonder if we can combine this with MASTER_BULK_RENAME_THREADS and just have one common value for renames in the Master.", "bodyHTML": "<p dir=\"auto\">I wonder if we can combine this with <code>MASTER_BULK_RENAME_THREADS</code> and just have one common value for renames in the Master.</p>", "author": "milleruntime", "createdAt": "2020-03-24T12:58:41Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -251,6 +251,9 @@\n   MASTER_BULK_RENAME_THREADS(\"master.bulk.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n       \"The number of threads to use when moving user files to bulk ingest \"\n           + \"directories under accumulo control\"),\n+  MASTER_IMPORTTABLE_RENAME_THREADS(\"master.importtable.rename.threadpool.size\", \"20\",\n+      PropertyType.COUNT,\n+      \"The number of threads to use when renaming user files when importing a table.\"),", "originalCommit": "efb5aedcda621b2c1365840257a95684e0e274a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE4MjMzMA==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397182330", "bodyText": "Could deprecate the bulk.rename prop and have a new master.import.rename.threadpool.size.   Could use the AccumuloConfiguration.resolve() method in the bulk import code to get the correct property.", "author": "keith-turner", "createdAt": "2020-03-24T14:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEzMTg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIwNDc4MA==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397204780", "bodyText": "I was thinking deprecate master.bulk.rename.threadpool.size and create something more generic like master.rename.threadpool.size that could be used anywhere in the Master where we want to optimize renames.  Just doing a quick search for \"fs.rename\" the new and old Bulk imports could use this property as well.  My point is I don't think it need to have a property for each fate operation.  If a user is having issues with NN renames, they would benefit in the other operations as well.", "author": "milleruntime", "createdAt": "2020-03-24T14:40:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEzMTg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIyNTAzMw==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397225033", "bodyText": "Thank you Mike and Keith - I'll lean on your experience to guide me accordingly. I conceptually agree having one property would be better.", "author": "arvindshmicrosoft", "createdAt": "2020-03-24T15:05:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEzMTg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1OTQ5Nw==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397259497", "bodyText": "Can I proceed to revise this PR with the following:\n\ndeprecate master.bulk.rename.threadpool.size and recommend master.rename.threadpool.size as the new property\nupdate the importdirectory (bulk) code with the appropriate code to resolve the new property and warn about deprecation\nupdate the changed importtable code to leverage the new property\n\nPlease let me know.", "author": "arvindshmicrosoft", "createdAt": "2020-03-24T15:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEzMTg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5MzE4OA==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397293188", "bodyText": "Sounds good.  After you finish this PR, I can create a follow on ticket to utilize the new property across the other FATE operations that perform renames.", "author": "milleruntime", "createdAt": "2020-03-24T16:31:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEzMTg5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzYxOTM2OQ==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397619369", "bodyText": "The changes are implemented. Please take a look. I was also curious about what you meant by \"other FATE operations that perform renames\". I think bulk ingest (importdirectory) is one, which is addressed in this PR now, but would like to know where else (of course, I'll leave those changes to a later change as you suggested).", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T05:39:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzEzMTg5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "8b530e0598f9831b8e343c7a7f56703ffc45bd92", "changed_code": [{"header": "diff --git a/core/src/main/java/org/apache/accumulo/core/conf/Property.java b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\nindex bc17284136..775d59a0f5 100644\n--- a/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n+++ b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n", "chunk": "@@ -248,6 +248,10 @@ public enum Property {\n       \"The number of threads to use when coordinating a bulk import.\"),\n   MASTER_BULK_TIMEOUT(\"master.bulk.timeout\", \"5m\", PropertyType.TIMEDURATION,\n       \"The time to wait for a tablet server to process a bulk import request\"),\n+  MASTER_RENAME_THREADS(\"master.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n+      \"The number of threads to use when renaming user files during table import or bulk ingest.\"),\n+  @Deprecated\n+  @ReplacedBy(property = MASTER_RENAME_THREADS)\n   MASTER_BULK_RENAME_THREADS(\"master.bulk.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n       \"The number of threads to use when moving user files to bulk ingest \"\n           + \"directories under accumulo control\"),\n", "next_change": {"commit": "595e735a074f6c05ddc4a4b8e969dd4702206572", "changed_code": [{"header": "diff --git a/core/src/main/java/org/apache/accumulo/core/conf/Property.java b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\nindex 775d59a0f5..fc83376d29 100644\n--- a/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n+++ b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n", "chunk": "@@ -253,11 +253,8 @@ public enum Property {\n   @Deprecated\n   @ReplacedBy(property = MASTER_RENAME_THREADS)\n   MASTER_BULK_RENAME_THREADS(\"master.bulk.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n-      \"The number of threads to use when moving user files to bulk ingest \"\n+      \"This property is deprecated since 2.1.0. The number of threads to use when moving user files to bulk ingest \"\n           + \"directories under accumulo control\"),\n-  MASTER_IMPORTTABLE_RENAME_THREADS(\"master.importtable.rename.threadpool.size\", \"20\",\n-      PropertyType.COUNT,\n-      \"The number of threads to use when renaming user files when importing a table.\"),\n   MASTER_BULK_TSERVER_REGEX(\"master.bulk.tserver.regex\", \"\", PropertyType.STRING,\n       \"Regular expression that defines the set of Tablet Servers that will perform bulk imports\"),\n   MASTER_MINTHREADS(\"master.server.threads.minimum\", \"20\", PropertyType.COUNT,\n", "next_change": null}]}}]}}, {"oid": "8b530e0598f9831b8e343c7a7f56703ffc45bd92", "url": "https://github.com/apache/accumulo/commit/8b530e0598f9831b8e343c7a7f56703ffc45bd92", "message": "Usee common property for file rename threadpools\n\n* deprecates master.bulk.rename.threadpool.size\n* master.rename.threadpool.size is a new common property shared across\n  import and bulk ingest\n* update importdirectory (bulk ingest) code to leverage new property", "committedDate": "2020-03-25T05:35:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMTYyMA==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397901620", "body": "Can this be removed?", "bodyText": "Can this be removed?", "bodyHTML": "<p dir=\"auto\">Can this be removed?</p>", "author": "keith-turner", "createdAt": "2020-03-25T14:33:20Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -248,9 +248,16 @@\n       \"The number of threads to use when coordinating a bulk import.\"),\n   MASTER_BULK_TIMEOUT(\"master.bulk.timeout\", \"5m\", PropertyType.TIMEDURATION,\n       \"The time to wait for a tablet server to process a bulk import request\"),\n+  MASTER_RENAME_THREADS(\"master.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n+      \"The number of threads to use when renaming user files during table import or bulk ingest.\"),\n+  @Deprecated\n+  @ReplacedBy(property = MASTER_RENAME_THREADS)\n   MASTER_BULK_RENAME_THREADS(\"master.bulk.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n       \"The number of threads to use when moving user files to bulk ingest \"\n           + \"directories under accumulo control\"),\n+  MASTER_IMPORTTABLE_RENAME_THREADS(\"master.importtable.rename.threadpool.size\", \"20\",", "originalCommit": "8b530e0598f9831b8e343c7a7f56703ffc45bd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkxOTQ1Nw==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397919457", "bodyText": "So sorry, I could have sworn I took care of that. Will address. Sorry again!", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T14:55:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMTYyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk4OTczNA==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397989734", "bodyText": "Done.", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T16:23:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMTYyMA=="}], "type": "inlineReview", "revised_code": {"commit": "595e735a074f6c05ddc4a4b8e969dd4702206572", "changed_code": [{"header": "diff --git a/core/src/main/java/org/apache/accumulo/core/conf/Property.java b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\nindex 775d59a0f5..fc83376d29 100644\n--- a/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n+++ b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n", "chunk": "@@ -253,11 +253,8 @@ public enum Property {\n   @Deprecated\n   @ReplacedBy(property = MASTER_RENAME_THREADS)\n   MASTER_BULK_RENAME_THREADS(\"master.bulk.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n-      \"The number of threads to use when moving user files to bulk ingest \"\n+      \"This property is deprecated since 2.1.0. The number of threads to use when moving user files to bulk ingest \"\n           + \"directories under accumulo control\"),\n-  MASTER_IMPORTTABLE_RENAME_THREADS(\"master.importtable.rename.threadpool.size\", \"20\",\n-      PropertyType.COUNT,\n-      \"The number of threads to use when renaming user files when importing a table.\"),\n   MASTER_BULK_TSERVER_REGEX(\"master.bulk.tserver.regex\", \"\", PropertyType.STRING,\n       \"Regular expression that defines the set of Tablet Servers that will perform bulk imports\"),\n   MASTER_MINTHREADS(\"master.server.threads.minimum\", \"20\", PropertyType.COUNT,\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMzU0OA==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397903548", "body": "Some of the deprecated properties have the following in their description.  I think this is nice for the generated documentation.\r\n\r\n```suggestion\r\n      \"This property is deprecated since 2.1.0. The number of threads to use when moving user files to bulk ingest \"\r\n```", "bodyText": "Some of the deprecated properties have the following in their description.  I think this is nice for the generated documentation.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"The number of threads to use when moving user files to bulk ingest \"\n          \n          \n            \n                  \"This property is deprecated since 2.1.0. The number of threads to use when moving user files to bulk ingest \"", "bodyHTML": "<p dir=\"auto\">Some of the deprecated properties have the following in their description.  I think this is nice for the generated documentation.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The number of threads to use when moving user files to bulk ingest <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">This property is deprecated since 2.1.0. </span>The number of threads to use when moving user files to bulk ingest <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "keith-turner", "createdAt": "2020-03-25T14:35:39Z", "path": "core/src/main/java/org/apache/accumulo/core/conf/Property.java", "diffHunk": "@@ -248,9 +248,16 @@\n       \"The number of threads to use when coordinating a bulk import.\"),\n   MASTER_BULK_TIMEOUT(\"master.bulk.timeout\", \"5m\", PropertyType.TIMEDURATION,\n       \"The time to wait for a tablet server to process a bulk import request\"),\n+  MASTER_RENAME_THREADS(\"master.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n+      \"The number of threads to use when renaming user files during table import or bulk ingest.\"),\n+  @Deprecated\n+  @ReplacedBy(property = MASTER_RENAME_THREADS)\n   MASTER_BULK_RENAME_THREADS(\"master.bulk.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n       \"The number of threads to use when moving user files to bulk ingest \"", "originalCommit": "8b530e0598f9831b8e343c7a7f56703ffc45bd92", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk5Mzg4Nw==", "url": "https://github.com/apache/accumulo/pull/1569#discussion_r397993887", "bodyText": "Done.", "author": "arvindshmicrosoft", "createdAt": "2020-03-25T16:28:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkwMzU0OA=="}], "type": "inlineReview", "revised_code": {"commit": "595e735a074f6c05ddc4a4b8e969dd4702206572", "changed_code": [{"header": "diff --git a/core/src/main/java/org/apache/accumulo/core/conf/Property.java b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\nindex 775d59a0f5..fc83376d29 100644\n--- a/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n+++ b/core/src/main/java/org/apache/accumulo/core/conf/Property.java\n", "chunk": "@@ -253,11 +253,8 @@ public enum Property {\n   @Deprecated\n   @ReplacedBy(property = MASTER_RENAME_THREADS)\n   MASTER_BULK_RENAME_THREADS(\"master.bulk.rename.threadpool.size\", \"20\", PropertyType.COUNT,\n-      \"The number of threads to use when moving user files to bulk ingest \"\n+      \"This property is deprecated since 2.1.0. The number of threads to use when moving user files to bulk ingest \"\n           + \"directories under accumulo control\"),\n-  MASTER_IMPORTTABLE_RENAME_THREADS(\"master.importtable.rename.threadpool.size\", \"20\",\n-      PropertyType.COUNT,\n-      \"The number of threads to use when renaming user files when importing a table.\"),\n   MASTER_BULK_TSERVER_REGEX(\"master.bulk.tserver.regex\", \"\", PropertyType.STRING,\n       \"Regular expression that defines the set of Tablet Servers that will perform bulk imports\"),\n   MASTER_MINTHREADS(\"master.server.threads.minimum\", \"20\", PropertyType.COUNT,\n", "next_change": null}]}}, {"oid": "595e735a074f6c05ddc4a4b8e969dd4702206572", "url": "https://github.com/apache/accumulo/commit/595e735a074f6c05ddc4a4b8e969dd4702206572", "message": "Remove unused property and add deprecation note", "committedDate": "2020-03-25T16:20:33Z", "type": "commit"}]}