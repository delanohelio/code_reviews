{"pr_number": 1759, "pr_title": "Wrap undo in try block", "pr_author": "Manno15", "pr_createdAt": "2020-10-30T12:00:23Z", "pr_url": "https://github.com/apache/accumulo/pull/1759", "timeline": [{"oid": "1626844419488b47ae57623286bfee473b112a77", "url": "https://github.com/apache/accumulo/commit/1626844419488b47ae57623286bfee473b112a77", "message": "wrap in try block, add finally block", "committedDate": "2020-10-30T11:56:30Z", "type": "commit"}, {"oid": "3df9fa40d16eb3a30fdd6dd4b64c58a854c869b8", "url": "https://github.com/apache/accumulo/commit/3df9fa40d16eb3a30fdd6dd4b64c58a854c869b8", "message": "wrap chooseDir in try block, log error", "committedDate": "2020-11-02T13:49:55Z", "type": "commit"}, {"oid": "e3d6c5fb4a18f9c179bfcb302ccd6a54bab1cd9d", "url": "https://github.com/apache/accumulo/commit/e3d6c5fb4a18f9c179bfcb302ccd6a54bab1cd9d", "message": "catch exceptions and log errors", "committedDate": "2020-11-02T14:24:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM3NDkyOQ==", "url": "https://github.com/apache/accumulo/pull/1759#discussion_r516374929", "body": "When on the receiving end of an error like this its really nice to have some information that helps correlate it with other activity in the system.  However the danger of trying to get more information for an error is that the code may fail.  I think the following is pretty safe and gives a good bit of helpful info. \r\n\r\n```suggestion\r\n      var spdir = Optional.ofNullable(tableInfo).map(TableInfo::getSplitDirsPath).orElse(null);\r\n      log.error(\"{} Failed to undo ChooseDir operation, split dir {} \",FateTxId.format(tid), spdir, e);\r\n```", "bodyText": "When on the receiving end of an error like this its really nice to have some information that helps correlate it with other activity in the system.  However the danger of trying to get more information for an error is that the code may fail.  I think the following is pretty safe and gives a good bit of helpful info.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.error(\"Failed to undo ChooseDir operation\", e);\n          \n          \n            \n                  var spdir = Optional.ofNullable(tableInfo).map(TableInfo::getSplitDirsPath).orElse(null);\n          \n          \n            \n                  log.error(\"{} Failed to undo ChooseDir operation, split dir {} \",FateTxId.format(tid), spdir, e);", "bodyHTML": "<p dir=\"auto\">When on the receiving end of an error like this its really nice to have some information that helps correlate it with other activity in the system.  However the danger of trying to get more information for an error is that the code may fail.  I think the following is pretty safe and gives a good bit of helpful info.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"x x-first\">log</span><span class=\"pl-k x\">.</span><span class=\"x\">error(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">Failed to undo ChooseDir operation</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">, e</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k x x-first\">var</span><span class=\"x\"> spdir </span><span class=\"pl-k x\">=</span><span class=\"x\"> </span><span class=\"pl-smi x\">Optional</span><span class=\"pl-k x\">.</span><span class=\"x\">ofNullable(tableInfo)</span><span class=\"pl-k x\">.</span><span class=\"x\">map(</span><span class=\"pl-smi x\">TableInfo</span><span class=\"pl-k x\">::</span><span class=\"x\">getSplitDirsPath)</span><span class=\"pl-k x\">.</span><span class=\"x\">orElse(</span><span class=\"pl-c1 x x-last\">null</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      log<span class=\"pl-k\">.</span>error(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{} Failed to undo ChooseDir operation, split dir {} <span class=\"pl-pds\">\"</span></span>,<span class=\"pl-smi\">FateTxId</span><span class=\"pl-k\">.</span>format(tid), spdir, e);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "keith-turner", "createdAt": "2020-11-03T01:00:13Z", "path": "server/manager/src/main/java/org/apache/accumulo/master/tableOps/create/ChooseDir.java", "diffHunk": "@@ -60,9 +63,16 @@ public long isReady(long tid, Master environment) {\n \n   @Override\n   public void undo(long tid, Master master) throws Exception {\n-    Path p = tableInfo.getSplitDirsPath();\n-    FileSystem fs = p.getFileSystem(master.getContext().getHadoopConf());\n-    fs.delete(p, true);\n+    // Clean up split files if ChooseDir operation fails\n+    try {\n+      if (tableInfo.getInitialSplitSize() > 0) {\n+        Path p = tableInfo.getSplitDirsPath();\n+        FileSystem fs = p.getFileSystem(master.getContext().getHadoopConf());\n+        fs.delete(p, true);\n+      }\n+    } catch (NullPointerException | IOException e) {\n+      log.error(\"Failed to undo ChooseDir operation\", e);", "originalCommit": "e3d6c5fb4a18f9c179bfcb302ccd6a54bab1cd9d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYyMzk4MQ==", "url": "https://github.com/apache/accumulo/pull/1759#discussion_r516623981", "bodyText": "I made the requested error changes or each of the catch blocks. Let me know if there is anything else I need to tweak.", "author": "Manno15", "createdAt": "2020-11-03T12:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM3NDkyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc3NTk5NQ==", "url": "https://github.com/apache/accumulo/pull/1759#discussion_r516775995", "bodyText": "Looks good.", "author": "keith-turner", "createdAt": "2020-11-03T15:59:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM3NDkyOQ=="}], "type": "inlineReview"}, {"oid": "59da0bf7171e1c2210acf81da25b105547cf9d64", "url": "https://github.com/apache/accumulo/commit/59da0bf7171e1c2210acf81da25b105547cf9d64", "message": "add requested error message", "committedDate": "2020-11-03T12:16:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4NjIwMw==", "url": "https://github.com/apache/accumulo/pull/1759#discussion_r516886203", "body": "This needs to be removed. A user could have a table by this name.", "bodyText": "This needs to be removed. A user could have a table by this name.", "bodyHTML": "<p dir=\"auto\">This needs to be removed. A user could have a table by this name.</p>", "author": "ctubbsii", "createdAt": "2020-11-03T18:53:15Z", "path": "server/manager/src/main/java/org/apache/accumulo/master/tableOps/create/CreateTable.java", "diffHunk": "@@ -72,6 +77,9 @@ public long isReady(long tid, Master environment) throws Exception {\n     Utils.getIdLock().lock();\n     try {\n       String tName = tableInfo.getTableName();\n+      if(tName.equals(\"ci\")){\n+        Thread.sleep(10000000);\n+      }", "originalCommit": "59da0bf7171e1c2210acf81da25b105547cf9d64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyNzYwNQ==", "url": "https://github.com/apache/accumulo/pull/1759#discussion_r516927605", "bodyText": "That is my mistake, this shouldn't be here. I used this to force it to hang. Forgot to remove it.", "author": "Manno15", "createdAt": "2020-11-03T20:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4NjIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxNjQ1MA==", "url": "https://github.com/apache/accumulo/pull/1759#discussion_r516916450", "body": "I don't think it's possible for tableInfo to be null here, given how this class is constructed. And, if the split size is `>0`, it's also not possible for the splits file locations to be null. Also, I think we should focus just on handling exceptions pertaining to the specific cleanup task that we're performing. So, if these do happen to be null because of some serialization bug or whatever, that shouldn't be handled here, but handled by the framework if the exception is thrown from the method (if the framework isn't capable of handling exceptions thrown by this method, the interface shouldn't have `throws Exception` on the method, and if that's a problem, it is a separate issue that should be fixed in a separate PR to fix the FaTE framework itself).\r\n\r\nAlso, the tx id is already in the path to the splits file, so it's possibly redundant to have that here (but I'm not opposed to keeping it).\r\n\r\nAlso, we probably want to log the parent path (the one we're trying to delete recursively), rather than just one of the two file names.\r\n\r\nSo, all told, I think something like this would be a little cleaner (with similar changes made in the other places):\r\n\r\n```suggestion\r\n    Path p = null;\r\n    try {\r\n      p = tableInfo.getSplitPath().getParent();\r\n      FileSystem fs = p.getFileSystem(env.getContext().getHadoopConf());\r\n      fs.delete(p, true);\r\n    } catch (IOException e) {\r\n      log.error(\"Table was created, but failed to clean up temporary splits files at {}\", p, e);\r\n    }\r\n```", "bodyText": "I don't think it's possible for tableInfo to be null here, given how this class is constructed. And, if the split size is >0, it's also not possible for the splits file locations to be null. Also, I think we should focus just on handling exceptions pertaining to the specific cleanup task that we're performing. So, if these do happen to be null because of some serialization bug or whatever, that shouldn't be handled here, but handled by the framework if the exception is thrown from the method (if the framework isn't capable of handling exceptions thrown by this method, the interface shouldn't have throws Exception on the method, and if that's a problem, it is a separate issue that should be fixed in a separate PR to fix the FaTE framework itself).\nAlso, the tx id is already in the path to the splits file, so it's possibly redundant to have that here (but I'm not opposed to keeping it).\nAlso, we probably want to log the parent path (the one we're trying to delete recursively), rather than just one of the two file names.\nSo, all told, I think something like this would be a little cleaner (with similar changes made in the other places):\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                try {\n          \n          \n            \n                  Path p = tableInfo.getSplitPath().getParent();\n          \n          \n            \n                  FileSystem fs = p.getFileSystem(env.getContext().getHadoopConf());\n          \n          \n            \n                  fs.delete(p, true);\n          \n          \n            \n                } catch (NullPointerException | IOException e) {\n          \n          \n            \n                  var spdir = Optional.ofNullable(tableInfo).map(TableInfo::getSplitDirsPath).orElse(null);\n          \n          \n            \n                  log.error(\"{} Failed to cleanup splits file after table was created, split dir {} \",\n          \n          \n            \n                      FateTxId.formatTid(tid), spdir, e);\n          \n          \n            \n                }\n          \n          \n            \n                Path p = null;\n          \n          \n            \n                try {\n          \n          \n            \n                  p = tableInfo.getSplitPath().getParent();\n          \n          \n            \n                  FileSystem fs = p.getFileSystem(env.getContext().getHadoopConf());\n          \n          \n            \n                  fs.delete(p, true);\n          \n          \n            \n                } catch (IOException e) {\n          \n          \n            \n                  log.error(\"Table was created, but failed to clean up temporary splits files at {}\", p, e);\n          \n          \n            \n                }", "bodyHTML": "<p dir=\"auto\">I don't think it's possible for tableInfo to be null here, given how this class is constructed. And, if the split size is <code>&gt;0</code>, it's also not possible for the splits file locations to be null. Also, I think we should focus just on handling exceptions pertaining to the specific cleanup task that we're performing. So, if these do happen to be null because of some serialization bug or whatever, that shouldn't be handled here, but handled by the framework if the exception is thrown from the method (if the framework isn't capable of handling exceptions thrown by this method, the interface shouldn't have <code>throws Exception</code> on the method, and if that's a problem, it is a separate issue that should be fixed in a separate PR to fix the FaTE framework itself).</p>\n<p dir=\"auto\">Also, the tx id is already in the path to the splits file, so it's possibly redundant to have that here (but I'm not opposed to keeping it).</p>\n<p dir=\"auto\">Also, we probably want to log the parent path (the one we're trying to delete recursively), rather than just one of the two file names.</p>\n<p dir=\"auto\">So, all told, I think something like this would be a little cleaner (with similar changes made in the other places):</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"83\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"84\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-smi\">Path</span> p <span class=\"pl-k\">=</span> tableInfo<span class=\"pl-k\">.</span>getSplitPath()<span class=\"pl-k\">.</span>getParent();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"85\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-smi\">FileSystem</span> fs <span class=\"pl-k\">=</span> p<span class=\"pl-k\">.</span>getFileSystem(env<span class=\"pl-k\">.</span>getContext()<span class=\"pl-k\">.</span>getHadoopConf());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"86\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      fs<span class=\"pl-k\">.</span>delete(p, <span class=\"pl-c1\">true</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"87\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">NullPointerException</span> <span class=\"pl-k\">|</span> <span class=\"pl-smi\">IOException</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"88\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">var</span> spdir <span class=\"pl-k\">=</span> <span class=\"pl-smi\">Optional</span><span class=\"pl-k\">.</span>ofNullable(tableInfo)<span class=\"pl-k\">.</span>map(<span class=\"pl-smi\">TableInfo</span><span class=\"pl-k\">::</span>getSplitDirsPath)<span class=\"pl-k\">.</span>orElse(<span class=\"pl-c1\">null</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"89\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      log<span class=\"pl-k\">.</span>error(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{} Failed to cleanup splits file after table was created, split dir {} <span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"90\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">          <span class=\"pl-smi\">FateTxId</span><span class=\"pl-k\">.</span>formatTid(tid), spdir, e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"91\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"83\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-smi\">Path</span> p <span class=\"pl-k\">=</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"84\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"85\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      p <span class=\"pl-k\">=</span> tableInfo<span class=\"pl-k\">.</span>getSplitPath()<span class=\"pl-k\">.</span>getParent();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"86\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-smi\">FileSystem</span> fs <span class=\"pl-k\">=</span> p<span class=\"pl-k\">.</span>getFileSystem(env<span class=\"pl-k\">.</span>getContext()<span class=\"pl-k\">.</span>getHadoopConf());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"87\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      fs<span class=\"pl-k\">.</span>delete(p, <span class=\"pl-c1\">true</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"88\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">IOException</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"89\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      log<span class=\"pl-k\">.</span>error(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Table was created, but failed to clean up temporary splits files at {}<span class=\"pl-pds\">\"</span></span>, p, e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"90\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ctubbsii", "createdAt": "2020-11-03T19:48:45Z", "path": "server/manager/src/main/java/org/apache/accumulo/master/tableOps/create/FinishCreateTable.java", "diffHunk": "@@ -62,17 +67,23 @@ public long isReady(long tid, Master environment) {\n     env.getEventCoordinator().event(\"Created table %s \", tableInfo.getTableName());\n \n     if (tableInfo.getInitialSplitSize() > 0) {\n-      cleanupSplitFiles(env);\n+      cleanupSplitFiles(tid, env);\n     }\n     return null;\n   }\n \n-  private void cleanupSplitFiles(Master env) throws IOException {\n+  private void cleanupSplitFiles(long tid, Master env) throws IOException {\n     // it is sufficient to delete from the parent, because both files are in the same directory, and\n     // we want to delete the directory also\n-    Path p = tableInfo.getSplitPath().getParent();\n-    FileSystem fs = p.getFileSystem(env.getContext().getHadoopConf());\n-    fs.delete(p, true);\n+    try {\n+      Path p = tableInfo.getSplitPath().getParent();\n+      FileSystem fs = p.getFileSystem(env.getContext().getHadoopConf());\n+      fs.delete(p, true);\n+    } catch (NullPointerException | IOException e) {\n+      var spdir = Optional.ofNullable(tableInfo).map(TableInfo::getSplitDirsPath).orElse(null);\n+      log.error(\"{} Failed to cleanup splits file after table was created, split dir {} \",\n+          FateTxId.formatTid(tid), spdir, e);\n+    }", "originalCommit": "59da0bf7171e1c2210acf81da25b105547cf9d64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkyOTMwNg==", "url": "https://github.com/apache/accumulo/pull/1759#discussion_r516929306", "bodyText": "I don't think it's possible for tableInfo to be null here, given how this class is constructed. And, if the split size is >0, it's also not possible for the splits file locations to be null.\n\nI agree. I wasn't quite sure so I kept the null exception handling in there. I will remove and look to make the other changes you suggested as well.", "author": "Manno15", "createdAt": "2020-11-03T20:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkxNjQ1MA=="}], "type": "inlineReview"}, {"oid": "07ffd14d9d49cea8948a46f11e4d56995ecb022c", "url": "https://github.com/apache/accumulo/commit/07ffd14d9d49cea8948a46f11e4d56995ecb022c", "message": "remove code that was left by mistake", "committedDate": "2020-11-04T12:37:00Z", "type": "commit"}, {"oid": "5ced0980e504d74bc4c1b2063e93264fd062e324", "url": "https://github.com/apache/accumulo/commit/5ced0980e504d74bc4c1b2063e93264fd062e324", "message": "made requested changes", "committedDate": "2020-11-04T13:16:23Z", "type": "commit"}]}