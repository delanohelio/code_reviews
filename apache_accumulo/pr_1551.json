{"pr_number": 1551, "pr_title": "Use sets instead of arrays for volumes", "pr_author": "ctubbsii", "pr_createdAt": "2020-03-06T03:39:26Z", "pr_url": "https://github.com/apache/accumulo/pull/1551", "timeline": [{"oid": "d886d869e628874054379f2b5ecdad702d9e0881", "url": "https://github.com/apache/accumulo/commit/d886d869e628874054379f2b5ecdad702d9e0881", "message": "Use sets instead of arrays for volumes\n\nOriginally ACCUMULO-3376, this change replaces the use of `String[]`\nwith `Set<String>` throughout the VolumeChooser and VolumeManager code.\nThis makes the API for VolumeChooser a bit more friendly, making it\neasier to use Streams and lambdas to filter and transform volumes\nthroughout the code.\n\nThis change also adds some more sanity checks on the instance volumes\nconfiguration (checking for empty list and duplicates).\n\nThis also includes a utility to warn about planned API changes in\ninternal pluggable code (such as the VolumeChooser), but without being\ntoo spammy.\n\nUpdate the default `VolumeChooser.choosable()` to return the full set of\nvolumes, so that all are checked for flush and sync support on tserver\nstartup. This choosable mechanism is a bit dubious anyway, because\nchoosers could make different decisions over time (in response to\nconfiguration changes, for example) than they do at startup. So,\ndefaulting to checking for the maximal set seems like a better strategy\nout-of-the-box.\n\nMake ServerConstants.baseUris unmodifiable.", "committedDate": "2020-03-06T03:35:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Mzg1Mw==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388953853", "body": "Could use sl4j parameterized log statement. \r\n```suggestion\r\n    log.info(\"Looking for matching filesystem for {} from options {}\", exportDir, tableDirs);\r\n```", "bodyText": "Could use sl4j parameterized log statement.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.info(\"Looking for matching filesystem for \" + exportDir + \" from options \" + tableDirs);\n          \n          \n            \n                log.info(\"Looking for matching filesystem for {} from options {}\", exportDir, tableDirs);", "bodyHTML": "<p dir=\"auto\">Could use sl4j parameterized log statement.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    log<span class=\"pl-k\">.</span>info(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Looking for matching filesystem for <span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x\">+</span><span class=\"x\"> exportDir </span><span class=\"pl-k x\">+</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x x-last\"> </span>from options <span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x x-last\">+</span> tableDirs);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    log<span class=\"pl-k\">.</span>info(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Looking for matching filesystem for <span class=\"x x-first x-last\">{} </span>from options <span class=\"x x-first\">{}</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">, exportDir,</span> tableDirs);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "milleruntime", "createdAt": "2020-03-06T15:03:25Z", "path": "server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java", "diffHunk": "@@ -47,10 +47,9 @@\n     UniqueNameAllocator namer = master.getContext().getUniqueNameAllocator();\n \n     Path exportDir = new Path(tableInfo.exportDir);\n-    String[] tableDirs = ServerConstants.getTablesDirs(master.getContext());\n+    Set<String> tableDirs = ServerConstants.getTablesDirs(master.getContext());\n \n-    log.info(\"Looking for matching filesystem for \" + exportDir + \" from options \"\n-        + Arrays.toString(tableDirs));\n+    log.info(\"Looking for matching filesystem for \" + exportDir + \" from options \" + tableDirs);", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyMTYyMw==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389021623", "bodyText": "This was preexisting, but good to change while we're in there.", "author": "ctubbsii", "createdAt": "2020-03-06T16:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Mzg1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Njg3MQ==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388956871", "body": "Could make ```ViewFSUtils``` take a Set as well.  Looks like this is the only class that uses it.", "bodyText": "Could make ViewFSUtils take a Set as well.  Looks like this is the only class that uses it.", "bodyHTML": "<p dir=\"auto\">Could make <code>ViewFSUtils</code> take a Set as well.  Looks like this is the only class that uses it.</p>", "author": "milleruntime", "createdAt": "2020-03-06T15:08:49Z", "path": "server/base/src/main/java/org/apache/accumulo/server/fs/VolumeManagerImpl.java", "diffHunk": "@@ -385,10 +385,10 @@ public boolean isReady() throws IOException {\n   }\n \n   @Override\n-  public Path matchingFileSystem(Path source, String[] options) {\n+  public Path matchingFileSystem(Path source, Set<String> options) {\n     try {\n       if (ViewFSUtils.isViewFS(source, hadoopConf)) {\n-        return ViewFSUtils.matchingFileSystem(source, options, hadoopConf);\n+        return ViewFSUtils.matchingFileSystem(source, options.toArray(new String[0]), hadoopConf);", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyMjAzOA==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389022038", "bodyText": "I'm going to deal with this class separately... I think we can rip out the viewfs support tooling... since we explicitly ban it.", "author": "ctubbsii", "createdAt": "2020-03-06T16:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1Njg3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NjIzMg==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388966232", "body": "This is neat.  The name is a little long though, could just call it ```ApiWarner``` or ```ApiNotifier```.  I wonder if there are other deprecated APIs that we want to warn about?  Could be a follow on task.", "bodyText": "This is neat.  The name is a little long though, could just call it ApiWarner or ApiNotifier.  I wonder if there are other deprecated APIs that we want to warn about?  Could be a follow on task.", "bodyHTML": "<p dir=\"auto\">This is neat.  The name is a little long though, could just call it <code>ApiWarner</code> or <code>ApiNotifier</code>.  I wonder if there are other deprecated APIs that we want to warn about?  Could be a follow on task.</p>", "author": "milleruntime", "createdAt": "2020-03-06T15:23:50Z", "path": "server/base/src/main/java/org/apache/accumulo/server/fs/InterfaceEvolutionWarner.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.accumulo.server.fs;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class InterfaceEvolutionWarner {", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyMzI0Mg==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389023242", "bodyText": "Nothing is tied to the name, not even its logger, so we can rename, move, and reuse it however we want, as needed.", "author": "ctubbsii", "createdAt": "2020-03-06T16:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2NjIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2OTYyNA==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r388969624", "body": "Can never have enough sanity checks!  Could create unit tests for these checks, one where two configured Volumes get normalized to the same Path.", "bodyText": "Can never have enough sanity checks!  Could create unit tests for these checks, one where two configured Volumes get normalized to the same Path.", "bodyHTML": "<p dir=\"auto\">Can never have enough sanity checks!  Could create unit tests for these checks, one where two configured Volumes get normalized to the same Path.</p>", "author": "milleruntime", "createdAt": "2020-03-06T15:29:30Z", "path": "core/src/main/java/org/apache/accumulo/core/volume/VolumeConfiguration.java", "diffHunk": "@@ -107,29 +110,31 @@ public static String getConfiguredBaseDir(AccumuloConfiguration conf,\n \n         try {\n           // pass through URI to unescape hex encoded chars (e.g. convert %2C to \",\" char)\n-          configuredBaseDirs[i++] = new Path(new URI(namespace)).toString();\n+          configuredBaseDirs.add(new Path(new URI(namespace)).toString());\n         } catch (URISyntaxException e) {\n           throw new IllegalArgumentException(Property.INSTANCE_VOLUMES.getKey() + \" contains \"\n               + namespace + \" which has a syntax error\", e);\n         }\n       }\n     }\n \n-    return configuredBaseDirs;\n+    LinkedHashSet<String> deduplicated = new LinkedHashSet<>();\n+    deduplicated.addAll(configuredBaseDirs);\n+    if (deduplicated.isEmpty()) {\n+      throw new IllegalArgumentException(\n+          Property.INSTANCE_VOLUMES.getKey() + \" contains no volumes (\" + ns + \")\");\n+    }\n+    if (deduplicated.size() < configuredBaseDirs.size()) {\n+      throw new IllegalArgumentException(\n+          Property.INSTANCE_VOLUMES.getKey() + \" contains duplicate volumes (\" + ns + \")\");", "originalCommit": "d886d869e628874054379f2b5ecdad702d9e0881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTAyNjE4MQ==", "url": "https://github.com/apache/accumulo/pull/1551#discussion_r389026181", "bodyText": "This code is likely to change with #1397, so I didn't want to spend too much time adding more stuff like that just yet, but can do so with #1397.", "author": "ctubbsii", "createdAt": "2020-03-06T17:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk2OTYyNA=="}], "type": "inlineReview"}, {"oid": "f9db0963603439a648af2f8a7aa8942f18c247e0", "url": "https://github.com/apache/accumulo/commit/f9db0963603439a648af2f8a7aa8942f18c247e0", "message": "Update server/master/src/main/java/org/apache/accumulo/master/tableOps/tableImport/CreateImportDir.java\n\nCo-Authored-By: Mike Miller <mmiller@apache.org>", "committedDate": "2020-03-06T16:56:06Z", "type": "commit"}]}