{"pr_number": 1556, "pr_title": "Fixes #1488 - ManyWriteAheadLogsIT asserts open WALS equal to zero.", "pr_author": "jzgithub1", "pr_createdAt": "2020-03-10T18:17:39Z", "pr_url": "https://github.com/apache/accumulo/pull/1556", "timeline": [{"oid": "0309bf5ed7ca82013235c0105600aa5acd075e45", "url": "https://github.com/apache/accumulo/commit/0309bf5ed7ca82013235c0105600aa5acd075e45", "message": "WIP - Fixes #1488 - ManyWriteAheadLogsIT sees CLOSED and UNREFERENCED WALS (not OPEN) causing open == 0", "committedDate": "2020-03-10T18:13:37Z", "type": "commit"}, {"oid": "9e51ba0db8220d34d842df3098fe5e27a3aabd8f", "url": "https://github.com/apache/accumulo/commit/9e51ba0db8220d34d842df3098fe5e27a3aabd8f", "message": "Fixes #1488 - ManyWriteAheadLogsIT retries to find open WALS", "committedDate": "2020-03-10T19:41:12Z", "type": "commit"}, {"oid": "f21c9102bfb5ead79107e6505e0649fba204f7d3", "url": "https://github.com/apache/accumulo/commit/f21c9102bfb5ead79107e6505e0649fba204f7d3", "message": "Fixes #1488 - ManyWriteAheadLogsIT retries to find open WALS", "committedDate": "2020-03-10T20:04:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1NDU0Ng==", "url": "https://github.com/apache/accumulo/pull/1556#discussion_r390654546", "body": "```suggestion\r\n    log.debug(\"It took {} attempt(s) to find {} open WALs\", attempts, open);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                log.debug(\"It took \" + attempts + \" attempt(s) to find an open WAL\");\n          \n          \n            \n                log.debug(\"It took {} attempt(s) to find {} open WALs\", attempts, open);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    log<span class=\"pl-k\">.</span>debug(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>It took <span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x\">+</span><span class=\"x\"> attempts </span><span class=\"pl-k x\">+</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x x-last\"> </span>attempt(s) to find <span class=\"x x-first x-last\">an</span> open <span class=\"x x-first\">WAL</span><span class=\"pl-pds x x-last\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    log<span class=\"pl-k\">.</span>debug(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>It took <span class=\"x x-first x-last\">{} </span>attempt(s) to find <span class=\"x x-first x-last\">{}</span> open <span class=\"x x-first\">WALs</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">, attempts, open</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ctubbsii", "createdAt": "2020-03-10T22:45:56Z", "path": "test/src/main/java/org/apache/accumulo/test/functional/ManyWriteAheadLogsIT.java", "diffHunk": "@@ -198,16 +198,33 @@ public void testMany() throws Exception {\n   }\n \n   private void addOpenWals(ServerContext c, Set<String> allWalsSeen) throws Exception {\n-    Map<String,WalState> wals = WALSunnyDayIT._getWals(c);\n-    Set<Entry<String,WalState>> es = wals.entrySet();\n+\n     int open = 0;\n-    for (Entry<String,WalState> entry : es) {\n-      if (entry.getValue() == WalState.OPEN) {\n-        open++;\n-        allWalsSeen.add(entry.getKey());\n+    int attempts = 0;\n+    boolean foundWal = false;\n+\n+    while (open == 0) {\n+      attempts++;\n+      Map<String,WalState> wals = WALSunnyDayIT._getWals(c);\n+      Set<Entry<String,WalState>> es = wals.entrySet();\n+      for (Entry<String,WalState> entry : es) {\n+        if (entry.getValue() == WalState.OPEN) {\n+          open++;\n+          allWalsSeen.add(entry.getKey());\n+          foundWal = true;\n+        } else {\n+          log.error(\"The WalState is \" + entry.getValue());// CLOSED or UNREFERENCED\n+        }\n+      }\n+\n+      if (!foundWal) {\n+        Thread.sleep(50);\n+        if (attempts % 50 == 0)\n+          log.info(\"Has not found an open WAL in \" + attempts + \" attempts.\");\n       }\n     }\n \n+    log.debug(\"It took \" + attempts + \" attempt(s) to find an open WAL\");", "originalCommit": "f21c9102bfb5ead79107e6505e0649fba204f7d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1NDgzMQ==", "url": "https://github.com/apache/accumulo/pull/1556#discussion_r390654831", "body": "```suggestion\r\n          log.debug(\"No open WALs found in {} attempts.\", attempts);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      log.info(\"Has not found an open WAL in \" + attempts + \" attempts.\");\n          \n          \n            \n                      log.debug(\"No open WALs found in {} attempts.\", attempts);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">          log<span class=\"pl-k\">.</span><span class=\"x x-first\">info(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x x-last\">Has not found an </span>open <span class=\"x x-first x-last\">WAL </span>in <span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x\">+</span><span class=\"x x-last\"> </span>attempts<span class=\"x x-first\"> </span><span class=\"pl-k x\">+</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x x-last\">\"</span> attempts<span class=\"x x-first\">.</span><span class=\"pl-pds x x-last\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          log<span class=\"pl-k\">.</span><span class=\"x x-first\">debug(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x x-last\">No </span>open <span class=\"x x-first x-last\">WALs found </span>in <span class=\"x x-first x-last\">{} </span>attempts<span class=\"x x-first\">.</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">,</span> attempts);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ctubbsii", "createdAt": "2020-03-10T22:46:42Z", "path": "test/src/main/java/org/apache/accumulo/test/functional/ManyWriteAheadLogsIT.java", "diffHunk": "@@ -198,16 +198,33 @@ public void testMany() throws Exception {\n   }\n \n   private void addOpenWals(ServerContext c, Set<String> allWalsSeen) throws Exception {\n-    Map<String,WalState> wals = WALSunnyDayIT._getWals(c);\n-    Set<Entry<String,WalState>> es = wals.entrySet();\n+\n     int open = 0;\n-    for (Entry<String,WalState> entry : es) {\n-      if (entry.getValue() == WalState.OPEN) {\n-        open++;\n-        allWalsSeen.add(entry.getKey());\n+    int attempts = 0;\n+    boolean foundWal = false;\n+\n+    while (open == 0) {\n+      attempts++;\n+      Map<String,WalState> wals = WALSunnyDayIT._getWals(c);\n+      Set<Entry<String,WalState>> es = wals.entrySet();\n+      for (Entry<String,WalState> entry : es) {\n+        if (entry.getValue() == WalState.OPEN) {\n+          open++;\n+          allWalsSeen.add(entry.getKey());\n+          foundWal = true;\n+        } else {\n+          log.error(\"The WalState is \" + entry.getValue());// CLOSED or UNREFERENCED\n+        }\n+      }\n+\n+      if (!foundWal) {\n+        Thread.sleep(50);\n+        if (attempts % 50 == 0)\n+          log.info(\"Has not found an open WAL in \" + attempts + \" attempts.\");", "originalCommit": "f21c9102bfb5ead79107e6505e0649fba204f7d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1NTIwNw==", "url": "https://github.com/apache/accumulo/pull/1556#discussion_r390655207", "body": "The formatter will reform that line, and possibly others. Try running `mvn clean verify -DskipTests` on this branch to run the code formatter, and to check for other style issues.\r\n\r\n```suggestion\r\n          log.debug(\"The WalState for {} is {}\", entry.getKey(), entry.getValue()); // CLOSED or UNREFERENCED\r\n```", "bodyText": "The formatter will reform that line, and possibly others. Try running mvn clean verify -DskipTests on this branch to run the code formatter, and to check for other style issues.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      log.error(\"The WalState is \" + entry.getValue());// CLOSED or UNREFERENCED\n          \n          \n            \n                      log.debug(\"The WalState for {} is {}\", entry.getKey(), entry.getValue()); // CLOSED or UNREFERENCED", "bodyHTML": "<p dir=\"auto\">The formatter will reform that line, and possibly others. Try running <code>mvn clean verify -DskipTests</code> on this branch to run the code formatter, and to check for other style issues.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">          log<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">error</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The WalState is <span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x x-last\">+</span> entry<span class=\"pl-k\">.</span>getValue());<span class=\"pl-c\"><span class=\"pl-c\">//</span> CLOSED or UNREFERENCED</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          log<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">debug</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The WalState <span class=\"x x-first x-last\">for {} </span>is <span class=\"x x-first\">{}</span><span class=\"pl-pds x\">\"</span></span><span class=\"x\">, entry</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getKey(),</span> entry<span class=\"pl-k\">.</span>getValue());<span class=\"x x-first x-last\"> </span><span class=\"pl-c\"><span class=\"pl-c\">//</span> CLOSED or UNREFERENCED</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ctubbsii", "createdAt": "2020-03-10T22:47:49Z", "path": "test/src/main/java/org/apache/accumulo/test/functional/ManyWriteAheadLogsIT.java", "diffHunk": "@@ -198,16 +198,33 @@ public void testMany() throws Exception {\n   }\n \n   private void addOpenWals(ServerContext c, Set<String> allWalsSeen) throws Exception {\n-    Map<String,WalState> wals = WALSunnyDayIT._getWals(c);\n-    Set<Entry<String,WalState>> es = wals.entrySet();\n+\n     int open = 0;\n-    for (Entry<String,WalState> entry : es) {\n-      if (entry.getValue() == WalState.OPEN) {\n-        open++;\n-        allWalsSeen.add(entry.getKey());\n+    int attempts = 0;\n+    boolean foundWal = false;\n+\n+    while (open == 0) {\n+      attempts++;\n+      Map<String,WalState> wals = WALSunnyDayIT._getWals(c);\n+      Set<Entry<String,WalState>> es = wals.entrySet();\n+      for (Entry<String,WalState> entry : es) {\n+        if (entry.getValue() == WalState.OPEN) {\n+          open++;\n+          allWalsSeen.add(entry.getKey());\n+          foundWal = true;\n+        } else {\n+          log.error(\"The WalState is \" + entry.getValue());// CLOSED or UNREFERENCED", "originalCommit": "f21c9102bfb5ead79107e6505e0649fba204f7d3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccf16cb9c92695bea72dd486c52e0a66feb4c214", "url": "https://github.com/apache/accumulo/commit/ccf16cb9c92695bea72dd486c52e0a66feb4c214", "message": "Update test/src/main/java/org/apache/accumulo/test/functional/ManyWriteAheadLogsIT.java\n\nCo-Authored-By: Christopher Tubbs <ctubbsii@apache.org>", "committedDate": "2020-03-11T02:35:17Z", "type": "commit"}, {"oid": "e7d2b257767f99d89b04b72914f2ec59fc354de9", "url": "https://github.com/apache/accumulo/commit/e7d2b257767f99d89b04b72914f2ec59fc354de9", "message": "Update test/src/main/java/org/apache/accumulo/test/functional/ManyWriteAheadLogsIT.java\n\nCo-Authored-By: Christopher Tubbs <ctubbsii@apache.org>", "committedDate": "2020-03-11T02:35:29Z", "type": "commit"}, {"oid": "355ff0dc746e8b6e907f68edb5cdce19e6270fe7", "url": "https://github.com/apache/accumulo/commit/355ff0dc746e8b6e907f68edb5cdce19e6270fe7", "message": "Update test/src/main/java/org/apache/accumulo/test/functional/ManyWriteAheadLogsIT.java\n\nCo-Authored-By: Christopher Tubbs <ctubbsii@apache.org>", "committedDate": "2020-03-11T02:35:38Z", "type": "commit"}]}