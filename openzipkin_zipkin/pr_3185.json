{"pr_number": 3185, "pr_title": "Composable index templates for ES 7.8", "pr_author": "ccharnkij", "pr_createdAt": "2020-08-22T21:40:38Z", "pr_url": "https://github.com/openzipkin/zipkin/pull/3185", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDI0MA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150240", "body": "beginTemplate", "bodyText": "beginTemplate", "bodyHTML": "<p dir=\"auto\">beginTemplate</p>", "author": "codefromthecrypt", "createdAt": "2020-08-22T23:51:07Z", "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/VersionSpecificTemplates.java", "diffHunk": "@@ -66,10 +67,35 @@ String indexProperties(float version) {\n     return result + \",\\n    \\\"index.mapper.dynamic\\\": false\\n\";\n   }\n \n+  String indexTemplate(float version) {\n+    if (version >= 7.8f) {\n+      return \"\\\"template\\\": {\\n\";\n+    }\n+\n+    return \"\";\n+  }\n+\n+  String indexTemplateClosing(float version) {\n+    if (version >= 7.8f) {\n+      return \"},\\n\";\n+    }\n+\n+    return \"\";\n+  }\n+\n+  String templatePriority(float version) {\n+    if (version >= 7.8f) {\n+      return \"\\\"priority\\\": \" + templatePriority + \"\\n\";\n+    }\n+\n+    return \"\";\n+  }\n+\n   /** Templatized due to version differences. Only fields used in search are declared */\n   String spanIndexTemplate(float version) {\n     String result = \"{\\n\"\n       + \"  \" + indexPattern(TYPE_SPAN, version) + \",\\n\"\n+      + indexTemplate(version)", "originalCommit": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDI2Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150262", "body": "squash this and below into endTemplate as it is distracting to add template priority here when sometimes there's no template anyway.", "bodyText": "squash this and below into endTemplate as it is distracting to add template priority here when sometimes there's no template anyway.", "bodyHTML": "<p dir=\"auto\">squash this and below into endTemplate as it is distracting to add template priority here when sometimes there's no template anyway.</p>", "author": "codefromthecrypt", "createdAt": "2020-08-22T23:52:06Z", "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/VersionSpecificTemplates.java", "diffHunk": "@@ -141,6 +167,8 @@ String spanIndexTemplate(float version) {\n         + \"      \\\"_q\\\": \" + KEYWORD + \"\\n\"\n         + \"    }\\n\")\n         + \"  }\\n\"\n+        + indexTemplateClosing(version)", "originalCommit": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDMzOA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150338", "body": "sorry I don't understand what is special checked here, as unless blind, I would expect the same to pass before 7.8?\r\n\r\nIn any case, if we are verifying these are legacy, we should mention that in the test name or description, as currently the name doesn't seem to suggest what we are looking at (unless I miss something)", "bodyText": "sorry I don't understand what is special checked here, as unless blind, I would expect the same to pass before 7.8?\nIn any case, if we are verifying these are legacy, we should mention that in the test name or description, as currently the name doesn't seem to suggest what we are looking at (unless I miss something)", "bodyHTML": "<p dir=\"auto\">sorry I don't understand what is special checked here, as unless blind, I would expect the same to pass before 7.8?</p>\n<p dir=\"auto\">In any case, if we are verifying these are legacy, we should mention that in the test name or description, as currently the name doesn't seem to suggest what we are looking at (unless I miss something)</p>", "author": "codefromthecrypt", "createdAt": "2020-08-22T23:53:19Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/ElasticsearchStorageTest.java", "diffHunk": "@@ -199,6 +199,26 @@\n       String.format(\"ElasticsearchStorage{initialEndpoints=%s, index=zipkin}\", server.httpUri()));\n   }\n \n+  @Test void check_composable_indexTemplate() throws Exception {\n+    server.enqueue(AggregatedHttpResponse.of(\n+      HttpStatus.OK, MediaType.JSON_UTF_8, \"{\\\"version\\\":{\\\"number\\\":\\\"7.8.0\\\"}}\"));\n+    server.enqueue(SUCCESS_RESPONSE); // get span template\n+    server.enqueue(SUCCESS_RESPONSE); // get dependency template\n+    server.enqueue(SUCCESS_RESPONSE); // get autocomplete template\n+    server.enqueue(SUCCESS_RESPONSE); // cluster health\n+\n+    storage.check();\n+\n+    server.takeRequest(); // get version\n+\n+    assertThat(server.takeRequest().request().path()) // get span template", "originalCommit": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE4ODU4Mw==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475188583", "bodyText": "Hi,\nThis test is for checking that Zipkin uses resource path of \"/_index_template/....\", as opposed to \"/_template/...\", for ES >= 7.8 when creating index templates. I can remove it if it's not needed. Or I can change test name (or add comment) for it to be more descriptive.", "author": "ccharnkij", "createdAt": "2020-08-23T08:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDMzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI4OTMwNw==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475289307", "bodyText": "yeah you can clarify with comment why it is important _index_template as I believe in some cases it worked before with _template. composable is a bit jargon to a passer-by.", "author": "codefromthecrypt", "createdAt": "2020-08-24T00:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE1MDM5MA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475150390", "body": "nice. I suppose at some point we should switch this assert to json path, but works for me.", "bodyText": "nice. I suppose at some point we should switch this assert to json path, but works for me.", "bodyHTML": "<p dir=\"auto\">nice. I suppose at some point we should switch this assert to json path, but works for me.</p>", "author": "codefromthecrypt", "createdAt": "2020-08-22T23:54:16Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/VersionSpecificTemplatesTest.java", "diffHunk": "@@ -107,6 +107,24 @@\n       + \"  }\");\n   }\n \n+  @Test void version78() {\n+    IndexTemplates template = storage.versionSpecificTemplates(7.8f);\n+\n+    assertThat(template.version()).isEqualTo(7.8f);\n+    assertThat(template.autocomplete())\n+      .withFailMessage(\"Starting at v7.x, we delimit index and type with hyphen\")\n+      .contains(\"\\\"index_patterns\\\": \\\"zipkin-autocomplete-*\\\"\");\n+    assertThat(template.span())\n+      .contains(\"\\\"template\\\": {\\n\")", "originalCommit": "c3cf8028b2d73cca9dbb6d377d92680a76c2895b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "url": "https://github.com/openzipkin/zipkin/commit/3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "message": "Composable index templates for ES 7.8", "committedDate": "2020-08-24T07:25:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MDc3NA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475450774", "body": "this comment doesn't belong. probably you want to say `// highest priority`", "bodyText": "this comment doesn't belong. probably you want to say // highest priority", "bodyHTML": "<p dir=\"auto\">this comment doesn't belong. probably you want to say <code>// highest priority</code></p>", "author": "codefromthecrypt", "createdAt": "2020-08-24T09:12:07Z", "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchStorage.java", "diffHunk": "@@ -88,7 +88,8 @@ public static Builder newBuilder(LazyHttpClient lazyHttpClient) {\n       .flushOnWrites(false)\n       .autocompleteKeys(Collections.emptyList())\n       .autocompleteTtl((int) TimeUnit.HOURS.toMillis(1))\n-      .autocompleteCardinality(5 * 4000); // Ex. 5 site tags with cardinality 4000 each\n+      .autocompleteCardinality(5 * 4000)\n+      .templatePriority(\"0\"); // Ex. 5 site tags with cardinality 4000 each", "originalCommit": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTIyNQ==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475451225", "body": "for example, eaisiest way is to change this to 7.9", "bodyText": "for example, eaisiest way is to change this to 7.9", "bodyHTML": "<p dir=\"auto\">for example, eaisiest way is to change this to 7.9</p>", "author": "codefromthecrypt", "createdAt": "2020-08-24T09:12:55Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/ElasticsearchStorageTest.java", "diffHunk": "@@ -199,6 +199,30 @@\n       String.format(\"ElasticsearchStorage{initialEndpoints=%s, index=zipkin}\", server.httpUri()));\n   }\n \n+  /**\n+   * Ensure that Zipkin uses the correct resource path of /_index_template when creating index\n+   * template for ES >= 7.8, as opposed to ES < 7.8 that uses /_template/\n+   */\n+  @Test void check_create_composable_indexTemplate_resourcePath() throws Exception {\n+    server.enqueue(AggregatedHttpResponse.of(\n+      HttpStatus.OK, MediaType.JSON_UTF_8, \"{\\\"version\\\":{\\\"number\\\":\\\"7.8.0\\\"}}\"));", "originalCommit": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTUyNQ==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475451525", "body": "if using square formatter it will expand wildcard imports", "bodyText": "if using square formatter it will expand wildcard imports", "bodyHTML": "<p dir=\"auto\">if using square formatter it will expand wildcard imports</p>", "author": "codefromthecrypt", "createdAt": "2020-08-24T09:13:27Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "diffHunk": "@@ -13,8 +13,14 @@\n  */\n package zipkin2.elasticsearch.integration;\n \n+import com.linecorp.armeria.common.*;", "originalCommit": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MTYzNQ==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475451635", "body": "maybe revert this as it effects all tests.. that or comment why.", "bodyText": "maybe revert this as it effects all tests.. that or comment why.", "bodyHTML": "<p dir=\"auto\">maybe revert this as it effects all tests.. that or comment why.</p>", "author": "codefromthecrypt", "createdAt": "2020-08-24T09:13:40Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ElasticsearchStorageExtension.java", "diffHunk": "@@ -116,6 +116,7 @@ Builder computeStorageBuilder() {\n     WebClient client = builder.build();\n     return ElasticsearchStorage.newBuilder(() -> client)\n       .index(\"zipkin-test\")\n+      .templatePriority(\"10\")", "originalCommit": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1MjU2Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r475452562", "body": "should be a separate test instead of a before for everything.", "bodyText": "should be a separate test instead of a before for everything.", "bodyHTML": "<p dir=\"auto\">should be a separate test instead of a before for everything.</p>", "author": "codefromthecrypt", "createdAt": "2020-08-24T09:15:12Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "diffHunk": "@@ -25,4 +31,40 @@\n   @Override ElasticsearchStorageExtension backend() {\n     return backend;\n   }\n+\n+  /**\n+   * Create a \"catch-all\" index template with the lowest priority prior to running tests to\n+   * ensure that the index templates created during tests with higher priority function as\n+   * designed. Only applicable for ES >= 7.8\n+   */\n+  @BeforeAll void setUpCatchAllTemplate() throws IOException {", "originalCommit": "3591b6f45d7794108e3f5b72d48edb3e3ab36cc7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4a45de4126b6d5403dc7c12a83667490fbb19b85", "url": "https://github.com/openzipkin/zipkin/commit/4a45de4126b6d5403dc7c12a83667490fbb19b85", "message": "Composable index templates for ES 7.8", "committedDate": "2020-08-28T05:18:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3Njk1NA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478876954", "body": "I think you can move this to the ITEs7 class?", "bodyText": "I think you can move this to the ITEs7 class?", "bodyHTML": "<p dir=\"auto\">I think you can move this to the ITEs7 class?</p>", "author": "codefromthecrypt", "createdAt": "2020-08-28T07:16:57Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorage.java", "diffHunk": "@@ -114,4 +114,12 @@\n       storage.clear();\n     }\n   }\n+\n+  @Nested\n+  class ITEnsureIndexTemplate extends zipkin2.elasticsearch.integration.ITEnsureIndexTemplate {", "originalCommit": "4a45de4126b6d5403dc7c12a83667490fbb19b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3NzM5MA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478877390", "body": "with this pinned to the ES 7 IT, you don't need to check version as our image is already this I think right? In this case you can do this in the test method itself", "bodyText": "with this pinned to the ES 7 IT, you don't need to check version as our image is already this I think right? In this case you can do this in the test method itself", "bodyHTML": "<p dir=\"auto\">with this pinned to the ES 7 IT, you don't need to check version as our image is already this I think right? In this case you can do this in the test method itself</p>", "author": "codefromthecrypt", "createdAt": "2020-08-28T07:18:03Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import java.util.List;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assumptions.assumeTrue;\n+import static zipkin2.TestObjects.LOTS_OF_SPANS;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @BeforeAll void setUpCatchAllTemplate(TestInfo testInfo) throws IOException {", "originalCommit": "4a45de4126b6d5403dc7c12a83667490fbb19b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3ODEwNQ==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478878105", "body": "this should be  a \"finally\" of the catchAllTemplateTest as it would only need to be tested once anyway", "bodyText": "this should be  a \"finally\" of the catchAllTemplateTest as it would only need to be tested once anyway", "bodyHTML": "<p dir=\"auto\">this should be  a \"finally\" of the catchAllTemplateTest as it would only need to be tested once anyway</p>", "author": "codefromthecrypt", "createdAt": "2020-08-28T07:19:41Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import java.util.List;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assumptions.assumeTrue;\n+import static zipkin2.TestObjects.LOTS_OF_SPANS;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @BeforeAll void setUpCatchAllTemplate(TestInfo testInfo) throws IOException {\n+    ElasticsearchStorage.Builder builder = newStorageBuilder(testInfo);\n+    storage = builder.build();\n+    assumeTrue(storage.version() >= 7.8f, () -> \"Applicable only for ES >= 7.8, skipping test\");\n+\n+    /**\n+     * Delete all index templates in order to create the \"catch-all\" index template, because\n+     * ES does not allow multiple index templates of the same index_patterns and priority\n+     */\n+    deleteIndexTemplate(\"*\");\n+    setUpCatchAllTemplate();\n+  }\n+\n+  @Test void createZipkinIndexTemplate_getTraces_returnsSuccess() throws IOException {\n+    /** Create index template with {@link ElasticsearchStorage#ensureIndexTemplates()} */\n+    CheckResult check = storage.check();\n+\n+    assertThat(check.ok()).isTrue();\n+\n+    List<String> traceIds = asList(LOTS_OF_SPANS[0].traceId(), LOTS_OF_SPANS[1].traceId());\n+    List<Span> spans = asList(LOTS_OF_SPANS[0], LOTS_OF_SPANS[1]);\n+\n+    storage.spanConsumer().accept(spans).execute();\n+\n+    assertThat(storage.traces().getTraces(traceIds).execute())\n+      .containsOnly(asList(LOTS_OF_SPANS[0]), asList(LOTS_OF_SPANS[1]));\n+  }\n+\n+  /**\n+   * Create a \"catch-all\" index template with the lowest priority prior to running tests to\n+   * ensure that the index templates created during tests with higher priority function as\n+   * designed. Only applicable for ES >= 7.8\n+   */\n+  void setUpCatchAllTemplate() throws IOException {\n+    AggregatedHttpRequest updateTemplate = AggregatedHttpRequest.of(\n+      RequestHeaders.of(\n+        HttpMethod.PUT, catchAllIndexPath(), HttpHeaderNames.CONTENT_TYPE, MediaType.JSON_UTF_8),\n+      HttpData.ofUtf8(catchAllTemplate()));\n+    Internal.instance.http(storage).newCall(updateTemplate, (parser, contentString) -> null,\n+      \"update-template\").execute();\n+  }\n+\n+  String catchAllIndexPath() {\n+    return \"/_index_template/catch-all\";\n+  }\n+\n+  String catchAllTemplate() {\n+    return \"{\\n\"\n+      + \"  \\\"index_patterns\\\" : [\\\"*\\\"],\\n\"\n+      + \"  \\\"priority\\\" : 0,\\n\"\n+      + \"  \\\"template\\\": {\\n\"\n+      + \"    \\\"settings\\\" : {\\n\"\n+      + \"      \\\"number_of_shards\\\" : 1\\n\"\n+      + \"    },\\n\"\n+      + \"    \\\"mappings\\\" : {\\n\"\n+      + \"      \\\"_source\\\" : { \\\"enabled\\\" : true }\\n\"\n+      + \"    }\\n\"\n+      + \"  }\\n\"\n+      + \"}\";\n+  }\n+\n+  void deleteIndexTemplate(String pattern) throws IOException {\n+    String url = \"/_index_template/\" + pattern;\n+    AggregatedHttpRequest delete = AggregatedHttpRequest.of(HttpMethod.DELETE, url);\n+    Internal.instance.http(storage)\n+      .newCall(delete, (parser, contentString) -> null, \"delete-index\").execute();\n+  }\n+\n+  /**\n+   * Delete \"catch-all\" index template so it does not interfere with any other test\n+   */\n+  @AfterAll void deleteCatchAllTemplate() throws IOException {", "originalCommit": "4a45de4126b6d5403dc7c12a83667490fbb19b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODg3ODY5MA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r478878690", "body": "verify the catch-all template works? you might want to make something more interesting so that you can use ES HTTP query on it. ex this one https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7", "bodyText": "verify the catch-all template works? you might want to make something more interesting so that you can use ES HTTP query on it. ex this one https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7", "bodyHTML": "<p dir=\"auto\">verify the catch-all template works? you might want to make something more interesting so that you can use ES HTTP query on it. ex this one <a href=\"https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7\">https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7</a></p>", "author": "codefromthecrypt", "createdAt": "2020-08-28T07:20:57Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import java.util.List;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assumptions.assumeTrue;\n+import static zipkin2.TestObjects.LOTS_OF_SPANS;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @BeforeAll void setUpCatchAllTemplate(TestInfo testInfo) throws IOException {\n+    ElasticsearchStorage.Builder builder = newStorageBuilder(testInfo);\n+    storage = builder.build();\n+    assumeTrue(storage.version() >= 7.8f, () -> \"Applicable only for ES >= 7.8, skipping test\");\n+\n+    /**\n+     * Delete all index templates in order to create the \"catch-all\" index template, because\n+     * ES does not allow multiple index templates of the same index_patterns and priority\n+     */\n+    deleteIndexTemplate(\"*\");\n+    setUpCatchAllTemplate();\n+  }\n+\n+  @Test void createZipkinIndexTemplate_getTraces_returnsSuccess() throws IOException {\n+    /** Create index template with {@link ElasticsearchStorage#ensureIndexTemplates()} */\n+    CheckResult check = storage.check();\n+\n+    assertThat(check.ok()).isTrue();\n+\n+    List<String> traceIds = asList(LOTS_OF_SPANS[0].traceId(), LOTS_OF_SPANS[1].traceId());\n+    List<Span> spans = asList(LOTS_OF_SPANS[0], LOTS_OF_SPANS[1]);\n+\n+    storage.spanConsumer().accept(spans).execute();\n+\n+    assertThat(storage.traces().getTraces(traceIds).execute())", "originalCommit": "4a45de4126b6d5403dc7c12a83667490fbb19b85", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f1e14495a9739ac692056bfed6d542e70d02c121", "url": "https://github.com/openzipkin/zipkin/commit/f1e14495a9739ac692056bfed6d542e70d02c121", "message": "Composable index templates for ES 7.8", "committedDate": "2020-08-29T10:36:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwMzc3MA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479703770", "body": "as other tests we add to ITEnsureIndexTemplate won't necessarily effect templatePriority, I would move that setting into the test itself. Then, you can use the same setup as the other tests like this:\r\n\r\n```java\r\n    @Override protected ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo) {\r\n      return backend().computeStorageBuilder().index(index(testInfo));\r\n    }\r\n\r\n    @AfterEach public void clear() throws IOException {\r\n      storage.clear();\r\n    }\r\n```", "bodyText": "as other tests we add to ITEnsureIndexTemplate won't necessarily effect templatePriority, I would move that setting into the test itself. Then, you can use the same setup as the other tests like this:\n    @Override protected ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo) {\n      return backend().computeStorageBuilder().index(index(testInfo));\n    }\n\n    @AfterEach public void clear() throws IOException {\n      storage.clear();\n    }", "bodyHTML": "<p dir=\"auto\">as other tests we add to ITEnsureIndexTemplate won't necessarily effect templatePriority, I would move that setting into the test itself. Then, you can use the same setup as the other tests like this:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    @Override protected ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo) {\n      return backend().computeStorageBuilder().index(index(testInfo));\n    }\n\n    @AfterEach public void clear() throws IOException {\n      storage.clear();\n    }\"><pre>    <span class=\"pl-k\">@Override</span> <span class=\"pl-k\">protected</span> <span class=\"pl-smi\">ElasticsearchStorage</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Builder</span> newStorageBuilder(<span class=\"pl-smi\">TestInfo</span> testInfo) {\n      <span class=\"pl-k\">return</span> backend()<span class=\"pl-k\">.</span>computeStorageBuilder()<span class=\"pl-k\">.</span>index(index(testInfo));\n    }\n\n    <span class=\"pl-k\">@AfterEach</span> <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> clear() throws <span class=\"pl-smi\">IOException</span> {\n      storage<span class=\"pl-k\">.</span>clear();\n    }</pre></div>", "author": "codefromthecrypt", "createdAt": "2020-08-30T00:22:24Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITElasticsearchStorageV7.java", "diffHunk": "@@ -25,4 +30,12 @@\n   @Override ElasticsearchStorageExtension backend() {\n     return backend;\n   }\n+\n+  @Nested\n+  class ITEnsureIndexTemplate extends zipkin2.elasticsearch.integration.ITEnsureIndexTemplate {\n+    @Override protected ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo) {", "originalCommit": "f1e14495a9739ac692056bfed6d542e70d02c121", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwMzc3OA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479703778", "body": "nit protected not needed in the same package", "bodyText": "nit protected not needed in the same package", "bodyHTML": "<p dir=\"auto\">nit protected not needed in the same package</p>", "author": "codefromthecrypt", "createdAt": "2020-08-30T00:22:39Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+import zipkin2.storage.QueryRequest;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static zipkin2.TestObjects.CLIENT_SPAN;\n+import static zipkin2.TestObjects.DAY;\n+import static zipkin2.TestObjects.TODAY;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);", "originalCommit": "f1e14495a9739ac692056bfed6d542e70d02c121", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwNDQzNw==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479704437", "body": "if this is the catch all change you want to make, it would be useful to test that this applies. The test could pass for a subtle reason, then in ES 7.10 it might break and we wouldn't know what it was trying to do either.\r\n\r\nFor this reason, making a template that sets default which I think this does, maybe isn't a good choice. \r\nInstead try something with semantic value and also relevant in tracing? ex\r\n```\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"tags.http.status_code\": {\r\n        \"norms\": false,\r\n        \"type\": \"keyword\"\r\n      }\r\n    }\r\n  }\r\n```\r\n\r\nIn this case, your test can switch from making a fake tag \"queryTest\"->\"ok\"  to a tag very commonly requested  like \"http.status_code\" \"404\"\r\n\r\nThen, you can verify your catch-all worked by using HTTP to do the following (except in java):\r\n\r\n```\r\ncurl -s 'localhost:9200/zipkin-span-*/_search?q=tags.http.status_code:404'\r\n```\r\n\r\nEx what you are doing is literally verifying automatically this https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7", "bodyText": "if this is the catch all change you want to make, it would be useful to test that this applies. The test could pass for a subtle reason, then in ES 7.10 it might break and we wouldn't know what it was trying to do either.\nFor this reason, making a template that sets default which I think this does, maybe isn't a good choice.\nInstead try something with semantic value and also relevant in tracing? ex\n  \"mappings\": {\n    \"properties\": {\n      \"tags.http.status_code\": {\n        \"norms\": false,\n        \"type\": \"keyword\"\n      }\n    }\n  }\n\nIn this case, your test can switch from making a fake tag \"queryTest\"->\"ok\"  to a tag very commonly requested  like \"http.status_code\" \"404\"\nThen, you can verify your catch-all worked by using HTTP to do the following (except in java):\ncurl -s 'localhost:9200/zipkin-span-*/_search?q=tags.http.status_code:404'\n\nEx what you are doing is literally verifying automatically this https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7", "bodyHTML": "<p dir=\"auto\">if this is the catch all change you want to make, it would be useful to test that this applies. The test could pass for a subtle reason, then in ES 7.10 it might break and we wouldn't know what it was trying to do either.</p>\n<p dir=\"auto\">For this reason, making a template that sets default which I think this does, maybe isn't a good choice.<br>\nInstead try something with semantic value and also relevant in tracing? ex</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  &quot;mappings&quot;: {\n    &quot;properties&quot;: {\n      &quot;tags.http.status_code&quot;: {\n        &quot;norms&quot;: false,\n        &quot;type&quot;: &quot;keyword&quot;\n      }\n    }\n  }\n\"><pre><code>  \"mappings\": {\n    \"properties\": {\n      \"tags.http.status_code\": {\n        \"norms\": false,\n        \"type\": \"keyword\"\n      }\n    }\n  }\n</code></pre></div>\n<p dir=\"auto\">In this case, your test can switch from making a fake tag \"queryTest\"-&gt;\"ok\"  to a tag very commonly requested  like \"http.status_code\" \"404\"</p>\n<p dir=\"auto\">Then, you can verify your catch-all worked by using HTTP to do the following (except in java):</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"curl -s 'localhost:9200/zipkin-span-*/_search?q=tags.http.status_code:404'\n\"><pre><code>curl -s 'localhost:9200/zipkin-span-*/_search?q=tags.http.status_code:404'\n</code></pre></div>\n<p dir=\"auto\">Ex what you are doing is literally verifying automatically this <a href=\"https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7\">https://gist.github.com/adriancole/1af1259102e7a2da1b3c9103565165d7</a></p>", "author": "codefromthecrypt", "createdAt": "2020-08-30T00:32:15Z", "path": "zipkin-storage/elasticsearch/src/test/java/zipkin2/elasticsearch/integration/ITEnsureIndexTemplate.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2015-2020 The OpenZipkin Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\n+ * in compliance with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package zipkin2.elasticsearch.integration;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import java.io.IOException;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInfo;\n+import org.junit.jupiter.api.TestInstance;\n+import zipkin2.CheckResult;\n+import zipkin2.Span;\n+import zipkin2.elasticsearch.ElasticsearchStorage;\n+import zipkin2.elasticsearch.internal.Internal;\n+import zipkin2.storage.QueryRequest;\n+\n+import static java.util.Arrays.asList;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static zipkin2.TestObjects.CLIENT_SPAN;\n+import static zipkin2.TestObjects.DAY;\n+import static zipkin2.TestObjects.TODAY;\n+\n+@TestInstance(TestInstance.Lifecycle.PER_CLASS)\n+abstract class ITEnsureIndexTemplate {\n+\n+  ElasticsearchStorage storage;\n+\n+  /**\n+   * Returns a new {@link ElasticsearchStorage.Builder} for connecting to the backend for the test.\n+   */\n+  protected abstract ElasticsearchStorage.Builder newStorageBuilder(TestInfo testInfo);\n+\n+  @Test void createZipkinIndexTemplate_getTraces_returnsSuccess(TestInfo testInfo) throws IOException {\n+    ElasticsearchStorage.Builder builder = newStorageBuilder(testInfo);\n+    storage = builder.build();\n+\n+    try {\n+      /**\n+       * Delete all index templates in order to create the \"catch-all\" index template, because\n+       * ES does not allow multiple index templates of the same index_patterns and priority\n+       */\n+      deleteIndexTemplate(\"*\");\n+      setUpCatchAllTemplate();\n+\n+      /** Create index template with {@link ElasticsearchStorage#ensureIndexTemplates()} */\n+      CheckResult check = storage.check();\n+\n+      assertThat(check.ok()).isTrue();\n+\n+      Span span = Span.newBuilder().traceId(CLIENT_SPAN.traceId())\n+        .id(\"1\")\n+        .timestamp(TODAY * 1000L)\n+        .putTag(\"queryTest\", \"ok\")\n+        .build();\n+\n+      storage.spanConsumer().accept(asList(span)).execute();\n+\n+      assertThat(storage.spanStore().getTraces(QueryRequest.newBuilder()\n+        .endTs(TODAY + DAY)\n+        .lookback(DAY * 2)\n+        .limit(10)\n+        .parseAnnotationQuery(\"queryTest=\" + span.tags().get(\"queryTest\"))\n+        .build()).execute())\n+      .flatExtracting(t -> t).containsExactly(span);\n+    }\n+    finally {\n+      /**\n+       * Delete \"catch-all\" index template so it does not interfere with any other test\n+       */\n+      deleteIndexTemplate(\"catch-all\");\n+      storage.close();\n+    }\n+  }\n+\n+  /**\n+   * Create a \"catch-all\" index template with the lowest priority prior to running tests to\n+   * ensure that the index templates created during tests with higher priority function as\n+   * designed. Only applicable for ES >= 7.8\n+   */\n+  void setUpCatchAllTemplate() throws IOException {\n+    AggregatedHttpRequest updateTemplate = AggregatedHttpRequest.of(\n+      RequestHeaders.of(\n+        HttpMethod.PUT, catchAllIndexPath(), HttpHeaderNames.CONTENT_TYPE, MediaType.JSON_UTF_8),\n+      HttpData.ofUtf8(catchAllTemplate()));\n+    Internal.instance.http(storage).newCall(updateTemplate, (parser, contentString) -> null,\n+      \"update-template\").execute();\n+  }\n+\n+  String catchAllIndexPath() {\n+    return \"/_index_template/catch-all\";\n+  }\n+\n+  String catchAllTemplate() {\n+    return \"{\\n\"\n+      + \"  \\\"index_patterns\\\" : [\\\"*\\\"],\\n\"\n+      + \"  \\\"priority\\\" : 0,\\n\"\n+      + \"  \\\"template\\\": {\\n\"\n+      + \"    \\\"settings\\\" : {\\n\"\n+      + \"      \\\"number_of_shards\\\" : 1\\n\"\n+      + \"    },\\n\"\n+      + \"    \\\"mappings\\\" : {\\n\"\n+      + \"      \\\"_source\\\" : { \\\"enabled\\\" : true }\\n\"", "originalCommit": "f1e14495a9739ac692056bfed6d542e70d02c121", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzNzMzNg==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479837336", "bodyText": "I don't think the suggested secondary template works anymore, given that ES no longer allows multiple matching index templates of the same priority. ES won't merge templates based on order anymore, and will only select 1 with the highest priority. Multiple index template with matching index patterns and priorities will result in error on PUT of the second index template. So in this case, it's either Zipkin's template or catch-all template, and I can't sneak in tags to zipkin-span-* like that.\nI do see what you mean, though. And if the objective is to test the catch-all, I think I have to use a new index that doesn't match Zipkin's template at all. Thought?", "author": "ccharnkij", "createdAt": "2020-08-31T00:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwNDQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzODM4Nw==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479838387", "bodyText": "interesting.. thanks for the info! yeah a comment should say this is the case now ( I remember hints of this in the past from @xeraa ). I do think the default template should meddle with ours in a way that would be obvious then. For example, you could change something we don't set? then read back that it is unset (as opposed to inherited/merged) would that do it?\nmeanwhile, using http in your test is still probably better as it is more realistic data, but yeah I can now expect people who setup multiple templates to have to do an offline merge of them instead of my gist now!", "author": "codefromthecrypt", "createdAt": "2020-08-31T00:42:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwNDQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTgzOTk0NQ==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479839945", "bodyText": "There are the legacy / v1 templates that can be merged, but I would be careful (multiple templates with the same order will result in a non-deterministic merging order, merging valid templates might lead to an invalid mapping). Right now they are deprecated and we'll see when we'll remove them \u2014 you have at least until 8.0.\nThe new component based approach still allows you to combine multiple pieces, but you don't merge them (to avoid the two problems mentioned above). This feature was only added in 7.8, so I'm not sure what will be the sanest approach for you \u2014 support it in 7.x already or switch over for any (upcoming) 8.x cluster.", "author": "xeraa", "createdAt": "2020-08-31T00:53:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwNDQzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg0MTQ1Nw==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r479841457", "bodyText": "ok so legacy/v1 would \"for some time\" retain the current behavior. I suppose in this case this means people in-place upgrading continue to work as this logic only applies when the templates don't already exist. cc also @basvanbeek for perspective on your schema tool. This chat will likely outgrow this PR :P\n@ccharnkij for you and to not cage you to this decision tree, I would make a comment to the effect that @xeraa made in point 1. in your unit test and possibly also revise the javadoc/README if doesn't already say this. Basically, this relies on that we are not using legacy/v1 templates, so it is a win, not a merge.\nhence we expect them to not merge. So, as mentioned earlier to show that actually happened (sanity check), have your template override something we don't and then magically notice that after the storage component initializes, whatever that setting is, is now ignored.", "author": "codefromthecrypt", "createdAt": "2020-08-31T01:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTcwNDQzNw=="}], "type": "inlineReview"}, {"oid": "15643801f066015a4fae3a8ae6a3dffc60c8ebe2", "url": "https://github.com/openzipkin/zipkin/commit/15643801f066015a4fae3a8ae6a3dffc60c8ebe2", "message": "Composable index templates for ES 7.8", "committedDate": "2020-09-01T04:16:46Z", "type": "forcePushed"}, {"oid": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "url": "https://github.com/openzipkin/zipkin/commit/c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "message": "Composable index templates for ES 7.8", "committedDate": "2020-09-02T08:10:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwOTUwMw==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r481909503", "body": "probably using Zipkin's Nullable for Integer is better, just to prevent a little brain break", "bodyText": "probably using Zipkin's Nullable for Integer is better, just to prevent a little brain break", "bodyHTML": "<p dir=\"auto\">probably using Zipkin's Nullable for Integer is better, just to prevent a little brain break</p>", "author": "codefromthecrypt", "createdAt": "2020-09-02T08:57:06Z", "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchStorage.java", "diffHunk": "@@ -213,6 +222,8 @@ public final Builder dateSeparator(char dateSeparator) {\n \n   public abstract int namesLookback();\n \n+  @Nullable abstract String templatePriority();", "originalCommit": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxMTIwOA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r481911208", "body": "make Integer", "bodyText": "make Integer", "bodyHTML": "<p dir=\"auto\">make Integer</p>", "author": "codefromthecrypt", "createdAt": "2020-09-02T08:59:03Z", "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -212,6 +213,8 @@ public void setInterval(Duration interval) {\n \n   private HealthCheck healthCheck = new HealthCheck();\n \n+  private String priority;", "originalCommit": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxMjUyMA==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r481912520", "body": "If this is a string to coerce empty to null, make a comment (also coerce empty to null :P) but still use an integer in the builder. I'm not actually sure what Spring does to an integer field set to \"\"", "bodyText": "If this is a string to coerce empty to null, make a comment (also coerce empty to null :P) but still use an integer in the builder. I'm not actually sure what Spring does to an integer field set to \"\"", "bodyHTML": "<p dir=\"auto\">If this is a string to coerce empty to null, make a comment (also coerce empty to null :P) but still use an integer in the builder. I'm not actually sure what Spring does to an integer field set to \"\"</p>", "author": "codefromthecrypt", "createdAt": "2020-09-02T09:00:27Z", "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -346,6 +349,10 @@ public void setSsl(Ssl ssl) {\n     this.ssl = ssl;\n   }\n \n+  public String getPriority() { return priority; }\n+\n+  public void setPriority(String priority) { this.priority = priority; }", "originalCommit": "c36cf3263a7f392561a6fbf3b47415ba0ece81f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "url": "https://github.com/openzipkin/zipkin/commit/a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "message": "Composable index templates for ES 7.8", "committedDate": "2020-09-03T07:52:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwNjg0Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r482806842", "body": "```suggestion\r\n    public abstract Builder templatePriority(@Nullable Integer priority);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable public abstract Builder templatePriority(Integer priority);\n          \n          \n            \n                public abstract Builder templatePriority(@Nullable Integer priority);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">@Nullable</span><span class=\"x x-last\"> </span><span class=\"pl-k\">public</span> <span class=\"pl-k\">abstract</span> <span class=\"pl-smi\">Builder</span> templatePriority(<span class=\"pl-smi\">Integer</span> priority);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">abstract</span> <span class=\"pl-smi\">Builder</span> templatePriority(<span class=\"pl-k x x-first\">@Nullable</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">Integer</span> priority);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codefromthecrypt", "createdAt": "2020-09-03T08:37:50Z", "path": "zipkin-storage/elasticsearch/src/main/java/zipkin2/elasticsearch/ElasticsearchStorage.java", "diffHunk": "@@ -162,6 +162,15 @@ public final Builder dateSeparator(char dateSeparator) {\n     /** False disables automatic index template installation. */\n     public abstract Builder ensureTemplates(boolean ensureTemplates);\n \n+    /**\n+     * Only valid when the destination is Elasticsearch >= 7.8. Indicates the index template\n+     * priority in case of multiple matching templates. The template with highest priority is used.\n+     * Default to 0.\n+     *\n+     * <p>See https://www.elastic.co/guide/en/elasticsearch/reference/7.8/_index_template_and_settings_priority.html\n+     */\n+    @Nullable public abstract Builder templatePriority(Integer priority);", "originalCommit": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwNzk1Mg==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r482807952", "body": "rename to templatePriority", "bodyText": "rename to templatePriority", "bodyHTML": "<p dir=\"auto\">rename to templatePriority</p>", "author": "codefromthecrypt", "createdAt": "2020-09-03T08:39:45Z", "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -212,6 +213,8 @@ public void setInterval(Duration interval) {\n \n   private HealthCheck healthCheck = new HealthCheck();\n \n+  private Integer priority;", "originalCommit": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgwODAxNw==", "url": "https://github.com/openzipkin/zipkin/pull/3185#discussion_r482808017", "body": "rename to template-priority", "bodyText": "rename to template-priority", "bodyHTML": "<p dir=\"auto\">rename to template-priority</p>", "author": "codefromthecrypt", "createdAt": "2020-09-03T08:39:52Z", "path": "zipkin-server/src/main/java/zipkin2/server/internal/elasticsearch/ZipkinElasticsearchStorageProperties.java", "diffHunk": "@@ -50,6 +50,7 @@\n  *     enabled: true\n  *     http-logging: HEADERS\n  *     interval: 3s\n+ *   priority: 0", "originalCommit": "a0919a8935fa247fd7d1c5b8c5aa5a2902bbe8e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "687de3a8532565c05294ba3b82b0e8dae2fc4428", "url": "https://github.com/openzipkin/zipkin/commit/687de3a8532565c05294ba3b82b0e8dae2fc4428", "message": "Composable index templates for ES 7.8", "committedDate": "2020-09-04T00:53:31Z", "type": "commit"}, {"oid": "687de3a8532565c05294ba3b82b0e8dae2fc4428", "url": "https://github.com/openzipkin/zipkin/commit/687de3a8532565c05294ba3b82b0e8dae2fc4428", "message": "Composable index templates for ES 7.8", "committedDate": "2020-09-04T00:53:31Z", "type": "forcePushed"}]}