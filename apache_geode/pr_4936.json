{"pr_number": 4936, "pr_title": "GEODE-7851: Pulse Oauth Support", "pr_author": "demery-pivotal", "pr_createdAt": "2020-04-09T21:07:54Z", "pr_url": "https://github.com/apache/geode/pull/4936", "timeline": [{"oid": "354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "url": "https://github.com/apache/geode/commit/354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "message": "GEODE-7851: Pulse Oauth Support\n\n- create an OauthSecurityConfig to configure spring using oauth\n- add PULSE as an oauth-enabled-component, and if pulse is set to use\n  oauth, set the OauthSecurityConfig as the active security profile\n- use pulse.properties in the locator's working dir to externalize pulse\n  authentication provider configuration\n\nCo-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>", "committedDate": "2020-04-09T20:56:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzODQyNg==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407538426", "body": "doesn't seem necessary to have this.", "bodyText": "doesn't seem necessary to have this.", "bodyHTML": "<p dir=\"auto\">doesn't seem necessary to have this.</p>", "author": "jinmeiliao", "createdAt": "2020-04-13T15:27:58Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/ManagementAgent.java", "diffHunk": "@@ -196,6 +196,7 @@ private void loadWebApplications() {\n       }\n     } else {\n       String pwFile = this.config.getJmxManagerPasswordFile();\n+      String springActiveProfile = \"spring.profiles.active\";", "originalCommit": "354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYxNzMxOA==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407617318", "bodyText": "I've removed it.", "author": "demery-pivotal", "createdAt": "2020-04-13T17:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUzODQyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NDgyMg==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407554822", "body": "hard to associate clientName with providerName, maybe rename the property to \"clientName\"?", "bodyText": "hard to associate clientName with providerName, maybe rename the property to \"clientName\"?", "bodyHTML": "<p dir=\"auto\">hard to associate clientName with providerName, maybe rename the property to \"clientName\"?</p>", "author": "jinmeiliao", "createdAt": "2020-04-13T15:58:44Z", "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/security/OAuthSecurityConfig.java", "diffHunk": "@@ -84,16 +107,15 @@ public OAuth2AuthorizedClientRepository authorizedClientRepository(\n \n   private ClientRegistration clientRegistration() {\n     return ClientRegistration.withRegistrationId(providerId)\n-        .clientId(clientId)\n-        .clientSecret(clientSecret)\n         .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)\n         .redirectUriTemplate(\"{baseUrl}/login/oauth2/code/{registrationId}\")\n-        .scope(\"openid\", \"CLUSTER:READ\", \"CLUSTER:WRITE\", \"DATA:READ\", \"DATA:WRITE\")\n+        .clientId(clientId)\n+        .clientSecret(clientSecret)\n         .authorizationUri(authorizationUri)\n         .tokenUri(tokenUri)\n         .userInfoUri(userInfoUri)\n         .jwkSetUri(jwkSetUri)\n-        .clientName(\"Pulse\")\n+        .clientName(providerName)", "originalCommit": "354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY1MDQwMA==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407650400", "bodyText": "Despite the name of the method clientName(), the value really, really, really does name the provider. If you look at the ClientRegistration code (line 561), you'll see that the default value for \"client name\" is registrationId (aka provider id).\nGiven that, we have some options:\n\nName the property pulse.oauth.clientName. I think this name is very confusing for whoever writes the properties file.\nName the property pulse.oauth.providerName. This name is clearer for whoever writes the properties file, and is a bit of a puzzle for a Geode developer reading the OAuthSecurityConfig code. We could add a comment explaining the puzzle.\nName the property pulse.oauth.providerName, but name the field clientName. Then this method call becomes clearer. But then a Geode developer may wonder why the field name differs from the property name. Again, we could explain with a comment.\n\nWhich do you prefer?", "author": "demery-pivotal", "createdAt": "2020-04-13T18:52:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NDgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2OTAzMQ==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407669031", "bodyText": "2 with a comment probably would be better.", "author": "jinmeiliao", "createdAt": "2020-04-13T19:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NDgyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODMxOQ==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407598319", "body": "I believe you don't need to implement `LogoutSuccessHandler` since `SimpleUrlLogoutSuccessHandler` already implements that\r\n\r\nyou don't need to implement `ContextAware` either, Spring should take care of auto-wiring for you if you declare\r\n<code>\r\n@Autowired\r\n  private Repository repository;\r\n<code>", "bodyText": "I believe you don't need to implement LogoutSuccessHandler since SimpleUrlLogoutSuccessHandler already implements that\nyou don't need to implement ContextAware either, Spring should take care of auto-wiring for you if you declare\n\n@Autowired\nprivate Repository repository;", "bodyHTML": "<p dir=\"auto\">I believe you don't need to implement <code>LogoutSuccessHandler</code> since <code>SimpleUrlLogoutSuccessHandler</code> already implements that</p>\n<p dir=\"auto\">you don't need to implement <code>ContextAware</code> either, Spring should take care of auto-wiring for you if you declare<br>\n<code><br>\n@Autowired<br>\nprivate Repository repository;<br>\n<code></code></code></p>", "author": "jinmeiliao", "createdAt": "2020-04-13T17:18:40Z", "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/security/LogoutHandler.java", "diffHunk": "@@ -30,24 +33,31 @@\n \n /**\n  * Handler is used to close jmx connection maintained at user-level\n- *\n  */\n-public class LogoutHandler extends SimpleUrlLogoutSuccessHandler implements LogoutSuccessHandler {\n+public class LogoutHandler extends SimpleUrlLogoutSuccessHandler implements LogoutSuccessHandler,", "originalCommit": "354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYzNjgzNA==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407636834", "bodyText": "I've removed the unnecessary implements LogoutSuccessHandler.\nRemoving ContextAware is trickier. Unfortunately, simply autowiring the repository this way causes a circular dependency that Spring can't resolve.\nIn my logout spike, I have fixed this by untangling the circular dependency. So here are the options I can think of:\n\nMove the dependency-untangling code from my logout spike into this PR. This involves changes to 8 or 9 files.\nLeave LogoutHandler implementing ContextAware for now, and fix it in a later PR.\n\nWhich would you prefer?", "author": "demery-pivotal", "createdAt": "2020-04-13T18:27:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODMxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0NjI1OA==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407646258", "bodyText": "we can leave it for now", "author": "jinmeiliao", "createdAt": "2020-04-13T18:44:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODMxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODU3MQ==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407598571", "body": "```suggestion\r\n  @Autowired\r\n  private Repository repository;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private ApplicationContext applicationContext;\n          \n          \n            \n              @Autowired\n          \n          \n            \n              private Repository repository;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"39\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k x x-first\">private</span><span class=\"x\"> </span><span class=\"pl-smi x\">ApplicationContext</span><span class=\"x x-last\"> applicationContext;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"39\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k x x-first x-last\">@Autowired</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"40\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">Repository</span> repository;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jinmeiliao", "createdAt": "2020-04-13T17:19:06Z", "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/security/LogoutHandler.java", "diffHunk": "@@ -30,24 +33,31 @@\n \n /**\n  * Handler is used to close jmx connection maintained at user-level\n- *\n  */\n-public class LogoutHandler extends SimpleUrlLogoutSuccessHandler implements LogoutSuccessHandler {\n+public class LogoutHandler extends SimpleUrlLogoutSuccessHandler implements LogoutSuccessHandler,\n+    ApplicationContextAware {\n   private static final Logger logger = LogManager.getLogger();\n+  private ApplicationContext applicationContext;", "originalCommit": "354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5OTI4NA==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407599284", "body": "```suggestion\r\n  @Autowired\r\n  private Repository repository;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final Repository repository;\n          \n          \n            \n              @Autowired\n          \n          \n            \n              private Repository repository;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"48\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k x x-first\">private</span><span class=\"x\"> </span><span class=\"pl-k x\">final</span><span class=\"x\"> </span><span class=\"pl-smi x\">Repository</span><span class=\"x x-last\"> repository;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"48\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k x x-first x-last\">@Autowired</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"49\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">Repository</span> repository;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jinmeiliao", "createdAt": "2020-04-13T17:20:24Z", "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/service/ClusterDetailsService.java", "diffHunk": "@@ -44,14 +45,20 @@\n public class ClusterDetailsService implements PulseService {\n \n   private final ObjectMapper mapper = new ObjectMapper();\n+  private final Repository repository;", "originalCommit": "354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0MDcyNQ==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407640725", "bodyText": "How strongly do you feel about this? The general (strong) consensus is to avoid field injection. And we've found that constructor injection makes it way easier to write unit tests (if we ever get around to writing unit tests).", "author": "demery-pivotal", "createdAt": "2020-04-13T18:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5OTI4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY0Njc1MA==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407646750", "bodyText": "I only prefer field injection because it's less code. If this makes testing easier, I am OK with it.", "author": "jinmeiliao", "createdAt": "2020-04-13T18:45:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5OTI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5OTgyNg==", "url": "https://github.com/apache/geode/pull/4936#discussion_r407599826", "body": "no need for this constructor if Repository variable is declared as `autowired` already.\r\n\r\nSame should be the same for all the service classes.", "bodyText": "no need for this constructor if Repository variable is declared as autowired already.\nSame should be the same for all the service classes.", "bodyHTML": "<p dir=\"auto\">no need for this constructor if Repository variable is declared as <code>autowired</code> already.</p>\n<p dir=\"auto\">Same should be the same for all the service classes.</p>", "author": "jinmeiliao", "createdAt": "2020-04-13T17:21:24Z", "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/service/ClusterDetailsService.java", "diffHunk": "@@ -44,14 +45,20 @@\n public class ClusterDetailsService implements PulseService {\n \n   private final ObjectMapper mapper = new ObjectMapper();\n+  private final Repository repository;\n+\n+  @Autowired", "originalCommit": "354a068a3a3a13ce11a0c7de0098eecedb8cae0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b8ee16efb4c0f85f8753fc51a307165a07463d73", "url": "https://github.com/apache/geode/commit/b8ee16efb4c0f85f8753fc51a307165a07463d73", "message": "Add documentation and remove unnecessary code\n\n- Remove redundant 'implements LogoutSuccessHandler' from LogoutHandler.\n- Remove unused local variable in ManagementAgent.\n- Add comment in OAuthSecurityConfig explaining why we pass the the\n  OAuth provider name to ClientRegistration.clientName().\n\nAuthored-by: Dale Emery <demery@pivotal.io>", "committedDate": "2020-04-13T19:48:32Z", "type": "commit"}]}