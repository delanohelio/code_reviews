{"pr_number": 4932, "pr_title": "GEODE-7664: calling RegionConfigRealizer.exists methods doesn't need \u2026", "pr_author": "jinmeiliao", "pr_createdAt": "2020-04-09T04:10:41Z", "pr_url": "https://github.com/apache/geode/pull/4932", "timeline": [{"oid": "40440153338b8b93f1c9329f113d42b253d934ca", "url": "https://github.com/apache/geode/commit/40440153338b8b93f1c9329f113d42b253d934ca", "message": "GEODE-7664: calling RegionConfigRealizer.exists methods doesn't need to get the runtime info of the region to avoid concurrency issues.", "committedDate": "2020-04-09T04:10:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzNjcxNQ==", "url": "https://github.com/apache/geode/pull/4932#discussion_r406336715", "body": "You can also use `never()` in place of `times(0)` if you think it's clearer.", "bodyText": "You can also use never() in place of times(0) if you think it's clearer.", "bodyHTML": "<p dir=\"auto\">You can also use <code>never()</code> in place of <code>times(0)</code> if you think it's clearer.</p>", "author": "demery-pivotal", "createdAt": "2020-04-09T16:44:23Z", "path": "geode-core/src/test/java/org/apache/geode/management/internal/configuration/realizers/RegionConfigRealizerTest.java", "diffHunk": "@@ -113,4 +116,23 @@ public void getRegionFactoryWhenValueNotSet() throws Exception {\n     verify(regionFactory, never()).setDiskStoreName(any());\n     verify(regionFactory).setDataPolicy(DataPolicy.REPLICATE);\n   }\n+\n+  @Test\n+  public void exists() {\n+    config.setName(\"test\");\n+    when(cache.getRegion(\"/test\")).thenReturn(null);\n+    assertThat(realizer.exists(config, cache)).isFalse();\n+\n+    when(region.isDestroyed()).thenReturn(true);\n+    assertThat(realizer.exists(config, cache)).isFalse();\n+  }\n+\n+  @Test\n+  public void existsDoesNotGetRuntimeInfo() {\n+    config.setName(\"test\");\n+    when(cache.getRegion(\"/test\")).thenReturn(region);\n+    boolean exists = realizer.exists(config, cache);\n+    assertThat(exists).isTrue();\n+    verify(region, times(0)).size();", "originalCommit": "40440153338b8b93f1c9329f113d42b253d934ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjMzODM0NQ==", "url": "https://github.com/apache/geode/pull/4932#discussion_r406338345", "body": "The test name hides a very important responsibility: To report that the region exists if it is in the cache and not destroyed.\r\n\r\nI would write this as two tests, so that the test names can clearly document the two responsibilities: 1. Determine that the region exists. 2. Do not get runtime info.", "bodyText": "The test name hides a very important responsibility: To report that the region exists if it is in the cache and not destroyed.\nI would write this as two tests, so that the test names can clearly document the two responsibilities: 1. Determine that the region exists. 2. Do not get runtime info.", "bodyHTML": "<p dir=\"auto\">The test name hides a very important responsibility: To report that the region exists if it is in the cache and not destroyed.</p>\n<p dir=\"auto\">I would write this as two tests, so that the test names can clearly document the two responsibilities: 1. Determine that the region exists. 2. Do not get runtime info.</p>", "author": "demery-pivotal", "createdAt": "2020-04-09T16:47:20Z", "path": "geode-core/src/test/java/org/apache/geode/management/internal/configuration/realizers/RegionConfigRealizerTest.java", "diffHunk": "@@ -113,4 +116,23 @@ public void getRegionFactoryWhenValueNotSet() throws Exception {\n     verify(regionFactory, never()).setDiskStoreName(any());\n     verify(regionFactory).setDataPolicy(DataPolicy.REPLICATE);\n   }\n+\n+  @Test\n+  public void exists() {\n+    config.setName(\"test\");\n+    when(cache.getRegion(\"/test\")).thenReturn(null);\n+    assertThat(realizer.exists(config, cache)).isFalse();\n+\n+    when(region.isDestroyed()).thenReturn(true);\n+    assertThat(realizer.exists(config, cache)).isFalse();\n+  }\n+\n+  @Test\n+  public void existsDoesNotGetRuntimeInfo() {\n+    config.setName(\"test\");\n+    when(cache.getRegion(\"/test\")).thenReturn(region);\n+    boolean exists = realizer.exists(config, cache);\n+    assertThat(exists).isTrue();", "originalCommit": "40440153338b8b93f1c9329f113d42b253d934ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM0Mzc0Mg==", "url": "https://github.com/apache/geode/pull/4932#discussion_r406343742", "body": "This section doesn't test anything. Because `cache.getRegion(\"test\")` still returns null, the realizer will never call `region.isDestroyed()`. So this test does not ensure that the realizer pays attention to `isDestroyed()`.\r\n\r\nI verified this by commenting out lines 322\u2013324 of the realizer class, and this test still passes. \r\n\r\nAlso, I would split this into two tests, so that the test names can clearly document the two 'does not exist' conditions:`regionDoesNotExistIfNotInCache()` and `destroyedRegionDoesNotExist()`.", "bodyText": "This section doesn't test anything. Because cache.getRegion(\"test\") still returns null, the realizer will never call region.isDestroyed(). So this test does not ensure that the realizer pays attention to isDestroyed().\nI verified this by commenting out lines 322\u2013324 of the realizer class, and this test still passes.\nAlso, I would split this into two tests, so that the test names can clearly document the two 'does not exist' conditions:regionDoesNotExistIfNotInCache() and destroyedRegionDoesNotExist().", "bodyHTML": "<p dir=\"auto\">This section doesn't test anything. Because <code>cache.getRegion(\"test\")</code> still returns null, the realizer will never call <code>region.isDestroyed()</code>. So this test does not ensure that the realizer pays attention to <code>isDestroyed()</code>.</p>\n<p dir=\"auto\">I verified this by commenting out lines 322\u2013324 of the realizer class, and this test still passes.</p>\n<p dir=\"auto\">Also, I would split this into two tests, so that the test names can clearly document the two 'does not exist' conditions:<code>regionDoesNotExistIfNotInCache()</code> and <code>destroyedRegionDoesNotExist()</code>.</p>", "author": "demery-pivotal", "createdAt": "2020-04-09T16:56:34Z", "path": "geode-core/src/test/java/org/apache/geode/management/internal/configuration/realizers/RegionConfigRealizerTest.java", "diffHunk": "@@ -113,4 +116,23 @@ public void getRegionFactoryWhenValueNotSet() throws Exception {\n     verify(regionFactory, never()).setDiskStoreName(any());\n     verify(regionFactory).setDataPolicy(DataPolicy.REPLICATE);\n   }\n+\n+  @Test\n+  public void exists() {\n+    config.setName(\"test\");\n+    when(cache.getRegion(\"/test\")).thenReturn(null);\n+    assertThat(realizer.exists(config, cache)).isFalse();\n+\n+    when(region.isDestroyed()).thenReturn(true);\n+    assertThat(realizer.exists(config, cache)).isFalse();", "originalCommit": "40440153338b8b93f1c9329f113d42b253d934ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6d5cadb5fad1ee784b9f974beb1f194369f780fd", "url": "https://github.com/apache/geode/commit/6d5cadb5fad1ee784b9f974beb1f194369f780fd", "message": "review changes", "committedDate": "2020-04-09T18:07:47Z", "type": "commit"}]}