{"pr_number": 4491, "pr_title": "Issue 4443: Use DelegationTokenProvider for BatchClient.", "pr_author": "shrids", "pr_createdAt": "2020-01-16T09:56:18Z", "pr_url": "https://github.com/pravega/pravega/pull/4491", "timeline": [{"oid": "2aecba7d7452f72af0373cdee9aa7f6042b95ac3", "url": "https://github.com/pravega/pravega/commit/2aecba7d7452f72af0373cdee9aa7f6042b95ac3", "message": "First version.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-01-16T09:55:04Z", "type": "commit"}, {"oid": "9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8", "url": "https://github.com/pravega/pravega/commit/9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8", "message": "Add Junits.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-01-16T10:32:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1MDMwOA==", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367450308", "body": "The `DelegationTokenProvider` implementation holds the `DelegationToken` under an `AtomicReference`. So wrapping the provider using an `AtomicReference` is redundant here, and should be removed. \r\n\r\nhttps://github.com/pravega/pravega/blob/ad9260d5d2e58e7262732818b8b2bf71ef325198/client/src/main/java/io/pravega/client/security/auth/JwtTokenProviderImpl.java#L71 ", "bodyText": "The DelegationTokenProvider implementation holds the DelegationToken under an AtomicReference. So wrapping the provider using an AtomicReference is redundant here, and should be removed.\n\n  \n    \n      pravega/client/src/main/java/io/pravega/client/security/auth/JwtTokenProviderImpl.java\n    \n    \n         Line 71\n      in\n      ad9260d\n    \n    \n    \n    \n\n        \n          \n           private final AtomicReference<DelegationToken> delegationToken = new AtomicReference<>();", "bodyHTML": "<p dir=\"auto\">The <code>DelegationTokenProvider</code> implementation holds the <code>DelegationToken</code> under an <code>AtomicReference</code>. So wrapping the provider using an <code>AtomicReference</code> is redundant here, and should be removed.</p>\n<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/pravega/pravega/blob/ad9260d5d2e58e7262732818b8b2bf71ef325198/client/src/main/java/io/pravega/client/security/auth/JwtTokenProviderImpl.java#L71\">pravega/client/src/main/java/io/pravega/client/security/auth/JwtTokenProviderImpl.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 71\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/pravega/pravega/commit/ad9260d5d2e58e7262732818b8b2bf71ef325198\">ad9260d</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L71\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"71\"></td>\n          <td id=\"LC71\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">AtomicReference&lt;<span class=\"pl-smi\">DelegationToken</span>&gt;</span> delegationToken <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">AtomicReference&lt;&gt;</span>(); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "ravisharda", "createdAt": "2020-01-16T14:34:08Z", "path": "client/src/main/java/io/pravega/client/batch/impl/BatchClientFactoryImpl.java", "diffHunk": "@@ -46,25 +46,22 @@\n \n @Beta\n @Slf4j\n-@SuppressWarnings(\"deprecation\")\n public class BatchClientFactoryImpl implements BatchClientFactory {\n \n     private final Controller controller;\n     private final ConnectionFactory connectionFactory;\n     private final SegmentInputStreamFactory inputStreamFactory;\n     private final SegmentMetadataClientFactory segmentMetadataClientFactory;\n     private final StreamCutHelper streamCutHelper;\n-\n-    @GuardedBy(\"this\")\n-    private final AtomicReference<String> latestDelegationToken;\n+    private final AtomicReference<DelegationTokenProvider> delegationTokenProvider;", "originalCommit": "9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzczODE2MA==", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367738160", "bodyText": "Fixed it. Removed the redundant AtomicReference.", "author": "shrids", "createdAt": "2020-01-17T02:00:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1MDMwOA=="}], "type": "inlineReview"}, {"oid": "fdc431f3b5877605bd7b2c621d38495cb1ed525c", "url": "https://github.com/pravega/pravega/commit/fdc431f3b5877605bd7b2c621d38495cb1ed525c", "message": "Review comments.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-01-17T01:59:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3MDA1Ng==", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367770056", "body": "Since the passed object is not a real object, using a `spy()` seems unnecessary here. We can use `mockController` directly. ", "bodyText": "Since the passed object is not a real object, using a spy() seems unnecessary here. We can use mockController directly.", "bodyHTML": "<p dir=\"auto\">Since the passed object is not a real object, using a <code>spy()</code> seems unnecessary here. We can use <code>mockController</code> directly.</p>", "author": "ravisharda", "createdAt": "2020-01-17T05:01:34Z", "path": "client/src/test/java/io/pravega/client/batch/impl/BatchClientImplTest.java", "diffHunk": "@@ -100,6 +109,33 @@ public void testGetSegmentsWithNullStreamCut() throws Exception {\n         assertFalse(segments.hasNext());\n     }\n \n+    @Test(timeout = 5000)\n+    public void testGetSegmentsWithMultipleSegments() throws Exception {\n+\n+        PravegaNodeUri location = new PravegaNodeUri(\"localhost\", 0);\n+        MockConnectionFactoryImpl connectionFactory = getMockConnectionFactory(location);\n+        MockController mockController = new MockController(location.getEndpoint(), location\n+                .getPort(), connectionFactory, false);\n+        MockController stubbedController = spy(mockController);", "originalCommit": "fdc431f3b5877605bd7b2c621d38495cb1ed525c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3MDcwMw==", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367770703", "bodyText": "The mockController used here is not a @mock but a test implmentation for the controller.", "author": "shrids", "createdAt": "2020-01-17T05:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3MDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3MTU1Nw==", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367771557", "bodyText": "I see. :)", "author": "ravisharda", "createdAt": "2020-01-17T05:09:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3MDA1Ng=="}], "type": "inlineReview"}, {"oid": "1526c2e6fa2e6c7a673f8ab929ca054d2664acc9", "url": "https://github.com/pravega/pravega/commit/1526c2e6fa2e6c7a673f8ab929ca054d2664acc9", "message": "Add Integration test.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-01-17T06:13:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4NTM2Mw==", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367785363", "body": "nit: `timeouts` ", "bodyText": "nit: timeouts", "bodyHTML": "<p dir=\"auto\">nit: <code>timeouts</code></p>", "author": "ravisharda", "createdAt": "2020-01-17T06:25:54Z", "path": "test/integration/src/test/java/io/pravega/test/integration/DelegationTokenTest.java", "diffHunk": "@@ -200,4 +184,96 @@ public void testDelegationTokenGetsRenewedAfterExpiry() throws InterruptedExcept\n             pravegaCluster.close();\n         }\n     }\n+\n+    /**\n+     * This test verifies that a batch client continues to read events as a result of automatic delegation token\n+     * renewal, after the initial delegation token it uses expires.\n+     * <p>\n+     * We use an extraordinarily high test timeout and read time outs to account for any inordinate delays that may be", "originalCommit": "1526c2e6fa2e6c7a673f8ab929ca054d2664acc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4NjI2MA==", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367786260", "bodyText": "fixed it.", "author": "shrids", "createdAt": "2020-01-17T06:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4NTM2Mw=="}], "type": "inlineReview"}, {"oid": "25e5181bd57e2498a9fab47dbb77f06dcbb69e9c", "url": "https://github.com/pravega/pravega/commit/25e5181bd57e2498a9fab47dbb77f06dcbb69e9c", "message": "CR Changes: fix typo.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>", "committedDate": "2020-01-17T06:29:54Z", "type": "commit"}, {"oid": "735a63688eba65afef3f70bf5bf5f9ca936dcbfb", "url": "https://github.com/pravega/pravega/commit/735a63688eba65afef3f70bf5bf5f9ca936dcbfb", "message": "Merge branch 'master' into issue-4443-delegationToken", "committedDate": "2020-01-17T08:47:31Z", "type": "commit"}]}