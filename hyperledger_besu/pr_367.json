{"pr_number": 367, "pr_title": "[BESU-169] cache logs bloom filters automatically.", "pr_author": "abdelhamidbakhta", "pr_createdAt": "2020-02-05T09:51:49Z", "pr_url": "https://github.com/hyperledger/besu/pull/367", "timeline": [{"oid": "6963071ba7eea3a0c636752d641759f19a9f6b55", "url": "https://github.com/hyperledger/besu/commit/6963071ba7eea3a0c636752d641759f19a9f6b55", "message": "First iteration. Draft PR.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-05T09:50:19Z", "type": "commit"}, {"oid": "ca62e34ad9f2421a1ba7f454e987cab804a136c1", "url": "https://github.com/hyperledger/besu/commit/ca62e34ad9f2421a1ba7f454e987cab804a136c1", "message": "fix SPDX header\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-05T13:24:02Z", "type": "commit"}, {"oid": "388d0dcffa49a43ed47faedefd3b47410cd40c80", "url": "https://github.com/hyperledger/besu/commit/388d0dcffa49a43ed47faedefd3b47410cd40c80", "message": "Use block broadcaster to index log bloom.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-05T17:32:55Z", "type": "commit"}, {"oid": "94fccd4f122d7ab9418757dd41ce04fc6099ad6b", "url": "https://github.com/hyperledger/besu/commit/94fccd4f122d7ab9418757dd41ce04fc6099ad6b", "message": "Remove useless toString method\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-05T17:34:15Z", "type": "commit"}, {"oid": "997c333d0714201fd753a5affefc2828624b5d61", "url": "https://github.com/hyperledger/besu/commit/997c333d0714201fd753a5affefc2828624b5d61", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-05T17:37:17Z", "type": "commit"}, {"oid": "3092ddca914aa6759d0228529d896ad08cd8ae87", "url": "https://github.com/hyperledger/besu/commit/3092ddca914aa6759d0228529d896ad08cd8ae87", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-05T19:35:02Z", "type": "commit"}, {"oid": "a29dcee1abee07fdbb5558b089b6138e2979bd27", "url": "https://github.com/hyperledger/besu/commit/a29dcee1abee07fdbb5558b089b6138e2979bd27", "message": "cacheLogsBloomForBlockHeader\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-06T08:54:14Z", "type": "commit"}, {"oid": "34fe368127f2f8375d7bd83473c72f4957801b96", "url": "https://github.com/hyperledger/besu/commit/34fe368127f2f8375d7bd83473c72f4957801b96", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-06T08:56:51Z", "type": "commit"}, {"oid": "3daa9a43d6e81d9234849228f77632bf07af75d7", "url": "https://github.com/hyperledger/besu/commit/3daa9a43d6e81d9234849228f77632bf07af75d7", "message": "ensurePreviousSegmentsArePresent\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-07T13:17:41Z", "type": "commit"}, {"oid": "743448aea13040a0762310fad4f3599b6e5c2f52", "url": "https://github.com/hyperledger/besu/commit/743448aea13040a0762310fad4f3599b6e5c2f52", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-07T13:35:27Z", "type": "commit"}, {"oid": "d7fbfdf5a71f71871533ab91afe5ce0d96d0647d", "url": "https://github.com/hyperledger/besu/commit/d7fbfdf5a71f71871533ab91afe5ce0d96d0647d", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-07T14:36:59Z", "type": "commit"}, {"oid": "34b1e50a19c446155ff2c4d6c89c64c60a8534ef", "url": "https://github.com/hyperledger/besu/commit/34b1e50a19c446155ff2c4d6c89c64c60a8534ef", "message": "Added CLI flag to enable / disable automatic logs bloom indexing.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-07T16:55:26Z", "type": "commit"}, {"oid": "026d53f45e0cd53529dffee747d0b7a8daa4b3c2", "url": "https://github.com/hyperledger/besu/commit/026d53f45e0cd53529dffee747d0b7a8daa4b3c2", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-10T07:51:05Z", "type": "commit"}, {"oid": "f545f708fc3cf30dd39b178427875ee11153e7a7", "url": "https://github.com/hyperledger/besu/commit/f545f708fc3cf30dd39b178427875ee11153e7a7", "message": "Create cache directory and cache file if not exist.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-10T09:11:46Z", "type": "commit"}, {"oid": "eb48fec2d60d52ae3f8244288450a73b5a5390bb", "url": "https://github.com/hyperledger/besu/commit/eb48fec2d60d52ae3f8244288450a73b5a5390bb", "message": "Fix acceptance test\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-10T09:42:03Z", "type": "commit"}, {"oid": "4c7a20c91ac8b8d43a831a7ff60e123ada871171", "url": "https://github.com/hyperledger/besu/commit/4c7a20c91ac8b8d43a831a7ff60e123ada871171", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-11T08:11:55Z", "type": "commit"}, {"oid": "ec42713e0ca788308ce3a2be7def86dea786f06e", "url": "https://github.com/hyperledger/besu/commit/ec42713e0ca788308ce3a2be7def86dea786f06e", "message": "Write cache for block only if block is new canonical head.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-11T08:23:40Z", "type": "commit"}, {"oid": "18f1a22fe033a608f3ad99fa365752b42c7bd296", "url": "https://github.com/hyperledger/besu/commit/18f1a22fe033a608f3ad99fa365752b42c7bd296", "message": "Handling of chain reorg.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T08:42:17Z", "type": "commit"}, {"oid": "84614213fdc59bca9fb0e2cc1a825de745f27a8d", "url": "https://github.com/hyperledger/besu/commit/84614213fdc59bca9fb0e2cc1a825de745f27a8d", "message": "fix\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T08:47:25Z", "type": "commit"}, {"oid": "bc65af99c4eddf0478a27ed23d5d1e306253c40b", "url": "https://github.com/hyperledger/besu/commit/bc65af99c4eddf0478a27ed23d5d1e306253c40b", "message": "sportless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T08:53:11Z", "type": "commit"}, {"oid": "8a3c988224dd40fdf63c2e07987cede3702e466f", "url": "https://github.com/hyperledger/besu/commit/8a3c988224dd40fdf63c2e07987cede3702e466f", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T16:53:15Z", "type": "commit"}, {"oid": "8a3c988224dd40fdf63c2e07987cede3702e466f", "url": "https://github.com/hyperledger/besu/commit/8a3c988224dd40fdf63c2e07987cede3702e466f", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T16:53:15Z", "type": "forcePushed"}, {"oid": "cd468ecb4b773bd7dcff9617183eb9d428f3e02a", "url": "https://github.com/hyperledger/besu/commit/cd468ecb4b773bd7dcff9617183eb9d428f3e02a", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T17:32:23Z", "type": "commit"}, {"oid": "2cd0985b0c9f1565f054d7d1a6c7f7f0fa1fa026", "url": "https://github.com/hyperledger/besu/commit/2cd0985b0c9f1565f054d7d1a6c7f7f0fa1fa026", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T17:53:57Z", "type": "commit"}, {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b", "url": "https://github.com/hyperledger/besu/commit/3d6efc35046e024222e9abce128f0942a49aba2b", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-12T18:06:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NDc0Ng==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378544746", "body": "```suggestion\r\n    params.add(\"--auto-log-bloom-caching-enabled\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                params.add(\"--auto-logs-bloom-indexing-enabled\");\n          \n          \n            \n                params.add(\"--auto-log-bloom-caching-enabled\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"260\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    params<span class=\"pl-k\">.</span>add(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>--auto-<span class=\"x x-first x-last\">logs</span>-bloom-<span class=\"x x-first x-last\">indexing</span>-enabled<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"260\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    params<span class=\"pl-k\">.</span>add(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>--auto-<span class=\"x x-first x-last\">log</span>-bloom-<span class=\"x x-first x-last\">caching</span>-enabled<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "shemnon", "createdAt": "2020-02-12T22:16:05Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -257,6 +257,9 @@ public void startNode(final BesuNode node) {\n     params.add(\"--key-value-storage\");\n     params.add(\"rocksdb\");\n \n+    params.add(\"--auto-logs-bloom-indexing-enabled\");", "originalCommit": "3d6efc35046e024222e9abce128f0942a49aba2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NTY4Ng==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378545686", "body": "```suggestion\r\n            .autoLogBloomCaching(false)\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .autoLogsBloomIndexing(false)\n          \n          \n            \n                        .autoLogBloomCaching(false)", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"198\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            .<span class=\"x x-first x-last\">autoLogsBloomIndexing</span>(<span class=\"pl-c1\">false</span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"198\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            .<span class=\"x x-first x-last\">autoLogBloomCaching</span>(<span class=\"pl-c1\">false</span>)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "shemnon", "createdAt": "2020-02-12T22:18:24Z", "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ThreadBesuNodeRunner.java", "diffHunk": "@@ -195,6 +195,7 @@ public void startNode(final BesuNode node) {\n                     .map(EnodeURL::fromString)\n                     .collect(Collectors.toList()))\n             .besuPluginContext(new BesuPluginContextImpl())\n+            .autoLogsBloomIndexing(false)", "originalCommit": "3d6efc35046e024222e9abce128f0942a49aba2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5NDE4Mg==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378594182", "body": "This should be `debug` - it happens way too often.", "bodyText": "This should be debug - it happens way too often.", "bodyHTML": "<p dir=\"auto\">This should be <code>debug</code> - it happens way too often.</p>", "author": "shemnon", "createdAt": "2020-02-13T00:43:54Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -117,16 +128,68 @@ private long fillCacheFile(\n       if (maybeHeader.isEmpty()) {\n         break;\n       }\n-      final byte[] logs = maybeHeader.get().getLogsBloom().toArray();\n-      checkNotNull(logs);\n-      checkState(logs.length == 256, \"BloomBits are not the correct length\");\n-      fos.write(logs);\n+      fillCacheFileWithBlock(maybeHeader.get(), fos);\n       indexingStatus.currentBlock = blockNum;\n       blockNum++;\n     }\n     return blockNum - startBlock;\n   }\n \n+  public void cacheLogsBloomForBlockHeader(final BlockHeader blockHeader) {\n+    try {\n+      final long blockNumber = blockHeader.getNumber();\n+      LOG.info(\"Caching logs bloom for block {}.\", \"0x\" + Long.toHexString(blockNumber));", "originalCommit": "3d6efc35046e024222e9abce128f0942a49aba2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcwMTk2Mg==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378701962", "bodyText": "Done.", "author": "abdelhamidbakhta", "createdAt": "2020-02-13T08:03:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5NDE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5ODQ0OQ==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378598449", "body": "This can result in indexing running twice... perhaps `ensurePreviousSegmentsArePresent(blockchain.getChainHeadBlockNumber());`?", "bodyText": "This can result in indexing running twice... perhaps ensurePreviousSegmentsArePresent(blockchain.getChainHeadBlockNumber());?", "bodyHTML": "<p dir=\"auto\">This can result in indexing running twice... perhaps <code>ensurePreviousSegmentsArePresent(blockchain.getChainHeadBlockNumber());</code>?</p>", "author": "shemnon", "createdAt": "2020-02-13T00:57:04Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -60,6 +67,10 @@ public TransactionLogsIndexer(\n     this.scheduler = scheduler;\n   }\n \n+  public IndexingStatus indexAll() {\n+    return generateLogBloomCache(0, Long.MAX_VALUE);", "originalCommit": "3d6efc35046e024222e9abce128f0942a49aba2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcwMjUyMA==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378702520", "bodyText": "Yes, good suggestion. Done.", "author": "abdelhamidbakhta", "createdAt": "2020-02-13T08:05:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5ODQ0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5OTkyNA==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378599924", "body": "I think we should track what segments we have made in a list or tree map.  Check the map before going to disk.", "bodyText": "I think we should track what segments we have made in a list or tree map.  Check the map before going to disk.", "bodyHTML": "<p dir=\"auto\">I think we should track what segments we have made in a list or tree map.  Check the map before going to disk.</p>", "author": "shemnon", "createdAt": "2020-02-13T01:03:02Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -117,16 +128,68 @@ private long fillCacheFile(\n       if (maybeHeader.isEmpty()) {\n         break;\n       }\n-      final byte[] logs = maybeHeader.get().getLogsBloom().toArray();\n-      checkNotNull(logs);\n-      checkState(logs.length == 256, \"BloomBits are not the correct length\");\n-      fos.write(logs);\n+      fillCacheFileWithBlock(maybeHeader.get(), fos);\n       indexingStatus.currentBlock = blockNum;\n       blockNum++;\n     }\n     return blockNum - startBlock;\n   }\n \n+  public void cacheLogsBloomForBlockHeader(final BlockHeader blockHeader) {\n+    try {\n+      final long blockNumber = blockHeader.getNumber();\n+      LOG.info(\"Caching logs bloom for block {}.\", \"0x\" + Long.toHexString(blockNumber));\n+      ensurePreviousSegmentsArePresent(blockNumber);\n+      final File cacheFile = calculateCacheFileName(blockNumber, cacheDir);\n+      if (!cacheFile.exists()) {\n+        Files.createFile(cacheFile.toPath());\n+      }\n+      try (RandomAccessFile writer = new RandomAccessFile(cacheFile, \"rw\")) {\n+        final long offset = (blockNumber / BLOCKS_PER_BLOOM_CACHE) * BLOOM_BITS_LENGTH;\n+        writer.seek(offset);\n+        writer.write(ensureBloomBitsAreCorrectLength(blockHeader.getLogsBloom().toArray()));\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Unhandled indexing exception.\", e);\n+    }\n+  }\n+\n+  private void ensurePreviousSegmentsArePresent(final long blockNumber) {\n+    scheduler.scheduleFutureTask(\n+        () -> {\n+          long currentSegment = (blockNumber / BLOCKS_PER_BLOOM_CACHE) - 1;\n+          while (currentSegment > 0) {\n+            try {\n+              if (!isCachePresentForSegment(currentSegment)) {", "originalCommit": "3d6efc35046e024222e9abce128f0942a49aba2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcwNjA5OQ==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378706099", "bodyText": "Done.", "author": "abdelhamidbakhta", "createdAt": "2020-02-13T08:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5OTkyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwMDE2Ng==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378600166", "body": "We should check indexing status before submitting the work.", "bodyText": "We should check indexing status before submitting the work.", "bodyHTML": "<p dir=\"auto\">We should check indexing status before submitting the work.</p>", "author": "shemnon", "createdAt": "2020-02-13T01:04:00Z", "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -117,16 +128,68 @@ private long fillCacheFile(\n       if (maybeHeader.isEmpty()) {\n         break;\n       }\n-      final byte[] logs = maybeHeader.get().getLogsBloom().toArray();\n-      checkNotNull(logs);\n-      checkState(logs.length == 256, \"BloomBits are not the correct length\");\n-      fos.write(logs);\n+      fillCacheFileWithBlock(maybeHeader.get(), fos);\n       indexingStatus.currentBlock = blockNum;\n       blockNum++;\n     }\n     return blockNum - startBlock;\n   }\n \n+  public void cacheLogsBloomForBlockHeader(final BlockHeader blockHeader) {\n+    try {\n+      final long blockNumber = blockHeader.getNumber();\n+      LOG.info(\"Caching logs bloom for block {}.\", \"0x\" + Long.toHexString(blockNumber));\n+      ensurePreviousSegmentsArePresent(blockNumber);\n+      final File cacheFile = calculateCacheFileName(blockNumber, cacheDir);\n+      if (!cacheFile.exists()) {\n+        Files.createFile(cacheFile.toPath());\n+      }\n+      try (RandomAccessFile writer = new RandomAccessFile(cacheFile, \"rw\")) {\n+        final long offset = (blockNumber / BLOCKS_PER_BLOOM_CACHE) * BLOOM_BITS_LENGTH;\n+        writer.seek(offset);\n+        writer.write(ensureBloomBitsAreCorrectLength(blockHeader.getLogsBloom().toArray()));\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Unhandled indexing exception.\", e);\n+    }\n+  }\n+\n+  private void ensurePreviousSegmentsArePresent(final long blockNumber) {\n+    scheduler.scheduleFutureTask(", "originalCommit": "3d6efc35046e024222e9abce128f0942a49aba2b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcwMzIyMg==", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378703222", "bodyText": "Done.", "author": "abdelhamidbakhta", "createdAt": "2020-02-13T08:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwMDE2Ng=="}], "type": "inlineReview"}, {"oid": "393dddbc99b8635948f2ce13ebeb095d9119e877", "url": "https://github.com/hyperledger/besu/commit/393dddbc99b8635948f2ce13ebeb095d9119e877", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-13T08:01:33Z", "type": "commit"}, {"oid": "d8d2a711c90d3fb24e3ec40f0cedc00a528c4fac", "url": "https://github.com/hyperledger/besu/commit/d8d2a711c90d3fb24e3ec40f0cedc00a528c4fac", "message": "Address PR comments.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-13T08:17:08Z", "type": "commit"}, {"oid": "eb1facf87fd34badf59e09792716ac255a099f5e", "url": "https://github.com/hyperledger/besu/commit/eb1facf87fd34badf59e09792716ac255a099f5e", "message": "Remove unused constant.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-13T08:20:12Z", "type": "commit"}, {"oid": "275ab563f17d4c331db26c96eab589b16dffd120", "url": "https://github.com/hyperledger/besu/commit/275ab563f17d4c331db26c96eab589b16dffd120", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>", "committedDate": "2020-02-13T08:24:44Z", "type": "commit"}]}