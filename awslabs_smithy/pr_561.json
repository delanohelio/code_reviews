{"pr_number": 561, "pr_title": "Emit events when traits are changed", "pr_author": "mtdowling", "pr_createdAt": "2020-09-11T00:31:52Z", "pr_url": "https://github.com/awslabs/smithy/pull/561", "timeline": [{"oid": "19bb6d91da4d6b9cb3360388ae15b25ef851978c", "url": "https://github.com/awslabs/smithy/commit/19bb6d91da4d6b9cb3360388ae15b25ef851978c", "message": "Emit events when traits are changed\n\nSmithy-diff previously did not emit validation events when a trait was\nadded, removed, or changed unless the trait was marked with one of a few\nspecial tags. This commit updates smithy-diff to emit a NOTE when a\ntrait is added or changed and a WARNING when a trait is removed. This\nhelps ensure that all trait changes are caught by smithy-diff, while\nstill allowing more granular control through the tags.", "committedDate": "2020-09-11T00:29:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyMDY5Nw==", "url": "https://github.com/awslabs/smithy/pull/561#discussion_r487120697", "body": "```suggestion\r\n                            \"The `%s` trait was added to the `%s` %s shape with the value: %s\",\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        \"The `%s` trait was added to the `%s` %s shape: %s\",\n          \n          \n            \n                                        \"The `%s` trait was added to the `%s` %s shape with the value: %s\",", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The `%s` trait was added to the `%s` %s shape: %s<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The `%s` trait was added to the `%s` %s shape<span class=\"x x-first x-last\"> with the value</span>: %s<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "kstich", "createdAt": "2020-09-11T15:26:36Z", "path": "smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java", "diffHunk": "@@ -101,6 +101,29 @@\n                             changedShape.getNewShape().getType(),\n                             Node.prettyPrintJson(oldTrait.toNode()),\n                             Node.prettyPrintJson(newTrait.toNode()))));\n+                } else if (oldTrait == null) {\n+                    events.add(note(changedShape.getNewShape(), newTrait, String.format(\n+                            \"The `%s` trait was added to the `%s` %s shape: %s\",", "originalCommit": "19bb6d91da4d6b9cb3360388ae15b25ef851978c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyMDkyMQ==", "url": "https://github.com/awslabs/smithy/pull/561#discussion_r487120921", "body": "```suggestion\r\n        assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape with the value: \\\"foo\\\"\"));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape: \\\"foo\\\"\"));\n          \n          \n            \n                    assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape with the value: \\\"foo\\\"\"));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        assertThat(messages, hasItem(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape: <span class=\"pl-cce\">\\\"</span>foo<span class=\"pl-cce\">\\\"</span><span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        assertThat(messages, hasItem(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape<span class=\"x x-first x-last\"> with the value</span>: <span class=\"pl-cce\">\\\"</span>foo<span class=\"pl-cce\">\\\"</span><span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "kstich", "createdAt": "2020-09-11T15:26:54Z", "path": "smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java", "diffHunk": "@@ -98,4 +103,28 @@ private static Shape createDefinition(String tag) {\n                 .addTrait(TraitDefinition.builder().build())\n                 .build();\n     }\n+\n+    @Test\n+    public void modifiedShapeNoTag() {\n+        Model modelA = Model.assembler()\n+                .addImport(getClass().getResource(\"trait-test-a.smithy\"))\n+                .assemble()\n+                .unwrap();\n+        Model modelB = Model.assembler()\n+                .addImport(getClass().getResource(\"trait-test-b.smithy\"))\n+                .assemble()\n+                .unwrap();\n+        List<ValidationEvent> events = TestHelper.findEvents(ModelDiff.compare(modelA, modelB), \"ModifiedTrait\");\n+        List<String> messages = events.stream()\n+                .map(ValidationEvent::getMessage)\n+                .collect(Collectors.toList());\n+\n+        assertThat(events, hasSize(3));\n+        assertThat(events.stream().filter(e -> e.getSeverity() == Severity.WARNING).count(), equalTo(1L));\n+        assertThat(events.stream().filter(e -> e.getSeverity() == Severity.NOTE).count(), equalTo(2L));\n+\n+        assertThat(messages, hasItem(\"The `smithy.example#c` trait was added to the `smithy.example#Foo` string shape: \\\"foo\\\"\"));", "originalCommit": "19bb6d91da4d6b9cb3360388ae15b25ef851978c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e82477ebcbca25140687d8a2ff82b932443776c", "url": "https://github.com/awslabs/smithy/commit/5e82477ebcbca25140687d8a2ff82b932443776c", "message": "Update smithy-diff/src/main/java/software/amazon/smithy/diff/evaluators/ModifiedTrait.java\n\nCo-authored-by: Kevin Stich <stickevi@amazon.com>", "committedDate": "2020-09-11T19:32:50Z", "type": "commit"}, {"oid": "facd957842ffbf96efb4d3e68eb4bd4a7af85a5b", "url": "https://github.com/awslabs/smithy/commit/facd957842ffbf96efb4d3e68eb4bd4a7af85a5b", "message": "Update smithy-diff/src/test/java/software/amazon/smithy/diff/evaluators/ModifiedTraitTest.java\n\nCo-authored-by: Kevin Stich <stickevi@amazon.com>", "committedDate": "2020-09-11T19:32:55Z", "type": "commit"}]}