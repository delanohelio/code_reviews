{"pr_number": 502, "pr_title": "[KOGITO-1968] Allow milestones to trigger completion and tests", "pr_author": "ruromero", "pr_createdAt": "2020-05-12T11:48:15Z", "pr_url": "https://github.com/kiegroup/kogito-runtimes/pull/502", "timeline": [{"oid": "0a9fe26c9b0d0f6452f7e20027a02ffdbb9af6bd", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0a9fe26c9b0d0f6452f7e20027a02ffdbb9af6bd", "message": "[KOGITO-1968] Allow milestones to trigger completion and tests\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-12T14:33:14Z", "type": "forcePushed"}, {"oid": "49af4e0b7b7a207b0a97eb658b3d4dc8334e9f3f", "url": "https://github.com/kiegroup/kogito-runtimes/commit/49af4e0b7b7a207b0a97eb658b3d4dc8334e9f3f", "message": "[KOGITO-1968] Allow milestones to trigger completion and tests\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-12T16:46:25Z", "type": "forcePushed"}, {"oid": "8f227e60c65322cfcf371fe3ee9ff81f8397252c", "url": "https://github.com/kiegroup/kogito-runtimes/commit/8f227e60c65322cfcf371fe3ee9ff81f8397252c", "message": "[KOGITO-1968] Allow milestones to trigger completion and tests\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-13T10:35:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NjY1Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424376657", "body": "why is this needed? if we make getAgenda() return null in the dummy implementation then you can just null check `getAgenda()`. Remember we want to get rid of the dummy implementation. ", "bodyText": "why is this needed? if we make getAgenda() return null in the dummy implementation then you can just null check getAgenda(). Remember we want to get rid of the dummy implementation.", "bodyHTML": "<p dir=\"auto\">why is this needed? if we make getAgenda() return null in the dummy implementation then you can just null check <code>getAgenda()</code>. Remember we want to get rid of the dummy implementation.</p>", "author": "evacchi", "createdAt": "2020-05-13T11:51:40Z", "path": "api/kogito-api/src/main/java/org/kie/api/runtime/rule/RuleRuntime.java", "diffHunk": "@@ -45,6 +45,13 @@\n      */\n     Agenda getAgenda();\n \n+    /**\n+     * @return true if the Runtime supports the Agenda\n+     */\n+    default boolean hasAgenda() {", "originalCommit": "8f227e60c65322cfcf371fe3ee9ff81f8397252c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3MzYwNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424473605", "bodyText": "good point, +1", "author": "tiagodolphine", "createdAt": "2020-05-13T14:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NjY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3NzgyNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424377826", "body": "memo: I wonder if we should keep these overrides in Kogito", "bodyText": "memo: I wonder if we should keep these overrides in Kogito", "bodyHTML": "<p dir=\"auto\">memo: I wonder if we should keep these overrides in Kogito</p>", "author": "evacchi", "createdAt": "2020-05-13T11:53:55Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/workflow/instance/impl/WorkflowProcessInstanceImpl.java", "diffHunk": "@@ -142,7 +144,7 @@ public void addNodeInstance(final NodeInstance nodeInstance) {\n \n     @Override\n     public int getLevelForNode(String uniqueID) {\n-        if (\"true\".equalsIgnoreCase(System.getProperty(\"jbpm.loop.level.disabled\"))) {\n+        if (Boolean.parseBoolean(System.getProperty(\"jbpm.loop.level.disabled\"))) {", "originalCommit": "8f227e60c65322cfcf371fe3ee9ff81f8397252c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3OTI0Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424379246", "body": "I can see now where rules are used, and we should probably **write a short spec for this** and see how we can reproduce it in the best way. Rule flow groups should be considered deprecated for Drools. Maybe we can write a \"System RuleUnit\" in the libary if these rules are static, or we could synthesize a rule unit to be used internally.", "bodyText": "I can see now where rules are used, and we should probably write a short spec for this and see how we can reproduce it in the best way. Rule flow groups should be considered deprecated for Drools. Maybe we can write a \"System RuleUnit\" in the libary if these rules are static, or we could synthesize a rule unit to be used internally.", "bodyHTML": "<p dir=\"auto\">I can see now where rules are used, and we should probably <strong>write a short spec for this</strong> and see how we can reproduce it in the best way. Rule flow groups should be considered deprecated for Drools. Maybe we can write a \"System RuleUnit\" in the libary if these rules are static, or we could synthesize a rule unit to be used internally.</p>", "author": "evacchi", "createdAt": "2020-05-13T11:56:36Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/MilestoneNodeInstance.java", "diffHunk": "@@ -53,10 +53,13 @@ public void internalTrigger(final NodeInstance from, String type) {\n             throw new IllegalArgumentException(\n                     \"A MilestoneNode only accepts default incoming connections!\");\n         }\n-        String rule = \"RuleFlow-Milestone-\" + getProcessInstance().getProcessId()\n-                + \"-\" + getMilestoneNode().getUniqueId();\n-        boolean isActive = ((InternalAgenda) getProcessInstance().getKnowledgeRuntime().getAgenda())\n-                .isRuleActiveInRuleFlowGroup(\"DROOLS_SYSTEM\", rule, getProcessInstance().getId());\n+        boolean isActive = true;\n+        if(getProcessInstance().getKnowledgeRuntime().hasAgenda()) {\n+            String rule = \"RuleFlow-Milestone-\" + getProcessInstance().getProcessId()\n+                    + \"-\" + getMilestoneNode().getUniqueId();\n+            isActive = ((InternalAgenda) getProcessInstance().getKnowledgeRuntime().getAgenda())\n+                    .isRuleActiveInRuleFlowGroup(\"DROOLS_SYSTEM\", rule, getProcessInstance().getId());\n+        }", "originalCommit": "8f227e60c65322cfcf371fe3ee9ff81f8397252c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUxMDg5NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424510895", "bodyText": "I have filed the following JIRA https://issues.redhat.com/browse/KOGITO-2168", "author": "ruromero", "createdAt": "2020-05-13T15:04:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM3OTI0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ4MTI5Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424481292", "body": "suggestion\r\n`.filter(nodeInstance -> Objects.equals(nodeInstance.getId(), nodeInstanceId))`\r\n", "bodyText": "suggestion\n.filter(nodeInstance -> Objects.equals(nodeInstance.getId(), nodeInstanceId))", "bodyHTML": "<p dir=\"auto\">suggestion<br>\n<code>.filter(nodeInstance -&gt; Objects.equals(nodeInstance.getId(), nodeInstanceId))</code></p>", "author": "tiagodolphine", "createdAt": "2020-05-13T14:27:03Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/workflow/instance/impl/WorkflowProcessInstanceImpl.java", "diffHunk": "@@ -193,22 +195,15 @@ public void removeNodeInstance(final NodeInstance nodeInstance) {\n \n     @Override\n     public NodeInstance getNodeInstance(String nodeInstanceId) {\n-        for (NodeInstance nodeInstance : nodeInstances) {\n-            if (nodeInstance.getId().equals(nodeInstanceId)) {\n-                return nodeInstance;\n-            }\n-        }\n-        return null;\n+        return getNodeInstance(nodeInstanceId, false);\n     }\n \n     @Override\n     public NodeInstance getNodeInstance(String nodeInstanceId, boolean recursive) {\n-        for (NodeInstance nodeInstance : getNodeInstances(recursive)) {\n-            if (nodeInstance.getId().equals(nodeInstanceId)) {\n-                return nodeInstance;\n-            }\n-        }\n-        return null;\n+        return getNodeInstances(recursive).stream()\n+                .filter(nodeInstance -> nodeInstance.getId().equals(nodeInstanceId))", "originalCommit": "8f227e60c65322cfcf371fe3ee9ff81f8397252c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5OTc4Nw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424499787", "body": "trying to simplify this block... just sugestion:\r\n```\r\nOptional.ofNullable(getProcessInstance())\r\n                .map(WorkflowProcessInstance::getKnowledgeRuntime)\r\n                .map(InternalKnowledgeRuntime::getAgenda)                \r\n                .filter(InternalAgenda.class::isInstance)\r\n                .map(InternalAgenda.class::cast)\r\n                .map(agenda -> {\r\n                    String rule =\r\n                            \"RuleFlow-Milestone-\" + getProcessInstance().getProcessId() + \"-\" + getMilestoneNode().getUniqueId();\r\n                    return agenda.isRuleActiveInRuleFlowGroup(\"DROOLS_SYSTEM\", rule, getProcessInstance().getId());\r\n                })\r\n                .orElse(true);\r\n```", "bodyText": "trying to simplify this block... just sugestion:\nOptional.ofNullable(getProcessInstance())\n                .map(WorkflowProcessInstance::getKnowledgeRuntime)\n                .map(InternalKnowledgeRuntime::getAgenda)                \n                .filter(InternalAgenda.class::isInstance)\n                .map(InternalAgenda.class::cast)\n                .map(agenda -> {\n                    String rule =\n                            \"RuleFlow-Milestone-\" + getProcessInstance().getProcessId() + \"-\" + getMilestoneNode().getUniqueId();\n                    return agenda.isRuleActiveInRuleFlowGroup(\"DROOLS_SYSTEM\", rule, getProcessInstance().getId());\n                })\n                .orElse(true);", "bodyHTML": "<p dir=\"auto\">trying to simplify this block... just sugestion:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Optional.ofNullable(getProcessInstance())\n                .map(WorkflowProcessInstance::getKnowledgeRuntime)\n                .map(InternalKnowledgeRuntime::getAgenda)                \n                .filter(InternalAgenda.class::isInstance)\n                .map(InternalAgenda.class::cast)\n                .map(agenda -&gt; {\n                    String rule =\n                            &quot;RuleFlow-Milestone-&quot; + getProcessInstance().getProcessId() + &quot;-&quot; + getMilestoneNode().getUniqueId();\n                    return agenda.isRuleActiveInRuleFlowGroup(&quot;DROOLS_SYSTEM&quot;, rule, getProcessInstance().getId());\n                })\n                .orElse(true);\"><pre><code>Optional.ofNullable(getProcessInstance())\n                .map(WorkflowProcessInstance::getKnowledgeRuntime)\n                .map(InternalKnowledgeRuntime::getAgenda)                \n                .filter(InternalAgenda.class::isInstance)\n                .map(InternalAgenda.class::cast)\n                .map(agenda -&gt; {\n                    String rule =\n                            \"RuleFlow-Milestone-\" + getProcessInstance().getProcessId() + \"-\" + getMilestoneNode().getUniqueId();\n                    return agenda.isRuleActiveInRuleFlowGroup(\"DROOLS_SYSTEM\", rule, getProcessInstance().getId());\n                })\n                .orElse(true);\n</code></pre></div>", "author": "tiagodolphine", "createdAt": "2020-05-13T14:50:35Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/MilestoneNodeInstance.java", "diffHunk": "@@ -53,10 +53,13 @@ public void internalTrigger(final NodeInstance from, String type) {\n             throw new IllegalArgumentException(\n                     \"A MilestoneNode only accepts default incoming connections!\");\n         }\n-        String rule = \"RuleFlow-Milestone-\" + getProcessInstance().getProcessId()\n-                + \"-\" + getMilestoneNode().getUniqueId();\n-        boolean isActive = ((InternalAgenda) getProcessInstance().getKnowledgeRuntime().getAgenda())\n-                .isRuleActiveInRuleFlowGroup(\"DROOLS_SYSTEM\", rule, getProcessInstance().getId());\n+        boolean isActive = true;", "originalCommit": "8f227e60c65322cfcf371fe3ee9ff81f8397252c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNDI5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424704291", "bodyText": "Although your suggestion is fancier I believe the existing code is easier to understand and maintain.", "author": "ruromero", "createdAt": "2020-05-13T20:14:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5OTc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcxNzM5NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424717394", "bodyText": "Sure, no problem, go with it, as I said just a suggestion a matter of taste, I really like and think a more functional approach is cleaner :)", "author": "tiagodolphine", "createdAt": "2020-05-13T20:39:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5OTc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2MjQ2OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424962469", "bodyText": "either way, this is just a refactoring of the existing code (@ruromero only added the null check around it and reformatted a bit); it doesn't really matter because I am pretty sure all this will have to be nuked in favor of rule units \ud83e\udd14", "author": "evacchi", "createdAt": "2020-05-14T08:32:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ5OTc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwNDA1Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424504052", "body": "Are the castings safe? WorkflowProcess, WorkflowProcessInstance, Is it worth checking instanceof before casting?", "bodyText": "Are the castings safe? WorkflowProcess, WorkflowProcessInstance, Is it worth checking instanceof before casting?", "bodyHTML": "<p dir=\"auto\">Are the castings safe? WorkflowProcess, WorkflowProcessInstance, Is it worth checking instanceof before casting?</p>", "author": "tiagodolphine", "createdAt": "2020-05-13T14:55:50Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -163,14 +164,20 @@ public void start(String trigger, String referenceId) {\n             this.status = legacyProcessInstance.getState();\n         }\n     }\n+\n+    public void complete() {\n+        if(((WorkflowProcess)legacyProcessInstance.getProcess()).isDynamic() && this.status.equals(ProcessInstance.STATE_ACTIVE)) {", "originalCommit": "8f227e60c65322cfcf371fe3ee9ff81f8397252c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwNjU5OQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424706599", "bodyText": "If the legacyProcessInstance.getProcess() is always returning what is generated by the legacyProcess() method coming from the codegen I'd say the only possibility is that it is a RuleFlowProcess which extends WorkflowProcessImpl", "author": "ruromero", "createdAt": "2020-05-13T20:18:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwNDA1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcxNzQ5MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r424717491", "bodyText": "\ud83d\udc4d", "author": "tiagodolphine", "createdAt": "2020-05-13T20:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwNDA1Mg=="}], "type": "inlineReview"}, {"oid": "298d0f68776e23a7c1bfd8bb0a9793760eacafc4", "url": "https://github.com/kiegroup/kogito-runtimes/commit/298d0f68776e23a7c1bfd8bb0a9793760eacafc4", "message": "[KOGITO-1968] DummyKnowledgeRuntime#getAgenda return null\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-13T15:04:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODgwNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r426838807", "body": "So Kogito process instance is completed, but legacy process instance is still active? Is that right? If so, why is it like that? I understand that cases are basically never complete as we discussed it on Zulip, but this can be considered as an inconsistency - one status is completed, the second one is active.", "bodyText": "So Kogito process instance is completed, but legacy process instance is still active? Is that right? If so, why is it like that? I understand that cases are basically never complete as we discussed it on Zulip, but this can be considered as an inconsistency - one status is completed, the second one is active.", "bodyHTML": "<p dir=\"auto\">So Kogito process instance is completed, but legacy process instance is still active? Is that right? If so, why is it like that? I understand that cases are basically never complete as we discussed it on Zulip, but this can be considered as an inconsistency - one status is completed, the second one is active.</p>", "author": "MarianMacik", "createdAt": "2020-05-18T19:11:33Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -163,14 +164,20 @@ public void start(String trigger, String referenceId) {\n             this.status = legacyProcessInstance.getState();\n         }\n     }\n+\n+    public void complete() {\n+        if(((WorkflowProcess)legacyProcessInstance.getProcess()).isDynamic() && this.status.equals(ProcessInstance.STATE_ACTIVE)) {\n+            ((WorkflowProcessInstance)legacyProcessInstance).setState(STATE_ACTIVE);\n+            this.status = ProcessInstance.STATE_COMPLETED;", "originalCommit": "298d0f68776e23a7c1bfd8bb0a9793760eacafc4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg0MTcyNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r426841724", "bodyText": "Also btw - this feature is already present in 7.x? I think that we can there only close or destroy a case instance, right? We cannot explicitly complete it...", "author": "MarianMacik", "createdAt": "2020-05-18T19:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg2MzkyMA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r426863920", "bodyText": "Ad-hoc processes, i.e. cases, can't autocomplete unless there is a terminate end node but this is not common in cases where knowledge workers might want to add/update information in the case or trigger discretionary tasks. That means there wasn't a mechanism to close a case.\nRegarding the naming. In 7.x you could close a case but here we are not explicitly using a Case model naming. We're still talking about processes and processes from the ACTIVE state move to the COMPLETED state, thus this action. Do you agree?", "author": "ruromero", "createdAt": "2020-05-18T20:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1MTQ2Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r427151462", "bodyText": "I agree, but somewhat I missed the explanation why the legacy process is still being kept ACTIVE :)", "author": "MarianMacik", "createdAt": "2020-05-19T09:13:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODgwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI4MzU4MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r427283581", "bodyText": "I get your point and that had to be aligned indeed. Thanks for your thorough review.", "author": "ruromero", "createdAt": "2020-05-19T13:02:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODgwNw=="}], "type": "inlineReview"}, {"oid": "0cda3ed4c1ae6d9bd2eaebaed05a8e6ba6a14a9b", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0cda3ed4c1ae6d9bd2eaebaed05a8e6ba6a14a9b", "message": "[KOGITO-1968] Validate both states\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-19T15:34:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTQzMg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428495432", "body": "from a perspective that processes will have at least some degree of structure, would it still make sense to allow it to be completed at any time? Thinking if we should first try to go for having a minial path that demonstrates how the process will be completed, not so much like a case close action. @ruromero @krisv wdyt?", "bodyText": "from a perspective that processes will have at least some degree of structure, would it still make sense to allow it to be completed at any time? Thinking if we should first try to go for having a minial path that demonstrates how the process will be completed, not so much like a case close action. @ruromero @krisv wdyt?", "bodyHTML": "<p dir=\"auto\">from a perspective that processes will have at least some degree of structure, would it still make sense to allow it to be completed at any time? Thinking if we should first try to go for having a minial path that demonstrates how the process will be completed, not so much like a case close action. <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/ruromero/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ruromero\">@ruromero</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/krisv/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/krisv\">@krisv</a> wdyt?</p>", "author": "cristianonicolai", "createdAt": "2020-05-21T07:39:37Z", "path": "api/kogito-api/src/main/java/org/kie/kogito/process/ProcessInstance.java", "diffHunk": "@@ -65,7 +65,12 @@\n      * @param referenceId optional reference id that points to a another  component triggering this instance\n      */\n     void startFrom(String nodeId, String referenceId);\n-    \n+\n+    /**\n+     * Completes a dynamic process that is in the ACTIVE state.\n+     */\n+    void complete();", "originalCommit": "9186456f1fefeb02b3349b7ba2013894aa9ed3d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUxNjEzMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428516131", "bodyText": "I think this is something we need at this point and we can adapt later on. Dynamic processes need a way to be completed.", "author": "ruromero", "createdAt": "2020-05-21T08:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxODQ1Ng==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428618456", "bodyText": "@ruromero sure, in the example you created the test can be completed once the milestone is achieved, we dont necessarly want to manually have to call complete in a process. We're trying to give some flexibility but not complete freedom, to me the process needs to to handle a expected path to end, otherwise people can still abort the process instance.", "author": "cristianonicolai", "createdAt": "2020-05-21T12:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTQzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNTE1MQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428635151", "bodyText": "Complete only affects dynamic processes that are active. How do you want to limit it's usage? By only allow processes without any active node to be completed for example?", "author": "ruromero", "createdAt": "2020-05-21T12:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NTQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NzQxNQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428497415", "body": "@ruromero is there any point for us to add this if we wont actually use this approach with the internal agenda? I guess we should simply set active to true.", "bodyText": "@ruromero is there any point for us to add this if we wont actually use this approach with the internal agenda? I guess we should simply set active to true.", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/ruromero/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ruromero\">@ruromero</a> is there any point for us to add this if we wont actually use this approach with the internal agenda? I guess we should simply set active to true.</p>", "author": "cristianonicolai", "createdAt": "2020-05-21T07:44:13Z", "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/MilestoneNodeInstance.java", "diffHunk": "@@ -53,10 +53,14 @@ public void internalTrigger(final NodeInstance from, String type) {\n             throw new IllegalArgumentException(\n                     \"A MilestoneNode only accepts default incoming connections!\");\n         }\n-        String rule = \"RuleFlow-Milestone-\" + getProcessInstance().getProcessId()\n-                + \"-\" + getMilestoneNode().getUniqueId();\n-        boolean isActive = ((InternalAgenda) getProcessInstance().getKnowledgeRuntime().getAgenda())\n-                .isRuleActiveInRuleFlowGroup(\"DROOLS_SYSTEM\", rule, getProcessInstance().getId());\n+        boolean isActive = true;\n+        // KOGITO-2168 Conditions not supported\n+        if(getProcessInstance().getKnowledgeRuntime().getAgenda() != null) {", "originalCommit": "9186456f1fefeb02b3349b7ba2013894aa9ed3d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUwNTk1NA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428505954", "bodyText": "I didn't want to remove the old functionality because other tests still rely on the agenda. Until we don't provide a replacement for conditions I prefer to keep it this way.", "author": "ruromero", "createdAt": "2020-05-21T08:03:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NzQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxOTI2Mw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428619263", "bodyText": "so maybe we should remove the old tests as well :) My concern is to bring things that we wont/dont need, removing later is way more complicated to assess.", "author": "cristianonicolai", "createdAt": "2020-05-21T12:23:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NzQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNjYzNg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428636636", "bodyText": "I'm always up for removing stuff. I just didn't dare to do it without a second opinion.", "author": "ruromero", "createdAt": "2020-05-21T13:01:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NzQxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2NjE4NQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428666185", "bodyText": "sorry, wrong gitlog :P looks fine as is", "author": "cristianonicolai", "createdAt": "2020-05-21T13:55:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5NzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5ODMwMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428498303", "body": "@ruromero should the actual milestone state be checked here?", "bodyText": "@ruromero should the actual milestone state be checked here?", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/ruromero/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ruromero\">@ruromero</a> should the actual milestone state be checked here?</p>", "author": "cristianonicolai", "createdAt": "2020-05-21T07:46:24Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/MilestoneTest.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+class MilestoneTest extends AbstractCodegenTest {\n+\n+    @Test\n+    void testSimpleMilestone() throws Exception {", "originalCommit": "9186456f1fefeb02b3349b7ba2013894aa9ed3d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzMzkyNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428633927", "bodyText": "Check my latest changes", "author": "ruromero", "createdAt": "2020-05-21T12:56:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ5ODMwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyMDEzNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428620137", "body": "```suggestion\r\n        ProcessInstance<?> processInstance = p.createInstance(p.createInstance(p.createModel()));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ProcessInstance<?> processInstance = p.createInstance(m);\n          \n          \n            \n                    ProcessInstance<?> processInstance = p.createInstance(p.createInstance(p.createModel()));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">ProcessInstance&lt;?&gt;</span> processInstance <span class=\"pl-k\">=</span> p<span class=\"pl-k\">.</span>createInstance(<span class=\"x x-first x-last\">m</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">ProcessInstance&lt;?&gt;</span> processInstance <span class=\"pl-k\">=</span> p<span class=\"pl-k\">.</span>createInstance(<span class=\"x x-first\">p</span><span class=\"pl-k x\">.</span><span class=\"x\">createInstance(p</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">createModel())</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cristianonicolai", "createdAt": "2020-05-21T12:25:59Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/MilestoneTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import org.jbpm.ruleflow.core.Metadata;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.core.Node;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class MilestoneTest extends AbstractCodegenTest {\n+\n+    @Test\n+    void testSimpleMilestone() throws Exception {\n+\n+        Application app = generateCodeProcessesOnly(\"cases/SimpleMilestone.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.SimpleMilestone\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        ProcessInstance<?> processInstance = p.createInstance(m);", "originalCommit": "7c0d50cf64a0fe1f340e8b18eee53676627d5379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0Mzk1MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428643950", "bodyText": "Not exactly this but I see your point", "author": "ruromero", "createdAt": "2020-05-21T13:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyMDEzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyMjE4MA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428622180", "body": "I think you can simplify the status check by doing:\r\n```suggestion\r\nassertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_PENDING);\r\n```", "bodyText": "I think you can simplify the status check by doing:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertState(processInstance, ProcessInstance.STATE_PENDING);\n          \n          \n            \n            assertThat(processInstance.status()).isEqualTo(ProcessInstance.STATE_PENDING);", "bodyHTML": "<p dir=\"auto\">I think you can simplify the status check by doing:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first x-last\">        assertState</span>(processInstance<span class=\"x x-first x-last\">, </span><span class=\"pl-smi\">ProcessInstance</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>STATE_PENDING</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"x x-first x-last\">assertThat</span>(processInstance<span class=\"pl-k x x-first\">.</span><span class=\"x\">status())</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">isEqualTo(</span><span class=\"pl-smi\">ProcessInstance</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>STATE_PENDING</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cristianonicolai", "createdAt": "2020-05-21T12:30:34Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/MilestoneTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import org.jbpm.ruleflow.core.Metadata;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.core.Node;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class MilestoneTest extends AbstractCodegenTest {\n+\n+    @Test\n+    void testSimpleMilestone() throws Exception {\n+\n+        Application app = generateCodeProcessesOnly(\"cases/SimpleMilestone.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.SimpleMilestone\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+\n+        assertState(processInstance, ProcessInstance.STATE_PENDING);", "originalCommit": "7c0d50cf64a0fe1f340e8b18eee53676627d5379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0MTYxOQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428641619", "bodyText": "I want to make sure the state in the processInstance and in the legacyProcessInstance are in sync", "author": "ruromero", "createdAt": "2020-05-21T13:11:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyMjE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyMjkxOA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428622918", "body": "Im not sure what's the point in regards to testing milestones to call complete here, I would recommend removing it.", "bodyText": "Im not sure what's the point in regards to testing milestones to call complete here, I would recommend removing it.", "bodyHTML": "<p dir=\"auto\">Im not sure what's the point in regards to testing milestones to call complete here, I would recommend removing it.</p>", "author": "cristianonicolai", "createdAt": "2020-05-21T12:32:13Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/MilestoneTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import org.jbpm.ruleflow.core.Metadata;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.core.Node;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class MilestoneTest extends AbstractCodegenTest {\n+\n+    @Test\n+    void testSimpleMilestone() throws Exception {\n+\n+        Application app = generateCodeProcessesOnly(\"cases/SimpleMilestone.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.SimpleMilestone\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+\n+        assertState(processInstance, ProcessInstance.STATE_PENDING);\n+        processInstance.complete();", "originalCommit": "7c0d50cf64a0fe1f340e8b18eee53676627d5379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc4MDMwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428780304", "bodyText": "As discussed I have removed the complete method. A terminate end node must be present in order for the dynamic process to complete", "author": "ruromero", "createdAt": "2020-05-21T16:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyMjkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzOTYxMQ==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428639611", "body": "@ruromero I guess the idea would be to add a method into _RuleFlowProcessInstance_ with a list of miliestones, that then we could check using a status like _MilestoneStatus_ from v7. No need to publish it in the ProcessInstance object for now.", "bodyText": "@ruromero I guess the idea would be to add a method into RuleFlowProcessInstance with a list of miliestones, that then we could check using a status like MilestoneStatus from v7. No need to publish it in the ProcessInstance object for now.", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/ruromero/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ruromero\">@ruromero</a> I guess the idea would be to add a method into <em>RuleFlowProcessInstance</em> with a list of miliestones, that then we could check using a status like <em>MilestoneStatus</em> from v7. No need to publish it in the ProcessInstance object for now.</p>", "author": "cristianonicolai", "createdAt": "2020-05-21T13:07:44Z", "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/MilestoneTest.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import org.jbpm.ruleflow.core.Metadata;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.core.Node;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+class MilestoneTest extends AbstractCodegenTest {\n+\n+    @Test\n+    void testSimpleMilestone() throws Exception {\n+\n+        Application app = generateCodeProcessesOnly(\"cases/SimpleMilestone.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.SimpleMilestone\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+\n+        assertState(processInstance, ProcessInstance.STATE_PENDING);\n+        processInstance.complete();\n+        assertState(processInstance, ProcessInstance.STATE_PENDING);\n+\n+        processInstance.start();\n+        assertState(processInstance, ProcessInstance.STATE_ACTIVE);\n+        \n+        RuleFlowProcessInstance legacyProcessInstance = (RuleFlowProcessInstance)((AbstractProcessInstance<?>) processInstance).legacyProcessInstance;\n+        assertThat(legacyProcessInstance.getNodeInstances()).isEmpty();\n+        assertThat(legacyProcessInstance.getNodeIdInError()).isNullOrEmpty();\n+        Optional<String> milestoneId = Stream.of(legacyProcessInstance.getNodeContainer().getNodes()).filter(node -> node.getName().equals(\"Milestone1\")).map(n -> (String)n.getMetaData().get(Metadata.UNIQUE_ID)).findFirst();", "originalCommit": "7c0d50cf64a0fe1f340e8b18eee53676627d5379", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3OTkwNA==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r428779904", "bodyText": "I have added the milestones method as suggested", "author": "ruromero", "createdAt": "2020-05-21T16:49:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzOTYxMQ=="}], "type": "inlineReview"}, {"oid": "79cd7a1ad0de3a91eea6046e7da195704265c0bc", "url": "https://github.com/kiegroup/kogito-runtimes/commit/79cd7a1ad0de3a91eea6046e7da195704265c0bc", "message": "[KOGITO-1968] Remove complete and add milestones method\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-21T16:45:39Z", "type": "forcePushed"}, {"oid": "66965cb8d73e701164e3e801dc3c9d5f0caded20", "url": "https://github.com/kiegroup/kogito-runtimes/commit/66965cb8d73e701164e3e801dc3c9d5f0caded20", "message": "[KOGITO-1968] Remove complete and add milestones method\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-21T16:51:59Z", "type": "forcePushed"}, {"oid": "666317c55fa31fd6b26ecb0d2f69a9d076227644", "url": "https://github.com/kiegroup/kogito-runtimes/commit/666317c55fa31fd6b26ecb0d2f69a9d076227644", "message": "[KOGITO-1968] Remove complete and add milestones method\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-21T16:54:22Z", "type": "forcePushed"}, {"oid": "7de57ff745101d539cdbf532c2832ae41ca63738", "url": "https://github.com/kiegroup/kogito-runtimes/commit/7de57ff745101d539cdbf532c2832ae41ca63738", "message": "[KOGITO-1968] Remove complete and add milestones method\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-21T16:59:35Z", "type": "forcePushed"}, {"oid": "b79a543fd0a66827cda74afcd9c547ee3f347306", "url": "https://github.com/kiegroup/kogito-runtimes/commit/b79a543fd0a66827cda74afcd9c547ee3f347306", "message": "[KOGITO-1968] Allow milestones to trigger completion\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-22T08:30:56Z", "type": "forcePushed"}, {"oid": "bc3e7ab996d726089ed6b3f50c8837c679dd8e7c", "url": "https://github.com/kiegroup/kogito-runtimes/commit/bc3e7ab996d726089ed6b3f50c8837c679dd8e7c", "message": "[KOGITO-1968] Allow milestones to trigger completion\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-22T08:39:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEzNTcxNw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r429135717", "body": "```suggestion\r\npublic class MilestoneInstance implements Serializable {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class CaseNodeInstance implements Serializable {\n          \n          \n            \n            public class MilestoneInstance implements Serializable {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">CaseNodeInstance</span> <span class=\"pl-k\">implements</span> <span class=\"pl-e\">Serializable</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">MilestoneInstance</span> <span class=\"pl-k\">implements</span> <span class=\"pl-e\">Serializable</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cristianonicolai", "createdAt": "2020-05-22T09:15:59Z", "path": "api/kogito-api/src/main/java/org/kie/kogito/process/CaseNodeInstance.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process;\n+\n+import java.io.Serializable;\n+\n+public class CaseNodeInstance implements Serializable {", "originalCommit": "bc3e7ab996d726089ed6b3f50c8837c679dd8e7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "acf9afe2dbce7478051e1124a3c3b794673f96fb", "url": "https://github.com/kiegroup/kogito-runtimes/commit/acf9afe2dbce7478051e1124a3c3b794673f96fb", "message": "[KOGITO-1968] Allow milestones to trigger completion\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-22T12:53:14Z", "type": "forcePushed"}, {"oid": "155315725d533ad1dbfbc9251d6822aee9ff1c43", "url": "https://github.com/kiegroup/kogito-runtimes/commit/155315725d533ad1dbfbc9251d6822aee9ff1c43", "message": "[KOGITO-1968] Allow milestones to trigger completion\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-22T13:12:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxODcxMw==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r429318713", "body": "```suggestion\r\n    private Stream<Node> getNodeInstances(Class<? extends Node> nodeClass) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Stream<Node> getCaseNodeInstances(Class<? extends Node> nodeClass) {\n          \n          \n            \n                private Stream<Node> getNodeInstances(Class<? extends Node> nodeClass) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">Stream&lt;<span class=\"pl-smi\">Node</span>&gt;</span> <span class=\"x x-first x-last\">getCaseNodeInstances</span>(<span class=\"pl-k\">Class&lt;? extends <span class=\"pl-smi\">Node</span>&gt;</span> nodeClass) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">Stream&lt;<span class=\"pl-smi\">Node</span>&gt;</span> <span class=\"x x-first x-last\">getNodeInstances</span>(<span class=\"pl-k\">Class&lt;? extends <span class=\"pl-smi\">Node</span>&gt;</span> nodeClass) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cristianonicolai", "createdAt": "2020-05-22T15:37:38Z", "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -368,6 +378,35 @@ public void transitionWorkItem(String id, Transition<?> transition) {\n         return legacyProcessInstance().getEventDescriptions();\n     }\n \n+    @Override\n+    public Collection<Milestone> milestones() {\n+        return getCaseNodeInstances(MilestoneNode.class)\n+                .map(n -> {\n+                    String uid = (String) n.getMetaData().get(UNIQUE_ID);\n+                    return new Milestone(uid, n.getName(), getStatus(uid));\n+                })\n+                .collect(Collectors.toList());\n+    }\n+\n+    private Stream<Node> getCaseNodeInstances(Class<? extends Node> nodeClass) {", "originalCommit": "155315725d533ad1dbfbc9251d6822aee9ff1c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxMjI0Mg==", "url": "https://github.com/kiegroup/kogito-runtimes/pull/502#discussion_r429412242", "bodyText": "They're just nodes so I renamed it to getNodes", "author": "ruromero", "createdAt": "2020-05-22T19:06:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxODcxMw=="}], "type": "inlineReview"}, {"oid": "26c3b845d30a9b9bada50fd59ede11907c1d3db2", "url": "https://github.com/kiegroup/kogito-runtimes/commit/26c3b845d30a9b9bada50fd59ede11907c1d3db2", "message": "[KOGITO-1968] Allow milestones to trigger completion\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-25T07:05:16Z", "type": "forcePushed"}, {"oid": "0fcba877fbd158558ac37295ac441196c7509052", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0fcba877fbd158558ac37295ac441196c7509052", "message": "[KOGITO-1968] Allow milestones to trigger completion\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-25T08:31:03Z", "type": "commit"}, {"oid": "0fcba877fbd158558ac37295ac441196c7509052", "url": "https://github.com/kiegroup/kogito-runtimes/commit/0fcba877fbd158558ac37295ac441196c7509052", "message": "[KOGITO-1968] Allow milestones to trigger completion\n\nSigned-off-by: ruromero <rromerom@redhat.com>", "committedDate": "2020-05-25T08:31:03Z", "type": "forcePushed"}]}