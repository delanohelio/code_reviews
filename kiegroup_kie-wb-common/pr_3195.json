{"pr_number": 3195, "pr_title": "KOGITO-1301: Adding support for binary icons", "pr_author": "jesuino", "pr_createdAt": "2020-02-27T17:07:18Z", "pr_url": "https://github.com/kiegroup/kie-wb-common/pull/3195", "timeline": [{"oid": "4e05562368a4a8232e9d6093a36865750388d782", "url": "https://github.com/kiegroup/kie-wb-common/commit/4e05562368a4a8232e9d6093a36865750388d782", "message": "KOGITO-1301: Adding support for binary icons", "committedDate": "2020-02-27T17:02:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MzU5MA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3195#discussion_r385353590", "body": "Some comments about the \"default\" icon data:\r\n\r\nThe initial idea was that the `WorkItemDefinition` (domain) object has a field `iconData`, but I can be empty. This way:\r\n* Once parsing a .wid file, if there exist icon, the `iconData` will get populated with the properly value\r\n* Otherwise, if an icon cannot be loaded (for whatever reason), the `iconData` field results empy. This way:\r\n** All the components that display those icons (palette, canvas elemnts, etc) are actually taking into account the empty  data case, and they should show some default icon data\r\n** It also implies that the javascript object does not have the same default icon data value accross instances, we just keep the objec'ts field empty, and then components can react to it \r\n\r\nIt means there should be no need to set any default icon data, in case the icon is not properly loaded, just keep the String empty or `null`, and the different Stunner components woulld prpoerly show some default icon. Didn't that worked? \r\n\r\nFor example, look at how the service tasks icons (on the canvas) are being rendered [here](https://github.com/kiegroup/kie-wb-common/blob/86e50d0a15e83f46837f878d9a0c9252ce50edd4/kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-client/src/main/java/org/kie/workbench/common/stunner/bpmn/client/shape/def/ServiceTaskShapeDef.java#L93), it already checks if there is icon data, otherwise it already uses some default one.\r\n\r\nAlso, I would say there is no need for this field, even in case we need it for setting some default value, because the default icon data is already being provided by a call to this static method - [WorkItemDefinitionClientUtils#getDefaultIconData()](https://github.com/kiegroup/kie-wb-common/blob/1d96fdcb991db06a633f620e5b53a4dd22c0b5c9/kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-client/src/main/java/org/kie/workbench/common/stunner/bpmn/client/workitem/WorkItemDefinitionClientUtils.java#L25)", "bodyText": "Some comments about the \"default\" icon data:\nThe initial idea was that the WorkItemDefinition (domain) object has a field iconData, but I can be empty. This way:\n\nOnce parsing a .wid file, if there exist icon, the iconData will get populated with the properly value\nOtherwise, if an icon cannot be loaded (for whatever reason), the iconData field results empy. This way:\n** All the components that display those icons (palette, canvas elemnts, etc) are actually taking into account the empty  data case, and they should show some default icon data\n** It also implies that the javascript object does not have the same default icon data value accross instances, we just keep the objec'ts field empty, and then components can react to it\n\nIt means there should be no need to set any default icon data, in case the icon is not properly loaded, just keep the String empty or null, and the different Stunner components woulld prpoerly show some default icon. Didn't that worked?\nFor example, look at how the service tasks icons (on the canvas) are being rendered here, it already checks if there is icon data, otherwise it already uses some default one.\nAlso, I would say there is no need for this field, even in case we need it for setting some default value, because the default icon data is already being provided by a call to this static method - WorkItemDefinitionClientUtils#getDefaultIconData()", "bodyHTML": "<p dir=\"auto\">Some comments about the \"default\" icon data:</p>\n<p dir=\"auto\">The initial idea was that the <code>WorkItemDefinition</code> (domain) object has a field <code>iconData</code>, but I can be empty. This way:</p>\n<ul dir=\"auto\">\n<li>Once parsing a .wid file, if there exist icon, the <code>iconData</code> will get populated with the properly value</li>\n<li>Otherwise, if an icon cannot be loaded (for whatever reason), the <code>iconData</code> field results empy. This way:<br>\n** All the components that display those icons (palette, canvas elemnts, etc) are actually taking into account the empty  data case, and they should show some default icon data<br>\n** It also implies that the javascript object does not have the same default icon data value accross instances, we just keep the objec'ts field empty, and then components can react to it</li>\n</ul>\n<p dir=\"auto\">It means there should be no need to set any default icon data, in case the icon is not properly loaded, just keep the String empty or <code>null</code>, and the different Stunner components woulld prpoerly show some default icon. Didn't that worked?</p>\n<p dir=\"auto\">For example, look at how the service tasks icons (on the canvas) are being rendered <a href=\"https://github.com/kiegroup/kie-wb-common/blob/86e50d0a15e83f46837f878d9a0c9252ce50edd4/kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-client/src/main/java/org/kie/workbench/common/stunner/bpmn/client/shape/def/ServiceTaskShapeDef.java#L93\">here</a>, it already checks if there is icon data, otherwise it already uses some default one.</p>\n<p dir=\"auto\">Also, I would say there is no need for this field, even in case we need it for setting some default value, because the default icon data is already being provided by a call to this static method - <a href=\"https://github.com/kiegroup/kie-wb-common/blob/1d96fdcb991db06a633f620e5b53a4dd22c0b5c9/kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-client/src/main/java/org/kie/workbench/common/stunner/bpmn/client/workitem/WorkItemDefinitionClientUtils.java#L25\">WorkItemDefinitionClientUtils#getDefaultIconData()</a></p>", "author": "romartin", "createdAt": "2020-02-27T20:28:10Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/main/java/org/kie/workbench/common/stunner/kogito/client/services/WorkItemDefinitionStandaloneClientService.java", "diffHunk": "@@ -46,6 +48,21 @@\n @ApplicationScoped\n public class WorkItemDefinitionStandaloneClientService implements WorkItemDefinitionClientService {\n \n+    private static final String DEFAULT_ICON_DATA = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAARCAYAAAA7bUf6AAADVklEQVQ4EYVUbWhTVxg+UAR/\" +", "originalCommit": "4e05562368a4a8232e9d6093a36865750388d782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM3NzQwMg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3195#discussion_r385377402", "bodyText": "Hello Roger!\nThank you so much for the feedback.\nI removed the default icon and with the changes everything seen to be working now, could you please check:\n5f61a4f\nWhat I had to do:\n\nBuild the image data URI (https://en.wikipedia.org/wiki/Data_URI_scheme)\nAsk resource content API for binary content\nThe fixes on kogito-tooling side.\n\nThanks", "author": "jesuino", "createdAt": "2020-02-27T21:19:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MzU5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NDQ4Mg==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3195#discussion_r385354482", "body": "I think this is not correct, although maybe it has no implications on the final result... I mean, if exist some `iconData`, we'll set the value to the model object, but we also sholud return that content as a result for the promise, isn't it?\r\n\r\nI mean, actually, you're setting the right `iconData` to the object model, and that will make things work, but if someone using this API uses the promise result, it would always obtain the default `iconData`, instead of the actual one, isn't it?", "bodyText": "I think this is not correct, although maybe it has no implications on the final result... I mean, if exist some iconData, we'll set the value to the model object, but we also sholud return that content as a result for the promise, isn't it?\nI mean, actually, you're setting the right iconData to the object model, and that will make things work, but if someone using this API uses the promise result, it would always obtain the default iconData, instead of the actual one, isn't it?", "bodyHTML": "<p dir=\"auto\">I think this is not correct, although maybe it has no implications on the final result... I mean, if exist some <code>iconData</code>, we'll set the value to the model object, but we also sholud return that content as a result for the promise, isn't it?</p>\n<p dir=\"auto\">I mean, actually, you're setting the right <code>iconData</code> to the object model, and that will make things work, but if someone using this API uses the promise result, it would always obtain the default <code>iconData</code>, instead of the actual one, isn't it?</p>", "author": "romartin", "createdAt": "2020-02-27T20:30:15Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/main/java/org/kie/workbench/common/stunner/kogito/client/services/WorkItemDefinitionStandaloneClientService.java", "diffHunk": "@@ -131,43 +148,57 @@ public void destroy() {\n         log(\"Processing [\" + path + \"]\");\n         if (nonEmpty(path)) {\n             return resourceContentService\n-                    .get(path)\n-                    .then(value -> {\n-                        log(\"Content for path = [\" + value + \"]\");\n-                        log(\"Loading Work Items for path [\" + path + \"]\");\n-                        final List<WorkItemDefinition> wids = parse(value);\n-                        return promises.create((success, failure) -> {\n-                            promises.all(wids, this::workItemIconLoader)\n-                                    .then(wid -> {\n-                                        loaded.addAll(wids);\n-                                        success.onInvoke(loaded);\n-                                        return promises.resolve();\n-                                    })\n-                                    .catch_(error -> {\n-                                        failure.onInvoke(error);\n-                                        return null;\n-                                    });\n-                        });\n-                    });\n+                                         .get(path)\n+                                         .then(value -> {\n+                                             log(\"Content for path = [\" + value + \"]\");\n+                                             log(\"Loading Work Items for path [\" + path + \"]\");\n+                                             final List<WorkItemDefinition> wids = parse(value);\n+                                             return promises.create((success, failure) -> {\n+                                                 promises.all(wids, this::workItemIconLoader)\n+                                                         .then(wid -> {\n+                                                             loaded.addAll(wids);\n+                                                             success.onInvoke(loaded);\n+                                                             return promises.resolve();\n+                                                         })\n+                                                         .catch_(error -> {\n+                                                             failure.onInvoke(error);\n+                                                             return null;\n+                                                         });\n+                                             });\n+                                         });\n         }\n         return promises.resolve(emptyList());\n     }\n \n     private Promise workItemIconLoader(final WorkItemDefinition wid) {\n+        Console.log(\"RUNING MY CODE MAN\");\n         final String iconUri = wid.getIconDefinition().getUri();\n         log(\"Loading icon for URI [\" + iconUri + \"]\");\n         if (nonEmpty(iconUri)) {\n             return resourceContentService\n-                    .get(iconUri)\n-                    .then(iconData -> {\n-                        log(\"Content for icon = [\" + iconData + \"]\");\n-                        if (nonEmpty(iconData)) {\n-                            wid.getIconDefinition().setIconData(iconData);\n-                        }\n-                        return promises.resolve();\n-                    });\n+                                         .get(iconUri, ResourceContentOptions.binary())\n+                                         .then(iconData -> {\n+                                             log(\"Content for icon = [\" + iconData + \"]\");\n+                                             if (nonEmpty(iconData)) {\n+                                                 wid.getIconDefinition().setIconData(iconDataUri(iconUri, iconData));\n+                                             }\n+                                             return promises.resolve(DEFAULT_ICON_DATA);", "originalCommit": "4e05562368a4a8232e9d6093a36865750388d782", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NDY4MQ==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3195#discussion_r385354681", "body": "same comment as above, althogugh it has no impact on the resutls...", "bodyText": "same comment as above, althogugh it has no impact on the resutls...", "bodyHTML": "<p dir=\"auto\">same comment as above, althogugh it has no impact on the resutls...</p>", "author": "romartin", "createdAt": "2020-02-27T20:30:40Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/main/java/org/kie/workbench/common/stunner/kogito/client/services/WorkItemDefinitionStandaloneClientService.java", "diffHunk": "@@ -131,43 +148,57 @@ public void destroy() {\n         log(\"Processing [\" + path + \"]\");\n         if (nonEmpty(path)) {\n             return resourceContentService\n-                    .get(path)\n-                    .then(value -> {\n-                        log(\"Content for path = [\" + value + \"]\");\n-                        log(\"Loading Work Items for path [\" + path + \"]\");\n-                        final List<WorkItemDefinition> wids = parse(value);\n-                        return promises.create((success, failure) -> {\n-                            promises.all(wids, this::workItemIconLoader)\n-                                    .then(wid -> {\n-                                        loaded.addAll(wids);\n-                                        success.onInvoke(loaded);\n-                                        return promises.resolve();\n-                                    })\n-                                    .catch_(error -> {\n-                                        failure.onInvoke(error);\n-                                        return null;\n-                                    });\n-                        });\n-                    });\n+                                         .get(path)\n+                                         .then(value -> {\n+                                             log(\"Content for path = [\" + value + \"]\");\n+                                             log(\"Loading Work Items for path [\" + path + \"]\");\n+                                             final List<WorkItemDefinition> wids = parse(value);\n+                                             return promises.create((success, failure) -> {\n+                                                 promises.all(wids, this::workItemIconLoader)\n+                                                         .then(wid -> {\n+                                                             loaded.addAll(wids);\n+                                                             success.onInvoke(loaded);\n+                                                             return promises.resolve();\n+                                                         })\n+                                                         .catch_(error -> {\n+                                                             failure.onInvoke(error);\n+                                                             return null;\n+                                                         });\n+                                             });\n+                                         });\n         }\n         return promises.resolve(emptyList());\n     }\n \n     private Promise workItemIconLoader(final WorkItemDefinition wid) {\n+        Console.log(\"RUNING MY CODE MAN\");\n         final String iconUri = wid.getIconDefinition().getUri();\n         log(\"Loading icon for URI [\" + iconUri + \"]\");\n         if (nonEmpty(iconUri)) {\n             return resourceContentService\n-                    .get(iconUri)\n-                    .then(iconData -> {\n-                        log(\"Content for icon = [\" + iconData + \"]\");\n-                        if (nonEmpty(iconData)) {\n-                            wid.getIconDefinition().setIconData(iconData);\n-                        }\n-                        return promises.resolve();\n-                    });\n+                                         .get(iconUri, ResourceContentOptions.binary())\n+                                         .then(iconData -> {\n+                                             log(\"Content for icon = [\" + iconData + \"]\");\n+                                             if (nonEmpty(iconData)) {\n+                                                 wid.getIconDefinition().setIconData(iconDataUri(iconUri, iconData));\n+                                             }\n+                                             return promises.resolve(DEFAULT_ICON_DATA);\n+                                         }).catch_(error -> {\n+                                             log(\"Not able to load icon for URI \" + iconUri);\n+                                             return Promise.resolve(DEFAULT_ICON_DATA);\n+                                         });\n+        }\n+        return promises.resolve(DEFAULT_ICON_DATA);\n+    }\n+\n+    private String iconDataUri(String iconUri, String iconData) {\n+        String[] iconUriParts = iconUri.split(\"\\\\.\");\n+        if (iconUriParts.length > 0) {\n+            int fileTypeIndex = iconUriParts.length - 1;\n+            String fileType = iconUriParts[fileTypeIndex];\n+            return \"data:image/\" + fileType + \";base64, \" + iconData;\n         }\n-        return promises.resolve();\n+        return DEFAULT_ICON_DATA;", "originalCommit": "4e05562368a4a8232e9d6093a36865750388d782", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NTE2Ng==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3195#discussion_r385355166", "body": "As far as I tested this, by retuning `null` for a promise call, it end up on NPE's in the unit tests... did you tested unit tests still work properly after it?", "bodyText": "As far as I tested this, by retuning null for a promise call, it end up on NPE's in the unit tests... did you tested unit tests still work properly after it?", "bodyHTML": "<p dir=\"auto\">As far as I tested this, by retuning <code>null</code> for a promise call, it end up on NPE's in the unit tests... did you tested unit tests still work properly after it?</p>", "author": "romartin", "createdAt": "2020-02-27T20:31:35Z", "path": "kie-wb-common-stunner/kie-wb-common-stunner-sets/kie-wb-common-stunner-bpmn/kie-wb-common-stunner-bpmn-kogito-runtime/src/main/java/org/kie/workbench/common/stunner/kogito/client/services/WorkItemDefinitionStandaloneClientService.java", "diffHunk": "@@ -131,43 +148,57 @@ public void destroy() {\n         log(\"Processing [\" + path + \"]\");\n         if (nonEmpty(path)) {\n             return resourceContentService\n-                    .get(path)\n-                    .then(value -> {\n-                        log(\"Content for path = [\" + value + \"]\");\n-                        log(\"Loading Work Items for path [\" + path + \"]\");\n-                        final List<WorkItemDefinition> wids = parse(value);\n-                        return promises.create((success, failure) -> {\n-                            promises.all(wids, this::workItemIconLoader)\n-                                    .then(wid -> {\n-                                        loaded.addAll(wids);\n-                                        success.onInvoke(loaded);\n-                                        return promises.resolve();\n-                                    })\n-                                    .catch_(error -> {\n-                                        failure.onInvoke(error);\n-                                        return null;\n-                                    });\n-                        });\n-                    });\n+                                         .get(path)\n+                                         .then(value -> {\n+                                             log(\"Content for path = [\" + value + \"]\");\n+                                             log(\"Loading Work Items for path [\" + path + \"]\");\n+                                             final List<WorkItemDefinition> wids = parse(value);\n+                                             return promises.create((success, failure) -> {\n+                                                 promises.all(wids, this::workItemIconLoader)\n+                                                         .then(wid -> {\n+                                                             loaded.addAll(wids);\n+                                                             success.onInvoke(loaded);\n+                                                             return promises.resolve();\n+                                                         })\n+                                                         .catch_(error -> {\n+                                                             failure.onInvoke(error);\n+                                                             return null;", "originalCommit": "4e05562368a4a8232e9d6093a36865750388d782", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDE4NTQ4MA==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3195#discussion_r394185480", "bodyText": "@jesuino is this Question resolved?", "author": "domhanak", "createdAt": "2020-03-18T08:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NTE2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQ4MDc1Ng==", "url": "https://github.com/kiegroup/kie-wb-common/pull/3195#discussion_r394480756", "bodyText": "Hello,\nYes, it is fine, no NPE on tests when I checked!", "author": "jesuino", "createdAt": "2020-03-18T16:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1NTE2Ng=="}], "type": "inlineReview"}, {"oid": "5f61a4fb051ddd2ceefe352e543af453e91bfed3", "url": "https://github.com/kiegroup/kie-wb-common/commit/5f61a4fb051ddd2ceefe352e543af453e91bfed3", "message": "no need to return default icon", "committedDate": "2020-02-27T21:13:46Z", "type": "commit"}, {"oid": "625db827010ffc7e36dc96f71cb8c49b9d99b0f4", "url": "https://github.com/kiegroup/kie-wb-common/commit/625db827010ffc7e36dc96f71cb8c49b9d99b0f4", "message": "Improvements and adding tests", "committedDate": "2020-02-28T16:53:33Z", "type": "commit"}]}