{"pr_number": 800, "pr_title": "Add farzone support", "pr_createdAt": "2020-03-04T23:15:25Z", "pr_url": "https://github.com/Netflix/titus-control-plane/pull/800", "merge_commit": "834a1de559c106a43d5128396657f2d7d690bf5e", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMjE3OA==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388422178", "body": "The first ipv4 ip address should be used as the host ip like in:\r\nhttps://github.com/Netflix/titus-control-plane/blob/master/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java#L453", "bodyText": "The first ipv4 ip address should be used as the host ip like in:\nhttps://github.com/Netflix/titus-control-plane/blob/master/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java#L453", "bodyHTML": "<p dir=\"auto\">The first ipv4 ip address should be used as the host ip like in:<br>\n<a href=\"https://github.com/Netflix/titus-control-plane/blob/master/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java#L453\">https://github.com/Netflix/titus-control-plane/blob/master/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeApiServerIntegrator.java#L453</a></p>", "author": "corindwyer", "createdAt": "2020-03-05T16:47:58Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java", "diffHunk": "@@ -264,6 +266,16 @@ private Task attachNodeMetadata(Task task, V1Node node) {\n \n         acceptNotNull(node.getMetadata().getName(), nodeName -> agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_KUBE_NODE_NAME, nodeName));\n \n+        List<V1NodeAddress> addresses = node.getStatus().getAddresses();", "originalCommit": "364c6a14e43e5ee4064a76c64a96ad3a624c873b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyNDUyNQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388424525", "bodyText": "@corindwyer I have seen your recent PR. We should share your address filter in both places. Once you merge, I will rebase and create a function in KubeUtil.", "author": "tbak", "createdAt": "2020-03-05T16:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMjE3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyNzI5Mg==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388427292", "bodyText": "Sounds good. I already merged.", "author": "corindwyer", "createdAt": "2020-03-05T16:55:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQyMjE3OA=="}], "type": "inlineReview", "revised_code": {"commit": "9f905c8121ea84179c18abaa794810077dbbee6d", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java b/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\nindex 373de600d..340ae1bba 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\n", "chunk": "@@ -266,16 +264,6 @@ public class KubeNotificationProcessor {\n \n         acceptNotNull(node.getMetadata().getName(), nodeName -> agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_KUBE_NODE_NAME, nodeName));\n \n-        List<V1NodeAddress> addresses = node.getStatus().getAddresses();\n-        if (!CollectionsExt.isNullOrEmpty(addresses)) {\n-            addresses.forEach(address -> {\n-                if (StringExt.isNotEmpty(address.getAddress()) && \"InternalIP\".equals(address.getType())) {\n-                    agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST, address.getAddress());\n-                    agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST_IP, address.getAddress());\n-                }\n-            });\n-        }\n-\n         if (agentAttributes.isEmpty()) {\n             return task;\n         }\n", "next_change": {"commit": "372302aaacc312652a402b6b28e0739d7013cb76", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java b/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\nindex 340ae1bba..373de600d 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\n", "chunk": "@@ -264,6 +266,16 @@ public class KubeNotificationProcessor {\n \n         acceptNotNull(node.getMetadata().getName(), nodeName -> agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_KUBE_NODE_NAME, nodeName));\n \n+        List<V1NodeAddress> addresses = node.getStatus().getAddresses();\n+        if (!CollectionsExt.isNullOrEmpty(addresses)) {\n+            addresses.forEach(address -> {\n+                if (StringExt.isNotEmpty(address.getAddress()) && \"InternalIP\".equals(address.getType())) {\n+                    agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST, address.getAddress());\n+                    agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST_IP, address.getAddress());\n+                }\n+            });\n+        }\n+\n         if (agentAttributes.isEmpty()) {\n             return task;\n         }\n", "next_change": {"commit": "56dbe6d10d178829b6fb132efd470def8ee963b7", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java b/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\nindex 373de600d..a8716f0e4 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/KubeNotificationProcessor.java\n", "chunk": "@@ -266,19 +264,9 @@ public class KubeNotificationProcessor {\n \n         acceptNotNull(node.getMetadata().getName(), nodeName -> agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_KUBE_NODE_NAME, nodeName));\n \n-        List<V1NodeAddress> addresses = node.getStatus().getAddresses();\n-        if (!CollectionsExt.isNullOrEmpty(addresses)) {\n-            addresses.forEach(address -> {\n-                if (StringExt.isNotEmpty(address.getAddress()) && \"InternalIP\".equals(address.getType())) {\n-                    agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST, address.getAddress());\n-                    agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST_IP, address.getAddress());\n-                }\n-            });\n-        }\n-\n-        if (agentAttributes.isEmpty()) {\n-            return task;\n-        }\n+        String nodeIpAddress = KubeUtil.getNodeIpV4Address(node);\n+        agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST, nodeIpAddress);\n+        agentAttributes.put(TaskAttributes.TASK_ATTRIBUTES_AGENT_HOST_IP, nodeIpAddress);\n \n         return task.toBuilder()\n                 .withTaskContext(CollectionsExt.merge(task.getTaskContext(), agentAttributes))\n", "next_change": null}]}}]}}]}}, {"oid": "9f905c8121ea84179c18abaa794810077dbbee6d", "url": "https://github.com/Netflix/titus-control-plane/commit/9f905c8121ea84179c18abaa794810077dbbee6d", "message": "Add farzone support", "committedDate": "2020-03-05T16:52:31Z", "type": "commit"}, {"oid": "372302aaacc312652a402b6b28e0739d7013cb76", "url": "https://github.com/Netflix/titus-control-plane/commit/372302aaacc312652a402b6b28e0739d7013cb76", "message": "Add agent host attributes", "committedDate": "2020-03-05T16:52:31Z", "type": "commit"}, {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7", "url": "https://github.com/Netflix/titus-control-plane/commit/56dbe6d10d178829b6fb132efd470def8ee963b7", "message": "Reuse node IP extractor from KubeApiServerIntegrator", "committedDate": "2020-03-05T17:16:57Z", "type": "commit"}, {"oid": "56dbe6d10d178829b6fb132efd470def8ee963b7", "url": "https://github.com/Netflix/titus-control-plane/commit/56dbe6d10d178829b6fb132efd470def8ee963b7", "message": "Reuse node IP extractor from KubeApiServerIntegrator", "committedDate": "2020-03-05T17:16:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0NjIzMA==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388446230", "body": "this looks incorrectly indented", "bodyText": "this looks incorrectly indented", "bodyHTML": "<p dir=\"auto\">this looks incorrectly indented</p>", "author": "corindwyer", "createdAt": "2020-03-05T17:26:12Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -191,4 +197,12 @@ public static boolean isOwnedByKubeScheduler(V1Pod v1Pod) {\n         }\n         return false;\n     }\n+\n+    public static String getNodeIpV4Address(V1Node node) {\n+        return   node.getStatus().getAddresses().stream()", "originalCommit": "56dbe6d10d178829b6fb132efd470def8ee963b7", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null, "revised_code_in_main": {"commit": "502b0d8150cc56388d4ac4a35fc5ca544232967c", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\nindex 3b6b415a3..637ae12fd 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n", "chunk": "@@ -199,7 +203,7 @@ public class KubeUtil {\n     }\n \n     public static String getNodeIpV4Address(V1Node node) {\n-        return   node.getStatus().getAddresses().stream()\n+        return node.getStatus().getAddresses().stream()\n                 .filter(a -> a.getType().equalsIgnoreCase(INTERNAL_IP) && NetworkExt.isIpV4(a.getAddress()))\n                 .findFirst()\n                 .map(V1NodeAddress::getAddress)\n", "next_change": {"commit": "79a89b74589fc6e6da9e07face1ab4b1fd63907a", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\nindex 637ae12fd..01b0c490c 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n", "chunk": "@@ -209,4 +213,24 @@ public class KubeUtil {\n                 .map(V1NodeAddress::getAddress)\n                 .orElse(\"UnknownIpAddress\");\n     }\n+\n+    public static Map<String, String> createPodAnnotations(\n+            Job<?> job,\n+            byte[] containerInfoData,\n+            Map<String, String> passthroughAttributes,\n+            boolean includeJobDescriptor\n+    ) {\n+        String encodedContainerInfo = Base64.getEncoder().encodeToString(containerInfoData);\n+\n+        Map<String, String> annotations = new HashMap<>(passthroughAttributes);\n+        annotations.putAll(PerformanceToolUtil.toAnnotations(job));\n+        annotations.put(\"containerInfo\", encodedContainerInfo);\n+\n+        if (includeJobDescriptor) {\n+            String jobDescriptorJson = CommonObjectMappers.writeValueAsString(ObjectMappers.storeMapper(), job.getJobDescriptor());\n+            annotations.put(\"jobDescriptor\", StringExt.gzipAndBase64Encode(jobDescriptorJson));\n+        }\n+\n+        return annotations;\n+    }\n }\n", "next_change": {"commit": "d35286955302d65c637815c6d6b6707831fffa93", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\nindex 01b0c490c..5f580fae5 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n", "chunk": "@@ -233,4 +240,76 @@ public class KubeUtil {\n \n         return annotations;\n     }\n+\n+    /**\n+     * A node is owned by Fenzo if:\n+     * <ul>\n+     *     <li>There is no taint with {@link KubeConstants#TAINT_SCHEDULER} key and it is not a farzone node</li>\n+     *     <li>There is one taint with {@link KubeConstants#TAINT_SCHEDULER} key and 'fenzo' value</li>\n+     * </ul>\n+     */\n+    public static boolean isNodeOwnedByFenzo(List<String> farzones, Set<String> toleratedTaints, V1Node node) {\n+        if (isFarzoneNode(farzones, node)) {\n+            logger.debug(\"Not owned by fenzo (farzone node): {}\", node.getMetadata().getName());\n+            return false;\n+        }\n+        if (!hasFenzoSchedulerTaint(node)) {\n+            logger.debug(\"Not owned by fenzo (non Fenzo scheduler taint): {}\", node.getMetadata().getName());\n+            return false;\n+        }\n+\n+        List<V1Taint> taints = node.getSpec().getTaints();\n+        if (CollectionsExt.isNullOrEmpty(taints)) {\n+            logger.debug(\"Owned by fenzo (no taint set): {}\", node.getMetadata().getName());\n+            return true;\n+        }\n+\n+        for (V1Taint taint : taints) {\n+            String taintKey = taint.getKey();\n+            if (!taintKey.equals(KubeConstants.TAINT_SCHEDULER) && !toleratedTaints.contains(taintKey)) {\n+                logger.debug(\"Not owned by fenzo (non tolerable taint found): nodeId={}, taintKey={}\", node.getMetadata().getName(), taintKey);\n+                return false;\n+            }\n+        }\n+\n+        logger.debug(\"Owned by fenzo (all taints tolerated): {}\", node.getMetadata().getName());\n+        return true;\n+    }\n+\n+    /**\n+     * Returns true if there is {@link KubeConstants#TAINT_SCHEDULER} taint with {@link KubeConstants#TAINT_SCHEDULER_VALUE_FENZO} value\n+     * or this taint is missing (no explicit scheduler taint == Fenzo).\n+     */\n+    public static boolean hasFenzoSchedulerTaint(V1Node node) {\n+        List<V1Taint> taints = node.getSpec().getTaints();\n+        if (CollectionsExt.isNullOrEmpty(taints)) {\n+            return true;\n+        }\n+        Set<String> schedulerTaintValues = taints.stream()\n+                .filter(t -> KubeConstants.TAINT_SCHEDULER.equals(t.getKey()))\n+                .map(t -> StringExt.safeTrim(t.getValue()))\n+                .collect(Collectors.toSet());\n+\n+        if (schedulerTaintValues.isEmpty()) {\n+            return true;\n+        }\n+\n+        return schedulerTaintValues.size() == 1 && KubeConstants.TAINT_SCHEDULER_VALUE_FENZO.equalsIgnoreCase(CollectionsExt.first(schedulerTaintValues));\n+    }\n+\n+    public static boolean isFarzoneNode(List<String> farzones, V1Node node) {\n+        String nodeZone = node.getMetadata().getLabels().get(KubeConstants.NODE_LABEL_ZONE);\n+        if (StringExt.isEmpty(nodeZone)) {\n+            logger.debug(\"Node without zone label: {}\", node.getMetadata().getName());\n+            return false;\n+        }\n+        for (String farzone : farzones) {\n+            if (farzone.equalsIgnoreCase(nodeZone)) {\n+                logger.debug(\"Farzone node: nodeId={}, zoneId={}\", node.getMetadata().getName(), nodeZone);\n+                return true;\n+            }\n+        }\n+        logger.debug(\"Non-farzone node: nodeId={}, zoneId={}\", node.getMetadata().getName(), nodeZone);\n+        return false;\n+    }\n }\n", "next_change": {"commit": "af8ce7106d0a9adb6c7c087f29e65b422de8facb", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\nindex 5f580fae5..13afd21d5 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n", "chunk": "@@ -312,4 +295,17 @@ public class KubeUtil {\n         logger.debug(\"Non-farzone node: nodeId={}, zoneId={}\", node.getMetadata().getName(), nodeZone);\n         return false;\n     }\n+\n+    public static String toErrorDetails(Exception e) {\n+        if (!(e instanceof ApiException)) {\n+            return ExceptionExt.toMessageChain(e);\n+        }\n+\n+        ApiException apiException = (ApiException) e;\n+        return String.format(\"{message=%s, httpCode=%d, responseBody=%s\",\n+                Evaluators.getOrDefault(apiException.getMessage(), \"<not set>\"),\n+                apiException.getCode(),\n+                Evaluators.getOrDefault(apiException.getResponseBody(), \"<not set>\")\n+        );\n+    }\n }\n", "next_change": {"commit": "ac3944c628902ab80bccbd058b2bb0999f15a99c", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\nindex 13afd21d5..88dc1551f 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n", "chunk": "@@ -308,4 +326,40 @@ public class KubeUtil {\n                 Evaluators.getOrDefault(apiException.getResponseBody(), \"<not set>\")\n         );\n     }\n+\n+    public static <T> Mono<T> toReact(KubeFunction<ApiCallback<T>, Call> handler) {\n+        return Mono.create(sink -> {\n+            Call call;\n+            try {\n+                call = handler.apply(new ApiCallback<T>() {\n+                    @Override\n+                    public void onFailure(ApiException e, int statusCode, Map<String, List<String>> responseHeaders) {\n+                        sink.error(e);\n+                    }\n+\n+                    @Override\n+                    public void onSuccess(T result, int statusCode, Map<String, List<String>> responseHeaders) {\n+                        if (result == null) {\n+                            sink.success();\n+                        } else {\n+                            sink.success(result);\n+                        }\n+                    }\n+\n+                    @Override\n+                    public void onUploadProgress(long bytesWritten, long contentLength, boolean done) {\n+                    }\n+\n+                    @Override\n+                    public void onDownloadProgress(long bytesRead, long contentLength, boolean done) {\n+                    }\n+                });\n+            } catch (ApiException e) {\n+                sink.error(e);\n+                return;\n+            }\n+\n+            sink.onCancel(call::cancel);\n+        });\n+    }\n }\n", "next_change": {"commit": "e579040bb21f013e86aa5ce87f8e41f03ea7778d", "changed_code": [{"header": "diff --git a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\nindex 88dc1551f..f27904671 100644\n--- a/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n+++ b/titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java\n", "chunk": "@@ -362,4 +365,12 @@ public class KubeUtil {\n             sink.onCancel(call::cancel);\n         });\n     }\n+\n+    public static boolean hasUninitializedTaint(V1Node node) {\n+        if (node.getSpec() != null && node.getSpec().getTaints() != null) {\n+            return node.getSpec().getTaints().stream()\n+                    .anyMatch(t -> KubeConstants.TAINT_NODE_UNINITIALIZED.equals(t.getKey()));\n+        }\n+        return false;\n+    }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "834a1de559c106a43d5128396657f2d7d690bf5e", "message": "Merge commit", "committedDate": null}, {"oid": "502b0d8150cc56388d4ac4a35fc5ca544232967c", "committedDate": "2020-03-05 20:18:10 -0800", "message": "Upgrade to kube-java-client 7.x (#797)"}, {"oid": "79a89b74589fc6e6da9e07face1ab4b1fd63907a", "committedDate": "2020-03-12 12:00:55 -0700", "message": "add job descriptor annotation (#804)"}, {"oid": "d35286955302d65c637815c6d6b6707831fffa93", "committedDate": "2020-03-20 14:13:25 -0700", "message": "Add configurable Fenzo taints (#817)"}, {"oid": "73a3963c1c21d75a10fa6b1eadae8a897fac550c", "committedDate": "2020-03-25 08:44:04 -0700", "message": "change jobDescriptor annotation payload to use the json API representation (#821)"}, {"oid": "5ec20ab8600dd6f8b466dcaa045203815f7c816f", "committedDate": "2020-04-24 13:30:32 -0700", "message": "handle Pod opportunistic annotations (#841)"}, {"oid": "67cacd3c6958d4a5192624dcf023a23b49afee88", "committedDate": "2020-05-11 09:05:20 -0700", "message": "Add a Kube backend constraint (#844)"}, {"oid": "5abbf67fd2c7543dcae9e13faed02d072a86a63b", "committedDate": "2020-05-26 10:52:41 -0700", "message": "Feature/kube informer sync (#850)"}, {"oid": "7f69c40b55bfc4205048ae1841650324ec3b3151", "committedDate": "2020-05-27 10:27:11 -0700", "message": "Add pod size metric + minor code cleanup (#851)"}, {"oid": "a02f248582c9fa650d92aa6ca141e6db48588042", "committedDate": "2020-06-02 14:52:38 -0700", "message": "Add configurable finished pod GC delay (#855)"}, {"oid": "43575f1e7375eafe5be9a0ebffac321a36ef20d1", "committedDate": "2020-06-04 10:48:35 -0700", "message": "add scheduling constraint for kube nodes (#858)"}, {"oid": "af8ce7106d0a9adb6c7c087f29e65b422de8facb", "committedDate": "2020-06-08 17:05:08 -0700", "message": "Better error reporting for Kube API exceptions (#865)"}, {"oid": "756a04c6ab435aaf2f6a771534b9561e62c010a9", "committedDate": "2020-06-12 10:36:42 -0700", "message": "Misc null validations (#871)"}, {"oid": "073f41752fb92b729f413041d753cdc306acec52", "committedDate": "2020-06-16 12:51:34 -0700", "message": "Check if all required node attributes are present (#873)"}, {"oid": "ac3944c628902ab80bccbd058b2bb0999f15a99c", "committedDate": "2020-06-25 16:03:30 -0700", "message": "Use KubeClient async API to launch pods (#878)"}, {"oid": "e579040bb21f013e86aa5ce87f8e41f03ea7778d", "committedDate": "2020-08-21 10:30:08 -0700", "message": "fenzo should ignore nodes marked with uninitialized taint (#900)"}, {"oid": "85037bbf98a3b5b5b055d43021e94cc9410aae52", "committedDate": "2020-08-25 14:41:31 -0700", "message": "KubeScheduler & task relocation support (#902)"}, {"oid": "423620274575ed4e1371a378b5c07523fbdb3739", "committedDate": "2020-08-28 15:53:11 -0700", "message": "Make the KubeNotificationProcessor understand pod ips from kubelet (#903)"}, {"oid": "31e69550eb6ee029508a45d484ef710a483f54c5", "committedDate": "2020-10-05 12:07:18 -0700", "message": "extract gc controller logic from KubeApiServerIntegrator into GC controllers (#889)"}, {"oid": "d61da0909ecc2e1dc0252d4b87c56b41e8a7e716", "committedDate": "2020-10-06 13:30:25 -0700", "message": "Add account id and subnets job parameters to pod annotations (#932)"}, {"oid": "1d75da8ccd2a187e76207ff707515a9615370fbe", "committedDate": "2020-11-18 10:26:26 -0800", "message": "Hard/soft constraint names are case sensitive (#956)"}, {"oid": "ca4344f029bc598c95ca513c51706383e64f6b88", "committedDate": "2020-11-20 07:01:26 -0800", "message": "Initial persistent volume GC functionality (#957)"}, {"oid": "bc8747660eb6c1e72031d69ffd30d375eacb9de4", "committedDate": "2020-12-02 11:30:47 -0800", "message": "Align KubeScheduler pod -> task state mapping with KubeApiServerIntegrator (#961)"}, {"oid": "29c1834e42999d9cc23460f5657e8b706174b8cc", "committedDate": "2021-02-09 11:45:29 -0800", "message": "Add capacity group annotation to a pod (#982)"}, {"oid": "fa9c3834e8f74d86f56ed6195e1822452a771cb0", "committedDate": "2021-02-10 09:32:14 -0800", "message": "Set pod capacity group in labels not annotations (#984)"}, {"oid": "08831e6b3221bdaf0ed6054e32789d991314416e", "committedDate": "2021-02-24 14:45:49 -0800", "message": "extract pod object building to a single interface (#988)"}, {"oid": "cda113f0a15a490f358063926f10e187018a893a", "committedDate": "2021-08-12 14:18:53 -0400", "message": "K8s 1.20 client upgrade (#1082)"}, {"oid": "a35bb67dd4cc522aee4fc7129416cd77168dd934", "committedDate": "2021-08-16 12:29:40 -0700", "message": "Hide Kube Java lib invocations behind internal API (#1080)"}, {"oid": "acf50da80a5dd23986b9ebba2a407e7dc5b8b020", "committedDate": "2021-08-18 15:46:51 -0700", "message": "Only set the ipv4 container attribute if we have one (#1086)"}, {"oid": "534dceae673eae35fb7553387787b7529259f67b", "committedDate": "2021-10-13 09:16:12 -0700", "message": "Remove all the remaining dependencies on fenzo and mesos (#1132)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MTkyOA==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388491928", "body": "why not centralize this check into the `kubeSchedulerPredicate`?", "bodyText": "why not centralize this check into the kubeSchedulerPredicate?", "bodyHTML": "<p dir=\"auto\">why not centralize this check into the <code>kubeSchedulerPredicate</code>?</p>", "author": "fabiokung", "createdAt": "2020-03-05T18:51:16Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/batch/BatchDifferenceResolver.java", "diffHunk": "@@ -238,7 +244,7 @@ public BatchDifferenceResolver(\n         }\n \n         Map<String, String> taskContext = getTaskContext(previousTask, unassignedIpAllocations);\n-        if (kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {\n+        if (KubeUtil.findFarzoneId(kubeConfiguration, refJobView.getJob()).isPresent() || kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {", "originalCommit": "56dbe6d10d178829b6fb132efd470def8ee963b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NzkyMA==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388497920", "bodyText": "I have tried that, but the code is in a different subproject.", "author": "tbak", "createdAt": "2020-03-05T19:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MTkyOA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MjIyMA==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388492220", "body": "same as above, centralize this into the predicate", "bodyText": "same as above, centralize this into the predicate", "bodyHTML": "<p dir=\"auto\">same as above, centralize this into the predicate</p>", "author": "fabiokung", "createdAt": "2020-03-05T18:51:45Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/jobmanager/service/service/ServiceDifferenceResolver.java", "diffHunk": "@@ -261,7 +267,7 @@ public ServiceDifferenceResolver(\n         }\n \n         Map<String, String> taskContext = getTaskContext(previousTask, unassignedIpAllocations);\n-        if (kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {\n+        if (KubeUtil.findFarzoneId(kubeConfiguration, refJobView.getJob()).isPresent() || kubeSchedulerPredicate.test(refJobView.getJob().getJobDescriptor())) {", "originalCommit": "56dbe6d10d178829b6fb132efd470def8ee963b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5ODI0MA==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388498240", "bodyText": "I have tried that, but the code is in a different subproject.", "author": "tbak", "createdAt": "2020-03-05T19:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MjIyMA=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NDI2MQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388494261", "body": "could this be generalized to any availabilityZones? Does it matter that it is a farzone? I'd recommend naming this `isAvailabilityZoneOwnedByKubeScheduler()` and `configuration.getAvailabilityZonesOwnedByKubeScheduler()`, or similar.\r\n\r\nIOW, can we abstract away that some AZs are farzones?", "bodyText": "could this be generalized to any availabilityZones? Does it matter that it is a farzone? I'd recommend naming this isAvailabilityZoneOwnedByKubeScheduler() and configuration.getAvailabilityZonesOwnedByKubeScheduler(), or similar.\nIOW, can we abstract away that some AZs are farzones?", "bodyHTML": "<p dir=\"auto\">could this be generalized to any availabilityZones? Does it matter that it is a farzone? I'd recommend naming this <code>isAvailabilityZoneOwnedByKubeScheduler()</code> and <code>configuration.getAvailabilityZonesOwnedByKubeScheduler()</code>, or similar.</p>\n<p dir=\"auto\">IOW, can we abstract away that some AZs are farzones?</p>", "author": "fabiokung", "createdAt": "2020-03-05T18:55:22Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/KubeUtil.java", "diffHunk": "@@ -148,4 +161,48 @@ public static String formatV1ContainerState(V1ContainerState containerState) {\n \n         return \"{state=<not set>}\";\n     }\n+\n+    /**\n+     * If a job has an availability zone hard constraint with a farzone id, return this farzone id.\n+     */\n+    public static Optional<String> findFarzoneId(DirectKubeConfiguration configuration, Job job) {\n+        List<String> farzones = configuration.getFarzones();", "originalCommit": "56dbe6d10d178829b6fb132efd470def8ee963b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5OTYzNQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388499635", "bodyText": "It is more than an additional zone. Farzones are excluded from the default scheduling, and there is extra logic around that. I would prefer to keep it explicit.", "author": "tbak", "createdAt": "2020-03-05T19:04:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NDI2MQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NTEwNQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388495105", "body": "same, generalize to any AZs, farzone or not", "bodyText": "same, generalize to any AZs, farzone or not", "bodyHTML": "<p dir=\"auto\">same, generalize to any AZs, farzone or not</p>", "author": "fabiokung", "createdAt": "2020-03-05T18:56:44Z", "path": "titus-server-master/src/main/java/com/netflix/titus/master/mesos/kubeapiserver/direct/DefaultPodAffinityFactory.java", "diffHunk": "@@ -181,6 +186,12 @@ private void addNodeAffinityPreferredSelectorConstraint(String key, String value\n             term.addMatchExpressionsItem(requirement);\n         }\n \n+        private void processFarzoneConstraints() {", "originalCommit": "56dbe6d10d178829b6fb132efd470def8ee963b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5OTc5OQ==", "url": "https://github.com/Netflix/titus-control-plane/pull/800#discussion_r388499799", "bodyText": "See my comment above ^^^.", "author": "tbak", "createdAt": "2020-03-05T19:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5NTEwNQ=="}], "type": "inlineReview", "revised_code": null}]}