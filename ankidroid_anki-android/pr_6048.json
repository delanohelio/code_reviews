{"pr_number": 6048, "pr_title": "beforeUpload: save only if some change occured", "pr_author": "Arthur-Milchior", "pr_createdAt": "2020-04-18T16:49:30Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6048", "timeline": [{"oid": "b9cffb6595f77972d749eb0a2443f81454813ec8", "url": "https://github.com/ankidroid/Anki-Android/commit/b9cffb6595f77972d749eb0a2443f81454813ec8", "message": "Array of JSONObject: save only if modified in beforeUpload", "committedDate": "2020-06-04T18:58:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzgyNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435493827", "body": "For reference: You could use a single `|` here which will evaluate both sides, but I'm happy with the comment. Feel free to mark as resolved with no action.", "bodyText": "For reference: You could use a single | here which will evaluate both sides, but I'm happy with the comment. Feel free to mark as resolved with no action.", "bodyHTML": "<p dir=\"auto\">For reference: You could use a single <code>|</code> here which will evaluate both sides, but I'm happy with the comment. Feel free to mark as resolved with no action.</p>", "author": "david-allison-1", "createdAt": "2020-06-04T19:17:34Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -979,13 +979,14 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n \n \n     public void beforeUpload() {\n-        for (JSONObject d : all()) {\n-            d.put(\"usn\", 0);\n+        boolean changed_decks = Utils.shouldSave(all());\n+        boolean changed_conf = Utils.shouldSave(allConf());\n+        if (changed_decks || changed_conf) {", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUwNjg0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435506849", "bodyText": "Since you are mentioning readability, I do believe the current version to be more clear than using a bitwise or on booleans. I do admit that you're right and that I've not thought of it, so thank you for the feedback.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:43:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzgyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNDkyMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435514921", "bodyText": "No worries - glad I helped. Marking as \"no action needed\"", "author": "david-allison-1", "createdAt": "2020-06-04T19:58:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5MzkzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435493935", "body": "```suggestion\r\n            // shouldSave should always be called on both lists, for\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // shouldSave should always be called on both list, for\n          \n          \n            \n                        // shouldSave should always be called on both lists, for", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> shouldSave should always be called on both <span class=\"x x-first x-last\">list</span>, for</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> shouldSave should always be called on both <span class=\"x x-first x-last\">lists</span>, for</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "david-allison-1", "createdAt": "2020-06-04T19:17:46Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -979,13 +979,14 @@ private void gather(HashMap<Long, HashMap> node, List<Long> arr) {\n \n \n     public void beforeUpload() {\n-        for (JSONObject d : all()) {\n-            d.put(\"usn\", 0);\n+        boolean changed_decks = Utils.shouldSave(all());\n+        boolean changed_conf = Utils.shouldSave(allConf());\n+        if (changed_decks || changed_conf) {\n+            // shouldSave should always be called on both list, for", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435494983", "body": "nit: I think you can iterate `mTags` here, rather than the `keySet`. \r\n\r\nYou might want to extract this to a `shouldSave` in `Utils` with a different parameter type for readability", "bodyText": "nit: I think you can iterate mTags here, rather than the keySet.\nYou might want to extract this to a shouldSave in Utils with a different parameter type for readability", "bodyHTML": "<p dir=\"auto\">nit: I think you can iterate <code>mTags</code> here, rather than the <code>keySet</code>.</p>\n<p dir=\"auto\">You might want to extract this to a <code>shouldSave</code> in <code>Utils</code> with a different parameter type for readability</p>", "author": "david-allison-1", "createdAt": "2020-06-04T19:19:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Tags.java", "diffHunk": "@@ -372,10 +372,16 @@ public boolean inList(String tag, Iterable<String> tags) {\n      */\n \n     public void beforeUpload() {\n+        boolean changed = false;\n         for (String k : mTags.keySet()) {", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMzk0NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435513944", "bodyText": "I'll do another PR if you want. I was not touching this line and would prefer the PR to remain smalls and to reduce the risk they are not NF", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNjU0OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435516549", "bodyText": "Nope, it's a TreeMap and they are not iterable.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T20:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNzgzOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435517839", "bodyText": "Doesn't .entrySet() or .values() work? That sucks. No need for another PR", "author": "david-allison-1", "createdAt": "2020-06-04T20:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NDk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435495626", "body": "> if the connection break at this exact moment, the collection will be inconsistent.\r\n\r\nIs this handled in the code right now, or do we need an issue to fix this?", "bodyText": "if the connection break at this exact moment, the collection will be inconsistent.\n\nIs this handled in the code right now, or do we need an issue to fix this?", "bodyHTML": "<blockquote>\n<p dir=\"auto\">if the connection break at this exact moment, the collection will be inconsistent.</p>\n</blockquote>\n<p dir=\"auto\">Is this handled in the code right now, or do we need an issue to fix this?</p>", "author": "david-allison-1", "createdAt": "2020-06-04T19:21:07Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -1017,4 +1017,29 @@ public static float randomFloatInRange(float min, float max) {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n+\n+    /**\n+       Set usn to 0 in every object.\n+\n+       Usn zero means that the object is already online. Non-zero usn\n+       means that the object is different than online or is not online.\n+\n+       This method is called during sync, before uploading, so during\n+       an instant, the value will be zero while the object is not\n+       actually online; if the connection break at this exact moment,\n+       the collection will be inconsistent.", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMjQ3Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435512472", "bodyText": "This is not handled in the code, as the code is the same as in upstream. It was not handled in upstream either. I do not know whether rust takes care of it or not, rust is too hard for me to read.\nI assume you could take a full copy of the arrays as they are before uploading them, and if the sync fails, restore the copy. However, maybe the upload suceeded and we just never received the confirmation, so the arrays are correct and reverting to previous version would actually be the bug.\nI've no clue whether it ever was a problem for anyone (statistically, I assume it has been), but I've no reason to believe that it was actually an important problem", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:54:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMjg1NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435512855", "bodyText": "I should note in any case that the problem is exactly the same in current master and in this PR. The comment is new but it is about an already existing theoretical problem.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNTMwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435515309", "bodyText": "Agreed - could you add an issue for someone later to investigate this? I'll do it - #6361", "author": "david-allison-1", "createdAt": "2020-06-04T19:59:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzA1OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435497058", "body": "Nit: needs a name change. `should` implies it doesn't make changed.\r\n\r\nMaybe `markAsRequiringSync` ", "bodyText": "Nit: needs a name change. should implies it doesn't make changed.\nMaybe markAsRequiringSync", "bodyHTML": "<p dir=\"auto\">Nit: needs a name change. <code>should</code> implies it doesn't make changed.</p>\n<p dir=\"auto\">Maybe <code>markAsRequiringSync</code></p>", "author": "david-allison-1", "createdAt": "2020-06-04T19:23:50Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Utils.java", "diffHunk": "@@ -1017,4 +1017,29 @@ public static float randomFloatInRange(float min, float max) {\n         Random rand = new Random();\n         return rand.nextFloat() * (max - min) + min;\n     }\n+\n+    /**\n+       Set usn to 0 in every object.\n+\n+       Usn zero means that the object is already online. Non-zero usn\n+       means that the object is different than online or is not online.\n+\n+       This method is called during sync, before uploading, so during\n+       an instant, the value will be zero while the object is not\n+       actually online; if the connection break at this exact moment,\n+       the collection will be inconsistent.\n+\n+       @return whether there was a non-zero usn; in this case the list\n+       should be saved before the upload.\n+     */\n+    public static boolean shouldSave(ArrayList<JSONObject> ar) {", "originalCommit": "b9cffb6595f77972d749eb0a2443f81454813ec8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxMzQ5NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435513495", "bodyText": "Indeed, the \"save\" action is done by the caller. This method change the USN number. Actually, it is the reason why the save occurs, to save the new usn number (0) in the database.", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:56:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNTA4Mg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6048#discussion_r435515082", "bodyText": "I used another name, but changed it to a more descriptive name", "author": "Arthur-Milchior", "createdAt": "2020-06-04T19:59:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ5NzA1OA=="}], "type": "inlineReview"}, {"oid": "54888591abadd36e100f0f6f9f8bcde28d03db4f", "url": "https://github.com/ankidroid/Anki-Android/commit/54888591abadd36e100f0f6f9f8bcde28d03db4f", "message": "Tags: save only if modified in beforeUpload", "committedDate": "2020-06-04T19:43:42Z", "type": "commit"}, {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "url": "https://github.com/ankidroid/Anki-Android/commit/4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "message": "Array of JSONObject: save only if modified in beforeUpload", "committedDate": "2020-06-04T19:58:42Z", "type": "commit"}, {"oid": "4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "url": "https://github.com/ankidroid/Anki-Android/commit/4276b2cdd045c68dc1cb4e59a532efe6fbf997e3", "message": "Array of JSONObject: save only if modified in beforeUpload", "committedDate": "2020-06-04T19:58:42Z", "type": "forcePushed"}]}