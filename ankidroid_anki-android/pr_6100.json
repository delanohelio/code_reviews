{"pr_number": 6100, "pr_title": "Don't crash Check Database when Database is locked", "pr_author": "david-allison-1", "pr_createdAt": "2020-05-03T15:05:29Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6100", "timeline": [{"oid": "57e5e9ca25a2a53f96d42c591ff6a5ac13ad6e39", "url": "https://github.com/ankidroid/Anki-Android/commit/57e5e9ca25a2a53f96d42c591ff6a5ac13ad6e39", "message": "Add DEBUG: Lock Database", "committedDate": "2020-05-03T10:36:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjExMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419126113", "body": "this stuff is touchy, this is not something to fix here / it is not actionable - just as knowledge sharing I have an advanceRobolectricLooper method I use in #5151 and it's basically setting Looper mode to PAUSED in robolectric, then after you do something that twiddles state but before (and after) you twiddle UI you ask robolectric to advance the execution loop, and then I sleep for a moment (since we do async things). Not ideal but that's how to turn the crank as it were in robolectric if you want to play with UI stuff\r\n\r\nnot actionable here because visibility isn't important but maybe useful info going forward", "bodyText": "this stuff is touchy, this is not something to fix here / it is not actionable - just as knowledge sharing I have an advanceRobolectricLooper method I use in #5151 and it's basically setting Looper mode to PAUSED in robolectric, then after you do something that twiddles state but before (and after) you twiddle UI you ask robolectric to advance the execution loop, and then I sleep for a moment (since we do async things). Not ideal but that's how to turn the crank as it were in robolectric if you want to play with UI stuff\nnot actionable here because visibility isn't important but maybe useful info going forward", "bodyHTML": "<p dir=\"auto\">this stuff is touchy, this is not something to fix here / it is not actionable - just as knowledge sharing I have an advanceRobolectricLooper method I use in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"388041663\" data-permission-text=\"Title is private\" data-url=\"https://github.com/ankidroid/Anki-Android/issues/5151\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/ankidroid/Anki-Android/pull/5151/hovercard\" href=\"https://github.com/ankidroid/Anki-Android/pull/5151\">#5151</a> and it's basically setting Looper mode to PAUSED in robolectric, then after you do something that twiddles state but before (and after) you twiddle UI you ask robolectric to advance the execution loop, and then I sleep for a moment (since we do async things). Not ideal but that's how to turn the crank as it were in robolectric if you want to play with UI stuff</p>\n<p dir=\"auto\">not actionable here because visibility isn't important but maybe useful info going forward</p>", "author": "mikehardy", "createdAt": "2020-05-03T16:23:26Z", "path": "AnkiDroid/src/test/java/com/ichi2/anki/DeckPickerCheckDatabaseListenerTest.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki;\n+\n+import android.content.Intent;\n+\n+import com.ichi2.anki.dialogs.DatabaseErrorDialog;\n+import com.ichi2.async.CollectionTask.TaskData;\n+import com.ichi2.libanki.Collection.CheckDatabaseResult;\n+\n+import org.junit.Ignore;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.Robolectric;\n+import org.robolectric.android.controller.ActivityController;\n+\n+import androidx.annotation.NonNull;\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+\n+@RunWith(AndroidJUnit4.class)\n+public class DeckPickerCheckDatabaseListenerTest extends RobolectricTest {\n+\n+    private DeckPickerTestImpl impl;\n+\n+    @Override\n+    public void setUp() {\n+        super.setUp();\n+        //.visible() crashes: Layout state should be one of 100 but it is 10", "originalCommit": "e1622d5b07c0a6627066e7488a2947047d6909d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMDE1MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419130150", "bodyText": "I thought I'd replied here, visible works for CardBroser/Viewer. Would you like me to remove the line?\nP.S: Thanks for the info, for now I try to avoid UI testing as it doesn't add much value if the business logic is well structured, and ties us in to an implementation, sometimes before we've really considered whether it was the right move (especially true given the complexity of DeckPicker).", "author": "david-allison-1", "createdAt": "2020-05-03T16:56:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzNDc1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419134754", "bodyText": "Nope - no change needed here - was just knowledge sharing. Agreed testing UI is usually not profitable for our aims and better to focus on making things testable at lower levels", "author": "mikehardy", "createdAt": "2020-05-03T17:34:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjkwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419126908", "body": "```suggestion\r\n                //If the database is locked, all we can do is ask the user to exit.\r\n```\r\n\r\nAs long as I have one textual nit that's important might as well throw in the other one I would have otherwise ignore ;-)\r\n\r\nI think this was the last commit in the stack, I'd like to rebase not squash so if you could merge this in (ignoring the fact that github makes them committable - it's just a nice presentation to see my suggestion - that'd be `<kiwi>legend</kiwi>`", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            //If the database is locked, all we can do is ask the user t exit.\n          \n          \n            \n                            //If the database is locked, all we can do is ask the user to exit.\n          \n      \n    \n    \n  \n\nAs long as I have one textual nit that's important might as well throw in the other one I would have otherwise ignore ;-)\nI think this was the last commit in the stack, I'd like to rebase not squash so if you could merge this in (ignoring the fact that github makes them committable - it's just a nice presentation to see my suggestion - that'd be <kiwi>legend</kiwi>", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-c\"><span class=\"pl-c\">//</span>If the database is locked, all we can do is ask the user <span class=\"x x-first x-last\">t</span> exit.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-c\"><span class=\"pl-c\">//</span>If the database is locked, all we can do is ask the user <span class=\"x x-first x-last\">to</span> exit.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">As long as I have one textual nit that's important might as well throw in the other one I would have otherwise ignore ;-)</p>\n<p dir=\"auto\">I think this was the last commit in the stack, I'd like to rebase not squash so if you could merge this in (ignoring the fact that github makes them committable - it's just a nice presentation to see my suggestion - that'd be <code>&lt;kiwi&gt;legend&lt;/kiwi&gt;</code></p>", "author": "mikehardy", "createdAt": "2020-05-03T16:29:22Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -270,12 +272,25 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         })\n                         .show();\n             }\n+            case DIALOG_DB_LOCKED: {\n+                //If the database is locked, all we can do is ask the user t exit.", "originalCommit": "8fe879dcbaa2b9c8c27d2f5f2f6270ec7f4a8fb4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyOTg1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419129854", "bodyText": "I'm used to rebasing commits in the middle of the stack now, so it's not a bother. Both were at the end", "author": "david-allison-1", "createdAt": "2020-05-03T16:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEyNjkwOA=="}], "type": "inlineReview"}, {"oid": "1e7fb11a75d84dba1ed3e924c7f88711940162f5", "url": "https://github.com/ankidroid/Anki-Android/commit/1e7fb11a75d84dba1ed3e924c7f88711940162f5", "message": "Don't crash on locked database in Check Database\n\nPreviously, we tried to end a transaction which did not exist, which\ncrashed. Now, we go back to the \"failed to load\" error.\n\nFixes #6067", "committedDate": "2020-05-03T16:50:55Z", "type": "commit"}, {"oid": "1981f73dd4ac0ce52a20c4fcdb70b39ffb1680a0", "url": "https://github.com/ankidroid/Anki-Android/commit/1981f73dd4ac0ce52a20c4fcdb70b39ffb1680a0", "message": "NF: Add tests for CheckDatabaseListener", "committedDate": "2020-05-03T16:50:59Z", "type": "commit"}, {"oid": "9b7ae2a4fbaf9dcfeed516fd365030d38c4f5f5f", "url": "https://github.com/ankidroid/Anki-Android/commit/9b7ae2a4fbaf9dcfeed516fd365030d38c4f5f5f", "message": "NF: DeckPicker: Refactor CheckDatabaseListener\n\nAutomated swap & removal of else block for clarity.", "committedDate": "2020-05-03T16:50:59Z", "type": "commit"}, {"oid": "3e3d42d6c1758fca69b5b4fa255a83431628e095", "url": "https://github.com/ankidroid/Anki-Android/commit/3e3d42d6c1758fca69b5b4fa255a83431628e095", "message": "DeckPicker: Handle DbLocked & change outcomes\n\nIf we got a valid result with no data, treat it as a success", "committedDate": "2020-05-03T16:50:59Z", "type": "commit"}, {"oid": "222c6ec50c0304d676c80752de5cf69371dff543", "url": "https://github.com/ankidroid/Anki-Android/commit/222c6ec50c0304d676c80752de5cf69371dff543", "message": "DatabaseErrorDialog: Handle DB Locked\n\nAdd in a dialog which will handle the database being locked.", "committedDate": "2020-05-03T16:52:31Z", "type": "commit"}, {"oid": "222c6ec50c0304d676c80752de5cf69371dff543", "url": "https://github.com/ankidroid/Anki-Android/commit/222c6ec50c0304d676c80752de5cf69371dff543", "message": "DatabaseErrorDialog: Handle DB Locked\n\nAdd in a dialog which will handle the database being locked.", "committedDate": "2020-05-03T16:52:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMDA2OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419130068", "body": "![Codacy](https://app.codacy.com/assets/images/favicon.png) Issue found: [Avoid throwing raw exception types.](https://app.codacy.com/manual/timrae/Anki-Android/pullRequest?prid=5461550)", "bodyText": "Issue found: Avoid throwing raw exception types.", "bodyHTML": "<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/ddf013cbb1295b347431f8757e505fb295e9c7dd5043d9a3a0bf610dd0bb0da7/68747470733a2f2f6170702e636f646163792e636f6d2f6173736574732f696d616765732f66617669636f6e2e706e67\"><img src=\"https://camo.githubusercontent.com/ddf013cbb1295b347431f8757e505fb295e9c7dd5043d9a3a0bf610dd0bb0da7/68747470733a2f2f6170702e636f646163792e636f6d2f6173736574732f696d616765732f66617669636f6e2e706e67\" alt=\"Codacy\" data-canonical-src=\"https://app.codacy.com/assets/images/favicon.png\" style=\"max-width: 100%;\"></a> Issue found: <a href=\"https://app.codacy.com/manual/timrae/Anki-Android/pullRequest?prid=5461550\" rel=\"nofollow\">Avoid throwing raw exception types.</a></p>", "author": "timrae", "createdAt": "2020-05-03T16:55:15Z", "path": "AnkiDroid/src/test/java/com/ichi2/async/AbstractCollectionTaskTest.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.async;\n+\n+import com.ichi2.anki.RobolectricTest;\n+\n+import org.junit.runner.RunWith;\n+\n+import androidx.test.ext.junit.runners.AndroidJUnit4;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.arrayWithSize;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+@RunWith(AndroidJUnit4.class)\n+public abstract class AbstractCollectionTaskTest extends RobolectricTest {\n+\n+    protected CollectionTask.TaskData execute(int taskType) {\n+        CollectionTask task = CollectionTask.launchCollectionTask(taskType);\n+        try {\n+            return task.execute().get();\n+        } catch (Exception e) {\n+            throw new RuntimeException(e);", "originalCommit": "222c6ec50c0304d676c80752de5cf69371dff543", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMDA3NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6100#discussion_r419130074", "body": "![Codacy](https://app.codacy.com/assets/images/favicon.png) Issue found: [The utility class name 'DatabaseLock' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper|Constants)'](https://app.codacy.com/manual/timrae/Anki-Android/pullRequest?prid=5461550)", "bodyText": "Issue found: The utility class name 'DatabaseLock' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper|Constants)'", "bodyHTML": "<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/ddf013cbb1295b347431f8757e505fb295e9c7dd5043d9a3a0bf610dd0bb0da7/68747470733a2f2f6170702e636f646163792e636f6d2f6173736574732f696d616765732f66617669636f6e2e706e67\"><img src=\"https://camo.githubusercontent.com/ddf013cbb1295b347431f8757e505fb295e9c7dd5043d9a3a0bf610dd0bb0da7/68747470733a2f2f6170702e636f646163792e636f6d2f6173736574732f696d616765732f66617669636f6e2e706e67\" alt=\"Codacy\" data-canonical-src=\"https://app.codacy.com/assets/images/favicon.png\" style=\"max-width: 100%;\"></a> Issue found: <a href=\"https://app.codacy.com/manual/timrae/Anki-Android/pullRequest?prid=5461550\" rel=\"nofollow\">The utility class name 'DatabaseLock' doesn't match '[A-Z][a-zA-Z0-9]+(Utils?|Helper|Constants)'</a></p>", "author": "timrae", "createdAt": "2020-05-03T16:55:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/debug/DatabaseLock.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ Copyright (c) 2020 David Allison <davidallisongithub@gmail.com>\n+\n+ This program is free software; you can redistribute it and/or modify it under\n+ the terms of the GNU General Public License as published by the Free Software\n+ Foundation; either version 3 of the License, or (at your option) any later\n+ version.\n+\n+ This program is distributed in the hope that it will be useful, but WITHOUT ANY\n+ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A\n+ PARTICULAR PURPOSE. See the GNU General Public License for more details.\n+\n+ You should have received a copy of the GNU General Public License along with\n+ this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.ichi2.anki.debug;\n+\n+import android.content.Context;\n+\n+import com.ichi2.anki.CollectionHelper;\n+import com.ichi2.libanki.Collection;\n+\n+import timber.log.Timber;\n+\n+/** Debug only class which will lock the database */\n+public class DatabaseLock {", "originalCommit": "222c6ec50c0304d676c80752de5cf69371dff543", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}