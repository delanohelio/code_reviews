{"pr_number": 6040, "pr_title": "Uses requery's window size", "pr_author": "Arthur-Milchior", "pr_createdAt": "2020-04-17T23:37:47Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6040", "timeline": [{"oid": "6cf1caf59edc6f7fe82b10b412e00fb2c06be967", "url": "https://github.com/ankidroid/Anki-Android/commit/6cf1caf59edc6f7fe82b10b412e00fb2c06be967", "message": "Uses requery's window size\n\nI want to look into requery's code to find the actual size of their\nwindow.\n\nI sent them a PR in order to add a getter which returns this window\nsize to us. Ideally, it would allow to remove those constants from\nAnkiDroid code which are here only to copy their constants.\n\nNote that, as I expected, we can't use a chunk whose size is the\nwindow (I tested); that's because the window contains extra\ninformations. So I decreased the window size slightly in order to have\nsomething reasonable.", "committedDate": "2020-07-05T23:48:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQyODE2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r450428161", "body": "```suggestion\r\n        // We have the ability to look into our sqlite implementation on Android and use it's value\r\n        // as a ceiling. Try it, with a reasonable fallback in case of failure\r\n        int chunk = 1024*1024; // 1 mb, a little less than what a cursor line may contain\r\n        if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(mDb.getDatabase().getClass().getName())) {\r\n            try {\r\n                Field cursorWindowSize = io.requery.android.database.CursorWindow.class.getDeclaredField(\"sCursorWindowSize\");\r\n                cursorWindowSize.setAccessible(true);\r\n                chunk = cursorWindowSize.getInt(null);\r\n            } catch (Exception e) {\r\n                Timber.w(e, \"Unable to get window size from requery cursor.\");\r\n            }\r\n        }\r\n```\r\n\r\n@Arthur-Milchior - tested and working with proof from the coverage report on jacocoTestReport\r\n\r\n![Screenshot from 2020-07-06 14-11-14](https://user-images.githubusercontent.com/782704/86630812-f254de00-bf92-11ea-93b6-5bd042fa5976.png)\r\n", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // the window size is saved in\n          \n          \n            \n                    // io.requery.android.database.CursorWindow.sCursorWindowSize.\n          \n          \n            \n                    // Values are copied here. Ideally, a getter would allow to access it.\n          \n          \n            \n                    final int WINDOW_SIZE_KB = 2048;\n          \n          \n            \n                    final int sCursorWindowSize = WINDOW_SIZE_KB * 1024;\n          \n          \n            \n                    // reduce the actual size a little bit.\n          \n          \n            \n                    final int chunk = (sCursorWindowSize / 16) * 15;\n          \n          \n            \n                    // We have the ability to look into our sqlite implementation on Android and use it's value\n          \n          \n            \n                    // as a ceiling. Try it, with a reasonable fallback in case of failure\n          \n          \n            \n                    int chunk = 1024*1024; // 1 mb, a little less than what a cursor line may contain\n          \n          \n            \n                    if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(mDb.getDatabase().getClass().getName())) {\n          \n          \n            \n                        try {\n          \n          \n            \n                            Field cursorWindowSize = io.requery.android.database.CursorWindow.class.getDeclaredField(\"sCursorWindowSize\");\n          \n          \n            \n                            cursorWindowSize.setAccessible(true);\n          \n          \n            \n                            chunk = cursorWindowSize.getInt(null);\n          \n          \n            \n                        } catch (Exception e) {\n          \n          \n            \n                            Timber.w(e, \"Unable to get window size from requery cursor.\");\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\n@Arthur-Milchior - tested and working with proof from the coverage report on jacocoTestReport", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> the window size is saved in</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> io.requery.android.database.CursorWindow.sCursorWindowSize.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> Values are copied here. Ideally, a getter would allow to access it.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> <span class=\"pl-c1\">WINDOW_SIZE_KB</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">2048</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> sCursorWindowSize <span class=\"pl-k\">=</span> <span class=\"pl-c1\">WINDOW_SIZE_KB</span> <span class=\"pl-k\">*</span> <span class=\"pl-c1\">1024</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> reduce the actual size a little bit.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> chunk <span class=\"pl-k\">=</span> (sCursorWindowSize <span class=\"pl-k\">/</span> <span class=\"pl-c1\">16</span>) <span class=\"pl-k\">*</span> <span class=\"pl-c1\">15</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> We have the ability to look into our sqlite implementation on Android and use it's value</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> as a ceiling. Try it, with a reasonable fallback in case of failure</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">int</span> chunk <span class=\"pl-k\">=</span> <span class=\"pl-c1\">1024</span><span class=\"pl-k\">*</span><span class=\"pl-c1\">1024</span>; <span class=\"pl-c\"><span class=\"pl-c\">//</span> 1 mb, a little less than what a cursor line may contain</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>io.requery.android.database.sqlite.SQLiteDatabase<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">.</span>equals(mDb<span class=\"pl-k\">.</span>getDatabase()<span class=\"pl-k\">.</span>getClass()<span class=\"pl-k\">.</span>getName())) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">Field</span> cursorWindowSize <span class=\"pl-k\">=</span> <span class=\"pl-smi\">io.requery.android.database<span class=\"pl-k\">.</span>CursorWindow</span><span class=\"pl-k\">.</span>class<span class=\"pl-k\">.</span>getDeclaredField(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>sCursorWindowSize<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                cursorWindowSize<span class=\"pl-k\">.</span>setAccessible(<span class=\"pl-c1\">true</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                chunk <span class=\"pl-k\">=</span> cursorWindowSize<span class=\"pl-k\">.</span>getInt(<span class=\"pl-c1\">null</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">Exception</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">Timber</span><span class=\"pl-k\">.</span>w(e, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Unable to get window size from requery cursor.<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/Arthur-Milchior/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/Arthur-Milchior\">@Arthur-Milchior</a> - tested and working with proof from the coverage report on jacocoTestReport</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/782704/86630812-f254de00-bf92-11ea-93b6-5bd042fa5976.png\"><img src=\"https://user-images.githubusercontent.com/782704/86630812-f254de00-bf92-11ea-93b6-5bd042fa5976.png\" alt=\"Screenshot from 2020-07-06 14-11-14\" style=\"max-width: 100%;\"></a></p>", "author": "mikehardy", "createdAt": "2020-07-06T19:14:50Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -272,7 +272,13 @@ public void load() {\n \n     public String loadColumn(String columnName) {\n         int pos = 1;\n-        int chunk = 1024*1024; // 1 mb, a little less than what a cursor line may contain\n+        // the window size is saved in\n+        // io.requery.android.database.CursorWindow.sCursorWindowSize.\n+        // Values are copied here. Ideally, a getter would allow to access it.\n+        final int WINDOW_SIZE_KB = 2048;\n+        final int sCursorWindowSize = WINDOW_SIZE_KB * 1024;\n+        // reduce the actual size a little bit.\n+        final int chunk = (sCursorWindowSize / 16) * 15;", "originalCommit": "6cf1caf59edc6f7fe82b10b412e00fb2c06be967", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f29ac33842661e94099569117fc097966e2369ab", "url": "https://github.com/ankidroid/Anki-Android/commit/f29ac33842661e94099569117fc097966e2369ab", "message": "Use Reflection", "committedDate": "2020-08-05T12:44:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDQxMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465700410", "body": "This isn't going to work now #3524 has gone in as it applies a decorator to the class", "bodyText": "This isn't going to work now #3524 has gone in as it applies a decorator to the class", "bodyHTML": "<p dir=\"auto\">This isn't going to work now <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"97678227\" data-permission-text=\"Title is private\" data-url=\"https://github.com/ankidroid/Anki-Android/issues/3524\" data-hovercard-type=\"issue\" data-hovercard-url=\"/ankidroid/Anki-Android/issues/3524/hovercard\" href=\"https://github.com/ankidroid/Anki-Android/issues/3524\">#3524</a> has gone in as it applies a decorator to the class</p>", "author": "david-allison-1", "createdAt": "2020-08-05T12:47:18Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -272,7 +272,24 @@ public void load() {\n \n     public String loadColumn(String columnName) {\n         int pos = 1;\n-        int chunk = 1024*1024; // 1 mb, a little less than what a cursor line may contain\n+        // the window size is saved in\n+        // io.requery.android.database.CursorWindow.sCursorWindowSize.\n+        // Values are copied here. Ideally, a getter would allow to access it.\n+        final int WINDOW_SIZE_KB = 2048;\n+        final int sCursorWindowSize = WINDOW_SIZE_KB * 1024;\n+        // reduce the actual size a little bit.\n+        // We have the ability to look into our sqlite implementation on Android and use it's value\n+        // as a ceiling. Try it, with a reasonable fallback in case of failure\n+        if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(mDb.getDatabase().getClass().getName())) {", "originalCommit": "f29ac33842661e94099569117fc097966e2369ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMzU1Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465803557", "bodyText": "We need to peek through the decorator I think? We need to be able to get the real implementation class so we have reasonable assurance that an otherwise known reflective access will work", "author": "mikehardy", "createdAt": "2020-08-05T15:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkzNTcwNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465935707", "bodyText": "@Arthur-Milchior - @david-allison-1 is right on this one, we'll need a change to the new wrapper as well, in order to access this https://github.com/david-allison-1/Anki-Android/blob/677831e94aa2cbd83284a305cf9cb88050e78f4f/AnkiDroid/src/main/java/com/ichi2/utils/DatabaseChangeDecorator.java#L39 - I believe the change is to make a getter for the wrapped object, then in this PR do a cast in order to access it\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(mDb.getDatabase().getClass().getName())) {\n          \n          \n            \n                    if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(((DatabaseChangeDecorator)mDb.getDatabase()).getWrapped().getClass().getName())) {\n          \n      \n    \n    \n  \n\nThis PR has been close but refuses to die! I think this last bit will get it", "author": "mikehardy", "createdAt": "2020-08-05T18:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDcyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465700722", "body": "This is going to slow down the app (reflection and exceptions are slow), ideally perform it once and cache the result", "bodyText": "This is going to slow down the app (reflection and exceptions are slow), ideally perform it once and cache the result", "bodyHTML": "<p dir=\"auto\">This is going to slow down the app (reflection and exceptions are slow), ideally perform it once and cache the result</p>", "author": "david-allison-1", "createdAt": "2020-08-05T12:47:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -272,7 +272,24 @@ public void load() {\n \n     public String loadColumn(String columnName) {\n         int pos = 1;\n-        int chunk = 1024*1024; // 1 mb, a little less than what a cursor line may contain\n+        // the window size is saved in\n+        // io.requery.android.database.CursorWindow.sCursorWindowSize.\n+        // Values are copied here. Ideally, a getter would allow to access it.\n+        final int WINDOW_SIZE_KB = 2048;\n+        final int sCursorWindowSize = WINDOW_SIZE_KB * 1024;\n+        // reduce the actual size a little bit.\n+        // We have the ability to look into our sqlite implementation on Android and use it's value\n+        // as a ceiling. Try it, with a reasonable fallback in case of failure\n+        if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(mDb.getDatabase().getClass().getName())) {\n+            try {", "originalCommit": "f29ac33842661e94099569117fc097966e2369ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxMTkzMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465711931", "bodyText": "Probably not slow the app a lot. This method is used only twice: to load decks and models.\nI'll do it anyway", "author": "Arthur-Milchior", "createdAt": "2020-08-05T13:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3NTE0NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465875145", "bodyText": "To be exhaustive, I should mention that those columns are loaded each time the collection is loaded, i.e. twice by sync, even for partial sync (unless you accept my PR which removes it)", "author": "Arthur-Milchior", "createdAt": "2020-08-05T17:05:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDcyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk0NTcwNA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465945704", "bodyText": "@Arthur-Milchior note that getWrapped() accessor does not exist yet on DatabaseChangeDecorator - it needs that too", "author": "mikehardy", "createdAt": "2020-08-05T19:13:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMDcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMTUzMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465701532", "body": "Use doubles here, then convert back to an int at the end. (I think this will make it more accurate, but needs verification).\r\n\r\n", "bodyText": "Use doubles here, then convert back to an int at the end. (I think this will make it more accurate, but needs verification).", "bodyHTML": "<p dir=\"auto\">Use doubles here, then convert back to an int at the end. (I think this will make it more accurate, but needs verification).</p>", "author": "david-allison-1", "createdAt": "2020-08-05T12:49:08Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -272,7 +272,24 @@ public void load() {\n \n     public String loadColumn(String columnName) {\n         int pos = 1;\n-        int chunk = 1024*1024; // 1 mb, a little less than what a cursor line may contain\n+        // the window size is saved in\n+        // io.requery.android.database.CursorWindow.sCursorWindowSize.\n+        // Values are copied here. Ideally, a getter would allow to access it.\n+        final int WINDOW_SIZE_KB = 2048;\n+        final int sCursorWindowSize = WINDOW_SIZE_KB * 1024;\n+        // reduce the actual size a little bit.\n+        // We have the ability to look into our sqlite implementation on Android and use it's value\n+        // as a ceiling. Try it, with a reasonable fallback in case of failure\n+        if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(mDb.getDatabase().getClass().getName())) {\n+            try {\n+                Field cursorWindowSize = io.requery.android.database.CursorWindow.class.getDeclaredField(\"sCursorWindowSize\");\n+                cursorWindowSize.setAccessible(true);\n+                sCursorWindowSize = cursorWindowSize.getInt(null);\n+            } catch (Exception e) {\n+                Timber.w(e, \"Unable to get window size from requery cursor.\");\n+            }\n+        }\n+        int final chunk = sCursorWindowSize * 15 / 16 ;", "originalCommit": "f29ac33842661e94099569117fc097966e2369ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMjMzMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465802332", "bodyText": "I hate computer math. I think you're right, may not matter here but should be a habit.", "author": "mikehardy", "createdAt": "2020-08-05T15:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMTUzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3MzgxOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465873818", "bodyText": "Done.", "author": "Arthur-Milchior", "createdAt": "2020-08-05T17:03:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwMTUzMg=="}], "type": "inlineReview"}, {"oid": "ba6b122fb0254db20500da83987e7dabdffdb023", "url": "https://github.com/ankidroid/Anki-Android/commit/ba6b122fb0254db20500da83987e7dabdffdb023", "message": "Use Reflection", "committedDate": "2020-08-05T17:02:23Z", "type": "forcePushed"}, {"oid": "26212464fef07c19711b2d39c147b404c032ecc6", "url": "https://github.com/ankidroid/Anki-Android/commit/26212464fef07c19711b2d39c147b404c032ecc6", "message": "Use Reflection", "committedDate": "2020-08-05T17:02:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MTE3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r465951176", "body": "You need to check that `mDb.getDatabase()` can be cast to `DatabaseChangeDecorator`\r\nIt'd be best to extract a few variables out of the line for clarity.\r\nMaybe extract `getCursorWindowSize()` so an early return is possible to make the code cleaner", "bodyText": "You need to check that mDb.getDatabase() can be cast to DatabaseChangeDecorator\nIt'd be best to extract a few variables out of the line for clarity.\nMaybe extract getCursorWindowSize() so an early return is possible to make the code cleaner", "bodyHTML": "<p dir=\"auto\">You need to check that <code>mDb.getDatabase()</code> can be cast to <code>DatabaseChangeDecorator</code><br>\nIt'd be best to extract a few variables out of the line for clarity.<br>\nMaybe extract <code>getCursorWindowSize()</code> so an early return is possible to make the code cleaner</p>", "author": "david-allison-1", "createdAt": "2020-08-05T19:23:56Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -276,14 +277,40 @@ public void load() {\n         mDecks.load(loadColumn(\"decks\"), deckConf);\n     }\n \n+    private static int sChunk = 0;\n+\n+    private int getChunk() {\n+        if (sChunk != 0) {\n+            return sChunk;\n+        }\n+        // the window size is saved in\n+        // io.requery.android.database.CursorWindow.sCursorWindowSize.\n+        // Values are copied here. Ideally, a getter would allow to access it.\n+        final int WINDOW_SIZE_KB = 2048;\n+        int sCursorWindowSize = WINDOW_SIZE_KB * 1024;\n+        // reduce the actual size a little bit.\n+        // We have the ability to look into our sqlite implementation on Android and use it's value\n+        // as a ceiling. Try it, with a reasonable fallback in case of failure\n+        if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(((DatabaseChangeDecorator)mDb.getDatabase()).getWrapped().getClass().getName())) {", "originalCommit": "ae94ae74acede39d0fd0c999cb848d60472f5b55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMwODA1Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r467308057", "bodyText": "@david-allison-1 I think you mean ?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(((DatabaseChangeDecorator)mDb.getDatabase()).getWrapped().getClass().getName())) {\n          \n          \n            \n                    SQLiteDatabase maybeDecorator = mDb.getDatabase();\n          \n          \n            \n                    if ((maybeDecorator instanceof DatabaseChangeDecorator) && (\"io.requery.android.database.sqlite.SQLiteDatabase\".equals(((DatabaseChangeDecorator)maybeDecorator).getWrapped().getClass().getName())) {", "author": "mikehardy", "createdAt": "2020-08-07T22:11:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MTE3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMwODUxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6040#discussion_r467308511", "bodyText": "you addressed this", "author": "mikehardy", "createdAt": "2020-08-07T22:13:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1MTE3Ng=="}], "type": "inlineReview"}, {"oid": "7daccebcd2fec5d892fabcd5720494e0769f15bc", "url": "https://github.com/ankidroid/Anki-Android/commit/7daccebcd2fec5d892fabcd5720494e0769f15bc", "message": "Uses requery's window size\n\nI want to look into requery's code to find the actual size of their\nwindow.\n\nI sent them a PR in order to add a getter which returns this window\nsize to us. Ideally, it would allow to remove those constants from\nAnkiDroid code which are here only to copy their constants.\n\nNote that, as I expected, we can't use a chunk whose size is the\nwindow (I tested); that's because the window contains extra\ninformations. So I decreased the window size slightly in order to have\nsomething reasonable.", "committedDate": "2020-08-07T21:53:25Z", "type": "forcePushed"}, {"oid": "48397da16ce2f4fdda704321a8a6b48919cd4bd7", "url": "https://github.com/ankidroid/Anki-Android/commit/48397da16ce2f4fdda704321a8a6b48919cd4bd7", "message": "Uses requery's window size\n\nI want to look into requery's code to find the actual size of their\nwindow.\n\nI sent them a PR in order to add a getter which returns this window\nsize to us. Ideally, it would allow to remove those constants from\nAnkiDroid code which are here only to copy their constants.\n\nNote that, as I expected, we can't use a chunk whose size is the\nwindow (I tested); that's because the window contains extra\ninformations. So I decreased the window size slightly in order to have\nsomething reasonable.", "committedDate": "2020-08-07T21:57:10Z", "type": "commit"}, {"oid": "6e2e6c87c4985c9f4ca1cf3e05322a893da31340", "url": "https://github.com/ankidroid/Anki-Android/commit/6e2e6c87c4985c9f4ca1cf3e05322a893da31340", "message": "NF: test writting reading big data in database", "committedDate": "2020-08-07T22:07:50Z", "type": "commit"}, {"oid": "6e2e6c87c4985c9f4ca1cf3e05322a893da31340", "url": "https://github.com/ankidroid/Anki-Android/commit/6e2e6c87c4985c9f4ca1cf3e05322a893da31340", "message": "NF: test writting reading big data in database", "committedDate": "2020-08-07T22:07:50Z", "type": "forcePushed"}]}