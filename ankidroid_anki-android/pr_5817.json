{"pr_number": 5817, "pr_title": "Add ability to answer cards via javascript in WebView", "pr_author": "infinyte7", "pr_createdAt": "2020-03-14T10:19:34Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/5817", "timeline": [{"oid": "3a4a301da3dca4f6a44edef2193988bed15316ad", "url": "https://github.com/ankidroid/Anki-Android/commit/3a4a301da3dca4f6a44edef2193988bed15316ad", "message": "Add files via upload", "committedDate": "2020-03-14T09:50:07Z", "type": "commit"}, {"oid": "3e57c4ceca25bb1fec92ca743eaa98700966108f", "url": "https://github.com/ankidroid/Anki-Android/commit/3e57c4ceca25bb1fec92ca743eaa98700966108f", "message": "Update card.js", "committedDate": "2020-03-15T09:39:50Z", "type": "commit"}, {"oid": "e7e91bc09a085ffc129535442af8456f97f6dc80", "url": "https://github.com/ankidroid/Anki-Android/commit/e7e91bc09a085ffc129535442af8456f97f6dc80", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T09:41:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392660054", "body": "Having functionality which will allow external actors to mutate the collection probably warrants an investigation into security.\r\n\r\nTheoretically, if someone hijacks a JS dependency in my deck, or I insert a malicious card from an external deck, a card could answer itself without my knowledge.\r\n\r\nA card being able to answer itself isn't too bad, but it'd be good to model it. \r\n\r\nIf the card could queue up a series of the actions, and they're executed outside the context of the current card, then that's really problematic\r\n\r\n```js\r\n//probably fine\r\nwindow.location = \"signal:showAnswer()\";\r\nwindow.location = \"signal:answer_ease1\";\r\n//Very bad if these are executed.\r\nwindow.location = \"signal:showAnswer()\";\r\nwindow.location = \"signal:answer_ease1\";\r\n```\r\nI don't know what will happen with the above, but we should check.\r\n\r\nI don't know if our threat model is defined anywhere yet. We currently allow people to do crazy things, which we probably shouldn't. Maybe the horse has bolted on this one.", "bodyText": "Having functionality which will allow external actors to mutate the collection probably warrants an investigation into security.\nTheoretically, if someone hijacks a JS dependency in my deck, or I insert a malicious card from an external deck, a card could answer itself without my knowledge.\nA card being able to answer itself isn't too bad, but it'd be good to model it.\nIf the card could queue up a series of the actions, and they're executed outside the context of the current card, then that's really problematic\n//probably fine\nwindow.location = \"signal:showAnswer()\";\nwindow.location = \"signal:answer_ease1\";\n//Very bad if these are executed.\nwindow.location = \"signal:showAnswer()\";\nwindow.location = \"signal:answer_ease1\";\nI don't know what will happen with the above, but we should check.\nI don't know if our threat model is defined anywhere yet. We currently allow people to do crazy things, which we probably shouldn't. Maybe the horse has bolted on this one.", "bodyHTML": "<p dir=\"auto\">Having functionality which will allow external actors to mutate the collection probably warrants an investigation into security.</p>\n<p dir=\"auto\">Theoretically, if someone hijacks a JS dependency in my deck, or I insert a malicious card from an external deck, a card could answer itself without my knowledge.</p>\n<p dir=\"auto\">A card being able to answer itself isn't too bad, but it'd be good to model it.</p>\n<p dir=\"auto\">If the card could queue up a series of the actions, and they're executed outside the context of the current card, then that's really problematic</p>\n<div class=\"highlight highlight-source-js position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"//probably fine\nwindow.location = &quot;signal:showAnswer()&quot;;\nwindow.location = &quot;signal:answer_ease1&quot;;\n//Very bad if these are executed.\nwindow.location = &quot;signal:showAnswer()&quot;;\nwindow.location = &quot;signal:answer_ease1&quot;;\n\"><pre><span class=\"pl-c\">//probably fine</span>\n<span class=\"pl-smi\">window</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">location</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">\"signal:showAnswer()\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-smi\">window</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">location</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">\"signal:answer_ease1\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-c\">//Very bad if these are executed.</span>\n<span class=\"pl-smi\">window</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">location</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">\"signal:showAnswer()\"</span><span class=\"pl-kos\">;</span>\n<span class=\"pl-smi\">window</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">location</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">\"signal:answer_ease1\"</span><span class=\"pl-kos\">;</span></pre></div>\n<p dir=\"auto\">I don't know what will happen with the above, but we should check.</p>\n<p dir=\"auto\">I don't know if our threat model is defined anywhere yet. We currently allow people to do crazy things, which we probably shouldn't. Maybe the horse has bolted on this one.</p>", "author": "david-allison-1", "createdAt": "2020-03-15T10:24:52Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1480,6 +1475,46 @@ private boolean filterUrl(String url) {\n                     mFlipCardLayout.setVisibility(View.GONE);\n                     return true;\n                 }\n+                /*show answer using js functions*/\n+                if(\"signal:show_answer\".equals(url)){\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease1\".equals(url)){", "originalCommit": "e7e91bc09a085ffc129535442af8456f97f6dc80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDkyMg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392660922", "bodyText": "I have just implemented it. I am currently learning new stuffs.\nIf functions call queued then It has to be checked.\nI am finding solution about it.\nThank you", "author": "infinyte7", "createdAt": "2020-03-15T10:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MTczOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392661739", "bodyText": "Just posting my thoughts on it. I'm not in a position to approve/deny anything.\nIMO, it'd be great to get this functionality in and better documented for deck authors to take advantage of. There's so much untapped potential with custom note types that we haven't explored yet, and it's even better if we allow people to do this in JS so they don't need to know AnkiDroid internals.", "author": "david-allison-1", "createdAt": "2020-03-15T10:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3OTM2MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392679361", "bodyText": "Yes, Giving potentiality of js capabilities make more useful for learnes as well as deck creators.", "author": "infinyte7", "createdAt": "2020-03-15T14:32:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY2MDA1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTI4NQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392675285", "body": "This logic branch (\"are we showing the answer? if not show the answer...\") is duplicated 4 times, seems it could be pulled up into one `if(url.contains(\"signal:answer_ease\")) { if (!sDisplayAnswer) { displayCardAnswer(); return true; }` then a switch on which answer_easeN was requested?\r\n\r\nAlso please note that your whitespace is inconsistent, we use a space after if, before parentheses - 'if (' not 'if('", "bodyText": "This logic branch (\"are we showing the answer? if not show the answer...\") is duplicated 4 times, seems it could be pulled up into one if(url.contains(\"signal:answer_ease\")) { if (!sDisplayAnswer) { displayCardAnswer(); return true; } then a switch on which answer_easeN was requested?\nAlso please note that your whitespace is inconsistent, we use a space after if, before parentheses - 'if (' not 'if('", "bodyHTML": "<p dir=\"auto\">This logic branch (\"are we showing the answer? if not show the answer...\") is duplicated 4 times, seems it could be pulled up into one <code>if(url.contains(\"signal:answer_ease\")) { if (!sDisplayAnswer) { displayCardAnswer(); return true; }</code> then a switch on which answer_easeN was requested?</p>\n<p dir=\"auto\">Also please note that your whitespace is inconsistent, we use a space after if, before parentheses - 'if (' not 'if('</p>", "author": "mikehardy", "createdAt": "2020-03-15T13:44:42Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1475,6 +1475,46 @@ private boolean filterUrl(String url) {\n                     mFlipCardLayout.setVisibility(View.GONE);\n                     return true;\n                 }\n+                /*show answer using js functions*/\n+                if(\"signal:show_answer\".equals(url)){\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease1\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_1);\n+                    } else {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease2\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_2);\n+                    } else {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease3\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_3);\n+                    } else {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if(\"signal:answer_ease4\".equals(url)){\n+                    if (sDisplayAnswer) {\n+                        answerCard(EASE_4);\n+                    } else {", "originalCommit": "e7e91bc09a085ffc129535442af8456f97f6dc80", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTMwNg==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392675306", "bodyText": "likewise, we have a space between close parentheses and open curly brace - ') {' vs '){'", "author": "mikehardy", "createdAt": "2020-03-15T13:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3OTQ4OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392679489", "bodyText": "Okay, I will follow that, and implement as per requested.", "author": "infinyte7", "createdAt": "2020-03-15T14:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTI4NQ=="}], "type": "inlineReview"}, {"oid": "366610142dc2b93fd4a54958878b9205a9d59f52", "url": "https://github.com/ankidroid/Anki-Android/commit/366610142dc2b93fd4a54958878b9205a9d59f52", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T15:52:38Z", "type": "commit"}, {"oid": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "url": "https://github.com/ankidroid/Anki-Android/commit/7c5ec74a43504d5357e66dfec9b329a64c88c04f", "message": "Update card.js", "committedDate": "2020-03-15T15:55:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjExNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392692115", "body": "(nitpick) a few whitespace issues in a few files", "bodyText": "(nitpick) a few whitespace issues in a few files", "bodyHTML": "<p dir=\"auto\">(nitpick) a few whitespace issues in a few files</p>", "author": "david-allison-1", "createdAt": "2020-03-15T16:56:37Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -676,7 +676,7 @@ private String typeAnsQuestionFilter(String buf) {\n             // These functions are defined in the JavaScript file assets/scripts/card.js. We get the text back in\n             // shouldOverrideUrlLoading() in createWebView() in this file.\n             sb.append(\"<center>\\n<input type=text name=typed id=typeans onfocus=\\\"taFocus();\\\" \" +\n-                      \"onblur=\\\"taBlur(this);\\\" onKeyPress=\\\"return taKey(this, event)\\\" autocomplete=\\\"off\\\" \");\n+                    \"onblur=\\\"taBlur(this);\\\" onKeyPress=\\\"return taKey(this, event)\\\" autocomplete=\\\"off\\\" \");", "originalCommit": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392692171", "body": "(nitpick) could be made more concise with string operations/regex.", "bodyText": "(nitpick) could be made more concise with string operations/regex.", "bodyHTML": "<p dir=\"auto\">(nitpick) could be made more concise with string operations/regex.</p>", "author": "david-allison-1", "createdAt": "2020-03-15T16:57:05Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/AbstractFlashcardViewer.java", "diffHunk": "@@ -1475,6 +1475,41 @@ private boolean filterUrl(String url) {\n                     mFlipCardLayout.setVisibility(View.GONE);\n                     return true;\n                 }\n+\n+                 /**\n+                  *  Call displayCardAnswer() and answerCard() from anki deck template using javascript\n+                  *  See card.js in assets/scripts folder\n+                  */\n+                if (\"signal:show_answer\".equals(url)) {\n+                    // display answer when showAnswer() called from card.js\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                    }\n+                    return true;\n+                }\n+                if (url.contains(\"signal:answer_ease\")) {\n+                    if (!sDisplayAnswer) {\n+                        displayCardAnswer();\n+                        return true;\n+                    } else {\n+                        switch (url) {", "originalCommit": "7c5ec74a43504d5357e66dfec9b329a64c88c04f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5NDEyMA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r392694120", "bodyText": "How can I do this?", "author": "infinyte7", "createdAt": "2020-03-15T17:23:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI0OTg3Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r393249876", "bodyText": "Honestly, I don't like it as much as the above. Vote to ignore my previous comment.\nif (url.length() == \"signal:answer_ease\".length() + 1) {\n    char lastChar = url.charAt(url.length() - 1);\n    int ease = lastChar - '0';\n    if (ease < 1 || ease > 4) {\n        Timber.w(\"unhandled signal: %s\", url);\n    } else {\n        answerCard(ease);\n    }\n}", "author": "david-allison-1", "createdAt": "2020-03-16T19:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMzNzY1MA==", "url": "https://github.com/ankidroid/Anki-Android/pull/5817#discussion_r393337650", "bodyText": "I will implement this. Thank you", "author": "infinyte7", "createdAt": "2020-03-16T22:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjE3MQ=="}], "type": "inlineReview"}, {"oid": "f8041a93bb3249736811d14659250d93a9c76ca4", "url": "https://github.com/ankidroid/Anki-Android/commit/f8041a93bb3249736811d14659250d93a9c76ca4", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T18:25:09Z", "type": "commit"}, {"oid": "f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "url": "https://github.com/ankidroid/Anki-Android/commit/f0f9331b5e8d518d7cbad7ac48cb0443c9384559", "message": "Update AbstractFlashcardViewer.java", "committedDate": "2020-03-15T18:36:30Z", "type": "commit"}, {"oid": "2f4df32f4fe9551691ebe4117059d301c55fd9b4", "url": "https://github.com/ankidroid/Anki-Android/commit/2f4df32f4fe9551691ebe4117059d301c55fd9b4", "message": "Merge branch 'master' of https://github.com/infinyte7/Anki-Android", "committedDate": "2020-03-15T18:36:57Z", "type": "commit"}]}