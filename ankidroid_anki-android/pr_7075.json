{"pr_number": 7075, "pr_title": "Show useful error when col version is too high", "pr_author": "david-allison-1", "pr_createdAt": "2020-09-13T02:58:22Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7075", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUxNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473517", "body": "```suggestion\r\n\r\n    @Nullable\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            \n          \n          \n            \n                @Nullable", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"384\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"384\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"385\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@Nullable</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "david-allison-1", "createdAt": "2020-09-13T02:58:58Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/CollectionHelper.java", "diffHunk": "@@ -368,4 +370,20 @@ public static void loadCollectionComplete(Collection col) {\n         col.getModels();\n     }\n \n+    public static boolean isFutureAnkiDroidVersion(Context context) {\n+        Integer databaseVersion = getDatabaseVersion(context);\n+        return databaseVersion != null && databaseVersion > SCHEMA_VERSION;\n+    }\n+\n+", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU0MjYwMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497542601", "bodyText": "As mentioned elsewhere, I'd prefer if the thing wasn't a possible null boxed value and was either a real value or a constant for unknown (-1) with actual exceptions and handling in case things are unrecoverably busted", "author": "mikehardy", "createdAt": "2020-09-30T14:12:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzUzNw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473537", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                   // .itemsColor(ContextCompat.getColor(requireContext(), R.color.material_grey_500))", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"317\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">                       </span><span class=\"pl-c\"><span class=\"pl-c x\">//</span><span class=\"x x-last\"> .itemsColor(ContextCompat.getColor(requireContext(), R.color.material_grey_500))</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "david-allison-1", "createdAt": "2020-09-13T02:59:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -295,6 +300,31 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n+            case DIALOG_DB_FUTURE_VERSION: {\n+                List<Integer> values = new ArrayList<>();\n+                CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };\n+                values.add(0);\n+                values.add(1);\n+                return builder\n+                        .cancelable(false)\n+                        .content(getMessage())\n+                        .iconAttr(R.attr.dialogErrorIcon)\n+                        .positiveText(res.getString(R.string.close))\n+                        .onPositive((inner_dialog, which) -> exit())\n+                        .items(options)\n+                       // .itemsColor(ContextCompat.getColor(requireContext(), R.color.material_grey_500))", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzU4OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473588", "body": "This might want a nicer abstraction as it's a rough copy of the same code in another method", "bodyText": "This might want a nicer abstraction as it's a rough copy of the same code in another method", "bodyHTML": "<p dir=\"auto\">This might want a nicer abstraction as it's a rough copy of the same code in another method</p>", "author": "david-allison-1", "createdAt": "2020-09-13T02:59:45Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -295,6 +300,31 @@ public MaterialDialog onCreateDialog(Bundle savedInstanceState) {\n                         .onPositive((inner_dialog, which) -> exit())\n                         .show();\n             }\n+            case DIALOG_DB_FUTURE_VERSION: {\n+                List<Integer> values = new ArrayList<>();\n+                CharSequence[] options = new CharSequence[] { UiUtil.makeBold(res.getString(R.string.backup_restore)), UiUtil.makeBold(res.getString(R.string.backup_full_sync_from_server)) };", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYwOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473609", "body": "```suggestion\r\n                    Timber.w(e, \"Failed to get database version, using -1\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Timber.w(e, \"Failed to get database version\");\n          \n          \n            \n                                Timber.w(e, \"Failed to get database version, using -1\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-smi\">Timber</span><span class=\"pl-k\">.</span>w(e, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Failed to get database version<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-smi\">Timber</span><span class=\"pl-k\">.</span>w(e, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Failed to get database version<span class=\"x x-first x-last\">, using -1</span><span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "david-allison-1", "createdAt": "2020-09-13T03:00:00Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/dialogs/DatabaseErrorDialog.java", "diffHunk": "@@ -334,6 +364,14 @@ private String getMessage() {\n                 return res().getString(R.string.backup_full_sync_from_server_question);\n             case DIALOG_DB_LOCKED:\n                 return res().getString(R.string.database_locked_summary);\n+            case DIALOG_DB_FUTURE_VERSION:\n+                Integer databaseVersion = null;\n+                try {\n+                    databaseVersion = CollectionHelper.getDatabaseVersion(requireContext());\n+                } catch (Exception e) {\n+                    Timber.w(e, \"Failed to get database version\");", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNDQwOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497534408", "bodyText": "I like the -1 addition", "author": "mikehardy", "createdAt": "2020-09-30T14:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYzMw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r487473633", "body": "```suggestion\r\n    public int queryVer() {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public Integer queryVer() {\n          \n          \n            \n                public int queryVer() {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi x x-first x-last\">Integer</span> queryVer() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k x x-first x-last\">int</span> queryVer() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "david-allison-1", "createdAt": "2020-09-13T03:00:26Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Collection.java", "diffHunk": "@@ -2134,6 +2134,10 @@ public Context getContext() {\n         return getDb().queryLongList(\"select id from cards where id in \" + Utils.ids2str(cards));\n     }\n \n+    public Integer queryVer() {", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNDc2Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497534763", "bodyText": "I prefer types that can't go null personally", "author": "mikehardy", "createdAt": "2020-09-30T14:02:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ3MzYzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUzNjM0OA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7075#discussion_r497536348", "body": "would prefer a constant -1 int unknown, and a real value here. It's a concrete thing the idea of a version, and seems like it should be strictly known as a real integer or a known constant (-1) that is unknown, with a real Exception if it's unrecoverably busted. I just don't like Nulls really, I'll admit it.", "bodyText": "would prefer a constant -1 int unknown, and a real value here. It's a concrete thing the idea of a version, and seems like it should be strictly known as a real integer or a known constant (-1) that is unknown, with a real Exception if it's unrecoverably busted. I just don't like Nulls really, I'll admit it.", "bodyHTML": "<p dir=\"auto\">would prefer a constant -1 int unknown, and a real value here. It's a concrete thing the idea of a version, and seems like it should be strictly known as a real integer or a known constant (-1) that is unknown, with a real Exception if it's unrecoverably busted. I just don't like Nulls really, I'll admit it.</p>", "author": "mikehardy", "createdAt": "2020-09-30T14:04:06Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Storage.java", "diffHunk": "@@ -45,6 +45,16 @@ public static Collection Collection(Context context, String path) {\n         return Collection(context, path, false, false);\n     }\n \n+    @Nullable\n+    public static Integer getDatabaseVersion(String path) {", "originalCommit": "2cfa1e28608e36c67ea0bf4c7e277b65d4bfb465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "url": "https://github.com/ankidroid/Anki-Android/commit/98cd640b9336d4deb4cafa1d0fd9bc2d0a8ec036", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T11:44:07Z", "type": "forcePushed"}, {"oid": "954feb3e0aa442d7bf1e337604c032d9795fe55a", "url": "https://github.com/ankidroid/Anki-Android/commit/954feb3e0aa442d7bf1e337604c032d9795fe55a", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T13:45:48Z", "type": "forcePushed"}, {"oid": "0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "url": "https://github.com/ankidroid/Anki-Android/commit/0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T18:48:22Z", "type": "commit"}, {"oid": "0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "url": "https://github.com/ankidroid/Anki-Android/commit/0c74fccac1bd9cf79281bd2da548d8a7525c5d9d", "message": "Show useful error when col version is too high\n\nThis means that the database has been upgraded, and there is currently no\nway of downgrading from an earlier version\n\nFixes 7072", "committedDate": "2020-10-01T18:48:22Z", "type": "forcePushed"}]}