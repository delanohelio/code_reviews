{"pr_number": 6453, "pr_title": "Strip spaces in deck name", "pr_author": "Arthur-Milchior", "pr_createdAt": "2020-06-13T12:15:04Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/6453", "timeline": [{"oid": "8315849aee4669996e25a5e95b345a8834c87c1d", "url": "https://github.com/ankidroid/Anki-Android/commit/8315849aee4669996e25a5e95b345a8834c87c1d", "message": "Strip spaces in deck name\n\nStarting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\n\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\n\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through `id` which\ncreates deck, and through `rename`). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\".", "committedDate": "2020-06-13T12:30:26Z", "type": "commit"}, {"oid": "8315849aee4669996e25a5e95b345a8834c87c1d", "url": "https://github.com/ankidroid/Anki-Android/commit/8315849aee4669996e25a5e95b345a8834c87c1d", "message": "Strip spaces in deck name\n\nStarting with 2.1.28, anki strip deck's name. I imitate it. I don't\nuse the same code as they do it in rust and we don't have rust yet.\n\nHowever, since this create compatibility problems between anki and\nankidroid during some sync ( see\nhttps://forums.ankiweb.net/t/decks-with-trailing-spaces/89/4?u=arthurmilchior\n) I believe it should be considered without waiting for\nrust. Especially since it's a small change in term of code.\n\nThe spaces are stripped in two places: when checking for deck\nintegrity, and when changing deck name (i.e. through `id` which\ncreates deck, and through `rename`). No need currently to use it in\nbyName, since it is only called with names already stripped and with\nthe constant \"Custom study session\".", "committedDate": "2020-06-13T12:30:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2MzY0MQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r439763641", "body": "```suggestion\r\n    /** With 2.1.28, anki started strips whitespace of deck name.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** With .28, anki started strips whitespace of deck name.\n          \n          \n            \n                /** With 2.1.28, anki started strips whitespace of deck name.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">/*</span>* With .28, anki started strips whitespace of deck name.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">/*</span>* With <span class=\"x x-first x-last\">2.1</span>.28, anki started strips whitespace of deck name.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mikehardy", "createdAt": "2020-06-13T19:36:27Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n+    private static String strip(String deckName) {\n+        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n+    }\n+\n+    /** With .28, anki started strips whitespace of deck name.", "originalCommit": "8315849aee4669996e25a5e95b345a8834c87c1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "456b8a9036adde0def848bad303ef06e5a40c5df", "url": "https://github.com/ankidroid/Anki-Android/commit/456b8a9036adde0def848bad303ef06e5a40c5df", "message": "Update AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java\n\nCo-authored-by: Mike Hardy <github@mikehardy.net>", "committedDate": "2020-06-13T20:23:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441374997", "body": "`sSpaceAroundSeparator`", "bodyText": "sSpaceAroundSeparator", "bodyHTML": "<p dir=\"auto\"><code>sSpaceAroundSeparator</code></p>", "author": "david-allison-1", "createdAt": "2020-06-17T08:31:48Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");", "originalCommit": "456b8a9036adde0def848bad303ef06e5a40c5df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NTM1Mw==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441375353", "bodyText": "Is this the same pattern as the one that Anki uses? Will have have problems such as the triple-colon that you previously solved?", "author": "david-allison-1", "createdAt": "2020-06-17T08:32:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwMzMxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441403311", "bodyText": "No triple column problem. The 3rd columnis the first letter of the deck nme, so no reason to strip ant space.\nI have not found where this change is made in rust, so can't tell whether this regexp is used", "author": "Arthur-Milchior", "createdAt": "2020-06-17T09:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NDk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441376019", "body": "Have you tested this on decks with duplicate names and different spacing?\r\nHave you tested this on decks which would normalise to the same name: \"Foo\" and \" FOO \"\r\n\r\nCan the user currently call their deck \"\", or \" \", would this generate an invalid name? What happens in Anki Desktop?", "bodyText": "Have you tested this on decks with duplicate names and different spacing?\nHave you tested this on decks which would normalise to the same name: \"Foo\" and \" FOO \"\nCan the user currently call their deck \"\", or \" \", would this generate an invalid name? What happens in Anki Desktop?", "bodyHTML": "<p dir=\"auto\">Have you tested this on decks with duplicate names and different spacing?<br>\nHave you tested this on decks which would normalise to the same name: \"Foo\" and \" FOO \"</p>\n<p dir=\"auto\">Can the user currently call their deck \"\", or \" \", would this generate an invalid name? What happens in Anki Desktop?</p>", "author": "david-allison-1", "createdAt": "2020-06-17T08:33:29Z", "path": "AnkiDroid/src/main/java/com/ichi2/libanki/Decks.java", "diffHunk": "@@ -777,6 +779,27 @@ private void maybeAddToActive() {\n                 \"select id from cards where did in \" + Utils.ids2str(Utils.arrayList2array(dids)), 0));\n     }\n \n+\n+    private static final Pattern spaceAroundSeparator = Pattern.compile(\" *:: *\");\n+    private static String strip(String deckName) {\n+        return spaceAroundSeparator.matcher(deckName.trim()).replaceAll( \"::\");\n+    }\n+\n+    /** With 2.1.28, anki started strips whitespace of deck name.\n+     * This method is here for compatibility while we wait for rust.\n+     * It should be executed before other methods, because both \"FOO \" and \"FOO\" will be renamed to the same name,\n+     * and so this will need to be renamed by _checkDeckTree.*/\n+    private void _removeSpaces () {\n+        for (JSONObject deck: all()) {", "originalCommit": "456b8a9036adde0def848bad303ef06e5a40c5df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNDQ1Ng==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441404456", "bodyText": "Duplicate name and different spacing was mentionned above. I don t know whether \" \" used to be valid, im pretty sure that \"\" was already not valid", "author": "Arthur-Milchior", "createdAt": "2020-06-17T09:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxNTgyNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441415825", "bodyText": "Just checked: \"FOO   \" is detected to be the same deck as \"foo\" so can't be created. Creating a deck is just ignored. Renaming is rejected with a message stating that this deck already exists.\nI just discovered that ankidroid accepts to create the deck \"\". (and that \"   \" is renamed as \"\", but I was expecting that)", "author": "Arthur-Milchior", "createdAt": "2020-06-17T09:36:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNTYzNQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/6453#discussion_r441435635", "bodyText": "\"\" is rejected upstream, while \" \" is accepted and then renamed to \"blank\". I corrected it in ankitects/anki#669", "author": "Arthur-Milchior", "createdAt": "2020-06-17T10:09:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjAxOQ=="}], "type": "inlineReview"}]}