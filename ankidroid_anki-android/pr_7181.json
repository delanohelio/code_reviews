{"pr_number": 7181, "pr_title": "Add \"Search Decks\" to Deck Picker", "pr_author": "david-allison-1", "pr_createdAt": "2020-09-20T20:10:24Z", "pr_url": "https://github.com/ankidroid/Anki-Android/pull/7181", "timeline": [{"oid": "ad9b87693a9d4705d77e70b95c71d5f0b69cbdff", "url": "https://github.com/ankidroid/Anki-Android/commit/ad9b87693a9d4705d77e70b95c71d5f0b69cbdff", "message": "NF: Deck Picker: Extract getNodeByDid", "committedDate": "2020-09-19T21:45:13Z", "type": "commit"}, {"oid": "bb439f6ed238ee2c1e323cdaabd1415c90427d29", "url": "https://github.com/ankidroid/Anki-Android/commit/bb439f6ed238ee2c1e323cdaabd1415c90427d29", "message": "NF: Add FilterResultsUtils\n\nQuick harmless refactoring to reduce code\n\nTo be used again in 7116", "committedDate": "2020-09-20T19:50:15Z", "type": "commit"}, {"oid": "86c26f1d4014284c757ade154f3f930c3f5e102a", "url": "https://github.com/ankidroid/Anki-Android/commit/86c26f1d4014284c757ade154f3f930c3f5e102a", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116", "committedDate": "2020-09-20T20:14:05Z", "type": "forcePushed"}, {"oid": "c1316eba3f37d62abf936c2722c52c68f25a63f4", "url": "https://github.com/ankidroid/Anki-Android/commit/c1316eba3f37d62abf936c2722c52c68f25a63f4", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116", "committedDate": "2020-09-20T20:40:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc2NzkxMQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#discussion_r491767911", "body": "Extract this above", "bodyText": "Extract this above", "bodyHTML": "<p dir=\"auto\">Extract this above</p>", "author": "david-allison-1", "createdAt": "2020-09-21T02:18:09Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/DeckPicker.java", "diffHunk": "@@ -2384,11 +2411,15 @@ public void __renderPage() {\n             if (getSupportActionBar() != null) {\n                 getSupportActionBar().setSubtitle(null);\n             }\n+            if (mToolbarSearchView != null) {\n+                mDeckListAdapter.getFilter().filter(mToolbarSearchView.getQuery());\n+            }\n             // We're done here\n             return;\n         }\n \n-        mDeckListAdapter.buildDeckList(mDueTree, getCol());\n+        CharSequence filter = mToolbarSearchView != null ? mToolbarSearchView.getQuery() : null;", "originalCommit": "c1316eba3f37d62abf936c2722c52c68f25a63f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc2ODA3OQ==", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#discussion_r491768079", "body": "Only necessary to add a private constructor - needs no code", "bodyText": "Only necessary to add a private constructor - needs no code", "bodyHTML": "<p dir=\"auto\">Only necessary to add a private constructor - needs no code</p>", "author": "david-allison-1", "createdAt": "2020-09-21T02:19:16Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/widgets/DeckAdapter.java", "diffHunk": "@@ -346,7 +361,87 @@ public Integer getDue() {\n         }\n     }\n \n-    public List<AbstractDeckTreeNode> getDeckList() {\n-        return mDeckList;\n+    private List<AbstractDeckTreeNode> getDeckList() {\n+        return mCurrentDeckList;\n+    }\n+\n+\n+    @Override\n+    public Filter getFilter() {\n+        return new DeckFilter();\n+    }\n+\n+\n+    private class DeckFilter extends Filter {\n+        private ArrayList<AbstractDeckTreeNode> mFilteredDecks;\n+        private DeckFilter() {\n+            super();", "originalCommit": "c1316eba3f37d62abf936c2722c52c68f25a63f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTc2ODIyOA==", "url": "https://github.com/ankidroid/Anki-Android/pull/7181#discussion_r491768228", "body": "```suggestion\r\n            // If a deck contains the string, then all its children are valid\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // If a deck contains the string, then all ts children are valid\n          \n          \n            \n                        // If a deck contains the string, then all its children are valid", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> If a deck contains the string, then all <span class=\"x x-first x-last\">ts</span> children are valid</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> If a deck contains the string, then all <span class=\"x x-first x-last\">its</span> children are valid</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "david-allison-1", "createdAt": "2020-09-21T02:20:01Z", "path": "AnkiDroid/src/main/java/com/ichi2/anki/widgets/DeckAdapter.java", "diffHunk": "@@ -346,7 +361,87 @@ public Integer getDue() {\n         }\n     }\n \n-    public List<AbstractDeckTreeNode> getDeckList() {\n-        return mDeckList;\n+    private List<AbstractDeckTreeNode> getDeckList() {\n+        return mCurrentDeckList;\n+    }\n+\n+\n+    @Override\n+    public Filter getFilter() {\n+        return new DeckFilter();\n+    }\n+\n+\n+    private class DeckFilter extends Filter {\n+        private ArrayList<AbstractDeckTreeNode> mFilteredDecks;\n+        private DeckFilter() {\n+            super();\n+            mFilteredDecks = new ArrayList<>();\n+        }\n+\n+        private List<AbstractDeckTreeNode> getAllDecks() {\n+            return mDeckList;\n+        }\n+\n+        @Override\n+        protected FilterResults performFiltering(CharSequence constraint) {\n+            mFilteredDecks.clear();\n+\n+            List<AbstractDeckTreeNode> allDecks = getAllDecks();\n+            if (TextUtils.isEmpty(constraint)) {\n+                mFilteredDecks.addAll(allDecks);\n+            } else {\n+                final String filterPattern = constraint.toString().toLowerCase().trim();\n+                List<AbstractDeckTreeNode> filteredDecks = filterDecks(filterPattern, allDecks);\n+                mFilteredDecks.addAll(filteredDecks);\n+            }\n+\n+            return FilterResultsUtils.fromCollection(mFilteredDecks);\n+        }\n+\n+        @Override\n+        protected void publishResults(CharSequence constraint, FilterResults results) {\n+            mCurrentDeckList.clear();\n+            mCurrentDeckList.addAll(mFilteredDecks);\n+            notifyDataSetChanged();\n+        }\n+\n+\n+        private List<AbstractDeckTreeNode> filterDecks(String filterPattern, List<AbstractDeckTreeNode> allDecks) {\n+            ArrayList<AbstractDeckTreeNode> ret = new ArrayList<>();\n+            for (AbstractDeckTreeNode tag : allDecks) {\n+                AbstractDeckTreeNode node = filterDeckInternal(filterPattern, tag);\n+                if (node != null) {\n+                    ret.add(node);\n+                }\n+            }\n+            return ret;\n+        }\n+\n+        @Nullable\n+        private <T extends AbstractDeckTreeNode<T>> T filterDeckInternal(String filterPattern, T root) {\n+\n+            // If a deck contains the string, then all ts children are valid", "originalCommit": "c1316eba3f37d62abf936c2722c52c68f25a63f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "url": "https://github.com/ankidroid/Anki-Android/commit/2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116", "committedDate": "2020-09-21T15:38:48Z", "type": "commit"}, {"oid": "2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "url": "https://github.com/ankidroid/Anki-Android/commit/2d19efd0bcb3e1a6b6a209bc8c8b7aa69a8c13cf", "message": "Add \"Search\" to Deck Picker\n\nFixes 7116", "committedDate": "2020-09-21T15:38:48Z", "type": "forcePushed"}]}