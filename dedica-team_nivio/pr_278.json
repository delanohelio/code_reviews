{"pr_number": 278, "pr_title": "[#277] refactor: separate hex code better from svg code", "pr_author": "bonndan", "pr_createdAt": "2020-09-14T20:35:34Z", "pr_url": "https://github.com/dedica-team/nivio/pull/278", "timeline": [{"oid": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "url": "https://github.com/dedica-team/nivio/commit/e508eac0f3540edc1e0b086ade2b3e45e3f44044", "message": "[#277] refactor: separate hex code better from svg code", "committedDate": "2020-09-14T20:34:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc0ODM3Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488748373", "body": "Small formatting problem.", "bodyText": "Small formatting problem.", "bodyHTML": "<p dir=\"auto\">Small formatting problem.</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:13:15Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex 5b518d07..03026442 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n", "chunk": "@@ -18,10 +18,11 @@ public class GroupAreaFactory {\n \n     /**\n      * Builds an areas of hex tiles belonging to a group.\n-     *  @param occupied    tiles occupied by items\n-     * @param group       the group\n-     * @param vertexHexes a mapping from item to its hex\n-     * @param relationPaths   existing paths\n+     *\n+     * @param occupied      tiles occupied by items\n+     * @param group         the group\n+     * @param vertexHexes   a mapping from item to its hex\n+     * @param relationPaths existing paths\n      * @return\n      */\n     public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n", "next_change": {"commit": "95f0f655f473a46efe6639533a43723007e8c54f", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex 03026442..adf6e5e4 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n", "chunk": "@@ -19,13 +19,19 @@ public class GroupAreaFactory {\n     /**\n      * Builds an areas of hex tiles belonging to a group.\n      *\n+     * It works as follows: first we circumnavigate all hexes of items and add their neighbours immediately. Then we\n+     * iterate over all one-hex gaps and add them. This iteration is repeated, so that effectively a few two-hex gaps are\n+     * filled.\n+     *\n+     * There is clearly much room for improvement here. It's only that I haven't found a better approach so far.\n+     *\n      * @param occupied      tiles occupied by items\n      * @param group         the group\n      * @param vertexHexes   a mapping from item to its hex\n-     * @param relationPaths existing paths\n-     * @return\n+     * @param pathsWithinGroup existing paths\n+     * @return all hexes the group consists of (an area)\n      */\n-    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n+    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> pathsWithinGroup) {\n \n         Set<Item> items = group.getItems();\n         Set<Hex> inArea = new HashSet<>();\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NDIyNw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488754227", "body": "I guess the check could be extracted into a separate method, e.g. ``isInGroup()``:\r\n\r\n    .filter(rel -> rel.getTarget().isInGroup(group.getIdentifier())", "bodyText": "I guess the check could be extracted into a separate method, e.g. isInGroup():\n.filter(rel -> rel.getTarget().isInGroup(group.getIdentifier())", "bodyHTML": "<p dir=\"auto\">I guess the check could be extracted into a separate method, e.g. <code>isInGroup()</code>:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\".filter(rel -&gt; rel.getTarget().isInGroup(group.getIdentifier())\"><pre><code>.filter(rel -&gt; rel.getTarget().isInGroup(group.getIdentifier())\n</code></pre></div>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:20:49Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items\n+     * @param group       the group\n+     * @param vertexHexes a mapping from item to its hex\n+     * @param relationPaths   existing paths\n+     * @return\n+     */\n+    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n+\n+        Set<Item> items = group.getItems();\n+        Set<Hex> inArea = new HashSet<>();\n+\n+        //surround each item\n+        items.forEach(item -> {\n+            Hex hex = vertexHexes.get(item);\n+            inArea.add(hex);\n+            hex.neighbours().forEach(neigh -> {\n+                if (!occupied.contains(neigh))\n+                    inArea.add(neigh);\n+            });\n+\n+            //add all \"inner\" relations (paths)\n+            relationPaths.stream()\n+                    .filter(rel -> rel.getSource().equals(item))\n+                    .filter(rel -> rel.getTarget().getGroup() != null)\n+                    .filter(rel -> rel.getTarget().getGroup().equals(group.getIdentifier()))", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODA1MA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908050", "bodyText": "The solution is now that only matching paths are passed as parameter, so filtering is not necessary here anymore.", "author": "bonndan", "createdAt": "2020-09-15T19:17:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NDIyNw=="}], "type": "inlineReview", "revised_code": {"commit": "95f0f655f473a46efe6639533a43723007e8c54f", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex 5b518d07..adf6e5e4 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n", "chunk": "@@ -39,11 +46,7 @@ public class GroupAreaFactory {\n             });\n \n             //add all \"inner\" relations (paths)\n-            relationPaths.stream()\n-                    .filter(rel -> rel.getSource().equals(item))\n-                    .filter(rel -> rel.getTarget().getGroup() != null)\n-                    .filter(rel -> rel.getTarget().getGroup().equals(group.getIdentifier()))\n-                    .forEach(rel -> inArea.addAll(rel.getHexes()));\n+            pathsWithinGroup.forEach(rel -> inArea.addAll(rel.getHexes()));\n         });\n \n         Set<Hex> bridges = getBridges(inArea);\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NjA2Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488756063", "body": "I do not know how this works in detail. But is it expected to always terminate in 2 iterations?", "bodyText": "I do not know how this works in detail. But is it expected to always terminate in 2 iterations?", "bodyHTML": "<p dir=\"auto\">I do not know how this works in detail. But is it expected to always terminate in 2 iterations?</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:23:24Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items\n+     * @param group       the group\n+     * @param vertexHexes a mapping from item to its hex\n+     * @param relationPaths   existing paths\n+     * @return\n+     */\n+    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n+\n+        Set<Item> items = group.getItems();\n+        Set<Hex> inArea = new HashSet<>();\n+\n+        //surround each item\n+        items.forEach(item -> {\n+            Hex hex = vertexHexes.get(item);\n+            inArea.add(hex);\n+            hex.neighbours().forEach(neigh -> {\n+                if (!occupied.contains(neigh))\n+                    inArea.add(neigh);\n+            });\n+\n+            //add all \"inner\" relations (paths)\n+            relationPaths.stream()\n+                    .filter(rel -> rel.getSource().equals(item))\n+                    .filter(rel -> rel.getTarget().getGroup() != null)\n+                    .filter(rel -> rel.getTarget().getGroup().equals(group.getIdentifier()))\n+                    .forEach(rel -> inArea.addAll(rel.getHexes()));\n+        });\n+\n+        Set<Hex> bridges = getBridges(inArea);\n+        inArea.addAll(bridges);\n+\n+        //2nd pass fills gaps\n+        bridges = getBridges(inArea);\n+        inArea.addAll(bridges);", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTAzMA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488851030", "bodyText": "It works as follows: first we circumnavigate all hexes of items and add their neighbours immediately. Then we iterate over all one-hex gaps and add them. This iteration is repeated, so that effectively a few two-hex gaps were filled.\nThere is clearly much room for improvement here. It's only that I haven't found a bettter approach so far.", "author": "bonndan", "createdAt": "2020-09-15T17:42:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NjA2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4NDYzNg==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488884636", "bodyText": "That explanation would be a greate code comment.", "author": "Matthimatiker", "createdAt": "2020-09-15T18:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc1NjA2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex 5b518d07..03026442 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n", "chunk": "@@ -56,8 +57,14 @@ public class GroupAreaFactory {\n         return inArea;\n     }\n \n+    /**\n+     * Finds neighbours of in-area tiles which have in-area neighbours at adjacent sides (gaps).\n+     *\n+     * @param inArea all hexes in area\n+     * @return all hexes which fill gaps\n+     */\n     static Set<Hex> getBridges(Set<Hex> inArea) {\n-        //find neighbours of in-area tiles which have in-area neighbours at adjacent sides\n+\n         Set<Hex> bridges = new HashSet<>();\n         inArea.forEach(hex -> {\n             hex.neighbours().forEach(neighbour -> {\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTM1Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488761353", "body": "What are bridges? Empty gaps between 2 Hexes? \r\nA brief description would help here.", "bodyText": "What are bridges? Empty gaps between 2 Hexes?\nA brief description would help here.", "bodyHTML": "<p dir=\"auto\">What are bridges? Empty gaps between 2 Hexes?<br>\nA brief description would help here.</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:30:19Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.*;\n+\n+/**\n+ * Collects all hexes close to group item hexes to create an area.\n+ */\n+public class GroupAreaFactory {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(GroupAreaFactory.class);\n+\n+    /**\n+     * Builds an areas of hex tiles belonging to a group.\n+     *  @param occupied    tiles occupied by items\n+     * @param group       the group\n+     * @param vertexHexes a mapping from item to its hex\n+     * @param relationPaths   existing paths\n+     * @return\n+     */\n+    public static Set<Hex> getGroup(Set<Hex> occupied, Group group, Map<LandscapeItem, Hex> vertexHexes, List<HexPath> relationPaths) {\n+\n+        Set<Item> items = group.getItems();\n+        Set<Hex> inArea = new HashSet<>();\n+\n+        //surround each item\n+        items.forEach(item -> {\n+            Hex hex = vertexHexes.get(item);\n+            inArea.add(hex);\n+            hex.neighbours().forEach(neigh -> {\n+                if (!occupied.contains(neigh))\n+                    inArea.add(neigh);\n+            });\n+\n+            //add all \"inner\" relations (paths)\n+            relationPaths.stream()\n+                    .filter(rel -> rel.getSource().equals(item))\n+                    .filter(rel -> rel.getTarget().getGroup() != null)\n+                    .filter(rel -> rel.getTarget().getGroup().equals(group.getIdentifier()))\n+                    .forEach(rel -> inArea.addAll(rel.getHexes()));\n+        });\n+\n+        Set<Hex> bridges = getBridges(inArea);\n+        inArea.addAll(bridges);\n+\n+        //2nd pass fills gaps\n+        bridges = getBridges(inArea);\n+        inArea.addAll(bridges);\n+\n+        return inArea;\n+    }\n+\n+    static Set<Hex> getBridges(Set<Hex> inArea) {", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg1MTI3OA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488851278", "bodyText": "correct. I've added an explanation.", "author": "bonndan", "createdAt": "2020-09-15T17:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MTM1Mw=="}], "type": "inlineReview", "revised_code": {"commit": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\nindex 5b518d07..03026442 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/GroupAreaFactory.java\n", "chunk": "@@ -56,8 +57,14 @@ public class GroupAreaFactory {\n         return inArea;\n     }\n \n+    /**\n+     * Finds neighbours of in-area tiles which have in-area neighbours at adjacent sides (gaps).\n+     *\n+     * @param inArea all hexes in area\n+     * @return all hexes which fill gaps\n+     */\n     static Set<Hex> getBridges(Set<Hex> inArea) {\n-        //find neighbours of in-area tiles which have in-area neighbours at adjacent sides\n+\n         Set<Hex> bridges = new HashSet<>();\n         inArea.forEach(hex -> {\n             hex.neighbours().forEach(neighbour -> {\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MjM3Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488762373", "body": "I guess this is nullable?", "bodyText": "I guess this is nullable?", "bodyHTML": "<p dir=\"auto\">I guess this is nullable?</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:31:44Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/Hex.java", "diffHunk": "@@ -39,6 +41,7 @@\n     public final int r;\n     public final int s;\n     public String id;\n+    public Item item;", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODE0Mg==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908142", "bodyText": "has been removed", "author": "bonndan", "createdAt": "2020-09-15T19:17:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MjM3Mw=="}], "type": "inlineReview", "revised_code": {"commit": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\nindex 3c183edd..19d7fcfa 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n", "chunk": "@@ -37,9 +37,21 @@ public class Hex {\n     //double DEFAULT_ICON_SIZE\n     public static final int HEX_SIZE = 2 * DEFAULT_ICON_SIZE;\n \n+    /**\n+     * q coordinate\n+     */\n     public final int q;\n+\n+    /**\n+     * r coordinate\n+     */\n     public final int r;\n+\n+    /**\n+     * s coordinate (could be omitted here, since q + r + s = 0 is mandatory)\n+     */\n     public final int s;\n+\n     public String id;\n     public Item item;\n \n", "next_change": {"commit": "2559b5170fa42f8d2ec52b9a2353b5024062e7e9", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\nindex 19d7fcfa..3f56fcdb 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n", "chunk": "@@ -53,7 +55,6 @@ public class Hex {\n     public final int s;\n \n     public String id;\n-    public Item item;\n \n     public Hex(int q, int r, int s) {\n         if (q + r + s != 0) {\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MzMyNw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488763327", "body": "Naming is so important...", "bodyText": "Naming is so important...", "bodyHTML": "<p dir=\"auto\">Naming is so important...</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:33:01Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/Hex.java", "diffHunk": "@@ -39,6 +41,7 @@\n     public final int r;\n     public final int s;", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyOTI4MQ==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488829281", "bodyText": "These are common names for hex coordinates. I've added field descriptions.", "author": "bonndan", "createdAt": "2020-09-15T17:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2MzMyNw=="}], "type": "inlineReview", "revised_code": {"commit": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\nindex 3c183edd..19d7fcfa 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n", "chunk": "@@ -37,9 +37,21 @@ public class Hex {\n     //double DEFAULT_ICON_SIZE\n     public static final int HEX_SIZE = 2 * DEFAULT_ICON_SIZE;\n \n+    /**\n+     * q coordinate\n+     */\n     public final int q;\n+\n+    /**\n+     * r coordinate\n+     */\n     public final int r;\n+\n+    /**\n+     * s coordinate (could be omitted here, since q + r + s = 0 is mandatory)\n+     */\n     public final int s;\n+\n     public String id;\n     public Item item;\n \n", "next_change": {"commit": "2559b5170fa42f8d2ec52b9a2353b5024062e7e9", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\nindex 19d7fcfa..3f56fcdb 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/Hex.java\n", "chunk": "@@ -53,7 +55,6 @@ public class Hex {\n     public final int s;\n \n     public String id;\n-    public Item item;\n \n     public Hex(int q, int r, int s) {\n         if (q + r + s != 0) {\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2Mzg2Ng==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488763866", "body": "This could also be final.", "bodyText": "This could also be final.", "bodyHTML": "<p dir=\"auto\">This could also be final.</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:33:47Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.layout.LayoutedComponent;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.springframework.lang.Nullable;\n+\n+import java.util.*;\n+\n+/**\n+ * Representation of a hex map.\n+ *\n+ *\n+ *\n+ */\n+public class HexMap {\n+\n+    private final Set<Hex> occupied = new HashSet<>();\n+    private final boolean debug;\n+    private final Map<LandscapeItem, Hex> vertexHexes = new HashMap<>();\n+    private final PathFinder pathFinder;\n+    private List<HexPath> paths = new ArrayList<>();", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java b/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\nindex ccab1199..9c003979 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\n", "chunk": "@@ -21,7 +21,7 @@ public class HexMap {\n     private final boolean debug;\n     private final Map<LandscapeItem, Hex> vertexHexes = new HashMap<>();\n     private final PathFinder pathFinder;\n-    private List<HexPath> paths = new ArrayList<>();\n+    private final List<HexPath> paths = new ArrayList<>();\n \n     public HexMap(boolean debug) {\n         this.debug = debug;\n", "next_change": {"commit": "95f0f655f473a46efe6639533a43723007e8c54f", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java b/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\nindex 9c003979..8cb1397e 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\n", "chunk": "@@ -18,18 +19,21 @@ import java.util.*;\n public class HexMap {\n \n     private final Set<Hex> occupied = new HashSet<>();\n-    private final boolean debug;\n     private final Map<LandscapeItem, Hex> vertexHexes = new HashMap<>();\n     private final PathFinder pathFinder;\n     private final List<HexPath> paths = new ArrayList<>();\n \n     public HexMap(boolean debug) {\n-        this.debug = debug;\n         // find and render relations\n         pathFinder = new PathFinder(occupied);\n-        pathFinder.debug = this.debug;\n+        pathFinder.debug = debug;\n     }\n \n+    /**\n+     * Add a previously layouted item to the map.\n+     *\n+     * @param layoutedItem landscape item plus coordinates\n+     */\n     public void add(LayoutedComponent layoutedItem) {\n         Hex hex = null;\n         int i = 0;\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NTQ3Mg==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488765472", "body": "Why is this obsolete? Can it be removed?", "bodyText": "Why is this obsolete? Can it be removed?", "bodyHTML": "<p dir=\"auto\">Why is this obsolete? Can it be removed?</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:36:08Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package de.bonndan.nivio.output.map.hex;\n+\n+import de.bonndan.nivio.model.Group;\n+import de.bonndan.nivio.model.Item;\n+import de.bonndan.nivio.model.LandscapeItem;\n+import de.bonndan.nivio.output.layout.LayoutedComponent;\n+import de.bonndan.nivio.output.map.svg.HexPath;\n+import org.springframework.lang.Nullable;\n+\n+import java.util.*;\n+\n+/**\n+ * Representation of a hex map.\n+ *\n+ *\n+ *\n+ */\n+public class HexMap {\n+\n+    private final Set<Hex> occupied = new HashSet<>();\n+    private final boolean debug;\n+    private final Map<LandscapeItem, Hex> vertexHexes = new HashMap<>();\n+    private final PathFinder pathFinder;\n+    private List<HexPath> paths = new ArrayList<>();\n+\n+    public HexMap(boolean debug) {\n+        this.debug = debug;\n+        // find and render relations\n+        pathFinder = new PathFinder(occupied);\n+        pathFinder.debug = this.debug;\n+    }\n+\n+    public void add(LayoutedComponent layoutedItem) {\n+        Hex hex = null;\n+        int i = 0;\n+        while (hex == null || occupied.contains(hex)) {\n+            hex = Hex.of(Math.round(layoutedItem.getX()) - i, Math.round(layoutedItem.getY()) - i);\n+            i++;\n+        }\n+\n+        Item item = (Item) layoutedItem.getComponent();\n+        hex.id = item.getFullyQualifiedIdentifier().jsonValue();\n+        hex.item = item;\n+        vertexHexes.put(item, hex); //this is obsolete", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgzMDg2Mw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488830863", "bodyText": "This is the mapping between landscape items and hexes on the map. If we store Item inside Hex, this mapping is obsolete. However, as you pointed out below, Item is pushed deeper and deeper into the hex package.", "author": "bonndan", "createdAt": "2020-09-15T17:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NTQ3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODU1NA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908554", "bodyText": "not obsolete anymore", "author": "bonndan", "createdAt": "2020-09-15T19:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NTQ3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "a1b223a7f6179154bb8170af9afa67ffec0f4a33", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java b/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\nindex ccab1199..27e2e660 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/HexMap.java\n", "chunk": "@@ -45,24 +46,48 @@ public class HexMap {\n         occupied.add(hex);\n     }\n \n+    /**\n+     * Returns the hex tile of an {@link Item}\n+     *\n+     * @param item the item (must have been added before)\n+     * @return the corresponding {@link Hex}\n+     */\n     public Hex hexForItem(Item item) {\n         return vertexHexes.get(item);\n     }\n \n+    /**\n+     * Uses the pathfinder to create a path between start and target.\n+     *\n+     * @param start  the relation source item\n+     * @param target the relation target item\n+     * @return a path if one could be found\n+     */\n     @Nullable\n-    public HexPath getPath(Item item, Item target) {\n-        HexPath path = pathFinder.getPath(hexForItem(item), hexForItem(target));\n+    public HexPath getPath(Item start, Item target) {\n+        HexPath path = pathFinder.getPath(hexForItem(start), hexForItem(target));\n+        if (path == null) {\n+            return null;\n+        }\n+\n+        if (start.getGroup() != null && start.getGroup().equals(target.getGroup())) {\n+            path.setGroup(start.getGroup());\n+        }\n+\n         paths.add(path);\n         return path;\n     }\n \n     /**\n-     * Returns all hexes which from a group area.\n+     * Returns all hexes which form a group area.\n      *\n      * @param group the group with items\n      * @return a set of (adjacent) hexes\n      */\n     public Set<Hex> getGroupArea(Group group) {\n-        return GroupAreaFactory.getGroup(occupied, group, vertexHexes, paths);\n+        List<HexPath> pathsWithinGroup = paths.stream()\n+                .filter(hexPath -> hexPath.getGroup().equals(group.getIdentifier()))\n+                .collect(Collectors.toList());\n+        return GroupAreaFactory.getGroup(occupied, group, vertexHexes, pathsWithinGroup);\n     }\n }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc2NjY0NA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488766644", "body": "What is ``collect``? The path? The hexes between ``startHex`` and ``destHex``?", "bodyText": "What is collect? The path? The hexes between startHex and destHex?", "bodyHTML": "<p dir=\"auto\">What is <code>collect</code>? The path? The hexes between <code>startHex</code> and <code>destHex</code>?</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T15:37:40Z", "path": "src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java", "diffHunk": "@@ -187,7 +187,7 @@ public HexPath getPath(Hex startHex, Hex destHex) {\n             return null;\n \n         List<Hex> collect = path.stream().map(tile -> tile.hex).collect(Collectors.toList());", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java b/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java\nindex 847de3c4..f1d73c9c 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java\n", "chunk": "@@ -186,8 +186,8 @@ public class PathFinder {\n         if (path.isEmpty())\n             return null;\n \n-        List<Hex> collect = path.stream().map(tile -> tile.hex).collect(Collectors.toList());\n-        return new HexPath(startHex.item, destHex.item, collect);\n+        List<Hex> pathOfHexes = path.stream().map(tile -> tile.hex).collect(Collectors.toList());\n+        return new HexPath(startHex.item, destHex.item, pathOfHexes);\n     }\n \n \n", "next_change": {"commit": "95f0f655f473a46efe6639533a43723007e8c54f", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java b/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java\nindex f1d73c9c..6ae68ec6 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/hex/PathFinder.java\n", "chunk": "@@ -183,11 +183,11 @@ public class PathFinder {\n         /*\n          * If no path is found return null.\n          */\n-        if (path.isEmpty())\n+        if (path.isEmpty()) {\n             return null;\n+        }\n \n-        List<Hex> pathOfHexes = path.stream().map(tile -> tile.hex).collect(Collectors.toList());\n-        return new HexPath(startHex.item, destHex.item, pathOfHexes);\n+        return new HexPath(path.stream().map(tile -> tile.hex).collect(Collectors.toList()));\n     }\n \n \n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc5MjYzMA==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488792630", "body": "This pushes domain objects down into the view level.\r\n\r\nAt least that looks like the wrong abstraction level for ``Item``s.", "bodyText": "This pushes domain objects down into the view level.\nAt least that looks like the wrong abstraction level for Items.", "bodyHTML": "<p dir=\"auto\">This pushes domain objects down into the view level.</p>\n<p dir=\"auto\">At least that looks like the wrong abstraction level for <code>Item</code>s.</p>", "author": "Matthimatiker", "createdAt": "2020-09-15T16:14:26Z", "path": "src/main/java/de/bonndan/nivio/output/map/svg/HexPath.java", "diffHunk": "@@ -13,13 +14,19 @@\n  */\n public class HexPath {\n \n+    private final Item source;\n+    private final Item target;", "originalCommit": "e508eac0f3540edc1e0b086ade2b3e45e3f44044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODkwODYzNw==", "url": "https://github.com/dedica-team/nivio/pull/278#discussion_r488908637", "bodyText": "Removed", "author": "bonndan", "createdAt": "2020-09-15T19:18:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc5MjYzMA=="}], "type": "inlineReview", "revised_code": {"commit": "95f0f655f473a46efe6639533a43723007e8c54f", "changed_code": [{"header": "diff --git a/src/main/java/de/bonndan/nivio/output/map/svg/HexPath.java b/src/main/java/de/bonndan/nivio/output/map/svg/HexPath.java\nindex f13bec70..1aa2ab58 100644\n--- a/src/main/java/de/bonndan/nivio/output/map/svg/HexPath.java\n+++ b/src/main/java/de/bonndan/nivio/output/map/svg/HexPath.java\n", "chunk": "@@ -14,19 +16,17 @@ import java.util.List;\n  */\n public class HexPath {\n \n-    private final Item source;\n-    private final Item target;\n+    /**\n+     * Non-empty if the path is within a group\n+     */\n+    private String group = \"\";\n     private final List<Hex> hexes;\n     private List<Hex> bends = null;\n \n     /**\n-     * @param source\n-     * @param target\n      * @param hexes the hex tile chain in correct order.\n      */\n-    public HexPath(Item source, Item target, List<Hex> hexes) {\n-        this.source = source;\n-        this.target = target;\n+    public HexPath(List<Hex> hexes) {\n         this.hexes = hexes;\n     }\n \n", "next_change": null}]}}, {"oid": "64d1a0707e87ebaada8c22ad15edaaae226806ad", "url": "https://github.com/dedica-team/nivio/commit/64d1a0707e87ebaada8c22ad15edaaae226806ad", "message": "[#277] added comments", "committedDate": "2020-09-15T17:22:00Z", "type": "commit"}, {"oid": "95f0f655f473a46efe6639533a43723007e8c54f", "url": "https://github.com/dedica-team/nivio/commit/95f0f655f473a46efe6639533a43723007e8c54f", "message": "[#277] added comments, different solution for in-group paths being added to group area", "committedDate": "2020-09-15T19:11:49Z", "type": "commit"}, {"oid": "cf4912b7d4bbb308ec678661943c927c6f21f883", "url": "https://github.com/dedica-team/nivio/commit/cf4912b7d4bbb308ec678661943c927c6f21f883", "message": "[#277] npe fix", "committedDate": "2020-09-15T19:12:59Z", "type": "commit"}, {"oid": "a1b223a7f6179154bb8170af9afa67ffec0f4a33", "url": "https://github.com/dedica-team/nivio/commit/a1b223a7f6179154bb8170af9afa67ffec0f4a33", "message": "[#277] added comments", "committedDate": "2020-09-15T19:15:02Z", "type": "commit"}, {"oid": "2559b5170fa42f8d2ec52b9a2353b5024062e7e9", "url": "https://github.com/dedica-team/nivio/commit/2559b5170fa42f8d2ec52b9a2353b5024062e7e9", "message": "[#277] removed Hex.item field", "committedDate": "2020-09-15T19:16:21Z", "type": "commit"}, {"oid": "463e24d3e6e28f7b1329e0bacef6d19126be2609", "url": "https://github.com/dedica-team/nivio/commit/463e24d3e6e28f7b1329e0bacef6d19126be2609", "message": "[#277] hexmap returns optional path", "committedDate": "2020-09-15T19:25:35Z", "type": "commit"}]}