{"pr_number": 1171, "pr_title": "Adds BaggagePropagation.allKeyNames and deprecates non-string propagation", "pr_author": "codefromthecrypt", "pr_createdAt": "2020-04-24T06:23:33Z", "pr_url": "https://github.com/openzipkin/brave/pull/1171", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNjk0NA==", "url": "https://github.com/openzipkin/brave/pull/1171#discussion_r414326944", "body": "It might be a tiny bit more performant to presize instead of precopy\r\n\r\n```java\r\nList<String> result = new ArrayList<>(propagation.keys().size()+ baggageKeyNames.size());\r\nresult.addAll(propataion.keys();\r\nresult.addAll(baggageKeyNames);\r\nreturn unmodifiable(result);\r\n```", "bodyText": "It might be a tiny bit more performant to presize instead of precopy\nList<String> result = new ArrayList<>(propagation.keys().size()+ baggageKeyNames.size());\nresult.addAll(propataion.keys();\nresult.addAll(baggageKeyNames);\nreturn unmodifiable(result);", "bodyHTML": "<p dir=\"auto\">It might be a tiny bit more performant to presize instead of precopy</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"List&lt;String&gt; result = new ArrayList&lt;&gt;(propagation.keys().size()+ baggageKeyNames.size());\nresult.addAll(propataion.keys();\nresult.addAll(baggageKeyNames);\nreturn unmodifiable(result);\"><pre><span class=\"pl-k\">List&lt;<span class=\"pl-smi\">String</span>&gt;</span> result <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ArrayList&lt;&gt;</span>(propagation<span class=\"pl-k\">.</span>keys()<span class=\"pl-k\">.</span>size()<span class=\"pl-k\">+</span> baggageKeyNames<span class=\"pl-k\">.</span>size());\nresult<span class=\"pl-k\">.</span>addAll(propataion<span class=\"pl-k\">.</span>keys();\nresult<span class=\"pl-k\">.</span>addAll(baggageKeyNames);\n<span class=\"pl-k\">return</span> unmodifiable(result);</pre></div>", "author": "anuraaga", "createdAt": "2020-04-24T06:28:26Z", "path": "brave/src/main/java/brave/baggage/BaggagePropagation.java", "diffHunk": "@@ -259,6 +240,45 @@ public FactoryBuilder add(BaggagePropagationConfig config) {\n     return delegate.keys();\n   }\n \n+  /**\n+   * Returns the key names used for propagation, including those used for the {@linkplain #keys()\n+   * trace context} and {@linkplain SingleBaggageField#keyNames() baggage}. The result can be cached\n+   * in the same scope as the propagation instance.\n+   *\n+   * <p>This is here for the remote propagation use cases:\n+   * <ul>\n+   *   <li>To generate constants for all key names. ex. gRPC Metadata.Key</li>\n+   *   <li>To iterate fields when missing a get field by name function. ex. OpenTracing TextMap</li>\n+   *   <li>To clear fields on re-usable requests. ex. JMS message</li>\n+   * </ul>\n+   *\n+   * <h3>Details</h3>\n+   * The {@code propagation} parameter is required because there may be multiple tracers with\n+   * different baggage configuration. Also, {@link Propagation} instances can be wrapped, so you\n+   * cannot use {@code instanceof} to identify if baggage is internally supported. For example,\n+   * {@link ExtraFieldPropagation} internally wraps {@link BaggagePropagation}.\n+   *\n+   * <p>This is different than {@link BaggageField#getAll(TraceContext)}, as propagation keys may be\n+   * different than {@link BaggageField#name() baggage field names}.\n+   *\n+   * @param propagation used to extract configuration\n+   * @return a list of remote propagation key names used for trace context and baggage.\n+   * @since 5.12\n+   */\n+  // On OpenTracing TextMap: https://github.com/opentracing/opentracing-java/issues/305\n+  public static List<String> allKeyNames(Propagation<String> propagation) {\n+    if (propagation == null) throw new NullPointerException(\"propagation == null\");\n+    // When baggage or similar is in use, the result != TraceContextOrSamplingFlags.EMPTY\n+    TraceContextOrSamplingFlags emptyExtraction =\n+      propagation.extractor((c, k) -> null).extract(Boolean.TRUE);\n+    List<String> baggageKeyNames = ExtraBaggageContext.getAllKeyNames(emptyExtraction);\n+    if (baggageKeyNames.isEmpty()) return propagation.keys();\n+\n+    List<String> result = new ArrayList<>(propagation.keys());", "originalCommit": "a71b3c5bb583b7a5e9e537f14536af0f421e9788", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyOTcwOA==", "url": "https://github.com/openzipkin/brave/pull/1171#discussion_r414329708", "bodyText": "sure thing", "author": "codefromthecrypt", "createdAt": "2020-04-24T06:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMyNjk0NA=="}], "type": "inlineReview"}, {"oid": "06cdc5289968bef7b4acf11c7109d67f68fcbf0b", "url": "https://github.com/openzipkin/brave/commit/06cdc5289968bef7b4acf11c7109d67f68fcbf0b", "message": "Adds BaggagePropagation.allKeyNames and deprecates non-string propagation\n\nIn 5.11, we partially replaced functionality of ExtraFieldPropagation.extraKeys().\nThis completes the work after I noticed it was needed for several use cases, not\njust OpenTracing. `BaggagePropagation.allKeyNames()` is also more robust when\npropagation is wrapped by proxy or otherwise.\n\nThe Propagation `<K>` parameter allowed integration with requests that had\nheaders, but didn't use String types. This was over-generalized, as in practice\nonly gRPC instrumentation ever used this key type (`Metadata.Key`).\n\nRemoving this `<K>` parameter dramatically simplifies the model as it removes\nthe need to explain the key factory and the edge case it supported, which can\nbe accomplished differently.\n\nIn Brave 6, we will need to keep the generic parameter `Propagation<String>`\n(to avoid API breaks). However, the internals will be far less complex once we\ncan remove KeyFactory etc that are no longer needed.", "committedDate": "2020-04-24T06:34:34Z", "type": "forcePushed"}, {"oid": "06cdc5289968bef7b4acf11c7109d67f68fcbf0b", "url": "https://github.com/openzipkin/brave/commit/06cdc5289968bef7b4acf11c7109d67f68fcbf0b", "message": "Adds BaggagePropagation.allKeyNames and deprecates non-string propagation\n\nIn 5.11, we partially replaced functionality of ExtraFieldPropagation.extraKeys().\nThis completes the work after I noticed it was needed for several use cases, not\njust OpenTracing. `BaggagePropagation.allKeyNames()` is also more robust when\npropagation is wrapped by proxy or otherwise.\n\nThe Propagation `<K>` parameter allowed integration with requests that had\nheaders, but didn't use String types. This was over-generalized, as in practice\nonly gRPC instrumentation ever used this key type (`Metadata.Key`).\n\nRemoving this `<K>` parameter dramatically simplifies the model as it removes\nthe need to explain the key factory and the edge case it supported, which can\nbe accomplished differently.\n\nIn Brave 6, we will need to keep the generic parameter `Propagation<String>`\n(to avoid API breaks). However, the internals will be far less complex once we\ncan remove KeyFactory etc that are no longer needed.", "committedDate": "2020-04-24T06:34:34Z", "type": "commit"}, {"oid": "bed0aa9d359be54ba7797393859a444cf90c12f4", "url": "https://github.com/openzipkin/brave/commit/bed0aa9d359be54ba7797393859a444cf90c12f4", "message": "nit", "committedDate": "2020-04-24T06:36:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzMTEyMg==", "url": "https://github.com/openzipkin/brave/pull/1171#discussion_r414331122", "body": "ps this was redundant as config keyNames are by definition lc", "bodyText": "ps this was redundant as config keyNames are by definition lc", "bodyHTML": "<p dir=\"auto\">ps this was redundant as config keyNames are by definition lc</p>", "author": "codefromthecrypt", "createdAt": "2020-04-24T06:38:00Z", "path": "brave/src/main/java/brave/baggage/BaggagePropagation.java", "diffHunk": "@@ -138,92 +139,72 @@ public FactoryBuilder add(BaggagePropagationConfig config) {\n         throw new UnsupportedOperationException(\"dynamic fields not yet supported\");\n       }\n       SingleBaggageField field = (SingleBaggageField) config;\n-      if (fieldToKeyNames.containsKey(field.field)) {\n+      if (fieldToHandler.containsKey(field.field)) {\n         throw new IllegalArgumentException(field.field.name + \" already added\");\n       }\n       configs.add(field);\n-      Set<String> lcKeyNames = new LinkedHashSet<>();\n+      if (field.keyNames().isEmpty()) {\n+        fieldToHandler.put(field.field, BaggageHandlers.string(field.field));\n+        return this;\n+      }\n+\n       for (String keyName : field.keyNames) {\n-        String lcName = validateName(keyName).toLowerCase(Locale.ROOT);", "originalCommit": "bed0aa9d359be54ba7797393859a444cf90c12f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDMzMTUzNQ==", "url": "https://github.com/openzipkin/brave/pull/1171#discussion_r414331535", "body": "```suggestion\r\n   * different than {@linkplain BaggageField#name() baggage field names}.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * different than {@link BaggageField#name() baggage field names}.\n          \n          \n            \n               * different than {@linkplain BaggageField#name() baggage field names}.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> different than {<span class=\"pl-k\">@<span class=\"x x-first x-last\">link</span></span> <span class=\"pl-smi\">BaggageField</span>#name() baggage field names}<span class=\"pl-c1\">.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> different than {<span class=\"pl-k\">@<span class=\"x x-first x-last\">linkplain</span></span> <span class=\"pl-smi\">BaggageField</span>#name() baggage field names}<span class=\"pl-c1\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codefromthecrypt", "createdAt": "2020-04-24T06:38:53Z", "path": "brave/src/main/java/brave/baggage/BaggagePropagation.java", "diffHunk": "@@ -259,6 +240,46 @@ public FactoryBuilder add(BaggagePropagationConfig config) {\n     return delegate.keys();\n   }\n \n+  /**\n+   * Returns the key names used for propagation, including those used for the {@linkplain #keys()\n+   * trace context} and {@linkplain SingleBaggageField#keyNames() baggage}. The result can be cached\n+   * in the same scope as the propagation instance.\n+   *\n+   * <p>This is here for the remote propagation use cases:\n+   * <ul>\n+   *   <li>To generate constants for all key names. ex. gRPC Metadata.Key</li>\n+   *   <li>To iterate fields when missing a get field by name function. ex. OpenTracing TextMap</li>\n+   *   <li>To clear fields on re-usable requests. ex. JMS message</li>\n+   * </ul>\n+   *\n+   * <h3>Details</h3>\n+   * The {@code propagation} parameter is required because there may be multiple tracers with\n+   * different baggage configuration. Also, {@link Propagation} instances can be wrapped, so you\n+   * cannot use {@code instanceof} to identify if baggage is internally supported. For example,\n+   * {@link ExtraFieldPropagation} internally wraps {@link BaggagePropagation}.\n+   *\n+   * <p>This is different than {@link BaggageField#getAll(TraceContext)}, as propagation keys may be\n+   * different than {@link BaggageField#name() baggage field names}.", "originalCommit": "bed0aa9d359be54ba7797393859a444cf90c12f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5042ef6b43777cd6400e504cc8dd9955f274e9f5", "url": "https://github.com/openzipkin/brave/commit/5042ef6b43777cd6400e504cc8dd9955f274e9f5", "message": "Update brave/src/main/java/brave/baggage/BaggagePropagation.java", "committedDate": "2020-04-24T06:38:59Z", "type": "commit"}]}