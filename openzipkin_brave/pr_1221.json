{"pr_number": 1221, "pr_title": "Adds javadocs on how to interpret MutableSpan.error", "pr_author": "codefromthecrypt", "pr_createdAt": "2020-05-19T02:49:57Z", "pr_url": "https://github.com/openzipkin/brave/pull/1221", "timeline": [{"oid": "29348f0e9a67328c0cdfd8daa4683193378e8323", "url": "https://github.com/openzipkin/brave/commit/29348f0e9a67328c0cdfd8daa4683193378e8323", "message": "Adds javadocs on how to interpret MutableSpan.error", "committedDate": "2020-05-19T02:50:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA2NjkxOQ==", "url": "https://github.com/openzipkin/brave/pull/1221#discussion_r427066919", "body": "```suggestion\r\n * <h3>MutableSpan.error() vs MutableSpan.tag(\"error\")</h3>\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * <h3>MutableSpan.error() vs MutableSpan.tag(\"error)</h3>\n          \n          \n            \n             * <h3>MutableSpan.error() vs MutableSpan.tag(\"error\")</h3>", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>h3<span class=\"pl-k\">&gt;</span><span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span>error() vs <span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span>tag(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>error)&lt;/h3&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>h3<span class=\"pl-k\">&gt;</span><span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span>error() vs <span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span>tag(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>error<span class=\"pl-pds x x-first x-last\">\"</span></span>)<span class=\"pl-k\">&lt;</span><span class=\"pl-k\">/</span>h3<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codefromthecrypt", "createdAt": "2020-05-19T06:48:19Z", "path": "brave/src/main/java/brave/handler/MutableSpan.java", "diffHunk": "@@ -46,6 +46,45 @@\n  * <p>In other words, this type is not thread safe. If you need to mutate this span in a different\n  * thread, use the {@linkplain #MutableSpan(MutableSpan) copy constructor}.\n  *\n+ * <h3>MutableSpan.error() vs MutableSpan.tag(\"error)</h3>", "originalCommit": "29348f0e9a67328c0cdfd8daa4683193378e8323", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43f052a648748489df59fa874f65adb50a1887d6", "url": "https://github.com/openzipkin/brave/commit/43f052a648748489df59fa874f65adb50a1887d6", "message": "typo", "committedDate": "2020-05-19T06:48:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA2ODMxOA==", "url": "https://github.com/openzipkin/brave/pull/1221#discussion_r427068318", "body": "```suggestion\r\n *   <li>{@code MutableSpan.error() -> MutableSpan.tag(\"exception\", normalized)} to match metrics dimension</li>\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *   <li>{@code MutableSpan.error() -> MutableSpan.tags[\"exception\"]} to match metrics dimension</li>\n          \n          \n            \n             *   <li>{@code MutableSpan.error() -> MutableSpan.tag(\"exception\", normalized)} to match metrics dimension</li>", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span>   <span class=\"pl-k\">&lt;</span>li<span class=\"pl-k\">&gt;</span>{<span class=\"pl-k\">@code</span> <span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span>error() <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">tags[</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>exception<span class=\"pl-pds\">\"</span></span><span class=\"x x-first x-last\">]</span>} to match metrics dimension<span class=\"pl-k\">&lt;</span><span class=\"pl-k\">/</span>li<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span>   <span class=\"pl-k\">&lt;</span>li<span class=\"pl-k\">&gt;</span>{<span class=\"pl-k\">@code</span> <span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span>error() <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">MutableSpan</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">tag(</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>exception<span class=\"pl-pds\">\"</span></span><span class=\"x x-first x-last\">, normalized)</span>} to match metrics dimension<span class=\"pl-k\">&lt;</span><span class=\"pl-k\">/</span>li<span class=\"pl-k\">&gt;</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codefromthecrypt", "createdAt": "2020-05-19T06:51:37Z", "path": "brave/src/main/java/brave/handler/MutableSpan.java", "diffHunk": "@@ -46,6 +46,45 @@\n  * <p>In other words, this type is not thread safe. If you need to mutate this span in a different\n  * thread, use the {@linkplain #MutableSpan(MutableSpan) copy constructor}.\n  *\n+ * <h3>MutableSpan.error() vs MutableSpan.tag(\"error\")</h3>\n+ * If {@link #tag(String)} returns a result for \"error\", it was from a layered api, instrumentation or the user.\n+ * {@link #error()} is usually an uncaught exception and does not imply there's a tag \"error\".\n+ *\n+ * <p>Here are examples of a span with {@link #error()}, but no \"error\" tag:\n+ * <ul>\n+ *   <li>{@code brave.Span.error(new OutOfMemoryError()) -> MutableSpan.error(new OutOfMemoryError())}</li>\n+ *   <li>{@code brave.Span.error(new RpcException()) -> MutableSpan.error(new RpcException())}</li>\n+ *   <li>{@code brave.Span.error(new NullPointerException()) -> MutableSpan.error(new NullPointerException())}</li>\n+ * </ul>\n+ *\n+ * <p>The above are examples of exceptions that users typically do not process, so are unlikely to\n+ * parse into an \"error\" tag. The opposite is also true as not all errors are derived from\n+ * {@link Throwable}. Particularly, RPC frameworks often do not use exceptions as error signals.\n+ *\n+ * <p>Here are examples of a span with an \"error\" tag, but no {@link #error()}:\n+ * <ul>\n+ *   <li>{@code io.opentracing.Span.tag(ERROR, true) -> MutableSpan.tag(\"error\", \"true\")}</li>\n+ *   <li>{@code brave.SpanCustomizer.tag(\"error\", \"\") -> MutableSpan.tag(\"error\", \"\")}</li>\n+ *   <li>{@code brave.Span.tag(\"error\", \"CANCELLED\") -> MutableSpan.tag(\"error\", \"CANCELLED\")}</li>\n+ * </ul>\n+\n+ * <p>The above examples are using in-band apis in Brave. {@link SpanHandler} is after the fact.\n+ * Since there is no default \"error\" tag, span handlers here can tell the difference between\n+ * explicitly set error messages, and what's needed by their format. For example, those only looking\n+ * at Zipkin clones may forget that {@link #error()} exists for custom formats including metrics!\n+ *\n+ * <p>Here are examples of {@link SpanHandler#end(TraceContext, MutableSpan, SpanHandler.Cause)}\n+ * implementations that process errors:\n+ * <ul>\n+ *   <li>{@code MutableSpan.tag(\"error\", \"\")} to redact the error message from Zipkin</li>\n+ *   <li>{@code MutableSpan.error() -> MutableSpan.tags[\"exception\"]} to match metrics dimension</li>", "originalCommit": "43f052a648748489df59fa874f65adb50a1887d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fde858e96a9828e7171cfe0fbe359f0c90913ccb", "url": "https://github.com/openzipkin/brave/commit/fde858e96a9828e7171cfe0fbe359f0c90913ccb", "message": "format", "committedDate": "2020-05-19T06:51:45Z", "type": "commit"}]}