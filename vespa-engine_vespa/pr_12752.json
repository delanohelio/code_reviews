{"pr_number": 12752, "pr_title": "Set warmup duration based on zone", "pr_author": "hmusum", "pr_createdAt": "2020-03-29T07:57:37Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12752", "timeline": [{"oid": "d0e36f8329daba094e908c1949dddd7e7de941e8", "url": "https://github.com/vespa-engine/vespa/commit/d0e36f8329daba094e908c1949dddd7e7de941e8", "message": "Set warmup duration based on zone\n\nNo warmup time necessary in cd or test environments. Set\ndefault warmup time to 89 seconds, as the previous value of 60\nseconds (which ended up being ~90 seconds) was the wanted one based\non experience with prod applications.", "committedDate": "2020-03-29T07:54:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NjcyMw==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399766723", "body": "Any reason this shouldn't apply to `PublicCd`?\r\n```suggestion\r\n        return zone.getSystemName().isCd() || zone.getEnvironment().isTest()\r\n```", "bodyText": "Any reason this shouldn't apply to PublicCd?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return zone.getSystemName() == SystemName.cd || zone.getEnvironment().isTest()\n          \n          \n            \n                    return zone.getSystemName().isCd() || zone.getEnvironment().isTest()", "bodyHTML": "<p dir=\"auto\">Any reason this shouldn't apply to <code>PublicCd</code>?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> zone<span class=\"pl-k\">.</span>getSystemName()<span class=\"x x-first\"> </span><span class=\"pl-k x\">==</span><span class=\"x\"> </span><span class=\"pl-smi x\">SystemName</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">cd</span> <span class=\"pl-k\">||</span> zone<span class=\"pl-k\">.</span>getEnvironment()<span class=\"pl-k\">.</span>isTest()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> zone<span class=\"pl-k\">.</span>getSystemName()<span class=\"pl-k x x-first\">.</span><span class=\"x x-last\">isCd()</span> <span class=\"pl-k\">||</span> zone<span class=\"pl-k\">.</span>getEnvironment()<span class=\"pl-k\">.</span>isTest()</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "freva", "createdAt": "2020-03-29T08:50:11Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java", "diffHunk": "@@ -605,4 +606,10 @@ public void createSymlink(Path symlink, Path target) {\n     protected Optional<CredentialsMaintainer> credentialsMaintainer() {\n         return credentialsMaintainer;\n     }\n+\n+    private static Duration warmUpDurationForZone(ZoneApi zone) {\n+        return zone.getSystemName() == SystemName.cd || zone.getEnvironment().isTest()", "originalCommit": "d0e36f8329daba094e908c1949dddd7e7de941e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzEwNQ==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399767105", "body": "Duration of zero still starts the container unconstrained, but then immediately attempts to suspend against orch. to set limits. Negative will start the container with the constraints https://github.com/vespa-engine/vespa/blob/44e2be1ea393b7556ab59e7f77a757d8d25be546/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java#L215\r\n```suggestion\r\n                ? Duration.ofSeconds(-1)\r\n```", "bodyText": "Duration of zero still starts the container unconstrained, but then immediately attempts to suspend against orch. to set limits. Negative will start the container with the constraints \n  \n    \n      vespa/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java\n    \n    \n         Line 215\n      in\n      44e2be1\n    \n    \n    \n    \n\n        \n          \n           ContainerResources wantedResources = context.nodeType() != NodeType.tenant || warmUpDuration.isNegative() ? \n        \n    \n  \n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            ? Duration.ZERO\n          \n          \n            \n                            ? Duration.ofSeconds(-1)", "bodyHTML": "<p dir=\"auto\">Duration of zero still starts the container unconstrained, but then immediately attempts to suspend against orch. to set limits. Negative will start the container with the constraints <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/vespa-engine/vespa/blob/44e2be1ea393b7556ab59e7f77a757d8d25be546/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java#L215\">vespa/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 215\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/vespa-engine/vespa/commit/44e2be1ea393b7556ab59e7f77a757d8d25be546\">44e2be1</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L215\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"215\"></td>\n          <td id=\"LC215\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">ContainerResources</span> wantedResources <span class=\"pl-k\">=</span> context<span class=\"pl-k\">.</span>nodeType() <span class=\"pl-k\">!=</span> <span class=\"pl-smi\">NodeType</span><span class=\"pl-k\">.</span>tenant <span class=\"pl-k\">||</span> warmUpDuration<span class=\"pl-k\">.</span>isNegative() <span class=\"pl-k\">?</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">?</span> <span class=\"pl-smi\">Duration</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">ZERO</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">?</span> <span class=\"pl-smi\">Duration</span><span class=\"pl-k\">.</span><span class=\"x x-first\">ofSeconds(</span><span class=\"pl-k x\">-</span><span class=\"pl-c1 x\">1</span><span class=\"x x-last\">)</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "freva", "createdAt": "2020-03-29T08:53:40Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java", "diffHunk": "@@ -605,4 +606,10 @@ public void createSymlink(Path symlink, Path target) {\n     protected Optional<CredentialsMaintainer> credentialsMaintainer() {\n         return credentialsMaintainer;\n     }\n+\n+    private static Duration warmUpDurationForZone(ZoneApi zone) {\n+        return zone.getSystemName() == SystemName.cd || zone.getEnvironment().isTest()\n+                ? Duration.ZERO", "originalCommit": "d0e36f8329daba094e908c1949dddd7e7de941e8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399767587", "body": "Consider just resolving this when needed via the `ZoneApi` in `NodeAgentContext`", "bodyText": "Consider just resolving this when needed via the ZoneApi in NodeAgentContext", "bodyHTML": "<p dir=\"auto\">Consider just resolving this when needed via the <code>ZoneApi</code> in <code>NodeAgentContext</code></p>", "author": "freva", "createdAt": "2020-03-29T08:58:24Z", "path": "node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java", "diffHunk": "@@ -102,9 +103,9 @@\n     public NodeAgentImpl(NodeAgentContextSupplier contextSupplier, NodeRepository nodeRepository,\n                          Orchestrator orchestrator, DockerOperations dockerOperations, StorageMaintainer storageMaintainer,\n                          FlagSource flagSource, Optional<CredentialsMaintainer> credentialsMaintainer,\n-                         Optional<AclMaintainer> aclMaintainer, Optional<HealthChecker> healthChecker, Clock clock) {\n+                         Optional<AclMaintainer> aclMaintainer, Optional<HealthChecker> healthChecker, Clock clock, ZoneApi zone) {\n         this(contextSupplier, nodeRepository, orchestrator, dockerOperations, storageMaintainer, flagSource, credentialsMaintainer,\n-                aclMaintainer, healthChecker, clock, DEFAULT_WARM_UP_DURATION);\n+             aclMaintainer, healthChecker, clock, warmUpDurationForZone(zone));", "originalCommit": "d0e36f8329daba094e908c1949dddd7e7de941e8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2OTg5Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399769892", "bodyText": "NodeAgentContextSupplier.nextContext() says blocks until the next context is readyand that sounded like something I wouldn't do in a constructor, I think I'll leave this for now at least", "author": "hmusum", "createdAt": "2020-03-29T09:20:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3MDI5MA==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399770290", "bodyText": "No, I meant in the methods that actually use this variable (startContainer(), updateContainerIfNeeded() and doConverge()).\nAnother option is to pass the initial context to the constructor instead of just the zone, since NodeAgentFactory already has it \n  \n    \n      vespa/node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentFactory.java\n    \n    \n         Line 9\n      in\n      44e2be1\n    \n    \n    \n    \n\n        \n          \n           NodeAgent create(NodeAgentContextSupplier contextSupplier, NodeAgentContext nodeAgentContext);", "author": "freva", "createdAt": "2020-03-29T09:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc3NDY1Ng==", "url": "https://github.com/vespa-engine/vespa/pull/12752#discussion_r399774656", "bodyText": "Yes, I initially did resolving when needed, let's go back to it. Thanks, done", "author": "hmusum", "createdAt": "2020-03-29T10:05:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc2NzU4Nw=="}], "type": "inlineReview"}, {"oid": "efc586ec3d49146b5c8ed44f9805556637db2378", "url": "https://github.com/vespa-engine/vespa/commit/efc586ec3d49146b5c8ed44f9805556637db2378", "message": "Update node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>", "committedDate": "2020-03-29T09:18:05Z", "type": "commit"}, {"oid": "965e3af747afaa4c4c0521d92b25cc155320d80b", "url": "https://github.com/vespa-engine/vespa/commit/965e3af747afaa4c4c0521d92b25cc155320d80b", "message": "Update node-admin/src/main/java/com/yahoo/vespa/hosted/node/admin/nodeagent/NodeAgentImpl.java\n\nCo-Authored-By: Valerij Fredriksen <freva@users.noreply.github.com>", "committedDate": "2020-03-29T09:18:14Z", "type": "commit"}, {"oid": "9109a39de0048098fc45ecf3910ac9eaaa87459b", "url": "https://github.com/vespa-engine/vespa/commit/9109a39de0048098fc45ecf3910ac9eaaa87459b", "message": "Use zone from context and resolve warmup time in method instead", "committedDate": "2020-03-29T10:03:42Z", "type": "commit"}]}