{"pr_number": 12006, "pr_title": "Prepare for setting PERMANENTLY_DOWN", "pr_author": "hakonhall", "pr_createdAt": "2020-01-30T10:23:22Z", "pr_url": "https://github.com/vespa-engine/vespa/pull/12006", "timeline": [{"oid": "cac9c69875dee164b45c1eddfbc2322eaa97a6f7", "url": "https://github.com/vespa-engine/vespa/commit/cac9c69875dee164b45c1eddfbc2322eaa97a6f7", "message": "Prepare for setting PERMANENTLY_DOWN", "committedDate": "2020-01-30T10:23:16Z", "type": "commit"}, {"oid": "a2777855122b34b49b4b98633eb131a67e74b2f7", "url": "https://github.com/vespa-engine/vespa/commit/a2777855122b34b49b4b98633eb131a67e74b2f7", "message": "Avoid setting PERMANENTLY_DOWN in mock", "committedDate": "2020-01-30T10:27:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg3MTQ0Nw==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372871447", "body": "This line is fairly new. The older code read the cache counter only once, and cleared the cache only once (or didn't clear it at all). While the current code will do cache invalidation on every invocation of the returned Function. The old behavior is restored with this PR.", "bodyText": "This line is fairly new. The older code read the cache counter only once, and cleared the cache only once (or didn't clear it at all). While the current code will do cache invalidation on every invocation of the returned Function. The old behavior is restored with this PR.", "bodyHTML": "<p dir=\"auto\">This line is fairly new. The older code read the cache counter only once, and cleared the cache only once (or didn't clear it at all). While the current code will do cache invalidation on every invocation of the returned Function. The old behavior is restored with this PR.</p>", "author": "hakonhall", "createdAt": "2020-01-30T10:32:36Z", "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -99,12 +99,13 @@ public boolean setHostStatus(ApplicationInstanceReference application, HostName\n \n     /**\n      * Cache is checked for freshness when this mapping is created, and may be invalidated again later\n-     * by other users of the cache. Since this function is backed by the cache, any such invalidations\n+     * by other users of the cache. Since this function is backed by the cache, any such invalidation\n      * will be reflected in the returned mapping; all users of the cache collaborate in repopulating it.\n      */\n     @Override\n-    public Function<ApplicationInstanceReference, Set<HostName>> getSuspendedHostsByApplication() {\n-        return application -> hostInfosCache.getHostInfos(application).suspendedHostsnames();", "originalCommit": "cac9c69875dee164b45c1eddfbc2322eaa97a6f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c1985cf796f265ffb929b49f944e63158558e8da", "url": "https://github.com/vespa-engine/vespa/commit/c1985cf796f265ffb929b49f944e63158558e8da", "message": "Remove unused suspendedHostnames", "committedDate": "2020-01-30T10:37:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NDg2Mw==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372884863", "body": "Why not just \r\n```suggestion\r\n        return hostInfosCache::getHostInfos;\r\n```\r\n?", "bodyText": "Why not just\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return hostInfosCache::getCachedHostInfos;\n          \n          \n            \n                    return hostInfosCache::getHostInfos;\n          \n      \n    \n    \n  \n\n?", "bodyHTML": "<p dir=\"auto\">Why not just</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"108\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> hostInfosCache<span class=\"pl-k\">::</span><span class=\"x x-first x-last\">getCachedHostInfos</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"108\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> hostInfosCache<span class=\"pl-k\">::</span><span class=\"x x-first x-last\">getHostInfos</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">?</p>", "author": "freva", "createdAt": "2020-01-30T11:01:08Z", "path": "orchestrator/src/main/java/com/yahoo/vespa/orchestrator/status/ZookeeperStatusService.java", "diffHunk": "@@ -99,12 +99,13 @@ public boolean setHostStatus(ApplicationInstanceReference application, HostName\n \n     /**\n      * Cache is checked for freshness when this mapping is created, and may be invalidated again later\n-     * by other users of the cache. Since this function is backed by the cache, any such invalidations\n+     * by other users of the cache. Since this function is backed by the cache, any such invalidation\n      * will be reflected in the returned mapping; all users of the cache collaborate in repopulating it.\n      */\n     @Override\n-    public Function<ApplicationInstanceReference, Set<HostName>> getSuspendedHostsByApplication() {\n-        return application -> hostInfosCache.getHostInfos(application).suspendedHostsnames();\n+    public Function<ApplicationInstanceReference, HostInfos> getHostInfosByApplicationResolver() {\n+        hostInfosCache.refreshCache();\n+        return hostInfosCache::getCachedHostInfos;", "originalCommit": "c1985cf796f265ffb929b49f944e63158558e8da", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwNTI4Mg==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372905282", "bodyText": "I tried to explain that to the left?", "author": "hakonhall", "createdAt": "2020-01-30T11:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NDg2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkwNjc5MA==", "url": "https://github.com/vespa-engine/vespa/pull/12006#discussion_r372906790", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f", "author": "freva", "createdAt": "2020-01-30T11:54:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NDg2Mw=="}], "type": "inlineReview"}]}