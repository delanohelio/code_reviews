{"pr_number": 5122, "pr_title": "show first run again", "pr_author": "tobiasKaminsky", "pr_createdAt": "2020-01-08T10:28:24Z", "pr_url": "https://github.com/nextcloud/android/pull/5122", "merge_commit": "b7a7772cf0dfabd1796dd717f10418f93591834d", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk1MzM5Ng==", "url": "https://github.com/nextcloud/android/pull/5122#discussion_r364953396", "body": "This part was moved in this commit:\r\n\r\nhttps://github.com/nextcloud/android/commit/d7d1c475aebb7b7e92b98c3d36dbf66c7a244d86\r\n\r\nIf you loot at it, you'll see that this code was previously in a wrong `onCreate(@Nullable Bundle savedInstanceState, @Nullable PersistableBundle persistentState)` method.\r\n\r\nIt was a bug that I introduced while refactoring `Account`-related code in `BaseActivity`, caused by IDE autocompletion - I simply typed wrong method signature while overriding `onCreate`. We didn't notice this as it works by accident simply becuase numerious calls to `setAccount` in derived activities.", "bodyText": "This part was moved in this commit:\nd7d1c47\nIf you loot at it, you'll see that this code was previously in a wrong onCreate(@Nullable Bundle savedInstanceState, @Nullable PersistableBundle persistentState) method.\nIt was a bug that I introduced while refactoring Account-related code in BaseActivity, caused by IDE autocompletion - I simply typed wrong method signature while overriding onCreate. We didn't notice this as it works by accident simply becuase numerious calls to setAccount in derived activities.", "bodyHTML": "<p dir=\"auto\">This part was moved in this commit:</p>\n<p dir=\"auto\"><a class=\"commit-link\" data-hovercard-type=\"commit\" data-hovercard-url=\"https://github.com/nextcloud/android/commit/d7d1c475aebb7b7e92b98c3d36dbf66c7a244d86/hovercard\" href=\"https://github.com/nextcloud/android/commit/d7d1c475aebb7b7e92b98c3d36dbf66c7a244d86\"><tt>d7d1c47</tt></a></p>\n<p dir=\"auto\">If you loot at it, you'll see that this code was previously in a wrong <code>onCreate(@Nullable Bundle savedInstanceState, @Nullable PersistableBundle persistentState)</code> method.</p>\n<p dir=\"auto\">It was a bug that I introduced while refactoring <code>Account</code>-related code in <code>BaseActivity</code>, caused by IDE autocompletion - I simply typed wrong method signature while overriding <code>onCreate</code>. We didn't notice this as it works by accident simply becuase numerious calls to <code>setAccount</code> in derived activities.</p>", "author": "ezaquarii", "createdAt": "2020-01-09T20:50:07Z", "path": "src/main/java/com/owncloud/android/ui/activity/BaseActivity.java", "diffHunk": "@@ -69,13 +68,6 @@ public UserAccountManager getUserAccountManager() {\n         return accountManager;\n     }\n \n-    @Override\n-    protected void onCreate(@Nullable Bundle savedInstanceState) {", "originalCommit": "a4832ca8156e414fe30ba28c1feb8019b04f84a0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "87dae2ef041a0dd3912c8dd1b8cb4747fb099f28", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex ff6c469524..fb8741baf6 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -68,6 +69,16 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n         return accountManager;\n     }\n \n+    @Override\n+    protected void onCreate(@Nullable Bundle savedInstanceState) {\n+        super.onCreate(savedInstanceState);\n+\n+        if (enableAccountHandling) {\n+            Account account = accountManager.getCurrentAccount();\n+            setAccount(account, false);\n+        }\n+    }\n+\n     @Override\n     protected void onPostCreate(@Nullable Bundle savedInstanceState) {\n         super.onPostCreate(savedInstanceState);\n", "next_change": null}]}, "revised_code_in_main": {"commit": "b7a7772cf0dfabd1796dd717f10418f93591834d", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex ff6c469524..fb8741baf6 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -68,6 +69,16 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n         return accountManager;\n     }\n \n+    @Override\n+    protected void onCreate(@Nullable Bundle savedInstanceState) {\n+        super.onCreate(savedInstanceState);\n+\n+        if (enableAccountHandling) {\n+            Account account = accountManager.getCurrentAccount();\n+            setAccount(account, false);\n+        }\n+    }\n+\n     @Override\n     protected void onPostCreate(@Nullable Bundle savedInstanceState) {\n         super.onPostCreate(savedInstanceState);\n", "next_change": {"commit": "26f2d52a5ad6eb50d303c7d0a681840f5394f961", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex fb8741baf6..df314c6859 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -72,11 +55,11 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n     @Override\n     protected void onCreate(@Nullable Bundle savedInstanceState) {\n         super.onCreate(savedInstanceState);\n-\n-        if (enableAccountHandling) {\n-            Account account = accountManager.getCurrentAccount();\n-            setAccount(account, false);\n-        }\n+        sessionMixin = new SessionMixin(this,\n+                                        getContentResolver(),\n+                                        accountManager);\n+        mixinRegistry.add(sessionMixin);\n+        mixinRegistry.onCreate(savedInstanceState);\n     }\n \n     @Override\n", "next_change": {"commit": "4cd105d5ec18acbb0fe7d62e33f06fef312dd67f", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex df314c6859..38d598820c 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -59,7 +60,10 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n                                         getContentResolver(),\n                                         accountManager);\n         mixinRegistry.add(sessionMixin);\n-        mixinRegistry.onCreate(savedInstanceState);\n+\n+        if (enableAccountHandling) {\n+            mixinRegistry.onCreate(savedInstanceState);\n+        }\n     }\n \n     @Override\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "b7a7772cf0dfabd1796dd717f10418f93591834d", "message": "Merge commit", "committedDate": null}, {"oid": "97eda02db6177a00ca1dd0a20bbf376354e0739f", "committedDate": "2020-01-16 18:18:42 +0100", "message": "Fix #5213"}, {"oid": "26f2d52a5ad6eb50d303c7d0a681840f5394f961", "committedDate": "2020-02-05 22:08:58 +0000", "message": "Extract account logic from BaseActivity into a mixin"}, {"oid": "4cd105d5ec18acbb0fe7d62e33f06fef312dd67f", "committedDate": "2020-03-26 09:25:02 +0100", "message": "Readd enableAccountHandling for show slider"}, {"oid": "e57176f009b5897e2000b089c033ac25ee85a62a", "committedDate": "2022-03-11 11:10:51 +0100", "message": "Move app source to subproject"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk1NDUxNA==", "url": "https://github.com/nextcloud/android/pull/5122#discussion_r364954514", "body": "This is what closes the `FirstRunActivity`. \r\n\r\nRemoving it wil break `FileListActivity`, causing empty file list after creating new account:\r\nhttps://github.com/nextcloud/android/pull/5031#discussion_r359570614", "bodyText": "This is what closes the FirstRunActivity.\nRemoving it wil break FileListActivity, causing empty file list after creating new account:\n#5031 (comment)", "bodyHTML": "<p dir=\"auto\">This is what closes the <code>FirstRunActivity</code>.</p>\n<p dir=\"auto\">Removing it wil break <code>FileListActivity</code>, causing empty file list after creating new account:<br>\n<a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"539713632\" data-permission-text=\"Title is private\" data-url=\"https://github.com/nextcloud/android/issues/5031\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/nextcloud/android/pull/5031/hovercard?comment_id=359570614&amp;comment_type=review_comment\" href=\"https://github.com/nextcloud/android/pull/5031#discussion_r359570614\">#5031 (comment)</a></p>", "author": "ezaquarii", "createdAt": "2020-01-09T20:53:00Z", "path": "src/main/java/com/owncloud/android/ui/activity/BaseActivity.java", "diffHunk": "@@ -178,7 +170,6 @@ protected void swapToDefaultAccount() {\n         if (newAccount == null) {\n             /// no account available: force account creation\n             createAccount(true);\n-            finish();", "originalCommit": "a4832ca8156e414fe30ba28c1feb8019b04f84a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc2ODE1NQ==", "url": "https://github.com/nextcloud/android/pull/5122#discussion_r367768155", "bodyText": "Yup, that's indeed what happens :-/  @tobiasKaminsky ?", "author": "mario", "createdAt": "2020-01-17T04:49:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk1NDUxNA=="}], "type": "inlineReview", "revised_code": {"commit": "87dae2ef041a0dd3912c8dd1b8cb4747fb099f28", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex ff6c469524..fb8741baf6 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -167,9 +178,14 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n     protected void swapToDefaultAccount() {\n         // default to the most recently used account\n         Account newAccount = accountManager.getCurrentAccount();\n+\n         if (newAccount == null) {\n             /// no account available: force account creation\n             createAccount(true);\n+\n+            if (enableAccountHandling) {\n+                finish();\n+            }\n         } else {\n             currentAccount = newAccount;\n         }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "b7a7772cf0dfabd1796dd717f10418f93591834d", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex ff6c469524..fb8741baf6 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -167,9 +178,14 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n     protected void swapToDefaultAccount() {\n         // default to the most recently used account\n         Account newAccount = accountManager.getCurrentAccount();\n+\n         if (newAccount == null) {\n             /// no account available: force account creation\n             createAccount(true);\n+\n+            if (enableAccountHandling) {\n+                finish();\n+            }\n         } else {\n             currentAccount = newAccount;\n         }\n", "next_change": {"commit": "97eda02db6177a00ca1dd0a20bbf376354e0739f", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex fb8741baf6..a3c6b2145a 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -182,10 +182,6 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n         if (newAccount == null) {\n             /// no account available: force account creation\n             createAccount(true);\n-\n-            if (enableAccountHandling) {\n-                finish();\n-            }\n         } else {\n             currentAccount = newAccount;\n         }\n", "next_change": {"commit": "26f2d52a5ad6eb50d303c7d0a681840f5394f961", "changed_code": [{"header": "diff --git a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\nindex a3c6b2145a..df314c6859 100644\n--- a/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n+++ b/src/main/java/com/owncloud/android/ui/activity/BaseActivity.java\n", "chunk": "@@ -152,56 +124,18 @@ public abstract class BaseActivity extends AppCompatActivity implements Injectab\n      */\n     @Deprecated\n     protected void setAccount(Account account, boolean savedAccount) {\n-        boolean validAccount = account != null && accountManager.setCurrentOwnCloudAccount(account.name);\n-        if (validAccount) {\n-            currentAccount = account;\n-        } else {\n-            swapToDefaultAccount();\n-        }\n-\n-        if(currentAccount != null) {\n-            storageManager = new FileDataStorageManager(currentAccount, getContentResolver());\n-            capabilities = storageManager.getCapability(currentAccount.name);\n-        }\n+        sessionMixin.setAccount(account);\n     }\n \n     protected void setUser(User user) {\n-        setAccount(user.toPlatformAccount(), false);\n-    }\n-\n-    /**\n-     * Tries to swap the current ownCloud {@link Account} for other valid and existing.\n-     *\n-     * If no valid ownCloud {@link Account} exists, then the user is requested\n-     * to create a new ownCloud {@link Account}.\n-     */\n-    protected void swapToDefaultAccount() {\n-        // default to the most recently used account\n-        Account newAccount = accountManager.getCurrentAccount();\n-\n-        if (newAccount == null) {\n-            /// no account available: force account creation\n-            createAccount(true);\n-        } else {\n-            currentAccount = newAccount;\n-        }\n+        sessionMixin.setUser(user);\n     }\n \n     /**\n      * Launches the account creation activity.\n-     *\n-     * @param mandatoryCreation     When 'true', if an account is not created by the user, the app will be closed.\n-     *                              To use when no ownCloud account is available.\n      */\n-    protected void createAccount(boolean mandatoryCreation) {\n-        AccountManager am = AccountManager.get(getApplicationContext());\n-        am.addAccount(MainApp.getAccountType(this),\n-                null,\n-                null,\n-                null,\n-                this,\n-                new AccountCreationCallback(mandatoryCreation),\n-                new Handler());\n+    protected void startAccountCreation() {\n+        sessionMixin.startAccountCreation();\n     }\n \n     /**\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "b7a7772cf0dfabd1796dd717f10418f93591834d", "message": "Merge commit", "committedDate": null}, {"oid": "97eda02db6177a00ca1dd0a20bbf376354e0739f", "committedDate": "2020-01-16 18:18:42 +0100", "message": "Fix #5213"}, {"oid": "26f2d52a5ad6eb50d303c7d0a681840f5394f961", "committedDate": "2020-02-05 22:08:58 +0000", "message": "Extract account logic from BaseActivity into a mixin"}, {"oid": "4cd105d5ec18acbb0fe7d62e33f06fef312dd67f", "committedDate": "2020-03-26 09:25:02 +0100", "message": "Readd enableAccountHandling for show slider"}, {"oid": "e57176f009b5897e2000b089c033ac25ee85a62a", "committedDate": "2022-03-11 11:10:51 +0100", "message": "Move app source to subproject"}]}, {"oid": "87dae2ef041a0dd3912c8dd1b8cb4747fb099f28", "url": "https://github.com/nextcloud/android/commit/87dae2ef041a0dd3912c8dd1b8cb4747fb099f28", "message": "show first run again\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-01-10T08:47:15Z", "type": "commit"}, {"oid": "87dae2ef041a0dd3912c8dd1b8cb4747fb099f28", "url": "https://github.com/nextcloud/android/commit/87dae2ef041a0dd3912c8dd1b8cb4747fb099f28", "message": "show first run again\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-01-10T08:47:15Z", "type": "forcePushed"}]}