{"pr_number": 1373, "pr_title": "Added possibility to use event store of node currently connected to.", "pr_author": "m1l4n54v1c", "pr_createdAt": "2020-03-13T18:15:36Z", "pr_url": "https://github.com/AxonFramework/AxonFramework/pull/1373", "timeline": [{"oid": "ceb8ef500ffe212d26e0d5a16c3f14459d0c9276", "url": "https://github.com/AxonFramework/AxonFramework/commit/ceb8ef500ffe212d26e0d5a16c3f14459d0c9276", "message": "Added possibility to use event store of node currently connected to.", "committedDate": "2020-03-13T18:06:13Z", "type": "commit"}, {"oid": "cc531329c25ffb83ad37479013187950da82c975", "url": "https://github.com/AxonFramework/AxonFramework/commit/cc531329c25ffb83ad37479013187950da82c975", "message": "Renamed useLocal(Event)Store to allowReading(Events)FromFollower.", "committedDate": "2020-03-18T09:00:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIwODE4Mg==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1373#discussion_r394208182", "body": "```suggestion\r\n     * Indicates whether it is OK to query events from the local Axon Server node - the node the client is currently\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Indicates whether it is ok to query events from the local Axon Server node - the node the client is currently\n          \n          \n            \n                 * Indicates whether it is OK to query events from the local Axon Server node - the node the client is currently", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Indicates</span> whether it is <span class=\"x x-first x-last\">ok</span> to query events from the local <span class=\"pl-smi\">Axon</span> <span class=\"pl-smi\">Server</span> node <span class=\"pl-k\">-</span> the node the client is currently</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Indicates</span> whether it is <span class=\"pl-c1 x x-first x-last\">OK</span> to query events from the local <span class=\"pl-smi\">Axon</span> <span class=\"pl-smi\">Server</span> node <span class=\"pl-k\">-</span> the node the client is currently</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "smcvb", "createdAt": "2020-03-18T09:28:09Z", "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/AxonServerConfiguration.java", "diffHunk": "@@ -210,6 +210,17 @@\n      */\n     private long connectTimeout = 5000;\n \n+    /**\n+     * Indicates whether it is ok to query events from the local Axon Server node - the node the client is currently", "originalCommit": "cc531329c25ffb83ad37479013187950da82c975", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIwODY1Nw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1373#discussion_r394208657", "body": "```suggestion\r\n     * this node yet. Can be used when the criteria for eventual consistency is less strict. It will spread the load for querying\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * this node yet. Used when criteria for eventual consistency is loosen up. It will spread the load for querying\n          \n          \n            \n                 * this node yet. Can be used when the criteria for eventual consistency is less strict. It will spread the load for querying", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-c1\">this</span> node yet. <span class=\"pl-smi x x-first\">Used</span><span class=\"x x-last\"> </span>when criteria <span class=\"pl-k\">for</span> eventual consistency is <span class=\"x x-first x-last\">loosen up</span>. <span class=\"pl-smi\">It</span> will spread the load <span class=\"pl-k\">for</span> querying</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-c1\">this</span> node yet. <span class=\"pl-smi x x-first\">Can</span><span class=\"x x-last\"> be used </span>when <span class=\"x x-first x-last\">the </span>criteria <span class=\"pl-k\">for</span> eventual consistency is <span class=\"x x-first x-last\">less strict</span>. <span class=\"pl-smi\">It</span> will spread the load <span class=\"pl-k\">for</span> querying</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "smcvb", "createdAt": "2020-03-18T09:28:54Z", "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/AxonServerConfiguration.java", "diffHunk": "@@ -210,6 +210,17 @@\n      */\n     private long connectTimeout = 5000;\n \n+    /**\n+     * Indicates whether it is ok to query events from the local Axon Server node - the node the client is currently\n+     * connected to. This means that the client will probably get stale events since all events my not be replicated to\n+     * this node yet. Used when criteria for eventual consistency is loosen up. It will spread the load for querying", "originalCommit": "cc531329c25ffb83ad37479013187950da82c975", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIwOTc5Mw==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1373#discussion_r394209793", "body": "Would it make sense to set this field once for the `AxonIQEventStorageEngine` to be used on every `GetEventsRequest` and `QueryEventsRequest` call instead of retrieving it from the config each time? :thinking: ", "bodyText": "Would it make sense to set this field once for the AxonIQEventStorageEngine to be used on every GetEventsRequest and QueryEventsRequest call instead of retrieving it from the config each time? \ud83e\udd14", "bodyHTML": "<p dir=\"auto\">Would it make sense to set this field once for the <code>AxonIQEventStorageEngine</code> to be used on every <code>GetEventsRequest</code> and <code>QueryEventsRequest</code> call instead of retrieving it from the config each time? <g-emoji class=\"g-emoji\" alias=\"thinking\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f914.png\">\ud83e\udd14</g-emoji></p>", "author": "smcvb", "createdAt": "2020-03-18T09:30:37Z", "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/event/axon/AxonServerEventStore.java", "diffHunk": "@@ -481,7 +481,10 @@ public void onCompleted() {\n                     requestStream,\n                     configuration.getClientId(),\n                     configuration.getEventFlowControl(),\n-                    t -> GetEventsRequest.newBuilder().setNumberOfPermits(t.getPermits()).build(),\n+                    t -> GetEventsRequest.newBuilder()\n+                                         .setAllowReadingFromFollower(configuration.isAllowReadingEventsFromFollower())", "originalCommit": "cc531329c25ffb83ad37479013187950da82c975", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIxMDQyMQ==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1373#discussion_r394210421", "body": "Nit: I'd expected your changes to update the copyright notice to 2020.", "bodyText": "Nit: I'd expected your changes to update the copyright notice to 2020.", "bodyHTML": "<p dir=\"auto\">Nit: I'd expected your changes to update the copyright notice to 2020.</p>", "author": "smcvb", "createdAt": "2020-03-18T09:31:39Z", "path": "axon-server-connector/src/test/java/org/axonframework/axonserver/connector/event/EventStoreImpl.java", "diffHunk": "@@ -16,16 +16,40 @@\n \n package org.axonframework.axonserver.connector.event;\n \n-import io.axoniq.axonserver.grpc.event.*;\n+import io.axoniq.axonserver.grpc.event.Confirmation;", "originalCommit": "cc531329c25ffb83ad37479013187950da82c975", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIxMTA0MA==", "url": "https://github.com/AxonFramework/AxonFramework/pull/1373#discussion_r394211040", "body": "When in the spot, might be nice to provide a short piece of class-level javadoc.", "bodyText": "When in the spot, might be nice to provide a short piece of class-level javadoc.", "bodyHTML": "<p dir=\"auto\">When in the spot, might be nice to provide a short piece of class-level javadoc.</p>", "author": "smcvb", "createdAt": "2020-03-18T09:32:38Z", "path": "axon-server-connector/src/test/java/org/axonframework/axonserver/connector/event/EventStoreImpl.java", "diffHunk": "@@ -16,16 +16,40 @@\n \n package org.axonframework.axonserver.connector.event;\n \n-import io.axoniq.axonserver.grpc.event.*;\n+import io.axoniq.axonserver.grpc.event.Confirmation;\n+import io.axoniq.axonserver.grpc.event.Event;\n+import io.axoniq.axonserver.grpc.event.EventStoreGrpc;\n+import io.axoniq.axonserver.grpc.event.EventWithToken;\n+import io.axoniq.axonserver.grpc.event.GetAggregateEventsRequest;\n+import io.axoniq.axonserver.grpc.event.GetEventsRequest;\n+import io.axoniq.axonserver.grpc.event.QueryEventsRequest;\n+import io.axoniq.axonserver.grpc.event.QueryEventsResponse;\n+import io.axoniq.axonserver.grpc.event.ReadHighestSequenceNrRequest;\n+import io.axoniq.axonserver.grpc.event.ReadHighestSequenceNrResponse;\n import io.grpc.stub.StreamObserver;\n \n-import java.util.*;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Map;\n import java.util.concurrent.atomic.AtomicLong;\n \n public class EventStoreImpl extends EventStoreGrpc.EventStoreImplBase {", "originalCommit": "cc531329c25ffb83ad37479013187950da82c975", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33cf0baa490abbceda48f229537777fdcdf742ae", "url": "https://github.com/AxonFramework/AxonFramework/commit/33cf0baa490abbceda48f229537777fdcdf742ae", "message": "Update axon-server-connector/src/main/java/org/axonframework/axonserver/connector/AxonServerConfiguration.java\n\nCo-Authored-By: Steven van Beelen <steven.vanbeelen@axoniq.io>", "committedDate": "2020-03-18T09:42:01Z", "type": "commit"}, {"oid": "8c36e378aca07078547ccbf879839de132d3896b", "url": "https://github.com/AxonFramework/AxonFramework/commit/8c36e378aca07078547ccbf879839de132d3896b", "message": "Update axon-server-connector/src/main/java/org/axonframework/axonserver/connector/AxonServerConfiguration.java\n\nCo-Authored-By: Steven van Beelen <steven.vanbeelen@axoniq.io>", "committedDate": "2020-03-18T09:46:26Z", "type": "commit"}, {"oid": "4ce2c918bd87c450bcc0ce01a07844874d75ace3", "url": "https://github.com/AxonFramework/AxonFramework/commit/4ce2c918bd87c450bcc0ce01a07844874d75ace3", "message": "Minor adjustments.", "committedDate": "2020-03-18T09:58:54Z", "type": "commit"}, {"oid": "b1000d888e34bbef0c23dbf7ecbb8ba9c6375ab8", "url": "https://github.com/AxonFramework/AxonFramework/commit/b1000d888e34bbef0c23dbf7ecbb8ba9c6375ab8", "message": "Merge remote-tracking branch 'origin/master' into use-local-store", "committedDate": "2020-03-19T11:08:21Z", "type": "commit"}, {"oid": "9b4830637712097a2fdb8c59a46197127874d5da", "url": "https://github.com/AxonFramework/AxonFramework/commit/9b4830637712097a2fdb8c59a46197127874d5da", "message": "Tell travis to use snapshot repositories.", "committedDate": "2020-03-19T13:18:00Z", "type": "commit"}, {"oid": "b4687c3e2d55db4b6daad12af905a9555ea0f7b3", "url": "https://github.com/AxonFramework/AxonFramework/commit/b4687c3e2d55db4b6daad12af905a9555ea0f7b3", "message": "Fixed typo in mvn build.", "committedDate": "2020-03-19T14:01:54Z", "type": "commit"}]}