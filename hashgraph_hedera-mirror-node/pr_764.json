{"pr_number": 764, "pr_title": "Add consensusTimestamp attribute to PubSub messages", "pr_author": "apeksharma", "pr_createdAt": "2020-05-16T08:52:15Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/764", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3ODg3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/764#discussion_r426178875", "body": "nit: You're using Assertj, but you're not really _using_ it:\r\n```java\r\nassertThat(headers).describedAs(\"Headers contain consensus timestamp\")\r\n  .hasSize(3)\r\n  .containsEntry(\"consensusTimestamp\", CONSENSUS_TIMESTAMP);\r\n```", "bodyText": "nit: You're using Assertj, but you're not really using it:\nassertThat(headers).describedAs(\"Headers contain consensus timestamp\")\n  .hasSize(3)\n  .containsEntry(\"consensusTimestamp\", CONSENSUS_TIMESTAMP);", "bodyHTML": "<p dir=\"auto\">nit: You're using Assertj, but you're not really <em>using</em> it:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"assertThat(headers).describedAs(&quot;Headers contain consensus timestamp&quot;)\n  .hasSize(3)\n  .containsEntry(&quot;consensusTimestamp&quot;, CONSENSUS_TIMESTAMP);\"><pre>assertThat(headers)<span class=\"pl-k\">.</span>describedAs(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Headers contain consensus timestamp<span class=\"pl-pds\">\"</span></span>)\n  .hasSize(<span class=\"pl-c1\">3</span>)\n  .containsEntry(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>consensusTimestamp<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">CONSENSUS_TIMESTAMP</span>);</pre></div>", "author": "steven-sheehy", "createdAt": "2020-05-16T18:30:40Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/pubsub/PubSubRecordItemListenerTest.java", "diffHunk": "@@ -213,6 +214,9 @@ private void assertPubSubMessage(EntityId expectedEntity, Transaction expectedTr\n         } else {\n             assertThat(actual.getNonFeeTransfers()).isEqualTo(expectedNonFeeTransfers);\n         }\n+        MessageHeaders headers = argument.getValue().getHeaders();\n+        assertThat(headers.size()).isEqualTo(3); // +2 are default attributes 'id' and 'timestamp' (publish)\n+        assertThat(headers.get(\"consensusTimestamp\")).isEqualTo(CONSENSUS_TIMESTAMP);", "originalCommit": "a99026fda77e2b9d74d28a76c08657d9f526e78b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5NzgwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/764#discussion_r426197806", "bodyText": "done.", "author": "apeksharma", "createdAt": "2020-05-16T22:47:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE3ODg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE4MTQ2Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/764#discussion_r426181463", "body": "This is quite convoluted. Would recommend converting them both to domain message:\r\n```java\r\nList<PubSubMessage> expected = null;\r\nList<com.google.pubsub.v1.PubsubMessage> actual = null;\r\n        assertThat(actual).describedAs(\"blah\")\r\n                .hasSize(expected.size())\r\n                .zipSatisfy(expected, (a, e) -> {\r\n                    assertThat(a.getAttributesMap()).containsEntry(\"consensusTimestamp\", e.getConsensusTimestamp().toString());\r\n                    assertThat(convert(a.getData())).isEqualTo(e);\r\n                });\r\n```", "bodyText": "This is quite convoluted. Would recommend converting them both to domain message:\nList<PubSubMessage> expected = null;\nList<com.google.pubsub.v1.PubsubMessage> actual = null;\n        assertThat(actual).describedAs(\"blah\")\n                .hasSize(expected.size())\n                .zipSatisfy(expected, (a, e) -> {\n                    assertThat(a.getAttributesMap()).containsEntry(\"consensusTimestamp\", e.getConsensusTimestamp().toString());\n                    assertThat(convert(a.getData())).isEqualTo(e);\n                });", "bodyHTML": "<p dir=\"auto\">This is quite convoluted. Would recommend converting them both to domain message:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"List&lt;PubSubMessage&gt; expected = null;\nList&lt;com.google.pubsub.v1.PubsubMessage&gt; actual = null;\n        assertThat(actual).describedAs(&quot;blah&quot;)\n                .hasSize(expected.size())\n                .zipSatisfy(expected, (a, e) -&gt; {\n                    assertThat(a.getAttributesMap()).containsEntry(&quot;consensusTimestamp&quot;, e.getConsensusTimestamp().toString());\n                    assertThat(convert(a.getData())).isEqualTo(e);\n                });\"><pre><span class=\"pl-k\">List&lt;<span class=\"pl-smi\">PubSubMessage</span>&gt;</span> expected <span class=\"pl-k\">=</span> <span class=\"pl-c1\">null</span>;\n<span class=\"pl-k\">List&lt;<span class=\"pl-smi\">com.google.pubsub.v1<span class=\"pl-k\">.</span>PubsubMessage</span>&gt;</span> actual <span class=\"pl-k\">=</span> <span class=\"pl-c1\">null</span>;\n        assertThat(actual)<span class=\"pl-k\">.</span>describedAs(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>blah<span class=\"pl-pds\">\"</span></span>)\n                .hasSize(expected<span class=\"pl-k\">.</span>size())\n                .zipSatisfy(expected, (a, e) <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> {\n                    assertThat(a<span class=\"pl-k\">.</span>getAttributesMap())<span class=\"pl-k\">.</span>containsEntry(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>consensusTimestamp<span class=\"pl-pds\">\"</span></span>, e<span class=\"pl-k\">.</span>getConsensusTimestamp()<span class=\"pl-k\">.</span>toString());\n                    assertThat(convert(a<span class=\"pl-k\">.</span>getData()))<span class=\"pl-k\">.</span>isEqualTo(e);\n                });</pre></div>", "author": "steven-sheehy", "createdAt": "2020-05-16T19:03:47Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/parser/record/pubsub/PubSubRecordParserTest.java", "diffHunk": "@@ -73,6 +78,26 @@ public void testPubSubExporter() throws Exception {\n         // then\n         List<String> expectedMessages =\n                 Files.readAllLines(testResourcesPath.resolve(\"pubsub-messages.txt\"));\n-        assertThat(getAllMessages(NUM_TXNS)).isEqualTo(expectedMessages);\n+        List<PubsubMessage> pubsubMessages = getAllMessages(NUM_TXNS);\n+        List<String> messages = pubsubMessages.stream()", "originalCommit": "a99026fda77e2b9d74d28a76c08657d9f526e78b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5Nzg3MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/764#discussion_r426197871", "bodyText": "done.\nwant to directly test json, added comment to code too.", "author": "apeksharma", "createdAt": "2020-05-16T22:47:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE4MTQ2Mw=="}], "type": "inlineReview"}, {"oid": "3426595860e98cd3a43c0318a8f0cdc007008981", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/3426595860e98cd3a43c0318a8f0cdc007008981", "message": "Add consensusTimestamp attribute to PubSub messages\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-05-16T22:24:48Z", "type": "commit"}, {"oid": "32802754dba65ecab63c65afc6765c702fe95027", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/32802754dba65ecab63c65afc6765c702fe95027", "message": "address review\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-05-16T22:46:48Z", "type": "commit"}, {"oid": "32802754dba65ecab63c65afc6765c702fe95027", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/32802754dba65ecab63c65afc6765c702fe95027", "message": "address review\n\nSigned-off-by: Apekshit Sharma <apekshit.sharma@hedera.com>", "committedDate": "2020-05-16T22:46:48Z", "type": "forcePushed"}]}