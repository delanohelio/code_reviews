{"pr_number": 1226, "pr_title": "Cache current address book", "pr_author": "ijungmann", "pr_createdAt": "2020-11-03T23:34:57Z", "pr_url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226", "timeline": [{"oid": "42e5d744b0523d1577a1dfd9e5ac092837bdda6c", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/42e5d744b0523d1577a1dfd9e5ac092837bdda6c", "message": "Cache current address book\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-11-03T23:30:08Z", "type": "commit"}, {"oid": "4f0d06b2622b2fa56d770c81f8b69023f58440de", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/4f0d06b2622b2fa56d770c81f8b69023f58440de", "message": "Refactor to not pull in static string\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-11-03T23:38:44Z", "type": "commit"}, {"oid": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "message": "Add test for repository layer\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-11-03T23:46:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2MzczOQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517463739", "body": "Will this break if someone renames the parameter? \r\nIf so use p1\r\n```suggestion\r\n            \"{#p1}\", unless = \"#result == null\")\r\n```", "bodyText": "Will this break if someone renames the parameter?\nIf so use p1\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"#encodedFileId\", unless = \"#result == null\")\n          \n          \n            \n                        \"{#p1}\", unless = \"#result == null\")", "bodyHTML": "<p dir=\"auto\">Will this break if someone renames the parameter?<br>\nIf so use p1</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">#encodedFileId</span><span class=\"pl-pds\">\"</span></span>, unless <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>#result == null<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">{#p1}</span><span class=\"pl-pds\">\"</span></span>, unless <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>#result == null<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Nana-EC", "createdAt": "2020-11-04T16:17:56Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/repository/AddressBookRepository.java", "diffHunk": "@@ -20,13 +20,20 @@\n  * \u200d\n  */\n \n+import static com.hedera.mirror.importer.config.CacheConfiguration.NEVER_EXPIRE_LARGE;\n+\n import java.util.Optional;\n+import org.springframework.cache.annotation.Cacheable;\n import org.springframework.data.jpa.repository.Query;\n import org.springframework.data.repository.CrudRepository;\n \n import com.hedera.mirror.importer.domain.AddressBook;\n \n public interface AddressBookRepository extends CrudRepository<AddressBook, Long> {\n+    public static final String ADDRESS_BOOK_CACHE_NAME = \"address_book\";\n+\n+    @Cacheable(cacheNames = ADDRESS_BOOK_CACHE_NAME, cacheManager = NEVER_EXPIRE_LARGE, key =\n+            \"#encodedFileId\", unless = \"#result == null\")", "originalCommit": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNDI5MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517624290", "bodyText": "This was refactored to work on the service layer which changed with the key params, but good point.", "author": "ijungmann", "createdAt": "2020-11-04T20:52:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ2MzczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3Njc5OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517476798", "body": "nit\r\n```suggestion\r\n    private final CacheManager cacheManager;\r\n```", "bodyText": "nit\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CacheManager cacheManager;\n          \n          \n            \n                private final CacheManager cacheManager;", "bodyHTML": "<p dir=\"auto\">nit</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-smi\">CacheManager</span> cacheManager;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k x x-first\">private</span><span class=\"x\"> </span><span class=\"pl-k x\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">CacheManager</span> cacheManager;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Nana-EC", "createdAt": "2020-11-04T16:36:02Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -57,6 +61,10 @@\n     private final AddressBookRepository addressBookRepository;\n     private final FileDataRepository fileDataRepository;\n \n+    @Qualifier(CacheConfiguration.NEVER_EXPIRE_LARGE)\n+    @Resource\n+    CacheManager cacheManager;", "originalCommit": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ4MTQyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517481423", "bodyText": "Unless there's a reason otherwise", "author": "Nana-EC", "createdAt": "2020-11-04T16:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3Njc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMjk3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517622975", "bodyText": "This was removed since the annotation can just be used, but you are correct that this should have been done.", "author": "ijungmann", "createdAt": "2020-11-04T20:49:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3Njc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3NzM2NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517477365", "body": "Add a test for the cache eviction scenario if possible", "bodyText": "Add a test for the cache eviction scenario if possible", "bodyHTML": "<p dir=\"auto\">Add a test for the cache eviction scenario if possible</p>", "author": "Nana-EC", "createdAt": "2020-11-04T16:36:52Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImplTest.java", "diffHunk": "@@ -138,6 +145,29 @@ void updateCompleteFile() {\n         assertEquals(10, addressBookEntryRepository.count());\n     }\n \n+    @Test\n+    void cacheAddressBook() {", "originalCommit": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyNTQ5MA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517625490", "bodyText": "Perhaps this test needs to be renamed to cacheAndEvictAddressBook, it does do an update/eviction and confirms that it was removed from the cache.", "author": "ijungmann", "createdAt": "2020-11-04T20:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3NzM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5Mjc5OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517492798", "body": "What happens if an error occurs before `addressBookRepository.save()` is called?\r\nWould the last valid address book be evicted from the cache?", "bodyText": "What happens if an error occurs before addressBookRepository.save() is called?\nWould the last valid address book be evicted from the cache?", "bodyHTML": "<p dir=\"auto\">What happens if an error occurs before <code>addressBookRepository.save()</code> is called?<br>\nWould the last valid address book be evicted from the cache?</p>", "author": "Nana-EC", "createdAt": "2020-11-04T16:59:02Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -78,6 +86,10 @@ public void update(FileData fileData) {\n             parse(fileData);\n         } catch (Exception e) {\n             log.error(\"Unable to parse address book\", e);\n+        } finally {\n+            //Evict the cache regardless of errors\n+            cacheManager.getCache(AddressBookRepository.ADDRESS_BOOK_CACHE_NAME)", "originalCommit": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5MjgyMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517492823", "bodyText": "Also what about when addressBookRepository.save() is called in parse() then an error occurs after?\nShould we be evicting the new valid address book?", "author": "Nana-EC", "createdAt": "2020-11-04T16:59:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5Mjc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0NDY2NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517644664", "bodyText": "After refactoring, the evict cache is called at the resolution of the method via an annotation.  That being said, it will not execute if an exception is thrown, I'm trying to evaluate if that is the best way to go or if it needs to switch back to something that fires regardless.", "author": "ijungmann", "createdAt": "2020-11-04T21:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5Mjc5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY5MTE3Mw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517691173", "bodyText": "At 5mins it's probably not a big deal, though if your research shows otherwise you can add it in a follow up PR.", "author": "Nana-EC", "createdAt": "2020-11-04T23:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5Mjc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxOTY1MQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517019651", "body": "Should be able to just put `@CacheEvict(...)` on `AddressBookService.update()` instead of this manual invocation.", "bodyText": "Should be able to just put @CacheEvict(...) on AddressBookService.update() instead of this manual invocation.", "bodyHTML": "<p dir=\"auto\">Should be able to just put <code>@CacheEvict(...)</code> on <code>AddressBookService.update()</code> instead of this manual invocation.</p>", "author": "steven-sheehy", "createdAt": "2020-11-03T23:43:24Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -78,6 +86,10 @@ public void update(FileData fileData) {\n             parse(fileData);\n         } catch (Exception e) {\n             log.error(\"Unable to parse address book\", e);\n+        } finally {\n+            //Evict the cache regardless of errors\n+            cacheManager.getCache(AddressBookRepository.ADDRESS_BOOK_CACHE_NAME)", "originalCommit": "4f0d06b2622b2fa56d770c81f8b69023f58440de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5OTUzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517499534", "body": "I think we're caching at the wrong layer here. We should not cache the repository but the service layer as caching here can cause problems with `AddressBookServiceImpl.updatePreviousAddressBook()`.", "bodyText": "I think we're caching at the wrong layer here. We should not cache the repository but the service layer as caching here can cause problems with AddressBookServiceImpl.updatePreviousAddressBook().", "bodyHTML": "<p dir=\"auto\">I think we're caching at the wrong layer here. We should not cache the repository but the service layer as caching here can cause problems with <code>AddressBookServiceImpl.updatePreviousAddressBook()</code>.</p>", "author": "steven-sheehy", "createdAt": "2020-11-04T17:09:15Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/repository/AddressBookRepository.java", "diffHunk": "@@ -20,13 +20,20 @@\n  * \u200d\n  */\n \n+import static com.hedera.mirror.importer.config.CacheConfiguration.NEVER_EXPIRE_LARGE;\n+\n import java.util.Optional;\n+import org.springframework.cache.annotation.Cacheable;\n import org.springframework.data.jpa.repository.Query;\n import org.springframework.data.repository.CrudRepository;\n \n import com.hedera.mirror.importer.domain.AddressBook;\n \n public interface AddressBookRepository extends CrudRepository<AddressBook, Long> {\n+    public static final String ADDRESS_BOOK_CACHE_NAME = \"address_book\";\n+\n+    @Cacheable(cacheNames = ADDRESS_BOOK_CACHE_NAME, cacheManager = NEVER_EXPIRE_LARGE, key =", "originalCommit": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ5OTg5Nw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517499897", "body": "`@Cacheable` should be here.", "bodyText": "@Cacheable should be here.", "bodyHTML": "<p dir=\"auto\"><code>@Cacheable</code> should be here.</p>", "author": "steven-sheehy", "createdAt": "2020-11-04T17:09:49Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -90,7 +102,6 @@ public void update(FileData fileData) {\n     public AddressBook getCurrent() {", "originalCommit": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUxNzAyNQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517517025", "body": "I believe it was a mistake for us to have this catch here.\r\nThe result is an error parsing a valid address book would be caught and we wouldn't retry the whole file.\r\nCan you remove this catch all together.\r\nThere shouldn't be any fallout in this minor refactor but let me know if you hit a snag as you address comments that makes it a bigger ask", "bodyText": "I believe it was a mistake for us to have this catch here.\nThe result is an error parsing a valid address book would be caught and we wouldn't retry the whole file.\nCan you remove this catch all together.\nThere shouldn't be any fallout in this minor refactor but let me know if you hit a snag as you address comments that makes it a bigger ask", "bodyHTML": "<p dir=\"auto\">I believe it was a mistake for us to have this catch here.<br>\nThe result is an error parsing a valid address book would be caught and we wouldn't retry the whole file.<br>\nCan you remove this catch all together.<br>\nThere shouldn't be any fallout in this minor refactor but let me know if you hit a snag as you address comments that makes it a bigger ask</p>", "author": "Nana-EC", "createdAt": "2020-11-04T17:37:16Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -78,6 +86,10 @@ public void update(FileData fileData) {\n             parse(fileData);\n         } catch (Exception e) {", "originalCommit": "a526281d1d0f3a35e9c5d7426dd2a6dbd3e77c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMzIzNA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517623234", "bodyText": "Removed, all seems well with the tests", "author": "ijungmann", "createdAt": "2020-11-04T20:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUxNzAyNQ=="}], "type": "inlineReview"}, {"oid": "7176f5aa04da26ed23db883a101f511e6afad95b", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/7176f5aa04da26ed23db883a101f511e6afad95b", "message": "Address PR comments to move caching fully to service layer\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-11-04T18:57:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5MjYzNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517592636", "body": "I'm hesitant to use a never expiring cache for such an important object. If we have a bug it will never self correct. We use the never expire cache only for entity IDs as they're insert only and not updateable like an address book. Even 30m might be too long and we can get away with much shorter without impacting performance. I think the `cacheManager5m` might be more appropriate.", "bodyText": "I'm hesitant to use a never expiring cache for such an important object. If we have a bug it will never self correct. We use the never expire cache only for entity IDs as they're insert only and not updateable like an address book. Even 30m might be too long and we can get away with much shorter without impacting performance. I think the cacheManager5m might be more appropriate.", "bodyHTML": "<p dir=\"auto\">I'm hesitant to use a never expiring cache for such an important object. If we have a bug it will never self correct. We use the never expire cache only for entity IDs as they're insert only and not updateable like an address book. Even 30m might be too long and we can get away with much shorter without impacting performance. I think the <code>cacheManager5m</code> might be more appropriate.</p>", "author": "steven-sheehy", "createdAt": "2020-11-04T19:50:45Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -87,10 +89,11 @@ public void update(FileData fileData) {\n      * @return returns AddressBook containing network node details\n      */\n     @Override\n+    @Cacheable(cacheNames = ADDRESS_BOOK_CACHE_NAME, cacheManager = NEVER_EXPIRE_LARGE, key =", "originalCommit": "7176f5aa04da26ed23db883a101f511e6afad95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxODg0NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517618844", "bodyText": "That logic makes sense, I've knocked it down to the 5m manager.", "author": "ijungmann", "createdAt": "2020-11-04T20:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5MjYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5OTAzMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517599032", "body": "Since we're effectively evicting all entries in the cache (one 102 file), we can just do the following and avoid the reflection penalty of using Spel expressions:\r\n\r\n```java\r\n@CacheEvict(allEntries = true)\r\n```", "bodyText": "Since we're effectively evicting all entries in the cache (one 102 file), we can just do the following and avoid the reflection penalty of using Spel expressions:\n@CacheEvict(allEntries = true)", "bodyHTML": "<p dir=\"auto\">Since we're effectively evicting all entries in the cache (one 102 file), we can just do the following and avoid the reflection penalty of using Spel expressions:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"@CacheEvict(allEntries = true)\"><pre><span class=\"pl-k\">@CacheEvict</span>(<span class=\"pl-c1\">allEntries</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>)</pre></div>", "author": "steven-sheehy", "createdAt": "2020-11-04T20:02:56Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -63,6 +68,8 @@\n      * @param fileData file data entry containing address book bytes\n      */\n     @Override\n+    @CacheEvict(cacheNames = ADDRESS_BOOK_CACHE_NAME, cacheManager = NEVER_EXPIRE_LARGE, key =\n+            \"#root.target.ADDRESS_BOOK_102_ENTITY_ID.getId()\")", "originalCommit": "7176f5aa04da26ed23db883a101f511e6afad95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTA0Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517619046", "bodyText": "Done", "author": "ijungmann", "createdAt": "2020-11-04T20:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5OTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0MzYyNw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517643627", "bodyText": "I am slightly concerned that the cache evict annotation, coupled with the removal of the top level catch as suggested by Nana, causes any exception that bubbles up to not evict the cache, as this fires at the resolution of the method.", "author": "ijungmann", "createdAt": "2020-11-04T21:33:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5OTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5OTY3NQ==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517599675", "body": "Use `@CacheConfig(cacheNames = \"current_102_address_book\", cacheManager = \"cacheManager5m\")` at the class level to stay DRY.", "bodyText": "Use @CacheConfig(cacheNames = \"current_102_address_book\", cacheManager = \"cacheManager5m\") at the class level to stay DRY.", "bodyHTML": "<p dir=\"auto\">Use <code>@CacheConfig(cacheNames = \"current_102_address_book\", cacheManager = \"cacheManager5m\")</code> at the class level to stay DRY.</p>", "author": "steven-sheehy", "createdAt": "2020-11-04T20:04:16Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -63,6 +68,8 @@\n      * @param fileData file data entry containing address book bytes\n      */\n     @Override\n+    @CacheEvict(cacheNames = ADDRESS_BOOK_CACHE_NAME, cacheManager = NEVER_EXPIRE_LARGE, key =", "originalCommit": "7176f5aa04da26ed23db883a101f511e6afad95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTE2OA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517619168", "bodyText": "Done", "author": "ijungmann", "createdAt": "2020-11-04T20:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU5OTY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMDQ0Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517600442", "body": "Since there's current and historical and 101 and 102 address books, we should name this to indicate it's only storing the current 102 address book. e.g.  something like`current_102_address_book`", "bodyText": "Since there's current and historical and 101 and 102 address books, we should name this to indicate it's only storing the current 102 address book. e.g.  something likecurrent_102_address_book", "bodyHTML": "<p dir=\"auto\">Since there's current and historical and 101 and 102 address books, we should name this to indicate it's only storing the current 102 address book. e.g.  something like<code>current_102_address_book</code></p>", "author": "steven-sheehy", "createdAt": "2020-11-04T20:05:41Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -53,6 +57,7 @@\n \n     public static final EntityId ADDRESS_BOOK_101_ENTITY_ID = EntityId.of(0, 0, 101, EntityTypeEnum.FILE);\n     public static final EntityId ADDRESS_BOOK_102_ENTITY_ID = EntityId.of(0, 0, 102, EntityTypeEnum.FILE);\n+    public static final String ADDRESS_BOOK_CACHE_NAME = \"address_book\";", "originalCommit": "7176f5aa04da26ed23db883a101f511e6afad95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTMxOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517619318", "bodyText": "Done", "author": "ijungmann", "createdAt": "2020-11-04T20:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMDQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMjIwNg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517602206", "body": "Can drop the cacheNames, cacheManager and key with my above recommendations.", "bodyText": "Can drop the cacheNames, cacheManager and key with my above recommendations.", "bodyHTML": "<p dir=\"auto\">Can drop the cacheNames, cacheManager and key with my above recommendations.</p>", "author": "steven-sheehy", "createdAt": "2020-11-04T20:09:08Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -87,10 +89,11 @@ public void update(FileData fileData) {\n      * @return returns AddressBook containing network node details\n      */\n     @Override\n+    @Cacheable(cacheNames = ADDRESS_BOOK_CACHE_NAME, cacheManager = NEVER_EXPIRE_LARGE, key =", "originalCommit": "7176f5aa04da26ed23db883a101f511e6afad95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxOTk1NA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517619954", "bodyText": "I've removed the cacheNames and cacheManager, letting it use the default key gen is causing issues with my unit test to retrieve it, I'm looking into how to fix that.", "author": "ijungmann", "createdAt": "2020-11-04T20:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMjIwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMzA1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517603052", "body": "Undo", "bodyText": "Undo", "bodyHTML": "<p dir=\"auto\">Undo</p>", "author": "steven-sheehy", "createdAt": "2020-11-04T20:10:32Z", "path": "hedera-mirror-importer/src/test/java/com/hedera/mirror/importer/repository/AddressBookRepositoryTest.java", "diffHunk": "@@ -23,6 +26,10 @@\n     private final EntityId addressBookEntityId101 = EntityId.of(\"0.0.101\", EntityTypeEnum.FILE);\n     private final EntityId addressBookEntityId102 = EntityId.of(\"0.0.102\", EntityTypeEnum.FILE);\n \n+    @Qualifier(CacheConfiguration.NEVER_EXPIRE_LARGE)\n+    @Resource\n+    CacheManager cacheManager;", "originalCommit": "7176f5aa04da26ed23db883a101f511e6afad95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMDEzMg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517620132", "bodyText": "Done", "author": "ijungmann", "createdAt": "2020-11-04T20:44:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMzA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMzA5Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517603096", "body": "Undo", "bodyText": "Undo", "bodyHTML": "<p dir=\"auto\">Undo</p>", "author": "steven-sheehy", "createdAt": "2020-11-04T20:10:39Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/repository/AddressBookRepository.java", "diffHunk": "@@ -27,6 +27,7 @@\n import com.hedera.mirror.importer.domain.AddressBook;\n \n public interface AddressBookRepository extends CrudRepository<AddressBook, Long> {\n+", "originalCommit": "7176f5aa04da26ed23db883a101f511e6afad95b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMDE4Ng==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517620186", "bodyText": "Done", "author": "ijungmann", "createdAt": "2020-11-04T20:44:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYwMzA5Ng=="}], "type": "inlineReview"}, {"oid": "8318c389afc2fe94da288a7aebf4200c4b2be813", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/8318c389afc2fe94da288a7aebf4200c4b2be813", "message": "Revert Address Book Repository changes due to new caching logic\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-11-04T20:25:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTIxMw==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517615213", "body": "the cached address book is built from file 102, here `update()` may be passed either file 101 or 102, so an update from file 101 will unnecessarily evict the cache", "bodyText": "the cached address book is built from file 102, here update() may be passed either file 101 or 102, so an update from file 101 will unnecessarily evict the cache", "bodyHTML": "<p dir=\"auto\">the cached address book is built from file 102, here <code>update()</code> may be passed either file 101 or 102, so an update from file 101 will unnecessarily evict the cache</p>", "author": "xin-hedera", "createdAt": "2020-11-04T20:33:59Z", "path": "hedera-mirror-importer/src/main/java/com/hedera/mirror/importer/addressbook/AddressBookServiceImpl.java", "diffHunk": "@@ -63,6 +68,8 @@\n      * @param fileData file data entry containing address book bytes\n      */\n     @Override\n+    @CacheEvict(cacheNames = ADDRESS_BOOK_CACHE_NAME, cacheManager = NEVER_EXPIRE_LARGE, key =", "originalCommit": "8318c389afc2fe94da288a7aebf4200c4b2be813", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYyMjI3Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517622272", "bodyText": "This has been changed to evict the entire cache.\nI think 102 is still going to get altered in this case, the updatePreviousAddressBook() method looks for the previous 102 address book and updates it.", "author": "ijungmann", "createdAt": "2020-11-04T20:48:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY0NjY1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517646652", "bodyText": "gotcha!", "author": "xin-hedera", "createdAt": "2020-11-04T21:39:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4MjMxOA==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517682318", "bodyText": "You're correct, except that I think that logic is actually a bug. We shouldn't hardcode 102 in updatePreviousAddressBook()", "author": "steven-sheehy", "createdAt": "2020-11-04T23:02:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTIxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzY4OTE1Mg==", "url": "https://github.com/hashgraph/hedera-mirror-node/pull/1226#discussion_r517689152", "bodyText": "Nana opened #1229", "author": "steven-sheehy", "createdAt": "2020-11-04T23:22:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzYxNTIxMw=="}], "type": "inlineReview"}, {"oid": "98fde83cde3877eb945bf6ab4e6c9247d1a337ff", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/98fde83cde3877eb945bf6ab4e6c9247d1a337ff", "message": "Refactor caching annotations\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-11-04T20:40:16Z", "type": "commit"}, {"oid": "aa3274fff876aa2ac92e26752fe8e62bf4ff4e02", "url": "https://github.com/hashgraph/hedera-mirror-node/commit/aa3274fff876aa2ac92e26752fe8e62bf4ff4e02", "message": "Rename caching test\n\nSigned-off-by: Ian Jungmann <ian.jungmann@hedera.com>", "committedDate": "2020-11-04T21:02:25Z", "type": "commit"}]}