{"pr_number": 5449, "pr_title": "Fixes #5409 - HttpClient fails intermittently with \"Invalid response \u2026", "pr_author": "sbordet", "pr_createdAt": "2020-10-13T21:19:24Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5449", "timeline": [{"oid": "c5df807b6d5de75118aca797dc168327b7364ebd", "url": "https://github.com/eclipse/jetty.project/commit/c5df807b6d5de75118aca797dc168327b7364ebd", "message": "Fixes #5409 - HttpClient fails intermittently with \"Invalid response state TRANSIENT\".\n\nThe problem was a race condition during content decoding.\nSince decoding needs to be done in a loop, the condition to loop is to\ncheck whether there is demand for the next chunk of decoded content.\n\nChecking for demand also sets the stalled flag, and this must be done\nonly after the response state has been set back to CONTENT.\nUnfortunately this was not done in the decoding loop.\n\nThe fix is to always update the response state in the decoding loop.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-10-13T21:18:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ1NjQzNw==", "url": "https://github.com/eclipse/jetty.project/pull/5449#discussion_r504456437", "body": "I'm not fond of this method's signature, what do you think of that one instead?\r\n```java\r\nprivate boolean updateResponseState(EnumSet<ResponseState> from, ResponseState to)\r\n```\r\nthat would make the callers look like this:\r\n```java\r\nif (updateResponseState(EnumSet.of(ResponseState.HEADERS, ResponseState.CONTENT), ResponseState.TRANSIENT))\r\n```", "bodyText": "I'm not fond of this method's signature, what do you think of that one instead?\nprivate boolean updateResponseState(EnumSet<ResponseState> from, ResponseState to)\nthat would make the callers look like this:\nif (updateResponseState(EnumSet.of(ResponseState.HEADERS, ResponseState.CONTENT), ResponseState.TRANSIENT))", "bodyHTML": "<p dir=\"auto\">I'm not fond of this method's signature, what do you think of that one instead?</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"private boolean updateResponseState(EnumSet&lt;ResponseState&gt; from, ResponseState to)\"><pre><span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> updateResponseState(<span class=\"pl-k\">EnumSet&lt;<span class=\"pl-smi\">ResponseState</span>&gt;</span> from, <span class=\"pl-smi\">ResponseState</span> to)</pre></div>\n<p dir=\"auto\">that would make the callers look like this:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"if (updateResponseState(EnumSet.of(ResponseState.HEADERS, ResponseState.CONTENT), ResponseState.TRANSIENT))\"><pre><span class=\"pl-k\">if</span> (updateResponseState(<span class=\"pl-smi\">EnumSet</span><span class=\"pl-k\">.</span>of(<span class=\"pl-smi\">ResponseState</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>HEADERS</span>, <span class=\"pl-smi\">ResponseState</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>CONTENT</span>), <span class=\"pl-smi\">ResponseState</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>TRANSIENT</span>))</pre></div>", "author": "lorban", "createdAt": "2020-10-14T07:23:17Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/HttpReceiver.java", "diffHunk": "@@ -614,15 +565,42 @@ public boolean abort(HttpExchange exchange, Throwable failure)\n         }\n     }\n \n+    private boolean updateResponseState(ResponseState from1, ResponseState from2, ResponseState to)", "originalCommit": "c5df807b6d5de75118aca797dc168327b7364ebd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY5MDIxNw==", "url": "https://github.com/eclipse/jetty.project/pull/5449#discussion_r504690217", "bodyText": "It allocates \ud83d\ude03", "author": "sbordet", "createdAt": "2020-10-14T13:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDQ1NjQzNw=="}], "type": "inlineReview"}]}