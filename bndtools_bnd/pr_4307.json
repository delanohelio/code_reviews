{"pr_number": 4307, "pr_title": "BndrunContainer incorrectly assumes artifactId == osgi.identity", "pr_author": "rotty3000", "pr_createdAt": "2020-09-10T03:31:22Z", "pr_url": "https://github.com/bndtools/bnd/pull/4307", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMyODUwMg==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486328502", "body": "This is kind of expensive as it will read the entire jar when all you need is the manifest. It is less costly to use Bnd Domain class (`Domain.domain(File)`) to process the manifest and get the BSN.\r\n\r\nhttps://github.com/bndtools/bnd/blob/aea111f779c5dfd2a91a82d698abb28bb25aaf0b/biz.aQute.bndlib/src/aQute/bnd/osgi/Domain.java#L509-L519", "bodyText": "This is kind of expensive as it will read the entire jar when all you need is the manifest. It is less costly to use Bnd Domain class (Domain.domain(File)) to process the manifest and get the BSN.\n\n  \n    \n      bnd/biz.aQute.bndlib/src/aQute/bnd/osgi/Domain.java\n    \n    \n        Lines 509 to 519\n      in\n      aea111f\n    \n    \n    \n    \n\n        \n          \n           // default & last. Assume JAR \n        \n\n        \n          \n           try (JarFile jf = new JarFile(file, false)) { \n        \n\n        \n          \n           \tManifest m = jf.getManifest(); \n        \n\n        \n          \n           \tif (m != null) { \n        \n\n        \n          \n           \t\tDomain domain = domain(m); \n        \n\n        \n          \n           \t\tJarEntry entry = jf.getJarEntry(domain.getLocalization()); \n        \n\n        \n          \n           \t\tif (entry != null) { \n        \n\n        \n          \n           \t\t\tdomain.translation.load(jf.getInputStream(entry)); \n        \n\n        \n          \n           \t\t} \n        \n\n        \n          \n           \t\treturn domain; \n        \n\n        \n          \n           \t}", "bodyHTML": "<p dir=\"auto\">This is kind of expensive as it will read the entire jar when all you need is the manifest. It is less costly to use Bnd Domain class (<code>Domain.domain(File)</code>) to process the manifest and get the BSN.</p>\n<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/bndtools/bnd/blob/aea111f779c5dfd2a91a82d698abb28bb25aaf0b/biz.aQute.bndlib/src/aQute/bnd/osgi/Domain.java#L509-L519\">bnd/biz.aQute.bndlib/src/aQute/bnd/osgi/Domain.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 509 to 519\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/bndtools/bnd/commit/aea111f779c5dfd2a91a82d698abb28bb25aaf0b\">aea111f</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L509\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"509\"></td>\n          <td id=\"LC509\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-c\"><span class=\"pl-c\">//</span> default &amp; last. Assume JAR</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L510\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"510\"></td>\n          <td id=\"LC510\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">try</span> (<span class=\"pl-smi\">JarFile</span> jf <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">JarFile</span>(file, <span class=\"pl-c1\">false</span>)) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L511\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"511\"></td>\n          <td id=\"LC511\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t<span class=\"pl-smi\">Manifest</span> m <span class=\"pl-k\">=</span> jf<span class=\"pl-k\">.</span>getManifest(); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L512\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"512\"></td>\n          <td id=\"LC512\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t<span class=\"pl-k\">if</span> (m <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L513\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"513\"></td>\n          <td id=\"LC513\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t\t<span class=\"pl-smi\">Domain</span> domain <span class=\"pl-k\">=</span> domain(m); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L514\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"514\"></td>\n          <td id=\"LC514\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t\t<span class=\"pl-smi\">JarEntry</span> entry <span class=\"pl-k\">=</span> jf<span class=\"pl-k\">.</span>getJarEntry(domain<span class=\"pl-k\">.</span>getLocalization()); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L515\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"515\"></td>\n          <td id=\"LC515\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t\t<span class=\"pl-k\">if</span> (entry <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L516\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"516\"></td>\n          <td id=\"LC516\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t\t\tdomain<span class=\"pl-k\">.</span>translation<span class=\"pl-k\">.</span>load(jf<span class=\"pl-k\">.</span>getInputStream(entry)); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L517\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"517\"></td>\n          <td id=\"LC517\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t\t} </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L518\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"518\"></td>\n          <td id=\"LC518\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t\t<span class=\"pl-k\">return</span> domain; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L519\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"519\"></td>\n          <td id=\"LC519\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> \t} </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "bjhargrave", "createdAt": "2020-09-10T13:18:29Z", "path": "biz.aQute.bnd.maven/src/aQute/bnd/maven/lib/resolve/BndrunContainer.java", "diffHunk": "@@ -262,9 +263,19 @@ public void setRunrequiresFromProjectArtifact(Run run) {\n \t\t\t&& (project.getPlugin(\"biz.aQute.bnd:bnd-maven-plugin\") != null)) {\n \n \t\t\tArtifact artifact = project.getArtifact();\n+\t\t\tString bsn = artifact.getArtifactId();\n+\n+\t\t\ttry (Jar jar = new Jar(artifact.getFile())) {", "originalCommit": "df37bdc459793a9d88a525df3b55a2d13cc4c202", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMzMzM0NQ==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486333345", "bodyText": "right right, I'll fix.", "author": "rotty3000", "createdAt": "2020-09-10T13:25:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMyODUwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4MDMwNQ==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486480305", "bodyText": "fixed", "author": "rotty3000", "createdAt": "2020-09-10T16:33:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMyODUwMg=="}], "type": "inlineReview"}, {"oid": "8beb810e77725f50e1716d8fd8faf89a6a0f3c18", "url": "https://github.com/bndtools/bnd/commit/8beb810e77725f50e1716d8fd8faf89a6a0f3c18", "message": "BndrunContainer incorrectly assumes artifactId == osgi.identity\n\nfixes #4189\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>", "committedDate": "2020-09-10T16:32:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Njk1Nw==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486486957", "body": "getBundleSymbolicName can return null. Are you counting on the NPE from `of` ending up in the catch block?", "bodyText": "getBundleSymbolicName can return null. Are you counting on the NPE from of ending up in the catch block?", "bodyHTML": "<p dir=\"auto\">getBundleSymbolicName can return null. Are you counting on the NPE from <code>of</code> ending up in the catch block?</p>", "author": "bjhargrave", "createdAt": "2020-09-10T16:44:10Z", "path": "biz.aQute.bnd.maven/src/aQute/bnd/maven/lib/resolve/BndrunContainer.java", "diffHunk": "@@ -263,8 +265,22 @@ public void setRunrequiresFromProjectArtifact(Run run) {\n \n \t\t\tArtifact artifact = project.getArtifact();\n \n+\t\t\tString bsn = artifact.getArtifactId();\n+\n+\t\t\ttry {\n+\t\t\t\tDomain domain = Domain.domain(artifact.getFile());\n+\n+\t\t\t\tbsn = Optional.of(domain.getBundleSymbolicName())", "originalCommit": "8beb810e77725f50e1716d8fd8faf89a6a0f3c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4NzE3Mw==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486487173", "body": "`.orElseGet(artifact::getArtifactId)`", "bodyText": ".orElseGet(artifact::getArtifactId)", "bodyHTML": "<p dir=\"auto\"><code>.orElseGet(artifact::getArtifactId)</code></p>", "author": "bjhargrave", "createdAt": "2020-09-10T16:44:34Z", "path": "biz.aQute.bnd.maven/src/aQute/bnd/maven/lib/resolve/BndrunContainer.java", "diffHunk": "@@ -263,8 +265,22 @@ public void setRunrequiresFromProjectArtifact(Run run) {\n \n \t\t\tArtifact artifact = project.getArtifact();\n \n+\t\t\tString bsn = artifact.getArtifactId();\n+\n+\t\t\ttry {\n+\t\t\t\tDomain domain = Domain.domain(artifact.getFile());\n+\n+\t\t\t\tbsn = Optional.of(domain.getBundleSymbolicName())\n+\t\t\t\t\t.map(Map.Entry::getKey)\n+\t\t\t\t\t.orElseGet(() -> artifact.getArtifactId());", "originalCommit": "8beb810e77725f50e1716d8fd8faf89a6a0f3c18", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Nzc2Mw==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486487763", "body": "domain can be null. Are you counting on the NPE dereferencing domain ending up in the catch block?", "bodyText": "domain can be null. Are you counting on the NPE dereferencing domain ending up in the catch block?", "bodyHTML": "<p dir=\"auto\">domain can be null. Are you counting on the NPE dereferencing domain ending up in the catch block?</p>", "author": "bjhargrave", "createdAt": "2020-09-10T16:45:24Z", "path": "biz.aQute.bnd.maven/src/aQute/bnd/maven/lib/resolve/BndrunContainer.java", "diffHunk": "@@ -263,8 +265,22 @@ public void setRunrequiresFromProjectArtifact(Run run) {\n \n \t\t\tArtifact artifact = project.getArtifact();\n \n+\t\t\tString bsn = artifact.getArtifactId();\n+\n+\t\t\ttry {\n+\t\t\t\tDomain domain = Domain.domain(artifact.getFile());", "originalCommit": "8beb810e77725f50e1716d8fd8faf89a6a0f3c18", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwMDc2MQ==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486500761", "bodyText": "how about:\n\t\t\tArtifact artifact = project.getArtifact();\n\n\t\t\tString bsn = artifact.getArtifactId();\n\n\t\t\ttry {\n\t\t\t\tbsn = Optional.ofNullable(artifact.getFile())\n\t\t\t\t\t.map(asFunction(Domain::domain))\n\t\t\t\t\t.map(Domain::getBundleSymbolicName)\n\t\t\t\t\t.map(Map.Entry::getKey)\n\t\t\t\t\t.orElseGet(artifact::getArtifactId);\n\t\t\t} catch (Exception e) {\n\t\t\t\tlogger.warn(\n\t\t\t\t\t\"Could not get the Bundle-SymbolicName from the project artifact {}, falling back to artifactId {}\",\n\t\t\t\t\tartifact, bsn, e);\n\t\t\t}", "author": "rotty3000", "createdAt": "2020-09-10T17:07:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Nzc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwMTg4Mw==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486501883", "bodyText": "That's fine, but you will not log any warning if the jar has no manifest or no BSN which I though you wanted to log.", "author": "bjhargrave", "createdAt": "2020-09-10T17:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Nzc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNDYyOA==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486504628", "bodyText": "not precisely, if the project HAS the bnd-maven-plugin (already checked) and the artifact IS NOT a bundle, then something went wrong, no? Isn't that a different problem entirely? the resolver would fail to find the bundle since it couldn't be indexed as a proper OSGi bundle. It was not my intention to capture all those scenarios from this specific logic whose only job is to find a suitable value for inferred -runrequires.", "author": "rotty3000", "createdAt": "2020-09-10T17:13:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Nzc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwNzgwNw==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486507807", "bodyText": "so the question is... should it be capturing all those cases?", "author": "rotty3000", "createdAt": "2020-09-10T17:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Nzc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwODA2OA==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486508068", "bodyText": "I've updated with new logic... let's go from that.", "author": "rotty3000", "createdAt": "2020-09-10T17:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Nzc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUwODY3OQ==", "url": "https://github.com/bndtools/bnd/pull/4307#discussion_r486508679", "bodyText": "I don't think so. I was just pointing out that your original commit logged for all those case. I think we only need to log for the exception case (as long as we don't NPE).", "author": "bjhargrave", "createdAt": "2020-09-10T17:20:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4Nzc2Mw=="}], "type": "inlineReview"}, {"oid": "45b92188799dba623de7510c59d7c8394ca404f4", "url": "https://github.com/bndtools/bnd/commit/45b92188799dba623de7510c59d7c8394ca404f4", "message": "BndrunContainer incorrectly assumes artifactId == osgi.identity\n\nfixes #4189\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>", "committedDate": "2020-09-10T17:17:59Z", "type": "commit"}, {"oid": "45b92188799dba623de7510c59d7c8394ca404f4", "url": "https://github.com/bndtools/bnd/commit/45b92188799dba623de7510c59d7c8394ca404f4", "message": "BndrunContainer incorrectly assumes artifactId == osgi.identity\n\nfixes #4189\n\nSigned-off-by: Raymond Aug\u00e9 <raymond.auge@liferay.com>", "committedDate": "2020-09-10T17:17:59Z", "type": "forcePushed"}]}