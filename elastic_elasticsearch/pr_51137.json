{"pr_number": 51137, "pr_title": "Add ranged readBlob to S3BlobContainer", "pr_author": "ywelsch", "pr_createdAt": "2020-01-17T09:02:55Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51137", "timeline": [{"oid": "c75a2a00069208c68b4ebb124680b1d126731471", "url": "https://github.com/elastic/elasticsearch/commit/c75a2a00069208c68b4ebb124680b1d126731471", "message": "Add ranged readBlob to S3BlobContainer", "committedDate": "2020-01-17T09:00:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MTkzOA==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367851938", "body": "It should be `read_blob_incomplete `", "bodyText": "It should be read_blob_incomplete", "bodyHTML": "<p dir=\"auto\">It should be <code>read_blob_incomplete </code></p>", "author": "tlrx", "createdAt": "2020-01-17T09:54:06Z", "path": "plugins/repository-s3/src/test/java/org/elasticsearch/repositories/s3/S3BlobContainerRetriesTests.java", "diffHunk": "@@ -227,7 +291,9 @@ public void testReadBlobWithPrematureConnectionClose() {\n         });\n \n         final Exception exception = expectThrows(ConnectionClosedException.class, () -> {\n-            try (InputStream stream = blobContainer.readBlob(\"read_blob_incomplete\")) {\n+            try (InputStream stream = randomBoolean() ?\n+                    blobContainer.readBlob(\"read_blob_incomplete\") :\n+                    blobContainer.readBlob(\"read_blob_no_response\", 0, 1)) {", "originalCommit": "c75a2a00069208c68b4ebb124680b1d126731471", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MzU2OA==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367853568", "body": "Maybe just randomize the call to range/non-range read instead of doing both?", "bodyText": "Maybe just randomize the call to range/non-range read instead of doing both?", "bodyHTML": "<p dir=\"auto\">Maybe just randomize the call to range/non-range read instead of doing both?</p>", "author": "tlrx", "createdAt": "2020-01-17T09:57:40Z", "path": "plugins/repository-s3/src/test/java/org/elasticsearch/repositories/s3/S3BlobContainerRetriesTests.java", "diffHunk": "@@ -139,8 +143,12 @@ private BlobContainer createBlobContainer(final @Nullable Integer maxRetries,\n \n     public void testReadNonexistentBlobThrowsNoSuchFileException() {\n         final BlobContainer blobContainer = createBlobContainer(between(1, 5), null, null, null);\n-        final Exception exception = expectThrows(NoSuchFileException.class, () -> blobContainer.readBlob(\"read_nonexistent_blob\"));\n+        Exception exception = expectThrows(NoSuchFileException.class, () -> blobContainer.readBlob(\"read_nonexistent_blob\"));\n         assertThat(exception.getMessage().toLowerCase(Locale.ROOT), containsString(\"blob object [read_nonexistent_blob] not found\"));\n+        final long position = randomLongBetween(0, Long.MAX_VALUE - 1);\n+        final int length = randomIntBetween(0, Math.toIntExact(Math.min(Integer.MAX_VALUE, Long.MAX_VALUE - 1 - position)));", "originalCommit": "c75a2a00069208c68b4ebb124680b1d126731471", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1NDk3OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367854979", "body": "Maybe rename `read_blob_max_retries` ->  `read_range_blob_max_retries` so that each test uses a dedicated Http context (this is no mandatory but can avoid some confusion maybe)?", "bodyText": "Maybe rename read_blob_max_retries ->  read_range_blob_max_retries so that each test uses a dedicated Http context (this is no mandatory but can avoid some confusion maybe)?", "bodyHTML": "<p dir=\"auto\">Maybe rename <code>read_blob_max_retries</code> -&gt;  <code>read_range_blob_max_retries</code> so that each test uses a dedicated Http context (this is no mandatory but can avoid some confusion maybe)?</p>", "author": "tlrx", "createdAt": "2020-01-17T10:00:44Z", "path": "plugins/repository-s3/src/test/java/org/elasticsearch/repositories/s3/S3BlobContainerRetriesTests.java", "diffHunk": "@@ -178,6 +187,50 @@ public void testReadBlobWithRetries() throws Exception {\n         }\n     }\n \n+    public void testReadRangeBlobWithRetries() throws Exception {\n+        final int maxRetries = randomInt(5);\n+        final CountDown countDown = new CountDown(maxRetries + 1);\n+\n+        final byte[] bytes = randomBlobContent();\n+        httpServer.createContext(\"/bucket/read_blob_max_retries\", exchange -> {", "originalCommit": "c75a2a00069208c68b4ebb124680b1d126731471", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1NTY5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367855691", "body": "It pops up here and there, maybe we should put this value in a constant?", "bodyText": "It pops up here and there, maybe we should put this value in a constant?", "bodyHTML": "<p dir=\"auto\">It pops up here and there, maybe we should put this value in a constant?</p>", "author": "tlrx", "createdAt": "2020-01-17T10:02:27Z", "path": "plugins/repository-s3/src/test/java/org/elasticsearch/repositories/s3/S3BlobContainerRetriesTests.java", "diffHunk": "@@ -397,23 +463,47 @@ public void testWriteLargeBlob() throws Exception {\n         return randomByteArrayOfLength(randomIntBetween(1, frequently() ? 512 : 1 << 20)); // rarely up to 1mb\n     }\n \n-    private static int getRangeStart(HttpExchange exchange) {\n+    private static Tuple<Long, Long> getRange(HttpExchange exchange) {\n         final String rangeHeader = exchange.getRequestHeaders().getFirst(\"Range\");\n         if (rangeHeader == null) {\n-            return 0;\n+            return Tuple.tuple(0L, Long.MAX_VALUE - 1);\n         }\n \n-        final Matcher matcher = Pattern.compile(\"^bytes=([0-9]+)-9223372036854775806$\").matcher(rangeHeader);\n+        final Matcher matcher = Pattern.compile(\"^bytes=([0-9]+)-([0-9]+)$\").matcher(rangeHeader);\n         assertTrue(rangeHeader + \" matches expected pattern\", matcher.matches());\n-        return Math.toIntExact(Long.parseLong(matcher.group(1)));\n+        long rangeStart = Long.parseLong(matcher.group(1));\n+        long rangeEnd = Long.parseLong(matcher.group(2));\n+        assertThat(rangeStart, lessThanOrEqualTo(rangeEnd));\n+        return Tuple.tuple(rangeStart, rangeEnd);\n+    }\n+\n+    private static int getRangeStart(HttpExchange exchange) {\n+        return Math.toIntExact(getRange(exchange).v1());\n+    }\n+\n+    private static Optional<Integer> getRangeEnd(HttpExchange exchange) {\n+        final long rangeEnd = getRange(exchange).v2();\n+        if (rangeEnd == Long.MAX_VALUE - 1) {", "originalCommit": "c75a2a00069208c68b4ebb124680b1d126731471", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MjI2OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367852269", "body": "I think we could reasonably drop this constructor and use the ranged one everywhere.", "bodyText": "I think we could reasonably drop this constructor and use the ranged one everywhere.", "bodyHTML": "<p dir=\"auto\">I think we could reasonably drop this constructor and use the ranged one everywhere.</p>", "author": "DaveCTurner", "createdAt": "2020-01-17T09:54:51Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3RetryingInputStream.java", "diffHunk": "@@ -58,17 +60,32 @@\n     private boolean closed;\n \n     S3RetryingInputStream(S3BlobStore blobStore, String blobKey) throws IOException {", "originalCommit": "c75a2a00069208c68b4ebb124680b1d126731471", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk3MDM3MA==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367970370", "bodyText": "I prefer to have a separate constructor instead of passing magical values.", "author": "ywelsch", "createdAt": "2020-01-17T14:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MjI2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzNDk2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r368034966", "bodyText": "ok", "author": "DaveCTurner", "createdAt": "2020-01-17T16:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MjI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1MzU1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367853551", "body": "`end < 0L` is redundant since `0 \u2264 start` and we're also checking for `end < start`.", "bodyText": "end < 0L is redundant since 0 \u2264 start and we're also checking for end < start.", "bodyHTML": "<p dir=\"auto\"><code>end &lt; 0L</code> is redundant since <code>0 \u2264 start</code> and we're also checking for <code>end &lt; start</code>.</p>", "author": "DaveCTurner", "createdAt": "2020-01-17T09:57:38Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3RetryingInputStream.java", "diffHunk": "@@ -58,17 +60,32 @@\n     private boolean closed;\n \n     S3RetryingInputStream(S3BlobStore blobStore, String blobKey) throws IOException {\n+        this(blobStore, blobKey, 0, Long.MAX_VALUE - 1);\n+    }\n+\n+    // both start and end are inclusive bounds, following the definition in GetObjectRequest.setRange\n+    S3RetryingInputStream(S3BlobStore blobStore, String blobKey, long start, long end) throws IOException {\n+        if (start < 0L) {\n+            throw new IllegalArgumentException(\"start must be non-negative\");\n+        }\n+        if (end < 0L || end == Long.MAX_VALUE || end < start) {", "originalCommit": "c75a2a00069208c68b4ebb124680b1d126731471", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg1NDAzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r367854031", "body": "Can still be `final`?", "bodyText": "Can still be final?", "bodyHTML": "<p dir=\"auto\">Can still be <code>final</code>?</p>", "author": "DaveCTurner", "createdAt": "2020-01-17T09:58:36Z", "path": "plugins/repository-s3/src/test/java/org/elasticsearch/repositories/s3/S3BlobContainerRetriesTests.java", "diffHunk": "@@ -139,8 +143,12 @@ private BlobContainer createBlobContainer(final @Nullable Integer maxRetries,\n \n     public void testReadNonexistentBlobThrowsNoSuchFileException() {\n         final BlobContainer blobContainer = createBlobContainer(between(1, 5), null, null, null);\n-        final Exception exception = expectThrows(NoSuchFileException.class, () -> blobContainer.readBlob(\"read_nonexistent_blob\"));", "originalCommit": "c75a2a00069208c68b4ebb124680b1d126731471", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ea74062339fdfcf972ed07fe4e686f364afefce", "url": "https://github.com/elastic/elasticsearch/commit/1ea74062339fdfcf972ed07fe4e686f364afefce", "message": "Simple review comments", "committedDate": "2020-01-17T10:52:28Z", "type": "commit"}, {"oid": "ff4361f8f7b6d85631b92c7fbafae679989e265b", "url": "https://github.com/elastic/elasticsearch/commit/ff4361f8f7b6d85631b92c7fbafae679989e265b", "message": "Consume stream when not fully consumed yet", "committedDate": "2020-01-17T14:41:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzNjE2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r368036165", "body": "I think we need it the other way round:\r\n\r\n```suggestion\r\n            e.addSuppressed(e2);\r\n```", "bodyText": "I think we need it the other way round:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        e2.addSuppressed(e);\n          \n          \n            \n                        e.addSuppressed(e2);", "bodyHTML": "<p dir=\"auto\">I think we need it the other way round:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"x x-first x-last\">e2</span><span class=\"pl-k\">.</span>addSuppressed(<span class=\"x x-first x-last\">e</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first x-last\">e</span><span class=\"pl-k\">.</span>addSuppressed(<span class=\"x x-first x-last\">e2</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "DaveCTurner", "createdAt": "2020-01-17T16:53:10Z", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3RetryingInputStream.java", "diffHunk": "@@ -122,20 +140,33 @@ private void ensureOpen() {\n \n     private void reopenStreamOrFail(IOException e) throws IOException {\n         if (attempt >= maxAttempts) {\n+            logger.debug(new ParameterizedMessage(\"failed reading [{}/{}] at offset [{}], attempt [{}] of [{}], giving up\",\n+                blobStore.bucket(), blobKey, start + currentOffset, attempt, maxAttempts), e);\n             throw addSuppressedExceptions(e);\n         }\n         logger.debug(new ParameterizedMessage(\"failed reading [{}/{}] at offset [{}], attempt [{}] of [{}], retrying\",\n-            blobStore.bucket(), blobKey, currentOffset, attempt, maxAttempts), e);\n+            blobStore.bucket(), blobKey, start + currentOffset, attempt, maxAttempts), e);\n         attempt += 1;\n         if (failures.size() < MAX_SUPPRESSED_EXCEPTIONS) {\n             failures.add(e);\n         }\n+        try {\n+            Streams.consumeFully(currentStream);\n+        } catch (Exception e2) {\n+            e2.addSuppressed(e);", "originalCommit": "ff4361f8f7b6d85631b92c7fbafae679989e265b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MDY1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r368050655", "bodyText": "I actually intended to log it that way. It's not needed anyway, as we already log the original exception above. I have removed this in 0b733f0", "author": "ywelsch", "createdAt": "2020-01-17T17:27:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzNjE2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzOTI3MA==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r368039270", "body": "Apparently this results in a different exception?\r\n\r\n```\r\njava.lang.AssertionError: \r\nExpected: a string containing \"premature end of content-length delimited message body\"\r\n     but: was \"premature end of chunk coded message body: closing chunk expected\"\r\n```", "bodyText": "Apparently this results in a different exception?\njava.lang.AssertionError: \nExpected: a string containing \"premature end of content-length delimited message body\"\n     but: was \"premature end of chunk coded message body: closing chunk expected\"", "bodyHTML": "<p dir=\"auto\">Apparently this results in a different exception?</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.lang.AssertionError: \nExpected: a string containing &quot;premature end of content-length delimited message body&quot;\n     but: was &quot;premature end of chunk coded message body: closing chunk expected&quot;\"><pre><code>java.lang.AssertionError: \nExpected: a string containing \"premature end of content-length delimited message body\"\n     but: was \"premature end of chunk coded message body: closing chunk expected\"\n</code></pre></div>", "author": "DaveCTurner", "createdAt": "2020-01-17T16:59:56Z", "path": "plugins/repository-s3/src/test/java/org/elasticsearch/repositories/s3/S3BlobContainerRetriesTests.java", "diffHunk": "@@ -227,7 +339,9 @@ public void testReadBlobWithPrematureConnectionClose() {\n         });\n \n         final Exception exception = expectThrows(ConnectionClosedException.class, () -> {\n-            try (InputStream stream = blobContainer.readBlob(\"read_blob_incomplete\")) {\n+            try (InputStream stream = randomBoolean() ?\n+                    blobContainer.readBlob(\"read_blob_incomplete\") :\n+                    blobContainer.readBlob(\"read_blob_incomplete\", 0, 1)) {", "originalCommit": "ff4361f8f7b6d85631b92c7fbafae679989e265b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1MDc5OA==", "url": "https://github.com/elastic/elasticsearch/pull/51137#discussion_r368050798", "bodyText": "Thanks, fixed in 6ec202c", "author": "ywelsch", "createdAt": "2020-01-17T17:27:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzOTI3MA=="}], "type": "inlineReview"}, {"oid": "6ec202c332927d1f3cfaf1053102496fc84cc5d3", "url": "https://github.com/elastic/elasticsearch/commit/6ec202c332927d1f3cfaf1053102496fc84cc5d3", "message": "fix test", "committedDate": "2020-01-17T17:24:50Z", "type": "commit"}, {"oid": "0b733f010e737199194f8bdbb90138ecc09ca33a", "url": "https://github.com/elastic/elasticsearch/commit/0b733f010e737199194f8bdbb90138ecc09ca33a", "message": "no need for suppressed exception, already logged", "committedDate": "2020-01-17T17:25:47Z", "type": "commit"}, {"oid": "2b2b69319f39cacbd210423cc6b573fef6b65333", "url": "https://github.com/elastic/elasticsearch/commit/2b2b69319f39cacbd210423cc6b573fef6b65333", "message": "Merge branch 'feature/searchable-snapshots' into repo-range-requests", "committedDate": "2020-01-20T15:56:30Z", "type": "commit"}, {"oid": "65b532d554b5a8e4f2790802a1d1efbaf85c22dc", "url": "https://github.com/elastic/elasticsearch/commit/65b532d554b5a8e4f2790802a1d1efbaf85c22dc", "message": "fix tests", "committedDate": "2020-01-20T20:36:49Z", "type": "commit"}, {"oid": "4ee2d9ffe1f0eeb44bfd1be9e1cd6dcd78331131", "url": "https://github.com/elastic/elasticsearch/commit/4ee2d9ffe1f0eeb44bfd1be9e1cd6dcd78331131", "message": "moar fixes", "committedDate": "2020-01-20T20:56:57Z", "type": "commit"}, {"oid": "cf193742cff6b9dabace211b559e7ac48a6c61ad", "url": "https://github.com/elastic/elasticsearch/commit/cf193742cff6b9dabace211b559e7ac48a6c61ad", "message": "yet more fixes", "committedDate": "2020-01-20T22:07:08Z", "type": "commit"}]}