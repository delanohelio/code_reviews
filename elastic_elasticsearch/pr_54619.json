{"pr_number": 54619, "pr_title": "Async search: create internal index only before storing initial response", "pr_author": "javanna", "pr_createdAt": "2020-04-01T22:43:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54619", "timeline": [{"oid": "cd2cd8740a9de7cb4948f03ade945885a15d3f4f", "url": "https://github.com/elastic/elasticsearch/commit/cd2cd8740a9de7cb4948f03ade945885a15d3f4f", "message": "Async search: create internal index if necessary only before storing initial response\n\nWe currently create the .async-search index if necessary before performing any action (index, update or delete). Truth is that this is needed only before storing the initial response. The other operations are either update or delete, which will anyways not find the document to update/delete even if the index gets created when missing. This also caused `testCancellation` failures as we were trying to delete the document twice from the .async-search index, once from `TransportDeleteAsyncSearchAction` and once as a consequence of the search task being completed. The latter may be called after the test is completed, but before the cluster is shut down and causing problems to the after test checks, for instance if it happens after all the indices have been cleaned up. It is totally fine to try to delete a response that is no longer found, but not quite so if such call will also trigger an index creation.\n\nWith this commit we remove all the calls to createIndexIfNecessary from the update/delete operation, and we leave one call only from storeInitialResponse which is where the index is expected to be created.\n\nCloses #54180", "committedDate": "2020-04-01T22:37:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzQ3NA==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r401953474", "body": "I tried to make this logic more readable. I found the boolean flag hard to reason about especially as it was provided true only once. I moved the listener wrapping to the callers, where each caller needs to do something different.", "bodyText": "I tried to make this logic more readable. I found the boolean flag hard to reason about especially as it was provided true only once. I moved the listener wrapping to the callers, where each caller needs to do something different.", "bodyHTML": "<p dir=\"auto\">I tried to make this logic more readable. I found the boolean flag hard to reason about especially as it was provided true only once. I moved the listener wrapping to the callers, where each caller needs to do something different.</p>", "author": "javanna", "createdAt": "2020-04-01T22:45:08Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchIndexService.java", "diffHunk": "@@ -194,31 +192,16 @@ void updateExpirationTime(String docId,\n         UpdateRequest request = new UpdateRequest().index(INDEX)\n             .id(docId)\n             .doc(source, XContentType.JSON);\n-        createIndexIfNecessary(ActionListener.wrap(v -> client.update(request, listener), listener::onFailure));\n+        client.update(request, listener);\n     }\n \n     /**\n      * Deletes the provided <code>searchId</code> from the index if present.\n      */\n     void deleteResponse(AsyncSearchId searchId,\n-                        boolean failIfNotFound,\n-                        ActionListener<AcknowledgedResponse> listener) {\n+                        ActionListener<DeleteResponse> listener) {\n         DeleteRequest request = new DeleteRequest(INDEX).id(searchId.getDocId());\n-        createIndexIfNecessary(\n-            ActionListener.wrap(v -> client.delete(request,\n-                ActionListener.wrap(\n-                    resp -> {\n-                        if (resp.status() == RestStatus.NOT_FOUND && failIfNotFound) {\n-                            listener.onFailure(new ResourceNotFoundException(searchId.getEncoded()));\n-                        } else {\n-                            listener.onResponse(new AcknowledgedResponse(true));\n-                        }\n-                    },\n-                    exc -> {\n-                        logger.error(() -> new ParameterizedMessage(\"failed to clean async-search [{}]\", searchId.getEncoded()), exc);\n-                        listener.onFailure(exc);\n-                    })),\n-                listener::onFailure));", "originalCommit": "cd2cd8740a9de7cb4948f03ade945885a15d3f4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgyNjg1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r402826855", "bodyText": "++", "author": "jimczi", "createdAt": "2020-04-03T08:24:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzQ3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r401953719", "body": "I was wondering if we are sure about exc.getCause here. What's the top level exception?", "bodyText": "I was wondering if we are sure about exc.getCause here. What's the top level exception?", "bodyHTML": "<p dir=\"auto\">I was wondering if we are sure about exc.getCause here. What's the top level exception?</p>", "author": "javanna", "createdAt": "2020-04-01T22:45:51Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/TransportGetAsyncSearchAction.java", "diffHunk": "@@ -57,8 +59,12 @@ protected void doExecute(Task task, GetAsyncSearchAction.Request request, Action\n                         ActionListener.wrap(\n                             p -> getSearchResponseFromTask(searchId, request, nowInMillis, expirationTime, listener),\n                             exc -> {\n-                                if (exc.getCause() instanceof DocumentMissingException == false) {\n-                                    logger.error(\"failed to retrieve \" + searchId.getEncoded(), exc);\n+                                //don't even log when: the async search document or its index is not found. That can happen if an invalid\n+                                //search id is provided and no async search initial response has been stored yet.\n+                                if (exc.getCause() instanceof DocumentMissingException == false\n+                                    && exc.getCause() instanceof IndexNotFoundException == false) {", "originalCommit": "cd2cd8740a9de7cb4948f03ade945885a15d3f4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0MzQ1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r402843451", "bodyText": "A RemoteTransportException.  Maybe we can replace the instanceof with ExceptionsHelper.status(exc) != RestStatus.NOT_FOUND ?", "author": "jimczi", "createdAt": "2020-04-03T08:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyOTUwMw==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r406729503", "bodyText": "the problem I have with ExceptionsHelper.status(exc) is that it does not look at the cause at all and it gives 500 if it does not know any better. How about ExceptionsHelper.status(ExceptionsHelper.unwrapCause(exc)) ?", "author": "javanna", "createdAt": "2020-04-10T12:08:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzcxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1NjY2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r406756663", "bodyText": "+1", "author": "jimczi", "createdAt": "2020-04-10T13:27:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1MzcxOQ=="}], "type": "inlineReview"}, {"oid": "1e087dbde9a6bbba40d0d30d032e91ca2d6b9090", "url": "https://github.com/elastic/elasticsearch/commit/1e087dbde9a6bbba40d0d30d032e91ca2d6b9090", "message": "Merge branch 'master' into enhancement/async_search_create_index", "committedDate": "2020-04-03T07:59:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0NjUwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r402846500", "body": "We shouldn't fail If the document is missing:\r\n```suggestion\r\n                        if (ExceptionsHelper.status(exc) == RestStatus.NOT_FOUND) {\r\n```", "bodyText": "We shouldn't fail If the document is missing:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    if (exc.getCause() instanceof IndexNotFoundException) {\n          \n          \n            \n                                    if (ExceptionsHelper.status(exc) == RestStatus.NOT_FOUND) {", "bodyHTML": "<p dir=\"auto\">We shouldn't fail If the document is missing:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        <span class=\"pl-k\">if</span> (<span class=\"x x-first\">exc</span><span class=\"pl-k x\">.</span><span class=\"x\">getCause() </span><span class=\"pl-k x\">instanceof</span><span class=\"x\"> </span><span class=\"pl-smi x x-last\">IndexNotFoundException</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        <span class=\"pl-k\">if</span> (<span class=\"pl-smi x x-first\">ExceptionsHelper</span><span class=\"pl-k x\">.</span><span class=\"x\">status(exc) </span><span class=\"pl-k x\">==</span><span class=\"x\"> </span><span class=\"pl-smi x\">RestStatus</span><span class=\"pl-c1\"><span class=\"pl-k x\">.</span><span class=\"x x-last\">NOT_FOUND</span></span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jimczi", "createdAt": "2020-04-03T08:47:07Z", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/TransportDeleteAsyncSearchAction.java", "diffHunk": "@@ -58,15 +67,40 @@ protected void doExecute(Task task, DeleteAsyncSearchAction.Request request, Act\n         }\n     }\n \n-    private void cancelTaskAndDeleteResult(AsyncSearchId searchId, ActionListener<AcknowledgedResponse> listener) throws IOException {\n+    void cancelTaskAndDeleteResult(AsyncSearchId searchId, ActionListener<AcknowledgedResponse> listener) throws IOException {\n         AsyncSearchTask task = store.getTask(taskManager, searchId);\n         if (task != null) {\n-            task.cancelTask(() -> store.deleteResponse(searchId, false, listener));\n+            //the task was found and gets cancelled. The response may or may not be found, but we will return 200 anyways.\n+            task.cancelTask(() -> store.deleteResponse(searchId,\n+                ActionListener.wrap(\n+                    r -> listener.onResponse(new AcknowledgedResponse(true)),\n+                    exc -> {\n+                        //the index may not be there (no initial async search response stored yet?): we still want to return 200\n+                        if (exc.getCause() instanceof IndexNotFoundException) {", "originalCommit": "1e087dbde9a6bbba40d0d30d032e91ca2d6b9090", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyNTkxNA==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r406725914", "bodyText": "we don't, document missing does not come back as a failure. Yet, I agree on changing the condition as exc.getCause() instanceof IndexNotFoundException is not great", "author": "javanna", "createdAt": "2020-04-10T11:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0NjUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1Njg0Ng==", "url": "https://github.com/elastic/elasticsearch/pull/54619#discussion_r406756846", "bodyText": "++, thanks", "author": "jimczi", "createdAt": "2020-04-10T13:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg0NjUwMA=="}], "type": "inlineReview"}, {"oid": "5bbde18791467d2522dc4159702dcdf61fd1c7e7", "url": "https://github.com/elastic/elasticsearch/commit/5bbde18791467d2522dc4159702dcdf61fd1c7e7", "message": "Merge branch 'master' into enhancement/async_search_create_index", "committedDate": "2020-04-10T09:34:14Z", "type": "commit"}, {"oid": "f739f197e0da833a97801d70d73835431c5e4348", "url": "https://github.com/elastic/elasticsearch/commit/f739f197e0da833a97801d70d73835431c5e4348", "message": "iter", "committedDate": "2020-04-10T12:12:06Z", "type": "commit"}, {"oid": "b2f956dea50bc9b936d280ac926d2bba304e01a1", "url": "https://github.com/elastic/elasticsearch/commit/b2f956dea50bc9b936d280ac926d2bba304e01a1", "message": "checkstyle", "committedDate": "2020-04-10T12:18:40Z", "type": "commit"}]}