{"pr_number": 63931, "pr_title": "make sure AggregationTest creates reduced aggregations.", "pr_author": "iverase", "pr_createdAt": "2020-10-20T12:15:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63931", "timeline": [{"oid": "8bbdb64473aaa483d245d8f3f2afd93021531d19", "url": "https://github.com/elastic/elasticsearch/commit/8bbdb64473aaa483d245d8f3f2afd93021531d19", "message": "make sure aggregation list has at least one element", "committedDate": "2020-10-20T12:08:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MjQxOA==", "url": "https://github.com/elastic/elasticsearch/pull/63931#discussion_r508462418", "body": "I don't think this is the right fix. The tests that fail are the one that always expect a reduced aggregation so they require a single element. That's why `InternalAggregationTestCase#createTestInstanceForXContent` was added but it's not used in `AggregationsTests`. See https://github.com/elastic/elasticsearch/blob/f20699ead53b8912918f4bda6cbfe89a61b8b983/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java#L299 where replacing the call with `createTestInstanceForXContent` fixes all the failures.", "bodyText": "I don't think this is the right fix. The tests that fail are the one that always expect a reduced aggregation so they require a single element. That's why InternalAggregationTestCase#createTestInstanceForXContent was added but it's not used in AggregationsTests. See \n  \n    \n      elasticsearch/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java\n    \n    \n         Line 299\n      in\n      f20699e\n    \n    \n    \n    \n\n        \n          \n           aggs.add(testCase.createTestInstance()); \n        \n    \n  \n\n where replacing the call with createTestInstanceForXContent fixes all the failures.", "bodyHTML": "<p dir=\"auto\">I don't think this is the right fix. The tests that fail are the one that always expect a reduced aggregation so they require a single element. That's why <code>InternalAggregationTestCase#createTestInstanceForXContent</code> was added but it's not used in <code>AggregationsTests</code>. See <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/elastic/elasticsearch/blob/f20699ead53b8912918f4bda6cbfe89a61b8b983/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java#L299\">elasticsearch/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 299\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/elastic/elasticsearch/commit/f20699ead53b8912918f4bda6cbfe89a61b8b983\">f20699e</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L299\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"299\"></td>\n          <td id=\"LC299\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> aggs<span class=\"pl-k\">.</span>add(testCase<span class=\"pl-k\">.</span>createTestInstance()); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n where replacing the call with <code>createTestInstanceForXContent</code> fixes all the failures.</p>", "author": "jimczi", "createdAt": "2020-10-20T12:35:08Z", "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/InternalScriptedMetricTests.java", "diffHunk": "@@ -91,7 +91,7 @@ protected InternalScriptedMetric createTestInstance(String name, Map<String, Obj\n     }\n \n     private List<Object> randomAggregations() {\n-        return randomList(randomBoolean() ? 1 : 5, this::randomAggregation);\n+        return randomList(1, randomBoolean() ? 1 : 5, this::randomAggregation);", "originalCommit": "8bbdb64473aaa483d245d8f3f2afd93021531d19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2OTQwMA==", "url": "https://github.com/elastic/elasticsearch/pull/63931#discussion_r508469400", "bodyText": "Yeah. I think the correct fix is in AggregationsTests.java to replace:\n            aggs.add(testCase.createTestInstance());\n\nwith:\n            aggs.add(testCase.createTestInstanceForXContent());\n\nI had long forgotten about this test!", "author": "nik9000", "createdAt": "2020-10-20T12:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MjQxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ3OTk5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/63931#discussion_r508479997", "bodyText": "ups, thanks @jimczi you are right. I guess we will need to make that method accessible to the test as currently is protected.", "author": "iverase", "createdAt": "2020-10-20T13:00:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2MjQxOA=="}], "type": "inlineReview"}, {"oid": "cca16eaa99c77b4f8f6e34f8da81ad3d390e2e47", "url": "https://github.com/elastic/elasticsearch/commit/cca16eaa99c77b4f8f6e34f8da81ad3d390e2e47", "message": "apply fix by making createTestInstanceForXContent accessible to the test", "committedDate": "2020-10-20T12:59:26Z", "type": "commit"}]}