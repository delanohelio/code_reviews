{"pr_number": 60314, "pr_title": "[ML] Remove unnecessary version constraints", "pr_author": "edsavage", "pr_createdAt": "2020-07-28T16:24:46Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/60314", "timeline": [{"oid": "5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "url": "https://github.com/elastic/elasticsearch/commit/5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "message": "[ML] Remove unnecessary version constraints\n\nRemove checks on version numbers from the serialisation code that are no longer necessary in the 8.0.0 branch", "committedDate": "2020-07-28T16:15:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxNTIyNg==", "url": "https://github.com/elastic/elasticsearch/pull/60314#discussion_r461715226", "body": "For this file it is probably worth leaving the BWC code in master for a bit longer.  It's very complex and would be a nasty shock for someone seeing it for the first time on a backport to 7.x.", "bodyText": "For this file it is probably worth leaving the BWC code in master for a bit longer.  It's very complex and would be a nasty shock for someone seeing it for the first time on a backport to 7.x.", "bodyHTML": "<p dir=\"auto\">For this file it is probably worth leaving the BWC code in master for a bit longer.  It's very complex and would be a nasty shock for someone seeing it for the first time on a backport to 7.x.</p>", "author": "droberts195", "createdAt": "2020-07-28T16:30:29Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/GetDataFrameAnalyticsStatsAction.java", "diffHunk": "@@ -193,26 +192,13 @@ public Stats(StreamInput in) throws IOException {\n                 id = in.readString();\n                 state = DataFrameAnalyticsState.fromStream(in);\n                 failureReason = in.readOptionalString();\n-                if (in.getVersion().before(Version.V_7_4_0)) {\n-                    progress = readProgressFromLegacy(state, in);", "originalCommit": "5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcyMTAzNg==", "url": "https://github.com/elastic/elasticsearch/pull/60314#discussion_r461721036", "body": "As above, this is very complex and it would be useful for anyone changing it on the master branch to be aware the complexity exists in 7.x.  So it's probably best to leave this file untouched until closer to 8.0 feature freeze too.", "bodyText": "As above, this is very complex and it would be useful for anyone changing it on the master branch to be aware the complexity exists in 7.x.  So it's probably best to leave this file untouched until closer to 8.0 feature freeze too.", "bodyHTML": "<p dir=\"auto\">As above, this is very complex and it would be useful for anyone changing it on the master branch to be aware the complexity exists in 7.x.  So it's probably best to leave this file untouched until closer to 8.0 feature freeze too.</p>", "author": "droberts195", "createdAt": "2020-07-28T16:40:04Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/InternalInferModelAction.java", "diffHunk": "@@ -72,18 +67,7 @@ public Request(StreamInput in) throws IOException {\n             super(in);\n             this.modelId = in.readString();\n             this.objectsToInfer = Collections.unmodifiableList(in.readList(StreamInput::readMap));\n-            if (in.getVersion().onOrAfter(Version.V_7_8_0)) {\n-                this.update = in.readNamedWriteable(InferenceConfigUpdate.class);\n-            } else {\n-                InferenceConfig oldConfig = in.readNamedWriteable(InferenceConfig.class);\n-                if (oldConfig instanceof RegressionConfig) {\n-                    this.update = RegressionConfigUpdate.fromConfig((RegressionConfig)oldConfig);\n-                } else if (oldConfig instanceof ClassificationConfig) {\n-                    this.update = ClassificationConfigUpdate.fromConfig((ClassificationConfig) oldConfig);\n-                } else {\n-                    throw new IOException(\"Unexpected configuration type [\" + oldConfig.getName() + \"]\");\n-                }\n-            }", "originalCommit": "5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcyMjk5Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60314#discussion_r461722996", "body": "There's no need to have a separate local variable now.\r\n\r\n```suggestion\r\n        out.writeEnum(this);\r\n```\r\n\r\nplus delete the line `DataFrameAnalyticsState toWrite = this;`", "bodyText": "There's no need to have a separate local variable now.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    out.writeEnum(toWrite);\n          \n          \n            \n                    out.writeEnum(this);\n          \n      \n    \n    \n  \n\nplus delete the line DataFrameAnalyticsState toWrite = this;", "bodyHTML": "<p dir=\"auto\">There's no need to have a separate local variable now.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        out<span class=\"pl-k\">.</span>writeEnum(<span class=\"x x-first x-last\">toWrite</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        out<span class=\"pl-k\">.</span>writeEnum(<span class=\"pl-c1 x x-first x-last\">this</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">plus delete the line <code>DataFrameAnalyticsState toWrite = this;</code></p>", "author": "droberts195", "createdAt": "2020-07-28T16:43:12Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsState.java", "diffHunk": "@@ -29,11 +28,7 @@ public static DataFrameAnalyticsState fromStream(StreamInput in) throws IOExcept\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         DataFrameAnalyticsState toWrite = this;\n-        if (out.getVersion().before(Version.V_7_5_0) && toWrite == STARTING) {\n-            // Before 7.5.0 there was no STARTING state and jobs for which\n-            // tasks existed but were unassigned were considered STOPPED\n-            toWrite = STOPPED;\n-        }\n+\n         out.writeEnum(toWrite);", "originalCommit": "5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcyOTE1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/60314#discussion_r461729156", "body": "This needs to stay.  The 7.5 here is embedded in the config document, not the node version.  Unless we do something else 8.x _will_ still have to cope with configs created in 7.5 and before.", "bodyText": "This needs to stay.  The 7.5 here is embedded in the config document, not the node version.  Unless we do something else 8.x will still have to cope with configs created in 7.5 and before.", "bodyHTML": "<p dir=\"auto\">This needs to stay.  The 7.5 here is embedded in the config document, not the node version.  Unless we do something else 8.x <em>will</em> still have to cope with configs created in 7.5 and before.</p>", "author": "droberts195", "createdAt": "2020-07-28T16:53:02Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsConfigTests.java", "diffHunk": "@@ -468,24 +451,6 @@ public void testToXContent_GivenAnalysisWithRandomizeSeedAndVersionIsCurrent() t\n         }\n     }\n \n-    public void testToXContent_GivenAnalysisWithRandomizeSeedAndVersionIsBeforeItWasIntroduced() throws IOException {", "originalCommit": "5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcyOTg0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/60314#discussion_r461729841", "body": "As with outlier detection, the version here is in the config, not the current node version, so this should stay.", "bodyText": "As with outlier detection, the version here is in the config, not the current node version, so this should stay.", "bodyHTML": "<p dir=\"auto\">As with outlier detection, the version here is in the config, not the current node version, so this should stay.</p>", "author": "droberts195", "createdAt": "2020-07-28T16:54:09Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/ClassificationTests.java", "diffHunk": "@@ -299,16 +299,6 @@ public void testGetExplicitlyMappedFields() {\n             equalTo(Collections.singletonMap(\"results.feature_importance\", MapUtils.featureImportanceMapping())));\n     }\n \n-    public void testToXContent_GivenVersionBeforeRandomizeSeedWasIntroduced() throws IOException {", "originalCommit": "5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTczMDIxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60314#discussion_r461730219", "body": "As with outlier detection, the version here is in the config, not the current node version, so this should stay.", "bodyText": "As with outlier detection, the version here is in the config, not the current node version, so this should stay.", "bodyHTML": "<p dir=\"auto\">As with outlier detection, the version here is in the config, not the current node version, so this should stay.</p>", "author": "droberts195", "createdAt": "2020-07-28T16:54:50Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/RegressionTests.java", "diffHunk": "@@ -221,17 +221,6 @@ public void testExtractJobIdFromStateDoc() {\n         assertThat(Regression.extractJobIdFromStateDoc(\"noop\"), is(nullValue()));\n     }\n \n-    public void testToXContent_GivenVersionBeforeRandomizeSeedWasIntroduced() throws IOException {", "originalCommit": "5a214ad3a5f6e4d84170cf3d80779fb1a605f718", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4c04f7e0e8a654ca47ba7064b12fc5143eca5a9", "url": "https://github.com/elastic/elasticsearch/commit/c4c04f7e0e8a654ca47ba7064b12fc5143eca5a9", "message": "[ML] Attending to code review comments\n\nReverting the more complex changes as these are best dealt with after\n8.0.0 feature freeze.", "committedDate": "2020-07-30T13:42:25Z", "type": "commit"}, {"oid": "d37bacde7b2e7a29f8f39a774f26f846fb323a7e", "url": "https://github.com/elastic/elasticsearch/commit/d37bacde7b2e7a29f8f39a774f26f846fb323a7e", "message": "Merge branch 'master' of github.com:elasticsearch/elasticsearch into remove_version_constraints", "committedDate": "2020-07-30T13:49:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzU3MjcxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/60314#discussion_r463572719", "body": "nit: a space has accidentally been removed from this line", "bodyText": "nit: a space has accidentally been removed from this line", "bodyHTML": "<p dir=\"auto\">nit: a space has accidentally been removed from this line</p>", "author": "droberts195", "createdAt": "2020-07-31T12:09:04Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/JobNodeSelector.java", "diffHunk": "@@ -82,10 +81,7 @@ public JobNodeSelector(ClusterState clusterState, String jobId, String taskName,\n \n     public PersistentTasksCustomMetadata.Assignment selectNode(int dynamicMaxOpenJobs, int maxConcurrentJobAllocations,\n                                                                int maxMachineMemoryPercent, boolean isMemoryTrackerRecentlyRefreshed) {\n-        // TODO: remove in 8.0.0\n-        boolean allNodesHaveDynamicMaxWorkers = clusterState.getNodes().getMinNodeVersion().onOrAfter(Version.V_7_2_0);\n-\n-        // Try to allocate jobs according to memory usage, but if that's not possible (maybe due to a mixed version cluster or maybe\n+       // Try to allocate jobs according to memory usage, but if that's not possible (maybe due to a mixed version cluster or maybe", "originalCommit": "d37bacde7b2e7a29f8f39a774f26f846fb323a7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9e662a43c919eca0cb7e3a139d206d75b3681c22", "url": "https://github.com/elastic/elasticsearch/commit/9e662a43c919eca0cb7e3a139d206d75b3681c22", "message": "[ML] Further review comments\n\nReinstating accidentally removed space", "committedDate": "2020-07-31T12:14:18Z", "type": "commit"}, {"oid": "62125afbf2088b2500184aa002864337c39b7df1", "url": "https://github.com/elastic/elasticsearch/commit/62125afbf2088b2500184aa002864337c39b7df1", "message": "Merge branch 'master' of github.com:elasticsearch/elasticsearch into remove_version_constraints", "committedDate": "2020-07-31T14:36:03Z", "type": "commit"}]}