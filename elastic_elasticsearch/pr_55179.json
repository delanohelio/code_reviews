{"pr_number": 55179, "pr_title": "Add support for more named curves", "pr_author": "jkakavas", "pr_createdAt": "2020-04-14T19:24:38Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55179", "timeline": [{"oid": "6b6965eafae55e665fd23bcb50d416770c632b3b", "url": "https://github.com/elastic/elasticsearch/commit/6b6965eafae55e665fd23bcb50d416770c632b3b", "message": "Add support for more named curves\n\nWe implicitly only supported the prime256v1 ( aka secp256r1 )\ncurve for the EC keys we read as PEM files to be used in any\nSSL Context. We would not fail when trying to read a key\npair using a different curve but we would silently assume\nthat it was using `secp256r1` which would lead to strange\nTLS handshake issues if the curve was actually another one.\n\nThis commit fixes that behavior in that it\nsupports parsing EC keys that use any of the named curves\ndefined in rfc5915 and rfc5480 making no assumptions about\nwhether the security provider in use supports them (JDK8 and\nhigher support all the curves defined in rfc5480).", "committedDate": "2020-04-14T19:19:34Z", "type": "commit"}, {"oid": "b815d3e73bc4c07f300913ce1d2a436b1884e8e6", "url": "https://github.com/elastic/elasticsearch/commit/b815d3e73bc4c07f300913ce1d2a436b1884e8e6", "message": "add missing resources", "committedDate": "2020-04-14T19:47:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ4NjEwMg==", "url": "https://github.com/elastic/elasticsearch/pull/55179#discussion_r408486102", "body": "```suggestion\r\n        throw new GeneralSecurityException(\"Error parsing EC named curve identifier. Named curve with OID: \" + oidString \r\n            + \" is not supported\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new GeneralSecurityException(\"Error parsing EC named curve identifier. Named curve with OID: \" + oidString + \" is not \" +\n          \n          \n            \n                        \"supported\");\n          \n          \n            \n                    throw new GeneralSecurityException(\"Error parsing EC named curve identifier. Named curve with OID: \" + oidString \n          \n          \n            \n                        + \" is not supported\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">GeneralSecurityException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Error parsing EC named curve identifier. Named curve with OID: <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> oidString <span class=\"pl-k x x-first\">+</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\"> is not </span><span class=\"pl-pds x\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x x-last\">+</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-s\"><span class=\"pl-pds x x-first x-last\">\"</span>supported<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">GeneralSecurityException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Error parsing EC named curve identifier. Named curve with OID: <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> oidString </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k x x-first\">+</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x x-last\"> is not </span>supported<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-04-14T23:04:34Z", "path": "libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/PemUtils.java", "diffHunk": "@@ -602,4 +605,42 @@ private static String getKeyAlgorithmIdentifier(byte[] keyBytes) throws IOExcept\n         return certificates;\n     }\n \n+    private static String getEcCurveNameFromOid(String oidString) throws GeneralSecurityException {\n+        switch (oidString) {\n+            // see https://tools.ietf.org/html/rfc5480#section-2.1.1.1\n+            case \"1.2.840.10045.3.1\":\n+                return \"secp192r1\";\n+            case \"1.3.132.0.1\":\n+                return \"sect163k1\";\n+            case \"1.3.132.0.15\":\n+                return \"sect163r2\";\n+            case \"1.3.132.0.33\":\n+                return \"secp224r1\";\n+            case \"1.3.132.0.26\":\n+                return \"sect233k1\";\n+            case \"1.3.132.0.27\":\n+                return \"sect233r1\";\n+            case \"1.2.840.10045.3.1.7\":\n+                return \"secp256r1\";\n+            case \"1.3.132.0.16\":\n+                return \"sect283k1\";\n+            case \"1.3.132.0.17\":\n+                return \"sect283r1\";\n+            case \"1.3.132.0.34\":\n+                return \"secp384r1\";\n+            case \"1.3.132.0.36\":\n+                return \"sect409k1\";\n+            case \"1.3.132.0.37\":\n+                return \"sect409r1\";\n+            case \"1.3.132.0.35\":\n+                return \"secp521r1\";\n+            case \"1.3.132.0.38\":\n+                return \"sect571k1\";\n+            case \"1.3.132.0.39\":\n+                return \"sect571r1\";\n+        }\n+        throw new GeneralSecurityException(\"Error parsing EC named curve identifier. Named curve with OID: \" + oidString + \" is not \" +\n+            \"supported\");", "originalCommit": "b815d3e73bc4c07f300913ce1d2a436b1884e8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "42e71b15de25021b50ae58c11d59c19ac6d91467", "url": "https://github.com/elastic/elasticsearch/commit/42e71b15de25021b50ae58c11d59c19ac6d91467", "message": "Update libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/PemUtils.java\n\nCo-Authored-By: Tim Vernum <tim@adjective.org>", "committedDate": "2020-04-15T04:37:13Z", "type": "commit"}]}