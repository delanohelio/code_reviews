{"pr_number": 53593, "pr_title": "Add supported NameID Format configuration and generate transient values", "pr_author": "jkakavas", "pr_createdAt": "2020-03-16T10:57:30Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53593", "timeline": [{"oid": "1883588304ba86e55ab87b9ae13415a125aa0544", "url": "https://github.com/elastic/elasticsearch/commit/1883588304ba86e55ab87b9ae13415a125aa0544", "message": "Add supported NameID Format configuration\n\nOnly transient is supported for now.", "committedDate": "2020-03-15T15:35:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzNzM3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53593#discussion_r392937376", "body": "I don't like this much as this is _yet another_ part of the code where we do some validation on the Document but this is the only place that validation depends on IDP configuration so it didn't make sense for this to be part of SecurityProviderDocument. I'm happy to discuss or take suggestions for refactoring this. ", "bodyText": "I don't like this much as this is yet another part of the code where we do some validation on the Document but this is the only place that validation depends on IDP configuration so it didn't make sense for this to be part of SecurityProviderDocument. I'm happy to discuss or take suggestions for refactoring this.", "bodyHTML": "<p dir=\"auto\">I don't like this much as this is <em>yet another</em> part of the code where we do some validation on the Document but this is the only place that validation depends on IDP configuration so it didn't make sense for this to be part of SecurityProviderDocument. I'm happy to discuss or take suggestions for refactoring this.</p>", "author": "jkakavas", "createdAt": "2020-03-16T10:59:22Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportPutSamlServiceProviderAction.java", "diffHunk": "@@ -56,6 +59,10 @@ protected void doExecute(Task task, final PutSamlServiceProviderRequest request,\n             listener.onFailure(new IllegalArgumentException(\"request document must not have an id [\" + document.docId + \"]\"));\n             return;\n         }\n+        if (document.nameIdFormat != null && identityProvider.getAllowedNameIdFormats().contains(document.nameIdFormat) == false) {", "originalCommit": "1883588304ba86e55ab87b9ae13415a125aa0544", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNDQ2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53593#discussion_r393424467", "bodyText": "I think this makes sense. We don't want to fail writes to documents just because the nameID format isn't valid - for example, it would make it impossible to disable a broken SP.\nIt would be logically sensible to do it in the request, but requests aren't really setup to do that sort of validation.", "author": "tvernum", "createdAt": "2020-03-17T03:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkzNzM3Ng=="}], "type": "inlineReview"}, {"oid": "5262d063e059fc7ca2806aac7c3047b8f0c50709", "url": "https://github.com/elastic/elasticsearch/commit/5262d063e059fc7ca2806aac7c3047b8f0c50709", "message": "Merge branch 'feature-internal-idp' into handle-nameid", "committedDate": "2020-03-17T02:39:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQyNTI5OA==", "url": "https://github.com/elastic/elasticsearch/pull/53593#discussion_r393425298", "body": "```suggestion\r\n                throw new IllegalStateException(\"Unsupported NameID Format: \" + format);\r\n```\r\nI can see someone running into this in 6 months time and wondering why PERSISTENT is \"invalid\"", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new IllegalStateException(\"Invalid NameID Format: \" + format);\n          \n          \n            \n                            throw new IllegalStateException(\"Unsupported NameID Format: \" + format);\n          \n      \n    \n    \n  \n\nI can see someone running into this in 6 months time and wondering why PERSISTENT is \"invalid\"", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalStateException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">Invalid</span> NameID Format: <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> format);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalStateException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">Unsupported</span> NameID Format: <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> format);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I can see someone running into this in 6 months time and wondering why PERSISTENT is \"invalid\"</p>", "author": "tvernum", "createdAt": "2020-03-17T03:26:25Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java", "diffHunk": "@@ -221,13 +223,25 @@ private Status buildStatus() {\n     private NameID buildNameId(UserServiceAuthentication user, @Nullable SamlAuthenticationState authnState) {\n         final SamlServiceProvider serviceProvider = user.getServiceProvider();\n         final NameID nameID = samlFactory.object(NameID.class, NameID.DEFAULT_ELEMENT_NAME);\n+        final String nameIdFormat;\n         if (authnState != null && authnState.getRequestedNameidFormat() != null) {\n-            nameID.setFormat(authnState.getRequestedNameidFormat());\n+            nameIdFormat = authnState.getRequestedNameidFormat();\n         } else {\n-            nameID.setFormat(serviceProvider.getAllowedNameIdFormat() != null ? serviceProvider.getAllowedNameIdFormat() :\n-                idp.getServiceProviderDefaults().nameIdFormat);\n+            nameIdFormat = serviceProvider.getAllowedNameIdFormat() != null ? serviceProvider.getAllowedNameIdFormat() :\n+                idp.getServiceProviderDefaults().nameIdFormat;\n         }\n-        // TODO: Set the value according to the format\n+        nameID.setFormat(nameIdFormat);\n+        nameID.setValue(getNameIdValueForFormat(nameIdFormat, user));\n         return nameID;\n     }\n+\n+    private String getNameIdValueForFormat(String format, UserServiceAuthentication user) {\n+        switch (format) {\n+            case TRANSIENT:\n+                // See SAML 2.0 Core 8.3.8 & 1.3.4\n+                return samlFactory.secureIdentifier();\n+            default:\n+                throw new IllegalStateException(\"Invalid NameID Format: \" + format);", "originalCommit": "5262d063e059fc7ca2806aac7c3047b8f0c50709", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "47a99b5bf2ed12eeed67532a5c9359328f8b8d9b", "url": "https://github.com/elastic/elasticsearch/commit/47a99b5bf2ed12eeed67532a5c9359328f8b8d9b", "message": "Update x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java\n\nCo-Authored-By: Tim Vernum <tim@adjective.org>", "committedDate": "2020-03-17T09:21:57Z", "type": "commit"}]}