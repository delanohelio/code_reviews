{"pr_number": 63416, "pr_title": "Simplify reroute counting in InternalSnapshotsInfoServiceTests", "pr_author": "tlrx", "pr_createdAt": "2020-10-07T15:21:49Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/63416", "timeline": [{"oid": "428e1ac350e66974c510f8ff2df81287244dc9e2", "url": "https://github.com/elastic/elasticsearch/commit/428e1ac350e66974c510f8ff2df81287244dc9e2", "message": "Simplify reroute counting", "committedDate": "2020-10-07T15:15:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4Mjg5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/63416#discussion_r501582891", "body": "I wonder, couldn't we get rid of the busy asserting completely by doing this via a latch (has the slight upside that we verify exact count a little stronger with the assertion on the latch count?)?\r\n\r\ne.g.:\r\n\r\n```diff\r\ndiff --git a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\r\nindex a4483bd5ce2..fdcdcdb013f 100644\r\n--- a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\r\n+++ b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\r\n@@ -120,12 +120,20 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\r\n \r\n     public void testSnapshotShardSizes() throws Exception {\r\n         final int maxConcurrentFetches = randomIntBetween(1, 10);\r\n+\r\n+        final int numberOfShards = randomIntBetween(1, 50);\r\n+        final CountDownLatch rerouteLatch = new CountDownLatch(numberOfShards);\r\n+        final RerouteService rerouteService = (reason, priority, listener) -> {\r\n+            listener.onResponse(clusterService.state());\r\n+            assertThat(rerouteLatch.getCount(), greaterThanOrEqualTo(0L));\r\n+            rerouteLatch.countDown();\r\n+        };\r\n+\r\n         final InternalSnapshotsInfoService snapshotsInfoService =\r\n             new InternalSnapshotsInfoService(Settings.builder()\r\n                 .put(INTERNAL_SNAPSHOT_INFO_MAX_CONCURRENT_FETCHES_SETTING.getKey(), maxConcurrentFetches)\r\n                 .build(), clusterService, () -> repositoriesService, () -> rerouteService);\r\n \r\n-        final int numberOfShards = randomIntBetween(1, 50);\r\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\r\n         final long[] expectedShardSizes = new long[numberOfShards];\r\n         for (int i = 0; i < expectedShardSizes.length; i++) {\r\n@@ -163,12 +171,10 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\r\n \r\n         latch.countDown();\r\n \r\n-        assertBusy(() -> {\r\n-            assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\r\n-            assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\r\n-            assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\r\n-        });\r\n-        verify(rerouteService, times(numberOfShards)).reroute(anyString(), any(Priority.class), any());\r\n+        assertTrue(rerouteLatch.await(10L, TimeUnit.SECONDS));\r\n+        assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\r\n+        assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\r\n+        assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\r\n         assertThat(getShardSnapshotStatusCount.get(), equalTo(numberOfShards));\r\n \r\n         final SnapshotShardSizeInfo snapshotShardSizeInfo = snapshotsInfoService.snapshotShardSizes();\r\n```\r\n\r\nJust a suggestion :) this approach looks fine as well.", "bodyText": "I wonder, couldn't we get rid of the busy asserting completely by doing this via a latch (has the slight upside that we verify exact count a little stronger with the assertion on the latch count?)?\ne.g.:\ndiff --git a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\nindex a4483bd5ce2..fdcdcdb013f 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\n@@ -120,12 +120,20 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n     public void testSnapshotShardSizes() throws Exception {\n         final int maxConcurrentFetches = randomIntBetween(1, 10);\n+\n+        final int numberOfShards = randomIntBetween(1, 50);\n+        final CountDownLatch rerouteLatch = new CountDownLatch(numberOfShards);\n+        final RerouteService rerouteService = (reason, priority, listener) -> {\n+            listener.onResponse(clusterService.state());\n+            assertThat(rerouteLatch.getCount(), greaterThanOrEqualTo(0L));\n+            rerouteLatch.countDown();\n+        };\n+\n         final InternalSnapshotsInfoService snapshotsInfoService =\n             new InternalSnapshotsInfoService(Settings.builder()\n                 .put(INTERNAL_SNAPSHOT_INFO_MAX_CONCURRENT_FETCHES_SETTING.getKey(), maxConcurrentFetches)\n                 .build(), clusterService, () -> repositoriesService, () -> rerouteService);\n \n-        final int numberOfShards = randomIntBetween(1, 50);\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final long[] expectedShardSizes = new long[numberOfShards];\n         for (int i = 0; i < expectedShardSizes.length; i++) {\n@@ -163,12 +171,10 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n         latch.countDown();\n \n-        assertBusy(() -> {\n-            assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\n-            assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\n-            assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\n-        });\n-        verify(rerouteService, times(numberOfShards)).reroute(anyString(), any(Priority.class), any());\n+        assertTrue(rerouteLatch.await(10L, TimeUnit.SECONDS));\n+        assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\n+        assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\n+        assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\n         assertThat(getShardSnapshotStatusCount.get(), equalTo(numberOfShards));\n \n         final SnapshotShardSizeInfo snapshotShardSizeInfo = snapshotsInfoService.snapshotShardSizes();\nJust a suggestion :) this approach looks fine as well.", "bodyHTML": "<p dir=\"auto\">I wonder, couldn't we get rid of the busy asserting completely by doing this via a latch (has the slight upside that we verify exact count a little stronger with the assertion on the latch count?)?</p>\n<p dir=\"auto\">e.g.:</p>\n<div class=\"highlight highlight-source-diff position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"diff --git a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\nindex a4483bd5ce2..fdcdcdb013f 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\n@@ -120,12 +120,20 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n     public void testSnapshotShardSizes() throws Exception {\n         final int maxConcurrentFetches = randomIntBetween(1, 10);\n+\n+        final int numberOfShards = randomIntBetween(1, 50);\n+        final CountDownLatch rerouteLatch = new CountDownLatch(numberOfShards);\n+        final RerouteService rerouteService = (reason, priority, listener) -&gt; {\n+            listener.onResponse(clusterService.state());\n+            assertThat(rerouteLatch.getCount(), greaterThanOrEqualTo(0L));\n+            rerouteLatch.countDown();\n+        };\n+\n         final InternalSnapshotsInfoService snapshotsInfoService =\n             new InternalSnapshotsInfoService(Settings.builder()\n                 .put(INTERNAL_SNAPSHOT_INFO_MAX_CONCURRENT_FETCHES_SETTING.getKey(), maxConcurrentFetches)\n                 .build(), clusterService, () -&gt; repositoriesService, () -&gt; rerouteService);\n \n-        final int numberOfShards = randomIntBetween(1, 50);\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final long[] expectedShardSizes = new long[numberOfShards];\n         for (int i = 0; i &lt; expectedShardSizes.length; i++) {\n@@ -163,12 +171,10 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n         latch.countDown();\n \n-        assertBusy(() -&gt; {\n-            assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\n-            assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\n-            assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\n-        });\n-        verify(rerouteService, times(numberOfShards)).reroute(anyString(), any(Priority.class), any());\n+        assertTrue(rerouteLatch.await(10L, TimeUnit.SECONDS));\n+        assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\n+        assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\n+        assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\n         assertThat(getShardSnapshotStatusCount.get(), equalTo(numberOfShards));\n \n         final SnapshotShardSizeInfo snapshotShardSizeInfo = snapshotsInfoService.snapshotShardSizes();\"><pre><span class=\"pl-c1\">diff --git a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java</span>\nindex a4483bd5ce2..fdcdcdb013f 100644\n<span class=\"pl-md\">--- a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java</span>\n<span class=\"pl-mi1\">+++ b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java</span>\n<span class=\"pl-mdr\">@@ -120,12 +120,20 @@</span> public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n     public void testSnapshotShardSizes() throws Exception {\n         final int maxConcurrentFetches = randomIntBetween(1, 10);\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        final int numberOfShards = randomIntBetween(1, 50);</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        final CountDownLatch rerouteLatch = new CountDownLatch(numberOfShards);</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        final RerouteService rerouteService = (reason, priority, listener) -&gt; {</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>            listener.onResponse(clusterService.state());</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>            assertThat(rerouteLatch.getCount(), greaterThanOrEqualTo(0L));</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>            rerouteLatch.countDown();</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        };</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n         final InternalSnapshotsInfoService snapshotsInfoService =\n             new InternalSnapshotsInfoService(Settings.builder()\n                 .put(INTERNAL_SNAPSHOT_INFO_MAX_CONCURRENT_FETCHES_SETTING.getKey(), maxConcurrentFetches)\n                 .build(), clusterService, () -&gt; repositoriesService, () -&gt; rerouteService);\n \n<span class=\"pl-md\"><span class=\"pl-md\">-</span>        final int numberOfShards = randomIntBetween(1, 50);</span>\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final long[] expectedShardSizes = new long[numberOfShards];\n         for (int i = 0; i &lt; expectedShardSizes.length; i++) {\n<span class=\"pl-mdr\">@@ -163,12 +171,10 @@</span> public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n         latch.countDown();\n \n<span class=\"pl-md\"><span class=\"pl-md\">-</span>        assertBusy(() -&gt; {</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>            assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>            assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>            assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>        });</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>        verify(rerouteService, times(numberOfShards)).reroute(anyString(), any(Priority.class), any());</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        assertTrue(rerouteLatch.await(10L, TimeUnit.SECONDS));</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));</span>\n         assertThat(getShardSnapshotStatusCount.get(), equalTo(numberOfShards));\n \n         final SnapshotShardSizeInfo snapshotShardSizeInfo = snapshotsInfoService.snapshotShardSizes();</pre></div>\n<p dir=\"auto\">Just a suggestion :) this approach looks fine as well.</p>", "author": "original-brownbear", "createdAt": "2020-10-08T09:37:37Z", "path": "server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java", "diffHunk": "@@ -120,6 +107,13 @@ public void tearDown() throws Exception {\n \n     public void testSnapshotShardSizes() throws Exception {\n         final int maxConcurrentFetches = randomIntBetween(1, 10);\n+\n+        final AtomicInteger rerouteCount = new AtomicInteger(0);", "originalCommit": "428e1ac350e66974c510f8ff2df81287244dc9e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxNTQ1Ng==", "url": "https://github.com/elastic/elasticsearch/pull/63416#discussion_r501615456", "bodyText": "This is a good suggestion, thanks!", "author": "tlrx", "createdAt": "2020-10-08T10:30:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4Mjg5MQ=="}], "type": "inlineReview"}, {"oid": "23e9c3d4b984fdd18255a917a3aaed59ec6f91f8", "url": "https://github.com/elastic/elasticsearch/commit/23e9c3d4b984fdd18255a917a3aaed59ec6f91f8", "message": "Simplify reroute counting", "committedDate": "2020-10-08T10:29:48Z", "type": "commit"}]}