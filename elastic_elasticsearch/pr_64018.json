{"pr_number": 64018, "pr_title": "DefaultUserInfo empty password hash", "pr_author": "jkakavas", "pr_createdAt": "2020-10-21T20:12:50Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64018", "timeline": [{"oid": "c741fb76e006ef85c783f4398b18045bb2ae627c", "url": "https://github.com/elastic/elasticsearch/commit/c741fb76e006ef85c783f4398b18045bb2ae627c", "message": "DefaultUserInfo empty password hash\n\nUse an empty char array in place of the hash of the empty string\nfor defaultEnabledReservedUser, defaultDisabledReservedUser and\nbootstrapUserInfo ReservedUserInfo objects, when the password is\nempty. In these cases, the hasEmptyPassword property is set to\ntrue and so the actual password hash is not ever checked or\nverified in ReservedRealm#doAuthenticate so this change has no\nfunctional effect on existing logic. If anything, it is more\nconsistent with the logic in NativeUsersStore#setReservedUserEnabled\nwhen the user document didn't already exist.\nEven if there is / will be code that attempts to verify the hash,\nthis would still work as intended as Hasher#resolve would resolve\nthe NOOP Hasher from the empty string and its verify method would\ncompare the char arrays.\n\nThe reason for this change is that when in FIPS 140 approved only\nmode, the security provider's implementation of PBKDF2 might\nforbid operations when the password is smaller than 112 bits so\nthe existing implementation would cause elasticsearch to fail.", "committedDate": "2020-10-21T19:52:41Z", "type": "commit"}, {"oid": "ecffc225e23390b7c7e31bf0b1f1d1fe4f6ef717", "url": "https://github.com/elastic/elasticsearch/commit/ecffc225e23390b7c7e31bf0b1f1d1fe4f6ef717", "message": "Merge remote-tracking branch 'origin/master' into defaultuserinfo-hash", "committedDate": "2020-10-21T20:36:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc5ODMxNg==", "url": "https://github.com/elastic/elasticsearch/pull/64018#discussion_r509798316", "body": "With this PR, the empty passwordHash now has a deterministic value, `new char[0]`. It would be better to remove  `hasEmptyPassword` from the constructor parameters of `ReservedUserInfo` because it can be safely derived. It is more consistent to derive it than manually passing it into the constructor. We can also replace the `hasEmptyPassword` field with a method call which internally returns `passwordHash.length == 0`.", "bodyText": "With this PR, the empty passwordHash now has a deterministic value, new char[0]. It would be better to remove  hasEmptyPassword from the constructor parameters of ReservedUserInfo because it can be safely derived. It is more consistent to derive it than manually passing it into the constructor. We can also replace the hasEmptyPassword field with a method call which internally returns passwordHash.length == 0.", "bodyHTML": "<p dir=\"auto\">With this PR, the empty passwordHash now has a deterministic value, <code>new char[0]</code>. It would be better to remove  <code>hasEmptyPassword</code> from the constructor parameters of <code>ReservedUserInfo</code> because it can be safely derived. It is more consistent to derive it than manually passing it into the constructor. We can also replace the <code>hasEmptyPassword</code> field with a method call which internally returns <code>passwordHash.length == 0</code>.</p>", "author": "ywangd", "createdAt": "2020-10-21T23:47:32Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/NativeUsersStore.java", "diffHunk": "@@ -697,5 +691,13 @@ ReservedUserInfo deepClone() {\n         boolean verifyPassword(SecureString data) {\n             return hasher.verify(data, this.passwordHash);\n         }\n+\n+        static ReservedUserInfo defaultEnabledUserInfo(){\n+            return new ReservedUserInfo(new char[0], true, true);", "originalCommit": "ecffc225e23390b7c7e31bf0b1f1d1fe4f6ef717", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTg3MTYxNg==", "url": "https://github.com/elastic/elasticsearch/pull/64018#discussion_r509871616", "bodyText": "Makes sense, will do", "author": "jkakavas", "createdAt": "2020-10-22T04:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc5ODMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTgyOTQyMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64018#discussion_r509829421", "body": "Nit:\r\n```suggestion\r\n        static ReservedUserInfo defaultEnabledUserInfo() {\r\n```", "bodyText": "Nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    static ReservedUserInfo defaultEnabledUserInfo(){\n          \n          \n            \n                    static ReservedUserInfo defaultEnabledUserInfo() {", "bodyHTML": "<p dir=\"auto\">Nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">static</span> <span class=\"pl-smi\">ReservedUserInfo</span> defaultEnabledUserInfo(){</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">static</span> <span class=\"pl-smi\">ReservedUserInfo</span> defaultEnabledUserInfo()<span class=\"x x-first x-last\"> </span>{</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-10-22T01:39:56Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/NativeUsersStore.java", "diffHunk": "@@ -697,5 +691,13 @@ ReservedUserInfo deepClone() {\n         boolean verifyPassword(SecureString data) {\n             return hasher.verify(data, this.passwordHash);\n         }\n+\n+        static ReservedUserInfo defaultEnabledUserInfo(){", "originalCommit": "ecffc225e23390b7c7e31bf0b1f1d1fe4f6ef717", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1426ed7c9bd588ec70838249dbb6ff7bf94f8d00", "url": "https://github.com/elastic/elasticsearch/commit/1426ed7c9bd588ec70838249dbb6ff7bf94f8d00", "message": "address feedback", "committedDate": "2020-10-22T09:28:30Z", "type": "commit"}]}