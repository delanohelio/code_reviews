{"pr_number": 64948, "pr_title": "Adding a warning header when a license is about to expire", "pr_author": "BigPandaToo", "pr_createdAt": "2020-11-11T16:05:08Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64948", "timeline": [{"oid": "f85a62432d1cab0c24a5cf5b4b5efebe402c0f63", "url": "https://github.com/elastic/elasticsearch/commit/f85a62432d1cab0c24a5cf5b4b5efebe402c0f63", "message": "This change adds a warning header when a license is about to expire\n\nResolves #60562", "committedDate": "2020-11-11T16:03:48Z", "type": "commit"}, {"oid": "af38237928955e54cab5d6da544ffddfabab603f", "url": "https://github.com/elastic/elasticsearch/commit/af38237928955e54cab5d6da544ffddfabab603f", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-11T16:52:24Z", "type": "commit"}, {"oid": "70461a2b97617c8d0f6577f45afb4328e9b7b3f6", "url": "https://github.com/elastic/elasticsearch/commit/70461a2b97617c8d0f6577f45afb4328e9b7b3f6", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-11T16:59:18Z", "type": "commit"}, {"oid": "f6e3cebe217b738eafe41c272c1553b2d95cf676", "url": "https://github.com/elastic/elasticsearch/commit/f6e3cebe217b738eafe41c272c1553b2d95cf676", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-11T19:55:39Z", "type": "commit"}, {"oid": "e52f2318e01cf795d97f4c2f9a5422d12d4909a8", "url": "https://github.com/elastic/elasticsearch/commit/e52f2318e01cf795d97f4c2f9a5422d12d4909a8", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-12T09:41:38Z", "type": "commit"}, {"oid": "10029990758325d0400f7b2abc5a2607e4a99dbf", "url": "https://github.com/elastic/elasticsearch/commit/10029990758325d0400f7b2abc5a2607e4a99dbf", "message": "This change adds realm name of the realm used to perform authentication to the responses of _security/oidc/authenticate and _security/oidc/authenticate APIs\n\nResolves #53161", "committedDate": "2020-11-12T20:07:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NTU0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524965547", "body": "s/avILble/available. Nit: also change the description of the Status class above to add the expiration date", "bodyText": "s/avILble/available. Nit: also change the description of the Status class above to add the expiration date", "bodyHTML": "<p dir=\"auto\">s/avILble/available. Nit: also change the description of the Status class above to add the expiration date</p>", "author": "jkakavas", "createdAt": "2020-11-17T08:25:13Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -400,9 +404,13 @@ private static boolean isBasic(OperationMode mode) {\n         /** True if the license is active, or false if it is expired. */\n         final boolean active;\n \n-        Status(OperationMode mode, boolean active) {\n+        /** The current expiration date of the license; Long.MAX_VALUE if not avILble yet. */", "originalCommit": "10029990758325d0400f7b2abc5a2607e4a99dbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MTM2NA==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524971364", "body": "I think we'd need to access this by calling `checkAgainstStatus` instead of accessing the licenseExpiryDate  field directly", "bodyText": "I think we'd need to access this by calling checkAgainstStatus instead of accessing the licenseExpiryDate  field directly", "bodyHTML": "<p dir=\"auto\">I think we'd need to access this by calling <code>checkAgainstStatus</code> instead of accessing the licenseExpiryDate  field directly</p>", "author": "jkakavas", "createdAt": "2020-11-17T08:34:59Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0\n+            && now > status.licenseExpiryDate - GRACE_PERIOD_DURATION.getMillis()) {", "originalCommit": "10029990758325d0400f7b2abc5a2607e4a99dbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MjA5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524972097", "body": "nit: `if (feature....`", "bodyText": "nit: if (feature....", "bodyHTML": "<p dir=\"auto\">nit: <code>if (feature....</code></p>", "author": "jkakavas", "createdAt": "2020-11-17T08:36:14Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0", "originalCommit": "10029990758325d0400f7b2abc5a2607e4a99dbf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MzYxNg==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524973616", "body": "I'm not sure about the wording here but I'll defer to a native speaker and maybe get Fabio's input too? \n\nMaybe s/update/renew ?  and s/for continued use of/in order to continue using the licensed ?", "bodyText": "I'm not sure about the wording here but I'll defer to a native speaker and maybe get Fabio's input too?\nMaybe s/update/renew ?  and s/for continued use of/in order to continue using the licensed ?", "bodyHTML": "<p dir=\"auto\">I'm not sure about the wording here but I'll defer to a native speaker and maybe get Fabio's input too?</p>\n<p dir=\"auto\">Maybe s/update/renew ?  and s/for continued use of/in order to continue using the licensed ?</p>", "author": "jkakavas", "createdAt": "2020-11-17T08:38:45Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0\n+            && now > status.licenseExpiryDate - GRACE_PERIOD_DURATION.getMillis()) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +\n+                    \"Contact your administrator or update your license for continued use of features\",", "originalCommit": "10029990758325d0400f7b2abc5a2607e4a99dbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NzM3MA==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524997370", "bodyText": "This is the wording Kibana has. I talked to Fabio and he suggested us to be consistant with wording when possible.", "author": "BigPandaToo", "createdAt": "2020-11-17T09:15:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MzYxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5Nzg3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524997876", "bodyText": "SGTM then!", "author": "jkakavas", "createdAt": "2020-11-17T09:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MzYxNg=="}], "type": "inlineReview"}, {"oid": "7b1b8da48bd1baf0b67b14d28c3c14de634c5a93", "url": "https://github.com/elastic/elasticsearch/commit/7b1b8da48bd1baf0b67b14d28c3c14de634c5a93", "message": "Adding doc for the new API introduced by #64517 - /_security/saml/metadata/{realm}\n\nRelated to #49018", "committedDate": "2020-11-17T21:47:44Z", "type": "commit"}, {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95", "url": "https://github.com/elastic/elasticsearch/commit/ffcd72bed08f16f5d9603a0cb2e9885955a86a95", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-17T22:37:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r525994902", "body": "If we're in the grace period, shouldn't this say `has expired` ?", "bodyText": "If we're in the grace period, shouldn't this say has expired ?", "bodyHTML": "<p dir=\"auto\">If we're in the grace period, shouldn't this say <code>has expired</code> ?</p>", "author": "tvernum", "createdAt": "2020-11-18T10:56:54Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "originalCommit": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAwMDA4OA==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526000088", "bodyText": "I'll double-check with Fabio. This is the only message Kibana has and the idea was to be consistent when possible.", "author": "BigPandaToo", "createdAt": "2020-11-18T11:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA4MDY5NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526080695", "bodyText": "I don't think we have a grace period anymore. AFAIK we have warnings before the expiration date, and no service after that. Could you please double check what isLicenseExpiring() assumes?", "author": "bytebilly", "createdAt": "2020-11-18T13:18:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4MDI1OA==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526580258", "bodyText": "We still have a grace period. We may not in the future, but we do now.", "author": "tvernum", "createdAt": "2020-11-19T04:03:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY2MTYxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526661615", "bodyText": "(sorry I cannot find the description of the full approach, so it may be already this)\nWhat about having two separate checks with two separate messages?\n\n7 days before expiration \u2014\u00a0expiration: \"will expire in N days\"\nexpiration \u2014\u00a0end of grace period: \"has expired N days ago\"", "author": "bytebilly", "createdAt": "2020-11-19T08:03:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzMDMyNw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527130327", "bodyText": "I changed the behaviour to have 3 different messages:\n\n7 days before expiration \u2014 expiration: \"will expire in N days\"\n<1 days before expiration: \"expires today\"\n\n\nexpiration: \"has expired N days ago\"\n\n\n\nIf grace period is over this code should be irrelevant as the license is not active.", "author": "BigPandaToo", "createdAt": "2020-11-19T19:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzMTkzNg==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527131936", "bodyText": "Also, addad a test", "author": "BigPandaToo", "createdAt": "2020-11-19T19:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NTMzNg==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r525995336", "body": "Why is this dependent on the `GRACE_PERIOD` ? It seems to be a co-incidence that they're both 7days, but they shouldn't be tied to one another.", "bodyText": "Why is this dependent on the GRACE_PERIOD ? It seems to be a co-incidence that they're both 7days, but they shouldn't be tied to one another.", "bodyHTML": "<p dir=\"auto\">Why is this dependent on the <code>GRACE_PERIOD</code> ? It seems to be a co-incidence that they're both 7days, but they shouldn't be tied to one another.</p>", "author": "tvernum", "createdAt": "2020-11-18T10:57:35Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -627,6 +644,22 @@ public boolean isAllowedByLicense(OperationMode minimumMode, boolean needActive)\n         });\n     }\n \n+    /**\n+     * Test whether current license expires in less than {@code GRACE_PERIOD_DURATION}.", "originalCommit": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAwMDczOQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526000739", "bodyText": "Good point, I'll add new const", "author": "BigPandaToo", "createdAt": "2020-11-18T11:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NTMzNg=="}], "type": "inlineReview"}, {"oid": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e", "url": "https://github.com/elastic/elasticsearch/commit/34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e", "message": "Adding a warning header when a license is about to expire\n\nResolves #60562", "committedDate": "2020-11-19T18:39:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4NzcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527587713", "body": "Given what this does, would it make sense to name it `shouldWarnAboutLicense()` ? ", "bodyText": "Given what this does, would it make sense to name it shouldWarnAboutLicense() ?", "bodyHTML": "<p dir=\"auto\">Given what this does, would it make sense to name it <code>shouldWarnAboutLicense()</code> ?</p>", "author": "jkakavas", "createdAt": "2020-11-20T10:12:25Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -627,6 +650,22 @@ public boolean isAllowedByLicense(OperationMode minimumMode, boolean needActive)\n         });\n     }\n \n+    /**\n+     * Test whether current license expires in less than {@code LICENSE_EXPIRATION_WARNING_PERIOD}.\n+     *\n+     * @param now  Current time in milliseconds\n+     *\n+     * @return true if current license expires in less than {@code LICENSE_EXPIRATION_WARNING_PERIOD}, otherwise false\n+     */\n+    public boolean isLicenseExpiring(long now) {", "originalCommit": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5NjExNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527596115", "body": "Do we have to do the double update dance here? `setLicensingExpirationDate` is the only thing that calls update with anything other than Long.MAX_VALUE, what cluster state could trigger the license state (Expiration date) to change ?", "bodyText": "Do we have to do the double update dance here? setLicensingExpirationDate is the only thing that calls update with anything other than Long.MAX_VALUE, what cluster state could trigger the license state (Expiration date) to change ?", "bodyHTML": "<p dir=\"auto\">Do we have to do the double update dance here? <code>setLicensingExpirationDate</code> is the only thing that calls update with anything other than Long.MAX_VALUE, what cluster state could trigger the license state (Expiration date) to change ?</p>", "author": "jkakavas", "createdAt": "2020-11-20T10:26:44Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -235,8 +293,42 @@ private void enableLicensing(License.OperationMode operationMode) throws Excepti\n             // re-apply the update in case any node received an updated cluster state that triggered the license state\n             // to change\n             for (XPackLicenseState licenseState : internalCluster().getInstances(XPackLicenseState.class)) {\n-                licenseState.update(operationMode, true, null);\n+                licenseState.update(operationMode, true, Long.MAX_VALUE, null);\n             }\n         }, 30L, TimeUnit.SECONDS);\n     }\n+\n+    private void setLicensingExpirationDate(License.OperationMode operationMode, long expirationDate) throws Exception {\n+        // do this in an await busy since there is a chance that the setting expiration date of the license is\n+        // overwritten by some other cluster activity and the node throws an exception while we\n+        // wait for things to stabilize!\n+        assertBusy(() -> {\n+            // first update the license so we can execute monitoring actions", "originalCommit": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0NDk4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r528944987", "bodyText": "Probably, not. Removed the second update, left hte assertBusy though.", "author": "BigPandaToo", "createdAt": "2020-11-23T19:28:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5NjExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwNjM4NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527606385", "body": "```suggestion\r\n            final String expiryMessage = days == 0 ? \"expires today\" :\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        final String expiryMessage = days == 0? \"expires today\":\n          \n          \n            \n                        final String expiryMessage = days == 0 ? \"expires today\" :", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> expiryMessage <span class=\"pl-k\">=</span> days <span class=\"pl-k\">==</span> <span class=\"pl-c1\">0</span><span class=\"pl-k\">?</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>expires today<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> expiryMessage <span class=\"pl-k\">=</span> days <span class=\"pl-k\">==</span> <span class=\"pl-c1\">0</span><span class=\"x x-first x-last\"> </span><span class=\"pl-k\">?</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>expires today<span class=\"pl-pds\">\"</span></span><span class=\"x x-first x-last\"> </span><span class=\"pl-k\">:</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jkakavas", "createdAt": "2020-11-20T10:44:06Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -505,12 +516,24 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(status.licenseExpiryDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":", "originalCommit": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwNjc3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527606773", "body": "```suggestion\r\n                (days > 0 ? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n          \n          \n            \n                            (days > 0 ? String.format(Locale.ROOT, \"will expire in [%d] days\", days):", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                (days <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span><span class=\"pl-k\">?</span> <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-smi\">Locale</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ROOT</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>will expire in [%d] days<span class=\"pl-pds\">\"</span></span>, days)<span class=\"pl-k\">:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                (days <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span><span class=\"x x-first x-last\"> </span><span class=\"pl-k\">?</span> <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-smi\">Locale</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ROOT</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>will expire in [%d] days<span class=\"pl-pds\">\"</span></span>, days)<span class=\"pl-k\">:</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jkakavas", "createdAt": "2020-11-20T10:44:48Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -505,12 +516,24 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(status.licenseExpiryDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):", "originalCommit": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fbbd2fa2363e6711c47837769dfe33e0e38b125c", "url": "https://github.com/elastic/elasticsearch/commit/fbbd2fa2363e6711c47837769dfe33e0e38b125c", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-23T16:05:16Z", "type": "commit"}, {"oid": "a57d4b163070c635f73eec402e0fd2842e887650", "url": "https://github.com/elastic/elasticsearch/commit/a57d4b163070c635f73eec402e0fd2842e887650", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-23T17:17:23Z", "type": "commit"}, {"oid": "1ecfa75beb0ef3fe218bf5f6c9e28ae4297c7bfb", "url": "https://github.com/elastic/elasticsearch/commit/1ecfa75beb0ef3fe218bf5f6c9e28ae4297c7bfb", "message": "Addressing the PR feedback", "committedDate": "2020-11-23T20:13:41Z", "type": "commit"}, {"oid": "1ed1cb2741104d21cdb6458403a9a672ad26b65a", "url": "https://github.com/elastic/elasticsearch/commit/1ed1cb2741104d21cdb6458403a9a672ad26b65a", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-26T10:19:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkzMjY4Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r530932686", "body": "Not necessary?  This method doesn't appear to use `Math.abs()`.", "bodyText": "Not necessary?  This method doesn't appear to use Math.abs().", "bodyHTML": "<p dir=\"auto\">Not necessary?  This method doesn't appear to use <code>Math.abs()</code>.</p>", "author": "droberts195", "createdAt": "2020-11-26T10:37:38Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +513,15 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")", "originalCommit": "1ed1cb2741104d21cdb6458403a9a672ad26b65a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NjkzMw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r530966933", "bodyText": "Leftover from the previous iteration, but will come back handy with the next one )", "author": "BigPandaToo", "createdAt": "2020-11-26T11:35:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkzMjY4Ng=="}], "type": "inlineReview"}, {"oid": "80ca874c54b20bec12bf7d8c914ba3f21fa546e1", "url": "https://github.com/elastic/elasticsearch/commit/80ca874c54b20bec12bf7d8c914ba3f21fa546e1", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-26T11:23:23Z", "type": "commit"}, {"oid": "07fa3e2d67ea5250e0c9dce9ca8688f3b632f8b3", "url": "https://github.com/elastic/elasticsearch/commit/07fa3e2d67ea5250e0c9dce9ca8688f3b632f8b3", "message": "Switching back to adding the header during featureCheck to allow\nwarnings when authentication is disabled as well. Adding filterHeader\nimplementation to SecurityRestFilter exception handling to remove all\nthe warnings if authentication fails.", "committedDate": "2020-11-26T18:26:59Z", "type": "commit"}, {"oid": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8", "url": "https://github.com/elastic/elasticsearch/commit/39e7ca7b5d29c8efa4519895b67d4843f387d3f8", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-11-30T19:17:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NjMwNQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533096305", "body": "For expired licenses, I think it's preferable to just print out the date that is expired, rather than calculate how lonh ago that was.\r\nThat's what the log warning does and it seems neater for this case.\r\n\r\n> LICENSE [EXPIRED] ON [SUNDAY, NOVEMBER 29, 2020]\r\n\r\nThe number of days makes sense for \"will expire\" because it creates a sense of urgency, but once it's expired I think the date is a better option. \r\n", "bodyText": "For expired licenses, I think it's preferable to just print out the date that is expired, rather than calculate how lonh ago that was.\nThat's what the log warning does and it seems neater for this case.\n\nLICENSE [EXPIRED] ON [SUNDAY, NOVEMBER 29, 2020]\n\nThe number of days makes sense for \"will expire\" because it creates a sense of urgency, but once it's expired I think the date is a better option.", "bodyHTML": "<p dir=\"auto\">For expired licenses, I think it's preferable to just print out the date that is expired, rather than calculate how lonh ago that was.<br>\nThat's what the log warning does and it seems neater for this case.</p>\n<blockquote>\n<p dir=\"auto\">LICENSE [EXPIRED] ON [SUNDAY, NOVEMBER 29, 2020]</p>\n</blockquote>\n<p dir=\"auto\">The number of days makes sense for \"will expire\" because it creates a sense of urgency, but once it's expired I think the date is a better option.</p>", "author": "tvernum", "createdAt": "2020-12-01T06:17:11Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +518,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n+        long licenseExpirationDate = getLicenseExpiryDate();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n+                    String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));", "originalCommit": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDk5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533690997", "bodyText": "Changed the wording to \"license expired on [EEEE, MMMM DD, YYYY]\". For the sace of keeping the headers relatively short kept the rest of the message the same.", "author": "BigPandaToo", "createdAt": "2020-12-01T20:10:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NjMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODE0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533098149", "body": "I think we should be doing the first round of calculations in millis, not in days otherwise we potentially says \"expires today\" _after_ the expiry date (because it's less than 1 day expired)\r\n\r\n```suggestion\r\n    \r\n        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0) {\r\n            final long expiryMillis = licenseExpirationDate - now;        \r\n            if (expiryMillis < LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\r\n                final String expiryMessage;\r\n                if (expiryMillis <= 0) {\r\n                    expiryMessage = \"expired on [\" + DATE_FORMATTER.formatMillis(expirationMillis) + \"]\";\r\n                } else {\r\n                    final long days = TimeUnit.MILLISECONDS.toDays(expiryMillis);\r\n                    expiryMessage = days == 0 ? \"expires today\": \r\n                       String.format(Locale.ROOT, \"will expire in [%d] days\", days);\r\n                }\r\n```", "bodyText": "I think we should be doing the first round of calculations in millis, not in days otherwise we potentially says \"expires today\" after the expiry date (because it's less than 1 day expired)\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n          \n          \n            \n                        now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n          \n          \n            \n                        final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n          \n          \n            \n                        final String expiryMessage = days == 0? \"expires today\":\n          \n          \n            \n                            (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n          \n          \n            \n                                String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));\n          \n          \n            \n                \n          \n          \n            \n                    if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0) {\n          \n          \n            \n                        final long expiryMillis = licenseExpirationDate - now;        \n          \n          \n            \n                        if (expiryMillis < LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n          \n          \n            \n                            final String expiryMessage;\n          \n          \n            \n                            if (expiryMillis <= 0) {\n          \n          \n            \n                                expiryMessage = \"expired on [\" + DATE_FORMATTER.formatMillis(expirationMillis) + \"]\";\n          \n          \n            \n                            } else {\n          \n          \n            \n                                final long days = TimeUnit.MILLISECONDS.toDays(expiryMillis);\n          \n          \n            \n                                expiryMessage = days == 0 ? \"expires today\": \n          \n          \n            \n                                   String.format(Locale.ROOT, \"will expire in [%d] days\", days);\n          \n          \n            \n                            }", "bodyHTML": "<p dir=\"auto\">I think we should be doing the first round of calculations in millis, not in days otherwise we potentially says \"expires today\" <em>after</em> the expiry date (because it's less than 1 day expired)</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (feature<span class=\"pl-k\">.</span>minimumOperationMode<span class=\"pl-k\">.</span>compareTo(<span class=\"pl-smi\">OperationMode</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>BASIC</span>) <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span> <span class=\"pl-k\">&amp;&amp;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            now <span class=\"pl-k\">&gt;</span>  licenseExpirationDate <span class=\"pl-k\">-</span> <span class=\"pl-c1\">LICENSE_EXPIRATION_WARNING_PERIOD</span><span class=\"pl-k\">.</span>getMillis()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">final</span> <span class=\"pl-k\">long</span> days <span class=\"pl-k\">=</span> <span class=\"pl-smi\">TimeUnit</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MILLISECONDS</span><span class=\"pl-k\">.</span>toDays(licenseExpirationDate <span class=\"pl-k\">-</span> now);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> expiryMessage <span class=\"pl-k\">=</span> days <span class=\"pl-k\">==</span> <span class=\"pl-c1\">0</span><span class=\"pl-k\">?</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>expires today<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                (days <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span><span class=\"pl-k\">?</span> <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-smi\">Locale</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ROOT</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>will expire in [%d] days<span class=\"pl-pds\">\"</span></span>, days)<span class=\"pl-k\">:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-smi\">Locale</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ROOT</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>has expired [%d] days ago<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-smi\">Math</span><span class=\"pl-k\">.</span>abs(days)));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (feature<span class=\"pl-k\">.</span>minimumOperationMode<span class=\"pl-k\">.</span>compareTo(<span class=\"pl-smi\">OperationMode</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>BASIC</span>) <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">final</span> <span class=\"pl-k\">long</span> expiryMillis <span class=\"pl-k\">=</span> licenseExpirationDate <span class=\"pl-k\">-</span> now;        </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (expiryMillis <span class=\"pl-k\">&lt;</span> <span class=\"pl-c1\">LICENSE_EXPIRATION_WARNING_PERIOD</span><span class=\"pl-k\">.</span>getMillis()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> expiryMessage;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">if</span> (expiryMillis <span class=\"pl-k\">&lt;=</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    expiryMessage <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>expired on [<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> <span class=\"pl-c1\">DATE_FORMATTER</span><span class=\"pl-k\">.</span>formatMillis(expirationMillis) <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>]<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-k\">final</span> <span class=\"pl-k\">long</span> days <span class=\"pl-k\">=</span> <span class=\"pl-smi\">TimeUnit</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MILLISECONDS</span><span class=\"pl-k\">.</span>toDays(expiryMillis);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    expiryMessage <span class=\"pl-k\">=</span> days <span class=\"pl-k\">==</span> <span class=\"pl-c1\">0</span> <span class=\"pl-k\">?</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>expires today<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">:</span> </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                       <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-smi\">Locale</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ROOT</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>will expire in [%d] days<span class=\"pl-pds\">\"</span></span>, days);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-12-01T06:23:02Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +518,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n+        long licenseExpirationDate = getLicenseExpiryDate();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n+                    String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));", "originalCommit": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MTE2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533691166", "bodyText": "Done", "author": "BigPandaToo", "createdAt": "2020-12-01T20:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODE0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODk2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533098963", "body": "Do we have a test for this anywhere?", "bodyText": "Do we have a test for this anywhere?", "bodyHTML": "<p dir=\"auto\">Do we have a test for this anywhere?</p>", "author": "tvernum", "createdAt": "2020-12-01T06:25:31Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -100,6 +102,14 @@ private void handleException(String actionType, RestRequest request, RestChannel\n                 @Override\n                 protected boolean skipStackTrace() { return restStatus == RestStatus.UNAUTHORIZED; }\n \n+                @Override\n+                public Map<String, List<String>> filterHeaders(Map<String, List<String>> headers) {\n+                    if (headers.containsKey(\"Warning\")) {\n+                        return Maps.copyMapWithRemovedEntry(headers, \"Warning\");\n+                    }\n+                    return headers;\n+                }\n+", "originalCommit": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MTYzMw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533691633", "bodyText": "Added a test to verify Warnings are removed if authN fails.", "author": "BigPandaToo", "createdAt": "2020-12-01T20:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODk2Mw=="}], "type": "inlineReview"}, {"oid": "d27df6f4d69e968dc39e417ef3abafc441ffa4cb", "url": "https://github.com/elastic/elasticsearch/commit/d27df6f4d69e968dc39e417ef3abafc441ffa4cb", "message": "Changing the wording for \"expired\" message to be consistent with the log\n messages; changing \"today\" calculation; adding a test case for failing\n authN to make sure we remove the warning header", "committedDate": "2020-12-01T19:42:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDcwMTY1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r534701659", "body": "In general we prefer to use `Matcher` based assertions because they provide better context when something fails. \r\n```suggestion\r\n        assertThat(afterWarningHeaders, Matchers.hasSize(1));\r\n        assertThat(afterWarningHeaders, Matchers.contains(\"Your license will expire in [6] days. \" +\r\n            \"Contact your administrator or update your license for continued use of features\"));\r\n```\r\n(Although, technically, the first assertion is redundant, because the `contains matcher already checks size)", "bodyText": "In general we prefer to use Matcher based assertions because they provide better context when something fails.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertTrue(afterWarningHeaders.size() == 1);\n          \n          \n            \n                    assertTrue(afterWarningHeaders.stream().anyMatch(v ->v.contains(\"Your license will expire in [6] days. \" +\n          \n          \n            \n                        \"Contact your administrator or update your license for continued use of features\")));\n          \n          \n            \n                    assertThat(afterWarningHeaders, Matchers.hasSize(1));\n          \n          \n            \n                    assertThat(afterWarningHeaders, Matchers.contains(\"Your license will expire in [6] days. \" +\n          \n          \n            \n                        \"Contact your administrator or update your license for continued use of features\"));\n          \n      \n    \n    \n  \n\n(Although, technically, the first assertion is redundant, because the `contains matcher already checks size)", "bodyHTML": "<p dir=\"auto\">In general we prefer to use <code>Matcher</code> based assertions because they provide better context when something fails.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"x x-first x-last\">assertTrue</span>(afterWarningHeaders<span class=\"pl-k x x-first\">.</span><span class=\"x\">size() </span><span class=\"pl-k x\">==</span><span class=\"x\"> </span><span class=\"pl-c1 x x-last\">1</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"x x-first x-last\">assertTrue</span>(afterWarningHeaders<span class=\"pl-k x x-first\">.</span><span class=\"x\">stream()</span><span class=\"pl-k x\">.</span><span class=\"x\">anyMatch(v </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\">v</span><span class=\"pl-k\">.</span>contains(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Your license will expire in [6] days. <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Contact your administrator or update your license for continued use of features<span class=\"pl-pds\">\"</span></span>))<span class=\"x x-first x-last\">)</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"x x-first x-last\">assertThat</span>(afterWarningHeaders<span class=\"x x-first\">, </span><span class=\"pl-smi x\">Matchers</span><span class=\"pl-k x\">.</span><span class=\"x\">hasSize(</span><span class=\"pl-c1 x\">1</span><span class=\"x x-last\">)</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"x x-first x-last\">assertThat</span>(afterWarningHeaders<span class=\"x x-first\">, </span><span class=\"pl-smi x x-last\">Matchers</span><span class=\"pl-k\">.</span>contains(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Your license will expire in [6] days. <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Contact your administrator or update your license for continued use of features<span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">(Although, technically, the first assertion is redundant, because the `contains matcher already checks size)</p>", "author": "tvernum", "createdAt": "2020-12-03T05:59:21Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -192,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        List<String> afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(afterWarningHeaders.size() == 1);\n+        assertTrue(afterWarningHeaders.stream().anyMatch(v ->v.contains(\"Your license will expire in [6] days. \" +\n+            \"Contact your administrator or update your license for continued use of features\")));", "originalCommit": "d27df6f4d69e968dc39e417ef3abafc441ffa4cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a3f2eba6fbe9239d9bfc67dcb0c0f55cacd29126", "url": "https://github.com/elastic/elasticsearch/commit/a3f2eba6fbe9239d9bfc67dcb0c0f55cacd29126", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-12-03T17:52:59Z", "type": "commit"}, {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "url": "https://github.com/elastic/elasticsearch/commit/b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "message": "Small changes in the way we verify header in tests", "committedDate": "2020-12-03T18:58:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0ODQ5Nw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535948497", "body": "Do we want to remove _all_ warning headers on authentication failure?", "bodyText": "Do we want to remove all warning headers on authentication failure?", "bodyHTML": "<p dir=\"auto\">Do we want to remove <em>all</em> warning headers on authentication failure?</p>", "author": "jkakavas", "createdAt": "2020-12-04T09:14:39Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -100,6 +102,14 @@ private void handleException(String actionType, RestRequest request, RestChannel\n                 @Override\n                 protected boolean skipStackTrace() { return restStatus == RestStatus.UNAUTHORIZED; }\n \n+                @Override\n+                public Map<String, List<String>> filterHeaders(Map<String, List<String>> headers) {\n+                    if (headers.containsKey(\"Warning\")) {", "originalCommit": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk5NzM5NA==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535997394", "bodyText": "Yes, it is intentional (see Tim's comment above). If Authentication fails it does make sense to not reveal any additional information", "author": "BigPandaToo", "createdAt": "2020-12-04T10:29:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0ODQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1MDA0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535950041", "body": "I think you can use a randomAlphaNumericOfLength , or a permutation of `TEST_PASSWORD` plus some random string for whenever we need this, other than defining it here. That's just personal preference, no strong views, feel free to keep as is if you prefer it", "bodyText": "I think you can use a randomAlphaNumericOfLength , or a permutation of TEST_PASSWORD plus some random string for whenever we need this, other than defining it here. That's just personal preference, no strong views, feel free to keep as is if you prefer it", "bodyHTML": "<p dir=\"auto\">I think you can use a randomAlphaNumericOfLength , or a permutation of <code>TEST_PASSWORD</code> plus some random string for whenever we need this, other than defining it here. That's just personal preference, no strong views, feel free to keep as is if you prefer it</p>", "author": "jkakavas", "createdAt": "2020-12-04T09:16:56Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/test/SecuritySettingsSourceField.java", "diffHunk": "@@ -10,6 +10,7 @@\n public final class SecuritySettingsSourceField {\n     public static final SecureString TEST_PASSWORD_SECURE_STRING = new SecureString(\"x-pack-test-password\".toCharArray());\n     public static final String TEST_PASSWORD = \"x-pack-test-password\";\n+    public static final String TEST_INVALID_PASSWORD = \"invalid-test-password\";", "originalCommit": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1MDg2MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535950861", "body": "use assertThat ?", "bodyText": "use assertThat ?", "bodyHTML": "<p dir=\"auto\">use assertThat ?</p>", "author": "jkakavas", "createdAt": "2020-12-04T09:18:15Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());", "originalCommit": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1MTI2NQ==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535951265", "body": "nit: Do we need all the empty lines? ", "bodyText": "nit: Do we need all the empty lines?", "bodyHTML": "<p dir=\"auto\">nit: Do we need all the empty lines?</p>", "author": "jkakavas", "createdAt": "2020-12-04T09:18:50Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+", "originalCommit": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1NjQzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535956432", "body": "I Guess we are fine with the message in warnigns and subtleties of `toDays` and being close to midnight in a given timezone , right? I think we are, just asking for completeness. ", "bodyText": "I Guess we are fine with the message in warnigns and subtleties of toDays and being close to midnight in a given timezone , right? I think we are, just asking for completeness.", "bodyHTML": "<p dir=\"auto\">I Guess we are fine with the message in warnigns and subtleties of <code>toDays</code> and being close to midnight in a given timezone , right? I think we are, just asking for completeness.</p>", "author": "jkakavas", "createdAt": "2020-12-04T09:26:50Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -509,12 +520,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        final long licenseExpiryDate = getLicenseExpiryDate();\n+        final long diff = licenseExpiryDate - System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() > diff) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(diff);", "originalCommit": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAwNTcwNw==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r536005707", "bodyText": "I believe we are :)", "author": "BigPandaToo", "createdAt": "2020-12-04T10:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1NjQzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1ODE1NA==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535958154", "body": "use assertThat ?", "bodyText": "use assertThat ?", "bodyHTML": "<p dir=\"auto\">use assertThat ?</p>", "author": "jkakavas", "createdAt": "2020-12-04T09:29:24Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        List<String> afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license will expire in [6] days. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now + 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license expires today. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now - 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        long finalNewExpirationDate = newExpirationDate;\n+        String expiredMessage = String.format(Locale.ROOT, \"Your license expired on [%s]. \",\n+            LicenseService.DATE_FORMATTER.formatMillis(finalNewExpirationDate));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(expiredMessage +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+    }\n+\n+    public void testWarningHeaderAuthenticationFailed() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_INVALID_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+        Header[] headers = null;\n+        try {\n+            getRestClient().performRequest(request);\n+        } catch (ResponseException e) {\n+            headers = e.getResponse().getHeaders();\n+            List<String> afterWarningHeaders= getWarningHeaders(e.getResponse().getHeaders());\n+            assertThat(afterWarningHeaders, Matchers.hasSize(0));\n+        }\n+        assertTrue(headers != null && headers.length == 3);", "originalCommit": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1ODYzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535958632", "body": "nit suggestion : testNoWarningHeaderWhenAuthenticationFailed", "bodyText": "nit suggestion : testNoWarningHeaderWhenAuthenticationFailed", "bodyHTML": "<p dir=\"auto\">nit suggestion : testNoWarningHeaderWhenAuthenticationFailed</p>", "author": "jkakavas", "createdAt": "2020-12-04T09:30:07Z", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        List<String> afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license will expire in [6] days. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now + 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license expires today. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now - 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        long finalNewExpirationDate = newExpirationDate;\n+        String expiredMessage = String.format(Locale.ROOT, \"Your license expired on [%s]. \",\n+            LicenseService.DATE_FORMATTER.formatMillis(finalNewExpirationDate));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(expiredMessage +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+    }\n+\n+    public void testWarningHeaderAuthenticationFailed() throws Exception {", "originalCommit": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8dc8b9c80857634bd34794740d64f0f4440b7074", "url": "https://github.com/elastic/elasticsearch/commit/8dc8b9c80857634bd34794740d64f0f4440b7074", "message": "Nit changes", "committedDate": "2020-12-04T10:45:45Z", "type": "commit"}, {"oid": "a939ae85a7ae6cac7fe20ae9e5653b0c689c6efd", "url": "https://github.com/elastic/elasticsearch/commit/a939ae85a7ae6cac7fe20ae9e5653b0c689c6efd", "message": "Merge branch 'master' into Warning_header", "committedDate": "2020-12-04T11:41:05Z", "type": "commit"}]}