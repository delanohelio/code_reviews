{"pr_number": 55437, "pr_title": "Fix certutil http for empty password with JDK 11 and lower", "pr_author": "ywangd", "pr_createdAt": "2020-04-20T05:44:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/55437", "timeline": [{"oid": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "url": "https://github.com/elastic/elasticsearch/commit/0a4431ddc55480d58581bb299bc1c7d9bca342fd", "message": "Support empty keystore password for JDK 11 and lower", "committedDate": "2020-04-20T05:37:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTEwODQ5MA==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r411108490", "body": "Commands other than `http` do not have issue with empty password because of the `withPassword(...)` wrapper. These empty strings are just added here for completeness.\r\nhttps://github.com/elastic/elasticsearch/blob/c5b923afec911c6ae8fc5179e65ae6bf55dcc5f1/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java#L928-L940", "bodyText": "Commands other than http do not have issue with empty password because of the withPassword(...) wrapper. These empty strings are just added here for completeness.\n\n  \n    \n      elasticsearch/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java\n    \n    \n        Lines 928 to 940\n      in\n      c5b923a\n    \n    \n    \n    \n\n        \n          \n           private static <T, E extends Exception> T withPassword(String description, char[] password, Terminal terminal, \n        \n\n        \n          \n                                                                  CheckedFunction<char[], T, E> body) throws E { \n        \n\n        \n          \n               if (password == null) { \n        \n\n        \n          \n                   char[] promptedValue = terminal.readSecret(\"Enter password for \" + description + \" : \"); \n        \n\n        \n          \n                   try { \n        \n\n        \n          \n                       return body.apply(promptedValue); \n        \n\n        \n          \n                   } finally { \n        \n\n        \n          \n                       Arrays.fill(promptedValue, (char) 0); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } else { \n        \n\n        \n          \n                   return body.apply(password); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }", "bodyHTML": "<p dir=\"auto\">Commands other than <code>http</code> do not have issue with empty password because of the <code>withPassword(...)</code> wrapper. These empty strings are just added here for completeness.<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/elastic/elasticsearch/blob/c5b923afec911c6ae8fc5179e65ae6bf55dcc5f1/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java#L928-L940\">elasticsearch/x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 928 to 940\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/elastic/elasticsearch/commit/c5b923afec911c6ae8fc5179e65ae6bf55dcc5f1\">c5b923a</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L928\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"928\"></td>\n          <td id=\"LC928\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">&lt;<span class=\"pl-smi\">T</span>, <span class=\"pl-smi\">E</span> extends <span class=\"pl-smi\">Exception</span>&gt;</span> <span class=\"pl-smi\">T</span> <span class=\"pl-en\">withPassword</span>(<span class=\"pl-smi\">String</span> <span class=\"pl-v\">description</span>, <span class=\"pl-k\">char</span>[] <span class=\"pl-v\">password</span>, <span class=\"pl-smi\">Terminal</span> <span class=\"pl-v\">terminal</span>, </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L929\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"929\"></td>\n          <td id=\"LC929\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                                                        <span class=\"pl-k\">CheckedFunction&lt;char[], <span class=\"pl-smi\">T</span>, <span class=\"pl-smi\">E</span>&gt;</span> <span class=\"pl-v\">body</span>) <span class=\"pl-k\">throws</span> <span class=\"pl-smi\">E</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L930\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"930\"></td>\n          <td id=\"LC930\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">if</span> (password <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L931\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"931\"></td>\n          <td id=\"LC931\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">char</span>[] promptedValue <span class=\"pl-k\">=</span> terminal<span class=\"pl-k\">.</span>readSecret(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Enter password for <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> description <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span> : <span class=\"pl-pds\">\"</span></span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L932\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"932\"></td>\n          <td id=\"LC932\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">try</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L933\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"933\"></td>\n          <td id=\"LC933\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-k\">return</span> body<span class=\"pl-k\">.</span>apply(promptedValue); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L934\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"934\"></td>\n          <td id=\"LC934\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         } <span class=\"pl-k\">finally</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L935\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"935\"></td>\n          <td id=\"LC935\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-smi\">Arrays</span><span class=\"pl-k\">.</span>fill(promptedValue, (<span class=\"pl-k\">char</span>) <span class=\"pl-c1\">0</span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L936\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"936\"></td>\n          <td id=\"LC936\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L937\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"937\"></td>\n          <td id=\"LC937\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } <span class=\"pl-k\">else</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L938\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"938\"></td>\n          <td id=\"LC938\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">return</span> body<span class=\"pl-k\">.</span>apply(password); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L939\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"939\"></td>\n          <td id=\"LC939\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L940\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"940\"></td>\n          <td id=\"LC940\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "ywangd", "createdAt": "2020-04-20T05:47:29Z", "path": "x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/CertificateToolTests.java", "diffHunk": "@@ -563,10 +563,10 @@ public void testCreateCaAndMultipleInstances() throws Exception {\n \n         final int days = randomIntBetween(7, 1500);\n \n-        final String caPassword = randomAlphaOfLengthBetween(4, 16);\n-        final String node1Password = randomAlphaOfLengthBetween(4, 16);\n-        final String node2Password = randomAlphaOfLengthBetween(4, 16);\n-        final String node3Password = randomAlphaOfLengthBetween(4, 16);\n+        final String caPassword = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));\n+        final String node1Password = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));\n+        final String node2Password = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));\n+        final String node3Password = randomFrom(\"\", randomAlphaOfLengthBetween(4, 16));", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTExMTAxMQ==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r411111011", "body": "This change is the fix. But is there any reason this was intentionally set to `null` for empty char array? I wonder whether the change would introduce any subtle side effect. @tvernum ", "bodyText": "This change is the fix. But is there any reason this was intentionally set to null for empty char array? I wonder whether the change would introduce any subtle side effect. @tvernum", "bodyHTML": "<p dir=\"auto\">This change is the fix. But is there any reason this was intentionally set to <code>null</code> for empty char array? I wonder whether the change would introduce any subtle side effect. <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/tvernum/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/tvernum\">@tvernum</a></p>", "author": "ywangd", "createdAt": "2020-04-20T05:54:33Z", "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommand.java", "diffHunk": "@@ -864,7 +864,7 @@ private boolean askCertSigningRequest(Terminal terminal) {\n             terminal.println(\"IT IS IMPORTANT THAT YOU REMEMBER THIS PASSWORD AND KEEP IT SECURE\");\n             terminal.println(\"\");\n             final char[] password = readPassword(terminal, \"CA password: \", true);\n-            return new CertificateTool.CAInfo(caCert, keyPair.getPrivate(), true, password.length == 0 ? null : password);\n+            return new CertificateTool.CAInfo(caCert, keyPair.getPrivate(), true, password);", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIxODI4MA==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412218280", "bodyText": "Inspecting the uses of this returned CAInfo instance, I am pretty sure this change is not impactful.\nHowever, looking at this other use of CAInfo, there seems to be a pattern where a null value is used to signal that a password prompt is further required. I believe the original code here intended for this same behavior.", "author": "albertzaharovits", "createdAt": "2020-04-21T14:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTExMTAxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzOTAwMw==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412239003", "body": "My _preference_ would have been a simple `if` in the code.", "bodyText": "My preference would have been a simple if in the code.", "bodyHTML": "<p dir=\"auto\">My <em>preference</em> would have been a simple <code>if</code> in the code.</p>", "author": "albertzaharovits", "createdAt": "2020-04-21T14:33:25Z", "path": "x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommandTests.java", "diffHunk": "@@ -589,7 +590,16 @@ private String formatIpAddress(byte[] addr) throws UnknownHostException {\n     private String randomPassword() {\n         // We want to assert that this password doesn't end up in any output files, so we need to make sure we\n         // don't randomly generate a real word.\n-        return randomAlphaOfLength(4) + randomFrom('~', '*', '%', '$', '|') + randomAlphaOfLength(4);\n+        return randomFrom(\n+            \"\",\n+            randomAlphaOfLength(4) + randomFrom('~', '*', '%', '$', '|') + randomAlphaOfLength(4)\n+        );\n+    }\n+\n+    private void runForNonEmptyPattern(String pattern, Runnable runnable) {\n+        if (\"\".equals(pattern) == false) {\n+            runnable.run();\n+        }\n     }", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4NzIwOA==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412587208", "bodyText": "Sure I removed it and replaced with if check in the call sites.", "author": "ywangd", "createdAt": "2020-04-22T00:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIzOTAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI0NjcyNg==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412246726", "body": "I would've not included the empty password in the list of `shouldNotContain`, but it's just a personal preference.", "bodyText": "I would've not included the empty password in the list of shouldNotContain, but it's just a personal preference.", "bodyHTML": "<p dir=\"auto\">I would've not included the empty password in the list of <code>shouldNotContain</code>, but it's just a personal preference.</p>", "author": "albertzaharovits", "createdAt": "2020-04-21T14:42:20Z", "path": "x-pack/plugin/security/cli/src/test/java/org/elasticsearch/xpack/security/cli/HttpCertificateCommandTests.java", "diffHunk": "@@ -699,11 +709,11 @@ private void verifyKibanaDirectory(Path zipRoot, boolean expectCAFile, Iterable<\n         assertThat(kibanaReadme, containsString(\"https://\"));\n         assertThat(kibanaReadme, containsString(\"elasticsearch-ca.pem\"));\n         readmeShouldContain.forEach(s -> assertThat(kibanaReadme, containsString(s)));\n-        shouldNotContain.forEach(s -> assertThat(kibanaReadme, not(containsString(s))));\n+        shouldNotContain.forEach(s -> runForNonEmptyPattern(s, () -> assertThat(kibanaReadme, not(containsString(s)))));\n \n         assertThat(kibanaYml, containsString(\"elasticsearch.ssl.certificateAuthorities: [ \\\"config/elasticsearch-ca.pem\\\" ]\"));\n         assertThat(kibanaYml, containsString(\"https://\"));\n-        shouldNotContain.forEach(s -> assertThat(kibanaYml, not(containsString(s))));\n+        shouldNotContain.forEach(s -> runForNonEmptyPattern(s, () -> assertThat(kibanaYml, not(containsString(s)))));\n     }", "originalCommit": "0a4431ddc55480d58581bb299bc1c7d9bca342fd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4NzQxNg==", "url": "https://github.com/elastic/elasticsearch/pull/55437#discussion_r412587416", "bodyText": "Makes sense. The list is not filtered before passed in.", "author": "ywangd", "createdAt": "2020-04-22T00:43:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI0NjcyNg=="}], "type": "inlineReview"}, {"oid": "ad06cd29ac38f46a9c0cfd469349b85b60cfaa75", "url": "https://github.com/elastic/elasticsearch/commit/ad06cd29ac38f46a9c0cfd469349b85b60cfaa75", "message": "Address feedback.", "committedDate": "2020-04-22T00:41:01Z", "type": "commit"}, {"oid": "d0e767099863baf7b01a8a408ff078fe6dba23c8", "url": "https://github.com/elastic/elasticsearch/commit/d0e767099863baf7b01a8a408ff078fe6dba23c8", "message": "Merge remote-tracking branch 'origin/master' into es-55386-p12-null-password", "committedDate": "2020-04-22T00:41:58Z", "type": "commit"}]}