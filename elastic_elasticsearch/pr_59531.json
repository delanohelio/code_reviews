{"pr_number": 59531, "pr_title": "Fix auditing of nameless API Keys", "pr_author": "albertzaharovits", "pr_createdAt": "2020-07-14T12:53:57Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/59531", "timeline": [{"oid": "e8d55d9eb82b68256c456c9e16cfcae543cd0c9c", "url": "https://github.com/elastic/elasticsearch/commit/e8d55d9eb82b68256c456c9e16cfcae543cd0c9c", "message": "namelless api key authn", "committedDate": "2020-07-14T12:47:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MjI2MA==", "url": "https://github.com/elastic/elasticsearch/pull/59531#discussion_r454342260", "body": "This can be just\r\n```java\r\nlogEntry.with(API_KEY_NAME_FIELD_NAME, apiKeyName);\r\n```", "bodyText": "This can be just\nlogEntry.with(API_KEY_NAME_FIELD_NAME, apiKeyName);", "bodyHTML": "<p dir=\"auto\">This can be just</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"logEntry.with(API_KEY_NAME_FIELD_NAME, apiKeyName);\n\"><pre>logEntry<span class=\"pl-k\">.</span>with(<span class=\"pl-c1\">API_KEY_NAME_FIELD_NAME</span>, apiKeyName);</pre></div>", "author": "ywangd", "createdAt": "2020-07-14T13:07:34Z", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -832,8 +832,11 @@ LogEntryBuilder withAuthentication(Authentication authentication) {\n             logEntry.with(PRINCIPAL_FIELD_NAME, authentication.getUser().principal());\n             logEntry.with(AUTHENTICATION_TYPE_FIELD_NAME, authentication.getAuthenticationType().toString());\n             if (Authentication.AuthenticationType.API_KEY == authentication.getAuthenticationType()) {\n-                logEntry.with(API_KEY_ID_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY))\n-                        .with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY));\n+                logEntry.with(API_KEY_ID_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY));\n+                String apiKeyName = (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY);\n+                if (apiKeyName != null) {\n+                    logEntry.with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY));", "originalCommit": "e8d55d9eb82b68256c456c9e16cfcae543cd0c9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3a65006a8bcb24ba869bde25fb8cbcac9a7f881a", "url": "https://github.com/elastic/elasticsearch/commit/3a65006a8bcb24ba869bde25fb8cbcac9a7f881a", "message": "Review", "committedDate": "2020-07-14T13:21:37Z", "type": "commit"}]}