{"pr_number": 51682, "pr_title": "Add IDP Configuration settings and related tests", "pr_author": "jkakavas", "pr_createdAt": "2020-01-30T14:40:52Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51682", "timeline": [{"oid": "57d2d76f3d864178fd2d6f3bf5f7f1131cf19155", "url": "https://github.com/elastic/elasticsearch/commit/57d2d76f3d864178fd2d6f3bf5f7f1131cf19155", "message": "Add IDP Configuration settings and related tests", "committedDate": "2020-01-30T14:35:28Z", "type": "commit"}, {"oid": "fcb2e8c28112e00dae8cb5a29d919a2772ba17ab", "url": "https://github.com/elastic/elasticsearch/commit/fcb2e8c28112e00dae8cb5a29d919a2772ba17ab", "message": "license and missing conf", "committedDate": "2020-01-30T14:40:33Z", "type": "commit"}, {"oid": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "url": "https://github.com/elastic/elasticsearch/commit/db7cb6719c4d60050183e5fc3ab0446228e837cf", "message": "Add scope to settings", "committedDate": "2020-01-30T14:51:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI1NDc0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373254749", "body": "Should we make these `Setting<URI>` instead?\r\n\r\n", "bodyText": "Should we make these Setting<URI> instead?", "bodyHTML": "<p dir=\"auto\">Should we make these <code>Setting&lt;URI&gt;</code> instead?</p>", "author": "tvernum", "createdAt": "2020-01-30T23:49:41Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/IdentityProviderPlugin.java", "diffHunk": "@@ -31,22 +38,72 @@\n  */\n public class IdentityProviderPlugin extends Plugin implements ActionPlugin {\n \n-    private final Setting<Boolean> ENABLED_SETTING = Setting.boolSetting(\"xpack.idp.enabled\", false, Setting.Property.NodeScope);\n+    private static final Setting<Boolean> ENABLED_SETTING = Setting.boolSetting(\"xpack.idp.enabled\", false, Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_ENTITY_ID = Setting.simpleString(\"xpack.idp.entity_id\", Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_SSO_REDIRECT_ENDPOINT = Setting.simpleString(\"xpack.idp.sso_endpoint.redirect\", value -> {", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMDEwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373320101", "bodyText": "I went back and forth. I settled on that we care about them being URIs mainly when we validate them while reading the setting and from there on we can treat them as Strings. Since I don't see any other use for these other than:\n\nConstructing metadata\nValidating Authn and Logout Requests where we will use string equality eitherway\n\nit feels that future implementers or anyone reading the code doesn't need to care about the fact that these are URIs so I opted for the \"simpler\" handling.", "author": "jkakavas", "createdAt": "2020-01-31T05:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI1NDc0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI1Njc0NA==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373256744", "body": "The previous implementation is actually correct.\r\nPlugins should do as little as possible in the constructor, and everything that can be, should be handled in `createComponents`\r\nSee: https://github.com/elastic/elasticsearch/pull/49667\r\n\r\nThe main issue is that a plugin is permitted to override the node's settings. But due to the plugin lifecycle, that has to happen _after_ the plugin is constructed, which means after _all_ plugins are constructed.\r\nSo the `Settings` object here is only a subset of the settings that the node might actually run with.\r\n ", "bodyText": "The previous implementation is actually correct.\nPlugins should do as little as possible in the constructor, and everything that can be, should be handled in createComponents\nSee: #49667\nThe main issue is that a plugin is permitted to override the node's settings. But due to the plugin lifecycle, that has to happen after the plugin is constructed, which means after all plugins are constructed.\nSo the Settings object here is only a subset of the settings that the node might actually run with.", "bodyHTML": "<p dir=\"auto\">The previous implementation is actually correct.<br>\nPlugins should do as little as possible in the constructor, and everything that can be, should be handled in <code>createComponents</code><br>\nSee: <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"529669178\" data-permission-text=\"Title is private\" data-url=\"https://github.com/elastic/elasticsearch/issues/49667\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/elastic/elasticsearch/pull/49667/hovercard\" href=\"https://github.com/elastic/elasticsearch/pull/49667\">#49667</a></p>\n<p dir=\"auto\">The main issue is that a plugin is permitted to override the node's settings. But due to the plugin lifecycle, that has to happen <em>after</em> the plugin is constructed, which means after <em>all</em> plugins are constructed.<br>\nSo the <code>Settings</code> object here is only a subset of the settings that the node might actually run with.</p>", "author": "tvernum", "createdAt": "2020-01-30T23:57:05Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/IdentityProviderPlugin.java", "diffHunk": "@@ -31,22 +38,72 @@\n  */\n public class IdentityProviderPlugin extends Plugin implements ActionPlugin {\n \n-    private final Setting<Boolean> ENABLED_SETTING = Setting.boolSetting(\"xpack.idp.enabled\", false, Setting.Property.NodeScope);\n+    private static final Setting<Boolean> ENABLED_SETTING = Setting.boolSetting(\"xpack.idp.enabled\", false, Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_ENTITY_ID = Setting.simpleString(\"xpack.idp.entity_id\", Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_SSO_REDIRECT_ENDPOINT = Setting.simpleString(\"xpack.idp.sso_endpoint.redirect\", value -> {\n+        try {\n+            new URI(value);\n+        } catch (URISyntaxException e) {\n+            throw new IllegalArgumentException(\"Invalid value [\" + value + \"] for  [xpack.idp.sso_endpoint.redirect]. Not a valid URI\", e);\n+        }\n+    }, Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_SSO_POST_ENDPOINT = Setting.simpleString(\"xpack.idp.sso_endpoint.post\", value -> {\n+        try {\n+            new URI(value);\n+        } catch (URISyntaxException e) {\n+            throw new IllegalArgumentException(\"Invalid value [\" + value + \"] for  [xpack.idp.sso_endpoint.post]. Not a valid URI\", e);\n+        }\n+    }, Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_SLO_REDIRECT_ENDPOINT = Setting.simpleString(\"xpack.idp.slo_endpoint.redirect\", value -> {\n+        try {\n+            new URI(value);\n+        } catch (URISyntaxException e) {\n+            throw new IllegalArgumentException(\"Invalid value [\" + value + \"] for  [xpack.idp.slo_endpoint.redirect]. Not a valid URI\", e);\n+        }\n+    }, Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_SLO_POST_ENDPOINT = Setting.simpleString(\"xpack.idp.slo_endpoint.post\", value -> {\n+        try {\n+            new URI(value);\n+        } catch (URISyntaxException e) {\n+            throw new IllegalArgumentException(\"Invalid value [\" + value + \"] for  [xpack.idp.slo_endpoint.post]. Not a valid URI\", e);\n+        }\n+    }, Setting.Property.NodeScope);\n+    public static final Setting<String> IDP_SIGNING_KEY_ALIAS = Setting.simpleString(\"xpack.idp.signing.keystore.alias\",\n+        Setting.Property.NodeScope);\n \n     private final Logger logger = LogManager.getLogger();\n     private boolean enabled;\n+    private final Settings settings;\n+\n+    public IdentityProviderPlugin(Settings settings) {\n+        this.settings = settings;\n+        this.enabled = ENABLED_SETTING.get(settings);\n+    }", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI1OTc1OA==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373259758", "body": "I don't understand why we have 1 `put` and 3 `computeIfAbsent`\r\nI think you'd get the same bevahiour with 4 `put` wouldn't you? None of the keys are going to be present.", "bodyText": "I don't understand why we have 1 put and 3 computeIfAbsent\nI think you'd get the same bevahiour with 4 put wouldn't you? None of the keys are going to be present.", "bodyHTML": "<p dir=\"auto\">I don't understand why we have 1 <code>put</code> and 3 <code>computeIfAbsent</code><br>\nI think you'd get the same bevahiour with 4 <code>put</code> wouldn't you? None of the keys are going to be present.</p>", "author": "tvernum", "createdAt": "2020-01-31T00:08:48Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.idp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsException;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.xpack.core.ssl.CertParsingUtils;\n+import org.elasticsearch.xpack.core.ssl.X509KeyPairSettings;\n+import org.opensaml.security.x509.X509Credential;\n+import org.opensaml.security.x509.impl.X509KeyManagerX509CredentialAdapter;\n+\n+import javax.net.ssl.X509KeyManager;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_ENTITY_ID;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SIGNING_KEY_ALIAS;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_REDIRECT_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_REDIRECT_ENDPOINT;\n+\n+public class CloudIdp implements SamlIdentityProvider {\n+\n+    private final String entityId;\n+    private final HashMap<String, String> ssoEndpoints = new HashMap<>();\n+    private final HashMap<String, String> sloEndpoints = new HashMap<>();\n+    private final X509Credential signingCredential;\n+\n+    public CloudIdp(Environment env, Settings settings) {\n+        this.entityId = require(settings, IDP_ENTITY_ID);\n+        this.ssoEndpoints.put(\"redirect\", require(settings, IDP_SSO_REDIRECT_ENDPOINT));\n+        this.ssoEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SSO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SLO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"redirect\", v -> settings.get(IDP_SLO_REDIRECT_ENDPOINT.getKey()));", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMDExMw==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373320113", "bodyText": "The \"added benefit\" of computeIfAbsent is that if the setting is not defined and settings.get returns null, then the null value won't be added to the hashmap.\nI don't feel strongly about it, it seemed as a nice thing to do but I could also do with null checks here or when consuming the map values.", "author": "jkakavas", "createdAt": "2020-01-31T05:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI1OTc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyNzAzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373927039", "bodyText": "It seems like it's depending on a side effect (a documented one, but still a side effect) and makes the code less clear because the reader is left trying to understand why we're using different methods.\nI'm not particular fussed though.", "author": "tvernum", "createdAt": "2020-02-03T05:28:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI1OTc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MDQ3Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373260472", "body": "Nit: I prefer putting the whole string on a new line rather than splitting it. I find it easier to check that the message has the right spaces, and no duplicate words, etc if I can read it in 1 unit.\r\n```\r\n    throw new IllegalArgumentException(\r\n        \"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC key pairs\");\r\n```\r\n", "bodyText": "Nit: I prefer putting the whole string on a new line rather than splitting it. I find it easier to check that the message has the right spaces, and no duplicate words, etc if I can read it in 1 unit.\n    throw new IllegalArgumentException(\n        \"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC key pairs\");", "bodyHTML": "<p dir=\"auto\">Nit: I prefer putting the whole string on a new line rather than splitting it. I find it easier to check that the message has the right spaces, and no duplicate words, etc if I can read it in 1 unit.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    throw new IllegalArgumentException(\n        &quot;The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC key pairs&quot;);\"><pre><code>    throw new IllegalArgumentException(\n        \"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC key pairs\");\n</code></pre></div>", "author": "tvernum", "createdAt": "2020-01-31T00:11:56Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.idp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsException;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.xpack.core.ssl.CertParsingUtils;\n+import org.elasticsearch.xpack.core.ssl.X509KeyPairSettings;\n+import org.opensaml.security.x509.X509Credential;\n+import org.opensaml.security.x509.impl.X509KeyManagerX509CredentialAdapter;\n+\n+import javax.net.ssl.X509KeyManager;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_ENTITY_ID;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SIGNING_KEY_ALIAS;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_REDIRECT_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_REDIRECT_ENDPOINT;\n+\n+public class CloudIdp implements SamlIdentityProvider {\n+\n+    private final String entityId;\n+    private final HashMap<String, String> ssoEndpoints = new HashMap<>();\n+    private final HashMap<String, String> sloEndpoints = new HashMap<>();\n+    private final X509Credential signingCredential;\n+\n+    public CloudIdp(Environment env, Settings settings) {\n+        this.entityId = require(settings, IDP_ENTITY_ID);\n+        this.ssoEndpoints.put(\"redirect\", require(settings, IDP_SSO_REDIRECT_ENDPOINT));\n+        this.ssoEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SSO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SLO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"redirect\", v -> settings.get(IDP_SLO_REDIRECT_ENDPOINT.getKey()));\n+        this.signingCredential = buildSigningCredential(env, settings);\n+    }\n+\n+    @Override\n+    public String getEntityId() {\n+        return entityId;\n+    }\n+\n+    @Override\n+    public String getSingleSignOnEndpoint(String binding) {\n+        return ssoEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public String getSingleLogoutEndpoint(String binding) {\n+        return sloEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public X509Credential getSigningCredential() {\n+        return signingCredential;\n+    }\n+\n+    private static String require(Settings settings, Setting<String> setting) {\n+        if (settings.hasValue(setting.getKey())) {\n+            return setting.get(settings);\n+        } else {\n+            throw new SettingsException(\"The configuration setting [\" + setting.getKey() + \"] is required\");\n+        }\n+    }\n+\n+    static X509Credential buildSigningCredential(Environment env, Settings settings) {\n+        final X509KeyPairSettings keyPairSettings = X509KeyPairSettings.withPrefix(\"xpack.idp.signing.\", false);\n+        final X509KeyManager keyManager = CertParsingUtils.getKeyManager(keyPairSettings, settings, null, env);\n+        if (keyManager == null) {\n+            return null;\n+        }\n+        final Set<String> aliases = new HashSet<>();\n+        final String configAlias = IDP_SIGNING_KEY_ALIAS.get(settings);\n+        if (Strings.isNullOrEmpty(configAlias)) {\n+            final String[] rsaAliases = keyManager.getServerAliases(\"RSA\", null);\n+            if (null != rsaAliases) {\n+                aliases.addAll(Arrays.asList(rsaAliases));\n+            }\n+            final String[] ecAliases = keyManager.getServerAliases(\"EC\", null);\n+            if (null != ecAliases) {\n+                aliases.addAll(Arrays.asList(ecAliases));\n+            }\n+            if (aliases.isEmpty()) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC\" +\n+                    \" key pairs\");", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MDYzNw==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373260637", "body": "This is an obvious exception since it can't fit on a single line :)", "bodyText": "This is an obvious exception since it can't fit on a single line :)", "bodyHTML": "<p dir=\"auto\">This is an obvious exception since it can't fit on a single line :)</p>", "author": "tvernum", "createdAt": "2020-01-31T00:12:34Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.idp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsException;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.xpack.core.ssl.CertParsingUtils;\n+import org.elasticsearch.xpack.core.ssl.X509KeyPairSettings;\n+import org.opensaml.security.x509.X509Credential;\n+import org.opensaml.security.x509.impl.X509KeyManagerX509CredentialAdapter;\n+\n+import javax.net.ssl.X509KeyManager;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_ENTITY_ID;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SIGNING_KEY_ALIAS;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_REDIRECT_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_REDIRECT_ENDPOINT;\n+\n+public class CloudIdp implements SamlIdentityProvider {\n+\n+    private final String entityId;\n+    private final HashMap<String, String> ssoEndpoints = new HashMap<>();\n+    private final HashMap<String, String> sloEndpoints = new HashMap<>();\n+    private final X509Credential signingCredential;\n+\n+    public CloudIdp(Environment env, Settings settings) {\n+        this.entityId = require(settings, IDP_ENTITY_ID);\n+        this.ssoEndpoints.put(\"redirect\", require(settings, IDP_SSO_REDIRECT_ENDPOINT));\n+        this.ssoEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SSO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SLO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"redirect\", v -> settings.get(IDP_SLO_REDIRECT_ENDPOINT.getKey()));\n+        this.signingCredential = buildSigningCredential(env, settings);\n+    }\n+\n+    @Override\n+    public String getEntityId() {\n+        return entityId;\n+    }\n+\n+    @Override\n+    public String getSingleSignOnEndpoint(String binding) {\n+        return ssoEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public String getSingleLogoutEndpoint(String binding) {\n+        return sloEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public X509Credential getSigningCredential() {\n+        return signingCredential;\n+    }\n+\n+    private static String require(Settings settings, Setting<String> setting) {\n+        if (settings.hasValue(setting.getKey())) {\n+            return setting.get(settings);\n+        } else {\n+            throw new SettingsException(\"The configuration setting [\" + setting.getKey() + \"] is required\");\n+        }\n+    }\n+\n+    static X509Credential buildSigningCredential(Environment env, Settings settings) {\n+        final X509KeyPairSettings keyPairSettings = X509KeyPairSettings.withPrefix(\"xpack.idp.signing.\", false);\n+        final X509KeyManager keyManager = CertParsingUtils.getKeyManager(keyPairSettings, settings, null, env);\n+        if (keyManager == null) {\n+            return null;\n+        }\n+        final Set<String> aliases = new HashSet<>();\n+        final String configAlias = IDP_SIGNING_KEY_ALIAS.get(settings);\n+        if (Strings.isNullOrEmpty(configAlias)) {\n+            final String[] rsaAliases = keyManager.getServerAliases(\"RSA\", null);\n+            if (null != rsaAliases) {\n+                aliases.addAll(Arrays.asList(rsaAliases));\n+            }\n+            final String[] ecAliases = keyManager.getServerAliases(\"EC\", null);\n+            if (null != ecAliases) {\n+                aliases.addAll(Arrays.asList(ecAliases));\n+            }\n+            if (aliases.isEmpty()) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC\" +\n+                    \" key pairs\");\n+            }\n+            if (aliases.size() > 1) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore contains multiple key pairs\" +\n+                    \" but no alias has been configured with [\" + IDP_SIGNING_KEY_ALIAS.getKey() + \"]\");", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMDEzOA==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373320138", "bodyText": "Could you please rephrase/elaborate ?", "author": "jkakavas", "createdAt": "2020-01-31T05:22:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MDYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM2MDY2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373360662", "bodyText": "Sorry, that was very confusing wording.\nGiven this message does not fit onto a single line, I'm not too worried about how it gets split.", "author": "tvernum", "createdAt": "2020-01-31T08:21:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MDYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MDk0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373260943", "body": "My preference is to refer to the `Setting` object for the key\r\n ```suggestion\r\n                 throw new IllegalArgumentException(\"The configured keystore for \" + IDP_SIGNING_KEY_ALIAS.getKey() + \" does not contain any RSA or EC\" +\r\n```", "bodyText": "My preference is to refer to the Setting object for the key\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC\" +\n          \n          \n            \n                            throw new IllegalArgumentException(\"The configured keystore for \" + IDP_SIGNING_KEY_ALIAS.getKey() + \" does not contain any RSA or EC\" +", "bodyHTML": "<p dir=\"auto\">My preference is to refer to the <code>Setting</code> object for the key</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalArgumentException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The configured keystore for <span class=\"x x-first x-last\">xpack.idp.signing.keystore</span> does not contain any RSA or EC<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalArgumentException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The configured keystore for <span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x\">+</span><span class=\"x\"> </span><span class=\"pl-c1 x\">IDP_SIGNING_KEY_ALIAS</span><span class=\"pl-k x\">.</span><span class=\"x\">getKey() </span><span class=\"pl-k x\">+</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x x-last\">\"</span> does not contain any RSA or EC<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-01-31T00:13:53Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.idp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsException;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.xpack.core.ssl.CertParsingUtils;\n+import org.elasticsearch.xpack.core.ssl.X509KeyPairSettings;\n+import org.opensaml.security.x509.X509Credential;\n+import org.opensaml.security.x509.impl.X509KeyManagerX509CredentialAdapter;\n+\n+import javax.net.ssl.X509KeyManager;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_ENTITY_ID;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SIGNING_KEY_ALIAS;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_REDIRECT_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_REDIRECT_ENDPOINT;\n+\n+public class CloudIdp implements SamlIdentityProvider {\n+\n+    private final String entityId;\n+    private final HashMap<String, String> ssoEndpoints = new HashMap<>();\n+    private final HashMap<String, String> sloEndpoints = new HashMap<>();\n+    private final X509Credential signingCredential;\n+\n+    public CloudIdp(Environment env, Settings settings) {\n+        this.entityId = require(settings, IDP_ENTITY_ID);\n+        this.ssoEndpoints.put(\"redirect\", require(settings, IDP_SSO_REDIRECT_ENDPOINT));\n+        this.ssoEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SSO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SLO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"redirect\", v -> settings.get(IDP_SLO_REDIRECT_ENDPOINT.getKey()));\n+        this.signingCredential = buildSigningCredential(env, settings);\n+    }\n+\n+    @Override\n+    public String getEntityId() {\n+        return entityId;\n+    }\n+\n+    @Override\n+    public String getSingleSignOnEndpoint(String binding) {\n+        return ssoEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public String getSingleLogoutEndpoint(String binding) {\n+        return sloEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public X509Credential getSigningCredential() {\n+        return signingCredential;\n+    }\n+\n+    private static String require(Settings settings, Setting<String> setting) {\n+        if (settings.hasValue(setting.getKey())) {\n+            return setting.get(settings);\n+        } else {\n+            throw new SettingsException(\"The configuration setting [\" + setting.getKey() + \"] is required\");\n+        }\n+    }\n+\n+    static X509Credential buildSigningCredential(Environment env, Settings settings) {\n+        final X509KeyPairSettings keyPairSettings = X509KeyPairSettings.withPrefix(\"xpack.idp.signing.\", false);\n+        final X509KeyManager keyManager = CertParsingUtils.getKeyManager(keyPairSettings, settings, null, env);\n+        if (keyManager == null) {\n+            return null;\n+        }\n+        final Set<String> aliases = new HashSet<>();\n+        final String configAlias = IDP_SIGNING_KEY_ALIAS.get(settings);\n+        if (Strings.isNullOrEmpty(configAlias)) {\n+            final String[] rsaAliases = keyManager.getServerAliases(\"RSA\", null);\n+            if (null != rsaAliases) {\n+                aliases.addAll(Arrays.asList(rsaAliases));\n+            }\n+            final String[] ecAliases = keyManager.getServerAliases(\"EC\", null);\n+            if (null != ecAliases) {\n+                aliases.addAll(Arrays.asList(ecAliases));\n+            }\n+            if (aliases.isEmpty()) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC\" +", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMDE0OA==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373320148", "bodyText": "Same here in general, but this is the keystore , not the alias, and we don't define the Setting object explicitly but rather\nsettings.addAll(X509KeyPairSettings.withPrefix(\"xpack.idp.signing.\", false).getAllSettings());\n\nin the plugin", "author": "jkakavas", "createdAt": "2020-01-31T05:22:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MDk0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MTc3MA==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373261770", "body": "I wish there was an obviously neater way to get the element from a singleton set...\r\nConstructing a list just to get at the element makes me feel dirty.\r\n\r\nWe do have `Iterables.get(aliases, 0)`, but maybe we need to implement `Iterables.head(aliases)` (or `Sets.head`)\r\n", "bodyText": "I wish there was an obviously neater way to get the element from a singleton set...\nConstructing a list just to get at the element makes me feel dirty.\nWe do have Iterables.get(aliases, 0), but maybe we need to implement Iterables.head(aliases) (or Sets.head)", "bodyHTML": "<p dir=\"auto\">I wish there was an obviously neater way to get the element from a singleton set...<br>\nConstructing a list just to get at the element makes me feel dirty.</p>\n<p dir=\"auto\">We do have <code>Iterables.get(aliases, 0)</code>, but maybe we need to implement <code>Iterables.head(aliases)</code> (or <code>Sets.head</code>)</p>", "author": "tvernum", "createdAt": "2020-01-31T00:17:17Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.idp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsException;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.xpack.core.ssl.CertParsingUtils;\n+import org.elasticsearch.xpack.core.ssl.X509KeyPairSettings;\n+import org.opensaml.security.x509.X509Credential;\n+import org.opensaml.security.x509.impl.X509KeyManagerX509CredentialAdapter;\n+\n+import javax.net.ssl.X509KeyManager;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_ENTITY_ID;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SIGNING_KEY_ALIAS;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_REDIRECT_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_REDIRECT_ENDPOINT;\n+\n+public class CloudIdp implements SamlIdentityProvider {\n+\n+    private final String entityId;\n+    private final HashMap<String, String> ssoEndpoints = new HashMap<>();\n+    private final HashMap<String, String> sloEndpoints = new HashMap<>();\n+    private final X509Credential signingCredential;\n+\n+    public CloudIdp(Environment env, Settings settings) {\n+        this.entityId = require(settings, IDP_ENTITY_ID);\n+        this.ssoEndpoints.put(\"redirect\", require(settings, IDP_SSO_REDIRECT_ENDPOINT));\n+        this.ssoEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SSO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SLO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"redirect\", v -> settings.get(IDP_SLO_REDIRECT_ENDPOINT.getKey()));\n+        this.signingCredential = buildSigningCredential(env, settings);\n+    }\n+\n+    @Override\n+    public String getEntityId() {\n+        return entityId;\n+    }\n+\n+    @Override\n+    public String getSingleSignOnEndpoint(String binding) {\n+        return ssoEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public String getSingleLogoutEndpoint(String binding) {\n+        return sloEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public X509Credential getSigningCredential() {\n+        return signingCredential;\n+    }\n+\n+    private static String require(Settings settings, Setting<String> setting) {\n+        if (settings.hasValue(setting.getKey())) {\n+            return setting.get(settings);\n+        } else {\n+            throw new SettingsException(\"The configuration setting [\" + setting.getKey() + \"] is required\");\n+        }\n+    }\n+\n+    static X509Credential buildSigningCredential(Environment env, Settings settings) {\n+        final X509KeyPairSettings keyPairSettings = X509KeyPairSettings.withPrefix(\"xpack.idp.signing.\", false);\n+        final X509KeyManager keyManager = CertParsingUtils.getKeyManager(keyPairSettings, settings, null, env);\n+        if (keyManager == null) {\n+            return null;\n+        }\n+        final Set<String> aliases = new HashSet<>();\n+        final String configAlias = IDP_SIGNING_KEY_ALIAS.get(settings);\n+        if (Strings.isNullOrEmpty(configAlias)) {\n+            final String[] rsaAliases = keyManager.getServerAliases(\"RSA\", null);\n+            if (null != rsaAliases) {\n+                aliases.addAll(Arrays.asList(rsaAliases));\n+            }\n+            final String[] ecAliases = keyManager.getServerAliases(\"EC\", null);\n+            if (null != ecAliases) {\n+                aliases.addAll(Arrays.asList(ecAliases));\n+            }\n+            if (aliases.isEmpty()) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC\" +\n+                    \" key pairs\");\n+            }\n+            if (aliases.size() > 1) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore contains multiple key pairs\" +\n+                    \" but no alias has been configured with [\" + IDP_SIGNING_KEY_ALIAS.getKey() + \"]\");\n+            }\n+        } else {\n+            aliases.add(configAlias);\n+        }\n+        String alias = new ArrayList<>(aliases).get(0);", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMDMwNw==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373320307", "bodyText": "I wish there was an obviously neater way to get the element from a singleton set...\n\nThe first time I couldn't do call get(0) on a Set, I thought my IDE was broken. I spent too much time on this rewritting it a couple of ways but didn't really like any. In other cases we also iterate the set with\nfor (String alias: aliases) {\n}\n\nI missed the Iterables.get(aliases, 0), I'll use that one.", "author": "jkakavas", "createdAt": "2020-01-31T05:23:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MjU0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373262542", "body": "This seems strange to me.\r\nCouldn't we\r\n1. create a `final String selectedAlias` local var where we currently declare `aliases`\r\n2. move `aliases` to be contained in the `if` block.\r\n3. change this line to `selectedAlias = configAlias`\r\n4. move the \"get element from singleton set\" into the `if` block.\r\n?", "bodyText": "This seems strange to me.\nCouldn't we\n\ncreate a final String selectedAlias local var where we currently declare aliases\nmove aliases to be contained in the if block.\nchange this line to selectedAlias = configAlias\nmove the \"get element from singleton set\" into the if block.\n?", "bodyHTML": "<p dir=\"auto\">This seems strange to me.<br>\nCouldn't we</p>\n<ol dir=\"auto\">\n<li>create a <code>final String selectedAlias</code> local var where we currently declare <code>aliases</code></li>\n<li>move <code>aliases</code> to be contained in the <code>if</code> block.</li>\n<li>change this line to <code>selectedAlias = configAlias</code></li>\n<li>move the \"get element from singleton set\" into the <code>if</code> block.<br>\n?</li>\n</ol>", "author": "tvernum", "createdAt": "2020-01-31T00:20:01Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.idp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsException;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.xpack.core.ssl.CertParsingUtils;\n+import org.elasticsearch.xpack.core.ssl.X509KeyPairSettings;\n+import org.opensaml.security.x509.X509Credential;\n+import org.opensaml.security.x509.impl.X509KeyManagerX509CredentialAdapter;\n+\n+import javax.net.ssl.X509KeyManager;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_ENTITY_ID;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SIGNING_KEY_ALIAS;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_REDIRECT_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_REDIRECT_ENDPOINT;\n+\n+public class CloudIdp implements SamlIdentityProvider {\n+\n+    private final String entityId;\n+    private final HashMap<String, String> ssoEndpoints = new HashMap<>();\n+    private final HashMap<String, String> sloEndpoints = new HashMap<>();\n+    private final X509Credential signingCredential;\n+\n+    public CloudIdp(Environment env, Settings settings) {\n+        this.entityId = require(settings, IDP_ENTITY_ID);\n+        this.ssoEndpoints.put(\"redirect\", require(settings, IDP_SSO_REDIRECT_ENDPOINT));\n+        this.ssoEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SSO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SLO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"redirect\", v -> settings.get(IDP_SLO_REDIRECT_ENDPOINT.getKey()));\n+        this.signingCredential = buildSigningCredential(env, settings);\n+    }\n+\n+    @Override\n+    public String getEntityId() {\n+        return entityId;\n+    }\n+\n+    @Override\n+    public String getSingleSignOnEndpoint(String binding) {\n+        return ssoEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public String getSingleLogoutEndpoint(String binding) {\n+        return sloEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public X509Credential getSigningCredential() {\n+        return signingCredential;\n+    }\n+\n+    private static String require(Settings settings, Setting<String> setting) {\n+        if (settings.hasValue(setting.getKey())) {\n+            return setting.get(settings);\n+        } else {\n+            throw new SettingsException(\"The configuration setting [\" + setting.getKey() + \"] is required\");\n+        }\n+    }\n+\n+    static X509Credential buildSigningCredential(Environment env, Settings settings) {\n+        final X509KeyPairSettings keyPairSettings = X509KeyPairSettings.withPrefix(\"xpack.idp.signing.\", false);\n+        final X509KeyManager keyManager = CertParsingUtils.getKeyManager(keyPairSettings, settings, null, env);\n+        if (keyManager == null) {\n+            return null;\n+        }\n+        final Set<String> aliases = new HashSet<>();\n+        final String configAlias = IDP_SIGNING_KEY_ALIAS.get(settings);\n+        if (Strings.isNullOrEmpty(configAlias)) {\n+            final String[] rsaAliases = keyManager.getServerAliases(\"RSA\", null);\n+            if (null != rsaAliases) {\n+                aliases.addAll(Arrays.asList(rsaAliases));\n+            }\n+            final String[] ecAliases = keyManager.getServerAliases(\"EC\", null);\n+            if (null != ecAliases) {\n+                aliases.addAll(Arrays.asList(ecAliases));\n+            }\n+            if (aliases.isEmpty()) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC\" +\n+                    \" key pairs\");\n+            }\n+            if (aliases.size() > 1) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore contains multiple key pairs\" +\n+                    \" but no alias has been configured with [\" + IDP_SIGNING_KEY_ALIAS.getKey() + \"]\");\n+            }\n+        } else {\n+            aliases.add(configAlias);", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMDMzOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373320339", "bodyText": "Yes. that is much neater thanks", "author": "jkakavas", "createdAt": "2020-01-31T05:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MjU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MjcyMw==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373262723", "body": "Minor: Can we extract `keyManager.getPrivateKey(alias)` into a local since we call it twice?", "bodyText": "Minor: Can we extract keyManager.getPrivateKey(alias) into a local since we call it twice?", "bodyHTML": "<p dir=\"auto\">Minor: Can we extract <code>keyManager.getPrivateKey(alias)</code> into a local since we call it twice?</p>", "author": "tvernum", "createdAt": "2020-01-31T00:20:45Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.idp;\n+\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.settings.SettingsException;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.xpack.core.ssl.CertParsingUtils;\n+import org.elasticsearch.xpack.core.ssl.X509KeyPairSettings;\n+import org.opensaml.security.x509.X509Credential;\n+import org.opensaml.security.x509.impl.X509KeyManagerX509CredentialAdapter;\n+\n+import javax.net.ssl.X509KeyManager;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_ENTITY_ID;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SIGNING_KEY_ALIAS;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SLO_REDIRECT_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_POST_ENDPOINT;\n+import static org.elasticsearch.xpack.idp.IdentityProviderPlugin.IDP_SSO_REDIRECT_ENDPOINT;\n+\n+public class CloudIdp implements SamlIdentityProvider {\n+\n+    private final String entityId;\n+    private final HashMap<String, String> ssoEndpoints = new HashMap<>();\n+    private final HashMap<String, String> sloEndpoints = new HashMap<>();\n+    private final X509Credential signingCredential;\n+\n+    public CloudIdp(Environment env, Settings settings) {\n+        this.entityId = require(settings, IDP_ENTITY_ID);\n+        this.ssoEndpoints.put(\"redirect\", require(settings, IDP_SSO_REDIRECT_ENDPOINT));\n+        this.ssoEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SSO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"post\", v -> settings.get(IDP_SLO_POST_ENDPOINT.getKey()));\n+        this.sloEndpoints.computeIfAbsent(\"redirect\", v -> settings.get(IDP_SLO_REDIRECT_ENDPOINT.getKey()));\n+        this.signingCredential = buildSigningCredential(env, settings);\n+    }\n+\n+    @Override\n+    public String getEntityId() {\n+        return entityId;\n+    }\n+\n+    @Override\n+    public String getSingleSignOnEndpoint(String binding) {\n+        return ssoEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public String getSingleLogoutEndpoint(String binding) {\n+        return sloEndpoints.get(binding);\n+    }\n+\n+    @Override\n+    public X509Credential getSigningCredential() {\n+        return signingCredential;\n+    }\n+\n+    private static String require(Settings settings, Setting<String> setting) {\n+        if (settings.hasValue(setting.getKey())) {\n+            return setting.get(settings);\n+        } else {\n+            throw new SettingsException(\"The configuration setting [\" + setting.getKey() + \"] is required\");\n+        }\n+    }\n+\n+    static X509Credential buildSigningCredential(Environment env, Settings settings) {\n+        final X509KeyPairSettings keyPairSettings = X509KeyPairSettings.withPrefix(\"xpack.idp.signing.\", false);\n+        final X509KeyManager keyManager = CertParsingUtils.getKeyManager(keyPairSettings, settings, null, env);\n+        if (keyManager == null) {\n+            return null;\n+        }\n+        final Set<String> aliases = new HashSet<>();\n+        final String configAlias = IDP_SIGNING_KEY_ALIAS.get(settings);\n+        if (Strings.isNullOrEmpty(configAlias)) {\n+            final String[] rsaAliases = keyManager.getServerAliases(\"RSA\", null);\n+            if (null != rsaAliases) {\n+                aliases.addAll(Arrays.asList(rsaAliases));\n+            }\n+            final String[] ecAliases = keyManager.getServerAliases(\"EC\", null);\n+            if (null != ecAliases) {\n+                aliases.addAll(Arrays.asList(ecAliases));\n+            }\n+            if (aliases.isEmpty()) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not contain any RSA or EC\" +\n+                    \" key pairs\");\n+            }\n+            if (aliases.size() > 1) {\n+                throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore contains multiple key pairs\" +\n+                    \" but no alias has been configured with [\" + IDP_SIGNING_KEY_ALIAS.getKey() + \"]\");\n+            }\n+        } else {\n+            aliases.add(configAlias);\n+        }\n+        String alias = new ArrayList<>(aliases).get(0);\n+        if (keyManager.getPrivateKey(alias) == null) {\n+            throw new IllegalArgumentException(\"The configured keystore for xpack.idp.signing.keystore does not have a private key\" +\n+                \" associated with alias [\" + alias + \"]\");\n+        }\n+\n+        final String keyType = keyManager.getPrivateKey(alias).getAlgorithm();", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MzI0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373263249", "body": "Could these return `URI` instead?\r\n\r\nAlso where do we expect to need these? Is it just for metadata? (which is a real need - I just want to check how we expect to consume them).\r\n", "bodyText": "Could these return URI instead?\nAlso where do we expect to need these? Is it just for metadata? (which is a real need - I just want to check how we expect to consume them).", "bodyHTML": "<p dir=\"auto\">Could these return <code>URI</code> instead?</p>\n<p dir=\"auto\">Also where do we expect to need these? Is it just for metadata? (which is a real need - I just want to check how we expect to consume them).</p>", "author": "tvernum", "createdAt": "2020-01-31T00:22:38Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProvider.java", "diffHunk": "@@ -7,10 +7,18 @@\n package org.elasticsearch.xpack.idp.saml.idp;\n \n \n+import org.opensaml.security.x509.X509Credential;\n+\n /**\n  * SAML 2.0 configuration information about this IdP\n  */\n public interface SamlIdentityProvider {\n \n     String getEntityId();\n+\n+    String getSingleSignOnEndpoint(String binding);", "originalCommit": "db7cb6719c4d60050183e5fc3ab0446228e837cf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyMDQ2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/51682#discussion_r373320467", "bodyText": "see #51682 (comment)\n\nAlso where do we expect to need these? Is it just for metadata?\n\nMetadata creation and incoming SAML message validation", "author": "jkakavas", "createdAt": "2020-01-31T05:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI2MzI0OQ=="}], "type": "inlineReview"}, {"oid": "8ed79cbab0a48778566813e4776750ae6cc5b031", "url": "https://github.com/elastic/elasticsearch/commit/8ed79cbab0a48778566813e4776750ae6cc5b031", "message": "address feedback", "committedDate": "2020-01-31T05:28:14Z", "type": "commit"}, {"oid": "a4136c7166685413ee1f9032c301310039e41ee4", "url": "https://github.com/elastic/elasticsearch/commit/a4136c7166685413ee1f9032c301310039e41ee4", "message": "add missing file", "committedDate": "2020-01-31T10:01:49Z", "type": "commit"}, {"oid": "5252c8bd7e4462999cc4fe82589c8fbb7aa7c730", "url": "https://github.com/elastic/elasticsearch/commit/5252c8bd7e4462999cc4fe82589c8fbb7aa7c730", "message": "address feedback", "committedDate": "2020-02-03T09:06:54Z", "type": "commit"}, {"oid": "00caa85a0e3f659159663afd8c9019a441aee805", "url": "https://github.com/elastic/elasticsearch/commit/00caa85a0e3f659159663afd8c9019a441aee805", "message": "Merge branch 'feature-internal-idp' into idp-configuration", "committedDate": "2020-02-03T09:56:13Z", "type": "commit"}]}