{"pr_number": 54197, "pr_title": "Compatible logic for include_type_param and RestCreateIndexAction", "pr_author": "pgomulka", "pr_createdAt": "2020-03-25T15:40:37Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/54197", "timeline": [{"oid": "96ebb5c3376dc5309e27e41890ab041f2bceeec6", "url": "https://github.com/elastic/elasticsearch/commit/96ebb5c3376dc5309e27e41890ab041f2bceeec6", "message": "init work. 221 vs 231 failing\n\nfixed get/index tests\nCompatRestIT. test {yaml=get/21_stored_fields_with_types/Stored fields}\nCompatRestIT. test {yaml=get/71_source_filtering_with_types/Source\nfiltering}\n\nCompatRestIT. test {yaml=index/70_mix_typeless_typeful/Index call that\nintroduces new field mappings}\nCompatRestIT. test {yaml=index/70_mix_typeless_typeful/Index with\ntypeless API on an index that has types}\n\nhowever the last one from get is still failing\nCompatRestIT. test {yaml=get/100_mix_typeless_typeful/GET with typeless\nAPI on an index that has", "committedDate": "2020-03-25T15:38:40Z", "type": "commit"}, {"oid": "2e922bf77ab08d48a8c2c48f8073b082275cbf10", "url": "https://github.com/elastic/elasticsearch/commit/2e922bf77ab08d48a8c2c48f8073b082275cbf10", "message": "allow registering multiple rest actions under the same path", "committedDate": "2020-03-27T13:57:42Z", "type": "commit"}, {"oid": "e7eda970edfec379bba6e91b8ba66495ebdedd67", "url": "https://github.com/elastic/elasticsearch/commit/e7eda970edfec379bba6e91b8ba66495ebdedd67", "message": "revert out dirs", "committedDate": "2020-03-27T14:07:44Z", "type": "commit"}, {"oid": "5dac4b9cbcd77ffbc662d2912067f4d6f49555b6", "url": "https://github.com/elastic/elasticsearch/commit/5dac4b9cbcd77ffbc662d2912067f4d6f49555b6", "message": "Merge branch 'compat_rest_api' into compat/create_index_include_type", "committedDate": "2020-03-27T14:15:22Z", "type": "commit"}, {"oid": "a213e6c7cc8ebb86d9c467155afe82348faff43e", "url": "https://github.com/elastic/elasticsearch/commit/a213e6c7cc8ebb86d9c467155afe82348faff43e", "message": "extend restcreateindexaction", "committedDate": "2020-03-27T14:29:45Z", "type": "commit"}, {"oid": "f1ad6779f0eb699d3623e055cb932ec041abd39b", "url": "https://github.com/elastic/elasticsearch/commit/f1ad6779f0eb699d3623e055cb932ec041abd39b", "message": "code style and discovery nodes in indexaction", "committedDate": "2020-03-27T15:14:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2ODA1NQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r399968055", "body": "no longer need that logic. each handler is registered with a compatibleWith version. \r\nThe compatible API registers with Version.7\r\nthe current version register with Version.Current\r\nthis version is being used in handlers.getHandler to get the right handler", "bodyText": "no longer need that logic. each handler is registered with a compatibleWith version.\nThe compatible API registers with Version.7\nthe current version register with Version.Current\nthis version is being used in handlers.getHandler to get the right handler", "bodyHTML": "<p dir=\"auto\">no longer need that logic. each handler is registered with a compatibleWith version.<br>\nThe compatible API registers with Version.7<br>\nthe current version register with Version.Current<br>\nthis version is being used in handlers.getHandler to get the right handler</p>", "author": "pgomulka", "createdAt": "2020-03-30T07:06:07Z", "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -309,20 +315,14 @@ private void tryAllHandlers(final RestRequest request, final RestChannel channel\n                 if (handlers == null) {\n                     handler = null;\n                 } else {\n-                    handler = handlers.getHandler(requestMethod);\n+                    handler = handlers.getHandler(requestMethod, compatibleWithVersion);\n                 }\n                 if (handler == null) {\n                   if (handleNoHandlerFound(rawPath, requestMethod, uri, channel)) {\n                       return;\n                   }\n                 } else {\n-                    if(handler.compatibilityRequired() == false //regular (not removed) handlers are always dispatched", "originalCommit": "f1ad6779f0eb699d3623e055cb932ec041abd39b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "url": "https://github.com/elastic/elasticsearch/commit/8ff3463f7558256da4aba434f14ba8446e1ebce8", "message": "fix double registration", "committedDate": "2020-03-30T08:03:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401977850", "body": "may want to explicitly reject if there are more then 1 mapping... or will the underlying code blow up in a meaningful way ?", "bodyText": "may want to explicitly reject if there are more then 1 mapping... or will the underlying code blow up in a meaningful way ?", "bodyHTML": "<p dir=\"auto\">may want to explicitly reject if there are more then 1 mapping... or will the underlying code blow up in a meaningful way ?</p>", "author": "jakelandis", "createdAt": "2020-04-01T23:59:33Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n+        final boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER, DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Object> mappings = (Map<String, Object>) source.get(\"mappings\");", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExMTY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402111689", "bodyText": "good question.. I forgot that we could have multiple types. When was this deprecated? Do we expect multiple types in mappings in 7.x?\nfrom what I see in Internal CreateIndexRequest holds a single mapping (#48996) Alan Woodward* 18/11/2019, 11:52 it is aimed at 8. so we should expect multiple types in 7.0-7.x?", "author": "pgomulka", "createdAt": "2020-04-02T07:41:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI0ODQ2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402248463", "bodyText": "I confirmed this with @colings86 that multiple types were deprecated in 6.x and were not expected anymore.\nif it contains two types it will get into else branch here https://github.com/elastic/elasticsearch/pull/54197/files#diff-9327cfc566910ab3fec1c4b23a87a71bR90\nfor v8 logic. It does not expect two types either, and in fact will consider this mapping not typed\nMapperService.java\npublic static boolean isMappingSourceTyped(String type, Map<String, Object> mapping) {\n        return mapping.size() == 1 && mapping.keySet().iterator().next().equals(type);\n    }\n\nthe request with two types in a mapping will  eventually end up with\n     \"type\": \"mapper_parsing_exception\",\n        \"reason\": \"Root mapping definition has unsupported parameters:  [some_type_2 : {properties={field1={type=text}}}] [some_type_1 : {properties={field1={type=text}}}]\"\n      }\n\nShould we improve this or is this good enough?", "author": "pgomulka", "createdAt": "2020-04-02T11:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3ODcwMA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402478700", "bodyText": "thanks for following up. I think that error is good enough.", "author": "jakelandis", "createdAt": "2020-04-02T17:18:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3ODkyOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401978929", "body": "The internal representation still requires the _doc right ?  can you make a comment here to that effect ?", "bodyText": "The internal representation still requires the _doc right ?  can you make a comment here to that effect ?", "bodyHTML": "<p dir=\"auto\">The internal representation still requires the _doc right ?  can you make a comment here to that effect ?</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:03:09Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n+        final boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER, DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Object> mappings = (Map<String, Object>) source.get(\"mappings\");\n+\n+        if (includeTypeName && mappings.size() == 1) {\n+            // no matter what the type was, replace it with _doc\n+            Map<String, Object> newSource = new HashMap<>();\n+\n+            String typeName = mappings.keySet().iterator().next();\n+            @SuppressWarnings(\"unchecked\")\n+            Map<String, Object> typedMappings = (Map<String, Object>) mappings.get(typeName);\n+\n+            newSource.put(\"mappings\", Collections.singletonMap(MapperService.SINGLE_MAPPING_NAME, typedMappings));", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3OTU4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401979583", "body": "Can you add some unit tests for this ?", "bodyText": "Can you add some unit tests for this ?", "bodyHTML": "<p dir=\"auto\">Can you add some unit tests for this ?</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:05:17Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MDY0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401980649", "body": "why not String.valueOf or Integer.toString ?", "bodyText": "why not String.valueOf or Integer.toString ?", "bodyHTML": "<p dir=\"auto\">why not String.valueOf or Integer.toString ?</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:08:49Z", "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){\n+        return \"\"+ Version.CURRENT.major;", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwNzk5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402107991", "bodyText": "this was just a dirty hack, should be as you mentioned in other comments Version.Current", "author": "pgomulka", "createdAt": "2020-04-02T07:34:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MDY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401981739", "body": "If possible, we should avoid using `String` types in contracts (unless they really are just simple strings). Here we are using a `String` to represent a `Version`, can we just pass around a `Version` object ? \r\n\r\nI think Version.7_0_0 is sufficient to pass around to mean \"7\" and having a proper `Version` object here allows for smarter comparisons and fewer conversions.  (and Version.CURRENT to represent current).  Then on usage, pull the major version out as close to where it is used as possible, but pass around proper Version objects. ", "bodyText": "If possible, we should avoid using String types in contracts (unless they really are just simple strings). Here we are using a String to represent a Version, can we just pass around a Version object ?\nI think Version.7_0_0 is sufficient to pass around to mean \"7\" and having a proper Version object here allows for smarter comparisons and fewer conversions.  (and Version.CURRENT to represent current).  Then on usage, pull the major version out as close to where it is used as possible, but pass around proper Version objects.", "bodyHTML": "<p dir=\"auto\">If possible, we should avoid using <code>String</code> types in contracts (unless they really are just simple strings). Here we are using a <code>String</code> to represent a <code>Version</code>, can we just pass around a <code>Version</code> object ?</p>\n<p dir=\"auto\">I think Version.7_0_0 is sufficient to pass around to mean \"7\" and having a proper <code>Version</code> object here allows for smarter comparisons and fewer conversions.  (and Version.CURRENT to represent current).  Then on usage, pull the major version out as close to where it is used as possible, but pass around proper Version objects.</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:12:25Z", "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzMjY5MA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402132690", "bodyText": "I can change it all to use Version, but the only places where a byte or a string are used would be XContentBuilder or params.\nSee AbstractRestChannel", "author": "pgomulka", "createdAt": "2020-04-02T08:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNDAzMg==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402134032", "bodyText": "I can possibly avoid using params() and add an additional property on RestRequest that would keep a Version.\nWhat do you think?", "author": "pgomulka", "createdAt": "2020-04-02T08:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4MzUwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402483509", "bodyText": "Adding to RestRequest would be in addition to params right ? Since params is still needed for XContent parsers ?\nIf so, I worry abit about having this info in two places, especially if the are set at different times. If we can ensure that they are set at the same time, and early enough on the RestRequest where it couldn't be read by something and then set. I am good with introducing in two places since I think it reads easier.", "author": "jakelandis", "createdAt": "2020-04-02T17:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4NjEzNA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402886134", "bodyText": "At the moment there is no usecase that requires params. XcontenBuilder has a version set in AbstractRestChannel where RestRequest is available\n        builder.setCompatibleMajorVersion(request.getCompatibleApiVersion().major);\n\nXContentParser - not currently used for compatible api, but will be for search_type https://github.com/pgomulka/elasticsearch/pull/17/files#diff-4ca0a565076688b0f2d8206a8aae8d2d , https://github.com/pgomulka/elasticsearch/pull/17/files#diff-8a62025dd40acfdd5de52b62bdb190f2R484\nIt is being created in RestRequest, where an information about Version is stored", "author": "pgomulka", "createdAt": "2020-04-03T09:43:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MzU5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401983591", "body": "I think this variable can be removed. i think it is only used once. \r\n\r\n", "bodyText": "I think this variable can be removed. i think it is only used once.", "bodyHTML": "<p dir=\"auto\">I think this variable can be removed. i think it is only used once.</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:18:49Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MzY3Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401983673", "body": "This note can be removed. ", "bodyText": "This note can be removed.", "bodyHTML": "<p dir=\"auto\">This note can be removed.</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:19:03Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NDA2OA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401984068", "body": "+1 (lets use the the Version object here)", "bodyText": "+1 (lets use the the Version object here)", "bodyHTML": "<p dir=\"auto\">+1 (lets use the the Version object here)</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:20:31Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,36 +32,40 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    //TODO maybe we should aim for having a type for version instead of string/byte", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NTg2Mw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401985863", "body": "May want to remove \"responses\" since this API does not include the mappings in the response. ", "bodyText": "May want to remove \"responses\" since this API does not include the mappings in the response.", "bodyHTML": "<p dir=\"auto\">May want to remove \"responses\" since this API does not include the mappings in the response.</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:26:58Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NjE1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401986151", "body": "the comment is a bit confusing .. it says it not replaced with _doc .. but it actually is for the internal representation right ? suggest to just remove the comment. ", "bodyText": "the comment is a bit confusing .. it says it not replaced with _doc .. but it actually is for the internal representation right ? suggest to just remove the comment.", "bodyHTML": "<p dir=\"auto\">the comment is a bit confusing .. it says it not replaced with _doc .. but it actually is for the internal representation right ? suggest to just remove the comment.</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:27:54Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwNjk0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402106942", "bodyText": "it is incorrect. It should say  it is always replaced with _doc", "author": "pgomulka", "createdAt": "2020-04-02T07:32:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NjE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjYzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401992631", "body": "is this part of your changes ... or just showing up in the diff ?", "bodyText": "is this part of your changes ... or just showing up in the diff ?", "bodyHTML": "<p dir=\"auto\">is this part of your changes ... or just showing up in the diff ?</p>", "author": "jakelandis", "createdAt": "2020-04-02T00:51:39Z", "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "diffHunk": "@@ -701,7 +701,7 @@ public void initRestHandlers(Supplier<DiscoveryNodes> nodesInCluster) {\n \n         registerHandler.accept(new RestIndexAction());\n         registerHandler.accept(new CreateHandler());\n-        registerHandler.accept(new AutoIdHandler(clusterService));\n+        registerHandler.accept(new AutoIdHandler(nodesInCluster));", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyMDg1OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402120859", "bodyText": "compat_rest_api was updated to master where it was (accidentally I suspect) reverted back to use clusterService when nodes in cluster is only needed 8264bdd\nI suspect this will be back to nodesInCluster in master soon", "author": "pgomulka", "createdAt": "2020-04-02T07:57:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NTU0Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401995547", "body": "nit: this can be simplified to ` methodHandlers.computeIfAbsent(method, k -> new HashMap<>()).put(version, handler);` (mostly a cosmetic change though...)", "bodyText": "nit: this can be simplified to  methodHandlers.computeIfAbsent(method, k -> new HashMap<>()).put(version, handler); (mostly a cosmetic change though...)", "bodyHTML": "<p dir=\"auto\">nit: this can be simplified to <code> methodHandlers.computeIfAbsent(method, k -&gt; new HashMap&lt;&gt;()).put(version, handler);</code> (mostly a cosmetic change though...)</p>", "author": "jakelandis", "createdAt": "2020-04-02T01:02:26Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,36 +32,40 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    //TODO maybe we should aim for having a type for version instead of string/byte\n+    private final Map<RestRequest.Method, Map<String,RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, String version, RestRequest.Method... methods) {\n         this.path = path;\n         this.methodHandlers = new HashMap<>(methods.length);\n         for (RestRequest.Method method : methods) {\n-            methodHandlers.put(method, handler);\n+            methodHandlers.putIfAbsent(method, new HashMap<>());\n+            methodHandlers.get(method).put(version, handler);", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExODA2Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402118062", "bodyText": "good idea!", "author": "pgomulka", "createdAt": "2020-04-02T07:52:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NTU0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NjEzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401996131", "body": "nit: this can be simplified to `  RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>()).put(version, handler);`", "bodyText": "nit: this can be simplified to   RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>()).put(version, handler);", "bodyHTML": "<p dir=\"auto\">nit: this can be simplified to <code>  RestHandler existing = methodHandlers.computeIfAbsent(method, k -&gt; new HashMap&lt;&gt;()).put(version, handler);</code></p>", "author": "jakelandis", "createdAt": "2020-04-02T01:04:37Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,36 +32,40 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    //TODO maybe we should aim for having a type for version instead of string/byte\n+    private final Map<RestRequest.Method, Map<String,RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, String version, RestRequest.Method... methods) {\n         this.path = path;\n         this.methodHandlers = new HashMap<>(methods.length);\n         for (RestRequest.Method method : methods) {\n-            methodHandlers.put(method, handler);\n+            methodHandlers.putIfAbsent(method, new HashMap<>());\n+            methodHandlers.get(method).put(version, handler);\n         }\n     }\n \n     /**\n      * Add a handler for an additional array of methods. Note that {@code MethodHandlers}\n      * does not allow replacing the handler for an already existing method.\n      */\n-    MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers addMethods(RestHandler handler, String version, RestRequest.Method... methods) {\n         for (RestRequest.Method method : methods) {\n-            RestHandler existing = methodHandlers.putIfAbsent(method, handler);\n+            methodHandlers.putIfAbsent(method, new HashMap<>());\n+            RestHandler existing = methodHandlers.get(method).put(version, handler);", "originalCommit": "8ff3463f7558256da4aba434f14ba8446e1ebce8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1ee448754484179e05ab14815bbaa21ba02dca0a", "url": "https://github.com/elastic/elasticsearch/commit/1ee448754484179e05ab14815bbaa21ba02dca0a", "message": "additional testing and using version", "committedDate": "2020-04-02T12:07:12Z", "type": "commit"}, {"oid": "abe1d2864ad79f409f01f301255af6f4ca7f51c6", "url": "https://github.com/elastic/elasticsearch/commit/abe1d2864ad79f409f01f301255af6f4ca7f51c6", "message": "unused method", "committedDate": "2020-04-02T12:08:45Z", "type": "commit"}, {"oid": "d8fc2e554bcdd809d471fbb2543bdfe9c6ae423f", "url": "https://github.com/elastic/elasticsearch/commit/d8fc2e554bcdd809d471fbb2543bdfe9c6ae423f", "message": "method handlers - returning null when no handler under a method was registered", "committedDate": "2020-04-02T13:16:15Z", "type": "commit"}, {"oid": "ec8df43b08348e8edf9556a3cb3844aee18b69cc", "url": "https://github.com/elastic/elasticsearch/commit/ec8df43b08348e8edf9556a3cb3844aee18b69cc", "message": "remove unused constant", "committedDate": "2020-04-03T11:25:47Z", "type": "commit"}, {"oid": "8602f6566dd0dc366358cf84bfd26f5bb508ecea", "url": "https://github.com/elastic/elasticsearch/commit/8602f6566dd0dc366358cf84bfd26f5bb508ecea", "message": "Merge branch 'compat_rest_api' into compat/create_index_include_type", "committedDate": "2020-04-20T09:17:28Z", "type": "commit"}, {"oid": "f3d25e0e8667ab937889205a9006967e161b270a", "url": "https://github.com/elastic/elasticsearch/commit/f3d25e0e8667ab937889205a9006967e161b270a", "message": "fix javadoc", "committedDate": "2020-04-20T09:45:47Z", "type": "commit"}, {"oid": "7024913f90f98f9aae7284b406c901545032f0b2", "url": "https://github.com/elastic/elasticsearch/commit/7024913f90f98f9aae7284b406c901545032f0b2", "message": "compile", "committedDate": "2020-04-20T11:45:19Z", "type": "commit"}, {"oid": "f52dbc1de09ac72c4cb6ca3c5f69e10bcc6ff24c", "url": "https://github.com/elastic/elasticsearch/commit/f52dbc1de09ac72c4cb6ca3c5f69e10bcc6ff24c", "message": "spotless", "committedDate": "2020-04-20T13:56:59Z", "type": "commit"}, {"oid": "0b07539562a5cfc9e8cc128bea316d3a249974bf", "url": "https://github.com/elastic/elasticsearch/commit/0b07539562a5cfc9e8cc128bea316d3a249974bf", "message": "Merge branch 'compat_rest_api' into compat/create_index_include_type", "committedDate": "2020-04-21T11:38:15Z", "type": "commit"}, {"oid": "813579444254bced0082b7994642124ee27b4cc1", "url": "https://github.com/elastic/elasticsearch/commit/813579444254bced0082b7994642124ee27b4cc1", "message": "v7 name", "committedDate": "2020-04-22T09:22:28Z", "type": "commit"}, {"oid": "f8193132a056cb9ebdf0b587f52a6096fa2d5967", "url": "https://github.com/elastic/elasticsearch/commit/f8193132a056cb9ebdf0b587f52a6096fa2d5967", "message": "fix test", "committedDate": "2020-04-22T13:35:36Z", "type": "commit"}, {"oid": "6e28d245c7e79681c5a092f45db50188e6d33e6d", "url": "https://github.com/elastic/elasticsearch/commit/6e28d245c7e79681c5a092f45db50188e6d33e6d", "message": "javadoc", "committedDate": "2020-04-22T14:34:10Z", "type": "commit"}, {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65", "url": "https://github.com/elastic/elasticsearch/commit/a77716e7a19bccff0c07e64c651b706133f23e65", "message": "Merge branch 'compat_rest_api' into compat/create_index_include_type", "committedDate": "2020-04-23T16:11:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MDQxNQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414950415", "body": "This is more of a nit but since the class itself already has `V7` in the name, maybe it is redundant to have `V7` in the method names as well?\r\n\r\n```suggestion\r\n    CreateIndexRequest prepareRequest(RestRequest request) {\r\n```", "bodyText": "This is more of a nit but since the class itself already has V7 in the name, maybe it is redundant to have V7 in the method names as well?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CreateIndexRequest prepareV7Request(RestRequest request) {\n          \n          \n            \n                CreateIndexRequest prepareRequest(RestRequest request) {", "bodyHTML": "<p dir=\"auto\">This is more of a nit but since the class itself already has <code>V7</code> in the name, maybe it is redundant to have <code>V7</code> in the method names as well?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-smi\">CreateIndexRequest</span> <span class=\"x x-first x-last\">prepareV7Request</span>(<span class=\"pl-smi\">RestRequest</span> request) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-smi\">CreateIndexRequest</span> <span class=\"x x-first x-last\">prepareRequest</span>(<span class=\"pl-smi\">RestRequest</span> request) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jaymode", "createdAt": "2020-04-25T01:53:25Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+\n+    @Override\n+    public String getName() {\n+        return \"create_index_action_v7\";\n+    }\n+\n+    @Override\n+    public Version compatibleWithVersion() {\n+        return Version.V_7_0_0;\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = prepareV7Request(request);\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    // default scope for testing\n+    CreateIndexRequest prepareV7Request(RestRequest request) {", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MDQ5OA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414950498", "body": "```suggestion\r\n    static Map<String, Object> prepareMappings(Map<String, Object> source, RestRequest request) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n          \n          \n            \n                static Map<String, Object> prepareMappings(Map<String, Object> source, RestRequest request) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">static</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span> <span class=\"x x-first x-last\">prepareMappingsV7</span>(<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span> source, <span class=\"pl-smi\">RestRequest</span> request) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">static</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span> <span class=\"x x-first x-last\">prepareMappings</span>(<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span> source, <span class=\"pl-smi\">RestRequest</span> request) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jaymode", "createdAt": "2020-04-25T01:53:48Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+\n+    @Override\n+    public String getName() {\n+        return \"create_index_action_v7\";\n+    }\n+\n+    @Override\n+    public Version compatibleWithVersion() {\n+        return Version.V_7_0_0;\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = prepareV7Request(request);\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    // default scope for testing\n+    CreateIndexRequest prepareV7Request(RestRequest request) {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is always replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return createIndexRequest;\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTMyNg==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414951326", "body": "This is a different way of doing things, but I'd much rather keep the assertion out of the individual rest handlers and add logic to the RestController for throwing an exception if a handler is registered with an incompatible version. So when the version is bumped to 9 that we would throw for any handler registered with a compatible version of 7. What do you think?", "bodyText": "This is a different way of doing things, but I'd much rather keep the assertion out of the individual rest handlers and add logic to the RestController for throwing an exception if a handler is registered with an incompatible version. So when the version is bumped to 9 that we would throw for any handler registered with a compatible version of 7. What do you think?", "bodyHTML": "<p dir=\"auto\">This is a different way of doing things, but I'd much rather keep the assertion out of the individual rest handlers and add logic to the RestController for throwing an exception if a handler is registered with an incompatible version. So when the version is bumped to 9 that we would throw for any handler registered with a compatible version of 7. What do you think?</p>", "author": "jaymode", "createdAt": "2020-04-25T01:58:29Z", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestIndexActionV7.java", "diffHunk": "@@ -55,7 +53,7 @@ public String getName() {\n \n         @Override\n         public List<Route> routes() {\n-            assert Version.CURRENT.major == 8 : \"REST API compatilbity for version 7 is only supported on version 8\";\n+            assert Version.CURRENT.major == 8 : \"REST API compatibility for version 7 is only supported on version 8\";", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU1MTA4MA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r415551080", "bodyText": "good idea, this will reduce duplication too", "author": "pgomulka", "createdAt": "2020-04-27T06:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTMyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTQyNA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414951424", "body": "nit:\r\n\r\n```suggestion\r\n```", "bodyText": "nit:\n  \n    \n      \n        Suggested change", "bodyHTML": "<p dir=\"auto\">nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jaymode", "createdAt": "2020-04-25T01:59:10Z", "path": "modules/rest-compatibility/src/test/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7Tests.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.common.bytes.BytesArray;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.test.rest.FakeRestRequest;\n+import org.elasticsearch.test.rest.RestActionTestCase;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class RestCreateIndexActionV7Tests extends RestActionTestCase {\n+\n+    String mimeType = \"application/vnd.elasticsearch+json;compatible-with=7\";\n+    List<String> contentTypeHeader = Collections.singletonList(mimeType);\n+\n+    RestCreateIndexActionV7 restHandler = new RestCreateIndexActionV7();\n+\n+    @Before\n+    public void setUpAction() {\n+        controller().registerHandler(restHandler);\n+", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTcxMw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414951713", "body": "nit:\r\n```suggestion\r\n    private final Map<RestRequest.Method, Map<Version, RestHandler>> methodHandlers;\r\n```", "bodyText": "nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final Map<RestRequest.Method, Map<Version,RestHandler>> methodHandlers;\n          \n          \n            \n                private final Map<RestRequest.Method, Map<Version, RestHandler>> methodHandlers;", "bodyHTML": "<p dir=\"auto\">nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">RestRequest</span>.</span><span class=\"pl-smi\">Method</span>, <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">Version</span>,<span class=\"pl-smi\">RestHandler</span>&gt;</span><span class=\"pl-k\">&gt;</span> methodHandlers;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">RestRequest</span>.</span><span class=\"pl-smi\">Method</span>, <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">Version</span>,<span class=\"x x-first x-last\"> </span><span class=\"pl-smi\">RestHandler</span>&gt;</span><span class=\"pl-k\">&gt;</span> methodHandlers;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jaymode", "createdAt": "2020-04-25T02:00:57Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,23 +32,25 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    private final Map<RestRequest.Method, Map<Version,RestHandler>> methodHandlers;", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1OTA0Mg==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414959042", "body": "In order to preserve the contract that existed previously, this should be:\r\n\r\n```suggestion\r\n            RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\r\n                .putIfAbsent(version, handler);\r\n```", "bodyText": "In order to preserve the contract that existed previously, this should be:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n          \n          \n            \n                            .put(version, handler);\n          \n          \n            \n                        RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n          \n          \n            \n                            .putIfAbsent(version, handler);", "bodyHTML": "<p dir=\"auto\">In order to preserve the contract that existed previously, this should be:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">RestHandler</span> existing <span class=\"pl-k\">=</span> methodHandlers<span class=\"pl-k\">.</span>computeIfAbsent(method, k <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashMap&lt;&gt;</span>())</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                .<span class=\"x x-first x-last\">put</span>(version, handler);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">RestHandler</span> existing <span class=\"pl-k\">=</span> methodHandlers<span class=\"pl-k\">.</span>computeIfAbsent(method, k <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashMap&lt;&gt;</span>())</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                .<span class=\"x x-first x-last\">putIfAbsent</span>(version, handler);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jaymode", "createdAt": "2020-04-25T02:44:33Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,23 +32,25 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    private final Map<RestRequest.Method, Map<Version,RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, Version version, RestRequest.Method... methods) {\n         this.path = path;\n         this.methodHandlers = new HashMap<>(methods.length);\n         for (RestRequest.Method method : methods) {\n-            methodHandlers.put(method, handler);\n+            methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n+                .put(version, handler);\n         }\n     }\n \n     /**\n      * Add a handler for an additional array of methods. Note that {@code MethodHandlers}\n      * does not allow replacing the handler for an already existing method.\n      */\n-    MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers addMethods(RestHandler handler, Version version, RestRequest.Method... methods) {\n         for (RestRequest.Method method : methods) {\n-            RestHandler existing = methodHandlers.putIfAbsent(method, handler);\n+            RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n+                .put(version, handler);", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1OTE3Nw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414959177", "body": "```suggestion\r\n        if (versionToHandlers == null) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(versionToHandlers == null){\n          \n          \n            \n                    if (versionToHandlers == null) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span>(versionToHandlers <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span>){</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span><span class=\"x x-first x-last\"> </span>(versionToHandlers <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span>)<span class=\"x x-first x-last\"> </span>{</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jaymode", "createdAt": "2020-04-25T02:45:30Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +59,29 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Return a handler for a given method and a version\n+     * If a handler for a given version is not found, the handler for Version.CURRENT is returned.\n+     * We only expect Version.CURRENT or Version.CURRENT -1. This is validated.\n+     *\n+     * Handlers can be registered under the same path and method, but will require to have different versions (CURRENT or CURRENT-1)\n+     *\n+     * //todo What if a handler was added in V8 but was not present in V7?\n+     *\n+     * @param method a REST method under which a handler was registered\n+     * @param version a Version under which a handler was registered\n+     * @return a handler\n      */\n     @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+\n+        if(versionToHandlers == null){", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1OTQ1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414959451", "body": "IMO if you request V7 compatibility mode but the API doesn't exist in V7 then this should be a bad request (HTTP 400)", "bodyText": "IMO if you request V7 compatibility mode but the API doesn't exist in V7 then this should be a bad request (HTTP 400)", "bodyHTML": "<p dir=\"auto\">IMO if you request V7 compatibility mode but the API doesn't exist in V7 then this should be a bad request (HTTP 400)</p>", "author": "jaymode", "createdAt": "2020-04-25T02:47:07Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +59,29 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Return a handler for a given method and a version\n+     * If a handler for a given version is not found, the handler for Version.CURRENT is returned.\n+     * We only expect Version.CURRENT or Version.CURRENT -1. This is validated.\n+     *\n+     * Handlers can be registered under the same path and method, but will require to have different versions (CURRENT or CURRENT-1)\n+     *\n+     * //todo What if a handler was added in V8 but was not present in V7?", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDE0MQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414960141", "body": "Is it ever valid for an entry in the map to have a null handler? I would think not so this could be simplified to:\r\n\r\n```\r\nfinal RestHandler handler = versionToHandlers.get(version);\r\nreturn handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);\r\n```", "bodyText": "Is it ever valid for an entry in the map to have a null handler? I would think not so this could be simplified to:\nfinal RestHandler handler = versionToHandlers.get(version);\nreturn handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);", "bodyHTML": "<p dir=\"auto\">Is it ever valid for an entry in the map to have a null handler? I would think not so this could be simplified to:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"final RestHandler handler = versionToHandlers.get(version);\nreturn handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);\"><pre><code>final RestHandler handler = versionToHandlers.get(version);\nreturn handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);\n</code></pre></div>", "author": "jaymode", "createdAt": "2020-04-25T02:51:32Z", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +59,29 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Return a handler for a given method and a version\n+     * If a handler for a given version is not found, the handler for Version.CURRENT is returned.\n+     * We only expect Version.CURRENT or Version.CURRENT -1. This is validated.\n+     *\n+     * Handlers can be registered under the same path and method, but will require to have different versions (CURRENT or CURRENT-1)\n+     *\n+     * //todo What if a handler was added in V8 but was not present in V7?\n+     *\n+     * @param method a REST method under which a handler was registered\n+     * @param version a Version under which a handler was registered\n+     * @return a handler\n      */\n     @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+\n+        if(versionToHandlers == null){\n+            return null;\n+        }\n+        if (versionToHandlers.containsKey(version)) {", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4ODA5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r415588099", "bodyText": "agree - I don't expect null values in versionToHandlers map. Will apply the suggestion", "author": "pgomulka", "createdAt": "2020-04-27T07:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDI1MA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414960250", "body": "can you add javadocs?", "bodyText": "can you add javadocs?", "bodyHTML": "<p dir=\"auto\">can you add javadocs?</p>", "author": "jaymode", "createdAt": "2020-04-25T02:52:25Z", "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default Version compatibleWithVersion(){", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDY3MA==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414960670", "body": "This is a nit but I prefer to keep final variables grouped together and non-final member variables grouped together. This means that these two variables should be moved under `httpChannel` and followed by an empty line, which would separate them from `httpRequest` and `contentConsumed`", "bodyText": "This is a nit but I prefer to keep final variables grouped together and non-final member variables grouped together. This means that these two variables should be moved under httpChannel and followed by an empty line, which would separate them from httpRequest and contentConsumed", "bodyHTML": "<p dir=\"auto\">This is a nit but I prefer to keep final variables grouped together and non-final member variables grouped together. This means that these two variables should be moved under <code>httpChannel</code> and followed by an empty line, which would separate them from <code>httpRequest</code> and <code>contentConsumed</code></p>", "author": "jaymode", "createdAt": "2020-04-25T02:55:22Z", "path": "server/src/main/java/org/elasticsearch/rest/RestRequest.java", "diffHunk": "@@ -74,8 +74,8 @@\n     private HttpRequest httpRequest;\n \n     private boolean contentConsumed = false;\n-\n     private final long requestId;\n+    private final Version compatibleApiVersion;", "originalCommit": "a77716e7a19bccff0c07e64c651b706133f23e65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU5MzYyNw==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r415593627", "bodyText": "agree, I like that arrangement too", "author": "pgomulka", "createdAt": "2020-04-27T07:57:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDY3MA=="}], "type": "inlineReview"}, {"oid": "094a4627265480b5cd08826b87bce3fa9959fcc3", "url": "https://github.com/elastic/elasticsearch/commit/094a4627265480b5cd08826b87bce3fa9959fcc3", "message": "Apply suggestions from code review\n\nCo-Authored-By: Jay Modi <jaymode@users.noreply.github.com>", "committedDate": "2020-04-27T08:10:17Z", "type": "commit"}, {"oid": "f704d0cddd4ccdfc44e31132eaa42f508de139a7", "url": "https://github.com/elastic/elasticsearch/commit/f704d0cddd4ccdfc44e31132eaa42f508de139a7", "message": "merge", "committedDate": "2020-04-27T08:20:59Z", "type": "commit"}, {"oid": "18651ae3fbdbad9d21396831d8a3ef8f8bff6aa3", "url": "https://github.com/elastic/elasticsearch/commit/18651ae3fbdbad9d21396831d8a3ef8f8bff6aa3", "message": "compile fix", "committedDate": "2020-04-27T09:31:05Z", "type": "commit"}, {"oid": "0e1c917100acf757a1fcacb81b6fac14d71a529e", "url": "https://github.com/elastic/elasticsearch/commit/0e1c917100acf757a1fcacb81b6fac14d71a529e", "message": "assertion on version and test", "committedDate": "2020-04-27T11:22:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEzNDEwMg==", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r416134102", "body": "```suggestion\r\n            : \"REST API compatibility is only supported for version \" + Version.minimumRestCompatibilityVersion().major;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        : \"REST API compatibility is only supported for version \"+Version.minimumRestCompatibilityVersion().major;\n          \n          \n            \n                        : \"REST API compatibility is only supported for version \" + Version.minimumRestCompatibilityVersion().major;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">:</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>REST API compatibility is only supported for version <span class=\"pl-pds\">\"</span></span><span class=\"pl-k x x-first x-last\">+</span><span class=\"pl-smi\">Version</span><span class=\"pl-k\">.</span>minimumRestCompatibilityVersion()<span class=\"pl-k\">.</span>major;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">:</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>REST API compatibility is only supported for version <span class=\"pl-pds\">\"</span></span><span class=\"x x-first\"> </span><span class=\"pl-k x\">+</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">Version</span><span class=\"pl-k\">.</span>minimumRestCompatibilityVersion()<span class=\"pl-k\">.</span>major;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jaymode", "createdAt": "2020-04-27T20:42:55Z", "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -145,6 +145,10 @@ protected void registerWithDeprecatedHandler(RestRequest.Method method, String p\n      * @param method GET, POST, etc.\n      */\n     protected void registerHandler(RestRequest.Method method, String path, RestHandler handler) {\n+        assert Version.minimumRestCompatibilityVersion() == handler.compatibleWithVersion() ||\n+            Version.CURRENT == handler.compatibleWithVersion()\n+            : \"REST API compatibility is only supported for version \"+Version.minimumRestCompatibilityVersion().major;", "originalCommit": "0e1c917100acf757a1fcacb81b6fac14d71a529e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "93bebbf19df4582cfa257c91d9229d42089513bf", "url": "https://github.com/elastic/elasticsearch/commit/93bebbf19df4582cfa257c91d9229d42089513bf", "message": "Update server/src/main/java/org/elasticsearch/rest/RestController.java\n\nCo-Authored-By: Jay Modi <jaymode@users.noreply.github.com>", "committedDate": "2020-04-28T07:04:36Z", "type": "commit"}, {"oid": "281ec7f448e0d546ee2c8ca747a4e974881e81d2", "url": "https://github.com/elastic/elasticsearch/commit/281ec7f448e0d546ee2c8ca747a4e974881e81d2", "message": "Merge branch 'compat_rest_api' into compat/create_index_include_type", "committedDate": "2020-04-28T07:11:33Z", "type": "commit"}, {"oid": "4ee93aec2d9bb5d694e08e4475ba6844356f496f", "url": "https://github.com/elastic/elasticsearch/commit/4ee93aec2d9bb5d694e08e4475ba6844356f496f", "message": "fix method not found test", "committedDate": "2020-04-28T07:47:42Z", "type": "commit"}, {"oid": "594b02f76c0fd4f50deca6fd90a581755f565258", "url": "https://github.com/elastic/elasticsearch/commit/594b02f76c0fd4f50deca6fd90a581755f565258", "message": "Merge branch 'compat/create_index_include_type' of github.com:pgomulka/elasticsearch into compat/create_index_include_type", "committedDate": "2020-04-28T07:55:54Z", "type": "commit"}]}