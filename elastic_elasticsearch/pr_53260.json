{"pr_number": 53260, "pr_title": "Use given executor for global checkpoint listener", "pr_author": "jasontedor", "pr_createdAt": "2020-03-07T18:53:56Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53260", "timeline": [{"oid": "e086753926e4940cb4d165412230073187015de1", "url": "https://github.com/elastic/elasticsearch/commit/e086753926e4940cb4d165412230073187015de1", "message": "Use given executor for global checkpoint listener\n\nToday when notifying a global checkpoint listener, we use the listener\nthread pool. This commit turns this inside out so that the global\ncheckpoint listener must provide an executor on which to notify the\nlistener.", "committedDate": "2020-03-07T18:51:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDgxMA==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389340810", "body": "It seems this default is only used in tests (and the interface is only implemented once anyways), should we maybe just extract some utility method into tests to build these listeners?\r\n\r\nE.g.\r\n\r\n```java\r\n    public static GlobalCheckpointListeners.GlobalCheckpointListener syncListener(BiConsumer<Long, Exception> consumer) {\r\n        return new GlobalCheckpointListeners.GlobalCheckpointListener() {\r\n            @Override\r\n            public Executor executor() {\r\n                return Runnable::run;\r\n            }\r\n\r\n            @Override\r\n            public void accept(long globalCheckpoint, Exception e) {\r\n                consumer.accept(globalCheckpoint, e);\r\n            }\r\n        };\r\n    }\r\n```\r\n\r\nIt seems a little strange to mark this as a `@FunctionalInterface` when it really only is one in tests?", "bodyText": "It seems this default is only used in tests (and the interface is only implemented once anyways), should we maybe just extract some utility method into tests to build these listeners?\nE.g.\n    public static GlobalCheckpointListeners.GlobalCheckpointListener syncListener(BiConsumer<Long, Exception> consumer) {\n        return new GlobalCheckpointListeners.GlobalCheckpointListener() {\n            @Override\n            public Executor executor() {\n                return Runnable::run;\n            }\n\n            @Override\n            public void accept(long globalCheckpoint, Exception e) {\n                consumer.accept(globalCheckpoint, e);\n            }\n        };\n    }\nIt seems a little strange to mark this as a @FunctionalInterface when it really only is one in tests?", "bodyHTML": "<p dir=\"auto\">It seems this default is only used in tests (and the interface is only implemented once anyways), should we maybe just extract some utility method into tests to build these listeners?</p>\n<p dir=\"auto\">E.g.</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    public static GlobalCheckpointListeners.GlobalCheckpointListener syncListener(BiConsumer&lt;Long, Exception&gt; consumer) {\n        return new GlobalCheckpointListeners.GlobalCheckpointListener() {\n            @Override\n            public Executor executor() {\n                return Runnable::run;\n            }\n\n            @Override\n            public void accept(long globalCheckpoint, Exception e) {\n                consumer.accept(globalCheckpoint, e);\n            }\n        };\n    }\"><pre>    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">GlobalCheckpointListeners</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">GlobalCheckpointListener</span> syncListener(<span class=\"pl-k\">BiConsumer&lt;<span class=\"pl-smi\">Long</span>, <span class=\"pl-smi\">Exception</span>&gt;</span> consumer) {\n        <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">GlobalCheckpointListeners</span>.<span class=\"pl-smi\">GlobalCheckpointListener</span>() {\n            <span class=\"pl-k\">@Override</span>\n            <span class=\"pl-k\">public</span> <span class=\"pl-smi\">Executor</span> <span class=\"pl-en\">executor</span>() {\n                <span class=\"pl-k\">return</span> <span class=\"pl-smi\">Runnable</span><span class=\"pl-k\">::</span>run;\n            }\n\n            <span class=\"pl-k\">@Override</span>\n            <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"pl-en\">accept</span>(<span class=\"pl-k\">long</span> <span class=\"pl-v\">globalCheckpoint</span>, <span class=\"pl-smi\">Exception</span> <span class=\"pl-v\">e</span>) {\n                consumer<span class=\"pl-k\">.</span>accept(globalCheckpoint, e);\n            }\n        };\n    }</pre></div>\n<p dir=\"auto\">It seems a little strange to mark this as a <code>@FunctionalInterface</code> when it really only is one in tests?</p>", "author": "original-brownbear", "createdAt": "2020-03-08T06:43:49Z", "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -53,6 +53,16 @@\n      */\n     @FunctionalInterface\n     public interface GlobalCheckpointListener {\n+\n+        /**\n+         * The executor on which the listener is notified. Defaults to the calling thread.\n+         *\n+         * @return the executor\n+         */\n+        default Executor executor() {\n+            return Runnable::run;", "originalCommit": "e086753926e4940cb4d165412230073187015de1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDY4Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389370687", "bodyText": "I pushed b565820. I mistakenly combined your two suggestions into a single commit, sorry.", "author": "jasontedor", "createdAt": "2020-03-08T13:42:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDkyMg==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389340922", "body": "Maybe move the wrapping `listener.executor().execute(() ...` into `notifyListener` to dry things up? We only ever invoke `notifyListener` from `listener.executor().execute(() -> ...` anyway.", "bodyText": "Maybe move the wrapping listener.executor().execute(() ... into notifyListener to dry things up? We only ever invoke notifyListener from listener.executor().execute(() -> ... anyway.", "bodyHTML": "<p dir=\"auto\">Maybe move the wrapping <code>listener.executor().execute(() ...</code> into <code>notifyListener</code> to dry things up? We only ever invoke <code>notifyListener</code> from <code>listener.executor().execute(() -&gt; ...</code> anyway.</p>", "author": "original-brownbear", "createdAt": "2020-03-08T06:46:24Z", "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -214,16 +220,15 @@ private void notifyListeners(final long globalCheckpoint, final IndexShardClosed\n             listeners.clear();\n         }\n         if (listenersToNotify.isEmpty() == false) {\n-            executor.execute(() ->\n-                    listenersToNotify\n-                            .forEach((listener, t) -> {\n-                                /*\n-                                 * We do not want to interrupt any timeouts that fired, these will detect that the listener has been\n-                                 * notified and not trigger the timeout.\n-                                 */\n-                                FutureUtils.cancel(t.v2());\n-                                notifyListener(listener, globalCheckpoint, e);\n-                            }));\n+            listenersToNotify\n+                .forEach((listener, t) -> {\n+                    /*\n+                     * We do not want to interrupt any timeouts that fired, these will detect that the listener has been notified and not\n+                     * trigger the timeout.\n+                     */\n+                    FutureUtils.cancel(t.v2());\n+                    listener.executor().execute(() -> notifyListener(listener, globalCheckpoint, e));", "originalCommit": "e086753926e4940cb4d165412230073187015de1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDY5OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389370699", "bodyText": "I pushed b565820. I mistakenly combined your two suggestions into a single commit, sorry.", "author": "jasontedor", "createdAt": "2020-03-08T13:42:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDkyMg=="}], "type": "inlineReview"}, {"oid": "b565820a862107f74bfdd23a99158a820e1231f9", "url": "https://github.com/elastic/elasticsearch/commit/b565820a862107f74bfdd23a99158a820e1231f9", "message": "Remove functional interface", "committedDate": "2020-03-08T13:40:30Z", "type": "commit"}, {"oid": "0d37aeacbdd3b3a401a72522cc98271fc795b4c0", "url": "https://github.com/elastic/elasticsearch/commit/0d37aeacbdd3b3a401a72522cc98271fc795b4c0", "message": "Remove stale comment", "committedDate": "2020-03-08T13:43:11Z", "type": "commit"}, {"oid": "d4fbc83623a5cfe737dbfc88e679347b20c78f24", "url": "https://github.com/elastic/elasticsearch/commit/d4fbc83623a5cfe737dbfc88e679347b20c78f24", "message": "Fix compilation", "committedDate": "2020-03-08T14:07:35Z", "type": "commit"}]}