{"pr_number": 64922, "pr_title": "[Transform] make state handling more robust when stop is called while indexer shuts down", "pr_author": "hendrikmuhs", "pr_createdAt": "2020-11-11T13:20:02Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/64922", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzODYzMQ==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521438631", "body": "```suggestion\r\n                                onFinishResponse -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\r\n                                onFinishFailure -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n          \n          \n            \n                                            onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));\n          \n          \n            \n                                            onFinishResponse -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\n          \n          \n            \n                                            onFinishFailure -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                                onFinishResponse <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"x x-first\">() </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> {</span>afterFinishOrFailure<span class=\"x x-first x-last\">();}</span>),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                                onFinishFailure <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"x x-first\">() </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> {</span>afterFinishOrFailure<span class=\"x x-first x-last\">();}</span>)));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                                onFinishResponse <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>afterFinishOrFailure),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                                onFinishFailure <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>afterFinishOrFailure)));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "benwtrent", "createdAt": "2020-11-11T15:29:52Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -222,8 +222,8 @@ public synchronized boolean maybeTriggerAsyncJob(long now) {\n                             nextSearch();\n                         } else {\n                             onFinish(ActionListener.wrap(\n-                                onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {}),\n-                                onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {})));\n+                                onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n+                                onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzODkyMw==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521438923", "body": "```suggestion\r\n        doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"x x-first\">() </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> {</span>afterFinishOrFailure<span class=\"x x-first x-last\">();}</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>afterFinishOrFailure);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "benwtrent", "createdAt": "2020-11-11T15:30:15Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -396,18 +402,19 @@ protected void onStop() {\n     private void finishWithSearchFailure(Exception exc) {\n         stats.incrementSearchFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTEzMg==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439132", "body": "```suggestion\r\n        doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"x x-first\">() </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> {</span>afterFinishOrFailure<span class=\"x x-first x-last\">();}</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>afterFinishOrFailure);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "benwtrent", "createdAt": "2020-11-11T15:30:34Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -396,18 +402,19 @@ protected void onStop() {\n     private void finishWithSearchFailure(Exception exc) {\n         stats.incrementSearchFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n     }\n \n     private void finishWithIndexingFailure(Exception exc) {\n         stats.incrementIndexingFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTY4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439689", "body": "```suggestion\r\n                        r -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\r\n                        e -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    r -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n          \n          \n            \n                                    e -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));\n          \n          \n            \n                                    r -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\n          \n          \n            \n                                    e -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        r <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"x x-first\">() </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> {</span>afterFinishOrFailure<span class=\"x x-first x-last\">();}</span>),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        e <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"x x-first\">() </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> {</span>afterFinishOrFailure<span class=\"x x-first x-last\">();}</span>)));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        r <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>afterFinishOrFailure),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        e <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> doSaveState(finishAndSetState(), position<span class=\"pl-k\">.</span>get(), <span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>afterFinishOrFailure)));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "benwtrent", "createdAt": "2020-11-11T15:31:21Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -478,8 +485,8 @@ private void onSearchResponse(SearchResponse searchResponse) {\n                 stats.markEndProcessing();\n                 // execute finishing tasks\n                 onFinish(ActionListener.wrap(\n-                        r -> doSaveState(finishAndSetState(), position.get(), () -> {}),\n-                        e -> doSaveState(finishAndSetState(), position.get(), () -> {})));\n+                        r -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n+                        e -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTk5MQ==", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439991", "body": "```suggestion\r\n            doSaveState(finishAndSetState(), getPosition(), this::afterFinishOrFailure);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        doSaveState(finishAndSetState(), getPosition(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                        doSaveState(finishAndSetState(), getPosition(), this::afterFinishOrFailure);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            doSaveState(finishAndSetState(), getPosition(), <span class=\"x x-first\">() </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> {</span>afterFinishOrFailure<span class=\"x x-first x-last\">();}</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            doSaveState(finishAndSetState(), getPosition(), <span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>afterFinishOrFailure);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "benwtrent", "createdAt": "2020-11-11T15:31:44Z", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -610,7 +617,7 @@ private boolean checkState(IndexerState currentState) {\n \n         case STOPPING:\n             logger.info(\"Indexer job encountered [\" + IndexerState.STOPPING + \"] state, halting indexer.\");\n-            doSaveState(finishAndSetState(), getPosition(), () -> {});\n+            doSaveState(finishAndSetState(), getPosition(), () -> {afterFinishOrFailure();});", "originalCommit": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ade15afaa9c4393cacfcfc59ba6663e6ed58604f", "url": "https://github.com/elastic/elasticsearch/commit/ade15afaa9c4393cacfcfc59ba6663e6ed58604f", "message": "fix a version conflict exception if stop is called while indexer is\nshutting down. Report the overall transform stats STOPPED iff there is no\ntask (and therefore no indexer)\n\nrelates #62204", "committedDate": "2020-11-12T07:54:46Z", "type": "commit"}, {"oid": "674a4d397ed17537d8cdb8dac9f74510aa926c81", "url": "https://github.com/elastic/elasticsearch/commit/674a4d397ed17537d8cdb8dac9f74510aa926c81", "message": "apply review suggestions", "committedDate": "2020-11-12T07:54:47Z", "type": "commit"}, {"oid": "674a4d397ed17537d8cdb8dac9f74510aa926c81", "url": "https://github.com/elastic/elasticsearch/commit/674a4d397ed17537d8cdb8dac9f74510aa926c81", "message": "apply review suggestions", "committedDate": "2020-11-12T07:54:47Z", "type": "forcePushed"}]}