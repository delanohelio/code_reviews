{"pr_number": 53254, "pr_title": "Handle SamlAuthenticationState between APIs", "pr_author": "jkakavas", "pr_createdAt": "2020-03-07T06:15:23Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/53254", "timeline": [{"oid": "1d636f7b8c6c425ce28e3e35b089412077501800", "url": "https://github.com/elastic/elasticsearch/commit/1d636f7b8c6c425ce28e3e35b089412077501800", "message": "Handle SamlAuthenticationState between APIs\n\nAfter successful validation of an AuthnRequest the caller of the\n/validate API needs to call /init to generate the SAML response\nthat it can then send to the SP. There is some context that needs\nto be carried from the response of the /validate API to the\nrequest to the /init API. This context is encaptulated in the\nSamlAuthenticationState object that is serialized to a json\nobject in the SamlValidateAuthnRequestResponse. This can be\ntreated as an opaque blob for the caller of the API that just\nneeds to pass it to the subsequent request to the /init API. At\nthe same time we enable SAML responses that indicate failure\n(as opposed to returning a 4xx) for both the /init API as\ndictated by the SAML 2.0 Web Browser SSO profile.\n\nAdditionally these small adjustements were made:\n\n- Saml Service Providers must indicate a single NameID format that\n  they want to use upon registration, instead of multiple. This is\n  used to validate the NameID Policy of the AuthnRequest if it\n  exists or to determine the NameID format for the response\n  otherwise.\n- If no NameID Policy is set in the AuthnRequest and the SP has\n  not registered a desired one, an IDP wide default NameID format\n  is returned.\n- JSON response fomat for the RestSamlInitiateSingleSignOnAction\n  has been reviewed as discussed.\n- All Rest actions have been moved under the same package", "committedDate": "2020-03-07T05:55:38Z", "type": "commit"}, {"oid": "e55a461e18ffeb9eed8d633f509e1029edccf527", "url": "https://github.com/elastic/elasticsearch/commit/e55a461e18ffeb9eed8d633f509e1029edccf527", "message": "Merge remote-tracking branch 'origin/feature-internal-idp' into handle-authn-state", "committedDate": "2020-03-07T06:09:34Z", "type": "commit"}, {"oid": "05b50bee9aebd46fd5a71671984942f4e1bd4b00", "url": "https://github.com/elastic/elasticsearch/commit/05b50bee9aebd46fd5a71671984942f4e1bd4b00", "message": "minor cleanup of leftovers from another approach", "committedDate": "2020-03-07T06:22:55Z", "type": "commit"}, {"oid": "a46ee7f2af181c4537950979f8363c7641f6f40f", "url": "https://github.com/elastic/elasticsearch/commit/a46ee7f2af181c4537950979f8363c7641f6f40f", "message": "cleanup whitespace", "committedDate": "2020-03-07T06:26:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzNDMwOA==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389234308", "body": "This ended up bothering me quite a bit but I raised the PR as is to discuss it. If this ends up in a cookie, a malicious user could forge the `inResponseTo` of  a SAML Response. This in itself is not a additional threat as it wouldn't allow any attack vectors that are not already mitigated by other means ( signature validation etc. ) \r\nThe requestedNameIdFormat can also be forged _after_ the NameIdPolicy is validated but then again the only attack vector this enables is that a malicious user could i.e.have a persistent NameID generated for an SP that only needs/handles transient ones. \r\nFinally the entityId is used only for the SamlInitiateSingleSignOnResponse and could easiliy be even omitted , and the requestedAcsUrl can potentially be forged to send SAML Response messages to attacker controlled URLs. \r\n\r\nAlthough we could accept the risk these potential issues carry, it makes me think: Is this user facing state control the right trade off to satisfy the API design ( the split between /validate and /init ) and the interplay between them ? \r\n\r\nIs the alternative of having the /validate API require secondary authentication too and able to respond with SAML Responses worth it ?That would mean that the user needs to be authenticated _before_ the AuthnRequest will be parsed and validated. It would also mean that we would respond with authentication failure even if i.e. there is also an error and we can't satisfy the NameIdPolicy ( one might argue that in these cases we should reply with `InvalidNameIdPolicy` regardless of auhtn failure because even if the authentication was correct, we would _still_ fail ) ", "bodyText": "This ended up bothering me quite a bit but I raised the PR as is to discuss it. If this ends up in a cookie, a malicious user could forge the inResponseTo of  a SAML Response. This in itself is not a additional threat as it wouldn't allow any attack vectors that are not already mitigated by other means ( signature validation etc. )\nThe requestedNameIdFormat can also be forged after the NameIdPolicy is validated but then again the only attack vector this enables is that a malicious user could i.e.have a persistent NameID generated for an SP that only needs/handles transient ones.\nFinally the entityId is used only for the SamlInitiateSingleSignOnResponse and could easiliy be even omitted , and the requestedAcsUrl can potentially be forged to send SAML Response messages to attacker controlled URLs.\nAlthough we could accept the risk these potential issues carry, it makes me think: Is this user facing state control the right trade off to satisfy the API design ( the split between /validate and /init ) and the interplay between them ?\nIs the alternative of having the /validate API require secondary authentication too and able to respond with SAML Responses worth it ?That would mean that the user needs to be authenticated before the AuthnRequest will be parsed and validated. It would also mean that we would respond with authentication failure even if i.e. there is also an error and we can't satisfy the NameIdPolicy ( one might argue that in these cases we should reply with InvalidNameIdPolicy regardless of auhtn failure because even if the authentication was correct, we would still fail )", "bodyHTML": "<p dir=\"auto\">This ended up bothering me quite a bit but I raised the PR as is to discuss it. If this ends up in a cookie, a malicious user could forge the <code>inResponseTo</code> of  a SAML Response. This in itself is not a additional threat as it wouldn't allow any attack vectors that are not already mitigated by other means ( signature validation etc. )<br>\nThe requestedNameIdFormat can also be forged <em>after</em> the NameIdPolicy is validated but then again the only attack vector this enables is that a malicious user could i.e.have a persistent NameID generated for an SP that only needs/handles transient ones.<br>\nFinally the entityId is used only for the SamlInitiateSingleSignOnResponse and could easiliy be even omitted , and the requestedAcsUrl can potentially be forged to send SAML Response messages to attacker controlled URLs.</p>\n<p dir=\"auto\">Although we could accept the risk these potential issues carry, it makes me think: Is this user facing state control the right trade off to satisfy the API design ( the split between /validate and /init ) and the interplay between them ?</p>\n<p dir=\"auto\">Is the alternative of having the /validate API require secondary authentication too and able to respond with SAML Responses worth it ?That would mean that the user needs to be authenticated <em>before</em> the AuthnRequest will be parsed and validated. It would also mean that we would respond with authentication failure even if i.e. there is also an error and we can't satisfy the NameIdPolicy ( one might argue that in these cases we should reply with <code>InvalidNameIdPolicy</code> regardless of auhtn failure because even if the authentication was correct, we would <em>still</em> fail )</p>", "author": "jkakavas", "createdAt": "2020-03-07T07:03:20Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/support/SamlAuthenticationState.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.idp.saml.support;\n+\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.ValidationException;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.common.xcontent.ObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * Represents a state object that can be used during an SP initiated flow in order to pass necessary parameters from the response of the\n+ * /validate API to the /init API. State properties are not integrity protected, might end up in a cookie on the user's side and as such\n+ * are treated as tainted parameters for informational purposes only. No authentication/authorization decisions should be made based on\n+ * these.\n+ */\n+public class SamlAuthenticationState implements Writeable, ToXContentObject {\n+    private String entityId;\n+    private String requestedAcsUrl;\n+    @Nullable\n+    private String requestedNameidFormat;\n+    @Nullable\n+    private String authnRequestId;", "originalCommit": "e55a461e18ffeb9eed8d633f509e1029edccf527", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MzkxOQ==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389543919", "bodyText": "We discussed this in person and determined that we want to keep the distinction as is for the reasons that originally lead us to this design ( mainly extensibility and spec conformance ).\nThe SamlAuthenticationState will not make it to a cookie for phase 1 and we will make it clear in the docs and code that this should be integrity protected if it ever needs to be shared in a format that is editable by the end user", "author": "jkakavas", "createdAt": "2020-03-09T09:28:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIzNDMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3ODU0OQ==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389478549", "body": "```suggestion\r\n                        \" for this Service Provider which is [{}]\", requestedFormat, sp.getAllowedNameIdFormat());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \"for this Service Provider which is [{}]\", requestedFormat, sp.getAllowedNameIdFormat());\n          \n          \n            \n                                    \" for this Service Provider which is [{}]\", requestedFormat, sp.getAllowedNameIdFormat());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>for this Service Provider which is [{}]<span class=\"pl-pds\">\"</span></span>, requestedFormat, sp<span class=\"pl-k\">.</span>getAllowedNameIdFormat());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\"> </span>for this Service Provider which is [{}]<span class=\"pl-pds\">\"</span></span>, requestedFormat, sp<span class=\"pl-k\">.</span>getAllowedNameIdFormat());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-03-09T06:17:37Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -172,36 +170,34 @@ private void validateAuthnRequest(AuthnRequest authnRequest, SamlServiceProvider\n                 return;\n             }\n         }\n-\n+        final Map<String, Object> authnState = new HashMap<>();\n         checkDestination(authnRequest);\n-        checkAcs(authnRequest, sp);\n-\n-        Map<String, Object> authnState = buildAuthnState(authnRequest, sp);\n+        checkAcs(authnRequest, sp, authnState);\n+        validateNameIdPolicy(authnRequest, sp, authnState);\n+        authnState.put(SamlAuthenticationState.Fields.ENTITY_ID.getPreferredName(), sp.getEntityId());\n+        authnState.put(SamlAuthenticationState.Fields.AUTHN_REQUEST_ID.getPreferredName(), authnRequest.getID());\n         final SamlValidateAuthnRequestResponse response = new SamlValidateAuthnRequestResponse(sp.getEntityId(),\n             authnRequest.isForceAuthn(), authnState);\n         logger.trace(new ParameterizedMessage(\"Validated AuthnResponse from queryString [{}] and extracted [{}]\",\n             parsedQueryString.queryString, response));\n         listener.onResponse(response);\n     }\n \n-    private Map<String, Object> buildAuthnState(AuthnRequest request, SamlServiceProvider sp) {\n-        Map<String, Object> authnState = new HashMap<>();\n+    private void validateNameIdPolicy(AuthnRequest request, SamlServiceProvider sp, Map<String, Object> authnState) {\n         final NameIDPolicy nameIDPolicy = request.getNameIDPolicy();\n         if (null != nameIDPolicy) {\n             final String requestedFormat = request.getNameIDPolicy().getFormat();\n+            final String allowedFormat = sp.getAllowedNameIdFormat();\n             if (Strings.hasText(requestedFormat)) {\n-                authnState.put(\"nameid_format\", requestedFormat);\n-                // we should not throw an error. Pass this as additional data so that the /saml/init API can\n-                // return a SAML response with the appropriate status (3.4.1.1 in the core spec)\n-                if (requestedFormat.equals(UNSPECIFIED) == false && sp.getAllowedNameIdFormats().contains(requestedFormat) == false) {\n-                    logger.warn(() ->\n-                        new ParameterizedMessage(\"The requested NameID format [{}] doesn't match the allowed NameID formats\" +\n-                            \"for this Service Provider are {}\", requestedFormat, sp.getAllowedNameIdFormats()));\n-                    authnState.put(\"error\", \"invalid_nameid_policy\");\n+                if (allowedFormat != null && requestedFormat.equals(UNSPECIFIED) == false\n+                    && requestedFormat.equals(allowedFormat) == false) {\n+                    throw new ElasticsearchSecurityException(\"The requested NameID format [{}] doesn't match the allowed NameID format\" +\n+                        \"for this Service Provider which is [{}]\", requestedFormat, sp.getAllowedNameIdFormat());", "originalCommit": "a46ee7f2af181c4537950979f8363c7641f6f40f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTA0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479043", "body": "Is this for template support? Or for concurrency?\r\n\r\nGiven we know that it _must_ equal the SP's registered ACS, it seems unnecessary here (but I'm not objecting, just trying to understand).", "bodyText": "Is this for template support? Or for concurrency?\nGiven we know that it must equal the SP's registered ACS, it seems unnecessary here (but I'm not objecting, just trying to understand).", "bodyHTML": "<p dir=\"auto\">Is this for template support? Or for concurrency?</p>\n<p dir=\"auto\">Given we know that it <em>must</em> equal the SP's registered ACS, it seems unnecessary here (but I'm not objecting, just trying to understand).</p>", "author": "tvernum", "createdAt": "2020-03-09T06:19:58Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -264,6 +260,7 @@ private void checkAcs(AuthnRequest request, SamlServiceProvider sp) {\n             throw new ElasticsearchSecurityException(\"The registered ACS URL for this Service Provider is [{}] but the authentication \" +\n                 \"request contained [{}]\", sp.getAssertionConsumerService(), acs);\n         }\n+        authnState.put(SamlAuthenticationState.Fields.ACS_URL.getPreferredName(), acs);", "originalCommit": "a46ee7f2af181c4537950979f8363c7641f6f40f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0NjEzNw==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389546137", "bodyText": "As we discussed in person, this is needed so that we can potentially return SAML Responses that indicate failure in the /init API, even if we/something fails before we reconstruct the SP object there", "author": "jkakavas", "createdAt": "2020-03-09T09:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTUwMA==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479500", "body": "Nit: Extra line.", "bodyText": "Nit: Extra line.", "bodyHTML": "<p dir=\"auto\">Nit: Extra line.</p>", "author": "tvernum", "createdAt": "2020-03-09T06:21:45Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java", "diffHunk": "@@ -215,4 +212,16 @@ private Status buildStatus() {\n \n         return status;\n     }\n+\n+    private NameID buildNameId(SamlServiceProvider serviceProvider, @Nullable SamlAuthenticationState authnState) {\n+        final NameID nameID = samlFactory.object(NameID.class, NameID.DEFAULT_ELEMENT_NAME);\n+        if (authnState != null && authnState.getRequestedNameidFormat() != null) {\n+            nameID.setFormat(authnState.getRequestedNameidFormat());\n+        } else {\n+            nameID.setFormat(serviceProvider.getAllowedNameIdFormat() != null ? serviceProvider.getAllowedNameIdFormat() :\n+                idp.getServiceProviderDefaults().nameIdFormat);\n+", "originalCommit": "a46ee7f2af181c4537950979f8363c7641f6f40f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTU4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479582", "body": "No `Value` for the NameID? If that's intentional, can we add a `TODO` here to set it?", "bodyText": "No Value for the NameID? If that's intentional, can we add a TODO here to set it?", "bodyHTML": "<p dir=\"auto\">No <code>Value</code> for the NameID? If that's intentional, can we add a <code>TODO</code> here to set it?</p>", "author": "tvernum", "createdAt": "2020-03-09T06:22:14Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SuccessfulAuthenticationResponseMessageBuilder.java", "diffHunk": "@@ -215,4 +212,16 @@ private Status buildStatus() {\n \n         return status;\n     }\n+\n+    private NameID buildNameId(SamlServiceProvider serviceProvider, @Nullable SamlAuthenticationState authnState) {\n+        final NameID nameID = samlFactory.object(NameID.class, NameID.DEFAULT_ELEMENT_NAME);\n+        if (authnState != null && authnState.getRequestedNameidFormat() != null) {\n+            nameID.setFormat(authnState.getRequestedNameidFormat());\n+        } else {\n+            nameID.setFormat(serviceProvider.getAllowedNameIdFormat() != null ? serviceProvider.getAllowedNameIdFormat() :\n+                idp.getServiceProviderDefaults().nameIdFormat);\n+\n+        }\n+        return nameID;", "originalCommit": "a46ee7f2af181c4537950979f8363c7641f6f40f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3OTk2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r389479967", "body": "```suggestion\r\n    @Nullable\r\n    public String nameIdFormat;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public String nameIdFormat;\n          \n          \n            \n                @Nullable\n          \n          \n            \n                public String nameIdFormat;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"232\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">public</span><span class=\"x\"> </span><span class=\"pl-smi x\">String</span><span class=\"x x-last\"> nameIdFormat;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"232\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k x x-first x-last\">@Nullable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"233\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">String</span> nameIdFormat;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-03-09T06:23:50Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderDocument.java", "diffHunk": "@@ -242,11 +242,12 @@ public int hashCode() {\n \n     public String acs;\n \n+    public String nameIdFormat;", "originalCommit": "a46ee7f2af181c4537950979f8363c7641f6f40f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9527dbc65a8ca5081cdb73a635ee5f480d5ada46", "url": "https://github.com/elastic/elasticsearch/commit/9527dbc65a8ca5081cdb73a635ee5f480d5ada46", "message": "Merge remote-tracking branch 'origin/feature-internal-idp' into handle-authn-state", "committedDate": "2020-03-09T09:30:54Z", "type": "commit"}, {"oid": "e7b077d226d852b9b971b50ee7b54ade190d76b2", "url": "https://github.com/elastic/elasticsearch/commit/e7b077d226d852b9b971b50ee7b54ade190d76b2", "message": "address preliminary comments", "committedDate": "2020-03-09T09:39:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMDg4OA==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391400888", "body": "Can't this be handled in the validation on the request? Why would we do it inside the action?", "bodyText": "Can't this be handled in the validation on the request? Why would we do it inside the action?", "bodyHTML": "<p dir=\"auto\">Can't this be handled in the validation on the request? Why would we do it inside the action?</p>", "author": "tvernum", "createdAt": "2020-03-12T04:54:24Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -49,34 +52,68 @@ public TransportSamlInitiateSingleSignOnAction(TransportService transportService\n     @Override\n     protected void doExecute(Task task, SamlInitiateSingleSignOnRequest request,\n                              ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        final SamlAuthenticationState authenticationState = request.getSamlAuthenticationState();\n+        if (authenticationState != null) {\n+            final ValidationException validationException = authenticationState.validate();\n+            if (validationException != null) {\n+                listener.onFailure(validationException);\n+                return;\n+            }\n+        }", "originalCommit": "e7b077d226d852b9b971b50ee7b54ade190d76b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMTQ4Mw==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391401483", "body": "I feel like it would be good (in a follow up probably) to actually indicate to the caller (in the JSON response) that this a failure rather than success.", "bodyText": "I feel like it would be good (in a follow up probably) to actually indicate to the caller (in the JSON response) that this a failure rather than success.", "bodyHTML": "<p dir=\"auto\">I feel like it would be good (in a follow up probably) to actually indicate to the caller (in the JSON response) that this a failure rather than success.</p>", "author": "tvernum", "createdAt": "2020-03-12T04:57:09Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -49,34 +52,68 @@ public TransportSamlInitiateSingleSignOnAction(TransportService transportService\n     @Override\n     protected void doExecute(Task task, SamlInitiateSingleSignOnRequest request,\n                              ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        final SamlAuthenticationState authenticationState = request.getSamlAuthenticationState();\n+        if (authenticationState != null) {\n+            final ValidationException validationException = authenticationState.validate();\n+            if (validationException != null) {\n+                listener.onFailure(validationException);\n+                return;\n+            }\n+        }\n         identityProvider.getRegisteredServiceProvider(request.getSpEntityId(), ActionListener.wrap(\n             sp -> {\n-                try {\n-                    if (null == sp) {\n-                        final String message = \"Service Provider with Entity ID [\" + request.getSpEntityId()\n-                            + \"] is not registered with this Identity Provider\";\n-                        logger.debug(message);\n-                        listener.onFailure(new IllegalArgumentException(message));\n+                if (null == sp) {\n+                    final String message = \"Service Provider with Entity ID [\" + request.getSpEntityId()\n+                        + \"] is not registered with this Identity Provider\";\n+                    logger.debug(message);\n+                    listener.onFailure(new IllegalArgumentException(message));\n+                    return;\n+                }\n+                final SecondaryAuthentication secondaryAuthentication = SecondaryAuthentication.readFromContext(securityContext);\n+                if (secondaryAuthentication == null) {\n+                    if (authenticationState != null) {\n+                        final FailedAuthenticationResponseMessageBuilder builder =\n+                            new FailedAuthenticationResponseMessageBuilder(samlFactory, Clock.systemUTC(), identityProvider)\n+                                .setInResponseTo(authenticationState.getAuthnRequestId())\n+                                .setAcsUrl(authenticationState.getRequestedAcsUrl())\n+                                .setPrimaryStatusCode(StatusCode.REQUESTER)\n+                                .setSecondaryStatusCode(StatusCode.AUTHN_FAILED);\n+                        final Response response = builder.build();\n+                        listener.onResponse(new SamlInitiateSingleSignOnResponse(\n+                            authenticationState.getRequestedAcsUrl(),\n+                            samlFactory.getXmlContent(response),\n+                            authenticationState.getEntityId()));", "originalCommit": "e7b077d226d852b9b971b50ee7b54ade190d76b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1NDA1MQ==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391654051", "bodyText": "Marked this as a todo and will take care of it in a follow up", "author": "jkakavas", "createdAt": "2020-03-12T14:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMTQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMTg1MA==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391401850", "body": "Nit, extra space.\r\n```suggestion\r\n * Processes a SAML AuthnRequest, validates it, extracts necessary information and returns a {@link SamlValidateAuthnRequestResponse}\r\n```", "bodyText": "Nit, extra space.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Processes a SAML AuthnRequest, validates it,  extracts necessary information and returns a {@link SamlValidateAuthnRequestResponse}\n          \n          \n            \n             * Processes a SAML AuthnRequest, validates it, extracts necessary information and returns a {@link SamlValidateAuthnRequestResponse}", "bodyHTML": "<p dir=\"auto\">Nit, extra space.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Processes</span> a <span class=\"pl-c1\">SAML</span> <span class=\"pl-smi\">AuthnRequest</span>, validates it, <span class=\"x x-first x-last\"> </span>extracts necessary information and returns a {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">SamlValidateAuthnRequestResponse</span>}</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Processes</span> a <span class=\"pl-c1\">SAML</span> <span class=\"pl-smi\">AuthnRequest</span>, validates it, extracts necessary information and returns a {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">SamlValidateAuthnRequestResponse</span>}</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-03-12T04:59:01Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -50,8 +51,8 @@\n import static org.opensaml.saml.common.xml.SAMLConstants.SAML2_REDIRECT_BINDING_URI;\n import static org.opensaml.saml.saml2.core.NameIDType.UNSPECIFIED;\n \n-/*\n- * Processes a SAML AuthnRequest, validates it and extracts necessary information\n+/**\n+ * Processes a SAML AuthnRequest, validates it,  extracts necessary information and returns a {@link SamlValidateAuthnRequestResponse}", "originalCommit": "e7b077d226d852b9b971b50ee7b54ade190d76b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQwMjAxNg==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391402016", "body": "For completeness, it would probably be worth putting the sp entity id in the message.\r\nThe caller should know it, but the logger won't.", "bodyText": "For completeness, it would probably be worth putting the sp entity id in the message.\nThe caller should know it, but the logger won't.", "bodyHTML": "<p dir=\"auto\">For completeness, it would probably be worth putting the sp entity id in the message.<br>\nThe caller should know it, but the logger won't.</p>", "author": "tvernum", "createdAt": "2020-03-12T04:59:54Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -150,17 +151,14 @@ private void validateAuthnRequest(AuthnRequest authnRequest, SamlServiceProvider\n                 }\n                 final Set<X509Credential> spSigningCredentials = sp.getSpSigningCredentials();\n                 if (spSigningCredentials == null || spSigningCredentials.isEmpty()) {\n-                    logAndRespond(\n-                        \"Unable to validate signature of authentication request, \" +\n-                            \"Service Provider hasn't registered signing credentials\",\n-                        listener);\n+                    logAndRespond(\"Unable to validate signature of authentication request, \" +\n+                        \"Service Provider hasn't registered signing credentials\", listener);", "originalCommit": "e7b077d226d852b9b971b50ee7b54ade190d76b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a58d9453615f7d6f0f69485f4d9eb91252f9eb68", "url": "https://github.com/elastic/elasticsearch/commit/a58d9453615f7d6f0f69485f4d9eb91252f9eb68", "message": "Merge remote-tracking branch 'origin/feature-internal-idp' into handle-authn-state", "committedDate": "2020-03-12T13:25:15Z", "type": "commit"}, {"oid": "2cbdb10a9058afa734246e5222f59fbfcf0c0fbc", "url": "https://github.com/elastic/elasticsearch/commit/2cbdb10a9058afa734246e5222f59fbfcf0c0fbc", "message": "Address feedback", "committedDate": "2020-03-12T14:20:03Z", "type": "commit"}, {"oid": "4816d77cf2e48a5525b9cfb8c90308fec6165d0e", "url": "https://github.com/elastic/elasticsearch/commit/4816d77cf2e48a5525b9cfb8c90308fec6165d0e", "message": "Merge branch 'feature-internal-idp' into handle-authn-state", "committedDate": "2020-03-12T14:29:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5NzgwMQ==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391997801", "body": "Since this only handles a failure response, I think it's worth naming it accordingly.\r\n\r\n```suggestion\r\n    private void possiblyReplyWithSamlFailure(SamlAuthenticationState authenticationState, String statusCode, Exception e,\r\n```", "bodyText": "Since this only handles a failure response, I think it's worth naming it accordingly.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void possiblyReplyWithSamlResponse(SamlAuthenticationState authenticationState, String statusCode, Exception e,\n          \n          \n            \n                private void possiblyReplyWithSamlFailure(SamlAuthenticationState authenticationState, String statusCode, Exception e,", "bodyHTML": "<p dir=\"auto\">Since this only handles a failure response, I think it's worth naming it accordingly.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">possiblyReplyWithSamlResponse</span>(<span class=\"pl-smi\">SamlAuthenticationState</span> authenticationState, <span class=\"pl-smi\">String</span> statusCode, <span class=\"pl-smi\">Exception</span> e,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">possiblyReplyWithSamlFailure</span>(<span class=\"pl-smi\">SamlAuthenticationState</span> authenticationState, <span class=\"pl-smi\">String</span> statusCode, <span class=\"pl-smi\">Exception</span> e,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tvernum", "createdAt": "2020-03-13T02:26:43Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -140,4 +123,23 @@ private void buildUserFromAuthentication(SecondaryAuthentication secondaryAuthen\n             }\n         );\n     }\n+\n+    private void possiblyReplyWithSamlResponse(SamlAuthenticationState authenticationState, String statusCode, Exception e,", "originalCommit": "4816d77cf2e48a5525b9cfb8c90308fec6165d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5Nzk3Ng==", "url": "https://github.com/elastic/elasticsearch/pull/53254#discussion_r391997976", "body": "Should we log too? (it can be part of the TODO)", "bodyText": "Should we log too? (it can be part of the TODO)", "bodyHTML": "<p dir=\"auto\">Should we log too? (it can be part of the TODO)</p>", "author": "tvernum", "createdAt": "2020-03-13T02:27:37Z", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/action/TransportSamlInitiateSingleSignOnAction.java", "diffHunk": "@@ -140,4 +123,23 @@ private void buildUserFromAuthentication(SecondaryAuthentication secondaryAuthen\n             }\n         );\n     }\n+\n+    private void possiblyReplyWithSamlResponse(SamlAuthenticationState authenticationState, String statusCode, Exception e,\n+                                               ActionListener<SamlInitiateSingleSignOnResponse> listener) {\n+        if (authenticationState != null) {\n+            final FailedAuthenticationResponseMessageBuilder builder =\n+                new FailedAuthenticationResponseMessageBuilder(samlFactory, Clock.systemUTC(), identityProvider)\n+                    .setInResponseTo(authenticationState.getAuthnRequestId())\n+                    .setAcsUrl(authenticationState.getRequestedAcsUrl())\n+                    .setPrimaryStatusCode(statusCode);\n+            final Response response = builder.build();\n+            //TODO: Indicate SAML Response status is failure in the response", "originalCommit": "4816d77cf2e48a5525b9cfb8c90308fec6165d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9049b0b8ae8ec4345d0cf1fdb62605443e6cac68", "url": "https://github.com/elastic/elasticsearch/commit/9049b0b8ae8ec4345d0cf1fdb62605443e6cac68", "message": "Merge branch 'feature-internal-idp' into handle-authn-state", "committedDate": "2020-03-13T05:57:11Z", "type": "commit"}, {"oid": "455edefac5570d4095ccc5d1cb4ba2585ed7d11c", "url": "https://github.com/elastic/elasticsearch/commit/455edefac5570d4095ccc5d1cb4ba2585ed7d11c", "message": "address feedback", "committedDate": "2020-03-13T06:26:24Z", "type": "commit"}]}