{"pr_number": 50610, "pr_title": "Run keystore management tests on docker distros", "pr_author": "williamrandolph", "pr_createdAt": "2020-01-03T15:53:15Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/50610", "timeline": [{"oid": "fb7455e32ac9764c62effe41044cd7972a660856", "url": "https://github.com/elastic/elasticsearch/commit/fb7455e32ac9764c62effe41044cd7972a660856", "message": "Add Docker handling to PackagingTestCase\n\nKeystore tests need to be able to run in the Docker case. We can do this\nby using a DockerShell instead of a plain Shell when Docker is running.", "committedDate": "2020-01-02T19:57:54Z", "type": "commit"}, {"oid": "1b3cbd692b416afa9ebe3b04564615ef1f5a8cf2", "url": "https://github.com/elastic/elasticsearch/commit/1b3cbd692b416afa9ebe3b04564615ef1f5a8cf2", "message": "Merge branch 'feature-pwd-protected-keystore-2' into docker-keystore-tests", "committedDate": "2020-01-02T21:00:28Z", "type": "commit"}, {"oid": "6a76f2021a73ef2f93ec8373736dab0a6d458359", "url": "https://github.com/elastic/elasticsearch/commit/6a76f2021a73ef2f93ec8373736dab0a6d458359", "message": "Refactor cleanup to parent class", "committedDate": "2020-01-03T15:40:32Z", "type": "commit"}, {"oid": "fb7366e9776d4444eee7d0d7a9352a7259116dd4", "url": "https://github.com/elastic/elasticsearch/commit/fb7366e9776d4444eee7d0d7a9352a7259116dd4", "message": "Verify permissions on docker keystore", "committedDate": "2020-01-03T16:26:59Z", "type": "commit"}, {"oid": "6f7e79314630d8abe630cb6421946ba244596a6e", "url": "https://github.com/elastic/elasticsearch/commit/6f7e79314630d8abe630cb6421946ba244596a6e", "message": "Remove redundant docker test", "committedDate": "2020-01-03T17:22:00Z", "type": "commit"}, {"oid": "a433e13fa5aa97432f810e885317eaebfc68a878", "url": "https://github.com/elastic/elasticsearch/commit/a433e13fa5aa97432f810e885317eaebfc68a878", "message": "Remove unused import", "committedDate": "2020-01-03T18:42:56Z", "type": "commit"}, {"oid": "d93631ca663b0c0febff3fe79a20a4d74e116aec", "url": "https://github.com/elastic/elasticsearch/commit/d93631ca663b0c0febff3fe79a20a4d74e116aec", "message": "Wait for keystore path availability for docker", "committedDate": "2020-01-03T20:38:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIyNzIyNA==", "url": "https://github.com/elastic/elasticsearch/pull/50610#discussion_r363227224", "body": "```suggestion\r\n        assertFalse(\"has-passwd should fail\", r.isSuccess());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n          \n          \n            \n                    assertFalse(\"has-passwd should fail\", r.isSuccess());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"x x-first x-last\">assertThat</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>has-passwd should fail<span class=\"pl-pds\">\"</span></span>, r<span class=\"pl-k\">.</span><span class=\"x x-first\">exitCode, not(is(</span><span class=\"pl-c1 x\">0</span><span class=\"x x-last\">)</span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"x x-first x-last\">assertFalse</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>has-passwd should fail<span class=\"pl-pds\">\"</span></span>, r<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">isSuccess(</span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "pugnascotia", "createdAt": "2020-01-06T10:00:21Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/KeystoreManagementTests.java", "diffHunk": "@@ -80,9 +83,30 @@ public void test11InstallPackageDistribution() throws Exception {\n         Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n         assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n         assertThat(\"has-passwd should fail\", r.stderr, containsString(\"ERROR: Keystore is not password-protected\"));\n+        Shell.Result r2 = bin.keystoreTool.run(\"list\");\n+        assertThat(r2.stdout, containsString(\"keystore.seed\"));\n+    }\n+\n+    /** Test initial Docker state */\n+    public void test12InstallDockerDistribution() throws Exception {\n+        assumeTrue(distribution().packaging == Distribution.Packaging.DOCKER);\n+\n+        installation = Docker.runContainer(distribution());\n+\n+        try {\n+            waitForPathToExist(installation.config(\"elasticsearch.keystore\"));\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        final Installation.Executables bin = installation.executables();\n+        Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n+        assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));", "originalCommit": "d93631ca663b0c0febff3fe79a20a4d74e116aec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIyNzQ4NA==", "url": "https://github.com/elastic/elasticsearch/pull/50610#discussion_r363227484", "body": "Since the previous line checked that the command failed, how about changing the message here:\r\n\r\n```suggestion\r\n        assertThat(\"has-passwd didn't fail with the expected error\", r.stdout, containsString(\"ERROR: Keystore is not password-protected\"));\r\n```", "bodyText": "Since the previous line checked that the command failed, how about changing the message here:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(\"has-passwd should fail\", r.stdout, containsString(\"ERROR: Keystore is not password-protected\"));\n          \n          \n            \n                    assertThat(\"has-passwd didn't fail with the expected error\", r.stdout, containsString(\"ERROR: Keystore is not password-protected\"));", "bodyHTML": "<p dir=\"auto\">Since the previous line checked that the command failed, how about changing the message here:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        assertThat(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>has-passwd <span class=\"x x-first x-last\">should</span> fail<span class=\"pl-pds\">\"</span></span>, r<span class=\"pl-k\">.</span>stdout, containsString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>ERROR: Keystore is not password-protected<span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        assertThat(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>has-passwd <span class=\"x x-first x-last\">didn't</span> fail<span class=\"x x-first x-last\"> with the expected error</span><span class=\"pl-pds\">\"</span></span>, r<span class=\"pl-k\">.</span>stdout, containsString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>ERROR: Keystore is not password-protected<span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "pugnascotia", "createdAt": "2020-01-06T10:01:06Z", "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/KeystoreManagementTests.java", "diffHunk": "@@ -80,9 +83,30 @@ public void test11InstallPackageDistribution() throws Exception {\n         Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n         assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n         assertThat(\"has-passwd should fail\", r.stderr, containsString(\"ERROR: Keystore is not password-protected\"));\n+        Shell.Result r2 = bin.keystoreTool.run(\"list\");\n+        assertThat(r2.stdout, containsString(\"keystore.seed\"));\n+    }\n+\n+    /** Test initial Docker state */\n+    public void test12InstallDockerDistribution() throws Exception {\n+        assumeTrue(distribution().packaging == Distribution.Packaging.DOCKER);\n+\n+        installation = Docker.runContainer(distribution());\n+\n+        try {\n+            waitForPathToExist(installation.config(\"elasticsearch.keystore\"));\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        final Installation.Executables bin = installation.executables();\n+        Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n+        assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n+        assertThat(\"has-passwd should fail\", r.stdout, containsString(\"ERROR: Keystore is not password-protected\"));", "originalCommit": "d93631ca663b0c0febff3fe79a20a4d74e116aec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "792020814f1074991cad275e9d23ec9f5e3b57c6", "url": "https://github.com/elastic/elasticsearch/commit/792020814f1074991cad275e9d23ec9f5e3b57c6", "message": "Add isDocker shortcut method", "committedDate": "2020-01-06T19:30:04Z", "type": "commit"}, {"oid": "5cbfe38e1c6aecd2dcebdc8eb99b0f25c342cfb0", "url": "https://github.com/elastic/elasticsearch/commit/5cbfe38e1c6aecd2dcebdc8eb99b0f25c342cfb0", "message": "Return full command width from docker ps", "committedDate": "2020-01-06T19:31:02Z", "type": "commit"}, {"oid": "3d551fce19842ed6bd33b45ee4483bcd31e6e232", "url": "https://github.com/elastic/elasticsearch/commit/3d551fce19842ed6bd33b45ee4483bcd31e6e232", "message": "Remove unused import", "committedDate": "2020-01-06T19:41:13Z", "type": "commit"}, {"oid": "24e5a95f28e7cbbe533f316601847fec7f6fd2b2", "url": "https://github.com/elastic/elasticsearch/commit/24e5a95f28e7cbbe533f316601847fec7f6fd2b2", "message": "Improve ES startup check for docker\n\nPreviously we were checking truncated output for the packaged JDK as\nan indication that Elasticsearch had started. With new preliminary\npassword checks, we might get a false positive from ES keystore\ncommands, so we have to check specifically that the Elasticsearch\nclass from the Bootstrap package is what's running.", "committedDate": "2020-01-06T20:39:40Z", "type": "commit"}, {"oid": "b9ce885586c50ed84f6fa81cf0f927e37d40b467", "url": "https://github.com/elastic/elasticsearch/commit/b9ce885586c50ed84f6fa81cf0f927e37d40b467", "message": "Respond to PR feedback", "committedDate": "2020-01-06T22:48:34Z", "type": "commit"}]}