{"pr_number": 52538, "pr_title": "[ML] rewrite deprecated datafeed configs to use new date_histogram interval fields", "pr_author": "benwtrent", "pr_createdAt": "2020-02-19T21:07:03Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/52538", "timeline": [{"oid": "4f176032264dcecb85d39eb447e1b928a145a211", "url": "https://github.com/elastic/elasticsearch/commit/4f176032264dcecb85d39eb447e1b928a145a211", "message": "[ML] rewrite deprecated datafeed aggs to use new [fixed|calendar]interval", "committedDate": "2020-02-19T21:01:56Z", "type": "commit"}, {"oid": "612b900397cf45aa762be8d230a671d148e254ba", "url": "https://github.com/elastic/elasticsearch/commit/612b900397cf45aa762be8d230a671d148e254ba", "message": "fixing bwc test", "committedDate": "2020-02-20T12:46:10Z", "type": "commit"}, {"oid": "00367ea646351e3576532098b64e6483d3895d63", "url": "https://github.com/elastic/elasticsearch/commit/00367ea646351e3576532098b64e6483d3895d63", "message": "Update 40_ml_datafeed_crud.yml", "committedDate": "2020-02-20T13:02:49Z", "type": "commit"}, {"oid": "c60f8c5f706dbd3cefc55e36d17cff67c2cc1eae", "url": "https://github.com/elastic/elasticsearch/commit/c60f8c5f706dbd3cefc55e36d17cff67c2cc1eae", "message": "adjusting bwc tests for rolling upgrade from 8.0.0", "committedDate": "2020-02-20T13:57:07Z", "type": "commit"}, {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "url": "https://github.com/elastic/elasticsearch/commit/efe0664294a7a14cf7e8231abbcc951fd49bc285", "message": "Merge branch 'feature/ml-datafeed-date_histo-migration' of github.com:benwtrent/elasticsearch into feature/ml-datafeed-date_histo-migration", "committedDate": "2020-02-20T13:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NDA5OA==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383274098", "body": "I think this should still be a valid test.  It's testing the code in https://github.com/elastic/elasticsearch/blob/290c8b8256fc4da512e7bbe1c727005c21d55a67/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/extractor/ExtractorUtils.java#L179-L189\r\n\r\nDid this test fail after the other changes in this PR?  If so that might be a sign of a problem.\r\n\r\nEven though histograms in general can plot variable length time buckets (e.g. months), it's still reasonable for ML to prohibit such bucket spans as they would make the modelling much more complex.", "bodyText": "I think this should still be a valid test.  It's testing the code in \n  \n    \n      elasticsearch/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/extractor/ExtractorUtils.java\n    \n    \n        Lines 179 to 189\n      in\n      290c8b8\n    \n    \n    \n    \n\n        \n          \n               if (interval.days() > 7) { \n        \n\n        \n          \n                   throw ExceptionsHelper.badRequestException(invalidDateHistogramCalendarIntervalMessage(calendarInterval)); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               return interval.millis(); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           private static String invalidDateHistogramCalendarIntervalMessage(String interval) { \n        \n\n        \n          \n               throw ExceptionsHelper.badRequestException(\"When specifying a date_histogram calendar interval [\" \n        \n\n        \n          \n                       + interval + \"], ML does not accept intervals longer than a week because of \" + \n        \n\n        \n          \n                       \"variable lengths of periods greater than a week\"); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nDid this test fail after the other changes in this PR?  If so that might be a sign of a problem.\nEven though histograms in general can plot variable length time buckets (e.g. months), it's still reasonable for ML to prohibit such bucket spans as they would make the modelling much more complex.", "bodyHTML": "<p dir=\"auto\">I think this should still be a valid test.  It's testing the code in <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/elastic/elasticsearch/blob/290c8b8256fc4da512e7bbe1c727005c21d55a67/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/extractor/ExtractorUtils.java#L179-L189\">elasticsearch/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/extractor/ExtractorUtils.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 179 to 189\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/elastic/elasticsearch/commit/290c8b8256fc4da512e7bbe1c727005c21d55a67\">290c8b8</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L179\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"179\"></td>\n          <td id=\"LC179\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">if</span> (interval<span class=\"pl-k\">.</span>days() <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">7</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L180\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"180\"></td>\n          <td id=\"LC180\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">throw</span> <span class=\"pl-smi\">ExceptionsHelper</span><span class=\"pl-k\">.</span>badRequestException(invalidDateHistogramCalendarIntervalMessage(calendarInterval)); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L181\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"181\"></td>\n          <td id=\"LC181\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L182\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"182\"></td>\n          <td id=\"LC182\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">return</span> interval<span class=\"pl-k\">.</span>millis(); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L183\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"183\"></td>\n          <td id=\"LC183\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L184\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"184\"></td>\n          <td id=\"LC184\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L185\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"185\"></td>\n          <td id=\"LC185\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">String</span> <span class=\"pl-en\">invalidDateHistogramCalendarIntervalMessage</span>(<span class=\"pl-smi\">String</span> <span class=\"pl-v\">interval</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L186\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"186\"></td>\n          <td id=\"LC186\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">throw</span> <span class=\"pl-smi\">ExceptionsHelper</span><span class=\"pl-k\">.</span>badRequestException(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>When specifying a date_histogram calendar interval [<span class=\"pl-pds\">\"</span></span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L187\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"187\"></td>\n          <td id=\"LC187\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-k\">+</span> interval <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>], ML does not accept intervals longer than a week because of <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L188\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"188\"></td>\n          <td id=\"LC188\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>variable lengths of periods greater than a week<span class=\"pl-pds\">\"</span></span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L189\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"189\"></td>\n          <td id=\"LC189\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">Did this test fail after the other changes in this PR?  If so that might be a sign of a problem.</p>\n<p dir=\"auto\">Even though histograms in general can plot variable length time buckets (e.g. months), it's still reasonable for ML to prohibit such bucket spans as they would make the modelling much more complex.</p>", "author": "droberts195", "createdAt": "2020-02-24T13:49:11Z", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfigTests.java", "diffHunk": "@@ -566,13 +584,6 @@ public void testBuild_GivenValidDateHistogram() {\n                 equalTo(7 * millisInDay + 1));\n     }\n \n-    public void testBuild_GivenDateHistogramWithMoreThanCalendarWeek() {\n-        ElasticsearchException e = expectThrows(ElasticsearchException.class,\n-                () -> createDatafeedWithDateHistogram(\"8d\"));\n-\n-        assertThat(e.getMessage(), containsString(\"When specifying a date_histogram calendar interval [8d]\"));", "originalCommit": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM2NjM4Mg==", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383366382", "bodyText": "added the test back and fixed it", "author": "benwtrent", "createdAt": "2020-02-24T16:20:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NDA5OA=="}], "type": "inlineReview"}, {"oid": "5b2d978a07261ec1fe88d4f18227eb710c38681c", "url": "https://github.com/elastic/elasticsearch/commit/5b2d978a07261ec1fe88d4f18227eb710c38681c", "message": "fixing bwc tests + adding back large calendar interval test", "committedDate": "2020-02-24T14:40:30Z", "type": "commit"}, {"oid": "252297fe0f41de1dc75ed19f9022a19df1471181", "url": "https://github.com/elastic/elasticsearch/commit/252297fe0f41de1dc75ed19f9022a19df1471181", "message": "Merge branch 'master' into feature/ml-datafeed-date_histo-migration", "committedDate": "2020-02-24T14:40:41Z", "type": "commit"}]}