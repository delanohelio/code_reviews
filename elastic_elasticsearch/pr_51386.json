{"pr_number": 51386, "pr_title": "Check all snapshots in SnapshotLifecycleRestIT.testFullPolicy", "pr_author": "dakrone", "pr_createdAt": "2020-01-23T23:17:29Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/51386", "timeline": [{"oid": "c7db7add948b174d382248eb50a9b3d03a292e70", "url": "https://github.com/elastic/elasticsearch/commit/c7db7add948b174d382248eb50a9b3d03a292e70", "message": "Check all snapshots in SnapshotLifecycleRestIT.testFullPolicy\n\nRather than check the first returned snapshot for a snapshot starting with `snap-` in\nSnapshotLifecycleRestIT.testFullPolicy, this commit changes the test to find any snapshots starting\nwith `snap-`.\n\nIn the event that there are no snapshots (the failure case), this also exposes the full results map\nso we can diagnose why a failure occurred.\n\nRelates to #50358", "committedDate": "2020-01-23T23:14:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxMjMwNA==", "url": "https://github.com/elastic/elasticsearch/pull/51386#discussion_r370712304", "body": "It's very hard for me to understand this, mix of streams, `Optional` and nested checks with streams doesn't work well for me. \r\nI'd rather split it into separate calls which is more explicit and it makes this code easier to digest:\r\n```java\r\nMap<String, Object> snapResponse;\r\ntry {\r\n    Map<String, Object> responseMap = ((List<Map<String, Object>>) snapshotResponseMap.get(\"responses\")).get(0);\r\n    List<Map<String, Object>> snapshots = (List<Map<String, Object>>) responseMap.get(\"snapshots\");\r\n    assertTrue(snapshots.stream().anyMatch(s -> s.containsKey(\"snapshot\") && s.get(\"snapshot\").toString().startsWith(\"snap-\")));\r\n    snapResponse = snapshots.get(0);\r\n} catch (Exception e){\r\n    throw new AssertionError(\"failed to find snapshot response in \" + snapshotResponseMap, e);\r\n}\r\nassertThat(snapResponse.get(\"indices\"), equalTo(Collections.singletonList(indexName)));\r\nMap<String, Object> metadata = (Map<String, Object>) snapResponse.get(\"metadata\");\r\n```\r\nIf you go with above, please check if I got it right, as I said it's hard for me to follow.", "bodyText": "It's very hard for me to understand this, mix of streams, Optional and nested checks with streams doesn't work well for me.\nI'd rather split it into separate calls which is more explicit and it makes this code easier to digest:\nMap<String, Object> snapResponse;\ntry {\n    Map<String, Object> responseMap = ((List<Map<String, Object>>) snapshotResponseMap.get(\"responses\")).get(0);\n    List<Map<String, Object>> snapshots = (List<Map<String, Object>>) responseMap.get(\"snapshots\");\n    assertTrue(snapshots.stream().anyMatch(s -> s.containsKey(\"snapshot\") && s.get(\"snapshot\").toString().startsWith(\"snap-\")));\n    snapResponse = snapshots.get(0);\n} catch (Exception e){\n    throw new AssertionError(\"failed to find snapshot response in \" + snapshotResponseMap, e);\n}\nassertThat(snapResponse.get(\"indices\"), equalTo(Collections.singletonList(indexName)));\nMap<String, Object> metadata = (Map<String, Object>) snapResponse.get(\"metadata\");\nIf you go with above, please check if I got it right, as I said it's hard for me to follow.", "bodyHTML": "<p dir=\"auto\">It's very hard for me to understand this, mix of streams, <code>Optional</code> and nested checks with streams doesn't work well for me.<br>\nI'd rather split it into separate calls which is more explicit and it makes this code easier to digest:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Map&lt;String, Object&gt; snapResponse;\ntry {\n    Map&lt;String, Object&gt; responseMap = ((List&lt;Map&lt;String, Object&gt;&gt;) snapshotResponseMap.get(&quot;responses&quot;)).get(0);\n    List&lt;Map&lt;String, Object&gt;&gt; snapshots = (List&lt;Map&lt;String, Object&gt;&gt;) responseMap.get(&quot;snapshots&quot;);\n    assertTrue(snapshots.stream().anyMatch(s -&gt; s.containsKey(&quot;snapshot&quot;) &amp;&amp; s.get(&quot;snapshot&quot;).toString().startsWith(&quot;snap-&quot;)));\n    snapResponse = snapshots.get(0);\n} catch (Exception e){\n    throw new AssertionError(&quot;failed to find snapshot response in &quot; + snapshotResponseMap, e);\n}\nassertThat(snapResponse.get(&quot;indices&quot;), equalTo(Collections.singletonList(indexName)));\nMap&lt;String, Object&gt; metadata = (Map&lt;String, Object&gt;) snapResponse.get(&quot;metadata&quot;);\"><pre><span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span> snapResponse;\n<span class=\"pl-k\">try</span> {\n    <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span> responseMap <span class=\"pl-k\">=</span> ((<span class=\"pl-k\">List&lt;<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span>&gt;</span>) snapshotResponseMap<span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>responses<span class=\"pl-pds\">\"</span></span>))<span class=\"pl-k\">.</span>get(<span class=\"pl-c1\">0</span>);\n    <span class=\"pl-k\">List&lt;<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span>&gt;</span> snapshots <span class=\"pl-k\">=</span> (<span class=\"pl-k\">List&lt;<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span>&gt;</span>) responseMap<span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>snapshots<span class=\"pl-pds\">\"</span></span>);\n    assertTrue(snapshots<span class=\"pl-k\">.</span>stream()<span class=\"pl-k\">.</span>anyMatch(s <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> s<span class=\"pl-k\">.</span>containsKey(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>snapshot<span class=\"pl-pds\">\"</span></span>) <span class=\"pl-k\">&amp;&amp;</span> s<span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>snapshot<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>toString()<span class=\"pl-k\">.</span>startsWith(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>snap-<span class=\"pl-pds\">\"</span></span>)));\n    snapResponse <span class=\"pl-k\">=</span> snapshots<span class=\"pl-k\">.</span>get(<span class=\"pl-c1\">0</span>);\n} <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">Exception</span> e){\n    <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">AssertionError</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>failed to find snapshot response in <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> snapshotResponseMap, e);\n}\nassertThat(snapResponse<span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>indices<span class=\"pl-pds\">\"</span></span>), equalTo(<span class=\"pl-smi\">Collections</span><span class=\"pl-k\">.</span>singletonList(indexName)));\n<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span> metadata <span class=\"pl-k\">=</span> (<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Object</span>&gt;</span>) snapResponse<span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>metadata<span class=\"pl-pds\">\"</span></span>);</pre></div>\n<p dir=\"auto\">If you go with above, please check if I got it right, as I said it's hard for me to follow.</p>", "author": "probakowski", "createdAt": "2020-01-24T16:05:52Z", "path": "x-pack/plugin/ilm/qa/multi-node/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleRestIT.java", "diffHunk": "@@ -108,9 +109,11 @@ public void testFullPolicySnapshot() throws Exception {\n             List<Map<String, Object>> snapResponse = ((List<Map<String, Object>>) snapshotResponseMap.get(\"responses\")).stream()\n                 .findFirst()\n                 .map(m -> (List<Map<String, Object>>) m.get(\"snapshots\"))\n+                .filter(allRepos -> allRepos.stream()\n+                    .anyMatch(snapMap -> Optional.ofNullable((String) snapMap.get(\"snapshot\"))\n+                        .map(snapName -> snapName.startsWith(\"snap-\"))\n+                        .orElse(false)))\n                 .orElseThrow(() -> new AssertionError(\"failed to find snapshot response in \" + snapshotResponseMap));", "originalCommit": "c7db7add948b174d382248eb50a9b3d03a292e70", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NzkwOQ==", "url": "https://github.com/elastic/elasticsearch/pull/51386#discussion_r370767909", "bodyText": "Sure, I went ahead and changed it.", "author": "dakrone", "createdAt": "2020-01-24T18:06:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcxMjMwNA=="}], "type": "inlineReview"}, {"oid": "51906a49e68f793166c115406a0d84342164f6f8", "url": "https://github.com/elastic/elasticsearch/commit/51906a49e68f793166c115406a0d84342164f6f8", "message": "Use a more imperative style for checking", "committedDate": "2020-01-24T18:05:24Z", "type": "commit"}]}