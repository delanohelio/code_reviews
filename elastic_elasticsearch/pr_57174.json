{"pr_number": 57174, "pr_title": "[6.8] Fix delete_expired_data/nightly maintenance when many model snapshots need deleting ", "pr_author": "davidkyle", "pr_createdAt": "2020-05-26T19:12:36Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/57174", "timeline": [{"oid": "b6608fca0d156c31ca0689acc17c460032e21725", "url": "https://github.com/elastic/elasticsearch/commit/b6608fca0d156c31ca0689acc17c460032e21725", "message": "Only request required fields in expired data removers", "committedDate": "2020-05-26T19:08:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzNDY0NA==", "url": "https://github.com/elastic/elasticsearch/pull/57174#discussion_r430934644", "body": "The logic here is different to the later branches as it doesn't have the new model snapshot retention options added in #56125", "bodyText": "The logic here is different to the later branches as it doesn't have the new model snapshot retention options added in #56125", "bodyHTML": "<p dir=\"auto\">The logic here is different to the later branches as it doesn't have the new model snapshot retention options added in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"611997892\" data-permission-text=\"Title is private\" data-url=\"https://github.com/elastic/elasticsearch/issues/56125\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/elastic/elasticsearch/pull/56125/hovercard\" href=\"https://github.com/elastic/elasticsearch/pull/56125\">#56125</a></p>", "author": "davidkyle", "createdAt": "2020-05-27T08:10:55Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemover.java", "diffHunk": "@@ -99,11 +106,18 @@ protected void removeDataBefore(Job job, long cutoffEpochMs, ActionListener<Bool\n             @Override\n             public void onResponse(SearchResponse searchResponse) {\n                 try {\n-                    List<ModelSnapshot> modelSnapshots = new ArrayList<>();\n+                    List<JobSnapshotId> snapshotIds = new ArrayList<>();\n                     for (SearchHit hit : searchResponse.getHits()) {\n-                        modelSnapshots.add(ModelSnapshot.fromJson(hit.getSourceRef()));\n+                        JobSnapshotId idPair = new JobSnapshotId(", "originalCommit": "b6608fca0d156c31ca0689acc17c460032e21725", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzNTg3NA==", "url": "https://github.com/elastic/elasticsearch/pull/57174#discussion_r430935874", "body": "In 6.8 the doc value could be a `Long` rather than a `String`.  It's why `TimeField` has this case: https://github.com/elastic/elasticsearch/blob/cde202610c58def76e5a923892776c0d7e00f88a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/TimeField.java#L49\r\n\r\nWhat this means in practice is that a user running 6.8 who first used ML in 5.x will end up seeing the warning on lines 139-140 repeatedly and won't get any cleanup.\r\n\r\nIt's still OK to use `stringFieldValueOrNull()` to extract fields mapped as `keyword` or `text` from hits, but for fields mapped as `date` in 6.8 the code needs to handle both `Long` and `String`.", "bodyText": "In 6.8 the doc value could be a Long rather than a String.  It's why TimeField has this case: \n  \n    \n      elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/TimeField.java\n    \n    \n         Line 49\n      in\n      cde2026\n    \n    \n    \n    \n\n        \n          \n           } else if (value[0] instanceof Long == false) { // pre-6.0 field \n        \n    \n  \n\n\nWhat this means in practice is that a user running 6.8 who first used ML in 5.x will end up seeing the warning on lines 139-140 repeatedly and won't get any cleanup.\nIt's still OK to use stringFieldValueOrNull() to extract fields mapped as keyword or text from hits, but for fields mapped as date in 6.8 the code needs to handle both Long and String.", "bodyHTML": "<p dir=\"auto\">In 6.8 the doc value could be a <code>Long</code> rather than a <code>String</code>.  It's why <code>TimeField</code> has this case: <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/elastic/elasticsearch/blob/cde202610c58def76e5a923892776c0d7e00f88a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/TimeField.java#L49\">elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/TimeField.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 49\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/elastic/elasticsearch/commit/cde202610c58def76e5a923892776c0d7e00f88a\">cde2026</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L49\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"49\"></td>\n          <td id=\"LC49\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (value[<span class=\"pl-c1\">0</span>] <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">Long</span> <span class=\"pl-k\">==</span> <span class=\"pl-c1\">false</span>) { <span class=\"pl-c\"><span class=\"pl-c\">//</span> pre-6.0 field</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">What this means in practice is that a user running 6.8 who first used ML in 5.x will end up seeing the warning on lines 139-140 repeatedly and won't get any cleanup.</p>\n<p dir=\"auto\">It's still OK to use <code>stringFieldValueOrNull()</code> to extract fields mapped as <code>keyword</code> or <code>text</code> from hits, but for fields mapped as <code>date</code> in 6.8 the code needs to handle both <code>Long</code> and <code>String</code>.</p>", "author": "droberts195", "createdAt": "2020-05-27T08:13:07Z", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/ExpiredForecastsRemover.java", "diffHunk": "@@ -129,39 +125,49 @@ public void onFailure(Exception e) {\n         });\n     }\n \n-    private List<ForecastRequestStats> findForecastsToDelete(SearchResponse searchResponse) throws IOException {\n-        List<ForecastRequestStats> forecastsToDelete = new ArrayList<>();\n+    private List<JobForecastId> findForecastsToDelete(SearchResponse searchResponse) {\n+        List<JobForecastId> forecastsToDelete = new ArrayList<>();\n \n         SearchHits hits = searchResponse.getHits();\n         if (hits.getTotalHits() > MAX_FORECASTS) {\n             LOGGER.info(\"More than [{}] forecasts were found. This run will only delete [{}] of them\", MAX_FORECASTS, MAX_FORECASTS);\n         }\n \n         for (SearchHit hit : hits.getHits()) {\n-            try (InputStream stream = hit.getSourceRef().streamInput();\n-                 XContentParser parser = XContentFactory.xContent(XContentType.JSON).createParser(\n-                         NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE, stream)) {\n-                ForecastRequestStats forecastRequestStats = ForecastRequestStats.LENIENT_PARSER.apply(parser, null);\n-                if (forecastRequestStats.getExpiryTime().toEpochMilli() < cutoffEpochMs) {\n-                    forecastsToDelete.add(forecastRequestStats);\n+            String expiryTime = stringFieldValueOrNull(hit, ForecastRequestStats.EXPIRY_TIME.getPreferredName());", "originalCommit": "b6608fca0d156c31ca0689acc17c460032e21725", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk0MzExMw==", "url": "https://github.com/elastic/elasticsearch/pull/57174#discussion_r430943113", "bodyText": "Good point thanks.\nI'm curious though why does this code throw if the object is a Long? This is from the 6.8 branch\n\n  \n    \n      elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/datafeed/extractor/fields/ExtractedField.java\n    \n    \n         Line 118\n      in\n      62f8da2\n    \n    \n    \n    \n\n        \n          \n           throw new IllegalStateException(\"Unexpected value for a time field: \" + value[0].getClass());", "author": "davidkyle", "createdAt": "2020-05-27T08:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzNTg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk2OTU2Nw==", "url": "https://github.com/elastic/elasticsearch/pull/57174#discussion_r430969567", "bodyText": "The tricky part is the condition checks the value is not a long. Thus, the logic there is that prior to 6.0, we expect a long. If it's not, then something's gone wrong. Otherwise, we fall through the last return of the method. Pretty confusing, I know.", "author": "dimitris-athanasiou", "createdAt": "2020-05-27T09:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzNTg3NA=="}], "type": "inlineReview"}, {"oid": "19efa8cbcdf9a945b179b15b2241ccec997e23a7", "url": "https://github.com/elastic/elasticsearch/commit/19efa8cbcdf9a945b179b15b2241ccec997e23a7", "message": "Revert TimeUtils", "committedDate": "2020-05-27T09:16:52Z", "type": "commit"}, {"oid": "8a32d639a106c31ff0fb37dbe05131163eecbd44", "url": "https://github.com/elastic/elasticsearch/commit/8a32d639a106c31ff0fb37dbe05131163eecbd44", "message": "Parse date as long or string", "committedDate": "2020-05-27T09:48:55Z", "type": "commit"}]}