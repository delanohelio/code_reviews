{"pr_number": 62261, "pr_title": "Fix privilege requirement for CCS with Point In Time reader", "pr_author": "ywangd", "pr_createdAt": "2020-09-11T01:36:47Z", "pr_url": "https://github.com/elastic/elasticsearch/pull/62261", "timeline": [{"oid": "ca75899fc9153992137340067510daa3922a1804", "url": "https://github.com/elastic/elasticsearch/commit/ca75899fc9153992137340067510daa3922a1804", "message": "Fix permission for CCS with PointInTime", "committedDate": "2020-09-11T01:32:58Z", "type": "commit"}, {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694", "url": "https://github.com/elastic/elasticsearch/commit/c0e2ace69f0c94ccfa67820eb2f8b377f6d23694", "message": "Merge remote-tracking branch 'origin/master' into pit-ccs-permission", "committedDate": "2020-09-11T01:58:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NTc2Ng==", "url": "https://github.com/elastic/elasticsearch/pull/62261#discussion_r487895766", "body": "I would also exercise the condition that remote indices are wildcards (it could be a random)", "bodyText": "I would also exercise the condition that remote indices are wildcards (it could be a random)", "bodyHTML": "<p dir=\"auto\">I would also exercise the condition that remote indices are wildcards (it could be a random)</p>", "author": "albertzaharovits", "createdAt": "2020-09-14T13:05:07Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/AuthorizationServiceTests.java", "diffHunk": "@@ -479,6 +484,46 @@ public void testRemoteIndicesOnlyWorkWithApplicableRequestTypes() throws IOExcep\n         verifyNoMoreInteractions(auditTrail);\n     }\n \n+    public void testUserWithNoRolesOpenPointInTimeWithRemoteIndices() {\n+        final boolean hasLocalIndices = randomBoolean();\n+        final String[] indices = new String[]{\n+            hasLocalIndices ? randomAlphaOfLength(5) : \"other_cluster:\" + randomAlphaOfLength(5),", "originalCommit": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NTk4OQ==", "url": "https://github.com/elastic/elasticsearch/pull/62261#discussion_r487895989", "body": "set this to both values in a for-each.", "bodyText": "set this to both values in a for-each.", "bodyHTML": "<p dir=\"auto\">set this to both values in a for-each.</p>", "author": "albertzaharovits", "createdAt": "2020-09-14T13:05:31Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/AuthorizationServiceTests.java", "diffHunk": "@@ -479,6 +484,46 @@ public void testRemoteIndicesOnlyWorkWithApplicableRequestTypes() throws IOExcep\n         verifyNoMoreInteractions(auditTrail);\n     }\n \n+    public void testUserWithNoRolesOpenPointInTimeWithRemoteIndices() {\n+        final boolean hasLocalIndices = randomBoolean();", "originalCommit": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwMTc0Mw==", "url": "https://github.com/elastic/elasticsearch/pull/62261#discussion_r487901743", "body": "```suggestion\r\n        verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(indices:data/read/close_point_in_time), eq(closePointInTimeRequest),\r\n```\r\nIf you wanna be consistent with the previous test.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(ClosePointInTimeAction.NAME), eq(closePointInTimeRequest),\n          \n          \n            \n                    verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(indices:data/read/close_point_in_time), eq(closePointInTimeRequest),\n          \n      \n    \n    \n  \n\nIf you wanna be consistent with the previous test.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        verify(auditTrail)<span class=\"pl-k\">.</span>accessGranted(eq(requestId), eq(authentication), eq(<span class=\"pl-smi x x-first\">ClosePointInTimeAction</span><span class=\"pl-c1\"><span class=\"pl-k x\">.</span><span class=\"x x-last\">NAME</span></span>), eq(closePointInTimeRequest),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        verify(auditTrail)<span class=\"pl-k\">.</span>accessGranted(eq(requestId), eq(authentication), eq(<span class=\"x x-first\">indices</span><span class=\"pl-k x\">:</span><span class=\"x\">data</span><span class=\"pl-k x\">/</span><span class=\"x\">read</span><span class=\"pl-k x\">/</span><span class=\"x x-last\">close_point_in_time</span>), eq(closePointInTimeRequest),</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">If you wanna be consistent with the previous test.</p>", "author": "albertzaharovits", "createdAt": "2020-09-14T13:14:07Z", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/AuthorizationServiceTests.java", "diffHunk": "@@ -479,6 +484,46 @@ public void testRemoteIndicesOnlyWorkWithApplicableRequestTypes() throws IOExcep\n         verifyNoMoreInteractions(auditTrail);\n     }\n \n+    public void testUserWithNoRolesOpenPointInTimeWithRemoteIndices() {\n+        final boolean hasLocalIndices = randomBoolean();\n+        final String[] indices = new String[]{\n+            hasLocalIndices ? randomAlphaOfLength(5) : \"other_cluster:\" + randomAlphaOfLength(5),\n+            \"other_cluster:\" + randomAlphaOfLength(5)\n+        };\n+        final OpenPointInTimeRequest openPointInTimeRequest = new OpenPointInTimeRequest(\n+            indices, OpenPointInTimeRequest.DEFAULT_INDICES_OPTIONS, TimeValue.timeValueMinutes(randomLongBetween(1, 10)),\n+            randomAlphaOfLength(5), randomAlphaOfLength(5)\n+        );\n+        final Authentication authentication = createAuthentication(new User(\"test user\"));\n+        mockEmptyMetadata();\n+        final String requestId = AuditUtil.getOrGenerateRequestId(threadContext);\n+        if (hasLocalIndices) {\n+            assertThrowsAuthorizationException(\n+                () -> authorize(authentication, OpenPointInTimeAction.NAME, openPointInTimeRequest),\n+                \"indices:data/read/open_point_in_time\", \"test user\"\n+            );\n+            verify(auditTrail).accessDenied(eq(requestId), eq(authentication),\n+                                            eq(\"indices:data/read/open_point_in_time\"), eq(openPointInTimeRequest),\n+                                            authzInfoRoles(Role.EMPTY.names()));\n+        } else {\n+            authorize(authentication, OpenPointInTimeAction.NAME, openPointInTimeRequest);\n+            verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(OpenPointInTimeAction.NAME), eq(openPointInTimeRequest),\n+                                             authzInfoRoles(Role.EMPTY.names()));\n+        }\n+        verifyNoMoreInteractions(auditTrail);\n+    }\n+\n+    public void testUserWithNoRolesCanClosePointInTime() {\n+        final ClosePointInTimeRequest closePointInTimeRequest = new ClosePointInTimeRequest(randomAlphaOfLength(8));\n+        final Authentication authentication = createAuthentication(new User(\"test user\"));\n+        mockEmptyMetadata();\n+        final String requestId = AuditUtil.getOrGenerateRequestId(threadContext);\n+        authorize(authentication, ClosePointInTimeAction.NAME, closePointInTimeRequest);\n+        verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(ClosePointInTimeAction.NAME), eq(closePointInTimeRequest),", "originalCommit": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "494863bf4a4423dda3e5ce5ff408b3feb2103f74", "url": "https://github.com/elastic/elasticsearch/commit/494863bf4a4423dda3e5ce5ff408b3feb2103f74", "message": "Merge remote-tracking branch 'origin/master' into pit-ccs-permission", "committedDate": "2020-09-18T02:17:48Z", "type": "commit"}, {"oid": "0c2f20cf39aac30f504990482f47e5470ed8435d", "url": "https://github.com/elastic/elasticsearch/commit/0c2f20cf39aac30f504990482f47e5470ed8435d", "message": "Apply suggestions from code review\n\nCo-authored-by: Albert Zaharovits <albert.zaharovits@gmail.com>", "committedDate": "2020-09-18T02:33:47Z", "type": "commit"}, {"oid": "0e056c3a8c6aa1d9c7e5c1988197b6454c190923", "url": "https://github.com/elastic/elasticsearch/commit/0e056c3a8c6aa1d9c7e5c1988197b6454c190923", "message": "Merge branch 'pit-ccs-permission' of github.com:ywangd/elasticsearch into pit-ccs-permission", "committedDate": "2020-09-18T02:34:03Z", "type": "commit"}, {"oid": "635619c7d0970a588b7d5fb2a7a653076c05be1d", "url": "https://github.com/elastic/elasticsearch/commit/635619c7d0970a588b7d5fb2a7a653076c05be1d", "message": "address feedback", "committedDate": "2020-09-18T02:43:42Z", "type": "commit"}, {"oid": "67a03a69a2e0e8eaf0260c98145b2ff4d4eac0fa", "url": "https://github.com/elastic/elasticsearch/commit/67a03a69a2e0e8eaf0260c98145b2ff4d4eac0fa", "message": "Fix test", "committedDate": "2020-09-18T03:10:32Z", "type": "commit"}]}