{"pr_number": 1016, "pr_title": "Add null check in close() of ZkConnectionManager", "pr_author": "narendly", "pr_createdAt": "2020-05-18T21:07:51Z", "pr_url": "https://github.com/apache/helix/pull/1016", "timeline": [{"oid": "b51de722492281a158ff6bd799abb224e2f227bd", "url": "https://github.com/apache/helix/commit/b51de722492281a158ff6bd799abb224e2f227bd", "message": "Add null check in close() of ZkConnectionManager\n\nJava objects may not have been fully initialized when their callback/interface methods are called. This adds a null check to ensure that an NPE does not happen.", "committedDate": "2020-05-18T20:56:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMjEwOA==", "url": "https://github.com/apache/helix/pull/1016#discussion_r426932108", "body": "It seems `_shareWatchers` is initialized outside the constructor of `ZkConnectionManager`. If `ZkConnectionManager` completes initialization, `_sharedWatchers` should also complete initialization.\r\nDoing the null check is unnecessary: an instance should be constructed well before it is used. `close()` should be called after the instance completes init. Why close() is called before the instance's state is fully initialized? We should find it out.\r\n\r\nIn one case I've known, it is related to SharedZkClient. The ZkConnection is created within sharedZkClient, before the ZK session is established, it is passed to ZkConnectionManager and ZkClient's connect(). And in ZkClient's connect, this is a check for this shared connection. Because the session is not established, zkclient has to `close()`. Meanwhile, `_shareWatchers` is not initialized.\r\n\r\nI think we should fix the root cause, instead of covering the problem with this null check. The solution should be wait until connected in SharedZkClient if this connection is newly created.\r\n```\r\n      connectionManager =\r\n          new ZkConnectionManager(createZkConnection(connectionConfig), connectInitTimeout,\r\n              connectionConfig.toString());\r\n      _connectionManagerPool.put(connectionConfig, connectionManager);\r\n```\r\n\r\nwhat do you think?", "bodyText": "It seems _shareWatchers is initialized outside the constructor of ZkConnectionManager. If ZkConnectionManager completes initialization, _sharedWatchers should also complete initialization.\nDoing the null check is unnecessary: an instance should be constructed well before it is used. close() should be called after the instance completes init. Why close() is called before the instance's state is fully initialized? We should find it out.\nIn one case I've known, it is related to SharedZkClient. The ZkConnection is created within sharedZkClient, before the ZK session is established, it is passed to ZkConnectionManager and ZkClient's connect(). And in ZkClient's connect, this is a check for this shared connection. Because the session is not established, zkclient has to close(). Meanwhile, _shareWatchers is not initialized.\nI think we should fix the root cause, instead of covering the problem with this null check. The solution should be wait until connected in SharedZkClient if this connection is newly created.\n      connectionManager =\n          new ZkConnectionManager(createZkConnection(connectionConfig), connectInitTimeout,\n              connectionConfig.toString());\n      _connectionManagerPool.put(connectionConfig, connectionManager);\n\nwhat do you think?", "bodyHTML": "<p dir=\"auto\">It seems <code>_shareWatchers</code> is initialized outside the constructor of <code>ZkConnectionManager</code>. If <code>ZkConnectionManager</code> completes initialization, <code>_sharedWatchers</code> should also complete initialization.<br>\nDoing the null check is unnecessary: an instance should be constructed well before it is used. <code>close()</code> should be called after the instance completes init. Why close() is called before the instance's state is fully initialized? We should find it out.</p>\n<p dir=\"auto\">In one case I've known, it is related to SharedZkClient. The ZkConnection is created within sharedZkClient, before the ZK session is established, it is passed to ZkConnectionManager and ZkClient's connect(). And in ZkClient's connect, this is a check for this shared connection. Because the session is not established, zkclient has to <code>close()</code>. Meanwhile, <code>_shareWatchers</code> is not initialized.</p>\n<p dir=\"auto\">I think we should fix the root cause, instead of covering the problem with this null check. The solution should be wait until connected in SharedZkClient if this connection is newly created.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"      connectionManager =\n          new ZkConnectionManager(createZkConnection(connectionConfig), connectInitTimeout,\n              connectionConfig.toString());\n      _connectionManagerPool.put(connectionConfig, connectionManager);\n\"><pre><code>      connectionManager =\n          new ZkConnectionManager(createZkConnection(connectionConfig), connectInitTimeout,\n              connectionConfig.toString());\n      _connectionManagerPool.put(connectionConfig, connectionManager);\n</code></pre></div>\n<p dir=\"auto\">what do you think?</p>", "author": "huizhilu", "createdAt": "2020-05-18T22:45:35Z", "path": "zookeeper-api/src/main/java/org/apache/helix/zookeeper/impl/factory/ZkConnectionManager.java", "diffHunk": "@@ -118,7 +118,7 @@ public void close() {\n \n   protected synchronized void close(boolean skipIfWatched) {\n     cleanupInactiveWatchers();\n-    if (_sharedWatchers.size() > 0) {\n+    if (_sharedWatchers != null && _sharedWatchers.size() > 0) {", "originalCommit": "b51de722492281a158ff6bd799abb224e2f227bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk2NzEzMg==", "url": "https://github.com/apache/helix/pull/1016#discussion_r426967132", "bodyText": "Synced offline. I missed the point ZkConnectionManager is managing connection. So there is a wait in ZkClient.\nThis NPE is thrown when ZkConnectionManager is being constructed and connection is not able to connect to ZK within timeout.", "author": "huizhilu", "createdAt": "2020-05-19T00:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzMjEwOA=="}], "type": "inlineReview"}]}