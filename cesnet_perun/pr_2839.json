{"pr_number": 2839, "pr_title": "Change of behavior in module m:d:o365EmailAddresses:mu", "pr_author": "stavamichal", "pr_createdAt": "2020-08-06T11:11:29Z", "pr_url": "https://github.com/CESNET/perun/pull/2839", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MzYwNw==", "url": "https://github.com/CESNET/perun/pull/2839#discussion_r466353607", "body": "NIT: When using the stream API, it is a best practice to use the dot notation to separate the input elements and each operation that is performed.\r\n```suggestion\r\n\t\t\tSet<Integer> groupsWithSameAttributeValueSet = sess.getPerunBl().getAttributesManagerBl().getPerunBeanIdsForUniqueAttributeValue(sess, groupO365EmailAddresses).stream()\r\n\t\t\t\t\t.map(Pair::getLeft)\r\n\t\t\t\t\t.collect(Collectors.toSet());\r\n```", "bodyText": "NIT: When using the stream API, it is a best practice to use the dot notation to separate the input elements and each operation that is performed.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tSet<Integer> groupsWithSameAttributeValueSet = sess.getPerunBl().getAttributesManagerBl().getPerunBeanIdsForUniqueAttributeValue(sess, groupO365EmailAddresses).stream().map(Pair::getLeft).collect(Collectors.toSet());\n          \n          \n            \n            \t\t\tSet<Integer> groupsWithSameAttributeValueSet = sess.getPerunBl().getAttributesManagerBl().getPerunBeanIdsForUniqueAttributeValue(sess, groupO365EmailAddresses).stream()\n          \n          \n            \n            \t\t\t\t\t.map(Pair::getLeft)\n          \n          \n            \n            \t\t\t\t\t.collect(Collectors.toSet());", "bodyHTML": "<p dir=\"auto\">NIT: When using the stream API, it is a best practice to use the dot notation to separate the input elements and each operation that is performed.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t\t<span class=\"pl-k\">Set&lt;<span class=\"pl-smi\">Integer</span>&gt;</span> groupsWithSameAttributeValueSet <span class=\"pl-k\">=</span> sess<span class=\"pl-k\">.</span>getPerunBl()<span class=\"pl-k\">.</span>getAttributesManagerBl()<span class=\"pl-k\">.</span>getPerunBeanIdsForUniqueAttributeValue(sess, groupO365EmailAddresses)<span class=\"pl-k\">.</span>stream()<span class=\"pl-k x x-first\">.</span><span class=\"x\">map(</span><span class=\"pl-smi x\">Pair</span><span class=\"pl-k x\">::</span><span class=\"x\">getLeft)</span><span class=\"pl-k x\">.</span><span class=\"x\">collect(</span><span class=\"pl-smi x\">Collectors</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">toSet());</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t\t<span class=\"pl-k\">Set&lt;<span class=\"pl-smi\">Integer</span>&gt;</span> groupsWithSameAttributeValueSet <span class=\"pl-k\">=</span> sess<span class=\"pl-k\">.</span>getPerunBl()<span class=\"pl-k\">.</span>getAttributesManagerBl()<span class=\"pl-k\">.</span>getPerunBeanIdsForUniqueAttributeValue(sess, groupO365EmailAddresses)<span class=\"pl-k\">.</span>stream()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t\t\t\t.map(<span class=\"pl-smi\">Pair</span><span class=\"pl-k\">::</span>getLeft)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t\t\t\t.collect(<span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>toSet());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Vojtech-Sassmann", "createdAt": "2020-08-06T11:43:40Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_member_attribute_def_def_o365EmailAddresses_mu.java", "diffHunk": "@@ -105,36 +103,29 @@ public void checkAttributeSemantics(PerunSessionImpl sess, Member member, Attrib\n \t\t\tthrow new WrongReferenceAttributeValueException(attribute, attrUCO, member, null, member, null, \"does not contain \" + ucoEmail);\n \t\t}\n \n-\t\t//check for duplicities among all members and groups (urn_perun_group_resource_attribute_def_def_o365EmailAddresses_mu)\n-\t\tAttributesManagerBl attributesManagerBl = sess.getPerunBl().getAttributesManagerBl();\n-\t\tSet<Pair<Integer, Integer>> memberPairs = attributesManagerBl.getPerunBeanIdsForUniqueAttributeValue(sess, attribute);\n-\t\tmemberPairs.remove(new Pair<>(member.getId(), 0));\n-\t\tif (!memberPairs.isEmpty()) {\n-\t\t\ttry {\n-\t\t\t\tMember memberWithDuplicateEmail = sess.getPerunBl().getMembersManagerBl().getMemberById(sess, memberPairs.iterator().next().getLeft());\n-\t\t\t\tthrow new WrongReferenceAttributeValueException(attribute, attribute, member, null, memberWithDuplicateEmail, null, \"some of the email addresses are already assigned.\");\n-\t\t\t} catch (MemberNotExistsException e) {\n-\t\t\t\tthrow new ConsistencyErrorException(e);\n-\t\t\t}\n-\t\t}\n-\t\tAttribute groupO365EmailAddresses = new Attribute(new urn_perun_group_resource_attribute_def_def_o365EmailAddresses_mu().getAttributeDefinition());\n-\t\tgroupO365EmailAddresses.setValue(emails);\n-\t\tSet<Pair<Integer, Integer>> groupResourcePairs = attributesManagerBl.getPerunBeanIdsForUniqueAttributeValue(sess, groupO365EmailAddresses);\n-\t\tif (!groupResourcePairs.isEmpty()) {\n-\t\t\ttry {\n-\t\t\t\tPair<Integer, Integer> GroupResourceWithDuplicateEmail = groupResourcePairs.iterator().next();\n-\t\t\t\tGroup groupWithDuplicateEmail = sess.getPerunBl().getGroupsManagerBl().getGroupById(sess, GroupResourceWithDuplicateEmail.getLeft());\n-\t\t\t\tResource resourceWithDuplicateEmail = sess.getPerunBl().getResourcesManagerBl().getResourceById(sess, GroupResourceWithDuplicateEmail.getRight());\n-\t\t\t\tthrow new WrongReferenceAttributeValueException(attribute, groupO365EmailAddresses, member, null, groupWithDuplicateEmail, resourceWithDuplicateEmail, \"some of the email addresses are already assigned.\" );\n-\t\t\t} catch (GroupNotExistsException | ResourceNotExistsException e) {\n-\t\t\t\tthrow new ConsistencyErrorException(e);\n+\t\t//No need to check duplicities between other members, cause attribute is unique\n+\t\t//Check uniqueness between this attribute and groups\n+\t\ttry {\n+\t\t\tAttribute groupO365EmailAddresses = new Attribute(sess.getPerunBl().getAttributesManagerBl().getAttributeDefinition(sess, G_D_O365_EMAIL_ADDRESSES_O365MU_ATTR));\n+\t\t\tgroupO365EmailAddresses.setValue(emails);\n+\t\t\tSet<Integer> groupsWithSameAttributeValueSet = sess.getPerunBl().getAttributesManagerBl().getPerunBeanIdsForUniqueAttributeValue(sess, groupO365EmailAddresses).stream().map(Pair::getLeft).collect(Collectors.toSet());", "originalCommit": "5e0f81fa17459981252fed9dfe4fc045913ba3ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQxMDE1Mg==", "url": "https://github.com/CESNET/perun/pull/2839#discussion_r466410152", "bodyText": "Changed.", "author": "stavamichal", "createdAt": "2020-08-06T13:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MzYwNw=="}], "type": "inlineReview"}, {"oid": "e7c8e02b5879e94a046c03567d61446f025e933d", "url": "https://github.com/CESNET/perun/commit/e7c8e02b5879e94a046c03567d61446f025e933d", "message": "Change of behavior in module m:d:o365EmailAddresses:mu\n\n - it will check duplicities with g:d:o365EmailAddressess:o365mu instead\n of gr:d:o365EmailAddresses:mu\n - logic was changed accordingly, one of them were removed becuase there\n is no need to test uniqueness in unique attribute\n - tests were changed accordingly", "committedDate": "2020-08-06T13:25:31Z", "type": "commit"}, {"oid": "e7c8e02b5879e94a046c03567d61446f025e933d", "url": "https://github.com/CESNET/perun/commit/e7c8e02b5879e94a046c03567d61446f025e933d", "message": "Change of behavior in module m:d:o365EmailAddresses:mu\n\n - it will check duplicities with g:d:o365EmailAddressess:o365mu instead\n of gr:d:o365EmailAddresses:mu\n - logic was changed accordingly, one of them were removed becuase there\n is no need to test uniqueness in unique attribute\n - tests were changed accordingly", "committedDate": "2020-08-06T13:25:31Z", "type": "forcePushed"}]}