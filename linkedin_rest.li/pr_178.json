{"pr_number": 178, "pr_title": "Fix for DataTranslator where PegasusToAvroDefaultFieldTranslation mode throws unexpcted exception", "pr_author": "junchuanwang", "pr_createdAt": "2020-02-20T00:14:01Z", "pr_url": "https://github.com/linkedin/rest.li/pull/178", "timeline": [{"oid": "70073df381beeadb5e1cfb259f20fad6eb4de519", "url": "https://github.com/linkedin/rest.li/commit/70073df381beeadb5e1cfb259f20fad6eb4de519", "message": "Fix for DataTranslator where PegasusToAvroDefaultFieldTranslation mode throws unexpcted exception", "committedDate": "2020-02-19T23:25:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzNDQ5OA==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r381634498", "body": "nit: \"whether the Avro map **is** generated from..\"", "bodyText": "nit: \"whether the Avro map is generated from..\"", "bodyHTML": "<p dir=\"auto\">nit: \"whether the Avro map <strong>is</strong> generated from..\"</p>", "author": "nickibi", "createdAt": "2020-02-20T00:59:50Z", "path": "data-avro/src/test/java/com/linkedin/data/avro/TestDataTranslator.java", "diffHunk": "@@ -1154,48 +1158,211 @@ private void testDataTranslation(String schemaText, String[][] row) throws IOExc\n \n   @DataProvider\n   public Object[][] defaultToAvroOptionalTranslationProvider() {\n-    // This test simulates the case where the DataMap for update is empty\n-    // Each object array contains four element,\n+    // These tests test DataMap translation under different PegasusToAvroDefaultFieldTranslationMode modes.\n+    // it will test whether the Avro map generated from expected AvroJsonString is as expected.", "originalCommit": "70073df381beeadb5e1cfb259f20fad6eb4de519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI0OTY1NQ==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r382249655", "bodyText": "If he adds this extra \"is\", then he has to remove the \"is\" at the end of the sentence.", "author": "evanw555", "createdAt": "2020-02-20T20:49:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzNDQ5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzNDY4Mg==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r381634682", "body": "nit: element**s**", "bodyText": "nit: elements", "bodyHTML": "<p dir=\"auto\">nit: element<strong>s</strong></p>", "author": "nickibi", "createdAt": "2020-02-20T01:00:32Z", "path": "data-avro/src/test/java/com/linkedin/data/avro/TestDataTranslator.java", "diffHunk": "@@ -1154,48 +1158,211 @@ private void testDataTranslation(String schemaText, String[][] row) throws IOExc\n \n   @DataProvider\n   public Object[][] defaultToAvroOptionalTranslationProvider() {\n-    // This test simulates the case where the DataMap for update is empty\n-    // Each object array contains four element,\n+    // These tests test DataMap translation under different PegasusToAvroDefaultFieldTranslationMode modes.\n+    // it will test whether the Avro map generated from expected AvroJsonString is as expected.\n+    // Each object array contains eight element,", "originalCommit": "70073df381beeadb5e1cfb259f20fad6eb4de519", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzNDk3Mw==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r381634973", "body": "nit: remove \"and\"", "bodyText": "nit: remove \"and\"", "bodyHTML": "<p dir=\"auto\">nit: remove \"and\"</p>", "author": "nickibi", "createdAt": "2020-02-20T01:01:33Z", "path": "data-avro/src/test/java/com/linkedin/data/avro/TestDataTranslator.java", "diffHunk": "@@ -1154,48 +1158,211 @@ private void testDataTranslation(String schemaText, String[][] row) throws IOExc\n \n   @DataProvider\n   public Object[][] defaultToAvroOptionalTranslationProvider() {\n-    // This test simulates the case where the DataMap for update is empty\n-    // Each object array contains four element,\n+    // These tests test DataMap translation under different PegasusToAvroDefaultFieldTranslationMode modes.\n+    // it will test whether the Avro map generated from expected AvroJsonString is as expected.\n+    // Each object array contains eight element,\n     // 1. first element is the schema Text,\n-    // 2. second element is the String representation of the data map\n-    // 3. third element is the dataTranslationMode for the default field and\n-    // 4. fourth element is is the expected AvroJsonString after translation\n-    // The test will test whether the Avro map generated from expected AvroJsonString is as expected from the program\n+    // 2. second element is the schema translation mode\n+    // 3. third element is the expected schema translation outcome\n+    // 4. fourth element is the String representation of the data map\n+    // 5. fifth element is the dataTranslationMode for the default field and", "originalCommit": "70073df381beeadb5e1cfb259f20fad6eb4de519", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzNTA1OQ==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r381635059", "body": "nit: remove extra \"is\"", "bodyText": "nit: remove extra \"is\"", "bodyHTML": "<p dir=\"auto\">nit: remove extra \"is\"</p>", "author": "nickibi", "createdAt": "2020-02-20T01:01:53Z", "path": "data-avro/src/test/java/com/linkedin/data/avro/TestDataTranslator.java", "diffHunk": "@@ -1154,48 +1158,211 @@ private void testDataTranslation(String schemaText, String[][] row) throws IOExc\n \n   @DataProvider\n   public Object[][] defaultToAvroOptionalTranslationProvider() {\n-    // This test simulates the case where the DataMap for update is empty\n-    // Each object array contains four element,\n+    // These tests test DataMap translation under different PegasusToAvroDefaultFieldTranslationMode modes.\n+    // it will test whether the Avro map generated from expected AvroJsonString is as expected.\n+    // Each object array contains eight element,\n     // 1. first element is the schema Text,\n-    // 2. second element is the String representation of the data map\n-    // 3. third element is the dataTranslationMode for the default field and\n-    // 4. fourth element is is the expected AvroJsonString after translation\n-    // The test will test whether the Avro map generated from expected AvroJsonString is as expected from the program\n+    // 2. second element is the schema translation mode\n+    // 3. third element is the expected schema translation outcome\n+    // 4. fourth element is the String representation of the data map\n+    // 5. fifth element is the dataTranslationMode for the default field and\n+    // 6. sixth element is is the expected AvroJsonString after translation", "originalCommit": "70073df381beeadb5e1cfb259f20fad6eb4de519", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI1MDIwOA==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r382250208", "body": "nit: remove space after the dot", "bodyText": "nit: remove space after the dot", "bodyHTML": "<p dir=\"auto\">nit: remove space after the dot</p>", "author": "evanw555", "createdAt": "2020-02-20T20:50:57Z", "path": "data-avro/src/main/java/com/linkedin/data/avro/DataTranslator.java", "diffHunk": "@@ -642,10 +641,20 @@ private Object translate(Object value, DataSchema dataSchema, Schema avroSchema)\n             }\n             else if (fieldValue == null)\n             {\n+              // if no fieldValue present, either NULL value or defaultValue will be assigned\n               Object defaultValue = field.getDefault();\n               if (defaultValue != null)\n               {\n-                fieldValue = defaultValue;\n+                if (_dataTranslationOptions == null || ((DataMapToAvroRecordTranslationOptions) _dataTranslationOptions). getDefaultFieldDataTranslationMode()", "originalCommit": "70073df381beeadb5e1cfb259f20fad6eb4de519", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI1MTYxOQ==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r382251619", "body": "You've said this is only for debug, but it's not actually used in the code you intend to commit. You should delete it.", "bodyText": "You've said this is only for debug, but it's not actually used in the code you intend to commit. You should delete it.", "bodyHTML": "<p dir=\"auto\">You've said this is only for debug, but it's not actually used in the code you intend to commit. You should delete it.</p>", "author": "evanw555", "createdAt": "2020-02-20T20:53:49Z", "path": "data-avro/src/test/java/com/linkedin/data/avro/TestDataTranslator.java", "diffHunk": "@@ -50,6 +52,8 @@\n \n public class TestDataTranslator\n {\n+  private static final Logger LOG = LoggerFactory.getLogger(TestDataTranslator.class);", "originalCommit": "70073df381beeadb5e1cfb259f20fad6eb4de519", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI1MzAzNA==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r382253034", "body": "I originally left this comment, which I'm still curious about.\r\n\r\n> Based on my understanding, this if-statement is just used to determine if the field schema was converted to a union. This doesn't seem to be consistent with the logic that actually determines whether to convert the schema field to a union.", "bodyText": "I originally left this comment, which I'm still curious about.\n\nBased on my understanding, this if-statement is just used to determine if the field schema was converted to a union. This doesn't seem to be consistent with the logic that actually determines whether to convert the schema field to a union.", "bodyHTML": "<p dir=\"auto\">I originally left this comment, which I'm still curious about.</p>\n<blockquote>\n<p dir=\"auto\">Based on my understanding, this if-statement is just used to determine if the field schema was converted to a union. This doesn't seem to be consistent with the logic that actually determines whether to convert the schema field to a union.</p>\n</blockquote>", "author": "evanw555", "createdAt": "2020-02-20T20:56:40Z", "path": "data-avro/src/main/java/com/linkedin/data/avro/DataTranslator.java", "diffHunk": "@@ -609,18 +609,17 @@ private Object translate(Object value, DataSchema dataSchema, Schema avroSchema)\n             Schema fieldAvroSchema = avroField.schema();\n             Object fieldValue = map.get(fieldName);\n             boolean isOptional = field.getOptional();\n-            if (isOptional  || (\n-                _dataTranslationOptions != null &&\n-                ((DataMapToAvroRecordTranslationOptions) _dataTranslationOptions). getDefaultFieldDataTranslationMode()\n-                    == PegasusToAvroDefaultFieldTranslationMode.DO_NOT_TRANSLATE))\n+            if (isOptional)", "originalCommit": "70073df381beeadb5e1cfb259f20fad6eb4de519", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjg3NDI3MQ==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r382874271", "bodyText": "After arguing for a few hours, I've come to the conclusion that the way you're doing it here is valid.", "author": "evanw555", "createdAt": "2020-02-22T01:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI1MzAzNA=="}], "type": "inlineReview"}, {"oid": "87c54e7f88d68aa654624ba9117901405358af1d", "url": "https://github.com/linkedin/rest.li/commit/87c54e7f88d68aa654624ba9117901405358af1d", "message": "resolve evanw555 and nickibi's comments", "committedDate": "2020-02-24T18:43:36Z", "type": "commit"}, {"oid": "c8f811131ae4521582841f35b2c24bcdc8d1db21", "url": "https://github.com/linkedin/rest.li/commit/c8f811131ae4521582841f35b2c24bcdc8d1db21", "message": "Merge branch 'master' into junchuan_defaultFieldTranslation_fix", "committedDate": "2020-02-24T18:47:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU5MTc1Mg==", "url": "https://github.com/linkedin/rest.li/pull/178#discussion_r383591752", "body": "Generally LGTM, though the documentation here could be drastically improved. This would help to avoid long conversations in the future to figure out what's going on here. It looks like you already added a few, but here are my suggested edits:\r\n\r\n> // process optional fields\r\n\r\nThis comment is unnecessary, since the `isOptional` condition above is clear.\r\n\r\nAdd a comment like this:\r\n\r\n```\r\nif (fieldDataSchema.getDereferencedType() != DataSchema.Type.UNION)\r\n{\r\n  // Translating from a non-union pegasus type to an embedded union type in Avro\r\n  if (fieldValue == null)\r\n```\r\n\r\n> // optional field will be represented as union in Avro\r\n\r\nThis doesn't really explain what's happening here. I'd suggest:\r\n```\r\n// Extract the Avro type corresponding to the pegasus type from the Avro union\r\n```\r\n\r\n> // already a union\r\n\r\nShould be something like:\r\n```\r\n// Translating from a pegasus union to an Avro union\r\n```\r\n\r\n> // if no fieldValue present, either NULL value or defaultValue will be assigned\r\n\r\nShould be a little more descriptive:\r\n\r\n```\r\n// Required field is missing, assign default value if present\r\n```\r\n\r\nThen add another comment in the subcondition saying:\r\n\r\n```\r\n// Translate default value as null, depending on specified options\r\n```\r\n\r\nAt the end of the _whole_ if-statement, add a comment saying something like:\r\n\r\n```\r\n// Translate the pegasus field data to Avro data\r\n```", "bodyText": "Generally LGTM, though the documentation here could be drastically improved. This would help to avoid long conversations in the future to figure out what's going on here. It looks like you already added a few, but here are my suggested edits:\n\n// process optional fields\n\nThis comment is unnecessary, since the isOptional condition above is clear.\nAdd a comment like this:\nif (fieldDataSchema.getDereferencedType() != DataSchema.Type.UNION)\n{\n  // Translating from a non-union pegasus type to an embedded union type in Avro\n  if (fieldValue == null)\n\n\n// optional field will be represented as union in Avro\n\nThis doesn't really explain what's happening here. I'd suggest:\n// Extract the Avro type corresponding to the pegasus type from the Avro union\n\n\n// already a union\n\nShould be something like:\n// Translating from a pegasus union to an Avro union\n\n\n// if no fieldValue present, either NULL value or defaultValue will be assigned\n\nShould be a little more descriptive:\n// Required field is missing, assign default value if present\n\nThen add another comment in the subcondition saying:\n// Translate default value as null, depending on specified options\n\nAt the end of the whole if-statement, add a comment saying something like:\n// Translate the pegasus field data to Avro data", "bodyHTML": "<p dir=\"auto\">Generally LGTM, though the documentation here could be drastically improved. This would help to avoid long conversations in the future to figure out what's going on here. It looks like you already added a few, but here are my suggested edits:</p>\n<blockquote>\n<p dir=\"auto\">// process optional fields</p>\n</blockquote>\n<p dir=\"auto\">This comment is unnecessary, since the <code>isOptional</code> condition above is clear.</p>\n<p dir=\"auto\">Add a comment like this:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"if (fieldDataSchema.getDereferencedType() != DataSchema.Type.UNION)\n{\n  // Translating from a non-union pegasus type to an embedded union type in Avro\n  if (fieldValue == null)\"><pre><code>if (fieldDataSchema.getDereferencedType() != DataSchema.Type.UNION)\n{\n  // Translating from a non-union pegasus type to an embedded union type in Avro\n  if (fieldValue == null)\n</code></pre></div>\n<blockquote>\n<p dir=\"auto\">// optional field will be represented as union in Avro</p>\n</blockquote>\n<p dir=\"auto\">This doesn't really explain what's happening here. I'd suggest:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"// Extract the Avro type corresponding to the pegasus type from the Avro union\"><pre><code>// Extract the Avro type corresponding to the pegasus type from the Avro union\n</code></pre></div>\n<blockquote>\n<p dir=\"auto\">// already a union</p>\n</blockquote>\n<p dir=\"auto\">Should be something like:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"// Translating from a pegasus union to an Avro union\"><pre><code>// Translating from a pegasus union to an Avro union\n</code></pre></div>\n<blockquote>\n<p dir=\"auto\">// if no fieldValue present, either NULL value or defaultValue will be assigned</p>\n</blockquote>\n<p dir=\"auto\">Should be a little more descriptive:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"// Required field is missing, assign default value if present\"><pre><code>// Required field is missing, assign default value if present\n</code></pre></div>\n<p dir=\"auto\">Then add another comment in the subcondition saying:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"// Translate default value as null, depending on specified options\"><pre><code>// Translate default value as null, depending on specified options\n</code></pre></div>\n<p dir=\"auto\">At the end of the <em>whole</em> if-statement, add a comment saying something like:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"// Translate the pegasus field data to Avro data\"><pre><code>// Translate the pegasus field data to Avro data\n</code></pre></div>", "author": "evanw555", "createdAt": "2020-02-25T00:20:20Z", "path": "data-avro/src/main/java/com/linkedin/data/avro/DataTranslator.java", "diffHunk": "@@ -609,18 +609,17 @@ private Object translate(Object value, DataSchema dataSchema, Schema avroSchema)\n             Schema fieldAvroSchema = avroField.schema();\n             Object fieldValue = map.get(fieldName);\n             boolean isOptional = field.getOptional();\n-            if (isOptional  || (\n-                _dataTranslationOptions != null &&\n-                ((DataMapToAvroRecordTranslationOptions) _dataTranslationOptions). getDefaultFieldDataTranslationMode()\n-                    == PegasusToAvroDefaultFieldTranslationMode.DO_NOT_TRANSLATE))\n+            if (isOptional)\n             {\n+              // process optional fields", "originalCommit": "c8f811131ae4521582841f35b2c24bcdc8d1db21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "33a97a7f2c7a9767cd2cce9c103fe633bbb362f2", "url": "https://github.com/linkedin/rest.li/commit/33a97a7f2c7a9767cd2cce9c103fe633bbb362f2", "message": "revise code comments after PR feedback", "committedDate": "2020-02-25T19:10:37Z", "type": "commit"}, {"oid": "6f2f1683758cf87486a348e7296a2ebe3b221e94", "url": "https://github.com/linkedin/rest.li/commit/6f2f1683758cf87486a348e7296a2ebe3b221e94", "message": "Merge branch 'master' into junchuan_defaultFieldTranslation_fix", "committedDate": "2020-02-25T21:26:48Z", "type": "commit"}, {"oid": "3e6b8603b702f38c5b907191d0583535535bbf41", "url": "https://github.com/linkedin/rest.li/commit/3e6b8603b702f38c5b907191d0583535535bbf41", "message": "Fix for DataTranslator where PegasusToAvroDefaultFieldTranslation mode throws unexpcted exception (#178)\nR=evanw555, nickibi\nA=evanw555, nickibi", "committedDate": "2020-02-25T21:27:20Z", "type": "commit"}]}