{"pr_number": 9149, "pr_title": "Map and inject Mgw throttling Extensions To Default extensions when importing an API definition", "pr_author": "Chamindu36", "pr_createdAt": "2020-08-07T07:32:55Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/9149", "timeline": [{"oid": "b4d88b19c1ccc478ade304bb302a6026ba62fb00", "url": "https://github.com/wso2/carbon-apimgt/commit/b4d88b19c1ccc478ade304bb302a6026ba62fb00", "message": "Support mutual ssl mandatory option with vendor extensions", "committedDate": "2020-08-06T22:52:05Z", "type": "commit"}, {"oid": "2498dd4b615305a1103a08602e8e086a18d15826", "url": "https://github.com/wso2/carbon-apimgt/commit/2498dd4b615305a1103a08602e8e086a18d15826", "message": "Map and inject Mgw Throttling Extensions To Default extensions", "committedDate": "2020-08-06T22:52:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzY1OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913659", "body": "Shall we move this to https://github.com/wso2/carbon-apimgt/blob/62dbf8e46ccaa067d8bf5c1f4ed028502fd2111f/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OASParserUtil.java#L1325-L1329", "bodyText": "Shall we move this to \n  \n    \n      carbon-apimgt/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OASParserUtil.java\n    \n    \n        Lines 1325 to 1329\n      in\n      62dbf8e\n    \n    \n    \n    \n\n        \n          \n           public static String preProcess(String swaggerContent) throws APIManagementException { \n        \n\n        \n          \n               //Load required properties from swagger to the API \n        \n\n        \n          \n               APIDefinition apiDefinition = getOASParser(swaggerContent); \n        \n\n        \n          \n               return apiDefinition.processOtherSchemeScopes(swaggerContent); \n        \n\n        \n          \n           }", "bodyHTML": "<p dir=\"auto\">Shall we move this to <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/wso2/carbon-apimgt/blob/62dbf8e46ccaa067d8bf5c1f4ed028502fd2111f/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OASParserUtil.java#L1325-L1329\">carbon-apimgt/components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OASParserUtil.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 1325 to 1329\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/wso2/carbon-apimgt/commit/62dbf8e46ccaa067d8bf5c1f4ed028502fd2111f\">62dbf8e</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L1325\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1325\"></td>\n          <td id=\"LC1325\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">String</span> <span class=\"pl-en\">preProcess</span>(<span class=\"pl-smi\">String</span> <span class=\"pl-v\">swaggerContent</span>) <span class=\"pl-k\">throws</span> <span class=\"pl-smi\">APIManagementException</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1326\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1326\"></td>\n          <td id=\"LC1326\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-c\"><span class=\"pl-c\">//</span>Load required properties from swagger to the API</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1327\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1327\"></td>\n          <td id=\"LC1327\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-smi\">APIDefinition</span> apiDefinition <span class=\"pl-k\">=</span> getOASParser(swaggerContent); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1328\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1328\"></td>\n          <td id=\"LC1328\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">return</span> apiDefinition<span class=\"pl-k\">.</span>processOtherSchemeScopes(swaggerContent); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1329\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1329\"></td>\n          <td id=\"LC1329\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "malinthaprasan", "createdAt": "2020-08-07T08:58:04Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1276,6 +1276,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         if (!isDefaultGiven(swaggerContent)) {\n             Swagger swagger = getSwagger(swaggerContent);\n+            swagger = injectMgwThrottlingExtensionsToDefault(swagger);", "originalCommit": "2498dd4b615305a1103a08602e8e086a18d15826", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzc5MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913790", "body": "make it an interface method of API definition and implement it here. \r\nSo you can call it from preProcess method above", "bodyText": "make it an interface method of API definition and implement it here.\nSo you can call it from preProcess method above", "bodyHTML": "<p dir=\"auto\">make it an interface method of API definition and implement it here.<br>\nSo you can call it from preProcess method above</p>", "author": "malinthaprasan", "createdAt": "2020-08-07T08:58:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1285,36 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swagger Swagger\n+     * @return Swagger\n+     * @throws APIManagementException\n+     */\n+    private Swagger injectMgwThrottlingExtensionsToDefault(Swagger swagger) throws APIManagementException {", "originalCommit": "2498dd4b615305a1103a08602e8e086a18d15826", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjkxMzg5NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466913894", "body": "same here", "bodyText": "same here", "bodyHTML": "<p dir=\"auto\">same here</p>", "author": "malinthaprasan", "createdAt": "2020-08-07T08:58:31Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1344,6 +1347,7 @@ private boolean isDefaultGiven(String swaggerContent) throws APIManagementExcept\n     @Override\n     public String processOtherSchemeScopes(String swaggerContent) throws APIManagementException {\n         OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        openAPI = injectMgwThrottlingExtensionsToDefault(openAPI);", "originalCommit": "2498dd4b615305a1103a08602e8e086a18d15826", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "url": "https://github.com/wso2/carbon-apimgt/commit/ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "message": "Adding suggestions", "committedDate": "2020-08-07T09:44:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjEwOQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946109", "body": "Do we need these 3 lines?", "bodyText": "Do we need these 3 lines?", "bodyHTML": "<p dir=\"auto\">Do we need these 3 lines?</p>", "author": "malinthaprasan", "createdAt": "2020-08-07T10:03:34Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS2Parser.java", "diffHunk": "@@ -1284,6 +1284,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns swagger definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in swagger file(Swagger version 2)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        Swagger swagger = getSwagger(swaggerContent);\n+        Map<String, Path> paths = swagger.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<HttpMethod, Operation> operationsMap = paths.get(pathKey).getOperationMap();\n+            for (Map.Entry<HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getVendorExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {\n+                    Object tier = extensions.get(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.remove(APIConstants.X_WSO2_THROTTLING_TIER);\n+                    extensions.put(APIConstants.SWAGGER_X_THROTTLING_TIER, tier);\n+                }\n+                operation.setVendorExtensions(extensions);\n+                entry.setValue(operation);\n+                operationsMap.put(entry.getKey(), operation);", "originalCommit": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Njk0NjE3NA==", "url": "https://github.com/wso2/carbon-apimgt/pull/9149#discussion_r466946174", "body": "same here.", "bodyText": "same here.", "bodyHTML": "<p dir=\"auto\">same here.</p>", "author": "malinthaprasan", "createdAt": "2020-08-07T10:03:45Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/definitions/OAS3Parser.java", "diffHunk": "@@ -1378,6 +1381,38 @@ public String processOtherSchemeScopes(String swaggerContent) throws APIManageme\n         return swaggerContent;\n     }\n \n+    /**\n+     * This method returns openAPI definition which replaced X-WSO2-throttling-tier extension comes from\n+     * mgw with X-throttling-tier extensions in openAPI file(openAPI version 3)\n+     *\n+     * @param swaggerContent String\n+     * @return String\n+     * @throws APIManagementException\n+     */\n+    @Override\n+    public String injectMgwThrottlingExtensionsToDefault(String swaggerContent) throws APIManagementException {\n+        OpenAPI openAPI = getOpenAPI(swaggerContent);\n+        Paths paths = openAPI.getPaths();\n+        for (String pathKey : paths.keySet()) {\n+            Map<PathItem.HttpMethod, Operation> operationsMap = paths.get(pathKey).readOperationsMap();\n+            for (Map.Entry<PathItem.HttpMethod, Operation> entry : operationsMap.entrySet()) {\n+                Operation operation = entry.getValue();\n+                Map<String, Object> extensions = operation.getExtensions();\n+                if (extensions.containsKey(APIConstants.X_WSO2_THROTTLING_TIER)) {", "originalCommit": "ffc073eefb5915ac13e81dd0f05a272103e3cd7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7745658f173c640098add6907c5d8f6404084586", "url": "https://github.com/wso2/carbon-apimgt/commit/7745658f173c640098add6907c5d8f6404084586", "message": "Fixing commented reviews", "committedDate": "2020-08-07T10:48:15Z", "type": "commit"}]}