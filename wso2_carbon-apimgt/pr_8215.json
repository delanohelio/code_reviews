{"pr_number": 8215, "pr_title": "Removing the hardcoded system apps names in the logout handler and retrieve from system apps db table", "pr_author": "CrowleyRajapakse", "pr_createdAt": "2020-02-18T11:51:18Z", "pr_url": "https://github.com/wso2/carbon-apimgt/pull/8215", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMTA3MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380631070", "body": "Can't we remove this new line and keep as a single line?", "bodyText": "Can't we remove this new line and keep as a single line?", "bodyHTML": "<p dir=\"auto\">Can't we remove this new line and keep as a single line?</p>", "author": "menakaj", "createdAt": "2020-02-18T12:05:57Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/SessionDataPublisherImpl.java", "diffHunk": "@@ -123,6 +123,19 @@\n                         .getUserName(), e);\n             }\n         }\n+        SystemApplicationDAO systemApplicationDAO = new SystemApplicationDAO();\n+        try {\n+            systemApplicationDTOS = systemApplicationDAO.getApplications(tenantDomain);\n+            if (systemApplicationDTOS.length < 0) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(", "originalCommit": "8087fdb1e4e23297fdf21c6079e0af669b1414c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMTM3MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380631370", "bodyText": "Also add a space before \"doesn't\"\n\"The tenant: \" + tenantDomain + \" doesn't have any system apps\"", "author": "menakaj", "createdAt": "2020-02-18T12:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMTA3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzNTU0NQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380635545", "bodyText": "resolved", "author": "CrowleyRajapakse", "createdAt": "2020-02-18T12:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMTA3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMjA3OA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380632078", "body": "Remove the concatenation and keep in a single line.\r\n\r\n        `public static final String GET__APPLICATIONS = \"SELECT * FROM AM_SYSTEM_APPS WHERE TENANT_DOMAIN = ?\";`", "bodyText": "Remove the concatenation and keep in a single line.\n    `public static final String GET__APPLICATIONS = \"SELECT * FROM AM_SYSTEM_APPS WHERE TENANT_DOMAIN = ?\";`", "bodyHTML": "<p dir=\"auto\">Remove the concatenation and keep in a single line.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    `public static final String GET__APPLICATIONS = &quot;SELECT * FROM AM_SYSTEM_APPS WHERE TENANT_DOMAIN = ?&quot;;`\n\"><pre><code>    `public static final String GET__APPLICATIONS = \"SELECT * FROM AM_SYSTEM_APPS WHERE TENANT_DOMAIN = ?\";`\n</code></pre></div>", "author": "menakaj", "createdAt": "2020-02-18T12:08:19Z", "path": "components/apimgt/org.wso2.carbon.apimgt.impl/src/main/java/org/wso2/carbon/apimgt/impl/dao/constants/SQLConstants.java", "diffHunk": "@@ -3403,6 +3403,9 @@\n                 \"INSERT INTO AM_SYSTEM_APPS \" + \"(NAME,CONSUMER_KEY,CONSUMER_SECRET,TENANT_DOMAIN,CREATED_TIME) \" +\n                         \"VALUES (?,?,?,?,?)\";\n \n+        public static final String GET__APPLICATIONS =", "originalCommit": "8087fdb1e4e23297fdf21c6079e0af669b1414c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMjc1Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380632753", "bodyText": "Ther are two _ characters in the variable.", "author": "menakaj", "createdAt": "2020-02-18T12:09:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMjA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzNTQ3Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380635473", "bodyText": "resolved", "author": "CrowleyRajapakse", "createdAt": "2020-02-18T12:15:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMjA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMzk4MA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380633980", "body": "Format the code", "bodyText": "Format the code", "bodyHTML": "<p dir=\"auto\">Format the code</p>", "author": "malinthaprasan", "createdAt": "2020-02-18T12:12:29Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/SessionDataPublisherImpl.java", "diffHunk": "@@ -136,11 +149,15 @@\n                     e);\n         }\n \n-        for (OAuthConsumerAppDTO appDTO : appDTOs) {\n-            if (StringUtils.equalsIgnoreCase(DEVPORTAL_CLIENT_APP_NAME_OLD, appDTO.getApplicationName()) ||\n-                    StringUtils.equalsIgnoreCase(DEVPORTAL_CLIENT_APP_NAME, appDTO.getApplicationName()) ||\n-                    StringUtils.equalsIgnoreCase(PUBLISHER_CLIENT_APP_NAME_OLD, appDTO.getApplicationName()) ||\n-                    StringUtils.equalsIgnoreCase(PUBLISHER_CLIENT_APP_NAME, appDTO.getApplicationName())) {\n+        for(OAuthConsumerAppDTO appDTO : appDTOs){\n+            for(SystemApplicationDTO systemApplicationDTO : systemApplicationDTOS) {\n+                if(StringUtils.equalsIgnoreCase(appDTO.getOauthConsumerKey(),systemApplicationDTO.getConsumerKey())){\n+                    revokeAppList.add(appDTO);\n+                }\n+            }\n+        }", "originalCommit": "8087fdb1e4e23297fdf21c6079e0af669b1414c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg0MTQ4Mw==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r381841483", "bodyText": "resolved", "author": "CrowleyRajapakse", "createdAt": "2020-02-20T08:16:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzMzk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzNDMwMg==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r380634302", "body": "Can we continue when error happens?", "bodyText": "Can we continue when error happens?", "bodyHTML": "<p dir=\"auto\">Can we continue when error happens?</p>", "author": "malinthaprasan", "createdAt": "2020-02-18T12:13:15Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/SessionDataPublisherImpl.java", "diffHunk": "@@ -123,6 +123,19 @@\n                         .getUserName(), e);\n             }\n         }\n+        SystemApplicationDAO systemApplicationDAO = new SystemApplicationDAO();\n+        try {\n+            systemApplicationDTOS = systemApplicationDAO.getApplications(tenantDomain);\n+            if (systemApplicationDTOS.length < 0) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\n+                            \"The tenant: \" + tenantDomain + \"doesn't have any system apps\");\n+                }\n+            }\n+        } catch (APIMgtDAOException e) {\n+            log.error(\"Error thrown while retrieving system applications for the tenant domain\" + tenantDomain, e);", "originalCommit": "8087fdb1e4e23297fdf21c6079e0af669b1414c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg0NDQwMA==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r381844400", "bodyText": "Yes, then there won't be any tokens related to system apps will be revoked and will log that above error message, but will terminate the user session from IDP side and user will be logged out of the client.\nTherefore, if there is an issue in database connections, it will not affect the logout flow. The downside is, then the tokens related to that user also won't get revoked.", "author": "CrowleyRajapakse", "createdAt": "2020-02-20T08:23:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDYzNDMwMg=="}], "type": "inlineReview"}, {"oid": "16190b973ce0e8465eb0ce75f30bb1a546681bd5", "url": "https://github.com/wso2/carbon-apimgt/commit/16190b973ce0e8465eb0ce75f30bb1a546681bd5", "message": "removing the hardcorded system apps names in the logout handler and retrieving from system apps db table", "committedDate": "2020-02-18T12:14:55Z", "type": "forcePushed"}, {"oid": "3099e5e2754fef6a69bd0d33eab45967c2268413", "url": "https://github.com/wso2/carbon-apimgt/commit/3099e5e2754fef6a69bd0d33eab45967c2268413", "message": "removing the hardcorded system apps names in the logout handler and retrieving from system apps db table", "committedDate": "2020-02-20T04:58:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg0NzUwMQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r381847501", "body": "```suggestion\r\n            log.error(\"Error thrown while retrieving system applications for the tenant domain \" + tenantDomain, e);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.error(\"Error thrown while retrieving system applications for the tenant domain\" + tenantDomain, e);\n          \n          \n            \n                        log.error(\"Error thrown while retrieving system applications for the tenant domain \" + tenantDomain, e);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            log<span class=\"pl-k\">.</span>error(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Error thrown while retrieving system applications for the tenant domain<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> tenantDomain, e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            log<span class=\"pl-k\">.</span>error(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Error thrown while retrieving system applications for the tenant domain<span class=\"x x-first x-last\"> </span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> tenantDomain, e);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "fazlan-nazeem", "createdAt": "2020-02-20T08:30:12Z", "path": "components/apimgt/org.wso2.carbon.apimgt.keymgt/src/main/java/org/wso2/carbon/apimgt/keymgt/handlers/SessionDataPublisherImpl.java", "diffHunk": "@@ -123,6 +123,18 @@\n                         .getUserName(), e);\n             }\n         }\n+        SystemApplicationDAO systemApplicationDAO = new SystemApplicationDAO();\n+        try {\n+            systemApplicationDTOS = systemApplicationDAO.getApplications(tenantDomain);\n+            if (systemApplicationDTOS.length < 0) {\n+                if (log.isDebugEnabled()) {\n+                    log.debug(\"The tenant: \" + tenantDomain + \" doesn't have any system apps\");\n+                }\n+            }\n+        } catch (APIMgtDAOException e) {\n+            log.error(\"Error thrown while retrieving system applications for the tenant domain\" + tenantDomain, e);", "originalCommit": "3099e5e2754fef6a69bd0d33eab45967c2268413", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg3MDc2OQ==", "url": "https://github.com/wso2/carbon-apimgt/pull/8215#discussion_r381870769", "bodyText": "changed and resolved", "author": "CrowleyRajapakse", "createdAt": "2020-02-20T09:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg0NzUwMQ=="}], "type": "inlineReview"}, {"oid": "cc039d4795c3c62bbc8991c0f80773275ccc4f0c", "url": "https://github.com/wso2/carbon-apimgt/commit/cc039d4795c3c62bbc8991c0f80773275ccc4f0c", "message": "removing the hardcorded system apps names in the logout handler and retrieving from system apps db table", "committedDate": "2020-02-20T09:14:12Z", "type": "commit"}, {"oid": "cc039d4795c3c62bbc8991c0f80773275ccc4f0c", "url": "https://github.com/wso2/carbon-apimgt/commit/cc039d4795c3c62bbc8991c0f80773275ccc4f0c", "message": "removing the hardcorded system apps names in the logout handler and retrieving from system apps db table", "committedDate": "2020-02-20T09:14:12Z", "type": "forcePushed"}]}