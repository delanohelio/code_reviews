{"pr_number": 1738, "pr_title": "JBTM-3245 report request and response filter processing failures back\u2026", "pr_author": "mmusgrov", "pr_createdAt": "2020-12-04T19:27:15Z", "pr_url": "https://github.com/jbosstm/narayana/pull/1738", "merge_commit": "26a149dfb5797ed619f5fde5526550191c27a903", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537452148", "body": "I wonder what is the benefit for having this `verbose` flag here. My opinion is that when the LRA is not created it's generally usable to understand the reason. The `throwGenericLRAException` was changed to contain this information in case of error. Then the `verbose` flag won't provide more information, will it?", "bodyText": "I wonder what is the benefit for having this verbose flag here. My opinion is that when the LRA is not created it's generally usable to understand the reason. The throwGenericLRAException was changed to contain this information in case of error. Then the verbose flag won't provide more information, will it?", "bodyHTML": "<p dir=\"auto\">I wonder what is the benefit for having this <code>verbose</code> flag here. My opinion is that when the LRA is not created it's generally usable to understand the reason. The <code>throwGenericLRAException</code> was changed to contain this information in case of error. Then the <code>verbose</code> flag won't provide more information, will it?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:00:49Z", "path": "rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -265,13 +287,17 @@ public URI startLRA(URI parentLRA, String clientID, Long timeout, ChronoUnit uni\n                 .queryParam(TIMELIMIT_PARAM_NAME, Duration.of(timeout, unit).toMillis())\n                 .queryParam(PARENT_LRA_PARAM_NAME, encodedParentLRA)\n                 .request()\n-                .post(null);\n+                .async()\n+                .post(null)\n+                .get(CLIENT_TIMEOUT, TimeUnit.SECONDS);\n \n             // validate the HTTP status code says an LRA resource was created\n             if (isUnexpectedResponseStatus(response, Response.Status.CREATED)) {\n                 String responseEntity = response.hasEntity() ? response.readEntity(String.class) : \"\";\n-                LRALogger.i18NLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n-                throwGenericLRAException(null, INTERNAL_SERVER_ERROR.getStatusCode(),\n+                if (verbose) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjIyNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606225", "bodyText": "The code is generating a stacktrace and that is not useful. The user wants a new LRA but the system responsible for fulfilling that request is not available. I don't think that is a good reason to start generating stack traces in the logs (this is a distributed system and Availability cannot be guaranteed - ie it is an expected condition).\nLRA operates in an environment where failure/unavailability conditions are the norm and dumping stacktraces is not the way to go, it gives the sense that the s/w is buggy. We only need to generate a decent response back to the client and a warning in the logs for further analysis and correlation. And this is what this PR is trying to achieve.", "author": "mmusgrov", "createdAt": "2020-12-07T15:40:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE2NjY5Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538166696", "bodyText": "Ok, I see, thanks. Then I assume this could be done in more Java way. We have exception handling and logging setup.\nWhen there is generated an Exception by throwGenericLRAException then we don't need a special logging when the exception has set the cause exception. Client may catch the exception and ignore it. There could be no logging at all.\nIf we think this is not exceptional occasion then the exception should not be thrown at all. The verbosity of the logging should be set by definition of the log level. This could be info and the stacktrace can be printed only for debug (ie. we don't need to add a special API for verbosity when Java manages this managed by logging levels).", "author": "ochaloup", "createdAt": "2020-12-08T09:17:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0MzAxNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539343016", "bodyText": "Exactly right, we should not be throwing exceptions and my code changes log the warning but avoid the exception.\nThe verbosity flag was added because I don't want the server side filters throwing exceptions. Existing code using this client API is unaffected (I still think it's wrong even for them but it isn't the subject of my PR).", "author": "mmusgrov", "createdAt": "2020-12-09T14:18:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwMzkyNA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539403924", "bodyText": "Ok, I would design the API differently.", "author": "ochaloup", "createdAt": "2020-12-09T15:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MjE0OA=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": {"commit": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 6751ae8f5..c62573d70 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -289,7 +294,7 @@ public class NarayanaLRAClient implements Closeable {\n                 .request()\n                 .async()\n                 .post(null)\n-                .get(CLIENT_TIMEOUT, TimeUnit.SECONDS);\n+                .get(START_TIMEOUT, TimeUnit.SECONDS);\n \n             // validate the HTTP status code says an LRA resource was created\n             if (isUnexpectedResponseStatus(response, Response.Status.CREATED)) {\n", "next_change": {"commit": "8a8ff6cf92169cbd4135e8a8ab5fe2e8f650ccfc", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex c62573d70..93a561f29 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -303,7 +326,7 @@ public class NarayanaLRAClient implements Closeable {\n                     LRALogger.i18NLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n                 }\n                 throwGenericLRAException(null, response.getStatus(),\n-                        \"LRA start returned an unexpected status code: \" + response.getStatus() + \", response '\" + responseEntity + \"'\");\n+                        \"LRA start returned an unexpected status code: \" + response.getStatus() + \", response '\" + responseEntity + \"'\", null);\n                 return null;\n             }\n \n", "next_change": {"commit": "39a099b28c8b6c429d4c9388a215833fed6b4b59", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 93a561f29..7d8765c79 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -322,11 +322,13 @@ public class NarayanaLRAClient implements Closeable {\n             // validate the HTTP status code says an LRA resource was created\n             if (isUnexpectedResponseStatus(response, Response.Status.CREATED)) {\n                 String responseEntity = response.hasEntity() ? response.readEntity(String.class) : \"\";\n+\n                 if (verbose) {\n                     LRALogger.i18NLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n                 }\n-                throwGenericLRAException(null, response.getStatus(),\n+                throwGenericLRAException(null, response.getStatus(), // TODO the catch (Exception) block already catches this one\n                         \"LRA start returned an unexpected status code: \" + response.getStatus() + \", response '\" + responseEntity + \"'\", null);\n+\n                 return null;\n             }\n \n", "next_change": {"commit": "12532b619fc028c24c1c3835475df2e1cce209a9", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 7d8765c79..2759e942f 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -324,7 +326,7 @@ public class NarayanaLRAClient implements Closeable {\n                 String responseEntity = response.hasEntity() ? response.readEntity(String.class) : \"\";\n \n                 if (verbose) {\n-                    LRALogger.i18NLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n+                    LRALogger.i18nLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n                 }\n                 throwGenericLRAException(null, response.getStatus(), // TODO the catch (Exception) block already catches this one\n                         \"LRA start returned an unexpected status code: \" + response.getStatus() + \", response '\" + responseEntity + \"'\", null);\n", "next_change": {"commit": "f7616e242937377b17f50820ff1dcb5a094ca40c", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 2759e942f..f13ea7e4f 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -324,12 +325,12 @@ public class NarayanaLRAClient implements Closeable {\n             // validate the HTTP status code says an LRA resource was created\n             if (isUnexpectedResponseStatus(response, Response.Status.CREATED)) {\n                 String responseEntity = response.hasEntity() ? response.readEntity(String.class) : \"\";\n-\n+                String logMsg = LRALogger.i18nLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n                 if (verbose) {\n-                    LRALogger.i18nLogger.error_lraCreationUnexpectedStatus(response.getStatus(), responseEntity);\n+                    LRALogger.logger.error(logMsg);\n                 }\n                 throwGenericLRAException(null, response.getStatus(), // TODO the catch (Exception) block already catches this one\n-                        \"LRA start returned an unexpected status code: \" + response.getStatus() + \", response '\" + responseEntity + \"'\", null);\n+                        logMsg, null);\n \n                 return null;\n             }\n", "next_change": {"commit": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex f13ea7e4f..9fc288dde 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -339,6 +342,7 @@ public class NarayanaLRAClient implements Closeable {\n             lraTrace(lra, \"startLRA returned\");\n \n             Current.push(lra);\n+            Current.addActiveLRACache(lra);\n \n             return lra;\n         } catch (UnsupportedEncodingException uee) {\n", "next_change": null}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "8a8ff6cf92169cbd4135e8a8ab5fe2e8f650ccfc", "committedDate": "2020-12-21 10:55:00 +0100", "message": "[JBTM-3411] enhance exception reporting for NarayanaLRAClient"}, {"oid": "84601dd3138fb165fe245d2a2f75709e9f39a095", "committedDate": "2021-02-03 14:34:14 +0000", "message": "JBTM-3418 Entity must not be null for http method PUT"}, {"oid": "39a099b28c8b6c429d4c9388a215833fed6b4b59", "committedDate": "2021-02-12 12:32:56 +0000", "message": "JBTM-3397 Better use of ArjunaCore features for nesting. Register LRARecord with the type manager."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "9e4cbbc67025a684230db46fb6b0de21f69773dc", "committedDate": "2021-04-21 18:41:28 +0200", "message": "[JBTM-3466] fixing the checkstyle based on the new rules"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "f7616e242937377b17f50820ff1dcb5a094ca40c", "committedDate": "2021-07-27 16:03:08 +0100", "message": "[JBTM-3424] Make consistency in error messag printed in log and returned via WebApplicationException to client"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "b66066b3e5eac2af7489c7f2aecc3d20d5b07ad8", "committedDate": "2022-08-15 09:57:12 +0100", "message": "JBTM-3674 Explicitly mark NarayanaLRAClient as deprecated"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "5301ec2916a51b04f10117e0c708c5b93b1dbac0", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "3ced34b50b32c8a923debdb1af1d1eead488eac6", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 wip getting most of the tests working"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "eb37cf829dc9347b2e63f1ff9092fe39db692bf7", "committedDate": "2023-05-31 14:50:31 +0200", "message": "JBTM-3755 converting StringBuilder into String"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537453926", "body": "```suggestion\r\n                .async()\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                .async()\n          \n          \n            \n                            .async()", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"x x-first x-last\">    </span>.async()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                .async()</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ochaloup", "createdAt": "2020-12-07T12:03:43Z", "path": "rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -370,14 +387,19 @@ public void leaveLRA(URI lraId, String body) throws WebApplicationException {\n             response = client.target(coordinatorUrl)\n                 .path(String.format(LEAVE_PATH, LRAConstants.getLRAUid(lraId)))\n                 .request()\n-                .put(Entity.text(body));\n+                    .async()", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NTE3OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537455179", "bodyText": "For me there is a strange formatting for these async calls and get calls. This formatting is used overall of the whole class. Is it intentional?", "author": "ochaloup", "createdAt": "2020-12-07T12:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjUwNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606506", "bodyText": "Yes the whole file probably needs reformatting. I am not doing that in the PR so it can be the subject of another issue.", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE2MDc5Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538160796", "bodyText": "I'm not talking about the whole file. I refer to the .async or .put calls which are called at the client. There are some later in the PR and I think it would be nice to adjust them all to be in the same style - with the same indentation.", "author": "ochaloup", "createdAt": "2020-12-08T09:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0MzQzNg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539343436", "bodyText": "Perhaps, but the formatting in this file has already diverged.", "author": "mmusgrov", "createdAt": "2020-12-09T14:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwNDcyOQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539404729", "bodyText": "I can't find any place where the formatting diverges now but if it's so, still the PR should not be adding more divergence.", "author": "ochaloup", "createdAt": "2020-12-09T15:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1MzkyNg=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 6751ae8f5..7a2b6e6ed 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -387,7 +387,7 @@ public class NarayanaLRAClient implements Closeable {\n             response = client.target(coordinatorUrl)\n                 .path(String.format(LEAVE_PATH, LRAConstants.getLRAUid(lraId)))\n                 .request()\n-                    .async()\n+                .async()\n                 .put(Entity.text(body))\n             .get(CLIENT_TIMEOUT, TimeUnit.SECONDS);\n \n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 6751ae8f5..94b0f0105 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -387,7 +387,7 @@ public class NarayanaLRAClient implements Closeable {\n             response = client.target(coordinatorUrl)\n                 .path(String.format(LEAVE_PATH, LRAConstants.getLRAUid(lraId)))\n                 .request()\n-                    .async()\n+                .async()\n                 .put(Entity.text(body))\n             .get(CLIENT_TIMEOUT, TimeUnit.SECONDS);\n \n", "next_change": {"commit": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 94b0f0105..c62573d70 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -389,7 +394,7 @@ public class NarayanaLRAClient implements Closeable {\n                 .request()\n                 .async()\n                 .put(Entity.text(body))\n-            .get(CLIENT_TIMEOUT, TimeUnit.SECONDS);\n+            .get(LEAVE_TIMEOUT, TimeUnit.SECONDS);\n \n             if (OK.getStatusCode() != response.getStatus()) {\n                 LRALogger.i18NLogger.error_lraLeaveUnexpectedStatus(response.getStatus(),\n", "next_change": {"commit": "8a8ff6cf92169cbd4135e8a8ab5fe2e8f650ccfc", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex c62573d70..93a561f29 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -400,7 +423,7 @@ public class NarayanaLRAClient implements Closeable {\n                 LRALogger.i18NLogger.error_lraLeaveUnexpectedStatus(response.getStatus(),\n                         response.hasEntity() ? response.readEntity(String.class) : \"\");\n                 throwGenericLRAException(null, response.getStatus(), \"Leaving LRA \" + lraId + \" from coordinator \" + coordinatorUrl\n-                    + \" finished with unexpected response code: \" + response.getStatusInfo());\n+                    + \" finished with unexpected response code: \" + response.getStatusInfo(), null);\n             }\n         } catch (InterruptedException | ExecutionException | TimeoutException e) {\n             throw new WebApplicationException(\"leave LRA client request timed out, try again later\",\n", "next_change": {"commit": "12532b619fc028c24c1c3835475df2e1cce209a9", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 93a561f29..2759e942f 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -415,12 +419,13 @@ public class NarayanaLRAClient implements Closeable {\n             response = client.target(coordinatorUrl)\n                 .path(String.format(LEAVE_PATH, LRAConstants.getLRAUid(lraId)))\n                 .request()\n+                .header(NARAYANA_LRA_API_VERSION_HEADER_NAME, LRAConstants.CURRENT_API_VERSION_STRING)\n                 .async()\n-                .put(Entity.text(body))\n-            .get(LEAVE_TIMEOUT, TimeUnit.SECONDS);\n+                .put(body == null ? Entity.text(\"\") : Entity.text(body))\n+                .get(LEAVE_TIMEOUT, TimeUnit.SECONDS);\n \n             if (OK.getStatusCode() != response.getStatus()) {\n-                LRALogger.i18NLogger.error_lraLeaveUnexpectedStatus(response.getStatus(),\n+                LRALogger.i18nLogger.error_lraLeaveUnexpectedStatus(response.getStatus(),\n                         response.hasEntity() ? response.readEntity(String.class) : \"\");\n                 throwGenericLRAException(null, response.getStatus(), \"Leaving LRA \" + lraId + \" from coordinator \" + coordinatorUrl\n                     + \" finished with unexpected response code: \" + response.getStatusInfo(), null);\n", "next_change": {"commit": "f7616e242937377b17f50820ff1dcb5a094ca40c", "changed_code": [{"header": "diff --git a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\nindex 2759e942f..f13ea7e4f 100644\n--- a/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n+++ b/rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java\n", "chunk": "@@ -425,10 +426,10 @@ public class NarayanaLRAClient implements Closeable {\n                 .get(LEAVE_TIMEOUT, TimeUnit.SECONDS);\n \n             if (OK.getStatusCode() != response.getStatus()) {\n-                LRALogger.i18nLogger.error_lraLeaveUnexpectedStatus(response.getStatus(),\n+                String logMsg = LRALogger.i18nLogger.error_lraLeaveUnexpectedStatus(lraId, response.getStatus(),\n                         response.hasEntity() ? response.readEntity(String.class) : \"\");\n-                throwGenericLRAException(null, response.getStatus(), \"Leaving LRA \" + lraId + \" from coordinator \" + coordinatorUrl\n-                    + \" finished with unexpected response code: \" + response.getStatusInfo(), null);\n+                LRALogger.logger.error(logMsg);\n+                throwGenericLRAException(null, response.getStatus(), logMsg, null);\n             }\n         } catch (InterruptedException | ExecutionException | TimeoutException e) {\n             throw new WebApplicationException(\"leave LRA client request timed out, try again later\",\n", "next_change": null}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "8a8ff6cf92169cbd4135e8a8ab5fe2e8f650ccfc", "committedDate": "2020-12-21 10:55:00 +0100", "message": "[JBTM-3411] enhance exception reporting for NarayanaLRAClient"}, {"oid": "84601dd3138fb165fe245d2a2f75709e9f39a095", "committedDate": "2021-02-03 14:34:14 +0000", "message": "JBTM-3418 Entity must not be null for http method PUT"}, {"oid": "39a099b28c8b6c429d4c9388a215833fed6b4b59", "committedDate": "2021-02-12 12:32:56 +0000", "message": "JBTM-3397 Better use of ArjunaCore features for nesting. Register LRARecord with the type manager."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "9e4cbbc67025a684230db46fb6b0de21f69773dc", "committedDate": "2021-04-21 18:41:28 +0200", "message": "[JBTM-3466] fixing the checkstyle based on the new rules"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "f7616e242937377b17f50820ff1dcb5a094ca40c", "committedDate": "2021-07-27 16:03:08 +0100", "message": "[JBTM-3424] Make consistency in error messag printed in log and returned via WebApplicationException to client"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "b66066b3e5eac2af7489c7f2aecc3d20d5b07ad8", "committedDate": "2022-08-15 09:57:12 +0100", "message": "JBTM-3674 Explicitly mark NarayanaLRAClient as deprecated"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "5301ec2916a51b04f10117e0c708c5b93b1dbac0", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "3ced34b50b32c8a923debdb1af1d1eead488eac6", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 wip getting most of the tests working"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "eb37cf829dc9347b2e63f1ff9092fe39db692bf7", "committedDate": "2023-05-31 14:50:31 +0200", "message": "JBTM-3755 converting StringBuilder into String"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537458476", "body": "What is the reason to explicitly provide the message code when it's printed by logger when logged?", "bodyText": "What is the reason to explicitly provide the message code when it's printed by logger when logged?", "bodyHTML": "<p dir=\"auto\">What is the reason to explicitly provide the message code when it's printed by logger when logged?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:11:24Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -78,10 +83,13 @@\n     private static final String TERMINAL_LRA_PROP = \"terminateLRA\";\n     private static final String SUSPENDED_LRA_PROP = \"suspendLRA\";\n     private static final String NEW_LRA_PROP = \"newLRA\";\n+    private static final String ABORT_WITH_PROP = \"abortWith\";\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-\n+    private static final String JOIN = \"join\";\n+    // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n+    private static final int i18nMessageCode = 25145;", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjY3NQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606675", "bodyText": "Take a look at where the constant gets used.\nIt provides a way for correlating the response with what's in the logs.", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3NjYyNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538176625", "bodyText": "Ok, the point is to correlate the response with what is in logs.\nI haven't seen this approach so far thus I wonder. I assume the same correlation can be done with time and the message content. If you consider a benefit in printing the global log identifier, ok.\nTwo questions\n\nShould not be the id linked with some constants on both places to be better coupled to each other?\nIf the point is correlation would not be better to correlate directly the particular response and the log message instance? Not having some general global log id that could be correlated with other means but having identifier of the message which will be \"unique\" overall?", "author": "ochaloup", "createdAt": "2020-12-08T09:30:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0NDc0Mw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539344743", "bodyText": "I am not following your logic, all I've done is to include the log message id in the response to the client. I am not advocating anything complex here, we just need a story to tell the user.", "author": "mmusgrov", "createdAt": "2020-12-09T14:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwNzY1Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539407656", "bodyText": "I see I was interested what the correlation is expected to be used for.\nFrom that I'm not following what is the benefit of adding the log error code to client response. But if there is then ok.", "author": "ochaloup", "createdAt": "2020-12-09T15:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODQ3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -87,7 +87,6 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    private static final String JOIN = \"join\";\n     // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n     private static final int i18nMessageCode = 25145;\n     @Context\n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -87,7 +87,6 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    private static final String JOIN = \"join\";\n     // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n     private static final int i18nMessageCode = 25145;\n     @Context\n", "next_change": {"commit": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex f99391001..ad318e6de 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -87,8 +87,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n-    private static final int i18nMessageCode = 25145;\n+\n     @Context\n     protected ResourceInfo resourceInfo;\n \n", "next_change": {"commit": "d21d97931681885f1f62445ad7fad263d56a9652", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex ad318e6de..a43ee26f5 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -94,14 +94,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     @Inject\n     private LRAParticipantRegistry lraParticipantRegistry;\n \n-    private final NarayanaLRAClient lraClient;\n-\n-    public ServerLRAFilter() {\n-        if (lraParticipantRegistry == null) {\n-            LRALogger.i18NLogger.warn_nonJaxRsParticipantsNotAllowed();\n-        }\n-        lraClient = new NarayanaLRAClient();\n-    }\n+    private NarayanaLRAClient lraClient;\n \n     private boolean isTxInvalid(ContainerRequestContext containerRequestContext, LRA.Type type, URI lraId,\n                                 boolean shouldNotBeNull, ArrayList<Progress> progress) {\n", "next_change": {"commit": "8fdfc0441230878f95531971e768071bda201bf6", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex a43ee26f5..0c3df7d85 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -96,6 +104,9 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private NarayanaLRAClient lraClient;\n \n+    @Inject\n+    LRAParticipantData data;\n+\n     private boolean isTxInvalid(ContainerRequestContext containerRequestContext, LRA.Type type, URI lraId,\n                                 boolean shouldNotBeNull, ArrayList<Progress> progress) {\n         if (lraId == null && shouldNotBeNull) {\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODgzOA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537458838", "body": "Is this constant used somewhere?", "bodyText": "Is this constant used somewhere?", "bodyHTML": "<p dir=\"auto\">Is this constant used somewhere?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:11:56Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -78,10 +83,13 @@\n     private static final String TERMINAL_LRA_PROP = \"terminateLRA\";\n     private static final String SUSPENDED_LRA_PROP = \"suspendLRA\";\n     private static final String NEW_LRA_PROP = \"newLRA\";\n+    private static final String ABORT_WITH_PROP = \"abortWith\";\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-\n+    private static final String JOIN = \"join\";", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNjkwOQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537606909", "bodyText": "No. I will remove it.", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1ODgzOA=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -87,7 +87,6 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    private static final String JOIN = \"join\";\n     // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n     private static final int i18nMessageCode = 25145;\n     @Context\n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -87,7 +87,6 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    private static final String JOIN = \"join\";\n     // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n     private static final int i18nMessageCode = 25145;\n     @Context\n", "next_change": {"commit": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex f99391001..ad318e6de 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -87,8 +87,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n-    private static final int i18nMessageCode = 25145;\n+\n     @Context\n     protected ResourceInfo resourceInfo;\n \n", "next_change": {"commit": "d21d97931681885f1f62445ad7fad263d56a9652", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex ad318e6de..a43ee26f5 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -94,14 +94,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     @Inject\n     private LRAParticipantRegistry lraParticipantRegistry;\n \n-    private final NarayanaLRAClient lraClient;\n-\n-    public ServerLRAFilter() {\n-        if (lraParticipantRegistry == null) {\n-            LRALogger.i18NLogger.warn_nonJaxRsParticipantsNotAllowed();\n-        }\n-        lraClient = new NarayanaLRAClient();\n-    }\n+    private NarayanaLRAClient lraClient;\n \n     private boolean isTxInvalid(ContainerRequestContext containerRequestContext, LRA.Type type, URI lraId,\n                                 boolean shouldNotBeNull, ArrayList<Progress> progress) {\n", "next_change": {"commit": "8fdfc0441230878f95531971e768071bda201bf6", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex a43ee26f5..0c3df7d85 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -96,6 +104,9 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n \n     private NarayanaLRAClient lraClient;\n \n+    @Inject\n+    LRAParticipantData data;\n+\n     private boolean isTxInvalid(ContainerRequestContext containerRequestContext, LRA.Type type, URI lraId,\n                                 boolean shouldNotBeNull, ArrayList<Progress> progress) {\n         if (lraId == null && shouldNotBeNull) {\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MDYwNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537460605", "body": "Please, use ` StringBuilder`", "bodyText": "Please, use  StringBuilder", "bodyHTML": "<p dir=\"auto\">Please, use <code> StringBuilder</code></p>", "author": "ochaloup", "createdAt": "2020-12-07T12:15:14Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNzA2MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537607061", "bodyText": "okay", "author": "mmusgrov", "createdAt": "2020-12-07T15:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MDYwNQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -628,10 +627,10 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private String processLRAOperationFailures(ArrayList<Progress> progress) {\n         StringJoiner badOps = new StringJoiner(\", \");\n         StringJoiner goodOps = new StringJoiner(\", \");\n-        StringBuffer code = new StringBuffer(\"-\");\n+        StringBuilder code = new StringBuilder(\"-\");\n \n         progress.forEach(p -> {\n-            if (p.ok()) {\n+            if (p.wasSuccessful()) {\n                 code.insert(0, p.progress.ordinal());\n                 goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n             } else {\n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -628,10 +627,10 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private String processLRAOperationFailures(ArrayList<Progress> progress) {\n         StringJoiner badOps = new StringJoiner(\", \");\n         StringJoiner goodOps = new StringJoiner(\", \");\n-        StringBuffer code = new StringBuffer(\"-\");\n+        StringBuilder code = new StringBuilder(\"-\");\n \n         progress.forEach(p -> {\n-            if (p.ok()) {\n+            if (p.wasSuccessful()) {\n                 code.insert(0, p.progress.ordinal());\n                 goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n             } else {\n", "next_change": null}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MTE4OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537461188", "body": "```suggestion\r\n         * <successful op codes>: each digit corresponds to the enum ordinal value of the ProgressStep enum value that failed\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n          \n          \n            \n                     * <successful op codes>: each digit corresponds to the enum ordinal value of the ProgressStep enum value that failed", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">         <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>successful op codes<span class=\"pl-k\">&gt;</span><span class=\"pl-k\">:</span> each digit corresponds to the <span class=\"pl-k\">enum</span> <span class=\"pl-en\">ordinal</span> <span class=\"x x-first x-last\">calue</span> of the ProgressStep <span class=\"pl-k\">enum</span> <span class=\"pl-en\">value</span> that failed</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">         <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>successful op codes<span class=\"pl-k\">&gt;</span><span class=\"pl-k\">:</span> each digit corresponds to the <span class=\"pl-k\">enum</span> <span class=\"pl-en\">ordinal</span> <span class=\"x x-first x-last\">value</span> of the ProgressStep <span class=\"pl-k\">enum</span> <span class=\"pl-en\">value</span> that failed</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ochaloup", "createdAt": "2020-12-07T12:16:20Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)\n+         *\n+         * where\n+         *\n+         * <major code>: corresponds to the id of the message in the logs\n+         * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n+         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -648,7 +647,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n          *\n          * <major code>: corresponds to the id of the message in the logs\n          * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n-         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n+         * <successful op codes>: each digit corresponds to the enum ordinal value of the ProgressStep enum value that failed\n          * <details of failed ops>: comma separated list of failed operation details \"<op name> (<exception message>)\"\n          * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n          */\n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -648,7 +647,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n          *\n          * <major code>: corresponds to the id of the message in the logs\n          * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n-         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n+         * <successful op codes>: each digit corresponds to the enum ordinal value of the ProgressStep enum value that failed\n          * <details of failed ops>: comma separated list of failed operation details \"<op name> (<exception message>)\"\n          * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n          */\n", "next_change": {"commit": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex f99391001..ad318e6de 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -652,7 +653,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n          * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n          */\n \n-        return badOps.length() != 0 ? String.format(\"%d-%s: %s (%s)\", i18nMessageCode, code, badOps, goodOps) : null;\n+        if (badOps.length() != 0) {\n+            return LRALogger.i18NLogger.warn_LRAStatusInDoubt(String.format(\"%s: %s (%s)\", code, badOps, goodOps));\n+        }\n+\n+        return null;\n     }\n \n     private boolean progressDoesNotContain(ArrayList<Progress> progress, ProgressStep step) {\n", "next_change": {"commit": "12532b619fc028c24c1c3835475df2e1cce209a9", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex ad318e6de..ca3e27488 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -654,7 +651,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n          */\n \n         if (badOps.length() != 0) {\n-            return LRALogger.i18NLogger.warn_LRAStatusInDoubt(String.format(\"%s: %s (%s)\", code, badOps, goodOps));\n+            return LRALogger.i18nLogger.warn_LRAStatusInDoubt(String.format(\"%s: %s (%s)\", code, badOps, goodOps));\n         }\n \n         return null;\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MTg5Mg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537461892", "body": "Could this be called from multiple threads?", "bodyText": "Could this be called from multiple threads?", "bodyHTML": "<p dir=\"auto\">Could this be called from multiple threads?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:17:36Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)\n+         *\n+         * where\n+         *\n+         * <major code>: corresponds to the id of the message in the logs\n+         * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n+         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n+         * <details of failed ops>: comma separated list of failed operation details \"<op name> (<exception message>)\"\n+         * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n+         */\n+\n+        return badOps.length() != 0 ? String.format(\"%d-%s: %s (%s)\", i18nMessageCode, code, badOps, goodOps) : null;\n+    }\n \n-        return terminateURIs.get(\"Link\");\n+    private boolean progressDoesNotContain(ArrayList<Progress> progress, ProgressStep step) {\n+        return progress.stream().noneMatch(p -> p.progress == step);\n     }\n \n-    private void lraTrace(URI lraId, String reason) {\n-        if (LRALogger.logger.isTraceEnabled()) {\n-            Method method = resourceInfo.getResourceMethod();\n-            LRALogger.logger.tracef(\"%s: container request for method %s: lra: %s%n\",\n-                    reason, method.getDeclaringClass().getName() + \"#\" + method.getName(),\n-                    lraId == null ? \"context\" : lraId);\n+    // add another step to the list of steps performed so far\n+    private ArrayList<Progress> updateProgress(ArrayList<Progress> progress, ProgressStep step, String reason) {\n+        if (progress == null) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2MTc3Ng==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537661776", "bodyText": "I missed these comments, github had collapse them all. Anyway,\nThis code is part of a request response processing filter chain. The context for such a request is passed into the filter method and applies to the particular request context. If you check the variable progress you will see that it is a method local variable and therefore not subject to your implied concurrency concern. In addition the contents of progress are passed to the response filter via a context property (of the request context)n and again there are no concurrency concerns.", "author": "mmusgrov", "createdAt": "2020-12-07T16:51:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MTg5Mg=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": null, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537463564", "body": "a minor thing, the `ClientLRAFilter` uses the call as `updateProgress(progres, ...)` while this class uses the format `progress = updateProgress(progress, ...`. Would not be better to use the same format of the call (probably just `updateProgress(...)`?", "bodyText": "a minor thing, the ClientLRAFilter uses the call as updateProgress(progres, ...) while this class uses the format progress = updateProgress(progress, .... Would not be better to use the same format of the call (probably just updateProgress(...)?", "bodyHTML": "<p dir=\"auto\">a minor thing, the <code>ClientLRAFilter</code> uses the call as <code>updateProgress(progres, ...)</code> while this class uses the format <code>progress = updateProgress(progress, ...</code>. Would not be better to use the same format of the call (probably just <code>updateProgress(...)</code>?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:20:36Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -385,10 +460,24 @@ public void filter(ContainerRequestContext requestContext, ContainerResponseCont\n         try {\n             if (current != null && isCancel) {\n                 try {\n-                    lraClient.cancelLRA(current);\n+                    // do not attempt to cancel if the request filter tried but failed to start a new LRA\n+                    if (progress == null || progressDoesNotContain(progress, ProgressStep.StartFailed)) {\n+                        lraClient.cancelLRA(current);\n+                        progress = updateProgress(progress, ProgressStep.Ended, null);", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2Mjg2Mg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537662862", "bodyText": "This is a server side request filter and it is only on the server that we need to check for coordinator availability. The ClientLRAFilter is for client side processing and is of no concern to the goals of this PR.", "author": "mmusgrov", "createdAt": "2020-12-07T16:52:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4MDQyOA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538180428", "bodyText": "Oh, sorry. I referred wrong class. I should say other method of the ServerLRAFilter.\nI'm talking about code style. My question of the different style was in reference to this method: https://github.com/jbosstm/narayana/pull/1738/files#diff-0b58c3a08c0d4f3a8f3953db76f78e21ca70325b035a36779d0739195444faf4R704", "author": "ochaloup", "createdAt": "2020-12-08T09:35:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM1Nzc3NQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539357775", "bodyText": "What other method (that link just takes me to the top of the PR diffs). Is this one another complaint about my coding style not matching up with what you prefer.", "author": "mmusgrov", "createdAt": "2020-12-09T14:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQxNjc1MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539416751", "bodyText": "No, here I'm not talking about the coding style. I'm talking to use the same way of method call in the code of this PR. Once it's updateProgress(progres, ...) while in a moment in the same PR it's progress = updateProgress(progress, ...). I'm advocating here the consistency of code snippets in the PR code. Let's leave it as it is.\nAnd, I'm not complaining about anything in any of my comments. I'm discussing the PR, trying to understand the purpose and find a ways how to improve it.", "author": "ochaloup", "createdAt": "2020-12-09T15:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2MzU2NA=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": {"commit": "d21d97931681885f1f62445ad7fad263d56a9652", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..a43ee26f5 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -462,7 +455,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n                 try {\n                     // do not attempt to cancel if the request filter tried but failed to start a new LRA\n                     if (progress == null || progressDoesNotContain(progress, ProgressStep.StartFailed)) {\n-                        lraClient.cancelLRA(current);\n+                        getLRAClient().cancelLRA(current);\n                         progress = updateProgress(progress, ProgressStep.Ended, null);\n                     }\n                 } catch (NotFoundException ignore) {\n", "next_change": null}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NTI4Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537465287", "body": "Using the enum `ordinal` for identity is not a good practice in java programming (https://wiki.sei.cmu.edu/confluence/display/java/DCL56-J.+Do+not+attach+significance+to+the+ordinal+associated+with+an+enum). There should be used a different approach for codes.", "bodyText": "Using the enum ordinal for identity is not a good practice in java programming (https://wiki.sei.cmu.edu/confluence/display/java/DCL56-J.+Do+not+attach+significance+to+the+ordinal+associated+with+an+enum). There should be used a different approach for codes.", "bodyHTML": "<p dir=\"auto\">Using the enum <code>ordinal</code> for identity is not a good practice in java programming (<a href=\"https://wiki.sei.cmu.edu/confluence/display/java/DCL56-J.+Do+not+attach+significance+to+the+ordinal+associated+with+an+enum\" rel=\"nofollow\">https://wiki.sei.cmu.edu/confluence/display/java/DCL56-J.+Do+not+attach+significance+to+the+ordinal+associated+with+an+enum</a>). There should be used a different approach for codes.</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:23:40Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2MzUwOQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537663509", "bodyText": "The advice you quote (DCL56-J) \"Do not attach significance to the ordinal associated with an enum\" does not apply.\nI am not attaching any significance to the ordinal value and I am using it as an identifier, identifiers do not carry significance, other than the fact that they imply uniqueness.", "author": "mmusgrov", "createdAt": "2020-12-07T16:53:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NTI4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMzkwMg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538203902", "bodyText": "I don't agree. The ordinal is used here for definition of the op code - they are reported to user as a code with significance of particular state.\nThe main reason is maitanance - enum constant reordering means troubles, op codes are not unique as any other constant enum will need to be used the values will be same... Check e.g. Effective Java from Joshua Bloch, Item 35.", "author": "ochaloup", "createdAt": "2020-12-08T10:07:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NTI4Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -628,10 +627,10 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private String processLRAOperationFailures(ArrayList<Progress> progress) {\n         StringJoiner badOps = new StringJoiner(\", \");\n         StringJoiner goodOps = new StringJoiner(\", \");\n-        StringBuffer code = new StringBuffer(\"-\");\n+        StringBuilder code = new StringBuilder(\"-\");\n \n         progress.forEach(p -> {\n-            if (p.ok()) {\n+            if (p.wasSuccessful()) {\n                 code.insert(0, p.progress.ordinal());\n                 goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n             } else {\n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -628,10 +627,10 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private String processLRAOperationFailures(ArrayList<Progress> progress) {\n         StringJoiner badOps = new StringJoiner(\", \");\n         StringJoiner goodOps = new StringJoiner(\", \");\n-        StringBuffer code = new StringBuffer(\"-\");\n+        StringBuilder code = new StringBuilder(\"-\");\n \n         progress.forEach(p -> {\n-            if (p.ok()) {\n+            if (p.wasSuccessful()) {\n                 code.insert(0, p.progress.ordinal());\n                 goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n             } else {\n", "next_change": null}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NjYxNw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537466617", "body": "Should not be `\"end suceeded\"`?", "bodyText": "Should not be \"end suceeded\"?", "bodyHTML": "<p dir=\"auto\">Should not be <code>\"end suceeded\"</code>?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:25:55Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NDQxMQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537664411", "bodyText": "Maybe, or \"join ok\" would work too from a consistency point of view.", "author": "mmusgrov", "createdAt": "2020-12-07T16:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NjYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3MTcyNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538171725", "bodyText": "and \"leave ok\" when \"ok\" is taken", "author": "ochaloup", "createdAt": "2020-12-08T09:23:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2NjYxNw=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -581,11 +580,11 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private enum ProgressStep {\n         Left (\"leave succeeded\"),\n         LeaveFailed(\"leave failed\"),\n-        Started(\"start ok\"),\n+        Started(\"start succeeded\"),\n         StartFailed(\"start failed\"),\n         Joined(\"join succeeded\"),\n         JoinFailed(\"join failed\"),\n-        Ended(\"end ok\"),\n+        Ended(\"end succeeded\"),\n         CloseFailed(\"close failed\"),\n         CancelFailed(\"cancel failed\");\n \n", "next_change": null}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2ODAxNA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537468014", "body": "When the progress data structure is used for seeking on existence would not be better to use the map structure?", "bodyText": "When the progress data structure is used for seeking on existence would not be better to use the map structure?", "bodyHTML": "<p dir=\"auto\">When the progress data structure is used for seeking on existence would not be better to use the map structure?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:28:15Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)\n+         *\n+         * where\n+         *\n+         * <major code>: corresponds to the id of the message in the logs\n+         * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n+         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n+         * <details of failed ops>: comma separated list of failed operation details \"<op name> (<exception message>)\"\n+         * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n+         */\n+\n+        return badOps.length() != 0 ? String.format(\"%d-%s: %s (%s)\", i18nMessageCode, code, badOps, goodOps) : null;\n+    }\n \n-        return terminateURIs.get(\"Link\");\n+    private boolean progressDoesNotContain(ArrayList<Progress> progress, ProgressStep step) {\n+        return progress.stream().noneMatch(p -> p.progress == step);", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NTIzMw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537665233", "bodyText": "I don't know. Let's get the functionality out there rather than getting the code absolutely perfect. There is plenty of scope for improving the code elsewhere.", "author": "mmusgrov", "createdAt": "2020-12-07T16:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2ODAxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3MDU2OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538170569", "bodyText": "And this could be one of them. I'm providing a feedback. If you consider not worthy for fixing it then ok.", "author": "ochaloup", "createdAt": "2020-12-08T09:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2ODAxNA=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": {"commit": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..ad318e6de 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -648,12 +648,16 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n          *\n          * <major code>: corresponds to the id of the message in the logs\n          * <failed op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that was successful\n-         * <successful op codes>: each digit corresponds to the enum ordinal calue of the ProgressStep enum value that failed\n+         * <successful op codes>: each digit corresponds to the enum ordinal value of the ProgressStep enum value that failed\n          * <details of failed ops>: comma separated list of failed operation details \"<op name> (<exception message>)\"\n          * <details of successful ops>: comma separated list of successful operation details \"<op name> (<op description>)\"\n          */\n \n-        return badOps.length() != 0 ? String.format(\"%d-%s: %s (%s)\", i18nMessageCode, code, badOps, goodOps) : null;\n+        if (badOps.length() != 0) {\n+            return LRALogger.i18NLogger.warn_LRAStatusInDoubt(String.format(\"%s: %s (%s)\", code, badOps, goodOps));\n+        }\n+\n+        return null;\n     }\n \n     private boolean progressDoesNotContain(ArrayList<Progress> progress, ProgressStep step) {\n", "next_change": {"commit": "12532b619fc028c24c1c3835475df2e1cce209a9", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex ad318e6de..ca3e27488 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -654,7 +651,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n          */\n \n         if (badOps.length() != 0) {\n-            return LRALogger.i18NLogger.warn_LRAStatusInDoubt(String.format(\"%s: %s (%s)\", code, badOps, goodOps));\n+            return LRALogger.i18nLogger.warn_LRAStatusInDoubt(String.format(\"%s: %s (%s)\", code, badOps, goodOps));\n         }\n \n         return null;\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTg0Mg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537469842", "body": "Would no this `EnumSet` be more appropriate to be part (a member) of the `ProgressStep` Enum itself?", "bodyText": "Would no this EnumSet be more appropriate to be part (a member) of the ProgressStep Enum itself?", "bodyHTML": "<p dir=\"auto\">Would no this <code>EnumSet</code> be more appropriate to be part (a member) of the <code>ProgressStep</code> Enum itself?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:31:27Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NzcwNA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537667704", "bodyText": "Not necessarily. Progress knows what constitutes a failure. Again, if we want this code to be perfect then different engineers have different concepts of perfection and such a strategy just serves to prolong the process.", "author": "mmusgrov", "createdAt": "2020-12-07T16:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTg0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NTE0NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538185144", "bodyText": "This was a regular question, nothing about perfection. I want to understand the code from the design perspective.\nI understand that it's intended that the Progress to have this responsibility. That's fine by me.", "author": "ochaloup", "createdAt": "2020-12-08T09:42:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ2OTg0Mg=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": null, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537471079", "body": "Maybe this would be better to be name with `success`? These this term seems to be used more in the sources here than `ok` to say that's all fine.", "bodyText": "Maybe this would be better to be name with success? These this term seems to be used more in the sources here than ok to say that's all fine.", "bodyHTML": "<p dir=\"auto\">Maybe this would be better to be name with <code>success</code>? These this term seems to be used more in the sources here than <code>ok</code> to say that's all fine.</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:33:31Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNzMwNQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537607305", "bodyText": "It is a private method and there are lots of other words that mean the same thing.\nIf I change it to something you want then what about the next person who prefers something different.", "author": "mmusgrov", "createdAt": "2020-12-07T15:42:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4NzM5NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538187394", "bodyText": "We can discuss it with the other person if he finds some part of code misleading.\nI don't talk about my private preference, I talk about using the same terms for the same thing.\nWhen the ok phrase are going to be used in other places then let's go with \"ok\".", "author": "ochaloup", "createdAt": "2020-12-08T09:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0NjE5NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539346194", "bodyText": "This is a trivial PR comment and is subjective. But if you're going to dig your feat in then I'll change it. I could be flippant and ask you for a coding style guide which passes your coding criteria, but I'll change it.", "author": "mmusgrov", "createdAt": "2020-12-09T14:21:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyMDc0Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539420747", "bodyText": "Anything what we do is subjective. I'm advocating the recommended sw practices for naming in this comment. There is no guide only recommendations in this are (e.g. Clean Code - Pick One Word per Concept).\nWhen you feel differently I'm not going to insist on this.", "author": "ochaloup", "createdAt": "2020-12-09T15:48:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MTA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -619,7 +618,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n             this.reason = reason;\n         }\n \n-        public boolean ok() {\n+        public boolean wasSuccessful() {\n             return !failures.contains(progress);\n         }\n     }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -619,7 +618,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n             this.reason = reason;\n         }\n \n-        public boolean ok() {\n+        public boolean wasSuccessful() {\n             return !failures.contains(progress);\n         }\n     }\n", "next_change": null}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MzI5NQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537473295", "body": "Why the `ProgressStep#status` is reported for success and not for the failure?", "bodyText": "Why the ProgressStep#status is reported for success and not for the failure?", "bodyHTML": "<p dir=\"auto\">Why the <code>ProgressStep#status</code> is reported for success and not for the failure?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:37:19Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwNzY3Mw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537607673", "bodyText": "Because the stuff in the brackets is only there to give more information about the step.\nThe failure branch includes the exception message whereas in the successful branch it adds nothing other than a more verbose description of name().", "author": "mmusgrov", "createdAt": "2020-12-07T15:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MzI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4ODA1Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538188057", "bodyText": "Ok, thanks for clarification.", "author": "ochaloup", "createdAt": "2020-12-08T09:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MzI5NQ=="}], "type": "inlineReview", "revised_code": {"commit": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -628,10 +627,10 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private String processLRAOperationFailures(ArrayList<Progress> progress) {\n         StringJoiner badOps = new StringJoiner(\", \");\n         StringJoiner goodOps = new StringJoiner(\", \");\n-        StringBuffer code = new StringBuffer(\"-\");\n+        StringBuilder code = new StringBuilder(\"-\");\n \n         progress.forEach(p -> {\n-            if (p.ok()) {\n+            if (p.wasSuccessful()) {\n                 code.insert(0, p.progress.ordinal());\n                 goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n             } else {\n", "next_change": null}]}, "revised_code_in_main": {"commit": "26a149dfb5797ed619f5fde5526550191c27a903", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..f99391001 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -628,10 +627,10 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n     private String processLRAOperationFailures(ArrayList<Progress> progress) {\n         StringJoiner badOps = new StringJoiner(\", \");\n         StringJoiner goodOps = new StringJoiner(\", \");\n-        StringBuffer code = new StringBuffer(\"-\");\n+        StringBuilder code = new StringBuilder(\"-\");\n \n         progress.forEach(p -> {\n-            if (p.ok()) {\n+            if (p.wasSuccessful()) {\n                 code.insert(0, p.progress.ordinal());\n                 goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n             } else {\n", "next_change": null}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NTc1OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537475758", "body": "Would not be clearer and faster not to concatenate the progress ops in case of succesful run (ie. the most probably much more often case than the failure)? \r\nChecking here for empy ops failure or similar, instead of checking the content of string of `failureMesssage`?", "bodyText": "Would not be clearer and faster not to concatenate the progress ops in case of succesful run (ie. the most probably much more often case than the failure)?\nChecking here for empy ops failure or similar, instead of checking the content of string of failureMesssage?", "bodyHTML": "<p dir=\"auto\">Would not be clearer and faster not to concatenate the progress ops in case of succesful run (ie. the most probably much more often case than the failure)?<br>\nChecking here for empy ops failure or similar, instead of checking the content of string of <code>failureMesssage</code>?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:41:32Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -431,6 +529,23 @@ public void filter(ContainerRequestContext requestContext, ContainerResponseCont\n                         Response.Status.ACCEPTED.getStatusCode(),\n                         Response.Status.OK.getStatusCode());\n             }\n+\n+            /*\n+             * report any failed steps (ie if progress contains any failures) to the caller.\n+             * If either filter encountered a failure they may have completed partial actions and\n+             * we need tell the caller which steps failed and which ones succeeded. We use a\n+             * different warning code for each scenario:\n+             */\n+            if (progress != null) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwODYxMg==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537608612", "bodyText": "Let's deal with performance enhancements when we have the primary functionality in place. There are many places throughout the code that need to be optimised.", "author": "mmusgrov", "createdAt": "2020-12-07T15:44:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NTc1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE4MjU3Mw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538182573", "bodyText": "It could be good to consider it during design phase as well. But ok.", "author": "ochaloup", "createdAt": "2020-12-08T09:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NTc1OA=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": {"commit": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex aae36de36..ad318e6de 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -540,7 +540,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n                 String failureMessage =  processLRAOperationFailures(progress);\n \n                 if (failureMessage != null) {\n-                    LRALogger.i18NLogger.warn_LRAStatusInDoubt(failureMessage);\n+                    LRALogger.logger.warn(LRALogger.i18NLogger.warn_LRAStatusInDoubt(failureMessage));\n \n                     // the actual failure(s) will also have been added to the i18NLogger logs at the time they occured\n                     responseContext.setEntity(failureMessage, null, MediaType.TEXT_PLAIN_TYPE);\n", "next_change": {"commit": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "changed_code": [{"header": "diff --git a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\nindex ad318e6de..d820cc8b9 100644\n--- a/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n+++ b/rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java\n", "chunk": "@@ -540,7 +540,7 @@ public class ServerLRAFilter implements ContainerRequestFilter, ContainerRespons\n                 String failureMessage =  processLRAOperationFailures(progress);\n \n                 if (failureMessage != null) {\n-                    LRALogger.logger.warn(LRALogger.i18NLogger.warn_LRAStatusInDoubt(failureMessage));\n+                    LRALogger.logger.warn(failureMessage);\n \n                     // the actual failure(s) will also have been added to the i18NLogger logs at the time they occured\n                     responseContext.setEntity(failureMessage, null, MediaType.TEXT_PLAIN_TYPE);\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537479941", "body": "After a while of decoding I understand the idea here.\r\nI would use probably a format but it's a matter of taste as discussed elsewhere.\r\nI would rather ask here what happens when there are multiple failed (or successful) op codes. They seem to be appended without any delimiter, or not?\r\n\r\nIn fact I wonder what is the purpose of having these opcodes as part of the user readable failure message? ", "bodyText": "After a while of decoding I understand the idea here.\nI would use probably a format but it's a matter of taste as discussed elsewhere.\nI would rather ask here what happens when there are multiple failed (or successful) op codes. They seem to be appended without any delimiter, or not?\nIn fact I wonder what is the purpose of having these opcodes as part of the user readable failure message?", "bodyHTML": "<p dir=\"auto\">After a while of decoding I understand the idea here.<br>\nI would use probably a format but it's a matter of taste as discussed elsewhere.<br>\nI would rather ask here what happens when there are multiple failed (or successful) op codes. They seem to be appended without any delimiter, or not?</p>\n<p dir=\"auto\">In fact I wonder what is the purpose of having these opcodes as part of the user readable failure message?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:47:51Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -460,46 +575,149 @@ private boolean isJaxRsCancel(ContainerRequestContext requestContext, ContainerR\n         return false;\n     }\n \n-    private URI startLRA(URI parentLRA, Method method, Long timeout) {\n-        // timeout should already have been converted to milliseconds\n-        String clientId = method.getDeclaringClass().getName() + \"#\" + method.getName();\n+    // the request filter may perform multiple and in failure scenarios the LRA may be left in an ambiguous state:\n+    // the following structure is used to track progress so that such failures can be reported in the response\n+    // filter processing\n+    private enum ProgressStep {\n+        Left (\"leave succeeded\"),\n+        LeaveFailed(\"leave failed\"),\n+        Started(\"start ok\"),\n+        StartFailed(\"start failed\"),\n+        Joined(\"join succeeded\"),\n+        JoinFailed(\"join failed\"),\n+        Ended(\"end ok\"),\n+        CloseFailed(\"close failed\"),\n+        CancelFailed(\"cancel failed\");\n+\n+        final String status;\n+\n+        ProgressStep(final String status) {\n+            this.status = status;\n+        }\n \n-        return lraClient.startLRA(parentLRA, clientId, timeout, ChronoUnit.MILLIS);\n+        @Override\n+        public String toString() {\n+            return status;\n+        }\n     }\n \n-    private void resumeTransaction(URI lraId) {\n-        // nothing to do\n+    // list of steps (both successful and unsuccesful) performed so far by the request and response filter\n+    // and is used for error reporting\n+    private static class Progress {\n+        static EnumSet<ProgressStep> failures = EnumSet.of(\n+                ProgressStep.LeaveFailed,\n+                ProgressStep.StartFailed,\n+                ProgressStep.JoinFailed,\n+                ProgressStep.CloseFailed,\n+                ProgressStep.CancelFailed);\n+\n+        ProgressStep progress;\n+        String reason;\n+\n+        public Progress(ProgressStep progress, String reason) {\n+            this.progress = progress;\n+            this.reason = reason;\n+        }\n+\n+        public boolean ok() {\n+            return !failures.contains(progress);\n+        }\n     }\n \n-    private String getCompensatorId(URI lraId, UriInfo uriInfo, Long timeout) {\n-        Map<String, String> terminateURIs = NarayanaLRAClient.getTerminationUris(resourceInfo.getResourceClass(), uriInfo, timeout);\n+    // convert the list of steps carried out by the filters into a warning message\n+    private String processLRAOperationFailures(ArrayList<Progress> progress) {\n+        StringJoiner badOps = new StringJoiner(\", \");\n+        StringJoiner goodOps = new StringJoiner(\", \");\n+        StringBuffer code = new StringBuffer(\"-\");\n \n-        if (!terminateURIs.containsKey(\"Link\")) {\n-            throwGenericLRAException(lraId, Response.Status.BAD_REQUEST.getStatusCode(),\n-                    \"Missing complete or compensate annotations\");\n-        }\n+        progress.forEach(p -> {\n+            if (p.ok()) {\n+                code.insert(0, p.progress.ordinal());\n+                goodOps.add(String.format(\"%s (%s)\", p.progress.name(), p.progress.status));\n+            } else {\n+                code.append(p.progress.ordinal());\n+                badOps.add(String.format(\"%s (%s)\", p.progress.name(), p.reason));\n+            }\n+        });\n+\n+        /*\n+         * return a string which encodes the result:\n+         * <major code>-<failed op codes>-<successful op codes>: <details of failed ops> (<details of successful ops>)", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYwOTkzMQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537609931", "bodyText": "Not. The code is using java.util.StringJoiner which includes the delimiter in the constructor.\nThe purpose is for knowing which operations are potentially in doubt.\nWe need some response to tell the caller that something is in doubt and this gives him a fighting chance of figuring out what went wrong i.e. it's not meant for users to read, rather it is for application logic to reason about the status of the system.\nYou/we can provide something more comprehensive in MP release 1.x", "author": "mmusgrov", "createdAt": "2020-12-07T15:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5Nzk2MQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538197961", "bodyText": "I see, thanks for clarification about the StringJoiner.\nThese type of changes could be difficult to done if this is a feature which is expected to be used by application logic and when some application starts to depend on it.\nMy trouble is that I don't understand well the usecase to be able to consider other possibilities. If there is some maybe we can discuss other approaches.\nIf you consider this the best for LRA design, ok.", "author": "ochaloup", "createdAt": "2020-12-08T09:59:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0ODI0NA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539348244", "bodyText": "We need to make progress and we don't have time for long protracted coding style debates.\nAfter we have finally got the code in front of users we can take our foot off the pedal and you can rework it all to satisfy your sensibilities.", "author": "mmusgrov", "createdAt": "2020-12-09T14:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQyODE3Nw==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539428177", "bodyText": "This change defines an API and as such it's good to be topic of a discussion.\nNever mind, I'm resolving this conversation thread.", "author": "ochaloup", "createdAt": "2020-12-09T15:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3OTk0MQ=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": null, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537481259", "body": "Why this check for null is needed when the `updateProgress` checks on `null`?", "bodyText": "Why this check for null is needed when the updateProgress checks on null?", "bodyHTML": "<p dir=\"auto\">Why this check for null is needed when the <code>updateProgress</code> checks on <code>null</code>?</p>", "author": "ochaloup", "createdAt": "2020-12-07T12:50:00Z", "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -240,41 +286,65 @@ public void filter(ContainerRequestContext containerRequestContext) {\n \n                         // if there is an LRA present nest a new LRA under it\n                         suspendedLRA = incommingLRA;\n-                        lraTrace(suspendedLRA, \"ServerLRAFilter before: REQUIRED start new LRA\");\n-                        newLRA = lraId = startLRA(incommingLRA, method, timeout);\n+\n+                        if (progress == null) {", "originalCommit": "00795e547e9546e68d5eef75ee76e8d32199485d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxMDE5MA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r537610190", "bodyText": "Because it might be null and updateProgress might not have been called.", "author": "mmusgrov", "createdAt": "2020-12-07T15:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE3ODg0MA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r538178840", "bodyText": "I see. I have additional question of matter of preference.\nWould not be easier to initiate it at start (https://github.com/jbosstm/narayana/pull/1738/files#diff-0b58c3a08c0d4f3a8f3953db76f78e21ca70325b035a36779d0739195444faf4R139) instead?", "author": "ochaloup", "createdAt": "2020-12-08T09:33:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTM0ODg2OQ==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539348869", "bodyText": "I could rewrite the whole thing in many different ways. Code is an art as well as a science.", "author": "mmusgrov", "createdAt": "2020-12-09T14:25:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQwOTA3OA==", "url": "https://github.com/jbosstm/narayana/pull/1738#discussion_r539409078", "bodyText": "Okay...", "author": "ochaloup", "createdAt": "2020-12-09T15:35:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ4MTI1OQ=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": null, "commits_in_main": [{"oid": "26a149dfb5797ed619f5fde5526550191c27a903", "message": "Merge commit", "committedDate": null}, {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2", "committedDate": "2020-12-18 16:52:33 +0000", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, {"oid": "9adcde53d1d626d33c8c44269e321fe3b62a215e", "committedDate": "2021-03-10 14:27:22 +0100", "message": "[JBTM-3294] adding version HTTP headers version handling to coordinator API"}, {"oid": "12532b619fc028c24c1c3835475df2e1cce209a9", "committedDate": "2021-04-27 11:42:56 +0200", "message": "JBTM-3474 LRA filters log an invalid warning about missing CDI"}, {"oid": "d21d97931681885f1f62445ad7fad263d56a9652", "committedDate": "2021-06-08 12:55:13 +0100", "message": "JBTM-3494 Lazily construct a NarayanaLRAClient helper"}, {"oid": "ead7de415b65c0073df7075b8549ec249bd3bb49", "committedDate": "2022-01-19 12:54:09 +0000", "message": "JBTM-3532 Add LRA support for EE 9"}, {"oid": "e6f02e25950677ab06493839997447248e98c408", "committedDate": "2022-02-15 11:55:08 +0000", "message": "JBTM-3579: Revert \"JBTM-3532 Add LRA support for EE 9\""}, {"oid": "9a73ec1adfcc0006d976097c73fe4368d8495e21", "committedDate": "2022-06-03 12:24:05 +0200", "message": "[JBTM-3374] afterLRA method is repeatedly called with simple LRA resource"}, {"oid": "d7829e21fcb98af4533ab8fc4208326b786f7fe0", "committedDate": "2022-07-22 15:50:52 +0100", "message": "JBTM-3655 A few changes required for Quarkus LRA TCK runs"}, {"oid": "0a08aa376868efa8cf14e1cb6e8a0651d2f3c678", "committedDate": "2022-12-01 09:50:07 +0000", "message": "JBTM-3588 initial conversion using org.eclipse.transformer.cli-0.6.0-SNAPSHOT.jar"}, {"oid": "0e9e5b14c31d0861ad8616c3ca7830d1c419d909", "committedDate": "2023-02-14 21:31:44 +0000", "message": "JBTM-3749 Changes required for LRA integration in WildFly"}, {"oid": "8fdfc0441230878f95531971e768071bda201bf6", "committedDate": "2023-03-21 10:33:40 +0000", "message": "JBTM-3755 Support for passing participant data to LRA callbacks"}, {"oid": "01f05ed0733c1a3951a254212d2d3a4d76c86039", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 Step 1: replace C and XML style copyrights"}, {"oid": "49f0bea54559b6bb8cb5651141992f3e21e355c8", "committedDate": "2023-06-06 13:40:58 +0100", "message": "JBTM-3764 add authors declaration for xml files - it's not needed but it deters people from adding their own"}]}, {"oid": "b3de967d8f9de5d9716a9f50a3db5ff76349768b", "url": "https://github.com/jbosstm/narayana/commit/b3de967d8f9de5d9716a9f50a3db5ff76349768b", "message": "JBTM-3245 report request and response filter processing failures back to the caller", "committedDate": "2020-12-10T14:23:34Z", "type": "forcePushed"}, {"oid": "9bc8e4975f73622058d51161408318db3eda0dde", "url": "https://github.com/jbosstm/narayana/commit/9bc8e4975f73622058d51161408318db3eda0dde", "message": "JBTM-3245 report request and response filter processing failures back to the caller", "committedDate": "2020-12-13T23:36:15Z", "type": "commit"}, {"oid": "9bc8e4975f73622058d51161408318db3eda0dde", "url": "https://github.com/jbosstm/narayana/commit/9bc8e4975f73622058d51161408318db3eda0dde", "message": "JBTM-3245 report request and response filter processing failures back to the caller", "committedDate": "2020-12-13T23:36:15Z", "type": "forcePushed"}]}