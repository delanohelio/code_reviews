{"pr_number": 1132, "pr_title": "Add a warning for potentially needless use of setSecretKey", "pr_author": "AdamBJohnsonx", "pr_createdAt": "2020-11-17T20:06:43Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ4MTkzMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525481932", "body": "```suggestion\r\n                    \"that supports keyStore functionality.  Consider not doing this, as it only exists \" +\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                \"that supports keyStore functionality.  Consider not doing this, as it only exists\" +\n          \n          \n            \n                                \"that supports keyStore functionality.  Consider not doing this, as it only exists \" +", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>that supports keyStore functionality.  Consider not doing this, as it only exists<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>that supports keyStore functionality.  Consider not doing this, as it only exists<span class=\"x x-first x-last\"> </span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "AdamBJohnsonx", "createdAt": "2020-11-17T20:14:04Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java", "diffHunk": "@@ -108,11 +112,15 @@\n      *\n      * @param rawKey App related key to use in encrypt/decrypt\n      */\n-    public void setSecretKey(byte[] rawKey) {\n+    public synchronized void setSecretKey(byte[] rawKey) {\n         if (rawKey == null || rawKey.length != SECRET_RAW_KEY_LENGTH) {\n             throw new IllegalArgumentException(\"rawKey\");\n         }\n-\n+        if (android.os.Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n+            Logger.warn(\":setSecretKey\", \"You're using setSecretKey in a version of android\" +\n+                    \"that supports keyStore functionality.  Consider not doing this, as it only exists\" +", "originalCommit": "75dea20e15aeb71091551313218724dd74543e1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ4MjE4NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525482185", "body": "```suggestion\r\n            Logger.warn(\":setSecretKey\", \"You're using setSecretKey in a version of android \" +\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Logger.warn(\":setSecretKey\", \"You're using setSecretKey in a version of android\" +\n          \n          \n            \n                        Logger.warn(\":setSecretKey\", \"You're using setSecretKey in a version of android \" +", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">Logger</span><span class=\"pl-k\">.</span>warn(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>:setSecretKey<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>You're using setSecretKey in a version of android<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">Logger</span><span class=\"pl-k\">.</span>warn(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>:setSecretKey<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>You're using setSecretKey in a version of android<span class=\"x x-first x-last\"> </span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "AdamBJohnsonx", "createdAt": "2020-11-17T20:14:14Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java", "diffHunk": "@@ -108,11 +112,15 @@\n      *\n      * @param rawKey App related key to use in encrypt/decrypt\n      */\n-    public void setSecretKey(byte[] rawKey) {\n+    public synchronized void setSecretKey(byte[] rawKey) {\n         if (rawKey == null || rawKey.length != SECRET_RAW_KEY_LENGTH) {\n             throw new IllegalArgumentException(\"rawKey\");\n         }\n-\n+        if (android.os.Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n+            Logger.warn(\":setSecretKey\", \"You're using setSecretKey in a version of android\" +", "originalCommit": "75dea20e15aeb71091551313218724dd74543e1f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0NjEzNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525546137", "body": "```suggestion\r\n    public void setSecretKey(byte[] rawKey) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public synchronized void setSecretKey(byte[] rawKey) {\n          \n          \n            \n                public void setSecretKey(byte[] rawKey) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k x x-first\">synchronized</span><span class=\"x x-last\"> </span><span class=\"pl-k\">void</span> setSecretKey(<span class=\"pl-k\">byte</span>[] rawKey) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> setSecretKey(<span class=\"pl-k\">byte</span>[] rawKey) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "AdamBJohnsonx", "createdAt": "2020-11-17T21:47:05Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java", "diffHunk": "@@ -108,11 +112,15 @@\n      *\n      * @param rawKey App related key to use in encrypt/decrypt\n      */\n-    public void setSecretKey(byte[] rawKey) {\n+    public synchronized void setSecretKey(byte[] rawKey) {", "originalCommit": "fc9ca3c0cf959c1403bab067aca507cf015a4875", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525552167", "body": "and are we doing this right now?", "bodyText": "and are we doing this right now?", "bodyHTML": "<p dir=\"auto\">and are we doing this right now?</p>", "author": "shahzaibj", "createdAt": "2020-11-17T21:58:28Z", "path": "common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java", "diffHunk": "@@ -112,7 +116,11 @@ public void setSecretKey(byte[] rawKey) {\n         if (rawKey == null || rawKey.length != SECRET_RAW_KEY_LENGTH) {\n             throw new IllegalArgumentException(\"rawKey\");\n         }\n-\n+        if (android.os.Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN_MR2) {\n+            Logger.warn(\":setSecretKey\", \"You're using setSecretKey in a version of android \" +\n+                    \"that supports keyStore functionality.  Consider not doing this, as it only exists \" +\n+                    \"for devices with an SDK lower than \" + Build.VERSION_CODES.JELLY_BEAN_MR2);", "originalCommit": "aff9e8252327ada7cbeee7ab9884ccac0cb7c446", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1NDE1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525554152", "bodyText": "We support generating our own key, it happens here:\n\n  \n    \n      microsoft-authentication-library-common-for-android/common/src/main/java/com/microsoft/identity/common/adal/internal/cache/StorageHelper.java\n    \n    \n         Line 666\n      in\n      9a09e2e\n    \n    \n    \n    \n\n        \n          \n           private synchronized KeyPair generateKeyPairFromAndroidKeyStore() \n        \n    \n  \n\n\nFrom a customer investigation we were working on earlier, we found an app that was calling this method at startup: we suspect it's causing issues with SSO loss due to the host-app [potentially] providing mismatched keys", "author": "iambmelt", "createdAt": "2020-11-17T22:02:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1ODE1Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525558156", "bodyText": "Cool.....actually how does user defined key currently work for MSAL? It is only for ADAL right?", "author": "shahzaibj", "createdAt": "2020-11-17T22:10:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1OTM5MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525559391", "bodyText": "MSAL reads the value from the AuthenticationSettings.INSTANCE:\n    // Try to get user defined key (ADAL/MSAL).\n    if (AuthenticationSettings.INSTANCE.getSecretKeyData() != null) {\n        setBlobVersion(VERSION_USER_DEFINED);\n        return loadSecretKey(KeyType.ADAL_USER_DEFINED_KEY);\n    }\n\nAdam.", "author": "AdamBJohnsonx", "createdAt": "2020-11-17T22:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU2MTA4Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525561082", "bodyText": "Yeah but it has to be set on AuthenticationSettings.INSTANCE right? ADAL has a public method to do this...but I don't see one in MSAL", "author": "shahzaibj", "createdAt": "2020-11-17T22:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU2MTYwOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525561608", "bodyText": "This is ADAL: https://github.com/AzureAD/azure-activedirectory-library-for-android/blob/cfdb40c5d0fb28e4825df030e909bc493aaaffe9/adal/src/main/java/com/microsoft/aad/adal/AuthenticationSettings.java#L82\nIs there something similar in MSAL?", "author": "shahzaibj", "createdAt": "2020-11-17T22:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU2NzQzNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525567437", "bodyText": "PublicClientApplicationConfiguration.java:167", "author": "AdamBJohnsonx", "createdAt": "2020-11-17T22:29:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU4MTIxOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/pull/1132#discussion_r525581218", "bodyText": "Cool, Thanks!", "author": "shahzaibj", "createdAt": "2020-11-17T22:57:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjE2Nw=="}], "type": "inlineReview"}, {"oid": "7a7f1888c0d32f99f264445a8a4c57adf260f20f", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/7a7f1888c0d32f99f264445a8a4c57adf260f20f", "message": "Add a warning for potentially needless use of setSecretKey.", "committedDate": "2020-11-18T00:17:55Z", "type": "commit"}, {"oid": "9728f8f2424cc1c905b4db08c5c83659abcd8b38", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/9728f8f2424cc1c905b4db08c5c83659abcd8b38", "message": "Fix spacing", "committedDate": "2020-11-18T00:17:55Z", "type": "commit"}, {"oid": "d1794763ec00898ab120347d7cc82c6da3083160", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d1794763ec00898ab120347d7cc82c6da3083160", "message": "don't change the synchronization", "committedDate": "2020-11-18T00:17:55Z", "type": "commit"}, {"oid": "d42a5f7fde42c522a2f8cd7e4f967ae99adeb99c", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/d42a5f7fde42c522a2f8cd7e4f967ae99adeb99c", "message": "Javadoc special use-case for setSecretKey", "committedDate": "2020-11-18T00:17:55Z", "type": "commit"}, {"oid": "90432828b952a4a3ee9967543e762082e90e52af", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/90432828b952a4a3ee9967543e762082e90e52af", "message": "Update common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java\n\nCo-authored-by: Shahzaib <37125644+shahzaibj@users.noreply.github.com>", "committedDate": "2020-11-18T00:17:55Z", "type": "commit"}, {"oid": "16b2263db714c1afa5e47d3aac57f93315b8271b", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/16b2263db714c1afa5e47d3aac57f93315b8271b", "message": "Update common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java\n\nCo-authored-by: Shahzaib <37125644+shahzaibj@users.noreply.github.com>", "committedDate": "2020-11-18T00:17:55Z", "type": "commit"}, {"oid": "16b2263db714c1afa5e47d3aac57f93315b8271b", "url": "https://github.com/AzureAD/microsoft-authentication-library-common-for-android/commit/16b2263db714c1afa5e47d3aac57f93315b8271b", "message": "Update common/src/main/java/com/microsoft/identity/common/adal/internal/AuthenticationSettings.java\n\nCo-authored-by: Shahzaib <37125644+shahzaibj@users.noreply.github.com>", "committedDate": "2020-11-18T00:17:55Z", "type": "forcePushed"}]}