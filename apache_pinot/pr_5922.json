{"pr_number": 5922, "pr_title": "Add max qps bucket count", "pr_author": "jackjlli", "pr_createdAt": "2020-08-25T22:29:25Z", "pr_url": "https://github.com/apache/pinot/pull/5922", "timeline": [{"oid": "b66b420a686ed7c61a48824ea6148ba9e3e50ea3", "url": "https://github.com/apache/pinot/commit/b66b420a686ed7c61a48824ea6148ba9e3e50ea3", "message": "Add max qps bucket count", "committedDate": "2020-08-25T21:48:34Z", "type": "commit"}, {"oid": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "url": "https://github.com/apache/pinot/commit/0569372a0269c3d9901efe6b63c1b807c8d7f111", "message": "Introduce StatefulHitCounter", "committedDate": "2020-08-27T17:07:02Z", "type": "commit"}, {"oid": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "url": "https://github.com/apache/pinot/commit/0569372a0269c3d9901efe6b63c1b807c8d7f111", "message": "Introduce StatefulHitCounter", "committedDate": "2020-08-27T17:07:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5MTkwNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478591905", "body": "```suggestion\r\n  private StatefulHitCounter _maxQpsTracker;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private StatefulHitCounter _hitCounterInMinute;\n          \n          \n            \n              private StatefulHitCounter _maxQpsTracker;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">StatefulHitCounter</span> <span class=\"x x-first x-last\">_hitCounterInMinute</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">StatefulHitCounter</span> <span class=\"x x-first x-last\">_maxQpsTracker</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mcvsubbu", "createdAt": "2020-08-27T17:47:16Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/QueryQuotaEntity.java", "diffHunk": "@@ -24,15 +24,17 @@\n public class QueryQuotaEntity {\n \n   private RateLimiter _rateLimiter;\n-  private HitCounter _hitCounter;\n+  private HitCounter _hitCounterInSecond;\n+  private StatefulHitCounter _hitCounterInMinute;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5MjEyNg==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478592126", "body": "```suggestion\r\n  private HitCounter _qpsTracker;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private HitCounter _hitCounterInSecond;\n          \n          \n            \n              private HitCounter _qpsTracker;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">HitCounter</span> <span class=\"x x-first x-last\">_hitCounterInSecond</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">HitCounter</span> <span class=\"x x-first x-last\">_qpsTracker</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mcvsubbu", "createdAt": "2020-08-27T17:47:43Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/QueryQuotaEntity.java", "diffHunk": "@@ -24,15 +24,17 @@\n public class QueryQuotaEntity {\n \n   private RateLimiter _rateLimiter;\n-  private HitCounter _hitCounter;\n+  private HitCounter _hitCounterInSecond;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NTk3Ng==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478595976", "body": "```suggestion\r\n  public StatefulHitCounter(int queriedTimeRangeInSeconds) {\r\n```\r\nDerive the other two locally. So, the timeRange we maintain could be `2*queriedTimeRangeInSeconds` or even `1.5` times . the bucket count is also something that could be decided by the statefulHitCounter.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {\n          \n          \n            \n              public StatefulHitCounter(int queriedTimeRangeInSeconds) {\n          \n      \n    \n    \n  \n\nDerive the other two locally. So, the timeRange we maintain could be 2*queriedTimeRangeInSeconds or even 1.5 times . the bucket count is also something that could be decided by the statefulHitCounter.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">public</span> StatefulHitCounter(<span class=\"pl-k\">int</span> <span class=\"x x-first\">timeRangeInSeconds, </span><span class=\"pl-k x\">int</span><span class=\"x\"> bucketCount, </span><span class=\"pl-k x\">int</span><span class=\"x x-last\"> defaultQueriedTimeRangeInSeconds</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">public</span> StatefulHitCounter(<span class=\"pl-k\">int</span> <span class=\"x x-first x-last\">queriedTimeRangeInSeconds</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Derive the other two locally. So, the timeRange we maintain could be <code>2*queriedTimeRangeInSeconds</code> or even <code>1.5</code> times . the bucket count is also something that could be decided by the statefulHitCounter.</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T17:54:29Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NjM2Ng==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478596366", "body": "Is `StatefulHitCounter` the right name? Should we call it maxHitRteTracker, since that is more specific?", "bodyText": "Is StatefulHitCounter the right name? Should we call it maxHitRteTracker, since that is more specific?", "bodyHTML": "<p dir=\"auto\">Is <code>StatefulHitCounter</code> the right name? Should we call it maxHitRteTracker, since that is more specific?</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T17:55:11Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4NzIyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478687225", "bodyText": "It can be used to track the max hit rate but the class itself is stateful. Updated the class name anyway.", "author": "jackjlli", "createdAt": "2020-08-27T20:49:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NjM2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NzY3Mw==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597673", "body": "should be volatile", "bodyText": "should be volatile", "bodyHTML": "<p dir=\"auto\">should be volatile</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T17:57:27Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NzcyNw==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597727", "body": "final", "bodyText": "final", "bodyHTML": "<p dir=\"auto\">final</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T17:57:33Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5Nzc4MA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597780", "body": "final", "bodyText": "final", "bodyHTML": "<p dir=\"auto\">final</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T17:57:40Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5Nzk3NA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478597974", "body": "```suggestion\r\n  int getMaxCountPerBucket(long now) {\r\n```\r\nMore intuitive name I think", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              int getMaxCountPerBucket(long timestamp) {\n          \n          \n            \n              int getMaxCountPerBucket(long now) {\n          \n      \n    \n    \n  \n\nMore intuitive name I think", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">int</span> getMaxCountPerBucket(<span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">timestamp</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">int</span> getMaxCountPerBucket(<span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">now</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">More intuitive name I think</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T17:58:01Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {\n+    super(timeRangeInSeconds, bucketCount);\n+    _maxTimeRangeMs = timeRangeInSeconds * 1000L;\n+    _defaultQueriedTimeRangeMs = defaultQueriedTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long timestamp) {", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5OTc0NA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478599744", "body": "```suggestion\r\n    // Since the end index was accessed last time, there is no need to query its bucket this time.\r\n```\r\nWe are skipping the endIndex in the loop below, right?", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Since the start index was accessed last time, there is no need to query its bucket this time.\n          \n          \n            \n                // Since the end index was accessed last time, there is no need to query its bucket this time.\n          \n      \n    \n    \n  \n\nWe are skipping the endIndex in the loop below, right?", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> Since the <span class=\"x x-first x-last\">start</span> index was accessed last time, there is no need to query its bucket this time.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> Since the <span class=\"x x-first x-last\">end</span> index was accessed last time, there is no need to query its bucket this time.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">We are skipping the endIndex in the loop below, right?</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T18:01:09Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/StatefulHitCounter.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class StatefulHitCounter extends HitCounter {\n+  private long _maxTimeRangeMs;\n+  private long _defaultQueriedTimeRangeMs;\n+  private long _lastAccessTimestamp;\n+\n+  public StatefulHitCounter(int timeRangeInSeconds, int bucketCount, int defaultQueriedTimeRangeInSeconds) {\n+    super(timeRangeInSeconds, bucketCount);\n+    _maxTimeRangeMs = timeRangeInSeconds * 1000L;\n+    _defaultQueriedTimeRangeMs = defaultQueriedTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long timestamp) {\n+    // If the hit counter didn't get queried for more than _maxTimeRangeMs\n+    if (timestamp - _lastAccessTimestamp > _maxTimeRangeMs) {\n+      _lastAccessTimestamp = timestamp - _defaultQueriedTimeRangeMs;\n+    }\n+    long startTimeUnits = _lastAccessTimestamp / _timeBucketWidthMs;\n+    int startIndex = (int) (startTimeUnits % _bucketCount);\n+\n+    long numTimeUnits = timestamp / _timeBucketWidthMs;\n+    int endIndex = (int) (numTimeUnits % _bucketCount);\n+\n+    int maxCount = 0;\n+    // Since the start index was accessed last time, there is no need to query its bucket this time.", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4NzQyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478687425", "bodyText": "Updated the comments here.", "author": "jackjlli", "createdAt": "2020-08-27T20:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5OTc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYwMTMzNw==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478601337", "body": "`MAX_QPS_SINCE_LAST_CALL` or better, `MAX_BURST_QPS`?", "bodyText": "MAX_QPS_SINCE_LAST_CALL or better, MAX_BURST_QPS?", "bodyHTML": "<p dir=\"auto\"><code>MAX_QPS_SINCE_LAST_CALL</code> or better, <code>MAX_BURST_QPS</code>?</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T18:04:04Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/metrics/BrokerGauge.java", "diffHunk": "@@ -27,6 +27,7 @@\n  */\n public enum BrokerGauge implements AbstractMetrics.Gauge {\n   QUERY_QUOTA_CAPACITY_UTILIZATION_RATE(\"tables\", false),\n+  MAX_QPS_IN_ONE_MINUTE(\"tables\", false),", "originalCommit": "0569372a0269c3d9901efe6b63c1b807c8d7f111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9f3ada50f96cb68b05501356256092647fd002d2", "url": "https://github.com/apache/pinot/commit/9f3ada50f96cb68b05501356256092647fd002d2", "message": "Address PR comments", "committedDate": "2020-08-27T20:50:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNTgzNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478735835", "body": "why do we need this constructor?", "bodyText": "why do we need this constructor?", "bodyHTML": "<p dir=\"auto\">why do we need this constructor?</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T22:44:47Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/MaxHitRateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class MaxHitRateTracker extends HitCounter {\n+  private static int ONE_SECOND_BUCKET_WIDTH_MS = 1000;\n+  private static int MAX_TIME_RANGE_FACTOR = 2;\n+\n+  private final long _maxTimeRangeMs;\n+  private final long _defaultTimeRangeMs;\n+  private volatile long _lastAccessTimestamp;\n+\n+  public MaxHitRateTracker(int timeRangeInSeconds) {\n+    this(timeRangeInSeconds, timeRangeInSeconds * MAX_TIME_RANGE_FACTOR);\n+  }\n+\n+  public MaxHitRateTracker(int defaultTimeRangeInSeconds, int maxTimeRangeInSeconds) {", "originalCommit": "9f3ada50f96cb68b05501356256092647fd002d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0Mzc3NA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478743774", "bodyText": "Basically it's the maxTimeRangeInSeconds that needs to be passed into the parent constructor instead of the default one. While maxTimeRangeInSeconds has to be calculated from the default one. Thus, we'd have to re-calculate the maxTimeRangeInSeconds  multiple times before we assign it to this class. Creating an extra constructor gives us the ability to reduce the duplicate calculation.", "author": "jackjlli", "createdAt": "2020-08-27T23:08:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNTgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc1NzAyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478757025", "bodyText": "Can we make that constructor private then?", "author": "mcvsubbu", "createdAt": "2020-08-27T23:53:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNTgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNjYzNA==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478736634", "body": "should this method be synchronized?\r\nI would code the method like this:\r\n- Get the value of _lastAccessTimeStamp in the beginning of the method (`then = _lastAccessTimeStamp`)\r\n- Use `then` throughout the method\r\n- Set the` _lastAccessTimestamp` to `now` at the end of the method\r\n\r\nThat will protect us against multiple calls, if any (just in case).\r\n\r\nit will also prevent us from accessing the volatile variable repeatedly.", "bodyText": "should this method be synchronized?\nI would code the method like this:\n\nGet the value of _lastAccessTimeStamp in the beginning of the method (then = _lastAccessTimeStamp)\nUse then throughout the method\nSet the _lastAccessTimestamp to now at the end of the method\n\nThat will protect us against multiple calls, if any (just in case).\nit will also prevent us from accessing the volatile variable repeatedly.", "bodyHTML": "<p dir=\"auto\">should this method be synchronized?<br>\nI would code the method like this:</p>\n<ul dir=\"auto\">\n<li>Get the value of _lastAccessTimeStamp in the beginning of the method (<code>then = _lastAccessTimeStamp</code>)</li>\n<li>Use <code>then</code> throughout the method</li>\n<li>Set the<code> _lastAccessTimestamp</code> to <code>now</code> at the end of the method</li>\n</ul>\n<p dir=\"auto\">That will protect us against multiple calls, if any (just in case).</p>\n<p dir=\"auto\">it will also prevent us from accessing the volatile variable repeatedly.</p>", "author": "mcvsubbu", "createdAt": "2020-08-27T22:47:07Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/MaxHitRateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class MaxHitRateTracker extends HitCounter {\n+  private static int ONE_SECOND_BUCKET_WIDTH_MS = 1000;\n+  private static int MAX_TIME_RANGE_FACTOR = 2;\n+\n+  private final long _maxTimeRangeMs;\n+  private final long _defaultTimeRangeMs;\n+  private volatile long _lastAccessTimestamp;\n+\n+  public MaxHitRateTracker(int timeRangeInSeconds) {\n+    this(timeRangeInSeconds, timeRangeInSeconds * MAX_TIME_RANGE_FACTOR);\n+  }\n+\n+  public MaxHitRateTracker(int defaultTimeRangeInSeconds, int maxTimeRangeInSeconds) {\n+    super(maxTimeRangeInSeconds, (int) (maxTimeRangeInSeconds * 1000L / ONE_SECOND_BUCKET_WIDTH_MS));\n+    _defaultTimeRangeMs = defaultTimeRangeInSeconds * 1000L;\n+    _maxTimeRangeMs = maxTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long now) {", "originalCommit": "9f3ada50f96cb68b05501356256092647fd002d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc0NTAyNQ==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478745025", "bodyText": "No, it doesn't need to be synchronized.\nThe callback function will be called by 1 single thread. Thus, _lastAccessTimeStamp will also be modified by the same thread.\nThe bucket belonging to the end index won't be queried, so there is no need to add the block on it. Plus, all the buckets have already been in AtomicIntegerArray. There is no need to add extra protection", "author": "jackjlli", "createdAt": "2020-08-27T23:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNjYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczNzcxMg==", "url": "https://github.com/apache/pinot/pull/5922#discussion_r478737712", "body": "```suggestion\r\n    then = _lastAccessTimeStamp;\r\n    if (now - then > _maxTimeRangeMs) {\r\n        then = now - _defaultTimeRangeMs;\r\n    }\r\n    long startTimeUnits = then / _timeBucketWidthMs;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (now - _lastAccessTimestamp > _maxTimeRangeMs) {\n          \n          \n            \n                then = _lastAccessTimeStamp;\n          \n          \n            \n                if (now - then > _maxTimeRangeMs) {\n          \n          \n            \n                    then = now - _defaultTimeRangeMs;\n          \n          \n            \n                }\n          \n          \n            \n                long startTimeUnits = then / _timeBucketWidthMs;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">if</span><span class=\"x\"> (now </span><span class=\"pl-k x\">-</span><span class=\"x\"> _lastAccessTimestamp </span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> _maxTimeRangeMs) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"x x-first\">then </span><span class=\"pl-k x\">=</span><span class=\"x x-last\"> _lastAccessTimeStamp;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (now <span class=\"pl-k\">-</span> then <span class=\"pl-k\">&gt;</span> _maxTimeRangeMs) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        then <span class=\"pl-k\">=</span> now <span class=\"pl-k\">-</span> _defaultTimeRangeMs;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">long</span> startTimeUnits <span class=\"pl-k\">=</span> then <span class=\"pl-k\">/</span> _timeBucketWidthMs;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mcvsubbu", "createdAt": "2020-08-27T22:50:21Z", "path": "pinot-broker/src/main/java/org/apache/pinot/broker/queryquota/MaxHitRateTracker.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.broker.queryquota;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+/**\n+ * A stateful version of hit counter. Similar to the default hit counter, it maintains a list of buckets.\n+ * Whereas it maintains an extra variable called _lastAccessTimestamp which tracks the last access time.\n+ * If the stateful hit counter gets queried, it firstly compares the current timestamp and the last access timestamp,\n+ * calculating the start index and end index among the buckets. Then, it traverses through all the valid candidate buckets.\n+ * If the current timestamp has exceeded the current time range of all the buckets, this hit counter will use\n+ * the current timestamp minus the default time queried time range to calculate the start time index.\n+ */\n+public class MaxHitRateTracker extends HitCounter {\n+  private static int ONE_SECOND_BUCKET_WIDTH_MS = 1000;\n+  private static int MAX_TIME_RANGE_FACTOR = 2;\n+\n+  private final long _maxTimeRangeMs;\n+  private final long _defaultTimeRangeMs;\n+  private volatile long _lastAccessTimestamp;\n+\n+  public MaxHitRateTracker(int timeRangeInSeconds) {\n+    this(timeRangeInSeconds, timeRangeInSeconds * MAX_TIME_RANGE_FACTOR);\n+  }\n+\n+  public MaxHitRateTracker(int defaultTimeRangeInSeconds, int maxTimeRangeInSeconds) {\n+    super(maxTimeRangeInSeconds, (int) (maxTimeRangeInSeconds * 1000L / ONE_SECOND_BUCKET_WIDTH_MS));\n+    _defaultTimeRangeMs = defaultTimeRangeInSeconds * 1000L;\n+    _maxTimeRangeMs = maxTimeRangeInSeconds * 1000L;\n+  }\n+\n+  /**\n+   * Get the maximum count among the buckets\n+   */\n+  public int getMaxCountPerBucket() {\n+    return getMaxCountPerBucket(System.currentTimeMillis());\n+  }\n+\n+  @VisibleForTesting\n+  int getMaxCountPerBucket(long now) {\n+    // Update the last access timestamp if the hit counter didn't get queried for more than _maxTimeRangeMs.\n+    if (now - _lastAccessTimestamp > _maxTimeRangeMs) {", "originalCommit": "9f3ada50f96cb68b05501356256092647fd002d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30103ce52126d3a004aca3cb046d4d9118eeca06", "url": "https://github.com/apache/pinot/commit/30103ce52126d3a004aca3cb046d4d9118eeca06", "message": "Address PR comments", "committedDate": "2020-08-28T00:03:19Z", "type": "commit"}, {"oid": "30103ce52126d3a004aca3cb046d4d9118eeca06", "url": "https://github.com/apache/pinot/commit/30103ce52126d3a004aca3cb046d4d9118eeca06", "message": "Address PR comments", "committedDate": "2020-08-28T00:03:19Z", "type": "forcePushed"}]}