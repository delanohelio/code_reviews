{"pr_number": 5617, "pr_title": "Add segment encryption on Controller based on table config", "pr_author": "sajjad-moradi", "pr_createdAt": "2020-06-25T00:26:53Z", "pr_url": "https://github.com/apache/pinot/pull/5617", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2NjMyNA==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445666324", "body": "Nit: Are you planning to add additional canonicalization logic? If not, we are substituting one method for another, right? ", "bodyText": "Nit: Are you planning to add additional canonicalization logic? If not, we are substituting one method for another, right?", "bodyHTML": "<p dir=\"auto\">Nit: Are you planning to add additional canonicalization logic? If not, we are substituting one method for another, right?</p>", "author": "mcvsubbu", "createdAt": "2020-06-25T15:59:09Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/TableCache.java", "diffHunk": "@@ -80,6 +80,14 @@ public String getActualColumnName(String tableName, String columnName) {\n     return columnName;\n   }\n \n+  public TableConfig getTableConfig(String tableName) {\n+    return _tableConfigChangeListener._tableConfigMap.get(canonicalize(tableName));\n+  }\n+\n+  private String canonicalize(String name) {", "originalCommit": "2ec6fabf8360504e2ec1005afe0ea9ddd6f9d10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyMDk0Ng==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445720946", "bodyText": "If latter, probably not worth creating another layer of method call.", "author": "mayankshriv", "createdAt": "2020-06-25T17:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2NjMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0NTY1Mw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447245653", "bodyText": "Using canonicalize explicitly states the reason why we're making the those strings lower case which IMO makes the code more maintainable, but since you both think otherwise, I'm reverting it.", "author": "sajjad-moradi", "createdAt": "2020-06-29T20:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2NjMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2ODM0NA==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445668344", "body": "Can you create an issue for this and reference the issue number? It is not clear what needs to be done here. I am guessing that the change is that if metadata is added, then we don't need to extract metadata?", "bodyText": "Can you create an issue for this and reference the issue number? It is not clear what needs to be done here. I am guessing that the change is that if metadata is added, then we don't need to extract metadata?", "bodyHTML": "<p dir=\"auto\">Can you create an issue for this and reference the issue number? It is not clear what needs to be done here. I am guessing that the change is that if metadata is added, then we don't need to extract metadata?</p>", "author": "mcvsubbu", "createdAt": "2020-06-25T16:02:15Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -194,38 +196,32 @@ private SuccessResponse uploadSegment(@Nullable String tableName, FormDataMultiP\n       ControllerFilePathProvider provider = ControllerFilePathProvider.getInstance();\n       String tempFileName = TMP_DIR_PREFIX + System.nanoTime();\n       tempDecryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n+      tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n       tempSegmentDir = new File(provider.getUntarredFileTempDir(), tempFileName);\n \n-      // Set default crypter to the noop crypter when no crypter header is sent\n-      // In this case, the noop crypter will not do any operations, so the encrypted and decrypted file will have the same\n-      // file path.\n-      if (crypterClassName == null) {\n-        crypterClassName = NoOpPinotCrypter.class.getSimpleName();\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n-      } else {\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n-      }\n-\n-      // TODO: Change when metadata upload added\n-      String metadataProviderClass = DefaultMetadataExtractor.class.getName();\n+      boolean uploadedSegmentIsEncrypted = !Strings.isNullOrEmpty(crypterClassNameInHeader);\n \n-      SegmentMetadata segmentMetadata;\n+      File dstFile = uploadedSegmentIsEncrypted ? tempEncryptedFile : tempDecryptedFile;\n       FileUploadDownloadClient.FileUploadType uploadType = getUploadType(uploadTypeStr);\n       switch (uploadType) {\n         case URI:\n-          segmentMetadata =\n-              getMetadataForURI(crypterClassName, downloadUri, tempEncryptedFile, tempDecryptedFile, tempSegmentDir,\n-                  metadataProviderClass);\n+          getSegmentFileFromURI(downloadUri, dstFile);\n           break;\n         case SEGMENT:\n-          getFileFromMultipart(multiPart, tempEncryptedFile);\n-          segmentMetadata = getSegmentMetadata(crypterClassName, tempEncryptedFile, tempDecryptedFile, tempSegmentDir,\n-              metadataProviderClass);\n+          getSegmentFileFromMultipart(multiPart, dstFile);\n           break;\n         default:\n           throw new UnsupportedOperationException(\"Unsupported upload type: \" + uploadType);\n       }\n \n+      if (uploadedSegmentIsEncrypted) {\n+        decryptFile(crypterClassNameInHeader, tempEncryptedFile, tempDecryptedFile);\n+      }\n+\n+      // TODO: Change when metadata upload added", "originalCommit": "2ec6fabf8360504e2ec1005afe0ea9ddd6f9d10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NTA3MA==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447345070", "bodyText": "I'm not sure why TODO is added there. I looked at it git history and it's added on this PR: 3155. If you (or other ppl) can confirm the intention there, i'll open up an issue for it.", "author": "sajjad-moradi", "createdAt": "2020-06-30T00:58:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2ODM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzOTkzMg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447839932", "bodyText": "I went through some history. I believe it is trying to refer to the case when the client (segment pusher) does the following:\n(1) Upload segment to deepstore\n(2) upload metadata to controller so that it can update ZK.\nWe don't support this pattern. When a URI is uploaded, we actually download the segment and extract metadata instead.\nA lot of code needs to change when we support metata-only upload, so let us just get rid of this TODO. thanks", "author": "mcvsubbu", "createdAt": "2020-06-30T17:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2ODM0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5MDkwMg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448690902", "bodyText": "FYI, we will need the support for metadata push pretty soon. But that is somewhat unrelated here, so just an FYI at this point in time.", "author": "mayankshriv", "createdAt": "2020-07-02T00:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2ODM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3MzA4Nw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445673087", "body": "why is this an exception? Should this just not be a case where encryption is not needed? Why are we explicitly preventing the client from encrypting the segment over the wire?\r\nI would suggest the following:\r\n(1) Check the crypter class name. If they are the same in the header and tableconfig, then accept the segment.\r\n(2) If they are not same, we have a few choices: Accept the segment after bumping a metric (and a warn log), or reject the segment with an exception. The problem with rejecting the segment is if the crypter classes are some extension of one another, and actually work fine, then we may be unnecessarily rejecting it. ", "bodyText": "why is this an exception? Should this just not be a case where encryption is not needed? Why are we explicitly preventing the client from encrypting the segment over the wire?\nI would suggest the following:\n(1) Check the crypter class name. If they are the same in the header and tableconfig, then accept the segment.\n(2) If they are not same, we have a few choices: Accept the segment after bumping a metric (and a warn log), or reject the segment with an exception. The problem with rejecting the segment is if the crypter classes are some extension of one another, and actually work fine, then we may be unnecessarily rejecting it.", "bodyHTML": "<p dir=\"auto\">why is this an exception? Should this just not be a case where encryption is not needed? Why are we explicitly preventing the client from encrypting the segment over the wire?<br>\nI would suggest the following:<br>\n(1) Check the crypter class name. If they are the same in the header and tableconfig, then accept the segment.<br>\n(2) If they are not same, we have a few choices: Accept the segment after bumping a metric (and a warn log), or reject the segment with an exception. The problem with rejecting the segment is if the crypter classes are some extension of one another, and actually work fine, then we may be unnecessarily rejecting it.</p>", "author": "mcvsubbu", "createdAt": "2020-06-25T16:09:29Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -290,6 +300,28 @@ private String extractHttpHeader(HttpHeaders headers, String name) {\n     return value;\n   }\n \n+  private Pair<Boolean, String> encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,\n+      boolean uploadedSegmentIsEncrypted) {\n+\n+    // get crypter class name from table config\n+    String crypterClassName = _pinotHelixResourceManager.getCrypterClassNameFromTableConfig(offlineTableName);\n+\n+    boolean segmentNeedsEncryption = !Strings.isNullOrEmpty(crypterClassName);\n+    if (segmentNeedsEncryption && uploadedSegmentIsEncrypted) {\n+      throw new ControllerApplicationException(LOGGER, String.format(", "originalCommit": "2ec6fabf8360504e2ec1005afe0ea9ddd6f9d10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NTAzMQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447345031", "bodyText": "Makes sense. Refactored per your suggestion.", "author": "sajjad-moradi", "createdAt": "2020-06-30T00:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3MzA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NTcxMA==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447345710", "bodyText": "I went with rejecting the segment option. If we encounter users having same crypter with different names, it'll be a small refactor to allow that change.", "author": "sajjad-moradi", "createdAt": "2020-06-30T01:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3MzA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3MzgyNg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445673826", "body": "How about returning right here if segment does not need encryption? The logic is easier to follow then.", "bodyText": "How about returning right here if segment does not need encryption? The logic is easier to follow then.", "bodyHTML": "<p dir=\"auto\">How about returning right here if segment does not need encryption? The logic is easier to follow then.</p>", "author": "mcvsubbu", "createdAt": "2020-06-25T16:10:36Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -290,6 +300,28 @@ private String extractHttpHeader(HttpHeaders headers, String name) {\n     return value;\n   }\n \n+  private Pair<Boolean, String> encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,\n+      boolean uploadedSegmentIsEncrypted) {\n+\n+    // get crypter class name from table config\n+    String crypterClassName = _pinotHelixResourceManager.getCrypterClassNameFromTableConfig(offlineTableName);\n+", "originalCommit": "2ec6fabf8360504e2ec1005afe0ea9ddd6f9d10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NDk3Mw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447344973", "bodyText": "Done.", "author": "sajjad-moradi", "createdAt": "2020-06-30T00:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3MzgyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5OTAxNQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448699015", "bodyText": "IMO, its better to always go through the same path and just make the crypter no-op", "author": "kishoreg", "createdAt": "2020-07-02T01:30:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3MzgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3NDYwNQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445674605", "body": "please add the file names to this log, thanks", "bodyText": "please add the file names to this log, thanks", "bodyHTML": "<p dir=\"auto\">please add the file names to this log, thanks</p>", "author": "mcvsubbu", "createdAt": "2020-06-25T16:11:44Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -303,46 +335,37 @@ private String getZkDownloadURIForSegmentUpload(String rawTableName, String segm\n     }\n   }\n \n-  private SegmentMetadata getMetadataForURI(String crypterClassHeader, String currentSegmentLocationURI,\n-      File tempEncryptedFile, File tempDecryptedFile, File tempSegmentDir, String metadataProviderClass)\n+  private void getSegmentFileFromURI(String currentSegmentLocationURI, File destFile)\n       throws Exception {\n-    SegmentMetadata segmentMetadata;\n     if (currentSegmentLocationURI == null || currentSegmentLocationURI.isEmpty()) {\n       throw new ControllerApplicationException(LOGGER, \"Failed to get downloadURI, needed for URI upload\",\n           Response.Status.BAD_REQUEST);\n     }\n-    LOGGER.info(\"Downloading segment from {} to {}\", currentSegmentLocationURI, tempEncryptedFile.getAbsolutePath());\n-    SegmentFetcherFactory.fetchSegmentToLocal(currentSegmentLocationURI, tempEncryptedFile);\n-    segmentMetadata = getSegmentMetadata(crypterClassHeader, tempEncryptedFile, tempDecryptedFile, tempSegmentDir,\n-        metadataProviderClass);\n-    return segmentMetadata;\n+    LOGGER.info(\"Downloading segment from {} to {}\", currentSegmentLocationURI, destFile.getAbsolutePath());\n+    SegmentFetcherFactory.fetchSegmentToLocal(currentSegmentLocationURI, destFile);\n   }\n \n-  private SegmentMetadata getSegmentMetadata(String crypterClassHeader, File tempEncryptedFile, File tempDecryptedFile,\n-      File tempSegmentDir, String metadataProviderClass)\n+  private SegmentMetadata getSegmentMetadata(File tempDecryptedFile, File tempSegmentDir, String metadataProviderClass)\n       throws Exception {\n-\n-    decryptFile(crypterClassHeader, tempEncryptedFile, tempDecryptedFile);\n-\n     // Call metadata provider to extract metadata with file object uri\n     return MetadataExtractorFactory.create(metadataProviderClass).extractMetadata(tempDecryptedFile, tempSegmentDir);\n   }\n \n-  private void completeZkOperations(boolean enableParallelPushProtection, HttpHeaders headers, File tempEncryptedFile,\n+  private void completeZkOperations(boolean enableParallelPushProtection, HttpHeaders headers, File uploadedSegmentFile,\n       String rawTableName, SegmentMetadata segmentMetadata, String segmentName, String zkDownloadURI,\n-      boolean moveSegmentToFinalLocation)\n+      boolean moveSegmentToFinalLocation, String crypter)\n       throws Exception {\n     URI finalSegmentLocationURI = URIUtils\n         .getUri(ControllerFilePathProvider.getInstance().getDataDirURI().toString(), rawTableName,\n             URIUtils.encode(segmentName));\n     ZKOperator zkOperator = new ZKOperator(_pinotHelixResourceManager, _controllerConf, _controllerMetrics);\n-    zkOperator.completeSegmentOperations(rawTableName, segmentMetadata, finalSegmentLocationURI, tempEncryptedFile,\n-        enableParallelPushProtection, headers, zkDownloadURI, moveSegmentToFinalLocation);\n+    zkOperator.completeSegmentOperations(rawTableName, segmentMetadata, finalSegmentLocationURI, uploadedSegmentFile,\n+        enableParallelPushProtection, headers, zkDownloadURI, moveSegmentToFinalLocation, crypter);\n   }\n \n-  private void decryptFile(String crypterClassHeader, File tempEncryptedFile, File tempDecryptedFile) {\n-    PinotCrypter pinotCrypter = PinotCrypterFactory.create(crypterClassHeader);\n-    LOGGER.info(\"Using crypter class {}\", pinotCrypter.getClass().getName());\n+  private void decryptFile(String crypterClassName, File tempEncryptedFile, File tempDecryptedFile) {\n+    PinotCrypter pinotCrypter = PinotCrypterFactory.create(crypterClassName);\n+    LOGGER.info(\"Using crypter class {} for decryption.\", pinotCrypter.getClass().getName());", "originalCommit": "2ec6fabf8360504e2ec1005afe0ea9ddd6f9d10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NDk2Mg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447344962", "bodyText": "Done.", "author": "sajjad-moradi", "createdAt": "2020-06-30T00:58:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY3NDYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyMzk5NQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445723995", "body": "A `get` method returning void seems odd to me. Probably `s/get/download`?", "bodyText": "A get method returning void seems odd to me. Probably s/get/download?", "bodyHTML": "<p dir=\"auto\">A <code>get</code> method returning void seems odd to me. Probably <code>s/get/download</code>?</p>", "author": "mayankshriv", "createdAt": "2020-06-25T17:33:02Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -303,46 +335,37 @@ private String getZkDownloadURIForSegmentUpload(String rawTableName, String segm\n     }\n   }\n \n-  private SegmentMetadata getMetadataForURI(String crypterClassHeader, String currentSegmentLocationURI,\n-      File tempEncryptedFile, File tempDecryptedFile, File tempSegmentDir, String metadataProviderClass)\n+  private void getSegmentFileFromURI(String currentSegmentLocationURI, File destFile)", "originalCommit": "2ec6fabf8360504e2ec1005afe0ea9ddd6f9d10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NDkzMQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447344931", "bodyText": "Makes sense \ud83d\udc4d  Refactored.", "author": "sajjad-moradi", "createdAt": "2020-06-30T00:58:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyMzk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyNjEyMA==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r445726120", "body": "crypterClassName should be an input to this method, not a return value? This method should just return the boolean.", "bodyText": "crypterClassName should be an input to this method, not a return value? This method should just return the boolean.", "bodyHTML": "<p dir=\"auto\">crypterClassName should be an input to this method, not a return value? This method should just return the boolean.</p>", "author": "mayankshriv", "createdAt": "2020-06-25T17:36:49Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -251,6 +247,20 @@ private SuccessResponse uploadSegment(@Nullable String tableName, FormDataMultiP\n           _controllerMetrics, _leadControllerManager.isLeaderForTable(offlineTableName))\n           .validateOfflineSegment(offlineTableName, segmentMetadata, tempSegmentDir);\n \n+      Pair<Boolean, String> encryptionInfo =\n+          encryptSegmentIfNeeded(offlineTableName, tempDecryptedFile, tempEncryptedFile, uploadedSegmentIsEncrypted);", "originalCommit": "2ec6fabf8360504e2ec1005afe0ea9ddd6f9d10a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM0NDkwMg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447344902", "bodyText": "Done.", "author": "sajjad-moradi", "createdAt": "2020-06-30T00:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTcyNjEyMA=="}], "type": "inlineReview"}, {"oid": "190f3f37d2fabb69387d409948b6e2ee5811ae91", "url": "https://github.com/apache/pinot/commit/190f3f37d2fabb69387d409948b6e2ee5811ae91", "message": "Applied PR's comments", "committedDate": "2020-06-30T00:05:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzgzMjc0MQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447832741", "body": "```suggestion\r\n      boolean isUploadedSegmentEncrypted = !Strings.isNullOrEmpty(crypterClassNameInHeader);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  boolean uploadedSegmentIsEncrypted = !Strings.isNullOrEmpty(crypterClassNameInHeader);\n          \n          \n            \n                  boolean isUploadedSegmentEncrypted = !Strings.isNullOrEmpty(crypterClassNameInHeader);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"202\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">uploadedSegmentIsEncrypted</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">!</span><span class=\"pl-smi\">Strings</span><span class=\"pl-k\">.</span>isNullOrEmpty(crypterClassNameInHeader);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"202\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">isUploadedSegmentEncrypted</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">!</span><span class=\"pl-smi\">Strings</span><span class=\"pl-k\">.</span>isNullOrEmpty(crypterClassNameInHeader);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mcvsubbu", "createdAt": "2020-06-30T16:49:35Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -194,38 +194,32 @@ private SuccessResponse uploadSegment(@Nullable String tableName, FormDataMultiP\n       ControllerFilePathProvider provider = ControllerFilePathProvider.getInstance();\n       String tempFileName = TMP_DIR_PREFIX + System.nanoTime();\n       tempDecryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n+      tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n       tempSegmentDir = new File(provider.getUntarredFileTempDir(), tempFileName);\n \n-      // Set default crypter to the noop crypter when no crypter header is sent\n-      // In this case, the noop crypter will not do any operations, so the encrypted and decrypted file will have the same\n-      // file path.\n-      if (crypterClassName == null) {\n-        crypterClassName = NoOpPinotCrypter.class.getSimpleName();\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n-      } else {\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n-      }\n-\n-      // TODO: Change when metadata upload added\n-      String metadataProviderClass = DefaultMetadataExtractor.class.getName();\n+      boolean uploadedSegmentIsEncrypted = !Strings.isNullOrEmpty(crypterClassNameInHeader);", "originalCommit": "190f3f37d2fabb69387d409948b6e2ee5811ae91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0MTg1Mw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447841853", "body": "Add segment name and table name to the exception string", "bodyText": "Add segment name and table name to the exception string", "bodyHTML": "<p dir=\"auto\">Add segment name and table name to the exception string</p>", "author": "mcvsubbu", "createdAt": "2020-06-30T17:03:38Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -290,6 +297,34 @@ private String extractHttpHeader(HttpHeaders headers, String name) {\n     return value;\n   }\n \n+  private Boolean encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,\n+      boolean uploadedSegmentIsEncrypted, String crypterUsedInUploadedSegment, String crypterClassNameInTableConfig) {\n+\n+    boolean segmentNeedsEncryption = !Strings.isNullOrEmpty(crypterClassNameInTableConfig);\n+    if (!segmentNeedsEncryption) {\n+      // do nothing\n+      return false;\n+    }\n+\n+    if (uploadedSegmentIsEncrypted) {\n+      if (!crypterClassNameInTableConfig.equalsIgnoreCase(crypterUsedInUploadedSegment)) {\n+        throw new ControllerApplicationException(LOGGER, String", "originalCommit": "190f3f37d2fabb69387d409948b6e2ee5811ae91", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0MzA4Nw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447843087", "body": "```suggestion\r\n      if (!crypterClassNameInTableConfig.equals(crypterUsedInUploadedSegment)) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (!crypterClassNameInTableConfig.equalsIgnoreCase(crypterUsedInUploadedSegment)) {\n          \n          \n            \n                  if (!crypterClassNameInTableConfig.equals(crypterUsedInUploadedSegment)) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>crypterClassNameInTableConfig<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">equalsIgnoreCase</span>(crypterUsedInUploadedSegment)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>crypterClassNameInTableConfig<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">equals</span>(crypterUsedInUploadedSegment)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mcvsubbu", "createdAt": "2020-06-30T17:05:25Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -290,6 +297,34 @@ private String extractHttpHeader(HttpHeaders headers, String name) {\n     return value;\n   }\n \n+  private Boolean encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,\n+      boolean uploadedSegmentIsEncrypted, String crypterUsedInUploadedSegment, String crypterClassNameInTableConfig) {\n+\n+    boolean segmentNeedsEncryption = !Strings.isNullOrEmpty(crypterClassNameInTableConfig);\n+    if (!segmentNeedsEncryption) {\n+      // do nothing\n+      return false;\n+    }\n+\n+    if (uploadedSegmentIsEncrypted) {\n+      if (!crypterClassNameInTableConfig.equalsIgnoreCase(crypterUsedInUploadedSegment)) {", "originalCommit": "190f3f37d2fabb69387d409948b6e2ee5811ae91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwNzAyNg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448007026", "bodyText": "Done.", "author": "sajjad-moradi", "createdAt": "2020-06-30T22:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0MzA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NDY1Ng==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r447844656", "body": "```suggestion\r\n  private boolean encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Boolean encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,\n          \n          \n            \n              private boolean encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi x x-first x-last\">Boolean</span> encryptSegmentIfNeeded(<span class=\"pl-smi\">String</span> offlineTableName, <span class=\"pl-smi\">File</span> tempDecryptedFile, <span class=\"pl-smi\">File</span> tempEncryptedFile,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first x-last\">boolean</span> encryptSegmentIfNeeded(<span class=\"pl-smi\">String</span> offlineTableName, <span class=\"pl-smi\">File</span> tempDecryptedFile, <span class=\"pl-smi\">File</span> tempEncryptedFile,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mcvsubbu", "createdAt": "2020-06-30T17:07:27Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -290,6 +297,34 @@ private String extractHttpHeader(HttpHeaders headers, String name) {\n     return value;\n   }\n \n+  private Boolean encryptSegmentIfNeeded(String offlineTableName, File tempDecryptedFile, File tempEncryptedFile,", "originalCommit": "190f3f37d2fabb69387d409948b6e2ee5811ae91", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwNzIyNg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448007226", "bodyText": "Refactored.", "author": "sajjad-moradi", "createdAt": "2020-06-30T22:09:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg0NDY1Ng=="}], "type": "inlineReview"}, {"oid": "b31f04e1eec5f4c02d7281ced3245609881000b5", "url": "https://github.com/apache/pinot/commit/b31f04e1eec5f4c02d7281ced3245609881000b5", "message": "Add segment encryption on Controller based on table config", "committedDate": "2020-06-30T22:11:10Z", "type": "commit"}, {"oid": "af5eeab10ff365b37818da6281d5eaa18966df70", "url": "https://github.com/apache/pinot/commit/af5eeab10ff365b37818da6281d5eaa18966df70", "message": "Applied PR's comments", "committedDate": "2020-06-30T22:11:10Z", "type": "commit"}, {"oid": "055e47a88928af94d75301c60c2441a5c6159210", "url": "https://github.com/apache/pinot/commit/055e47a88928af94d75301c60c2441a5c6159210", "message": "Addressed PR's comments", "committedDate": "2020-06-30T22:11:10Z", "type": "commit"}, {"oid": "055e47a88928af94d75301c60c2441a5c6159210", "url": "https://github.com/apache/pinot/commit/055e47a88928af94d75301c60c2441a5c6159210", "message": "Addressed PR's comments", "committedDate": "2020-06-30T22:11:10Z", "type": "forcePushed"}, {"oid": "bd8368a42201b443af9d98a986233526a7d59723", "url": "https://github.com/apache/pinot/commit/bd8368a42201b443af9d98a986233526a7d59723", "message": "Add license header + equality check on crypters", "committedDate": "2020-06-30T23:22:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1MjkxNg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448052916", "body": "please add table name and segment name here. In production, we will see multiple parallel pushes going on, and it is useful to determine which segment/table we are talking about.", "bodyText": "please add table name and segment name here. In production, we will see multiple parallel pushes going on, and it is useful to determine which segment/table we are talking about.", "bodyHTML": "<p dir=\"auto\">please add table name and segment name here. In production, we will see multiple parallel pushes going on, and it is useful to determine which segment/table we are talking about.</p>", "author": "mcvsubbu", "createdAt": "2020-07-01T00:35:56Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -290,6 +296,39 @@ private String extractHttpHeader(HttpHeaders headers, String name) {\n     return value;\n   }\n \n+  Pair<String, File> encryptSegmentIfNeeded(File tempDecryptedFile, File tempEncryptedFile,\n+      boolean isUploadedSegmentEncrypted, String crypterUsedInUploadedSegment, String crypterClassNameInTableConfig,\n+      String segmentName, String tableName) {\n+\n+    boolean segmentNeedsEncryption = !Strings.isNullOrEmpty(crypterClassNameInTableConfig);\n+\n+    // form the output\n+    File finalSegmentFile =\n+        (isUploadedSegmentEncrypted || segmentNeedsEncryption) ? tempEncryptedFile : tempDecryptedFile;\n+    String crypterClassName = Strings.isNullOrEmpty(crypterClassNameInTableConfig) ? crypterUsedInUploadedSegment\n+        : crypterClassNameInTableConfig;\n+    ImmutablePair<String, File> out = ImmutablePair.of(crypterClassName, finalSegmentFile);\n+\n+    if (!segmentNeedsEncryption) {\n+      return out;\n+    }\n+\n+    if (isUploadedSegmentEncrypted && !crypterClassNameInTableConfig.equals(crypterUsedInUploadedSegment)) {\n+      throw new ControllerApplicationException(LOGGER, String\n+          .format(\"Uploaded segment is encrypted with '%s' while table config requires '%s' as crypter \"\n+                  + \"(segment name = '%s', table name = '%s').\", crypterUsedInUploadedSegment,\n+              crypterClassNameInTableConfig, segmentName, tableName), Response.Status.INTERNAL_SERVER_ERROR);\n+    }\n+\n+    // encrypt segment\n+    PinotCrypter pinotCrypter = PinotCrypterFactory.create(crypterClassNameInTableConfig);\n+    LOGGER.info(\"Using crypter class {} for encrypting {} to {}.\", crypterClassNameInTableConfig, tempDecryptedFile,", "originalCommit": "bd8368a42201b443af9d98a986233526a7d59723", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1MzM2Nw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448053367", "body": "I am assuming that the URI tells us segment and table name here, otherwise, it is useful to add table/segment name i this log", "bodyText": "I am assuming that the URI tells us segment and table name here, otherwise, it is useful to add table/segment name i this log", "bodyHTML": "<p dir=\"auto\">I am assuming that the URI tells us segment and table name here, otherwise, it is useful to add table/segment name i this log</p>", "author": "mcvsubbu", "createdAt": "2020-07-01T00:37:34Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -303,46 +342,38 @@ private String getZkDownloadURIForSegmentUpload(String rawTableName, String segm\n     }\n   }\n \n-  private SegmentMetadata getMetadataForURI(String crypterClassHeader, String currentSegmentLocationURI,\n-      File tempEncryptedFile, File tempDecryptedFile, File tempSegmentDir, String metadataProviderClass)\n+  private void downloadSegmentFileFromURI(String currentSegmentLocationURI, File destFile)\n       throws Exception {\n-    SegmentMetadata segmentMetadata;\n     if (currentSegmentLocationURI == null || currentSegmentLocationURI.isEmpty()) {\n       throw new ControllerApplicationException(LOGGER, \"Failed to get downloadURI, needed for URI upload\",\n           Response.Status.BAD_REQUEST);\n     }\n-    LOGGER.info(\"Downloading segment from {} to {}\", currentSegmentLocationURI, tempEncryptedFile.getAbsolutePath());\n-    SegmentFetcherFactory.fetchSegmentToLocal(currentSegmentLocationURI, tempEncryptedFile);\n-    segmentMetadata = getSegmentMetadata(crypterClassHeader, tempEncryptedFile, tempDecryptedFile, tempSegmentDir,\n-        metadataProviderClass);\n-    return segmentMetadata;\n+    LOGGER.info(\"Downloading segment from {} to {}\", currentSegmentLocationURI, destFile.getAbsolutePath());", "originalCommit": "bd8368a42201b443af9d98a986233526a7d59723", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUwNTc3MQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448505771", "bodyText": "I think the same way, but I added the table name to the logs anyways. For the segment, it is not available here. Segment needs to be downloaded first and then its name can be retrieved from the segment metadata.", "author": "sajjad-moradi", "createdAt": "2020-07-01T17:15:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1MzM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1MzY3MQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448053671", "body": "Not sure why we lower case here. Can you elaborate?", "bodyText": "Not sure why we lower case here. Can you elaborate?", "bodyHTML": "<p dir=\"auto\">Not sure why we lower case here. Can you elaborate?</p>", "author": "mcvsubbu", "createdAt": "2020-07-01T00:38:59Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/TableCache.java", "diffHunk": "@@ -98,7 +102,7 @@ public synchronized void refresh() {\n             try {\n               TableConfig tableConfig = TableConfigUtils.fromZNRecord(znRecord);\n               String tableNameWithType = tableConfig.getTableName();\n-              _tableConfigMap.put(tableNameWithType, tableConfig);\n+              _tableConfigMap.put(tableNameWithType.toLowerCase(), tableConfig);", "originalCommit": "bd8368a42201b443af9d98a986233526a7d59723", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUwNjY1Nw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448506657", "bodyText": "Reverted. I was following the pattern with column and table name in this class.", "author": "sajjad-moradi", "createdAt": "2020-07-01T17:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODA1MzY3MQ=="}], "type": "inlineReview"}, {"oid": "575407aa9d1b487455bf22f9ae4f54566e5555a9", "url": "https://github.com/apache/pinot/commit/575407aa9d1b487455bf22f9ae4f54566e5555a9", "message": "Addressed PR's comments", "committedDate": "2020-07-01T17:11:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNzYxOA==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448527618", "body": "```suggestion\r\n    LOGGER.info(\"Using crypter class '{}' for encrypting '{}' to '{}' (segment name = '{}', table name = '{}').\",\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                LOGGER.info(\"Using crypter class '{}' for encrypting '{}' to '{}' (segment name = '{}}', table name = '{}').\",\n          \n          \n            \n                LOGGER.info(\"Using crypter class '{}' for encrypting '{}' to '{}' (segment name = '{}', table name = '{}').\",", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span>info(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Using crypter class '{}' for encrypting '{}' to '{}' (segment name = '{}<span class=\"x x-first x-last\">}</span>', table name = '{}').<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c1\">LOGGER</span><span class=\"pl-k\">.</span>info(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Using crypter class '{}' for encrypting '{}' to '{}' (segment name = '{}', table name = '{}').<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mcvsubbu", "createdAt": "2020-07-01T17:56:45Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -290,6 +296,39 @@ private String extractHttpHeader(HttpHeaders headers, String name) {\n     return value;\n   }\n \n+  Pair<String, File> encryptSegmentIfNeeded(File tempDecryptedFile, File tempEncryptedFile,\n+      boolean isUploadedSegmentEncrypted, String crypterUsedInUploadedSegment, String crypterClassNameInTableConfig,\n+      String segmentName, String tableName) {\n+\n+    boolean segmentNeedsEncryption = !Strings.isNullOrEmpty(crypterClassNameInTableConfig);\n+\n+    // form the output\n+    File finalSegmentFile =\n+        (isUploadedSegmentEncrypted || segmentNeedsEncryption) ? tempEncryptedFile : tempDecryptedFile;\n+    String crypterClassName = Strings.isNullOrEmpty(crypterClassNameInTableConfig) ? crypterUsedInUploadedSegment\n+        : crypterClassNameInTableConfig;\n+    ImmutablePair<String, File> out = ImmutablePair.of(crypterClassName, finalSegmentFile);\n+\n+    if (!segmentNeedsEncryption) {\n+      return out;\n+    }\n+\n+    if (isUploadedSegmentEncrypted && !crypterClassNameInTableConfig.equals(crypterUsedInUploadedSegment)) {\n+      throw new ControllerApplicationException(LOGGER, String.format(\n+          \"Uploaded segment is encrypted with '%s' while table config requires '%s' as crypter \"\n+              + \"(segment name = '%s', table name = '%s').\", crypterUsedInUploadedSegment,\n+          crypterClassNameInTableConfig, segmentName, tableName), Response.Status.INTERNAL_SERVER_ERROR);\n+    }\n+\n+    // encrypt segment\n+    PinotCrypter pinotCrypter = PinotCrypterFactory.create(crypterClassNameInTableConfig);\n+    LOGGER.info(\"Using crypter class '{}' for encrypting '{}' to '{}' (segment name = '{}}', table name = '{}').\",", "originalCommit": "575407aa9d1b487455bf22f9ae4f54566e5555a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "289ca9ec4d4f3f6f5e74e191826d429f76fca9ab", "url": "https://github.com/apache/pinot/commit/289ca9ec4d4f3f6f5e74e191826d429f76fca9ab", "message": "Fix log message\n\nCo-authored-by: Subbu Subramaniam <mcvsubbu@users.noreply.github.com>", "committedDate": "2020-07-01T18:03:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5NzgyMQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448697821", "body": "it's better to pass the crypterName instead of the classname right? Its ok to have the ability to override it with a classname but it weird to have users pass classname in the request", "bodyText": "it's better to pass the crypterName instead of the classname right? Its ok to have the ability to override it with a classname but it weird to have users pass classname in the request", "bodyHTML": "<p dir=\"auto\">it's better to pass the crypterName instead of the classname right? Its ok to have the ability to override it with a classname but it weird to have users pass classname in the request</p>", "author": "kishoreg", "createdAt": "2020-07-02T01:25:48Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -177,13 +179,13 @@ public Response downloadSegment(\n   private SuccessResponse uploadSegment(@Nullable String tableName, FormDataMultiPart multiPart,\n       boolean enableParallelPushProtection, HttpHeaders headers, Request request, boolean moveSegmentToFinalLocation) {\n     String uploadTypeStr = null;\n-    String crypterClassName = null;\n+    String crypterClassNameInHeader = null;", "originalCommit": "289ca9ec4d4f3f6f5e74e191826d429f76fca9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI3NjkxMg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r449276912", "bodyText": "If you're talking about the difference between fully qualified name vs just the name of the crypter, then how can we differentiate two crypters which have the same name but different packages?", "author": "sajjad-moradi", "createdAt": "2020-07-02T21:36:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5NzgyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODA1Mw==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448698053", "body": "why are we download the segment?", "bodyText": "why are we download the segment?", "bodyHTML": "<p dir=\"auto\">why are we download the segment?</p>", "author": "kishoreg", "createdAt": "2020-07-02T01:26:48Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -194,38 +196,31 @@ private SuccessResponse uploadSegment(@Nullable String tableName, FormDataMultiP\n       ControllerFilePathProvider provider = ControllerFilePathProvider.getInstance();\n       String tempFileName = TMP_DIR_PREFIX + System.nanoTime();\n       tempDecryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n+      tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n       tempSegmentDir = new File(provider.getUntarredFileTempDir(), tempFileName);\n \n-      // Set default crypter to the noop crypter when no crypter header is sent\n-      // In this case, the noop crypter will not do any operations, so the encrypted and decrypted file will have the same\n-      // file path.\n-      if (crypterClassName == null) {\n-        crypterClassName = NoOpPinotCrypter.class.getSimpleName();\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n-      } else {\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n-      }\n-\n-      // TODO: Change when metadata upload added\n-      String metadataProviderClass = DefaultMetadataExtractor.class.getName();\n+      boolean uploadedSegmentIsEncrypted = !Strings.isNullOrEmpty(crypterClassNameInHeader);\n \n-      SegmentMetadata segmentMetadata;\n+      File dstFile = uploadedSegmentIsEncrypted ? tempEncryptedFile : tempDecryptedFile;\n       FileUploadDownloadClient.FileUploadType uploadType = getUploadType(uploadTypeStr);\n       switch (uploadType) {\n         case URI:\n-          segmentMetadata =\n-              getMetadataForURI(crypterClassName, downloadUri, tempEncryptedFile, tempDecryptedFile, tempSegmentDir,\n-                  metadataProviderClass);\n+          downloadSegmentFileFromURI(downloadUri, dstFile, tableName);", "originalCommit": "289ca9ec4d4f3f6f5e74e191826d429f76fca9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxNzY1Mg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r449217652", "bodyText": "Downloading logic was there before. I just renamed the functions.\nBasically if the download uri, instead of the segment data, is provided, controllers download the segment from the given uri.", "author": "sajjad-moradi", "createdAt": "2020-07-02T19:11:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODQ1Mg==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448698452", "body": "better to always go through the crypter with noopcrypter", "bodyText": "better to always go through the crypter with noopcrypter", "bodyHTML": "<p dir=\"auto\">better to always go through the crypter with noopcrypter</p>", "author": "kishoreg", "createdAt": "2020-07-02T01:28:25Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -194,38 +196,31 @@ private SuccessResponse uploadSegment(@Nullable String tableName, FormDataMultiP\n       ControllerFilePathProvider provider = ControllerFilePathProvider.getInstance();\n       String tempFileName = TMP_DIR_PREFIX + System.nanoTime();\n       tempDecryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n+      tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n       tempSegmentDir = new File(provider.getUntarredFileTempDir(), tempFileName);\n \n-      // Set default crypter to the noop crypter when no crypter header is sent\n-      // In this case, the noop crypter will not do any operations, so the encrypted and decrypted file will have the same\n-      // file path.\n-      if (crypterClassName == null) {\n-        crypterClassName = NoOpPinotCrypter.class.getSimpleName();\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName);\n-      } else {\n-        tempEncryptedFile = new File(provider.getFileUploadTempDir(), tempFileName + ENCRYPTED_SUFFIX);\n-      }\n-\n-      // TODO: Change when metadata upload added\n-      String metadataProviderClass = DefaultMetadataExtractor.class.getName();\n+      boolean uploadedSegmentIsEncrypted = !Strings.isNullOrEmpty(crypterClassNameInHeader);\n \n-      SegmentMetadata segmentMetadata;\n+      File dstFile = uploadedSegmentIsEncrypted ? tempEncryptedFile : tempDecryptedFile;\n       FileUploadDownloadClient.FileUploadType uploadType = getUploadType(uploadTypeStr);\n       switch (uploadType) {\n         case URI:\n-          segmentMetadata =\n-              getMetadataForURI(crypterClassName, downloadUri, tempEncryptedFile, tempDecryptedFile, tempSegmentDir,\n-                  metadataProviderClass);\n+          downloadSegmentFileFromURI(downloadUri, dstFile, tableName);\n           break;\n         case SEGMENT:\n-          getFileFromMultipart(multiPart, tempEncryptedFile);\n-          segmentMetadata = getSegmentMetadata(crypterClassName, tempEncryptedFile, tempDecryptedFile, tempSegmentDir,\n-              metadataProviderClass);\n+          createSegmentFileFromMultipart(multiPart, dstFile);\n           break;\n         default:\n           throw new UnsupportedOperationException(\"Unsupported upload type: \" + uploadType);\n       }\n \n+      if (uploadedSegmentIsEncrypted) {", "originalCommit": "289ca9ec4d4f3f6f5e74e191826d429f76fca9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxNTU2NQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r449215565", "bodyText": "If we do that, the reader needs to know the assumption that there's always a default noopcrypter which gets used when there's no encryption involved. IMO using the proposed approach, it's more explicit and reads better - if the segment is encrypted, then decryption needs to happen.", "author": "sajjad-moradi", "createdAt": "2020-07-02T19:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODcxOQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r448698719", "body": "is this making a ZK call? ", "bodyText": "is this making a ZK call?", "bodyHTML": "<p dir=\"auto\">is this making a ZK call?</p>", "author": "kishoreg", "createdAt": "2020-07-02T01:29:28Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/PinotSegmentUploadDownloadRestletResource.java", "diffHunk": "@@ -251,6 +246,17 @@ private SuccessResponse uploadSegment(@Nullable String tableName, FormDataMultiP\n           _controllerMetrics, _leadControllerManager.isLeaderForTable(offlineTableName))\n           .validateOfflineSegment(offlineTableName, segmentMetadata, tempSegmentDir);\n \n+      // Encrypt segment\n+      String crypterClassNameInTableConfig =", "originalCommit": "289ca9ec4d4f3f6f5e74e191826d429f76fca9ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxMzE3MQ==", "url": "https://github.com/apache/pinot/pull/5617#discussion_r449213171", "bodyText": "No, it uses an existing TableCache which gets updated upon changes.", "author": "sajjad-moradi", "createdAt": "2020-07-02T19:01:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5ODcxOQ=="}], "type": "inlineReview"}]}