{"pr_number": 5872, "pr_title": "Support for exact distinct count for non int data types", "pr_author": "kishoreg", "pr_createdAt": "2020-08-16T09:31:41Z", "pr_url": "https://github.com/apache/pinot/pull/5872", "timeline": [{"oid": "ef30e07e696bb80f5fb31f6557676768cf4ad457", "url": "https://github.com/apache/pinot/commit/ef30e07e696bb80f5fb31f6557676768cf4ad457", "message": "Fixing serde for  bytesset", "committedDate": "2020-08-17T05:55:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2Mzc1OQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471263759", "body": "Float.BYTES", "bodyText": "Float.BYTES", "bodyHTML": "<p dir=\"auto\">Float.BYTES</p>", "author": "xiangfu0", "createdAt": "2020-08-17T06:49:48Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +478,142 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];", "originalCommit": "ef30e07e696bb80f5fb31f6557676768cf4ad457", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2MzkyNA==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471263924", "body": "byteBuffer.getFloat()", "bodyText": "byteBuffer.getFloat()", "bodyHTML": "<p dir=\"auto\">byteBuffer.getFloat()</p>", "author": "xiangfu0", "createdAt": "2020-08-17T06:50:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +478,142 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      FloatIterator iterator = floatSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putFloat(iterator.nextFloat());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      FloatSet floatSet = new FloatOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        floatSet.add(byteBuffer.getLong());", "originalCommit": "ef30e07e696bb80f5fb31f6557676768cf4ad457", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2Mzk5NQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471263995", "body": "Double.BYTES", "bodyText": "Double.BYTES", "bodyHTML": "<p dir=\"auto\">Double.BYTES</p>", "author": "xiangfu0", "createdAt": "2020-08-17T06:50:28Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +478,142 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      FloatIterator iterator = floatSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putFloat(iterator.nextFloat());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public FloatSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      FloatSet floatSet = new FloatOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        floatSet.add(byteBuffer.getLong());\n+      }\n+      return floatSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<DoubleSet> DOUBLE_SET_SER_DE = new ObjectSerDe<DoubleSet>() {\n+\n+    @Override\n+    public byte[] serialize(DoubleSet doubleSet) {\n+      int size = doubleSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];", "originalCommit": "ef30e07e696bb80f5fb31f6557676768cf4ad457", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MTIzNg==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471661236", "body": "What is this for?", "bodyText": "What is this for?", "bodyHTML": "<p dir=\"auto\">What is this for?</p>", "author": "Jackie-Jiang", "createdAt": "2020-08-17T17:53:33Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/function/AggregationFunctionType.java", "diffHunk": "@@ -61,7 +61,8 @@\n   PERCENTILEMV(\"percentileMV\"),\n   PERCENTILEESTMV(\"percentileEstMV\"),\n   PERCENTILETDIGESTMV(\"percentileTDigestMV\"),\n-  DISTINCT(\"distinct\");\n+  DISTINCT(\"distinct\"),\n+  DISTINCTRAWBLOOMFILTER(\"distinctRawBloomFilter\");", "originalCommit": "3c531f32b734be6004add1f3e138f42bf9e7c1f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTczNjQxMg==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471736412", "bodyText": "removed it", "author": "kishoreg", "createdAt": "2020-08-17T19:46:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2MTIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2Mzk0NA==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471663944", "body": "```suggestion\r\n      } else if (value instanceof FloatSet) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  } else if (value instanceof it.unimi.dsi.fastutil.floats.FloatSet) {\n          \n          \n            \n                  } else if (value instanceof FloatSet) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (value <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\"><span class=\"x x-first\">it.unimi.dsi.fastutil.floats</span><span class=\"pl-k x x-last\">.</span>FloatSet</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (value <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">FloatSet</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-08-17T17:58:19Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -111,6 +127,14 @@ public static ObjectType getObjectType(Object value) {\n         return ObjectType.Geometry;\n       } else if (value instanceof RoaringBitmap) {\n         return ObjectType.RoaringBitmap;\n+      } else if (value instanceof LongSet) {\n+        return ObjectType.LongSet;\n+      } else if (value instanceof it.unimi.dsi.fastutil.floats.FloatSet) {", "originalCommit": "3c531f32b734be6004add1f3e138f42bf9e7c1f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NDAyNw==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471664027", "body": "```suggestion\r\n      } else if (value instanceof DoubleSet) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  } else if (value instanceof it.unimi.dsi.fastutil.doubles.DoubleSet) {\n          \n          \n            \n                  } else if (value instanceof DoubleSet) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (value <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\"><span class=\"x x-first\">it.unimi.dsi.fastutil.doubles</span><span class=\"pl-k x x-last\">.</span>DoubleSet</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (value <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">DoubleSet</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-08-17T17:58:29Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -111,6 +127,14 @@ public static ObjectType getObjectType(Object value) {\n         return ObjectType.Geometry;\n       } else if (value instanceof RoaringBitmap) {\n         return ObjectType.RoaringBitmap;\n+      } else if (value instanceof LongSet) {\n+        return ObjectType.LongSet;\n+      } else if (value instanceof it.unimi.dsi.fastutil.floats.FloatSet) {\n+        return ObjectType.FloatSet;\n+      } else if (value instanceof it.unimi.dsi.fastutil.doubles.DoubleSet) {", "originalCommit": "3c531f32b734be6004add1f3e138f42bf9e7c1f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NDk3MQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471664971", "body": "Revert this reformat (you may want to enable formatter markers in comments in your IDE)", "bodyText": "Revert this reformat (you may want to enable formatter markers in comments in your IDE)", "bodyHTML": "<p dir=\"auto\">Revert this reformat (you may want to enable formatter markers in comments in your IDE)</p>", "author": "Jackie-Jiang", "createdAt": "2020-08-17T18:00:12Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -538,23 +695,8 @@ public RoaringBitmap deserialize(ByteBuffer byteBuffer) {\n \n   // NOTE: DO NOT change the order, it has to be the same order as the ObjectType\n   //@formatter:off\n-  private static final ObjectSerDe[] SER_DES = {\n-      STRING_SER_DE,\n-      LONG_SER_DE,\n-      DOUBLE_SER_DE,\n-      DOUBLE_ARRAY_LIST_SER_DE,\n-      AVG_PAIR_SER_DE,\n-      MIN_MAX_RANGE_PAIR_SER_DE,\n-      HYPER_LOG_LOG_SER_DE,\n-      QUANTILE_DIGEST_SER_DE,\n-      MAP_SER_DE,\n-      INT_SET_SER_DE,\n-      TDIGEST_SER_DE,\n-      DISTINCT_TABLE_SER_DE,\n-      DATA_SKETCH_SER_DE,\n-      GEOMETRY_SER_DE,\n-      ROARING_BITMAP_SER_DE\n-  };\n+  private static final ObjectSerDe[] SER_DES =", "originalCommit": "3c531f32b734be6004add1f3e138f42bf9e7c1f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NTc1NQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471665755", "body": "Suggest using `ByteArray` instead of `ByteBuffer` to store bytes", "bodyText": "Suggest using ByteArray instead of ByteBuffer to store bytes", "bodyHTML": "<p dir=\"auto\">Suggest using <code>ByteArray</code> instead of <code>ByteBuffer</code> to store bytes</p>", "author": "Jackie-Jiang", "createdAt": "2020-08-17T18:01:38Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/query/DictionaryBasedAggregationOperator.java", "diffHunk": "@@ -77,36 +83,42 @@ protected IntermediateResultsBlock getNextBlock() {\n               .add(new MinMaxRangePair(dictionary.getDoubleValue(0), dictionary.getDoubleValue(dictionarySize - 1)));\n           break;\n         case DISTINCTCOUNT:\n-          IntOpenHashSet set = new IntOpenHashSet(dictionarySize);\n+          AbstractCollection set;\n           switch (dictionary.getValueType()) {\n             case INT:\n+              set = new IntOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n                 set.add(dictionary.getIntValue(dictId));\n               }\n               break;\n             case LONG:\n+              set = new LongOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Long.hashCode(dictionary.getLongValue(dictId)));\n+                set.add(dictionary.getLongValue(dictId));\n               }\n               break;\n             case FLOAT:\n+              set = new FloatOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Float.hashCode(dictionary.getFloatValue(dictId)));\n+                set.add(dictionary.getFloatValue(dictId));\n               }\n               break;\n             case DOUBLE:\n+              set = new DoubleOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Double.hashCode(dictionary.getDoubleValue(dictId)));\n+                set.add(dictionary.getDoubleValue(dictId));\n               }\n               break;\n             case STRING:\n+              set = new ObjectOpenHashSet<ByteBuffer>(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(dictionary.getStringValue(dictId).hashCode());\n+                set.add(ByteBuffer.wrap(dictionary.getStringValue(dictId).getBytes(Charsets.UTF_8)));", "originalCommit": "3c531f32b734be6004add1f3e138f42bf9e7c1f6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NjIwMQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471666201", "bodyText": "Use StringUtils.encodeUtf8() to encode string for better performance", "author": "Jackie-Jiang", "createdAt": "2020-08-17T18:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2NTc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY2ODkzOA==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471668938", "body": "I don't think this works for ser/de. You need to construct a type specific set based on the data type", "bodyText": "I don't think this works for ser/de. You need to construct a type specific set based on the data type", "bodyHTML": "<p dir=\"auto\">I don't think this works for ser/de. You need to construct a type specific set based on the data type</p>", "author": "Jackie-Jiang", "createdAt": "2020-08-17T18:07:27Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/query/aggregation/function/DistinctCountAggregationFunction.java", "diffHunk": "@@ -233,41 +241,103 @@ public void aggregateGroupByMV(int length, int[][] groupKeysArray, GroupByResult\n   }\n \n   @Override\n-  public IntOpenHashSet extractAggregationResult(AggregationResultHolder aggregationResultHolder) {\n+  public AbstractCollection extractAggregationResult(AggregationResultHolder aggregationResultHolder) {\n     Object result = aggregationResultHolder.getResult();\n     if (result == null) {\n-      return new IntOpenHashSet();\n+      return emptyCollection();\n     }\n \n     if (result instanceof DictIdsWrapper) {\n       // For dictionary-encoded expression, convert dictionary ids to hash code of the values\n       return convertToValueSet((DictIdsWrapper) result);\n     } else {\n       // For non-dictionary-encoded expression, directly return the value set\n-      return (IntOpenHashSet) result;\n+      return (AbstractCollection) result;\n     }\n   }\n \n+  private AbstractCollection emptyCollection() {\n+    return new AbstractCollection() {", "originalCommit": "3c531f32b734be6004add1f3e138f42bf9e7c1f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NjkzOQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471796939", "body": "Wondering if we should have a single ser/de for different data types, by writing the data type as part of header. Not sure if the iterators share the same interface to be able to share the same `serialize()`.", "bodyText": "Wondering if we should have a single ser/de for different data types, by writing the data type as part of header. Not sure if the iterators share the same interface to be able to share the same serialize().", "bodyHTML": "<p dir=\"auto\">Wondering if we should have a single ser/de for different data types, by writing the data type as part of header. Not sure if the iterators share the same interface to be able to share the same <code>serialize()</code>.</p>", "author": "mayankshriv", "createdAt": "2020-08-17T21:56:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -452,6 +476,139 @@ public IntSet deserialize(ByteBuffer byteBuffer) {\n     }\n   };\n \n+  public static final ObjectSerDe<LongSet> LONG_SET_SER_DE = new ObjectSerDe<LongSet>() {\n+\n+    @Override\n+    public byte[] serialize(LongSet longSet) {\n+      int size = longSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Long.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);\n+      LongIterator iterator = longSet.iterator();\n+      while (iterator.hasNext()) {\n+        byteBuffer.putLong(iterator.nextLong());\n+      }\n+      return bytes;\n+    }\n+\n+    @Override\n+    public LongSet deserialize(byte[] bytes) {\n+      return deserialize(ByteBuffer.wrap(bytes));\n+    }\n+\n+    @Override\n+    public LongSet deserialize(ByteBuffer byteBuffer) {\n+      int size = byteBuffer.getInt();\n+      LongSet longSet = new LongOpenHashSet(size);\n+      for (int i = 0; i < size; i++) {\n+        longSet.add(byteBuffer.getLong());\n+      }\n+      return longSet;\n+    }\n+  };\n+\n+  public static final ObjectSerDe<FloatSet> FLOAT_SET_SER_DE = new ObjectSerDe<FloatSet>() {\n+\n+    @Override\n+    public byte[] serialize(FloatSet floatSet) {\n+      int size = floatSet.size();\n+      byte[] bytes = new byte[Integer.BYTES + size * Float.BYTES];\n+      ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);\n+      byteBuffer.putInt(size);", "originalCommit": "e5fd3a07afc50ea06daf3b379b534be3e28cdb8d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ1MzQ1Ng==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r473453456", "bodyText": "We are using fastutil Sets for better performance, and each Set has its own iterator class. Keeping them separate is more readable IMO. The ObjectType info is already maintained in the header, no need to introduce another level of type info.", "author": "Jackie-Jiang", "createdAt": "2020-08-20T00:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5NjkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTc5ODE1Mw==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r471798153", "body": "why not byte[]?", "bodyText": "why not byte[]?", "bodyHTML": "<p dir=\"auto\">why not byte[]?</p>", "author": "mayankshriv", "createdAt": "2020-08-17T21:59:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/operator/query/DictionaryBasedAggregationOperator.java", "diffHunk": "@@ -77,36 +83,42 @@ protected IntermediateResultsBlock getNextBlock() {\n               .add(new MinMaxRangePair(dictionary.getDoubleValue(0), dictionary.getDoubleValue(dictionarySize - 1)));\n           break;\n         case DISTINCTCOUNT:\n-          IntOpenHashSet set = new IntOpenHashSet(dictionarySize);\n+          AbstractCollection set;\n           switch (dictionary.getValueType()) {\n             case INT:\n+              set = new IntOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n                 set.add(dictionary.getIntValue(dictId));\n               }\n               break;\n             case LONG:\n+              set = new LongOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Long.hashCode(dictionary.getLongValue(dictId)));\n+                set.add(dictionary.getLongValue(dictId));\n               }\n               break;\n             case FLOAT:\n+              set = new FloatOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Float.hashCode(dictionary.getFloatValue(dictId)));\n+                set.add(dictionary.getFloatValue(dictId));\n               }\n               break;\n             case DOUBLE:\n+              set = new DoubleOpenHashSet(dictionarySize);\n               for (int dictId = 0; dictId < dictionarySize; dictId++) {\n-                set.add(Double.hashCode(dictionary.getDoubleValue(dictId)));\n+                set.add(dictionary.getDoubleValue(dictId));\n               }\n               break;\n             case STRING:\n+              set = new ObjectOpenHashSet<ByteBuffer>(dictionarySize);", "originalCommit": "e5fd3a07afc50ea06daf3b379b534be3e28cdb8d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "18105504b22008b45a585cd592b4e10cd4bf337a", "url": "https://github.com/apache/pinot/commit/18105504b22008b45a585cd592b4e10cd4bf337a", "message": "Support exact distinct count", "committedDate": "2020-08-19T23:45:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5MzcwNQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r473493705", "body": "will this be a problem as we always return StringSet for empty value?", "bodyText": "will this be a problem as we always return StringSet for empty value?", "bodyHTML": "<p dir=\"auto\">will this be a problem as we always return StringSet for empty value?</p>", "author": "xiangfu0", "createdAt": "2020-08-20T01:02:01Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/common/ObjectSerDeUtils.java", "diffHunk": "@@ -111,6 +131,19 @@ public static ObjectType getObjectType(Object value) {\n         return ObjectType.Geometry;\n       } else if (value instanceof RoaringBitmap) {\n         return ObjectType.RoaringBitmap;\n+      } else if (value instanceof LongSet) {\n+        return ObjectType.LongSet;\n+      } else if (value instanceof FloatSet) {\n+        return ObjectType.FloatSet;\n+      } else if (value instanceof DoubleSet) {\n+        return ObjectType.DoubleSet;\n+      } else if (value instanceof ObjectSet) {\n+        ObjectSet objectSet = (ObjectSet) value;\n+        if (objectSet.isEmpty() || objectSet.iterator().next() instanceof String) {", "originalCommit": "18105504b22008b45a585cd592b4e10cd4bf337a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0ODEyMQ==", "url": "https://github.com/apache/pinot/pull/5872#discussion_r473548121", "bodyText": "It is fine for empty set as empty string set and empty bytes set are the same (both are empty ObjectOpenHashSet)", "author": "Jackie-Jiang", "createdAt": "2020-08-20T02:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzQ5MzcwNQ=="}], "type": "inlineReview"}, {"oid": "1159f79a88b6727e50db9cc50e3a71f400d9d3cc", "url": "https://github.com/apache/pinot/commit/1159f79a88b6727e50db9cc50e3a71f400d9d3cc", "message": "Support exact distinct count", "committedDate": "2020-08-20T18:28:02Z", "type": "commit"}, {"oid": "a6836284047eb98f4c4c8aa2832310945f31efeb", "url": "https://github.com/apache/pinot/commit/a6836284047eb98f4c4c8aa2832310945f31efeb", "message": "Add DistinctCountBitmap query override", "committedDate": "2020-08-20T18:28:02Z", "type": "forcePushed"}, {"oid": "4fdf4cdbb24c468cb4d4ecf465551b485df38f4c", "url": "https://github.com/apache/pinot/commit/4fdf4cdbb24c468cb4d4ecf465551b485df38f4c", "message": "Add DistinctCountBitmap query override", "committedDate": "2020-08-20T18:32:22Z", "type": "commit"}, {"oid": "4fdf4cdbb24c468cb4d4ecf465551b485df38f4c", "url": "https://github.com/apache/pinot/commit/4fdf4cdbb24c468cb4d4ecf465551b485df38f4c", "message": "Add DistinctCountBitmap query override", "committedDate": "2020-08-20T18:32:22Z", "type": "forcePushed"}]}