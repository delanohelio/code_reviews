{"pr_number": 6119, "pr_title": "Change Signature of Broker API in Controller", "pr_author": "KKcorps", "pr_createdAt": "2020-10-08T08:21:06Z", "pr_url": "https://github.com/apache/pinot/pull/6119", "timeline": [{"oid": "41a821824d52911baa5767190e345ad265febad8", "url": "https://github.com/apache/pinot/commit/41a821824d52911baa5767190e345ad265febad8", "message": "Add code for v2 broker api", "committedDate": "2020-10-08T07:18:12Z", "type": "commit"}, {"oid": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "url": "https://github.com/apache/pinot/commit/987a01d267f2b67798386d5c002c3d5e4275ba2f", "message": "Change v1 methods to use v2 signature", "committedDate": "2020-10-08T07:50:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjA5MA==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502132090", "body": "Can we keep the old implementation as there are performance differences", "bodyText": "Can we keep the old implementation as there are performance differences", "bodyHTML": "<p dir=\"auto\">Can we keep the old implementation as there are performance differences</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:06:17Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -422,10 +423,15 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * reuse instance configs in order to reduce ZK accesses\n    */\n   public static List<String> getInstancesWithTag(List<InstanceConfig> instanceConfigs, String tag) {\n-    List<String> instancesWithTag = new ArrayList<>();\n+    List<InstanceConfig> instancesWithTag = getInstancesConfigsWithTag(instanceConfigs, tag);\n+    return instancesWithTag.stream().map(InstanceConfig::getInstanceName).collect(Collectors.toList());", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5NTk5Nw==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502295997", "bodyText": "These APIs won't be called frequently. The only use of this API is to determine brokers for a tenant or table while creating a connection for a query. Once the connection is created, the API is only called again if the connection breaks.", "author": "KKcorps", "createdAt": "2020-10-09T09:13:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjU2OQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502132569", "body": "```suggestion\r\n    return new HashSet<>(getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return new HashSet<>(HelixHelper.getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n          \n          \n            \n                return new HashSet<>(getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashSet&lt;&gt;</span>(<span class=\"pl-smi x x-first\">HelixHelper</span><span class=\"pl-k x x-last\">.</span>getInstancesConfigsWithTag(instanceConfigs, <span class=\"pl-smi\">TagNameUtils</span><span class=\"pl-k\">.</span>getBrokerTagForTenant(tenant)));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashSet&lt;&gt;</span>(getInstancesConfigsWithTag(instanceConfigs, <span class=\"pl-smi\">TagNameUtils</span><span class=\"pl-k\">.</span>getBrokerTagForTenant(tenant)));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:07:21Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -474,6 +480,12 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * TODO: refactor code to use this method if applicable to reuse instance configs in order to reduce ZK accesses\n    */\n   public static Set<String> getBrokerInstancesForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n-    return new HashSet<>(HelixHelper.getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n+    return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n+        Collectors.toSet());\n   }\n+\n+  public static Set<InstanceConfig> getBrokerInstanceConfigsForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n+    return new HashSet<>(HelixHelper.getInstancesConfigsWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjMwMDczOQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502300739", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:21:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMjU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzE3MQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502133171", "body": "```suggestion\r\n    return new HashSet<>(getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n          \n          \n            \n                    Collectors.toSet());\n          \n          \n            \n                return new HashSet<>(getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">return</span> getBrokerInstanceConfigsForTenant(instanceConfigs, tenant)<span class=\"pl-k\">.</span>stream()<span class=\"pl-k\">.</span>map(<span class=\"pl-smi\">InstanceConfig</span><span class=\"pl-k\">::</span>getInstanceName)<span class=\"pl-k\">.</span>collect(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>toSet());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashSet&lt;&gt;</span>(getInstancesWithTag(instanceConfigs, <span class=\"pl-smi\">TagNameUtils</span><span class=\"pl-k\">.</span>getBrokerTagForTenant(tenant)));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:08:31Z", "path": "pinot-common/src/main/java/org/apache/pinot/common/utils/helix/HelixHelper.java", "diffHunk": "@@ -474,6 +480,12 @@ public IdealState apply(@Nullable IdealState idealState) {\n    * TODO: refactor code to use this method if applicable to reuse instance configs in order to reduce ZK accesses\n    */\n   public static Set<String> getBrokerInstancesForTenant(List<InstanceConfig> instanceConfigs, String tenant) {\n-    return new HashSet<>(HelixHelper.getInstancesWithTag(instanceConfigs, TagNameUtils.getBrokerTagForTenant(tenant)));\n+    return getBrokerInstanceConfigsForTenant(instanceConfigs, tenant).stream().map(InstanceConfig::getInstanceName).collect(\n+        Collectors.toSet());", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTgzMg==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299832", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:19:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzE3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzQ1Mg==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502133452", "body": "Is this used?", "bodyText": "Is this used?", "bodyHTML": "<p dir=\"auto\">Is this used?</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:09:03Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/Constants.java", "diffHunk": "@@ -36,6 +36,7 @@\n   public static final String SCHEMA_TAG = \"Schema\";\n   public static final String TENANT_TAG = \"Tenant\";\n   public static final String BROKER_TAG = \"Broker\";\n+  public static final String BROKER_V2_TAG = \"BrokerV2\";", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTc2OQ==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299769", "bodyText": "removed", "author": "KKcorps", "createdAt": "2020-10-09T09:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzMzQ1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEzNjY1Ng==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502136656", "body": "Again suggest keeping the current logic for performance concern if this will be called frequently. You may extract a helper function for getting the `brokerTenantName` to avoid duplicate code", "bodyText": "Again suggest keeping the current logic for performance concern if this will be called frequently. You may extract a helper function for getting the brokerTenantName to avoid duplicate code", "bodyHTML": "<p dir=\"auto\">Again suggest keeping the current logic for performance concern if this will be called frequently. You may extract a helper function for getting the <code>brokerTenantName</code> to avoid duplicate code</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-09T02:15:00Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/helix/core/PinotHelixResourceManager.java", "diffHunk": "@@ -348,6 +348,11 @@ public InstanceZKMetadata getInstanceZKMetadata(String instanceId) {\n    * @return List of broker instance Ids\n    */\n   public List<String> getBrokerInstancesFor(String tableName) {\n+    List<InstanceConfig> instanceConfigList = getBrokerInstancesConfigsFor(tableName);\n+    return instanceConfigList.stream().map(InstanceConfig::getInstanceName).collect(Collectors.toList());", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDQ0OA==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502164448", "body": "Suggest renaming it to `InstanceInfo` so that it can be reused for server instances if necessary.", "bodyText": "Suggest renaming it to InstanceInfo so that it can be reused for server instances if necessary.", "bodyHTML": "<p dir=\"auto\">Suggest renaming it to <code>InstanceInfo</code> so that it can be reused for server instances if necessary.</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-09T03:27:21Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/ControllerBrokerResponse.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+public class ControllerBrokerResponse {", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTUyNg==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299526", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDU4NA==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502164584", "body": "You can change these variables to final and remove the setters as they are not needed", "bodyText": "You can change these variables to final and remove the setters as they are not needed", "bodyHTML": "<p dir=\"auto\">You can change these variables to final and remove the setters as they are not needed</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-09T03:27:55Z", "path": "pinot-controller/src/main/java/org/apache/pinot/controller/api/resources/ControllerBrokerResponse.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.pinot.controller.api.resources;\n+\n+public class ControllerBrokerResponse {\n+  private String _instanceName;", "originalCommit": "987a01d267f2b67798386d5c002c3d5e4275ba2f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI5OTQ5Ng==", "url": "https://github.com/apache/pinot/pull/6119#discussion_r502299496", "bodyText": "done", "author": "KKcorps", "createdAt": "2020-10-09T09:19:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjE2NDU4NA=="}], "type": "inlineReview"}, {"oid": "6a1accf846f03c4cac5dbf442594317936a409ac", "url": "https://github.com/apache/pinot/commit/6a1accf846f03c4cac5dbf442594317936a409ac", "message": "Refactor: Change class name from ControllerBrokerResponse to InstanceInfo", "committedDate": "2020-10-09T09:16:33Z", "type": "commit"}, {"oid": "9b245e6ce88b10d63369a902ffc2ef7205fc7e3b", "url": "https://github.com/apache/pinot/commit/9b245e6ce88b10d63369a902ffc2ef7205fc7e3b", "message": "Refactor: Remove unused constant and reuse functions", "committedDate": "2020-10-09T09:18:43Z", "type": "commit"}, {"oid": "f49a0172a206ccb01f38df840bff3ac250221d8c", "url": "https://github.com/apache/pinot/commit/f49a0172a206ccb01f38df840bff3ac250221d8c", "message": "Refactor: Remove class name from the methods called from same class", "committedDate": "2020-10-09T09:21:12Z", "type": "commit"}]}