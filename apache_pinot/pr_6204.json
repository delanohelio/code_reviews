{"pr_number": 6204, "pr_title": "add upsert metadata metric", "pr_author": "yupeng9", "pr_createdAt": "2020-10-28T00:02:37Z", "pr_url": "https://github.com/apache/pinot/pull/6204", "timeline": [{"oid": "06a34351a71bb88c9a11312d0acb147a8567495d", "url": "https://github.com/apache/pinot/commit/06a34351a71bb88c9a11312d0acb147a8567495d", "message": "add upsert metadata metric of the primary key counts per partition metadata manager", "committedDate": "2020-10-27T23:49:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzM1Nw==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513103357", "body": "Use `_tableNameWithType` for clarity", "bodyText": "Use _tableNameWithType for clarity", "bodyHTML": "<p dir=\"auto\">Use <code>_tableNameWithType</code> for clarity</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:06:43Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManager.java", "diffHunk": "@@ -51,6 +53,16 @@\n public class PartitionUpsertMetadataManager {\n   private static final Logger LOGGER = LoggerFactory.getLogger(PartitionUpsertMetadataManager.class);\n \n+  private final String _tableName;", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzUzMQ==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513103531", "body": "This line is mis-deleted?", "bodyText": "This line is mis-deleted?", "bodyHTML": "<p dir=\"auto\">This line is mis-deleted?</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:07:17Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManager.java", "diffHunk": "@@ -85,8 +97,7 @@ public ThreadSafeMutableRoaringBitmap addSegment(String segmentName, Iterator<Re\n               // committing a consuming segment, or reloading a completed segment.\n \n               // Update the record location when the new timestamp is greater than or equal to the current timestamp.\n-              // Update the record location when there is a tie because the record locations should point to the new\n-              // segment instead of the old segment being replaced. Also, do not update the valid doc ids for the old\n+               // segment instead of the old segment being replaced. Also, do not update the valid doc ids for the old", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEyNDY3Mg==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513124672", "bodyText": "no.. auto formatting", "author": "yupeng9", "createdAt": "2020-10-28T01:23:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc3Nzk1MA==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513777950", "bodyText": "This is not auto formatting. One line is mis-deleted. Please double check", "author": "Jackie-Jiang", "createdAt": "2020-10-28T21:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzUzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwMzk2NA==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513103964", "body": "`_tableNameWithType`", "bodyText": "_tableNameWithType", "bodyHTML": "<p dir=\"auto\"><code>_tableNameWithType</code></p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:08:48Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/TableUpsertMetadataManager.java", "diffHunk": "@@ -29,8 +30,16 @@\n @ThreadSafe\n public class TableUpsertMetadataManager {\n   private final Map<Integer, PartitionUpsertMetadataManager> _partitionMetadataManagerMap = new ConcurrentHashMap<>();\n+  private final String _tableName;", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwNDExMw==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513104113", "body": "(nit)\r\n```suggestion\r\n        .computeIfAbsent(partitionId, k -> new PartitionUpsertMetadataManager(_tableName, k, _serverMetrics));\r\n```", "bodyText": "(nit)\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .computeIfAbsent(partitionId, k -> new PartitionUpsertMetadataManager(_tableName, partitionId, _serverMetrics));\n          \n          \n            \n                    .computeIfAbsent(partitionId, k -> new PartitionUpsertMetadataManager(_tableName, k, _serverMetrics));", "bodyHTML": "<p dir=\"auto\">(nit)</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        .computeIfAbsent(partitionId, k <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">PartitionUpsertMetadataManager</span>(_tableName, <span class=\"x x-first x-last\">partitionId</span>, _serverMetrics));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        .computeIfAbsent(partitionId, k <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">PartitionUpsertMetadataManager</span>(_tableName, <span class=\"x x-first x-last\">k</span>, _serverMetrics));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:09:16Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/TableUpsertMetadataManager.java", "diffHunk": "@@ -29,8 +30,16 @@\n @ThreadSafe\n public class TableUpsertMetadataManager {\n   private final Map<Integer, PartitionUpsertMetadataManager> _partitionMetadataManagerMap = new ConcurrentHashMap<>();\n+  private final String _tableName;\n+  private final ServerMetrics _serverMetrics;\n+\n+  public TableUpsertMetadataManager(String tableName, ServerMetrics serverMetrics) {\n+    _tableName = tableName;\n+    _serverMetrics = serverMetrics;\n+  }\n \n   public PartitionUpsertMetadataManager getOrCreatePartitionManager(int partitionId) {\n-    return _partitionMetadataManagerMap.computeIfAbsent(partitionId, k -> new PartitionUpsertMetadataManager());\n+    return _partitionMetadataManagerMap\n+        .computeIfAbsent(partitionId, k -> new PartitionUpsertMetadataManager(_tableName, partitionId, _serverMetrics));", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwNDc0NQ==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513104745", "body": "Use the serverMetrics available instead of mocking one", "bodyText": "Use the serverMetrics available instead of mocking one", "bodyHTML": "<p dir=\"auto\">Use the serverMetrics available instead of mocking one</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:11:29Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java", "diffHunk": "@@ -800,7 +801,8 @@ public FakeLLRealtimeSegmentDataManager(RealtimeSegmentZKMetadata segmentZKMetad\n         throws Exception {\n       super(segmentZKMetadata, tableConfig, realtimeTableDataManager, resourceDataDir,\n           new IndexLoadingConfig(makeInstanceDataManagerConfig(), tableConfig), schema, llcSegmentName,\n-          semaphoreMap.get(llcSegmentName.getPartitionId()), serverMetrics, new PartitionUpsertMetadataManager());\n+          semaphoreMap.get(llcSegmentName.getPartitionId()), serverMetrics,\n+          new PartitionUpsertMetadataManager(\"testTable\", 0, Mockito.mock(ServerMetrics.class)));", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwNTIyNg==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513105226", "body": "(nit) Mock a ServerMetrics here locally instead of having a member variable", "bodyText": "(nit) Mock a ServerMetrics here locally instead of having a member variable", "bodyHTML": "<p dir=\"auto\">(nit) Mock a ServerMetrics here locally instead of having a member variable</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:13:21Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/plan/maker/MetadataAndDictionaryAggregationPlanMakerTest.java", "diffHunk": "@@ -121,7 +125,8 @@ public void loadSegment()\n     _indexSegment = ImmutableSegmentLoader.load(new File(INDEX_DIR, SEGMENT_NAME), ReadMode.heap);\n     _upsertIndexSegment = ImmutableSegmentLoader.load(new File(INDEX_DIR, SEGMENT_NAME), ReadMode.heap);\n     ((ImmutableSegmentImpl) _upsertIndexSegment)\n-        .enableUpsert(new PartitionUpsertMetadataManager(), new ThreadSafeMutableRoaringBitmap());\n+        .enableUpsert(new PartitionUpsertMetadataManager(\"testTable\", 0, _serverMetrics),", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwNTQ5OQ==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513105499", "body": "Make `\"testTable\"` a constant and change it to `testTable_REALTIME`?", "bodyText": "Make \"testTable\" a constant and change it to testTable_REALTIME?", "bodyHTML": "<p dir=\"auto\">Make <code>\"testTable\"</code> a constant and change it to <code>testTable_REALTIME</code>?</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:14:23Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManagerTest.java", "diffHunk": "@@ -37,7 +39,8 @@\n \n   @Test\n   public void testAddSegment() {\n-    PartitionUpsertMetadataManager upsertMetadataManager = new PartitionUpsertMetadataManager();\n+    PartitionUpsertMetadataManager upsertMetadataManager =\n+        new PartitionUpsertMetadataManager(\"testTable\", 0, Mockito.mock(ServerMetrics.class));", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEwNTczNg==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513105736", "body": "(nit) Capitalize the first character for consistency", "bodyText": "(nit) Capitalize the first character for consistency", "bodyHTML": "<p dir=\"auto\">(nit) Capitalize the first character for consistency</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T00:15:06Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManager.java", "diffHunk": "@@ -113,6 +124,9 @@ public ThreadSafeMutableRoaringBitmap addSegment(String segmentName, Iterator<Re\n         }\n       });\n     }\n+    // update metrics", "originalCommit": "06a34351a71bb88c9a11312d0acb147a8567495d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89602e7fca246dfb0c8008044dee8282a0535129", "url": "https://github.com/apache/pinot/commit/89602e7fca246dfb0c8008044dee8282a0535129", "message": "comments", "committedDate": "2020-10-28T01:29:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc3ODUyNQ==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513778525", "body": "```suggestion\r\n          new PartitionUpsertMetadataManager(\"testTable_REALTIME\", 0, serverMetrics));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      new PartitionUpsertMetadataManager(\"testTable\", 0, serverMetrics));\n          \n          \n            \n                      new PartitionUpsertMetadataManager(\"testTable_REALTIME\", 0, serverMetrics));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">          <span class=\"pl-k\">new</span> <span class=\"pl-smi\">PartitionUpsertMetadataManager</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">0</span>, serverMetrics));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          <span class=\"pl-k\">new</span> <span class=\"pl-smi\">PartitionUpsertMetadataManager</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable_REALTIME</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">0</span>, serverMetrics));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-10-28T21:41:02Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/data/manager/realtime/LLRealtimeSegmentDataManagerTest.java", "diffHunk": "@@ -800,7 +800,8 @@ public FakeLLRealtimeSegmentDataManager(RealtimeSegmentZKMetadata segmentZKMetad\n         throws Exception {\n       super(segmentZKMetadata, tableConfig, realtimeTableDataManager, resourceDataDir,\n           new IndexLoadingConfig(makeInstanceDataManagerConfig(), tableConfig), schema, llcSegmentName,\n-          semaphoreMap.get(llcSegmentName.getPartitionId()), serverMetrics, new PartitionUpsertMetadataManager());\n+          semaphoreMap.get(llcSegmentName.getPartitionId()), serverMetrics,\n+          new PartitionUpsertMetadataManager(\"testTable\", 0, serverMetrics));", "originalCommit": "89602e7fca246dfb0c8008044dee8282a0535129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc3ODcyMQ==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513778721", "body": "Revert this removal", "bodyText": "Revert this removal", "bodyHTML": "<p dir=\"auto\">Revert this removal</p>", "author": "Jackie-Jiang", "createdAt": "2020-10-28T21:41:25Z", "path": "pinot-core/src/main/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManager.java", "diffHunk": "@@ -85,7 +97,6 @@ public ThreadSafeMutableRoaringBitmap addSegment(String segmentName, Iterator<Re\n               // committing a consuming segment, or reloading a completed segment.\n \n               // Update the record location when the new timestamp is greater than or equal to the current timestamp.\n-              // Update the record location when there is a tie because the record locations should point to the new", "originalCommit": "89602e7fca246dfb0c8008044dee8282a0535129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc3OTAyMg==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513779022", "body": "```suggestion\r\n        new TableUpsertMetadataManager(\"testTable_REALTINE\", Mockito.mock(ServerMetrics.class)).getOrCreatePartitionManager(0);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    new TableUpsertMetadataManager(\"testTable\", Mockito.mock(ServerMetrics.class)).getOrCreatePartitionManager(0);\n          \n          \n            \n                    new TableUpsertMetadataManager(\"testTable_REALTINE\", Mockito.mock(ServerMetrics.class)).getOrCreatePartitionManager(0);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">new</span> <span class=\"pl-smi\">TableUpsertMetadataManager</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-smi\">Mockito</span><span class=\"pl-k\">.</span>mock(<span class=\"pl-smi\">ServerMetrics</span><span class=\"pl-k\">.</span>class))<span class=\"pl-k\">.</span>getOrCreatePartitionManager(<span class=\"pl-c1\">0</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">new</span> <span class=\"pl-smi\">TableUpsertMetadataManager</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable_REALTINE</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-smi\">Mockito</span><span class=\"pl-k\">.</span>mock(<span class=\"pl-smi\">ServerMetrics</span><span class=\"pl-k\">.</span>class))<span class=\"pl-k\">.</span>getOrCreatePartitionManager(<span class=\"pl-c1\">0</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-10-28T21:42:01Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/indexsegment/mutable/MutableSegmentImplUpsertTest.java", "diffHunk": "@@ -58,7 +60,8 @@ public void setup()\n         .setUpsertConfig(new UpsertConfig(UpsertConfig.Mode.FULL)).build();\n     _recordTransformer = CompositeTransformer.getDefaultTransformer(_tableConfig, _schema);\n     File jsonFile = new File(dataResourceUrl.getFile());\n-    _partitionUpsertMetadataManager = new TableUpsertMetadataManager().getOrCreatePartitionManager(0);\n+    _partitionUpsertMetadataManager =\n+        new TableUpsertMetadataManager(\"testTable\", Mockito.mock(ServerMetrics.class)).getOrCreatePartitionManager(0);", "originalCommit": "89602e7fca246dfb0c8008044dee8282a0535129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc3OTE4MQ==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513779181", "body": "```suggestion\r\n        .enableUpsert(new PartitionUpsertMetadataManager(\"testTable_REALTIME\", 0, serverMetrics),\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .enableUpsert(new PartitionUpsertMetadataManager(\"testTable\", 0, serverMetrics),\n          \n          \n            \n                    .enableUpsert(new PartitionUpsertMetadataManager(\"testTable_REALTIME\", 0, serverMetrics),", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        .enableUpsert(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">PartitionUpsertMetadataManager</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">0</span>, serverMetrics),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        .enableUpsert(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">PartitionUpsertMetadataManager</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable_REALTIME</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-c1\">0</span>, serverMetrics),</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-10-28T21:42:22Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/plan/maker/MetadataAndDictionaryAggregationPlanMakerTest.java", "diffHunk": "@@ -119,9 +121,11 @@ public void buildSegment()\n   public void loadSegment()\n       throws Exception {\n     _indexSegment = ImmutableSegmentLoader.load(new File(INDEX_DIR, SEGMENT_NAME), ReadMode.heap);\n+    ServerMetrics serverMetrics = Mockito.mock(ServerMetrics.class);\n     _upsertIndexSegment = ImmutableSegmentLoader.load(new File(INDEX_DIR, SEGMENT_NAME), ReadMode.heap);\n     ((ImmutableSegmentImpl) _upsertIndexSegment)\n-        .enableUpsert(new PartitionUpsertMetadataManager(), new ThreadSafeMutableRoaringBitmap());\n+        .enableUpsert(new PartitionUpsertMetadataManager(\"testTable\", 0, serverMetrics),", "originalCommit": "89602e7fca246dfb0c8008044dee8282a0535129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc3OTUyMg==", "url": "https://github.com/apache/pinot/pull/6204#discussion_r513779522", "body": "```suggestion\r\n  private static final String REALTIME_TABLE_NAME = \"testTable_REALTIME\";\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final String TEST_TABLE = \"testTable\";\n          \n          \n            \n              private static final String REALTIME_TABLE_NAME = \"testTable_REALTIME\";", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">TEST_TABLE</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable</span><span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">REALTIME_TABLE_NAME</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">testTable_REALTIME</span><span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Jackie-Jiang", "createdAt": "2020-10-28T21:43:02Z", "path": "pinot-core/src/test/java/org/apache/pinot/core/upsert/PartitionUpsertMetadataManagerTest.java", "diffHunk": "@@ -34,10 +36,12 @@\n \n public class PartitionUpsertMetadataManagerTest {\n   private static final String SEGMENT_PREFIX = \"testSegment\";\n+  private static final String TEST_TABLE = \"testTable\";", "originalCommit": "89602e7fca246dfb0c8008044dee8282a0535129", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e89497b2e88cb0252b17f709d5efcb403a69a888", "url": "https://github.com/apache/pinot/commit/e89497b2e88cb0252b17f709d5efcb403a69a888", "message": "comments", "committedDate": "2020-10-28T22:30:56Z", "type": "commit"}]}