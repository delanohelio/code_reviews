{"pr_number": 7093, "pr_title": "Add control of single topic gc in inactive state.", "pr_author": "zhanghaou", "pr_createdAt": "2020-05-29T06:07:32Z", "pr_url": "https://github.com/apache/pulsar/pull/7093", "timeline": [{"oid": "d8603d75b714b9a3a87bcf37d091d8eb998efb2f", "url": "https://github.com/apache/pulsar/commit/d8603d75b714b9a3a87bcf37d091d8eb998efb2f", "message": "Add control of single topic gc in inactive state.", "committedDate": "2020-05-29T03:30:17Z", "type": "commit"}, {"oid": "6f0fc6a549a8bfbf1ff03aa68b5355149f22cd18", "url": "https://github.com/apache/pulsar/commit/6f0fc6a549a8bfbf1ff03aa68b5355149f22cd18", "message": "use original name of parameter.", "committedDate": "2020-05-29T10:26:22Z", "type": "commit"}, {"oid": "478fb75c18ed95c25acf571988a81c01c2c852b1", "url": "https://github.com/apache/pulsar/commit/478fb75c18ed95c25acf571988a81c01c2c852b1", "message": "add getter and setter.", "committedDate": "2020-05-29T10:28:51Z", "type": "commit"}, {"oid": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "url": "https://github.com/apache/pulsar/commit/9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "message": "change notes.", "committedDate": "2020-05-29T10:33:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NzE3OQ==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432787179", "body": "How is this supposed to be activated? \r\n\r\nInstead, we need a namespace policy, attached to https://pulsar.apache.org/admin-rest-api/?version=2.5.2#operation/setAutoTopicCreation that adds the auto-deletion override configuration, on top of the auto-creation", "bodyText": "How is this supposed to be activated?\nInstead, we need a namespace policy, attached to https://pulsar.apache.org/admin-rest-api/?version=2.5.2#operation/setAutoTopicCreation that adds the auto-deletion override configuration, on top of the auto-creation", "bodyHTML": "<p dir=\"auto\">How is this supposed to be activated?</p>\n<p dir=\"auto\">Instead, we need a namespace policy, attached to <a href=\"https://pulsar.apache.org/admin-rest-api/?version=2.5.2#operation/setAutoTopicCreation\" rel=\"nofollow\">https://pulsar.apache.org/admin-rest-api/?version=2.5.2#operation/setAutoTopicCreation</a> that adds the auto-deletion override configuration, on top of the auto-creation</p>", "author": "merlimat", "createdAt": "2020-05-30T00:01:08Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -423,5 +428,13 @@ public long getBytesOutCounter() {\n         return getStats(false).bytesOutCounter;\n     }\n \n+    public boolean isBrokerDeleteInactiveTopicsEnabled() {\n+        return brokerDeleteInactiveTopicsEnabled;\n+    }\n+\n+    public void setBrokerDeleteInactiveTopicsEnabled(boolean brokerDeleteInactiveTopicsEnabled) {", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjc4Mw==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432902783", "bodyText": "@merlimat This is used by the protocol handlers who want to ensure some topics under the namespace does not delete by the broker. But do not want to change the namespace level policy. Now, we don't have a topic level policy, without this change, we must create a virtual producer or consume.", "author": "codelipenghui", "createdAt": "2020-05-31T02:12:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjc4NzE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjkxMA==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432902910", "body": "I think it's better to named `deleteWhileInactive`.", "bodyText": "I think it's better to named deleteWhileInactive.", "bodyHTML": "<p dir=\"auto\">I think it's better to named <code>deleteWhileInactive</code>.</p>", "author": "codelipenghui", "createdAt": "2020-05-31T02:14:55Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -63,6 +63,9 @@\n \n     protected volatile boolean isFenced;\n \n+    // When set to false, this inactive topic can not be deleted\n+    protected boolean brokerDeleteInactiveTopicsEnabled;", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkzODU4NA==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432938584", "bodyText": "Done.", "author": "zhanghaou", "createdAt": "2020-05-31T11:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMjkxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMzAxMg==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432903012", "body": "```suggestion\r\n        if (! brokerDeleteInactiveTopicsEnabled) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (brokerDeleteInactiveTopicsEnabled) {\n          \n          \n            \n                    if (! brokerDeleteInactiveTopicsEnabled) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (brokerDeleteInactiveTopicsEnabled) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (<span class=\"pl-k x x-first\">!</span><span class=\"x x-last\"> </span>brokerDeleteInactiveTopicsEnabled) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codelipenghui", "createdAt": "2020-05-31T02:17:01Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/nonpersistent/NonPersistentTopic.java", "diffHunk": "@@ -830,6 +830,10 @@ public boolean isActive() {\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n+        if (brokerDeleteInactiveTopicsEnabled) {", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjkwMzAzNQ==", "url": "https://github.com/apache/pulsar/pull/7093#discussion_r432903035", "body": "```suggestion\r\n        if (!brokerDeleteInactiveTopicsEnabled) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (brokerDeleteInactiveTopicsEnabled) {\n          \n          \n            \n                    if (!brokerDeleteInactiveTopicsEnabled) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (brokerDeleteInactiveTopicsEnabled) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (<span class=\"pl-k x x-first x-last\">!</span>brokerDeleteInactiveTopicsEnabled) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codelipenghui", "createdAt": "2020-05-31T02:17:37Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1636,6 +1629,10 @@ private boolean hasBacklogs() {\n \n     @Override\n     public void checkGC(int maxInactiveDurationInSec, InactiveTopicDeleteMode deleteMode) {\n+        if (brokerDeleteInactiveTopicsEnabled) {", "originalCommit": "9adb53867fee4a13b9ee0843270c3cba6a22b2e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e0dc906f26842b0949b344e03b0f8462d51342de", "url": "https://github.com/apache/pulsar/commit/e0dc906f26842b0949b344e03b0f8462d51342de", "message": "rename to deleteWhileInactive and logic fix.", "committedDate": "2020-05-31T11:44:59Z", "type": "commit"}, {"oid": "1efb772a467c93296dfd82ef21eef673a480ebc7", "url": "https://github.com/apache/pulsar/commit/1efb772a467c93296dfd82ef21eef673a480ebc7", "message": "Merge pull request #2 from apache/master\n\nMerge from Pulsar's master branch.", "committedDate": "2020-06-04T02:14:46Z", "type": "commit"}]}