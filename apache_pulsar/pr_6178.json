{"pr_number": 6178, "pr_title": "Introduce maxMessagePublishBufferSizeInMB configuration to avoid broker OOM", "pr_author": "codelipenghui", "pr_createdAt": "2020-01-31T17:01:06Z", "pr_url": "https://github.com/apache/pulsar/pull/6178", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY1MzgzNQ==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r373653835", "body": "This would become a contention point across all the threads in the broker", "bodyText": "This would become a contention point across all the threads in the broker", "bodyHTML": "<p dir=\"auto\">This would become a contention point across all the threads in the broker</p>", "author": "merlimat", "createdAt": "2020-01-31T19:44:41Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2009,4 +2025,49 @@ public ConfigField(Field field) {\n             return Optional.empty();\n         }\n     }\n+\n+    private void enableTopicsAutoRead() {\n+        topics.values().forEach(future -> {\n+            if (future.isDone() && !future.isCompletedExceptionally()) {\n+                try {\n+                    future.get().ifPresent(Topic::enableProducerRead);\n+                } catch (InterruptedException | ExecutionException e) {\n+                   // no-op\n+                }\n+            }\n+        });\n+    }\n+\n+    @VisibleForTesting\n+    boolean increasePublishBufferSizeAndCheckStopRead(int msgSize) {\n+        if (maxMessagePublishBufferSize < 0) {\n+            return false;\n+        }\n+        if (currentMessagePublishBufferSize.addAndGet(msgSize) >= maxMessagePublishBufferSize &&", "originalCommit": "7ce1f44ccfdca31ef473aaac5a09484d2caeeeac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzgxNTExMw==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r373815113", "bodyText": "@merlimat Yes, this does increase competition, how about move currentMessagePublishBufferSize to ServerCnx and periodically sync them to totalMessagePublishBufferSize in BrokerService by a single thread?\nOf course this will cause delays, but it will reduce competition.", "author": "codelipenghui", "createdAt": "2020-02-02T02:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY1MzgzNQ=="}], "type": "inlineReview"}, {"oid": "f92ed4e4f072319e185365c285522c1b5debe0a9", "url": "https://github.com/apache/pulsar/commit/f92ed4e4f072319e185365c285522c1b5debe0a9", "message": "Apply comments", "committedDate": "2020-02-11T15:34:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NzczMQ==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379167731", "body": "The default value should be a value that makes the broker behave as close to the behavior without this code change. I understand we want to enable the rate-limiting feature. So we should try to make the default value as 60% and 70% of max direct memory? Otherwise, people might experience unexpected performance issues when they upgrade a broker from an old version to a newer version.", "bodyText": "The default value should be a value that makes the broker behave as close to the behavior without this code change. I understand we want to enable the rate-limiting feature. So we should try to make the default value as 60% and 70% of max direct memory? Otherwise, people might experience unexpected performance issues when they upgrade a broker from an old version to a newer version.", "bodyHTML": "<p dir=\"auto\">The default value should be a value that makes the broker behave as close to the behavior without this code change. I understand we want to enable the rate-limiting feature. So we should try to make the default value as 60% and 70% of max direct memory? Otherwise, people might experience unexpected performance issues when they upgrade a broker from an old version to a newer version.</p>", "author": "sijie", "createdAt": "2020-02-13T23:01:58Z", "path": "pulsar-broker-common/src/main/java/org/apache/pulsar/broker/ServiceConfiguration.java", "diffHunk": "@@ -603,6 +603,23 @@\n             doc = \"Max number of snapshot to be cached per subscription.\")\n     private int replicatedSubscriptionsSnapshotMaxCachedPerSubscription = 10;\n \n+    @FieldContext(\n+        category = CATEGORY_SERVER,\n+        doc = \"Max memory size for broker handling messages sending from producers.\\n\\n\"\n+            + \" If the processing message size exceed this value, broker will stop read data\"\n+            + \" from the connection. The processing messages means messages are sends to broker\"\n+            + \" but broker have not send response to client, usually waiting to write to bookies.\\n\\n\"\n+            + \" It's shared across all the topics running in the same broker.\\n\\n\"\n+            + \" Use -1 to disable the memory limitation. Default is 1/5 of direct memory.\\n\\n\")\n+    private int maxMessagePublishBufferSizeInMB = Math.max(64,", "originalCommit": "b4be922c38e62054ae0c4270bdc09df1df579d3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQwMjk1NA==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379402954", "bodyText": "Maybe we'd better keep the default value to -1.", "author": "codelipenghui", "createdAt": "2020-02-14T12:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NzczMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTg3MTcwNA==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379871704", "bodyText": "Changed the default buffer size to half of the direct memory.", "author": "codelipenghui", "createdAt": "2020-02-16T03:12:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2NzczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2ODM1Ng==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379168356", "body": "We should create this executor only when the feature is enabled.\r\n\r\nAlso I see we are creating more and more schedulers. Can we consider reusing some of the executors?", "bodyText": "We should create this executor only when the feature is enabled.\nAlso I see we are creating more and more schedulers. Can we consider reusing some of the executors?", "bodyHTML": "<p dir=\"auto\">We should create this executor only when the feature is enabled.</p>\n<p dir=\"auto\">Also I see we are creating more and more schedulers. Can we consider reusing some of the executors?</p>", "author": "sijie", "createdAt": "2020-02-13T23:03:59Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -257,6 +268,8 @@ public BrokerService(PulsarService pulsar) throws Exception {\n                 .newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"pulsar-msg-expiry-monitor\"));\n         this.compactionMonitor =\n             Executors.newSingleThreadScheduledExecutor(new DefaultThreadFactory(\"pulsar-compaction-monitor\"));\n+        this.messagePublishBufferMonitor =", "originalCommit": "b4be922c38e62054ae0c4270bdc09df1df579d3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQwMzM3NQ==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379403375", "bodyText": "Hmm, I think we need a different thread name. It's better for jstack analysis.", "author": "codelipenghui", "createdAt": "2020-02-14T12:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2ODM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2OTI4Mg==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379169282", "body": "It seems to me that this variable doesn't have to be a class variable of `BrokerService`. It can just be a local variable, right?", "bodyText": "It seems to me that this variable doesn't have to be a class variable of BrokerService. It can just be a local variable, right?", "bodyHTML": "<p dir=\"auto\">It seems to me that this variable doesn't have to be a class variable of <code>BrokerService</code>. It can just be a local variable, right?</p>", "author": "sijie", "createdAt": "2020-02-13T23:06:53Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -2011,4 +2033,34 @@ public ConfigField(Field field) {\n             return Optional.empty();\n         }\n     }\n+\n+    private void checkMessagePublishBuffer() {\n+        currentMessagePublishBufferSize = 0;", "originalCommit": "b4be922c38e62054ae0c4270bdc09df1df579d3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQwMzY4Mg==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379403682", "bodyText": "Yes, it is.", "author": "codelipenghui", "createdAt": "2020-02-14T12:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE2OTI4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3MDAwNg==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379170006", "body": "```suggestion\r\n    private volatile boolean reachMessagePublishBufferThreshold;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private volatile boolean isMessagePublishBufferThreshold;\n          \n          \n            \n                private volatile boolean reachMessagePublishBufferThreshold;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">volatile</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">isMessagePublishBufferThreshold</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">volatile</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">reachMessagePublishBufferThreshold</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "sijie", "createdAt": "2020-02-13T23:09:07Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -216,8 +218,17 @@\n     private Channel listenChannel;\n     private Channel listenChannelTls;\n \n+    private final long maxMessagePublishBufferSize;\n+    private final long resumeProducerReadMessagePublishBufferSize;\n+    private volatile long currentMessagePublishBufferSize;\n+    private volatile boolean isMessagePublishBufferThreshold;", "originalCommit": "b4be922c38e62054ae0c4270bdc09df1df579d3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3MDE0MA==", "url": "https://github.com/apache/pulsar/pull/6178#discussion_r379170140", "body": "```suggestion\r\n    private volatile long currentMessagePublishBufferBytes;\r\n```\r\n\r\nI prefer using `bytes` rather than `size` to make the unit more explicit.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private volatile long currentMessagePublishBufferSize;\n          \n          \n            \n                private volatile long currentMessagePublishBufferBytes;\n          \n      \n    \n    \n  \n\nI prefer using bytes rather than size to make the unit more explicit.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">volatile</span> <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">currentMessagePublishBufferSize</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">volatile</span> <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">currentMessagePublishBufferBytes</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I prefer using <code>bytes</code> rather than <code>size</code> to make the unit more explicit.</p>", "author": "sijie", "createdAt": "2020-02-13T23:09:33Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/BrokerService.java", "diffHunk": "@@ -216,8 +218,17 @@\n     private Channel listenChannel;\n     private Channel listenChannelTls;\n \n+    private final long maxMessagePublishBufferSize;\n+    private final long resumeProducerReadMessagePublishBufferSize;\n+    private volatile long currentMessagePublishBufferSize;", "originalCommit": "b4be922c38e62054ae0c4270bdc09df1df579d3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "68d15b5822e16d245ed8ffff7b5197795157d570", "url": "https://github.com/apache/pulsar/commit/68d15b5822e16d245ed8ffff7b5197795157d570", "message": "Add maxMessagePublishBufferSizeInMB configuration to avoid broker OOM", "committedDate": "2020-02-16T02:34:32Z", "type": "commit"}, {"oid": "c3bbbb02cf5704c82041c2d8398506dff1d5c9ca", "url": "https://github.com/apache/pulsar/commit/c3bbbb02cf5704c82041c2d8398506dff1d5c9ca", "message": "Apply comments", "committedDate": "2020-02-16T02:34:33Z", "type": "commit"}, {"oid": "7bbc7a283a68f8e88d9ccfb273c1e87a18a21da9", "url": "https://github.com/apache/pulsar/commit/7bbc7a283a68f8e88d9ccfb273c1e87a18a21da9", "message": "Clean code", "committedDate": "2020-02-16T02:34:33Z", "type": "commit"}, {"oid": "917f29b45d5392d71270ab290266df232201c09b", "url": "https://github.com/apache/pulsar/commit/917f29b45d5392d71270ab290266df232201c09b", "message": "Fix unit test", "committedDate": "2020-02-16T02:34:33Z", "type": "commit"}, {"oid": "917f29b45d5392d71270ab290266df232201c09b", "url": "https://github.com/apache/pulsar/commit/917f29b45d5392d71270ab290266df232201c09b", "message": "Fix unit test", "committedDate": "2020-02-16T02:34:33Z", "type": "forcePushed"}, {"oid": "47923d17fecde87a9017924828577be66c1e6b43", "url": "https://github.com/apache/pulsar/commit/47923d17fecde87a9017924828577be66c1e6b43", "message": "Apply comments", "committedDate": "2020-02-16T02:57:07Z", "type": "commit"}, {"oid": "f752a6ce54cbd58dfc4cb873ccca3a6fdcdc7890", "url": "https://github.com/apache/pulsar/commit/f752a6ce54cbd58dfc4cb873ccca3a6fdcdc7890", "message": "Fix unit tests.", "committedDate": "2020-02-16T13:48:27Z", "type": "commit"}]}