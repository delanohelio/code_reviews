{"pr_number": 7355, "pr_title": "Handling error in creation of non-durable cursor", "pr_author": "merlimat", "pr_createdAt": "2020-06-24T23:59:03Z", "pr_url": "https://github.com/apache/pulsar/pull/7355", "timeline": [{"oid": "7f84ff4e157936038e1526ab974b2b4003ce9822", "url": "https://github.com/apache/pulsar/commit/7f84ff4e157936038e1526ab974b2b4003ce9822", "message": "Handling error in creation of non-durable cursor", "committedDate": "2020-06-24T23:54:20Z", "type": "commit"}, {"oid": "2216dd1cfc1f9c53346414305413f49c1957ac10", "url": "https://github.com/apache/pulsar/commit/2216dd1cfc1f9c53346414305413f49c1957ac10", "message": "Fixed tests", "committedDate": "2020-06-25T04:44:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzOTk1MzIzMQ==", "url": "https://github.com/apache/pulsar/pull/7355#discussion_r639953231", "body": "@merlimat - I know this has been merged for a while, but I was reading through this class today, and I am concerned about a possible race condition that would lead to an incorrect update to the `subscriptions` map.\r\n\r\nWith this PR, the `subscriptions` map is no longer updated using the `computeIfAbsent` method here, but is instead modified with a `get` and then a subsequent `put`. The `getDurableSubscription` updates the `subscriptions` map concurrently as well. I believe this opens us up to a race under the following conditions:\r\n\r\n1. We call get for a subscription on line 695, and get `null`.\r\n2. Then, a durable subscription with the same name is added to the `subscriptions` map on line 665.\r\n3. Then, the non durable subscription is put into the `subscriptions` map on new line 722, and in doing so, overwrites the durable subscription of the same name.\r\n\r\nDo you agree this is a risk here? If so, I will work on contributing a fix. I wanted to check first though, just in case there is context I'm missing. Thanks!", "bodyText": "@merlimat - I know this has been merged for a while, but I was reading through this class today, and I am concerned about a possible race condition that would lead to an incorrect update to the subscriptions map.\nWith this PR, the subscriptions map is no longer updated using the computeIfAbsent method here, but is instead modified with a get and then a subsequent put. The getDurableSubscription updates the subscriptions map concurrently as well. I believe this opens us up to a race under the following conditions:\n\nWe call get for a subscription on line 695, and get null.\nThen, a durable subscription with the same name is added to the subscriptions map on line 665.\nThen, the non durable subscription is put into the subscriptions map on new line 722, and in doing so, overwrites the durable subscription of the same name.\n\nDo you agree this is a risk here? If so, I will work on contributing a fix. I wanted to check first though, just in case there is context I'm missing. Thanks!", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/merlimat/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/merlimat\">@merlimat</a> - I know this has been merged for a while, but I was reading through this class today, and I am concerned about a possible race condition that would lead to an incorrect update to the <code>subscriptions</code> map.</p>\n<p dir=\"auto\">With this PR, the <code>subscriptions</code> map is no longer updated using the <code>computeIfAbsent</code> method here, but is instead modified with a <code>get</code> and then a subsequent <code>put</code>. The <code>getDurableSubscription</code> updates the <code>subscriptions</code> map concurrently as well. I believe this opens us up to a race under the following conditions:</p>\n<ol dir=\"auto\">\n<li>We call get for a subscription on line 695, and get <code>null</code>.</li>\n<li>Then, a durable subscription with the same name is added to the <code>subscriptions</code> map on line 665.</li>\n<li>Then, the non durable subscription is put into the <code>subscriptions</code> map on new line 722, and in doing so, overwrites the durable subscription of the same name.</li>\n</ol>\n<p dir=\"auto\">Do you agree this is a risk here? If so, I will work on contributing a fix. I wanted to check first though, just in case there is context I'm missing. Thanks!</p>", "author": "michaeljmarshall", "createdAt": "2021-05-26T17:18:33Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -688,12 +688,13 @@ public void openCursorFailed(ManagedLedgerException exception, Object ctx) {\n \n     private CompletableFuture<? extends Subscription> getNonDurableSubscription(String subscriptionName,\n             MessageId startMessageId, long startMessageRollbackDurationSec) {\n-        CompletableFuture<Subscription> subscriptionFuture = new CompletableFuture<>();\n         log.info(\"[{}][{}] Creating non-durable subscription at msg id {}\", topic, subscriptionName, startMessageId);\n \n         synchronized (ledger) {\n             // Create a new non-durable cursor only for the first consumer that connects\n-            Subscription subscription = subscriptions.computeIfAbsent(subscriptionName, name -> {", "originalCommit": "2216dd1cfc1f9c53346414305413f49c1957ac10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}