{"pr_number": 7744, "pr_title": "[broker] Make resetting cursor in REST API asynchronous", "pr_author": "massakam", "pr_createdAt": "2020-08-04T09:52:21Z", "pr_url": "https://github.com/apache/pulsar/pull/7744", "timeline": [{"oid": "11e6e3f17a519101ece6d35090bd37b143185c70", "url": "https://github.com/apache/pulsar/commit/11e6e3f17a519101ece6d35090bd37b143185c70", "message": "Make resetting cursor in REST API asynchronous", "committedDate": "2020-08-05T00:58:08Z", "type": "commit"}, {"oid": "5fe7e5fc2937d4b8baa99d798083b89974072819", "url": "https://github.com/apache/pulsar/commit/5fe7e5fc2937d4b8baa99d798083b89974072819", "message": "Enable automatic topic creation", "committedDate": "2020-08-05T00:58:09Z", "type": "commit"}, {"oid": "5fe7e5fc2937d4b8baa99d798083b89974072819", "url": "https://github.com/apache/pulsar/commit/5fe7e5fc2937d4b8baa99d798083b89974072819", "message": "Enable automatic topic creation", "committedDate": "2020-08-05T00:58:09Z", "type": "forcePushed"}, {"oid": "0d8f2397f36ecbaf5661c772d2c4a1e154c899cf", "url": "https://github.com/apache/pulsar/commit/0d8f2397f36ecbaf5661c772d2c4a1e154c899cf", "message": "Get cause of CompletionException", "committedDate": "2020-08-05T05:01:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY4NjI5Mw==", "url": "https://github.com/apache/pulsar/pull/7744#discussion_r465686293", "body": "This test fails if `allowAutoTopicCreation` is false.\r\n\r\nWe are testing if the subscription creation is successful here. However, if `allowAutoTopicCreation` is false, the topic cannot be created and the subscription creation should also fail.\r\nhttps://github.com/apache/pulsar/blob/8061c547327b46700c8e66f2d829e258f21a292c/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java#L1787-L1789\r\n\r\nI think it's a mistake to set `allowAutoTopicCreation` to false here. Previously this test passed because the REST API was not able to return the error response correctly.", "bodyText": "This test fails if allowAutoTopicCreation is false.\nWe are testing if the subscription creation is successful here. However, if allowAutoTopicCreation is false, the topic cannot be created and the subscription creation should also fail.\n\n  \n    \n      pulsar/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java\n    \n    \n        Lines 1787 to 1789\n      in\n      8061c54\n    \n    \n    \n    \n\n        \n          \n           boolean isAllowAutoTopicCreation = pulsar().getConfiguration().isAllowAutoTopicCreation(); \n        \n\n        \n          \n           PersistentTopic topic = (PersistentTopic) pulsar().getBrokerService() \n        \n\n        \n          \n                   .getTopic(topicName.toString(), isAllowAutoTopicCreation).thenApply(Optional::get).join(); \n        \n    \n  \n\n\nI think it's a mistake to set allowAutoTopicCreation to false here. Previously this test passed because the REST API was not able to return the error response correctly.", "bodyHTML": "<p dir=\"auto\">This test fails if <code>allowAutoTopicCreation</code> is false.</p>\n<p dir=\"auto\">We are testing if the subscription creation is successful here. However, if <code>allowAutoTopicCreation</code> is false, the topic cannot be created and the subscription creation should also fail.<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/apache/pulsar/blob/8061c547327b46700c8e66f2d829e258f21a292c/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java#L1787-L1789\">pulsar/pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 1787 to 1789\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/apache/pulsar/commit/8061c547327b46700c8e66f2d829e258f21a292c\">8061c54</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L1787\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1787\"></td>\n          <td id=\"LC1787\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">boolean</span> isAllowAutoTopicCreation <span class=\"pl-k\">=</span> pulsar()<span class=\"pl-k\">.</span>getConfiguration()<span class=\"pl-k\">.</span>isAllowAutoTopicCreation(); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1788\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1788\"></td>\n          <td id=\"LC1788\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">PersistentTopic</span> topic <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">PersistentTopic</span>) pulsar()<span class=\"pl-k\">.</span>getBrokerService() </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1789\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1789\"></td>\n          <td id=\"LC1789\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         .getTopic(topicName<span class=\"pl-k\">.</span>toString(), isAllowAutoTopicCreation)<span class=\"pl-k\">.</span>thenApply(<span class=\"pl-smi\">Optional</span><span class=\"pl-k\">::</span>get)<span class=\"pl-k\">.</span>join(); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">I think it's a mistake to set <code>allowAutoTopicCreation</code> to false here. Previously this test passed because the REST API was not able to return the error response correctly.</p>", "author": "massakam", "createdAt": "2020-08-05T12:22:03Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/PersistentTopicsTest.java", "diffHunk": "@@ -232,7 +232,6 @@ public void testTerminatePartitionedTopic() {\n \n     @Test\n     public void testNonPartitionedTopics() {\n-        pulsar.getConfiguration().setAllowAutoTopicCreation(false);", "originalCommit": "0d8f2397f36ecbaf5661c772d2c4a1e154c899cf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}