{"pr_number": 7968, "pr_title": "[Issue 7759] Support set Max Consumer on topic level.", "pr_author": "zhanghaou", "pr_createdAt": "2020-09-03T11:36:51Z", "pr_url": "https://github.com/apache/pulsar/pull/7968", "timeline": [{"oid": "2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "url": "https://github.com/apache/pulsar/commit/2522a08430dc5ec8fdd0f534038e3183aea4dc8c", "message": "Merge pull request #1 from apache/master\n\nmerge", "committedDate": "2020-08-28T02:05:01Z", "type": "commit"}, {"oid": "a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "url": "https://github.com/apache/pulsar/commit/a3880bb4ab7d82b4f58efeca351a9ebb1b601147", "message": "Merge pull request #2 from apache/master\n\nmerge", "committedDate": "2020-08-31T01:04:34Z", "type": "commit"}, {"oid": "13df37f3e29e3c4f1696ed92405940c2405aab85", "url": "https://github.com/apache/pulsar/commit/13df37f3e29e3c4f1696ed92405940c2405aab85", "message": "Merge pull request #3 from apache/master\n\nmerge", "committedDate": "2020-09-03T00:03:30Z", "type": "commit"}, {"oid": "c535605d9355fcfe96cdcc9f5c0aa8575fff4489", "url": "https://github.com/apache/pulsar/commit/c535605d9355fcfe96cdcc9f5c0aa8575fff4489", "message": "Merge pull request #4 from apache/master\n\nmerge", "committedDate": "2020-09-03T09:07:18Z", "type": "commit"}, {"oid": "550963be7652a6c428b80e17b11e99184adf8233", "url": "https://github.com/apache/pulsar/commit/550963be7652a6c428b80e17b11e99184adf8233", "message": "[ISSUE 7759] Support set Max Consumer on topic level.", "committedDate": "2020-09-03T11:33:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483567506", "body": "It is not recommended to use `AsyncResponse`, just return the value directly.\r\nmore info to see https://github.com/apache/pulsar/issues/7884", "bodyText": "It is not recommended to use AsyncResponse, just return the value directly.\nmore info to see #7884", "bodyHTML": "<p dir=\"auto\">It is not recommended to use <code>AsyncResponse</code>, just return the value directly.<br>\nmore info to see <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"684187198\" data-permission-text=\"Title is private\" data-url=\"https://github.com/apache/pulsar/issues/7884\" data-hovercard-type=\"issue\" data-hovercard-url=\"/apache/pulsar/issues/7884/hovercard\" href=\"https://github.com/apache/pulsar/issues/7884\">#7884</a></p>", "author": "jianyun8023", "createdAt": "2020-09-04T11:51:18Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/PersistentTopicsBase.java", "diffHunk": "@@ -2417,6 +2417,53 @@ protected void internalGetMaxProducers(AsyncResponse asyncResponse) {\n         return pulsar().getTopicPoliciesService().updateTopicPoliciesAsync(topicName, topicPolicies.get());\n     }\n \n+    protected void internalGetMaxConsumers(AsyncResponse asyncResponse) {\n+        validateAdminAccessForTenant(namespaceName.getTenant());\n+        validatePoliciesReadOnlyAccess();\n+        if (topicName.isGlobal()) {\n+            validateGlobalNamespaceOwnership(namespaceName);\n+        }\n+        checkTopicLevelPolicyEnable();\n+        Optional<Integer> maxConsumers = getTopicPolicies(topicName)\n+                .map(TopicPolicies::getMaxConsumerPerTopic);\n+        if (!maxConsumers.isPresent()) {\n+            asyncResponse.resume(Response.noContent().build());\n+        } else {\n+            asyncResponse.resume(maxConsumers.get());\n+        }\n+    }", "originalCommit": "550963be7652a6c428b80e17b11e99184adf8233", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU5ODE1Nw==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483598157", "bodyText": "How about making a new PR to resolve them all?", "author": "zhanghaou", "createdAt": "2020-09-04T12:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODkyMw==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484028923", "bodyText": "I think the new code can comply with this rule.", "author": "jianyun8023", "createdAt": "2020-09-06T06:33:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMzNTY0OQ==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484335649", "bodyText": "Done.", "author": "zhanghaou", "createdAt": "2020-09-07T10:13:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2NzUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2ODgyMg==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483568822", "body": "remove `admin.topics().deletePartitionedTopic(testTopic, true);`", "bodyText": "remove admin.topics().deletePartitionedTopic(testTopic, true);", "bodyHTML": "<p dir=\"auto\">remove <code>admin.topics().deletePartitionedTopic(testTopic, true);</code></p>", "author": "jianyun8023", "createdAt": "2020-09-04T11:54:21Z", "path": "pulsar-broker/src/test/java/org/apache/pulsar/broker/admin/TopicPoliciesTest.java", "diffHunk": "@@ -590,4 +591,121 @@ public void testRemovePublishRate() throws Exception {\n \n         admin.topics().deletePartitionedTopic(testTopic, true);\n     }\n+\n+    @Test\n+    public void testCheckMaxConsumers() throws Exception {\n+        Integer maxProducers = new Integer(-1);\n+        log.info(\"MaxConsumers: {} will set to the topic: {}\", maxProducers, testTopic);\n+        try {\n+            admin.topics().setMaxConsumers(testTopic, maxProducers);\n+            Assert.fail();\n+        } catch (PulsarAdminException e) {\n+            Assert.assertEquals(e.getStatusCode(), 412);\n+        }\n+\n+        admin.topics().deletePartitionedTopic(testTopic, true);\n+    }\n+\n+    @Test\n+    public void testSetMaxConsumers() throws Exception {\n+        admin.namespaces().setMaxConsumersPerTopic(myNamespace, 1);\n+        log.info(\"MaxConsumers: {} will set to the namespace: {}\", 1, myNamespace);\n+        Integer maxConsumers = 2;\n+        log.info(\"MaxConsumers: {} will set to the topic: {}\", maxConsumers, persistenceTopic);\n+        admin.topics().setMaxConsumers(persistenceTopic, maxConsumers);\n+        Thread.sleep(3000);\n+\n+        admin.topics().createPartitionedTopic(persistenceTopic, 2);\n+        Consumer consumer1 = null;\n+        Consumer consumer2 = null;\n+        Consumer consumer3 = null;\n+        try {\n+            consumer1 = pulsarClient.newConsumer().subscriptionName(\"sub1\").topic(persistenceTopic).subscribe();\n+        } catch (PulsarClientException e) {\n+            Assert.fail();\n+        }\n+        try {\n+            consumer2 = pulsarClient.newConsumer().subscriptionName(\"sub2\").topic(persistenceTopic).subscribe();\n+        } catch (PulsarClientException e) {\n+            Assert.fail();\n+        }\n+        try {\n+            consumer3 = pulsarClient.newConsumer().subscriptionName(\"sub3\").topic(persistenceTopic).subscribe();\n+            Assert.fail();\n+        } catch (PulsarClientException e) {\n+            log.info(\"Topic reached max consumers limit\");\n+        }\n+        Assert.assertNotNull(consumer1);\n+        Assert.assertNotNull(consumer2);\n+        Assert.assertNull(consumer3);\n+        consumer1.close();\n+        consumer2.close();\n+\n+        Integer getMaxConsumers = admin.topics().getMaxConsumers(persistenceTopic);\n+        log.info(\"MaxConsumers {} get on topic: {}\", getMaxConsumers, persistenceTopic);\n+        Assert.assertEquals(getMaxConsumers, maxConsumers);\n+\n+        admin.topics().deletePartitionedTopic(persistenceTopic, true);\n+        admin.topics().deletePartitionedTopic(testTopic, true);", "originalCommit": "550963be7652a6c428b80e17b11e99184adf8233", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU4NzY2OA==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r483587668", "bodyText": "'testTopic' was created in BeforeMethod.", "author": "zhanghaou", "createdAt": "2020-09-04T12:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2ODgyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODk3OA==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484028978", "bodyText": "Okay.", "author": "jianyun8023", "createdAt": "2020-09-06T06:34:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU2ODgyMg=="}], "type": "inlineReview"}, {"oid": "80bbe5a82cfbfc0136b300099bb7352d4fcec583", "url": "https://github.com/apache/pulsar/commit/80bbe5a82cfbfc0136b300099bb7352d4fcec583", "message": "Merge pull request #5 from apache/master\n\nmerge", "committedDate": "2020-09-07T07:11:33Z", "type": "commit"}, {"oid": "bd91059134454ea67fe0ae66903b98ca71ea20a5", "url": "https://github.com/apache/pulsar/commit/bd91059134454ea67fe0ae66903b98ca71ea20a5", "message": "Merge remote-tracking branch 'origin/master' into set-max-consumer\n\n# Conflicts:\n#\tpulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "committedDate": "2020-09-07T07:24:29Z", "type": "commit"}, {"oid": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "url": "https://github.com/apache/pulsar/commit/f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "message": "bug fix.", "committedDate": "2020-09-07T07:48:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484378476", "body": "```suggestion\r\n        jcommander.addCommand(\"get-max-consumers\", new GetMaxConsumers());\r\n        jcommander.addCommand(\"set-max-consumers\", new SetMaxConsumers());\r\n        jcommander.addCommand(\"remove-max-consumers\", new RemoveMaxConsumers());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    jcommander.addCommand(\"get-maxConsumers\", new GetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"set-maxConsumers\", new SetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"remove-maxConsumers\", new RemoveMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"get-max-consumers\", new GetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"set-max-consumers\", new SetMaxConsumers());\n          \n          \n            \n                    jcommander.addCommand(\"remove-max-consumers\", new RemoveMaxConsumers());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        jcommander<span class=\"pl-k\">.</span>addCommand(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>get-<span class=\"x x-first x-last\">maxConsumers</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">GetMaxConsumers</span>());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        jcommander<span class=\"pl-k\">.</span>addCommand(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>set-<span class=\"x x-first x-last\">maxConsumers</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">SetMaxConsumers</span>());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        jcommander<span class=\"pl-k\">.</span>addCommand(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>remove-<span class=\"x x-first x-last\">maxConsumers</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RemoveMaxConsumers</span>());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        jcommander<span class=\"pl-k\">.</span>addCommand(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>get-<span class=\"x x-first x-last\">max-consumers</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">GetMaxConsumers</span>());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        jcommander<span class=\"pl-k\">.</span>addCommand(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>set-<span class=\"x x-first x-last\">max-consumers</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">SetMaxConsumers</span>());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        jcommander<span class=\"pl-k\">.</span>addCommand(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>remove-<span class=\"x x-first x-last\">max-consumers</span><span class=\"pl-pds\">\"</span></span>, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RemoveMaxConsumers</span>());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codelipenghui", "createdAt": "2020-09-07T11:40:39Z", "path": "pulsar-client-tools/src/main/java/org/apache/pulsar/admin/cli/CmdTopics.java", "diffHunk": "@@ -153,6 +153,9 @@ public CmdTopics(PulsarAdmin admin) {\n         jcommander.addCommand(\"get-inactive-topic-policies\", new GetInactiveTopicPolicies());\n         jcommander.addCommand(\"set-inactive-topic-policies\", new SetInactiveTopicPolicies());\n         jcommander.addCommand(\"remove-inactive-topic-policies\", new RemoveInactiveTopicPolicies());\n+        jcommander.addCommand(\"get-maxConsumers\", new GetMaxConsumers());\n+        jcommander.addCommand(\"set-maxConsumers\", new SetMaxConsumers());\n+        jcommander.addCommand(\"remove-maxConsumers\", new RemoveMaxConsumers());", "originalCommit": "f06b0cbf9ab7f0fd8d1585342e3703b6a2ca5916", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODkzNA==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484378934", "bodyText": "And please also update the max producers as the above pattern.", "author": "codelipenghui", "createdAt": "2020-09-07T11:41:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQwOTA0MQ==", "url": "https://github.com/apache/pulsar/pull/7968#discussion_r484409041", "bodyText": "Done.", "author": "zhanghaou", "createdAt": "2020-09-07T12:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM3ODQ3Ng=="}], "type": "inlineReview"}, {"oid": "a45400dfdfb56734a055db309815bde216ef3e1d", "url": "https://github.com/apache/pulsar/commit/a45400dfdfb56734a055db309815bde216ef3e1d", "message": "rename command name.", "committedDate": "2020-09-07T12:41:21Z", "type": "commit"}]}