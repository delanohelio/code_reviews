{"pr_number": 8992, "pr_title": "PIP-68: WaitForExclusive producer access mode", "pr_author": "merlimat", "pr_createdAt": "2020-12-17T18:26:02Z", "pr_url": "https://github.com/apache/pulsar/pull/8992", "timeline": [{"oid": "b23e12278d436406e93cfc59c215b53b63586769", "url": "https://github.com/apache/pulsar/commit/b23e12278d436406e93cfc59c215b53b63586769", "message": "PIP-68: WaitForExclusive producer access mode", "committedDate": "2020-12-17T18:22:06Z", "type": "commit"}, {"oid": "b5259839ff07e053b41dcc190f25af645d8c7ac0", "url": "https://github.com/apache/pulsar/commit/b5259839ff07e053b41dcc190f25af645d8c7ac0", "message": "Fixed checkstyle issues", "committedDate": "2020-12-17T18:50:43Z", "type": "commit"}, {"oid": "a57c2534c105e8b750cc7fc2602f00647c26ad40", "url": "https://github.com/apache/pulsar/commit/a57c2534c105e8b750cc7fc2602f00647c26ad40", "message": "Fixed log level to info", "committedDate": "2020-12-18T19:15:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MDY2OA==", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546070668", "body": "Typo  qeuue", "bodyText": "Typo  qeuue", "bodyHTML": "<p dir=\"auto\">Typo  qeuue</p>", "author": "eolivelli", "createdAt": "2020-12-18T20:18:13Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1192,6 +1193,17 @@ protected void handleProducer(final CommandProducer cmdProducer) {\n                                     }\n                                     return null;\n                                 });\n+\n+                                producerQueuedFuture.thenRun(() -> {\n+                                    // If the producer is queued waiting, we will get an immediate notification\n+                                    // that we need to pass to client\n+                                    if (isActive()) {\n+                                        log.info(\"[{}] Producer is waiting in qeuue: {}\", remoteAddress, producer);", "originalCommit": "a57c2534c105e8b750cc7fc2602f00647c26ad40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3Mzk3MQ==", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546073971", "bodyText": "Fixed", "author": "merlimat", "createdAt": "2020-12-18T20:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MDY2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MTk5Ng==", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546071996", "body": "What happens if the PulsarClient gets closed or there is a network error?\r\nAre we guaranteed to fail and do not wait forever?", "bodyText": "What happens if the PulsarClient gets closed or there is a network error?\nAre we guaranteed to fail and do not wait forever?", "bodyHTML": "<p dir=\"auto\">What happens if the PulsarClient gets closed or there is a network error?<br>\nAre we guaranteed to fail and do not wait forever?</p>", "author": "eolivelli", "createdAt": "2020-12-18T20:21:27Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/ClientCnx.java", "diffHunk": "@@ -468,6 +469,19 @@ protected void handleProducerSuccess(CommandProducerSuccess success) {\n                     success.getRequestId(), success.getProducerName());\n         }\n         long requestId = success.getRequestId();\n+        if (!success.getProducerReady()) {\n+            // We got a success operation but the producer is not ready. This means that the producer has been queued up\n+            // in broker. We need to leave the future pending until we get the final confirmation. We just mark that\n+            // we have received a response, in order to avoid the timeout.\n+            TimedCompletableFuture<?> requestFuture = (TimedCompletableFuture<?>) pendingRequests.get(requestId);\n+            if (requestFuture != null) {\n+                log.info(\"{} Producer {} has been queued up at broker. request: {}\", ctx.channel(),\n+                        success.getProducerName(), requestId);\n+                requestFuture.markAsResponded();", "originalCommit": "a57c2534c105e8b750cc7fc2602f00647c26ad40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MzMzNQ==", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546073335", "bodyText": "Yes, the marking of the future is only for timeout within a single connection. When a connection fails, everything that was in that connections is marked as failed and will trigger a retry.", "author": "merlimat", "createdAt": "2020-12-18T20:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MTk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjIxMjc2OQ==", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546212769", "bodyText": "Good", "author": "eolivelli", "createdAt": "2020-12-19T08:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3MTk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA3Mzc4NA==", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r546073784", "body": "```suggestion\r\n                                        log.info(\"[{}] Producer is waiting in queue: {}\", remoteAddress, producer);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                    log.info(\"[{}] Producer is waiting in qeuue: {}\", remoteAddress, producer);\n          \n          \n            \n                                                    log.info(\"[{}] Producer is waiting in queue: {}\", remoteAddress, producer);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                                        log<span class=\"pl-k\">.</span>info(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>[{}] Producer is waiting in <span class=\"x x-first x-last\">qeuue</span>: {}<span class=\"pl-pds\">\"</span></span>, remoteAddress, producer);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                                        log<span class=\"pl-k\">.</span>info(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>[{}] Producer is waiting in <span class=\"x x-first x-last\">queue</span>: {}<span class=\"pl-pds\">\"</span></span>, remoteAddress, producer);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "merlimat", "createdAt": "2020-12-18T20:25:23Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "diffHunk": "@@ -1192,6 +1193,17 @@ protected void handleProducer(final CommandProducer cmdProducer) {\n                                     }\n                                     return null;\n                                 });\n+\n+                                producerQueuedFuture.thenRun(() -> {\n+                                    // If the producer is queued waiting, we will get an immediate notification\n+                                    // that we need to pass to client\n+                                    if (isActive()) {\n+                                        log.info(\"[{}] Producer is waiting in qeuue: {}\", remoteAddress, producer);", "originalCommit": "a57c2534c105e8b750cc7fc2602f00647c26ad40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dd614a912d055085e011cd83c9f7769b3d3a54ad", "url": "https://github.com/apache/pulsar/commit/dd614a912d055085e011cd83c9f7769b3d3a54ad", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/service/ServerCnx.java", "committedDate": "2020-12-18T20:25:31Z", "type": "commit"}, {"id": "PRRC_kwDOA7PXtM4qP4e9", "url": "https://github.com/apache/pulsar/pull/8992#discussion_r708806589", "body": "Hi @merlimat @sijie , this place makes me a little puzzled and I would like to ask why we need to change readlock to writelock?", "bodyText": "Hi @merlimat @sijie , this place makes me a little puzzled and I would like to ask why we need to change readlock to writelock?", "bodyHTML": "<p dir=\"auto\">Hi <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/merlimat/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/merlimat\">@merlimat</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/sijie/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/sijie\">@sijie</a> , this place makes me a little puzzled and I would like to ask why we need to change readlock to writelock?</p>", "author": "wuzhanpeng", "createdAt": "2021-09-15T03:21:31Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/AbstractTopic.java", "diffHunk": "@@ -337,14 +342,15 @@ public String getReplicatorPrefix() {\n     }\n \n     @Override\n-    public CompletableFuture<Optional<Long>> addProducer(Producer producer) {\n+    public CompletableFuture<Optional<Long>> addProducer(Producer producer,\n+            CompletableFuture<Void> producerQueuedFuture) {\n         checkArgument(producer.getTopic() == this);\n \n         CompletableFuture<Optional<Long>> future = new CompletableFuture<>();\n \n-        incrementTopicEpochIfNeeded(producer)\n-                .thenAccept(epoch -> {\n-                    lock.readLock().lock();", "originalCommit": "dd614a912d055085e011cd83c9f7769b3d3a54ad", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}