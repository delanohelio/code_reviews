{"pr_number": 8442, "pr_title": "Fix the residual of inactive partitioned-topic cleaning", "pr_author": "315157973", "pr_createdAt": "2020-11-04T01:15:40Z", "pr_url": "https://github.com/apache/pulsar/pull/8442", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODA3NzgyNw==", "url": "https://github.com/apache/pulsar/pull/8442#discussion_r518077827", "body": "There may be problems with this treatment because the partitions of a partitioned topic also is an independent topic, the partitions distributed to different brokers and each topic may have different producers and consumers(In some cases, the client may only connect a few partitions). \r\n\r\nFor example, if we have 3 partitions but only partition-0 have no producers, the broker will delete the partitioned topic. After that, the new producers or consumers will connect to the topic name which is the same as the partition topic but this is a different topic.\r\n\r\nSo it's better to check if all of the partitions are deleted when deleting a partitioned topic.\r\n\r\nAnd, I think it's better to provide an option for users in the broker.conf. Such as `brokerDeleteInactivePartitionedTopicEnabled` and keep false as the default value.\r\nI proposed this because if the partitioned metadata is deleted automatically, the reconnecting client might create partitions again when enabling topic auto-creation. This will cause serious problems because the new clients will connect to non-partitioned topic(partitioned metadata is delete, so the broker will create a non-partitioned topic automatically). This may lead to users use the same topic name but unable to pass data.", "bodyText": "There may be problems with this treatment because the partitions of a partitioned topic also is an independent topic, the partitions distributed to different brokers and each topic may have different producers and consumers(In some cases, the client may only connect a few partitions).\nFor example, if we have 3 partitions but only partition-0 have no producers, the broker will delete the partitioned topic. After that, the new producers or consumers will connect to the topic name which is the same as the partition topic but this is a different topic.\nSo it's better to check if all of the partitions are deleted when deleting a partitioned topic.\nAnd, I think it's better to provide an option for users in the broker.conf. Such as brokerDeleteInactivePartitionedTopicEnabled and keep false as the default value.\nI proposed this because if the partitioned metadata is deleted automatically, the reconnecting client might create partitions again when enabling topic auto-creation. This will cause serious problems because the new clients will connect to non-partitioned topic(partitioned metadata is delete, so the broker will create a non-partitioned topic automatically). This may lead to users use the same topic name but unable to pass data.", "bodyHTML": "<p dir=\"auto\">There may be problems with this treatment because the partitions of a partitioned topic also is an independent topic, the partitions distributed to different brokers and each topic may have different producers and consumers(In some cases, the client may only connect a few partitions).</p>\n<p dir=\"auto\">For example, if we have 3 partitions but only partition-0 have no producers, the broker will delete the partitioned topic. After that, the new producers or consumers will connect to the topic name which is the same as the partition topic but this is a different topic.</p>\n<p dir=\"auto\">So it's better to check if all of the partitions are deleted when deleting a partitioned topic.</p>\n<p dir=\"auto\">And, I think it's better to provide an option for users in the broker.conf. Such as <code>brokerDeleteInactivePartitionedTopicEnabled</code> and keep false as the default value.<br>\nI proposed this because if the partitioned metadata is deleted automatically, the reconnecting client might create partitions again when enabling topic auto-creation. This will cause serious problems because the new clients will connect to non-partitioned topic(partitioned metadata is delete, so the broker will create a non-partitioned topic automatically). This may lead to users use the same topic name but unable to pass data.</p>", "author": "codelipenghui", "createdAt": "2020-11-05T14:09:32Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1787,6 +1788,32 @@ public void checkGC() {\n         }\n     }\n \n+    private CompletableFuture<Void> deleteZkNode() {\n+        CompletableFuture<Void> deleteZkNodeFuture = new CompletableFuture<>();\n+        TopicName topicName = TopicName.get(topic);\n+        //Only need to delete the ZK node once\n+        if (topicName.isPartitioned() && topicName.getPartitionIndex() == 0) {", "originalCommit": "e823c6e2afef60d5552d64024b470069dcad5021", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f50a545e93256f57b132ef1ddb0e5d3f1f395da8", "url": "https://github.com/apache/pulsar/commit/f50a545e93256f57b132ef1ddb0e5d3f1f395da8", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T15:53:54Z", "type": "forcePushed"}, {"oid": "cd6542755a2f54c4c3e6a0e42f7ac010deb76128", "url": "https://github.com/apache/pulsar/commit/cd6542755a2f54c4c3e6a0e42f7ac010deb76128", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T16:24:12Z", "type": "forcePushed"}, {"oid": "33d4412dd4f99da810b31fc76c119d70fc0a9483", "url": "https://github.com/apache/pulsar/commit/33d4412dd4f99da810b31fc76c119d70fc0a9483", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T17:59:36Z", "type": "forcePushed"}, {"oid": "dfca90c99450c90564ea235d836260dd2867726a", "url": "https://github.com/apache/pulsar/commit/dfca90c99450c90564ea235d836260dd2867726a", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T18:11:10Z", "type": "commit"}, {"oid": "dfca90c99450c90564ea235d836260dd2867726a", "url": "https://github.com/apache/pulsar/commit/dfca90c99450c90564ea235d836260dd2867726a", "message": "fix partitioned topic is not deleted", "committedDate": "2020-11-06T18:11:10Z", "type": "forcePushed"}, {"oid": "aa1c31024e47bf759135a1938696581520f0e5e0", "url": "https://github.com/apache/pulsar/commit/aa1c31024e47bf759135a1938696581520f0e5e0", "message": "change option", "committedDate": "2020-11-07T03:38:00Z", "type": "commit"}, {"oid": "9f770ec73da36c4c91b3ccdcba390b73811758c5", "url": "https://github.com/apache/pulsar/commit/9f770ec73da36c4c91b3ccdcba390b73811758c5", "message": "change doc", "committedDate": "2020-11-07T04:47:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwMTY4Mw==", "url": "https://github.com/apache/pulsar/pull/8442#discussion_r519501683", "body": "```suggestion\r\n    private CompletableFuture<Void> tryToDeletePartitionedMetadata() {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private CompletableFuture<Void> deleteZkNode() {\n          \n          \n            \n                private CompletableFuture<Void> tryToDeletePartitionedMetadata() {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">CompletableFuture&lt;<span class=\"pl-smi\">Void</span>&gt;</span> <span class=\"x x-first x-last\">deleteZkNode</span>() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">CompletableFuture&lt;<span class=\"pl-smi\">Void</span>&gt;</span> <span class=\"x x-first x-last\">tryToDeletePartitionedMetadata</span>() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codelipenghui", "createdAt": "2020-11-09T00:35:19Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1783,7 +1785,47 @@ public void checkGC() {\n                         }\n                         return null;\n                     });\n+        }\n+    }\n+\n+    private CompletableFuture<Void> deleteZkNode() {", "originalCommit": "9f770ec73da36c4c91b3ccdcba390b73811758c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUwMTc3Mw==", "url": "https://github.com/apache/pulsar/pull/8442#discussion_r519501773", "body": "We should get the partitioned metadata asynchronously", "bodyText": "We should get the partitioned metadata asynchronously", "bodyHTML": "<p dir=\"auto\">We should get the partitioned metadata asynchronously</p>", "author": "codelipenghui", "createdAt": "2020-11-09T00:36:03Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java", "diffHunk": "@@ -1783,7 +1785,47 @@ public void checkGC() {\n                         }\n                         return null;\n                     });\n+        }\n+    }\n+\n+    private CompletableFuture<Void> deleteZkNode() {\n+        if (TopicName.get(topic).isPartitioned() && !deletePartitionedTopicMetadataWhileInactive()) {\n+            return CompletableFuture.completedFuture(null);\n+        }\n+        TopicName topicName = TopicName.get(TopicName.get(topic).getPartitionedTopicName());\n+        String path = AdminResource.path(AdminResource.PARTITIONED_TOPIC_PATH_ZNODE, topicName.getNamespace()\n+                , topicName.getDomain().value(), topicName.getEncodedLocalName());\n+        try {\n+            if (topicName.isPartitioned() && !getBrokerService().pulsar().getGlobalZkCache().exists(path)) {\n+                return CompletableFuture.completedFuture(null);\n+            }\n+            // make sure all sub partitions were deleted\n+            PartitionedTopicMetadata metadata = getBrokerService()\n+                    .fetchPartitionedTopicMetadataAsync(TopicName.get(topicName.getPartitionedTopicName())).get();", "originalCommit": "9f770ec73da36c4c91b3ccdcba390b73811758c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "25fb624ebd7855140094522d0dfdd0e85f3a6ef7", "url": "https://github.com/apache/pulsar/commit/25fb624ebd7855140094522d0dfdd0e85f3a6ef7", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/service/persistent/PersistentTopic.java\n\nCo-authored-by: lipenghui <penghui@apache.org>", "committedDate": "2020-11-09T09:51:11Z", "type": "commit"}, {"oid": "a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "url": "https://github.com/apache/pulsar/commit/a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "message": "Asynchronous delete", "committedDate": "2020-11-09T13:04:59Z", "type": "commit"}, {"oid": "a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "url": "https://github.com/apache/pulsar/commit/a27e26c91f573ed5a3a1f1eae9a693cc09b603cf", "message": "Asynchronous delete", "committedDate": "2020-11-09T13:04:59Z", "type": "forcePushed"}]}