{"pr_number": 8208, "pr_title": "Use ThreadPoolExecutor instead of EventLoop", "pr_author": "315157973", "pr_createdAt": "2020-10-06T07:41:02Z", "pr_url": "https://github.com/apache/pulsar/pull/8208", "timeline": [{"oid": "e3bf030cdf96952a48c25ba93af95f9a795061d6", "url": "https://github.com/apache/pulsar/commit/e3bf030cdf96952a48c25ba93af95f9a795061d6", "message": "use ThreadPoolExecutor", "committedDate": "2020-10-06T07:17:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA2OTAzOA==", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r500069038", "body": "we must shutdown this executor, otherwise we are leaking threads", "bodyText": "we must shutdown this executor, otherwise we are leaking threads", "bodyHTML": "<p dir=\"auto\">we must shutdown this executor, otherwise we are leaking threads</p>", "author": "eolivelli", "createdAt": "2020-10-06T07:42:50Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,8 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,", "originalCommit": "e3bf030cdf96952a48c25ba93af95f9a795061d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "url": "https://github.com/apache/pulsar/commit/8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "message": "add shutdown", "committedDate": "2020-10-06T07:46:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAyOTc1OA==", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r501029758", "body": " Now we already have threads named `pulsar-client-io`, so it's better to use a different name for the new threads. And I noticed some internal tasks of the client also uses the `externalExecutorProvider` for executing the internal task of the Pulsar client. Maybe we can add an `internalExecutorService` for handing the internal tasks of the client.", "bodyText": "Now we already have threads named pulsar-client-io, so it's better to use a different name for the new threads. And I noticed some internal tasks of the client also uses the externalExecutorProvider for executing the internal task of the Pulsar client. Maybe we can add an internalExecutorService for handing the internal tasks of the client.", "bodyHTML": "<p dir=\"auto\">Now we already have threads named <code>pulsar-client-io</code>, so it's better to use a different name for the new threads. And I noticed some internal tasks of the client also uses the <code>externalExecutorProvider</code> for executing the internal task of the Pulsar client. Maybe we can add an <code>internalExecutorService</code> for handing the internal tasks of the client.</p>", "author": "codelipenghui", "createdAt": "2020-10-07T13:51:59Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,8 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        ioExecutorService = new ThreadPoolExecutor(conf.getNumIoThreads(), conf.getNumIoThreads(), 0L, TimeUnit.MILLISECONDS,\n+                new LinkedBlockingQueue<>(), getThreadFactory(\"pulsar-io-thread\"));", "originalCommit": "8612e46e11d617bddfe7268d57b5a3b3b9250aa4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b19536ba52067d72a2378d83fa3eb2a057c72932", "url": "https://github.com/apache/pulsar/commit/b19536ba52067d72a2378d83fa3eb2a057c72932", "message": "use ExecutorProvider instead", "committedDate": "2020-10-07T16:49:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcyMDE0NQ==", "url": "https://github.com/apache/pulsar/pull/8208#discussion_r501720145", "body": "```suggestion\r\n        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-internal\"));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));\n          \n          \n            \n                    internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-internal\"));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        internalExecutorService <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ExecutorProvider</span>(conf<span class=\"pl-k\">.</span>getNumIoThreads(), getThreadFactory(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pulsar-client-<span class=\"x x-first x-last\">io</span><span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        internalExecutorService <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ExecutorProvider</span>(conf<span class=\"pl-k\">.</span>getNumIoThreads(), getThreadFactory(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>pulsar-client-<span class=\"x x-first x-last\">internal</span><span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "codelipenghui", "createdAt": "2020-10-08T13:28:13Z", "path": "pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java", "diffHunk": "@@ -145,6 +147,7 @@ public PulsarClientImpl(ClientConfigurationData conf, EventLoopGroup eventLoopGr\n         conf.getAuthentication().start();\n         this.cnxPool = cnxPool;\n         externalExecutorProvider = new ExecutorProvider(conf.getNumListenerThreads(), getThreadFactory(\"pulsar-external-listener\"));\n+        internalExecutorService = new ExecutorProvider(conf.getNumIoThreads(), getThreadFactory(\"pulsar-client-io\"));", "originalCommit": "b19536ba52067d72a2378d83fa3eb2a057c72932", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "64daa07e801579c6d83b5fcb0b2a596ba2faf198", "url": "https://github.com/apache/pulsar/commit/64daa07e801579c6d83b5fcb0b2a596ba2faf198", "message": "Update pulsar-client/src/main/java/org/apache/pulsar/client/impl/PulsarClientImpl.java\n\nCo-authored-by: lipenghui <penghui@apache.org>", "committedDate": "2020-10-11T13:39:50Z", "type": "commit"}, {"oid": "96799c67451f2c8f773844e8d524538bc05f3161", "url": "https://github.com/apache/pulsar/commit/96799c67451f2c8f773844e8d524538bc05f3161", "message": "merge master", "committedDate": "2020-10-12T04:11:09Z", "type": "commit"}]}