{"pr_number": 8446, "pr_title": "add rest api: unsetOffloadPolicies", "pr_author": "Renkai", "pr_createdAt": "2020-11-04T06:31:10Z", "pr_url": "https://github.com/apache/pulsar/pull/8446", "timeline": [{"oid": "5274c2b25c7b00134522d479851aa5cd29a27fa4", "url": "https://github.com/apache/pulsar/commit/5274c2b25c7b00134522d479851aa5cd29a27fa4", "message": "add rest api: unsetOffloadPolicies\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-04T06:22:53Z", "type": "commit"}, {"oid": "49aeeae7d412d816440398df59b97cafacd77136", "url": "https://github.com/apache/pulsar/commit/49aeeae7d412d816440398df59b97cafacd77136", "message": "rename to remove\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-04T07:04:26Z", "type": "commit"}, {"oid": "ffdfc76c1093143151aaeab277c69e1120bd304c", "url": "https://github.com/apache/pulsar/commit/ffdfc76c1093143151aaeab277c69e1120bd304c", "message": "add admin tool api\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-04T08:09:32Z", "type": "commit"}, {"oid": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "url": "https://github.com/apache/pulsar/commit/ccbb32ff25f0b46f59975882ec396a5b0375b209", "message": "add admin tool api\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-04T08:39:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4MzIwMQ==", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517383201", "body": "```suggestion\r\n                                    \"[%s] Failed to remove offload configuration for namespace %s\",\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                \"[%s] Failed to update offload configuration for namespace %s\",\n          \n          \n            \n                                                \"[%s] Failed to remove offload configuration for namespace %s\",", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                                    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>[%s] Failed to <span class=\"x x-first x-last\">update</span> offload configuration for namespace %s<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                                    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>[%s] Failed to <span class=\"x x-first x-last\">remove</span> offload configuration for namespace %s<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gaoran10", "createdAt": "2020-11-04T14:28:28Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3000,6 +3001,47 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n         }\n     }\n \n+    protected void internalRemoveOffloadPolicies(AsyncResponse asyncResponse) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.OFFLOAD, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        try {\n+            Stat nodeStat = new Stat();\n+            final String path = path(POLICIES, namespaceName.toString());\n+            byte[] content = globalZk().getData(path, null, nodeStat);\n+            Policies policies = jsonMapper().readValue(content, Policies.class);\n+\n+            policies.offload_policies = null;\n+            String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);\n+            globalZk().setData(path, jsonMapper().writeValueAsBytes(policies), nodeStat.getVersion(),\n+                    (rc, path1, ctx, stat) -> {\n+                        if (rc == KeeperException.Code.OK.intValue()) {\n+                            policiesCache().invalidate(path(POLICIES, namespaceName.toString()));\n+                            log.info(\"[{}] Successfully updated offload configuration: namespace={}, map={}\", clientAppId(),\n+                                    namespaceName, updatedOffloadPolicies);\n+                            asyncResponse.resume(Response.noContent().build());\n+                        } else {\n+                            String errorMsg = String.format(\n+                                    \"[%s] Failed to update offload configuration for namespace %s\",", "originalCommit": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4MzQwNg==", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517383406", "body": "```suggestion\r\n            log.error(\"[{}] Failed to remove offload configuration for namespace {}\", clientAppId(), namespaceName,\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.error(\"[{}] Failed to update offload configuration for namespace {}\", clientAppId(), namespaceName,\n          \n          \n            \n                        log.error(\"[{}] Failed to remove offload configuration for namespace {}\", clientAppId(), namespaceName,", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            log<span class=\"pl-k\">.</span>error(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>[{}] Failed to <span class=\"x x-first x-last\">update</span> offload configuration for namespace {}<span class=\"pl-pds\">\"</span></span>, clientAppId(), namespaceName,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            log<span class=\"pl-k\">.</span>error(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>[{}] Failed to <span class=\"x x-first x-last\">remove</span> offload configuration for namespace {}<span class=\"pl-pds\">\"</span></span>, clientAppId(), namespaceName,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gaoran10", "createdAt": "2020-11-04T14:28:46Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3000,6 +3001,47 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n         }\n     }\n \n+    protected void internalRemoveOffloadPolicies(AsyncResponse asyncResponse) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.OFFLOAD, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        try {\n+            Stat nodeStat = new Stat();\n+            final String path = path(POLICIES, namespaceName.toString());\n+            byte[] content = globalZk().getData(path, null, nodeStat);\n+            Policies policies = jsonMapper().readValue(content, Policies.class);\n+\n+            policies.offload_policies = null;\n+            String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);\n+            globalZk().setData(path, jsonMapper().writeValueAsBytes(policies), nodeStat.getVersion(),\n+                    (rc, path1, ctx, stat) -> {\n+                        if (rc == KeeperException.Code.OK.intValue()) {\n+                            policiesCache().invalidate(path(POLICIES, namespaceName.toString()));\n+                            log.info(\"[{}] Successfully updated offload configuration: namespace={}, map={}\", clientAppId(),\n+                                    namespaceName, updatedOffloadPolicies);\n+                            asyncResponse.resume(Response.noContent().build());\n+                        } else {\n+                            String errorMsg = String.format(\n+                                    \"[%s] Failed to update offload configuration for namespace %s\",\n+                                    clientAppId(), namespaceName);\n+                            if (rc == KeeperException.Code.NONODE.intValue()) {\n+                                log.warn(\"{} : does not exist\", errorMsg);\n+                                asyncResponse.resume(new RestException(Status.NOT_FOUND, \"Namespace does not exist\"));\n+                            } else if (rc == KeeperException.Code.BADVERSION.intValue()) {\n+                                log.warn(\"{} : concurrent modification\", errorMsg);\n+                                asyncResponse.resume(new RestException(Status.CONFLICT, \"Concurrent modification\"));\n+                            } else {\n+                                asyncResponse.resume(KeeperException.create(KeeperException.Code.get(rc), errorMsg));\n+                            }\n+                        }\n+                    }, null);\n+        } catch (Exception e) {\n+            log.error(\"[{}] Failed to update offload configuration for namespace {}\", clientAppId(), namespaceName,", "originalCommit": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM4OTE0OA==", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517389148", "body": "Maybe this is not exactly. Removing the namespace offload policies not represents to remove the topic offload policies, if the topic has its own offload policies, it will not be affected.", "bodyText": "Maybe this is not exactly. Removing the namespace offload policies not represents to remove the topic offload policies, if the topic has its own offload policies, it will not be affected.", "bodyHTML": "<p dir=\"auto\">Maybe this is not exactly. Removing the namespace offload policies not represents to remove the topic offload policies, if the topic has its own offload policies, it will not be affected.</p>", "author": "gaoran10", "createdAt": "2020-11-04T14:36:38Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Namespaces.java", "diffHunk": "@@ -3263,6 +3263,20 @@ void setIsAllowAutoUpdateSchema(String namespace, boolean isAllowAutoUpdateSchem\n      */\n     void setOffloadPolicies(String namespace, OffloadPolicies offloadPolicies) throws PulsarAdminException;\n \n+    /**\n+     * Remove the offload configuration for all the topics in a namespace.", "originalCommit": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5MTIyNQ==", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517391225", "body": "Same as above.", "bodyText": "Same as above.", "bodyHTML": "<p dir=\"auto\">Same as above.</p>", "author": "gaoran10", "createdAt": "2020-11-04T14:39:23Z", "path": "pulsar-client-admin/src/main/java/org/apache/pulsar/client/admin/Namespaces.java", "diffHunk": "@@ -3290,6 +3304,20 @@ void setIsAllowAutoUpdateSchema(String namespace, boolean isAllowAutoUpdateSchem\n      */\n     CompletableFuture<Void> setOffloadPoliciesAsync(String namespace, OffloadPolicies offloadPolicies);\n \n+    /**\n+     * Remove the offload configuration for all the topics in a namespace asynchronously.", "originalCommit": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5Mzc3Mw==", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517393773", "body": "It's better to use the `DELETE` method.", "bodyText": "It's better to use the DELETE method.", "bodyHTML": "<p dir=\"auto\">It's better to use the <code>DELETE</code> method.</p>", "author": "gaoran10", "createdAt": "2020-11-04T14:42:52Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/v2/Namespaces.java", "diffHunk": "@@ -1335,14 +1334,34 @@ public void setOffloadPolicies(@PathParam(\"tenant\") String tenant, @PathParam(\"n\n         }\n     }\n \n+    @POST", "originalCommit": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzM5ODgxNw==", "url": "https://github.com/apache/pulsar/pull/8446#discussion_r517398817", "body": "`            String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);\r\n`\r\n\r\nMaybe this is not necessary? The log could be just like Successfully remove the namespace offload policies.\r\n\r\n", "bodyText": "String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);\nMaybe this is not necessary? The log could be just like Successfully remove the namespace offload policies.", "bodyHTML": "<p dir=\"auto\"><code>           String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);</code></p>\n<p dir=\"auto\">Maybe this is not necessary? The log could be just like Successfully remove the namespace offload policies.</p>", "author": "gaoran10", "createdAt": "2020-11-04T14:49:45Z", "path": "pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java", "diffHunk": "@@ -3000,6 +3001,47 @@ protected void internalSetOffloadPolicies(AsyncResponse asyncResponse, OffloadPo\n         }\n     }\n \n+    protected void internalRemoveOffloadPolicies(AsyncResponse asyncResponse) {\n+        validateNamespacePolicyOperation(namespaceName, PolicyName.OFFLOAD, PolicyOperation.WRITE);\n+        validatePoliciesReadOnlyAccess();\n+\n+        try {\n+            Stat nodeStat = new Stat();\n+            final String path = path(POLICIES, namespaceName.toString());\n+            byte[] content = globalZk().getData(path, null, nodeStat);\n+            Policies policies = jsonMapper().readValue(content, Policies.class);\n+\n+            policies.offload_policies = null;\n+            String updatedOffloadPolicies = jsonMapper().writeValueAsString(policies.offload_policies);", "originalCommit": "ccbb32ff25f0b46f59975882ec396a5b0375b209", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "39718280677b79051f88d70fe5d74549eb24a0ae", "url": "https://github.com/apache/pulsar/commit/39718280677b79051f88d70fe5d74549eb24a0ae", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java\n\nCo-authored-by: ran <gaoran_10@126.com>", "committedDate": "2020-11-05T02:44:56Z", "type": "commit"}, {"oid": "f7778f9e79dae0f1f3891e6c04e2e5bdb910d8e3", "url": "https://github.com/apache/pulsar/commit/f7778f9e79dae0f1f3891e6c04e2e5bdb910d8e3", "message": "Update pulsar-broker/src/main/java/org/apache/pulsar/broker/admin/impl/NamespacesBase.java\n\nCo-authored-by: ran <gaoran_10@126.com>", "committedDate": "2020-11-05T02:45:06Z", "type": "commit"}, {"oid": "f9312562e8dfdd63be0772131f0caed6d3784e5d", "url": "https://github.com/apache/pulsar/commit/f9312562e8dfdd63be0772131f0caed6d3784e5d", "message": "post to delete\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-05T02:47:06Z", "type": "commit"}, {"oid": "2130902ea209f089eae9b20a7505ac4bdd005908", "url": "https://github.com/apache/pulsar/commit/2130902ea209f089eae9b20a7505ac4bdd005908", "message": "post to delete\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-05T02:51:08Z", "type": "commit"}, {"oid": "3c0a1089736e27467bf8419da3122c56cdb89651", "url": "https://github.com/apache/pulsar/commit/3c0a1089736e27467bf8419da3122c56cdb89651", "message": "post to delete\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-05T02:57:15Z", "type": "commit"}, {"oid": "37f84c23298decd5742610c9857437f4c7aa891b", "url": "https://github.com/apache/pulsar/commit/37f84c23298decd5742610c9857437f4c7aa891b", "message": "use delete request instead of post\n\nSigned-off-by: Renkai <gaelookair@gmail.com>", "committedDate": "2020-11-05T06:04:09Z", "type": "commit"}]}