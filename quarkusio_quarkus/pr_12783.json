{"pr_number": 12783, "pr_title": "Clean up the config of service integration", "pr_author": "phillip-kruger", "pr_createdAt": "2020-10-19T10:04:20Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/12783", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMTk3NA==", "url": "https://github.com/quarkusio/quarkus/pull/12783#discussion_r508421974", "body": "I think we should have a proper parameter to passe the extension name and not the capability.", "bodyText": "I think we should have a proper parameter to passe the extension name and not the capability.", "bodyHTML": "<p dir=\"auto\">I think we should have a proper parameter to passe the extension name and not the capability.</p>", "author": "gsmet", "createdAt": "2020-10-20T11:26:21Z", "path": "extensions/smallrye-graphql/deployment/src/main/java/io/quarkus/smallrye/graphql/deployment/SmallRyeGraphQLProcessor.java", "diffHunk": "@@ -341,6 +313,106 @@ void openTracingIntegration(Capabilities capabilities,\n         return classes;\n     }\n \n+    // Services Integrations\n+\n+    @BuildStep\n+    void activateMetrics(Capabilities capabilities,\n+            Optional<MetricsCapabilityBuildItem> metricsCapability,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties,\n+            BuildProducer<UnremovableBeanBuildItem> unremovableBeans) {\n+\n+        boolean activate = shouldActivateService(capabilities, quarkusConfig.metricsEnabled, metricsCapability.isPresent(),\n+                \"metrics\", \"quarkus.smallrye-graphql.metrics.enabled\");\n+        if (activate) {\n+            if (metricsCapability.isPresent() && metricsCapability.get().metricsSupported(MetricsFactory.MP_METRICS)) {\n+                unremovableBeans.produce(UnremovableBeanBuildItem.beanClassNames(\"io.smallrye.metrics.MetricRegistries\"));\n+            }\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_METRICS, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_METRICS, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateTracing(Capabilities capabilities,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+\n+        boolean activate = shouldActivateService(capabilities, quarkusConfig.tracingEnabled, Capability.OPENTRACING,\n+                \"quarkus.smallrye-graphql.tracing.enabled\");\n+        if (activate) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_TRACING, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_TRACING, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateValidation(Capabilities capabilities,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+\n+        boolean activate = shouldActivateService(capabilities, quarkusConfig.validationEnabled, Capability.HIBERNATE_VALIDATOR,\n+                \"quarkus.smallrye-graphql.validation.enabled\");\n+        if (activate) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_VALIDATION, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_VALIDATION, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateEventing(BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+        if (quarkusConfig.eventsEnabled) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_EVENTS, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_EVENTS, FALSE));\n+        }\n+    }\n+\n+    private boolean shouldActivateService(Capabilities capabilities,\n+            Optional<Boolean> serviceEnabled,\n+            Capability linkedCapability,\n+            String configKey) {\n+\n+        return shouldActivateService(capabilities, serviceEnabled, capabilities.isPresent(linkedCapability),\n+                linkedCapability.getName(), configKey);\n+    }\n+\n+    private boolean shouldActivateService(Capabilities capabilities,\n+            Optional<Boolean> serviceEnabled,\n+            boolean linkedCapabilityIsPresent,\n+            String linkedCapabilityName,\n+            String configKey) {\n+\n+        if (serviceEnabled.isPresent()) {\n+            // The user explisitly asked from something\n+            boolean isEnabled = serviceEnabled.get();\n+            if (isEnabled) {\n+                if (linkedCapabilityIsPresent) {\n+                    // enable\n+                    return true;\n+                } else {\n+                    // Warn and disable\n+                    LOG.warnf(SERVICE_NOT_AVAILABLE_WARNING, configKey, linkedCapabilityName, linkedCapabilityName);", "originalCommit": "6c25332abfecab648867c25b15d2b2887742309b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjQzMA==", "url": "https://github.com/quarkusio/quarkus/pull/12783#discussion_r508422430", "body": "Isn't Micrometer the extension that should be used for Metrics now? Not sure if it's supported by your GraphQL extension though?\r\n\r\n/cc @ebullient @jmartisk ", "bodyText": "Isn't Micrometer the extension that should be used for Metrics now? Not sure if it's supported by your GraphQL extension though?\n/cc @ebullient @jmartisk", "bodyHTML": "<p dir=\"auto\">Isn't Micrometer the extension that should be used for Metrics now? Not sure if it's supported by your GraphQL extension though?</p>\n<p dir=\"auto\">/cc <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/ebullient/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ebullient\">@ebullient</a> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/jmartisk/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/jmartisk\">@jmartisk</a></p>", "author": "gsmet", "createdAt": "2020-10-20T11:27:09Z", "path": "extensions/smallrye-graphql/deployment/src/main/java/io/quarkus/smallrye/graphql/deployment/SmallRyeGraphQLProcessor.java", "diffHunk": "@@ -341,6 +313,106 @@ void openTracingIntegration(Capabilities capabilities,\n         return classes;\n     }\n \n+    // Services Integrations\n+\n+    @BuildStep\n+    void activateMetrics(Capabilities capabilities,\n+            Optional<MetricsCapabilityBuildItem> metricsCapability,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties,\n+            BuildProducer<UnremovableBeanBuildItem> unremovableBeans) {\n+\n+        boolean activate = shouldActivateService(capabilities, quarkusConfig.metricsEnabled, metricsCapability.isPresent(),\n+                \"metrics\", \"quarkus.smallrye-graphql.metrics.enabled\");\n+        if (activate) {\n+            if (metricsCapability.isPresent() && metricsCapability.get().metricsSupported(MetricsFactory.MP_METRICS)) {", "originalCommit": "6c25332abfecab648867c25b15d2b2887742309b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ0NTA5NQ==", "url": "https://github.com/quarkusio/quarkus/pull/12783#discussion_r508445095", "bodyText": "there is an additional issue open to sort out graphql and metrics.. this will be revisited at that time.\n(edited: phone keyboards)", "author": "ebullient", "createdAt": "2020-10-20T12:07:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ2NTQzNA==", "url": "https://github.com/quarkusio/quarkus/pull/12783#discussion_r508465434", "bodyText": "I am leaving the Metrics as is, and we can do a new PR (@jmartisk can help) to update to the micrometer.", "author": "phillip-kruger", "createdAt": "2020-10-20T12:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjU5OA==", "url": "https://github.com/quarkusio/quarkus/pull/12783#discussion_r508422598", "body": "```suggestion\r\n     * Enable validation. By default this will be enabled if the Hibernate Validator extension is added.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Enable validation. By default this will be enabled if the bean validation extension is added.\n          \n          \n            \n                 * Enable validation. By default this will be enabled if the Hibernate Validator extension is added.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Enable</span> validation. <span class=\"pl-smi\">By</span> <span class=\"pl-k\">default</span> <span class=\"pl-c1\">this</span> will be enabled <span class=\"pl-k\">if</span> the <span class=\"x x-first x-last\">bean validation</span> extension is added.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Enable</span> validation. <span class=\"pl-smi\">By</span> <span class=\"pl-k\">default</span> <span class=\"pl-c1\">this</span> will be enabled <span class=\"pl-k\">if</span> the <span class=\"pl-smi x x-first\">Hibernate</span><span class=\"x\"> </span><span class=\"pl-smi x x-last\">Validator</span> extension is added.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gsmet", "createdAt": "2020-10-20T11:27:25Z", "path": "extensions/smallrye-graphql/deployment/src/main/java/io/quarkus/smallrye/graphql/deployment/SmallRyeGraphQLConfig.java", "diffHunk": "@@ -15,10 +17,28 @@\n     String rootPath;\n \n     /**\n-     * Enable metrics\n+     * Enable metrics. By default this will be enabled if the metrics extension is added.\n+     */\n+    @ConfigItem(name = \"metrics.enabled\")\n+    Optional<Boolean> metricsEnabled;\n+\n+    /**\n+     * Enable tracing. By default this will be enabled if the tracing extension is added.\n+     */\n+    @ConfigItem(name = \"tracing.enabled\")\n+    Optional<Boolean> tracingEnabled;\n+\n+    /**\n+     * Enable validation. By default this will be enabled if the bean validation extension is added.", "originalCommit": "6c25332abfecab648867c25b15d2b2887742309b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5MjM5Mw==", "url": "https://github.com/quarkusio/quarkus/pull/12783#discussion_r508692393", "body": "```suggestion\r\n            // The user explicitly asked from something\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // The user explisitly asked from something\n          \n          \n            \n                        // The user explicitly asked from something", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> The user <span class=\"x x-first x-last\">explisitly</span> asked from something</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> The user <span class=\"x x-first x-last\">explicitly</span> asked from something</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gastaldi", "createdAt": "2020-10-20T16:59:54Z", "path": "extensions/smallrye-graphql/deployment/src/main/java/io/quarkus/smallrye/graphql/deployment/SmallRyeGraphQLProcessor.java", "diffHunk": "@@ -341,6 +313,118 @@ void openTracingIntegration(Capabilities capabilities,\n         return classes;\n     }\n \n+    // Services Integrations\n+\n+    @BuildStep\n+    void activateMetrics(Capabilities capabilities,\n+            Optional<MetricsCapabilityBuildItem> metricsCapability,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties,\n+            BuildProducer<UnremovableBeanBuildItem> unremovableBeans) {\n+\n+        boolean activate = shouldActivateService(capabilities,\n+                quarkusConfig.metricsEnabled,\n+                metricsCapability.isPresent(),\n+                \"quarkus-smallrye-metrics\",\n+                \"metrics\",\n+                \"quarkus.smallrye-graphql.metrics.enabled\");\n+        if (activate) {\n+            if (metricsCapability.isPresent() && metricsCapability.get().metricsSupported(MetricsFactory.MP_METRICS)) {\n+                unremovableBeans.produce(UnremovableBeanBuildItem.beanClassNames(\"io.smallrye.metrics.MetricRegistries\"));\n+            }\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_METRICS, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_METRICS, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateTracing(Capabilities capabilities,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+\n+        boolean activate = shouldActivateService(capabilities,\n+                quarkusConfig.tracingEnabled,\n+                \"quarkus-smallrye-opentracing\",\n+                Capability.OPENTRACING,\n+                \"quarkus.smallrye-graphql.tracing.enabled\");\n+        if (activate) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_TRACING, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_TRACING, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateValidation(Capabilities capabilities,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+\n+        boolean activate = shouldActivateService(capabilities,\n+                quarkusConfig.validationEnabled,\n+                \"quarkus-hibernate-validator\",\n+                Capability.HIBERNATE_VALIDATOR,\n+                \"quarkus.smallrye-graphql.validation.enabled\");\n+        if (activate) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_VALIDATION, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_VALIDATION, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateEventing(BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+        if (quarkusConfig.eventsEnabled) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_EVENTS, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_EVENTS, FALSE));\n+        }\n+    }\n+\n+    private boolean shouldActivateService(Capabilities capabilities,\n+            Optional<Boolean> serviceEnabled,\n+            String linkedExtensionName,\n+            Capability linkedCapability,\n+            String configKey) {\n+\n+        return shouldActivateService(capabilities, serviceEnabled, capabilities.isPresent(linkedCapability),\n+                linkedExtensionName, linkedCapability.getName(), configKey);\n+    }\n+\n+    private boolean shouldActivateService(Capabilities capabilities,\n+            Optional<Boolean> serviceEnabled,\n+            boolean linkedCapabilityIsPresent,\n+            String linkedExtensionName,\n+            String linkedCapabilityName,\n+            String configKey) {\n+\n+        if (serviceEnabled.isPresent()) {\n+            // The user explisitly asked from something", "originalCommit": "4e2167e97a0a5873c7816e5ab7ee0827be5fa76e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY5NDEzNA==", "url": "https://github.com/quarkusio/quarkus/pull/12783#discussion_r508694134", "body": "```suggestion\r\n            if (isEnabled && !linkedCapabilityIsPresent) {\r\n            \t // Warn and disable\r\n                    LOG.warnf(SERVICE_NOT_AVAILABLE_WARNING, configKey, linkedExtensionName, linkedCapabilityName);\r\n            }\r\n            return (isEnabled && linkedCapabilityIsPresent);\r\n        } else {\r\n           return linkedCapabilityIsPresent;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (isEnabled) {\n          \n          \n            \n                            if (linkedCapabilityIsPresent) {\n          \n          \n            \n                                // enable\n          \n          \n            \n                                return true;\n          \n          \n            \n                            } else {\n          \n          \n            \n                                // Warn and disable\n          \n          \n            \n                                LOG.warnf(SERVICE_NOT_AVAILABLE_WARNING, configKey, linkedExtensionName, linkedCapabilityName);\n          \n          \n            \n                                return false;\n          \n          \n            \n                            }\n          \n          \n            \n                        } else {\n          \n          \n            \n                            // disable\n          \n          \n            \n                            return false;\n          \n          \n            \n                        }\n          \n          \n            \n                    } else {\n          \n          \n            \n                        // Auto dis/enable\n          \n          \n            \n                        if (linkedCapabilityIsPresent) {\n          \n          \n            \n                            // enable\n          \n          \n            \n                            return true;\n          \n          \n            \n                        } else {\n          \n          \n            \n                            // disable\n          \n          \n            \n                            return false;\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n          \n            \n                        if (isEnabled && !linkedCapabilityIsPresent) {\n          \n          \n            \n                        \t // Warn and disable\n          \n          \n            \n                                LOG.warnf(SERVICE_NOT_AVAILABLE_WARNING, configKey, linkedExtensionName, linkedCapabilityName);\n          \n          \n            \n                        }\n          \n          \n            \n                        return (isEnabled && linkedCapabilityIsPresent);\n          \n          \n            \n                    } else {\n          \n          \n            \n                       return linkedCapabilityIsPresent;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"409\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (isEnabled) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"410\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">if</span> (linkedCapabilityIsPresent) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"411\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-c\"><span class=\"pl-c\">//</span> enable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"412\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">true</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"413\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"414\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-c\"><span class=\"pl-c\">//</span> Warn and disable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"415\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-c1\">LOG</span><span class=\"pl-k\">.</span>warnf(<span class=\"pl-c1\">SERVICE_NOT_AVAILABLE_WARNING</span>, configKey, linkedExtensionName, linkedCapabilityName);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"416\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">return</span> <span class=\"pl-c1\">false</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"417\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"418\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"419\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-c\"><span class=\"pl-c\">//</span> disable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"420\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">return</span> <span class=\"pl-c1\">false</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"421\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"422\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"423\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> Auto dis/enable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"424\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (linkedCapabilityIsPresent) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"425\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-c\"><span class=\"pl-c\">//</span> enable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"426\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">return</span> <span class=\"pl-c1\">true</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"427\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"428\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-c\"><span class=\"pl-c\">//</span> disable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"429\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">return</span> <span class=\"pl-c1\">false</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"430\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"431\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"409\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (isEnabled <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>linkedCapabilityIsPresent) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"410\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            \t <span class=\"pl-c\"><span class=\"pl-c\">//</span> Warn and disable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"411\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-c1\">LOG</span><span class=\"pl-k\">.</span>warnf(<span class=\"pl-c1\">SERVICE_NOT_AVAILABLE_WARNING</span>, configKey, linkedExtensionName, linkedCapabilityName);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"412\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"413\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span> (isEnabled <span class=\"pl-k\">&amp;&amp;</span> linkedCapabilityIsPresent);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"414\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"415\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">           <span class=\"pl-k\">return</span> linkedCapabilityIsPresent;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gastaldi", "createdAt": "2020-10-20T17:02:45Z", "path": "extensions/smallrye-graphql/deployment/src/main/java/io/quarkus/smallrye/graphql/deployment/SmallRyeGraphQLProcessor.java", "diffHunk": "@@ -341,6 +313,118 @@ void openTracingIntegration(Capabilities capabilities,\n         return classes;\n     }\n \n+    // Services Integrations\n+\n+    @BuildStep\n+    void activateMetrics(Capabilities capabilities,\n+            Optional<MetricsCapabilityBuildItem> metricsCapability,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties,\n+            BuildProducer<UnremovableBeanBuildItem> unremovableBeans) {\n+\n+        boolean activate = shouldActivateService(capabilities,\n+                quarkusConfig.metricsEnabled,\n+                metricsCapability.isPresent(),\n+                \"quarkus-smallrye-metrics\",\n+                \"metrics\",\n+                \"quarkus.smallrye-graphql.metrics.enabled\");\n+        if (activate) {\n+            if (metricsCapability.isPresent() && metricsCapability.get().metricsSupported(MetricsFactory.MP_METRICS)) {\n+                unremovableBeans.produce(UnremovableBeanBuildItem.beanClassNames(\"io.smallrye.metrics.MetricRegistries\"));\n+            }\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_METRICS, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_METRICS, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateTracing(Capabilities capabilities,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+\n+        boolean activate = shouldActivateService(capabilities,\n+                quarkusConfig.tracingEnabled,\n+                \"quarkus-smallrye-opentracing\",\n+                Capability.OPENTRACING,\n+                \"quarkus.smallrye-graphql.tracing.enabled\");\n+        if (activate) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_TRACING, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_TRACING, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateValidation(Capabilities capabilities,\n+            BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+\n+        boolean activate = shouldActivateService(capabilities,\n+                quarkusConfig.validationEnabled,\n+                \"quarkus-hibernate-validator\",\n+                Capability.HIBERNATE_VALIDATOR,\n+                \"quarkus.smallrye-graphql.validation.enabled\");\n+        if (activate) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_VALIDATION, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_VALIDATION, FALSE));\n+        }\n+    }\n+\n+    @BuildStep\n+    void activateEventing(BuildProducer<SystemPropertyBuildItem> systemProperties) {\n+        if (quarkusConfig.eventsEnabled) {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_EVENTS, TRUE));\n+        } else {\n+            systemProperties.produce(new SystemPropertyBuildItem(ConfigKey.ENABLE_EVENTS, FALSE));\n+        }\n+    }\n+\n+    private boolean shouldActivateService(Capabilities capabilities,\n+            Optional<Boolean> serviceEnabled,\n+            String linkedExtensionName,\n+            Capability linkedCapability,\n+            String configKey) {\n+\n+        return shouldActivateService(capabilities, serviceEnabled, capabilities.isPresent(linkedCapability),\n+                linkedExtensionName, linkedCapability.getName(), configKey);\n+    }\n+\n+    private boolean shouldActivateService(Capabilities capabilities,\n+            Optional<Boolean> serviceEnabled,\n+            boolean linkedCapabilityIsPresent,\n+            String linkedExtensionName,\n+            String linkedCapabilityName,\n+            String configKey) {\n+\n+        if (serviceEnabled.isPresent()) {\n+            // The user explisitly asked from something\n+            boolean isEnabled = serviceEnabled.get();\n+            if (isEnabled) {\n+                if (linkedCapabilityIsPresent) {\n+                    // enable\n+                    return true;\n+                } else {\n+                    // Warn and disable\n+                    LOG.warnf(SERVICE_NOT_AVAILABLE_WARNING, configKey, linkedExtensionName, linkedCapabilityName);\n+                    return false;\n+                }\n+            } else {\n+                // disable\n+                return false;\n+            }\n+        } else {\n+            // Auto dis/enable\n+            if (linkedCapabilityIsPresent) {\n+                // enable\n+                return true;\n+            } else {\n+                // disable\n+                return false;\n+            }\n+        }", "originalCommit": "4e2167e97a0a5873c7816e5ab7ee0827be5fa76e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df99b6e09304acc3e45a9de446c02e24a478ad7e", "url": "https://github.com/quarkusio/quarkus/commit/df99b6e09304acc3e45a9de446c02e24a478ad7e", "message": "Clean up the config of service integration\n\nSigned-off-by: Phillip Kruger <phillip.kruger@gmail.com>", "committedDate": "2020-10-21T11:02:23Z", "type": "commit"}]}