{"pr_number": 7739, "pr_title": "Ensure that a .env file at the root of the project can be used in dev-mode", "pr_author": "geoand", "pr_createdAt": "2020-03-10T15:05:30Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7739", "timeline": [{"oid": "6fca5731e80fcf7b988c635325b53b4794d29641", "url": "https://github.com/quarkusio/quarkus/commit/6fca5731e80fcf7b988c635325b53b4794d29641", "message": "Ensure that a .env file at the root of the project can be used in dev-mode\n\nThis includes having the capability to update the file\n\nFixes: #7519", "committedDate": "2020-03-10T15:40:36Z", "type": "forcePushed"}, {"oid": "985c8cbdceb4b1911d3ecd57954fc9a2b191a3d1", "url": "https://github.com/quarkusio/quarkus/commit/985c8cbdceb4b1911d3ecd57954fc9a2b191a3d1", "message": "Ensure that a .env file at the root of the project can be used in dev-mode\n\nThis includes having the capability to update the file\n\nFixes: #7519", "committedDate": "2020-03-10T19:59:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2NjY3Mw==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390666673", "body": "```suggestion\r\n    // this is done because for the .env file to take effect, it needs to be\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // this is done because the for the .env file to take effect, it needs to be\n          \n          \n            \n                // this is done because for the .env file to take effect, it needs to be", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> this is done because <span class=\"x x-first x-last\">the </span>for the .env file to take effect, it needs to be</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> this is done because for the .env file to take effect, it needs to be</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gsmet", "createdAt": "2020-03-10T23:21:27Z", "path": "core/devmode/src/main/java/io/quarkus/dev/DevModeMain.java", "diffHunk": "@@ -110,6 +114,36 @@ public void start() throws Exception {\n         }\n     }\n \n+    // copies the .env file to the directory where the process is running\n+    // this is done because the for the .env file to take effect, it needs to be", "originalCommit": "985c8cbdceb4b1911d3ecd57954fc9a2b191a3d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc3ODg3NA==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390778874", "bodyText": "Fixed, thanks", "author": "geoand", "createdAt": "2020-03-11T07:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2NjY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2Njg5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390666890", "body": "Does it work on Windows?", "bodyText": "Does it work on Windows?", "bodyHTML": "<p dir=\"auto\">Does it work on Windows?</p>", "author": "gsmet", "createdAt": "2020-03-10T23:22:02Z", "path": "core/devmode/src/main/java/io/quarkus/dev/DevModeMain.java", "diffHunk": "@@ -110,6 +114,36 @@ public void start() throws Exception {\n         }\n     }\n \n+    // copies the .env file to the directory where the process is running\n+    // this is done because the for the .env file to take effect, it needs to be\n+    // in the same directory as the running process\n+    private void copyDotEnvFile() {\n+        File projectDir = context.getProjectDir();\n+        if (projectDir == null) { // this is the case for QuarkusDevModeTest\n+            return;\n+        }\n+        Path currentDir = Paths.get(\"\").toAbsolutePath().normalize();\n+        Path dotEnvPath = projectDir.toPath().resolve(\".env\");\n+        if (Files.exists(dotEnvPath)) {\n+            try {\n+                Path link = currentDir.resolve(\".env\");\n+                silentDeleteFile(link);\n+                // create a symlink to ensure that user updates to the file have the expected effect in dev-mode\n+                Files.createSymbolicLink(link, dotEnvPath);", "originalCommit": "985c8cbdceb4b1911d3ecd57954fc9a2b191a3d1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2NzIxNQ==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390667215", "bodyText": "I suppose so as you have a test.", "author": "gsmet", "createdAt": "2020-03-10T23:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2Njg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDc3NTk4OA==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390775988", "bodyText": "Yup, thankfully we have CI running on Windows as well \ud83d\ude0e - moreover it passes :)", "author": "geoand", "createdAt": "2020-03-11T06:59:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2Njg5MA=="}], "type": "inlineReview"}, {"oid": "c1ffc2a98208664b2334f0c6f568e55e30f496b6", "url": "https://github.com/quarkusio/quarkus/commit/c1ffc2a98208664b2334f0c6f568e55e30f496b6", "message": "Ensure that a .env file at the root of the project can be used in dev-mode\n\nThis includes having the capability to update the file\n\nFixes: #7519", "committedDate": "2020-03-11T07:10:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MTA0MA==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390891040", "body": "This seems like it might be overkill... would something like this work?\r\n\r\n```suggestion\r\n                        Paths.get(\".env\").toAbsolutePath().toString()));\r\n```", "bodyText": "This seems like it might be overkill... would something like this work?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    Paths.get(\"\").toAbsolutePath().normalize().resolve(\".env\").toAbsolutePath().toString()));\n          \n          \n            \n                                    Paths.get(\".env\").toAbsolutePath().toString()));", "bodyHTML": "<p dir=\"auto\">This seems like it might be overkill... would something like this work?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        <span class=\"pl-smi\">Paths</span><span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\">)</span><span class=\"pl-k x\">.</span><span class=\"x\">toAbsolutePath()</span><span class=\"pl-k x\">.</span><span class=\"x\">normalize()</span><span class=\"pl-k x\">.</span><span class=\"x\">resolve(</span><span class=\"pl-s\"><span class=\"pl-pds x x-last\">\"</span>.env<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>toAbsolutePath()<span class=\"pl-k\">.</span>toString()));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        <span class=\"pl-smi\">Paths</span><span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>.env<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>toAbsolutePath()<span class=\"pl-k\">.</span>toString()));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "dmlloyd", "createdAt": "2020-03-11T10:57:20Z", "path": "core/deployment/src/main/java/io/quarkus/deployment/steps/DevModeBuildStep.java", "diffHunk": "@@ -11,6 +12,7 @@\n     @BuildStep\n     List<HotDeploymentWatchedFileBuildItem> config() {\n         return Arrays.asList(new HotDeploymentWatchedFileBuildItem(\"META-INF/microprofile-config.properties\"),\n-                new HotDeploymentWatchedFileBuildItem(\"application.properties\"));\n+                new HotDeploymentWatchedFileBuildItem(\"application.properties\"), new HotDeploymentWatchedFileBuildItem(\n+                        Paths.get(\"\").toAbsolutePath().normalize().resolve(\".env\").toAbsolutePath().toString()));", "originalCommit": "c1ffc2a98208664b2334f0c6f568e55e30f496b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMDA4MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390900081", "bodyText": "It does yes, thanks", "author": "geoand", "createdAt": "2020-03-11T11:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MTA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MjM0MA==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390892340", "body": "This seems wrong... unless we know for a fact that the current directory is going to be `target/`?  We don't want to modify anything outside `target` for any reason.  It would be better to modify the config source impl if that's the case.", "bodyText": "This seems wrong... unless we know for a fact that the current directory is going to be target/?  We don't want to modify anything outside target for any reason.  It would be better to modify the config source impl if that's the case.", "bodyHTML": "<p dir=\"auto\">This seems wrong... unless we know for a fact that the current directory is going to be <code>target/</code>?  We don't want to modify anything outside <code>target</code> for any reason.  It would be better to modify the config source impl if that's the case.</p>", "author": "dmlloyd", "createdAt": "2020-03-11T10:59:32Z", "path": "core/devmode/src/main/java/io/quarkus/dev/DevModeMain.java", "diffHunk": "@@ -110,6 +114,36 @@ public void start() throws Exception {\n         }\n     }\n \n+    // copies the .env file to the directory where the process is running\n+    // this is done because for the .env file to take effect, it needs to be\n+    // in the same directory as the running process\n+    private void copyDotEnvFile() {\n+        File projectDir = context.getProjectDir();\n+        if (projectDir == null) { // this is the case for QuarkusDevModeTest\n+            return;\n+        }\n+        Path currentDir = Paths.get(\"\").toAbsolutePath().normalize();\n+        Path dotEnvPath = projectDir.toPath().resolve(\".env\");\n+        if (Files.exists(dotEnvPath)) {\n+            try {\n+                Path link = currentDir.resolve(\".env\");\n+                silentDeleteFile(link);\n+                // create a symlink to ensure that user updates to the file have the expected effect in dev-mode\n+                Files.createSymbolicLink(link, dotEnvPath);", "originalCommit": "c1ffc2a98208664b2334f0c6f568e55e30f496b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5NDQ2NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390894465", "bodyText": "The reason I did this is because as a user I expect that if my ${rootDir}/.env file is going to be picked up when I do mvn quarkus:dev, then I would also expect it to be monitored for changes. With this way of doing things, those changes are picked up.\nIt doesn't really have to do with ./target at all, unless I am missing something.\nWDYT?", "author": "geoand", "createdAt": "2020-03-11T11:03:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MjM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5NjY3Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390896677", "bodyText": "The question is, where is this symbolic link being created, in practical terms?", "author": "dmlloyd", "createdAt": "2020-03-11T11:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MjM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5OTEzMg==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390899132", "bodyText": "Inside target. Which is why I mentioned that updates work, but deleting the original .env doesn't (although I wouldn't expect the user to do that)", "author": "geoand", "createdAt": "2020-03-11T11:12:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MjM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5OTk3NQ==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390899975", "bodyText": "OK, that's what I wanted to know.  Thanks!", "author": "dmlloyd", "createdAt": "2020-03-11T11:14:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MjM0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkwMDUyNA==", "url": "https://github.com/quarkusio/quarkus/pull/7739#discussion_r390900524", "bodyText": "\ud83d\udc4d", "author": "geoand", "createdAt": "2020-03-11T11:15:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg5MjM0MA=="}], "type": "inlineReview"}, {"oid": "de155a07b937014445e575598d18b3c5f6b8e53d", "url": "https://github.com/quarkusio/quarkus/commit/de155a07b937014445e575598d18b3c5f6b8e53d", "message": "Ensure that a .env file at the root of the project can be used in dev-mode\n\nThis includes having the capability to update the file\n\nFixes: #7519", "committedDate": "2020-03-11T11:15:03Z", "type": "forcePushed"}, {"oid": "b4d7778f891ab6061e4f556cda275169941d48e6", "url": "https://github.com/quarkusio/quarkus/commit/b4d7778f891ab6061e4f556cda275169941d48e6", "message": "Ensure that a .env file at the root of the project can be used in dev-mode\n\nThis includes having the capability to update the file\n\nFixes: #7519", "committedDate": "2020-03-11T11:20:05Z", "type": "commit"}, {"oid": "b4d7778f891ab6061e4f556cda275169941d48e6", "url": "https://github.com/quarkusio/quarkus/commit/b4d7778f891ab6061e4f556cda275169941d48e6", "message": "Ensure that a .env file at the root of the project can be used in dev-mode\n\nThis includes having the capability to update the file\n\nFixes: #7519", "committedDate": "2020-03-11T11:20:05Z", "type": "forcePushed"}]}