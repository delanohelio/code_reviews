{"pr_number": 9933, "pr_title": "Add ability to run tests with different config profiles", "pr_author": "stuartwdouglas", "pr_createdAt": "2020-06-11T03:09:29Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/9933", "timeline": [{"oid": "8a18bad995745e2e2d1a47064f67721d0ca05fe1", "url": "https://github.com/quarkusio/quarkus/commit/8a18bad995745e2e2d1a47064f67721d0ca05fe1", "message": "Add ability to run tests with different config profiles", "committedDate": "2020-06-11T03:17:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1OTE0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r438559142", "body": "Perhaps this should be called `TestProfile`?", "bodyText": "Perhaps this should be called TestProfile?", "bodyHTML": "<p dir=\"auto\">Perhaps this should be called <code>TestProfile</code>?</p>", "author": "geoand", "createdAt": "2020-06-11T05:59:31Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/WithProfile.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package io.quarkus.test.junit;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+/**\n+ * Defines a 'test profile'. Tests run under a test profile\n+ * will have different configuration options to other tests.\n+ *\n+ * Due to the global nature of Quarkus if a previous test was\n+ * run under a different profile then Quarkus will need to be\n+ * restarted when the profile changes. Unfortunately there\n+ * is currently no way to order tests based on profile, however\n+ * this can be done manually by running tests in alphabetical\n+ * order and putting all tests with the same profile in the same\n+ * package.\n+ */\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target(ElementType.TYPE)\n+public @interface WithProfile {", "originalCommit": "8a18bad995745e2e2d1a47064f67721d0ca05fe1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU1OTM4NA==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r438559384", "body": "I love the idea of having all per-test configuration under one class, really simplifies things both for users and for us :)", "bodyText": "I love the idea of having all per-test configuration under one class, really simplifies things both for users and for us :)", "bodyHTML": "<p dir=\"auto\">I love the idea of having all per-test configuration under one class, really simplifies things both for users and for us :)</p>", "author": "geoand", "createdAt": "2020-06-11T06:00:19Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestProfile.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package io.quarkus.test.junit;\n+\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Defines a 'test profile'. Tests run under a test profile\n+ * will have different configuration options to other tests.\n+ *\n+ */\n+public interface QuarkusTestProfile {", "originalCommit": "8a18bad995745e2e2d1a47064f67721d0ca05fe1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a2ff59a02b47549841a81a5572508a13eb5e2e58", "url": "https://github.com/quarkusio/quarkus/commit/a2ff59a02b47549841a81a5572508a13eb5e2e58", "message": "Add ability to run tests with different config profiles", "committedDate": "2020-06-15T03:55:26Z", "type": "forcePushed"}, {"oid": "f0eabb050b1325624bac9858cac3f147ade989cc", "url": "https://github.com/quarkusio/quarkus/commit/f0eabb050b1325624bac9858cac3f147ade989cc", "message": "Add ability to run tests with different config profiles", "committedDate": "2020-06-15T04:43:39Z", "type": "forcePushed"}, {"oid": "2f7b40c343c81c61212c3497b6594f3b68d29feb", "url": "https://github.com/quarkusio/quarkus/commit/2f7b40c343c81c61212c3497b6594f3b68d29feb", "message": "Add ability to run tests with different config profiles", "committedDate": "2020-06-15T04:44:50Z", "type": "commit"}, {"oid": "2f7b40c343c81c61212c3497b6594f3b68d29feb", "url": "https://github.com/quarkusio/quarkus/commit/2f7b40c343c81c61212c3497b6594f3b68d29feb", "message": "Add ability to run tests with different config profiles", "committedDate": "2020-06-15T04:44:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY4MDI4MA==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r440680280", "body": "FYI there is also `quarkus.arc.exclude-types` that allows you to exclude types from discovery, i.e. ignore the specified types. And it hase the same syntax as selected alternatives: https://github.com/quarkusio/quarkus/blob/master/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ArcConfig.java#L99-L113", "bodyText": "FYI there is also quarkus.arc.exclude-types that allows you to exclude types from discovery, i.e. ignore the specified types. And it hase the same syntax as selected alternatives: https://github.com/quarkusio/quarkus/blob/master/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ArcConfig.java#L99-L113", "bodyHTML": "<p dir=\"auto\">FYI there is also <code>quarkus.arc.exclude-types</code> that allows you to exclude types from discovery, i.e. ignore the specified types. And it hase the same syntax as selected alternatives: <a href=\"https://github.com/quarkusio/quarkus/blob/master/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ArcConfig.java#L99-L113\">https://github.com/quarkusio/quarkus/blob/master/extensions/arc/deployment/src/main/java/io/quarkus/arc/deployment/ArcConfig.java#L99-L113</a></p>", "author": "mkouba", "createdAt": "2020-06-16T08:34:07Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/QuarkusTestExtension.java", "diffHunk": "@@ -114,10 +121,38 @@ private ExtensionState doJavaStart(ExtensionContext context) throws Throwable {\n                 }\n             }\n             originalCl = Thread.currentThread().getContextClassLoader();\n+            Map<String, String> sysPropRestore = new HashMap<>();\n+            sysPropRestore.put(ProfileManager.QUARKUS_TEST_PROFILE_PROP,\n+                    System.getProperty(ProfileManager.QUARKUS_TEST_PROFILE_PROP));\n \n             final QuarkusBootstrap.Builder runnerBuilder = QuarkusBootstrap.builder()\n                     .setIsolateDeployment(true)\n                     .setMode(QuarkusBootstrap.Mode.TEST);\n+            if (profile != null) {\n+                QuarkusTestProfile profileInstance = profile.newInstance();\n+                Map<String, String> additional = new HashMap<>(profileInstance.getConfigOverrides());\n+                if (!profileInstance.getEnabledAlternatives().isEmpty()) {\n+                    additional.put(\"quarkus.arc.selected-alternatives\", profileInstance.getEnabledAlternatives().stream()", "originalCommit": "2f7b40c343c81c61212c3497b6594f3b68d29feb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNDQ1Mw==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r446114453", "body": "IMHO it would make sense to define this interface as `@Inherited` in case someone wants to define it on a common superclass.\r\n\r\nFor JUnit 5 tests I am also used to be able to define my own [_composed annotations with meta-annotations_](https://junit.org/junit5/docs/current/user-guide/#writing-tests-meta-annotations), which I think could also be very useful for Quarkus' test annotations like `@QuarkusTestResource` and `@TestProfile`. But for this I will file a separate enhancement request.", "bodyText": "IMHO it would make sense to define this interface as @Inherited in case someone wants to define it on a common superclass.\nFor JUnit 5 tests I am also used to be able to define my own composed annotations with meta-annotations, which I think could also be very useful for Quarkus' test annotations like @QuarkusTestResource and @TestProfile. But for this I will file a separate enhancement request.", "bodyHTML": "<p dir=\"auto\">IMHO it would make sense to define this interface as <code>@Inherited</code> in case someone wants to define it on a common superclass.</p>\n<p dir=\"auto\">For JUnit 5 tests I am also used to be able to define my own <a href=\"https://junit.org/junit5/docs/current/user-guide/#writing-tests-meta-annotations\" rel=\"nofollow\"><em>composed annotations with meta-annotations</em></a>, which I think could also be very useful for Quarkus' test annotations like <code>@QuarkusTestResource</code> and <code>@TestProfile</code>. But for this I will file a separate enhancement request.</p>", "author": "knutwannheden", "createdAt": "2020-06-26T10:57:43Z", "path": "test-framework/junit5/src/main/java/io/quarkus/test/junit/TestProfile.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package io.quarkus.test.junit;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+/**\n+ * Defines a 'test profile'. Tests run under a test profile\n+ * will have different configuration options to other tests.\n+ *\n+ * Due to the global nature of Quarkus if a previous test was\n+ * run under a different profile then Quarkus will need to be\n+ * restarted when the profile changes. Unfortunately there\n+ * is currently no way to order tests based on profile, however\n+ * this can be done manually by running tests in alphabetical\n+ * order and putting all tests with the same profile in the same\n+ * package.\n+ */\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target(ElementType.TYPE)\n+public @interface TestProfile {", "originalCommit": "2f7b40c343c81c61212c3497b6594f3b68d29feb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNDk0OQ==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r446114949", "bodyText": "Please do, that sounds useful", "author": "geoand", "createdAt": "2020-06-26T10:59:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNDQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNzA0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r446117042", "bodyText": "See #10297.", "author": "knutwannheden", "createdAt": "2020-06-26T11:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNDQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNzU0MA==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r446117540", "bodyText": "Should I file a separate enhancement request for declaring @QuarkusTestResource and @TestProfile as @Inherited?", "author": "knutwannheden", "createdAt": "2020-06-26T11:05:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNDQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExODQwMQ==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r446118401", "bodyText": "Sure yeah", "author": "geoand", "createdAt": "2020-06-26T11:07:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNDQ1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExODQ0Mg==", "url": "https://github.com/quarkusio/quarkus/pull/9933#discussion_r446118442", "bodyText": "See #10297.\n\nThanks", "author": "geoand", "createdAt": "2020-06-26T11:07:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjExNDQ1Mw=="}], "type": "inlineReview"}]}