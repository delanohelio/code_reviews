{"pr_number": 7786, "pr_title": "Fixes related to Maven projects using the 'revision' property as the project version", "pr_author": "aloubyansky", "pr_createdAt": "2020-03-11T17:22:31Z", "pr_url": "https://github.com/quarkusio/quarkus/pull/7786", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5MjMzNw==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391292337", "body": "Just a heads up: https://maven.apache.org/maven-ci-friendly.html does not only support `revision` but also `sha1` and/or `changelist`.", "bodyText": "Just a heads up: https://maven.apache.org/maven-ci-friendly.html does not only support revision but also sha1 and/or changelist.", "bodyHTML": "<p dir=\"auto\">Just a heads up: <a href=\"https://maven.apache.org/maven-ci-friendly.html\" rel=\"nofollow\">https://maven.apache.org/maven-ci-friendly.html</a> does not only support <code>revision</code> but also <code>sha1</code> and/or <code>changelist</code>.</p>", "author": "famod", "createdAt": "2020-03-11T22:00:31Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/resolver/maven/workspace/LocalProject.java", "diffHunk": "@@ -28,17 +28,24 @@\n \n     private static final String PROJECT_BASEDIR = \"${project.basedir}\";\n     private static final String POM_XML = \"pom.xml\";\n+    private static final String REVISION = \"revision\";", "originalCommit": "f14d4c42f6bdfd97930ddb5867b188edffd57bfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5NTU5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391295590", "bodyText": "Thanks for pointing this out. I'll probably add support for those in another PR just to get this one in quicker. Unless you tell me you absolutely need them :)", "author": "aloubyansky", "createdAt": "2020-03-11T22:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5MjMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5Njk1OA==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391296958", "bodyText": "I'm fine with just revision!", "author": "famod", "createdAt": "2020-03-11T22:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI5MjMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTgzNg==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391319836", "body": "Does this also cover `-Drevision=<something_different_than_in_pom>`?\r\nThis is important, because that is what CI (e.g. Jenkins via `Jenkinsfile`) would be passing to `mvn` to override the default revision.\r\n\r\nA variation is of that would be:\r\n- ```xml\r\n  <properties>\r\n      <revision>0.1-${revisionSuffix}</revision>\r\n      <revisionSuffix>SNAPSHOT</revisionSuffix>\r\n  </properties>\r\n  ```\r\n- CI passes `-DrevisionSuffix=build-${BUILD_NUMBER}`\r\n\r\nThis way local build produces `0.1-SNAPSHOT` and CI produces something like `0.1-build-123`.", "bodyText": "Does this also cover -Drevision=<something_different_than_in_pom>?\nThis is important, because that is what CI (e.g. Jenkins via Jenkinsfile) would be passing to mvn to override the default revision.\nA variation is of that would be:\n\n\n<properties>\n    <revision>0.1-${revisionSuffix}</revision>\n    <revisionSuffix>SNAPSHOT</revisionSuffix>\n</properties>\n\nCI passes -DrevisionSuffix=build-${BUILD_NUMBER}\n\nThis way local build produces 0.1-SNAPSHOT and CI produces something like 0.1-build-123.", "bodyHTML": "<p dir=\"auto\">Does this also cover <code>-Drevision=&lt;something_different_than_in_pom&gt;</code>?<br>\nThis is important, because that is what CI (e.g. Jenkins via <code>Jenkinsfile</code>) would be passing to <code>mvn</code> to override the default revision.</p>\n<p dir=\"auto\">A variation is of that would be:</p>\n<ul dir=\"auto\">\n<li>\n<div class=\"highlight highlight-text-xml position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"&lt;properties&gt;\n    &lt;revision&gt;0.1-${revisionSuffix}&lt;/revision&gt;\n    &lt;revisionSuffix&gt;SNAPSHOT&lt;/revisionSuffix&gt;\n&lt;/properties&gt;\"><pre>&lt;<span class=\"pl-ent\">properties</span>&gt;\n    &lt;<span class=\"pl-ent\">revision</span>&gt;0.1-${revisionSuffix}&lt;/<span class=\"pl-ent\">revision</span>&gt;\n    &lt;<span class=\"pl-ent\">revisionSuffix</span>&gt;SNAPSHOT&lt;/<span class=\"pl-ent\">revisionSuffix</span>&gt;\n&lt;/<span class=\"pl-ent\">properties</span>&gt;</pre></div>\n</li>\n<li>CI passes <code>-DrevisionSuffix=build-${BUILD_NUMBER}</code></li>\n</ul>\n<p dir=\"auto\">This way local build produces <code>0.1-SNAPSHOT</code> and CI produces something like <code>0.1-build-123</code>.</p>", "author": "famod", "createdAt": "2020-03-11T23:06:20Z", "path": "independent-projects/bootstrap/core/src/main/java/io/quarkus/bootstrap/resolver/maven/workspace/LocalProject.java", "diffHunk": "@@ -136,10 +143,30 @@ private LocalProject(Model rawModel, LocalWorkspace workspace) throws BootstrapE\n         this.workspace = workspace;\n         this.groupId = ModelUtils.getGroupId(rawModel);\n         this.artifactId = rawModel.getArtifactId();\n-        this.version = ModelUtils.getVersion(rawModel);\n+\n+        String version = ModelUtils.getVersion(rawModel);\n+        final boolean revisionVersion;\n+        if (revisionVersion = REVISION_EXPR.equals(version)) {\n+            version = rawModel.getProperties().getProperty(REVISION);", "originalCommit": "f14d4c42f6bdfd97930ddb5867b188edffd57bfe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUxOTI2Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391519262", "bodyText": "Actually according to the Maven doc you referenced this is not supported by Maven itself, isn't it?", "author": "aloubyansky", "createdAt": "2020-03-12T10:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyMDM5MA==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391520390", "bodyText": "I tried adding support for sha1 and changelist but strangely it also didn't work in Maven itself. Unless I somehow did it wrong.", "author": "aloubyansky", "createdAt": "2020-03-12T10:15:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyODc1Mg==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391528752", "bodyText": "Does this also cover -Drevision=<something_different_than_in_pom>?\n\nThis will work though.", "author": "aloubyansky", "createdAt": "2020-03-12T10:30:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5Nzg3Ng==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391697876", "bodyText": "Actually according to the Maven doc you referenced this is not supported by Maven itself, isn't it?\n\nWhich part do you mean? -Drevision=... is mentioned explicitly multiple times.\nThe revisionSuffix is not mentioned but IMHO this is just basic Maven interpolation logic, no?\nYou could also have myFancySomethingProperty instead of revisionSuffix, doesn't matter.\n\nI tried adding support for sha1 and changelist but strangely it also didn't work in Maven itself.\n\nI swapped revision with sha1 locally in my sample project and it worked (apart from the Quarkus build problem). I even changed the default value from 1.0-SNAPSHOT to 0.2-SNAPSHOT and I also tried -Dsha1=1.1-SNAPSHOT.\n\n\nDoes this also cover -Drevision=<something_different_than_in_pom>?\n\nThis will work though.\n\nOk, as long as this works the main problem is solved. The rest could be addressed separately.", "author": "famod", "createdAt": "2020-03-12T15:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwMDU4Nw==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391700587", "bodyText": "You could also have myFancySomethingProperty instead of revisionSuffix, doesn't matter.\n\nArbitrary property interpolation is not allowed in the version elements. There is an example in that doc.\n\nI swapped revision with sha1 locally in my sample project and it worked\n\nAh, I need to try that. I tried combining the three mentioned properties like they had in the doc, which for some reason didn't work.", "author": "aloubyansky", "createdAt": "2020-03-12T15:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTgzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcxMTQ2MQ==", "url": "https://github.com/quarkusio/quarkus/pull/7786#discussion_r391711461", "bodyText": "You could also have myFancySomethingProperty instead of revisionSuffix, doesn't matter.\n\nArbitrary property interpolation is not allowed in the version elements. There is an example in that doc.\n\nYou are right, I have totally missed that!\n\n\nI swapped revision with sha1 locally in my sample project and it worked\n\nAh, I need to try that. I tried combining the three mentioned properties like they had in the doc, which for some reason didn't work.\n\nI just tried the following and everything works as expected (in Maven itself):\ndiff --git a/core/pom.xml b/core/pom.xml\nindex ea45976..b52f070 100644\n--- a/core/pom.xml\n+++ b/core/pom.xml\n@@ -5,7 +5,7 @@\n   <parent>\n     <groupId>com.github.famod.modmono-quarkus</groupId>\n     <artifactId>modmono-quarkus-parent</artifactId>\n-    <version>${revision}</version>\n+    <version>${revision}${sha1}</version>\n   </parent>\n   <artifactId>modmono-quarkus-core</artifactId>\n   <dependencies>\ndiff --git a/dist/pom.xml b/dist/pom.xml\nindex 278e9c5..e0df457 100644\n--- a/dist/pom.xml\n+++ b/dist/pom.xml\n@@ -5,7 +5,7 @@\n   <parent>\n     <groupId>com.github.famod.modmono-quarkus</groupId>\n     <artifactId>modmono-quarkus-parent</artifactId>\n-    <version>${revision}</version>\n+    <version>${revision}${sha1}</version>\n   </parent>\n   <artifactId>modmono-quarkus-dist</artifactId>\n   <dependencies>\ndiff --git a/pom.xml b/pom.xml\nindex b895c66..f72103c 100644\n--- a/pom.xml\n+++ b/pom.xml\n@@ -4,10 +4,11 @@\n   <modelVersion>4.0.0</modelVersion>\n   <groupId>com.github.famod.modmono-quarkus</groupId>\n   <artifactId>modmono-quarkus-parent</artifactId>\n-  <version>${revision}</version>\n+  <version>${revision}${sha1}</version>\n   <packaging>pom</packaging>\n   <properties>\n-    <revision>1.0-SNAPSHOT</revision>\n+    <revision>0.3</revision>\n+    <sha1>-SNAPSHOT</sha1>\n\n     <compiler-plugin.version>3.8.1</compiler-plugin.version>", "author": "famod", "createdAt": "2020-03-12T15:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTgzNg=="}], "type": "inlineReview"}, {"oid": "8932af18edd8cc7e5b5243a105f63033458a119a", "url": "https://github.com/quarkusio/quarkus/commit/8932af18edd8cc7e5b5243a105f63033458a119a", "message": "Fixes related to Maven projects using the 'revision' property as the project version", "committedDate": "2020-03-12T10:29:21Z", "type": "commit"}, {"oid": "8932af18edd8cc7e5b5243a105f63033458a119a", "url": "https://github.com/quarkusio/quarkus/commit/8932af18edd8cc7e5b5243a105f63033458a119a", "message": "Fixes related to Maven projects using the 'revision' property as the project version", "committedDate": "2020-03-12T10:29:21Z", "type": "forcePushed"}]}