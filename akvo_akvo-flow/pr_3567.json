{"pr_number": 3567, "pr_title": "Fix webform validation conditions and refactor logic application contexts", "pr_author": "tangrammer", "pr_createdAt": "2020-05-21T16:30:42Z", "pr_url": "https://github.com/akvo/akvo-flow/pull/3567", "timeline": [{"oid": "318597e1d14687178fdad4ea2d27f2b10a652e40", "url": "https://github.com/akvo/akvo-flow/commit/318597e1d14687178fdad4ea2d27f2b10a652e40", "message": "[#3562] Fix webform constraints\n\nAllow cascade types and don't allow monitoring surveys nor repeatable\nquestion groups", "committedDate": "2020-05-21T13:17:35Z", "type": "commit"}, {"oid": "60a2e81242230632671f8b47eb54eefec6a563d8", "url": "https://github.com/akvo/akvo-flow/commit/60a2e81242230632671f8b47eb54eefec6a563d8", "message": "[#3562] Move webform validation to publishing survey place\n\nInstead of having validation every time a question is changed or a\nquestionGroup is changed or a form is changed", "committedDate": "2020-05-21T16:05:57Z", "type": "commit"}, {"oid": "ed0ffc57cc551342a4c675aed85883bce9082ba3", "url": "https://github.com/akvo/akvo-flow/commit/ed0ffc57cc551342a4c675aed85883bce9082ba3", "message": "[#3526] Update webform only if enabled on publishing action", "committedDate": "2020-05-21T17:28:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NDQ1Mw==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r428854453", "body": "Why do we need an explicit `boolean` primitive? .... using `i.getRepeatable()` does the trick", "bodyText": "Why do we need an explicit boolean primitive? .... using i.getRepeatable() does the trick", "bodyHTML": "<p dir=\"auto\">Why do we need an explicit <code>boolean</code> primitive? .... using <code>i.getRepeatable()</code> does the trick</p>", "author": "iperdomo", "createdAt": "2020-05-21T19:05:48Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable().booleanValue()).collect(Collectors.toList()).size() == 0;", "originalCommit": "ed0ffc57cc551342a4c675aed85883bce9082ba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg1NDY0OA==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r428854648", "body": "Idem, that extra `.booleanValue()` is not required, I think", "bodyText": "Idem, that extra .booleanValue() is not required, I think", "bodyHTML": "<p dir=\"auto\">Idem, that extra <code>.booleanValue()</code> is not required, I think</p>", "author": "iperdomo", "createdAt": "2020-05-21T19:06:13Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable().booleanValue()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static boolean validSurveyGroup(final SurveyGroup surveyGroup){\n+        return !surveyGroup.getMonitoringGroup().booleanValue();", "originalCommit": "ed0ffc57cc551342a4c675aed85883bce9082ba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "url": "https://github.com/akvo/akvo-flow/commit/4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "message": "[#3526] Use Boolean instead of boolean", "committedDate": "2020-05-22T07:48:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429109666", "body": "So this one is a bit more subtle. It should be that webforms doesn't support monitoring forms. I.e. in a survey you have registration form and monitoring forms.  We should allow a registration form to be filled in.  Registration form id is === `SurveyGroup.newLocaleSurveyId` @marvinkome I guess this is already done on UI side?", "bodyText": "So this one is a bit more subtle. It should be that webforms doesn't support monitoring forms. I.e. in a survey you have registration form and monitoring forms.  We should allow a registration form to be filled in.  Registration form id is === SurveyGroup.newLocaleSurveyId @marvinkome I guess this is already done on UI side?", "bodyHTML": "<p dir=\"auto\">So this one is a bit more subtle. It should be that webforms doesn't support monitoring forms. I.e. in a survey you have registration form and monitoring forms.  We should allow a registration form to be filled in.  Registration form id is === <code>SurveyGroup.newLocaleSurveyId</code> <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/marvinkome/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/marvinkome\">@marvinkome</a> I guess this is already done on UI side?</p>", "author": "muloem", "createdAt": "2020-05-22T08:20:46Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static Boolean validSurveyGroup(final SurveyGroup surveyGroup){", "originalCommit": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExMzYzNg==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429113636", "bodyText": "Yeah on the UI, monitoring surveys aren't supported", "author": "marvinkome", "createdAt": "2020-05-22T08:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExNDU4Mw==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429114583", "bodyText": "Monitoring surveys or monitoring forms?", "author": "muloem", "createdAt": "2020-05-22T08:30:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExNzU4OQ==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429117589", "bodyText": "\ud83d\udc40 monitoring survey groups", "author": "marvinkome", "createdAt": "2020-05-22T08:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExOTM2Ng==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429119366", "bodyText": "Should be the same... in a monitoring Survey(Group) you have two kinds of forms, registration and monitoring forms. Registration forms can be shared via webforms, monitoring forms cannot be shared. Registration form id is found by looking at the SurveyGroup.newLocaleSurveyId property", "author": "muloem", "createdAt": "2020-05-22T08:41:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwOTY2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE0MjU4OA==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429142588", "body": "Let's always use `{ }` in `if` conditions.", "bodyText": "Let's always use { } in if conditions.", "bodyHTML": "<p dir=\"auto\">Let's always use <code>{ }</code> in <code>if</code> conditions.</p>", "author": "iperdomo", "createdAt": "2020-05-22T09:29:53Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -25,17 +25,26 @@\n \n     public static Set<String> unsupportedQuestionTypes(){\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey){\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static Boolean validSurveyGroup(final SurveyGroup surveyGroup){\n+        return !surveyGroup.getMonitoringGroup();\n+    }\n+\n+    public static boolean validWebForm(final SurveyGroup surveyGroup, final Survey survey, final List<Question> questions){\n+        boolean validQuestionGroups = validQuestionGroups(survey);\n+        if (!validQuestionGroups) return false;", "originalCommit": "4d34af2beea879c0d6cb592a0b9d79980b9d0a11", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29d10548622314c88794b2c0a8709ddba31d630e", "url": "https://github.com/akvo/akvo-flow/commit/29d10548622314c88794b2c0a8709ddba31d630e", "message": "[#3526] Adapt to PR review", "committedDate": "2020-05-22T09:32:09Z", "type": "commit"}, {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509", "url": "https://github.com/akvo/akvo-flow/commit/2cafdf33784247cb56131b389c4fee9e11d0a509", "message": "[#3562] Refactor", "committedDate": "2020-05-22T09:40:16Z", "type": "commit"}, {"oid": "2cafdf33784247cb56131b389c4fee9e11d0a509", "url": "https://github.com/akvo/akvo-flow/commit/2cafdf33784247cb56131b389c4fee9e11d0a509", "message": "[#3562] Refactor", "committedDate": "2020-05-22T09:40:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTE1MzQ3MQ==", "url": "https://github.com/akvo/akvo-flow/pull/3567#discussion_r429153471", "body": "```suggestion\r\n    public static boolean validForm(final Survey survey, final SurveyGroup surveyGroup) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static boolean validSurveyGroup(final Survey survey, final SurveyGroup surveyGroup) {\n          \n          \n            \n                public static boolean validForm(final Survey survey, final SurveyGroup surveyGroup) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">validSurveyGroup</span>(<span class=\"pl-k\">final</span> <span class=\"pl-smi\">Survey</span> survey, <span class=\"pl-k\">final</span> <span class=\"pl-smi\">SurveyGroup</span> surveyGroup) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">validForm</span>(<span class=\"pl-k\">final</span> <span class=\"pl-smi\">Survey</span> survey, <span class=\"pl-k\">final</span> <span class=\"pl-smi\">SurveyGroup</span> surveyGroup) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "muloem", "createdAt": "2020-05-22T09:53:30Z", "path": "GAE/src/com/gallatinsystems/survey/domain/WebForm.java", "diffHunk": "@@ -23,19 +23,32 @@\n \n public class WebForm {\n \n-    public static Set<String> unsupportedQuestionTypes(){\n+    public static Set<String> unsupportedQuestionTypes() {\n         Set<String> unsupportedTypes = new HashSet<String>();\n-        unsupportedTypes.add(Question.Type.CASCADE.toString());\n         unsupportedTypes.add(Question.Type.GEOSHAPE.toString());\n         unsupportedTypes.add(Question.Type.SIGNATURE.toString());\n         unsupportedTypes.add(Question.Type.CADDISFLY.toString());\n         return unsupportedTypes;\n     }\n \n-    public static boolean validWebForm(final List<Question> questions){\n-        \n-        List<Question> validQuestions = questions.stream().filter(i -> !unsupportedQuestionTypes().contains(i.getType().toString())).collect(Collectors.toList());\n+    public static boolean validQuestionGroups(final Survey survey) {\n+        return survey.getQuestionGroupMap().values().stream().filter(i -> i.getRepeatable()).collect(Collectors.toList()).size() == 0;\n+    }\n \n+    public static boolean validSurveyGroup(final Survey survey, final SurveyGroup surveyGroup) {", "originalCommit": "2cafdf33784247cb56131b389c4fee9e11d0a509", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce7b6dd28a7a8781303777b9533e2b9c491512c5", "url": "https://github.com/akvo/akvo-flow/commit/ce7b6dd28a7a8781303777b9533e2b9c491512c5", "message": "Update GAE/src/com/gallatinsystems/survey/domain/WebForm.java\n\nCo-authored-by: Emmanuel Mulo <emmanuel@akvo.org>", "committedDate": "2020-05-22T10:27:54Z", "type": "commit"}, {"oid": "78f015b53941acf2db97edcdfa75c7ac578a2942", "url": "https://github.com/akvo/akvo-flow/commit/78f015b53941acf2db97edcdfa75c7ac578a2942", "message": "[#3562] Fix build", "committedDate": "2020-05-22T10:47:39Z", "type": "commit"}]}