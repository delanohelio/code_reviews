{"pr_number": 3582, "pr_title": "[Feature][API] process definition delete api add check process instance is already running. #3581", "pr_author": "zhuangchong", "pr_createdAt": "2020-08-24T10:45:27Z", "pr_url": "https://github.com/apache/dolphinscheduler/pull/3582", "timeline": [{"oid": "97397b40fa00424adb72b26dae006a64d735952f", "url": "https://github.com/apache/dolphinscheduler/commit/97397b40fa00424adb72b26dae006a64d735952f", "message": "process definition delete api add check process instance is already running.", "committedDate": "2020-08-24T05:25:30Z", "type": "commit"}, {"oid": "2aaac4b3d297f7a5f7b73a133e1dfde978c64530", "url": "https://github.com/apache/dolphinscheduler/commit/2aaac4b3d297f7a5f7b73a133e1dfde978c64530", "message": "add checkstyle.", "committedDate": "2020-08-25T01:38:54Z", "type": "commit"}, {"oid": "2f927f0fac150f822d5e9bd219db3284b99373ed", "url": "https://github.com/apache/dolphinscheduler/commit/2f927f0fac150f822d5e9bd219db3284b99373ed", "message": "update.", "committedDate": "2020-08-25T03:10:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyMTE4NQ==", "url": "https://github.com/apache/dolphinscheduler/pull/3582#discussion_r477321185", "body": "```suggestion\r\n        List<ProcessInstance> processInstances =  processInstanceService.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\r\n        if (CollectionUtils.isNotEmpty(processInstances)) {\r\n            putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\r\n            return result;\r\n        }\r\n```\r\n\r\nHi,\r\nIn `processDefinitionService` service layer, it is not recommended straightly use `processInstanceMapper` dao layer, this part should be in `processInstanceService`, use `processInstanceService` here. ", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<ProcessInstance> processInstances =  processInstanceMapper.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n          \n          \n            \n                    if (CollectionUtils.isNotEmpty(processInstances)) {\n          \n          \n            \n                        putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n          \n          \n            \n                        return result;\n          \n          \n            \n                    }\n          \n          \n            \n                    List<ProcessInstance> processInstances =  processInstanceService.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n          \n          \n            \n                    if (CollectionUtils.isNotEmpty(processInstances)) {\n          \n          \n            \n                        putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n          \n          \n            \n                        return result;\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nHi,\nIn processDefinitionService service layer, it is not recommended straightly use processInstanceMapper dao layer, this part should be in processInstanceService, use processInstanceService here.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"496\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">ProcessInstance</span>&gt;</span> processInstances <span class=\"pl-k\">=</span>  <span class=\"x x-first x-last\">processInstanceMapper</span><span class=\"pl-k\">.</span>queryByProcessDefineIdAndStatus(processDefinitionId, <span class=\"pl-smi\">Constants</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>NOT_TERMINATED_STATES</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"497\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">CollectionUtils</span><span class=\"pl-k\">.</span>isNotEmpty(processInstances)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"498\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            putMsg(result, <span class=\"pl-smi\">Status</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>DELETE_PROCESS_DEFINITION_BY_ID_FAIL</span>,processInstances<span class=\"pl-k\">.</span>size());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"499\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">return</span> result;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"500\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"496\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">ProcessInstance</span>&gt;</span> processInstances <span class=\"pl-k\">=</span>  <span class=\"x x-first x-last\">processInstanceService</span><span class=\"pl-k\">.</span>queryByProcessDefineIdAndStatus(processDefinitionId, <span class=\"pl-smi\">Constants</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>NOT_TERMINATED_STATES</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"497\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (<span class=\"pl-smi\">CollectionUtils</span><span class=\"pl-k\">.</span>isNotEmpty(processInstances)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"498\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            putMsg(result, <span class=\"pl-smi\">Status</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>DELETE_PROCESS_DEFINITION_BY_ID_FAIL</span>,processInstances<span class=\"pl-k\">.</span>size());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"499\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span> result;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"500\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Hi,<br>\nIn <code>processDefinitionService</code> service layer, it is not recommended straightly use <code>processInstanceMapper</code> dao layer, this part should be in <code>processInstanceService</code>, use <code>processInstanceService</code> here.</p>", "author": "yangyichao-mango", "createdAt": "2020-08-26T13:56:42Z", "path": "dolphinscheduler-api/src/main/java/org/apache/dolphinscheduler/api/service/impl/ProcessDefinitionServiceImpl.java", "diffHunk": "@@ -488,6 +488,12 @@ private String getResourceIds(ProcessData processData) {\n             putMsg(result, Status.PROCESS_DEFINE_STATE_ONLINE, processDefinitionId);\n             return result;\n         }\n+        // check process instances is already running\n+        List<ProcessInstance> processInstances =  processInstanceMapper.queryByProcessDefineIdAndStatus(processDefinitionId, Constants.NOT_TERMINATED_STATES);\n+        if (CollectionUtils.isNotEmpty(processInstances)) {\n+            putMsg(result, Status.DELETE_PROCESS_DEFINITION_BY_ID_FAIL,processInstances.size());\n+            return result;\n+        }", "originalCommit": "2f927f0fac150f822d5e9bd219db3284b99373ed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODIzNDYxMw==", "url": "https://github.com/apache/dolphinscheduler/pull/3582#discussion_r478234613", "bodyText": "Processinstanceservice has been used. Processinstanceservice should implement the interface. There are contributors who have submitted branches. I have not changed this.\n\n\u5df2\u4f7f\u7528processInstanceService \uff0cprocessInstanceService \u5e94\u8be5\u5b9e\u73b0\u63a5\u53e3\uff0c\u5df2\u7ecf\u6709\u8d21\u732e\u8005\u63d0\u4ea4\u5206\u652f\uff0c\u8fd9\u5757\u6211\u6ca1\u6709\u6539.", "author": "zhuangchong", "createdAt": "2020-08-27T08:07:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyMTE4NQ=="}], "type": "inlineReview"}, {"oid": "2d73b9ab248dcc53f230225b39f6a6961f4c0f50", "url": "https://github.com/apache/dolphinscheduler/commit/2d73b9ab248dcc53f230225b39f6a6961f4c0f50", "message": "processinstancemapper replaces processinstanceservice.", "committedDate": "2020-08-27T07:20:51Z", "type": "commit"}, {"oid": "772c7f2eec59a8c25286703e3f3da5d33f096f81", "url": "https://github.com/apache/dolphinscheduler/commit/772c7f2eec59a8c25286703e3f3da5d33f096f81", "message": "processinstancemapper replaces processinstanceservice.", "committedDate": "2020-08-27T07:48:04Z", "type": "commit"}]}