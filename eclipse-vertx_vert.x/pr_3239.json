{"pr_number": 3239, "pr_title": "Added default value for query parameters.", "pr_author": "hradecek", "pr_createdAt": "2020-01-01T13:08:09Z", "pr_url": "https://github.com/eclipse-vertx/vert.x/pull/3239", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNjMwNw==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3239#discussion_r363636307", "body": "\"Return the first param value with the specified name or `@code{defaultValue}` when the query param is not present.\"", "bodyText": "\"Return the first param value with the specified name or @code{defaultValue} when the query param is not present.\"", "bodyHTML": "<p dir=\"auto\">\"Return the first param value with the specified name or <code>@code{defaultValue}</code> when the query param is not present.\"</p>", "author": "vietj", "createdAt": "2020-01-07T08:27:04Z", "path": "src/main/java/io/vertx/core/http/HttpServerRequest.java", "diffHunk": "@@ -170,6 +169,18 @@ default String getParam(String paramName) {\n     return params().get(paramName);\n   }\n \n+  /**\n+   * Return the first param value or defaultValue if the query param is not provided.", "originalCommit": "0def904ddcffbcd813602956ecf8583d81c3ce5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEwNDI5NA==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3239#discussion_r364104294", "bodyText": "Done.", "author": "hradecek", "createdAt": "2020-01-08T08:08:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNjMwNw=="}], "type": "inlineReview", "revised_code": {"commit": "70d9d24e20b84ab7b6b272ff8facb72f1753d5b0", "changed_code": [{"header": "diff --git a/src/main/java/io/vertx/core/http/HttpServerRequest.java b/src/main/java/io/vertx/core/http/HttpServerRequest.java\nindex 24f8b0ed1..ddac76b9d 100644\n--- a/src/main/java/io/vertx/core/http/HttpServerRequest.java\n+++ b/src/main/java/io/vertx/core/http/HttpServerRequest.java\n", "chunk": "@@ -170,15 +170,16 @@ public interface HttpServerRequest extends ReadStream<Buffer> {\n   }\n \n   /**\n-   * Return the first param value or defaultValue if the query param is not provided.\n+   * Return the first param value with the specified name or {@code defaultValue} when the query param is not present\n    *\n    * @param paramName    the param name\n    * @param defaultValue the default value, must be non-null\n-   * @return the param value or default value\n+   * @return the param value or {@code defaultValue} when not present\n    */\n   default String getParam(String paramName, String defaultValue) {\n     Objects.requireNonNull(defaultValue, \"defaultValue\");\n-    return params().contains(paramName) ? params().get(paramName) : defaultValue;\n+    final String paramValue = params().get(paramName);\n+    return paramValue != null ? paramValue : defaultValue;\n   }\n \n   /**\n", "next_change": {"commit": "10a2b6c4cf6acffa5990f1c78fcbb40c2dc324af", "changed_code": [{"header": "diff --git a/src/main/java/io/vertx/core/http/HttpServerRequest.java b/src/main/java/io/vertx/core/http/HttpServerRequest.java\nindex ddac76b9d..503d476cb 100644\n--- a/src/main/java/io/vertx/core/http/HttpServerRequest.java\n+++ b/src/main/java/io/vertx/core/http/HttpServerRequest.java\n", "chunk": "@@ -183,7 +178,8 @@ public interface HttpServerRequest extends ReadStream<Buffer> {\n   }\n \n   /**\n-   * @return the remote (client side) address of the request\n+   * @return the remote address for this connection, possibly {@code null} (e.g a server bound on a domain socket).\n+   * If {@code useProxyProtocol} is set to {@code true}, the address returned will be of the actual connecting client.\n    */\n   @CacheReturn\n   default SocketAddress remoteAddress() {\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNjUzMw==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3239#discussion_r363636533", "body": "\"the param value or `@code{defaultValue}` when not present\"", "bodyText": "\"the param value or @code{defaultValue} when not present\"", "bodyHTML": "<p dir=\"auto\">\"the param value or <code>@code{defaultValue}</code> when not present\"</p>", "author": "vietj", "createdAt": "2020-01-07T08:27:41Z", "path": "src/main/java/io/vertx/core/http/HttpServerRequest.java", "diffHunk": "@@ -170,6 +169,18 @@ default String getParam(String paramName) {\n     return params().get(paramName);\n   }\n \n+  /**\n+   * Return the first param value or defaultValue if the query param is not provided.\n+   *\n+   * @param paramName    the param name\n+   * @param defaultValue the default value, must be non-null\n+   * @return the param value or default value", "originalCommit": "0def904ddcffbcd813602956ecf8583d81c3ce5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEwNDMyNQ==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3239#discussion_r364104325", "bodyText": "Done.", "author": "hradecek", "createdAt": "2020-01-08T08:08:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYzNjUzMw=="}], "type": "inlineReview", "revised_code": {"commit": "70d9d24e20b84ab7b6b272ff8facb72f1753d5b0", "changed_code": [{"header": "diff --git a/src/main/java/io/vertx/core/http/HttpServerRequest.java b/src/main/java/io/vertx/core/http/HttpServerRequest.java\nindex 24f8b0ed1..ddac76b9d 100644\n--- a/src/main/java/io/vertx/core/http/HttpServerRequest.java\n+++ b/src/main/java/io/vertx/core/http/HttpServerRequest.java\n", "chunk": "@@ -170,15 +170,16 @@ public interface HttpServerRequest extends ReadStream<Buffer> {\n   }\n \n   /**\n-   * Return the first param value or defaultValue if the query param is not provided.\n+   * Return the first param value with the specified name or {@code defaultValue} when the query param is not present\n    *\n    * @param paramName    the param name\n    * @param defaultValue the default value, must be non-null\n-   * @return the param value or default value\n+   * @return the param value or {@code defaultValue} when not present\n    */\n   default String getParam(String paramName, String defaultValue) {\n     Objects.requireNonNull(defaultValue, \"defaultValue\");\n-    return params().contains(paramName) ? params().get(paramName) : defaultValue;\n+    final String paramValue = params().get(paramName);\n+    return paramValue != null ? paramValue : defaultValue;\n   }\n \n   /**\n", "next_change": {"commit": "10a2b6c4cf6acffa5990f1c78fcbb40c2dc324af", "changed_code": [{"header": "diff --git a/src/main/java/io/vertx/core/http/HttpServerRequest.java b/src/main/java/io/vertx/core/http/HttpServerRequest.java\nindex ddac76b9d..503d476cb 100644\n--- a/src/main/java/io/vertx/core/http/HttpServerRequest.java\n+++ b/src/main/java/io/vertx/core/http/HttpServerRequest.java\n", "chunk": "@@ -183,7 +178,8 @@ public interface HttpServerRequest extends ReadStream<Buffer> {\n   }\n \n   /**\n-   * @return the remote (client side) address of the request\n+   * @return the remote address for this connection, possibly {@code null} (e.g a server bound on a domain socket).\n+   * If {@code useProxyProtocol} is set to {@code true}, the address returned will be of the actual connecting client.\n    */\n   @CacheReturn\n   default SocketAddress remoteAddress() {\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk0MDc4MQ==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3239#discussion_r363940781", "body": "This method is a good idea! \ud83d\ude0e  I know I'm nitpicking, but may I suggest to skip the `contains()` call and just do a `get()` and if `nul\bl`, then return `defaultValue`?  This will skip at least one MultiMap call.", "bodyText": "This method is a good idea! \ud83d\ude0e  I know I'm nitpicking, but may I suggest to skip the contains() call and just do a get() and if nul\ufffdl, then return defaultValue?  This will skip at least one MultiMap call.", "bodyHTML": "<p dir=\"auto\">This method is a good idea! <g-emoji class=\"g-emoji\" alias=\"sunglasses\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png\">\ud83d\ude0e</g-emoji>  I know I'm nitpicking, but may I suggest to skip the <code>contains()</code> call and just do a <code>get()</code> and if <code>nul\ufffdl</code>, then return <code>defaultValue</code>?  This will skip at least one MultiMap call.</p>", "author": "petarov", "createdAt": "2020-01-07T20:40:28Z", "path": "src/main/java/io/vertx/core/http/HttpServerRequest.java", "diffHunk": "@@ -170,6 +169,18 @@ default String getParam(String paramName) {\n     return params().get(paramName);\n   }\n \n+  /**\n+   * Return the first param value or defaultValue if the query param is not provided.\n+   *\n+   * @param paramName    the param name\n+   * @param defaultValue the default value, must be non-null\n+   * @return the param value or default value\n+   */\n+  default String getParam(String paramName, String defaultValue) {\n+    Objects.requireNonNull(defaultValue, \"defaultValue\");\n+    return params().contains(paramName) ? params().get(paramName) : defaultValue;", "originalCommit": "0def904ddcffbcd813602956ecf8583d81c3ce5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEwNDU3Mw==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3239#discussion_r364104573", "bodyText": "I know I'm nitpicking\n\nNoo, I was actually thinking about this way of implementation too, but I found contains() then get() more general and interface-friendlier.\nBut you're right as definition of MultiMap#get() is: Something or null if there is no such entry.\nRe-implemented as you have suggested, thanks.", "author": "hradecek", "createdAt": "2020-01-08T08:09:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzk0MDc4MQ=="}], "type": "inlineReview", "revised_code": {"commit": "70d9d24e20b84ab7b6b272ff8facb72f1753d5b0", "changed_code": [{"header": "diff --git a/src/main/java/io/vertx/core/http/HttpServerRequest.java b/src/main/java/io/vertx/core/http/HttpServerRequest.java\nindex 24f8b0ed1..ddac76b9d 100644\n--- a/src/main/java/io/vertx/core/http/HttpServerRequest.java\n+++ b/src/main/java/io/vertx/core/http/HttpServerRequest.java\n", "chunk": "@@ -170,15 +170,16 @@ public interface HttpServerRequest extends ReadStream<Buffer> {\n   }\n \n   /**\n-   * Return the first param value or defaultValue if the query param is not provided.\n+   * Return the first param value with the specified name or {@code defaultValue} when the query param is not present\n    *\n    * @param paramName    the param name\n    * @param defaultValue the default value, must be non-null\n-   * @return the param value or default value\n+   * @return the param value or {@code defaultValue} when not present\n    */\n   default String getParam(String paramName, String defaultValue) {\n     Objects.requireNonNull(defaultValue, \"defaultValue\");\n-    return params().contains(paramName) ? params().get(paramName) : defaultValue;\n+    final String paramValue = params().get(paramName);\n+    return paramValue != null ? paramValue : defaultValue;\n   }\n \n   /**\n", "next_change": {"commit": "10a2b6c4cf6acffa5990f1c78fcbb40c2dc324af", "changed_code": [{"header": "diff --git a/src/main/java/io/vertx/core/http/HttpServerRequest.java b/src/main/java/io/vertx/core/http/HttpServerRequest.java\nindex ddac76b9d..503d476cb 100644\n--- a/src/main/java/io/vertx/core/http/HttpServerRequest.java\n+++ b/src/main/java/io/vertx/core/http/HttpServerRequest.java\n", "chunk": "@@ -183,7 +178,8 @@ public interface HttpServerRequest extends ReadStream<Buffer> {\n   }\n \n   /**\n-   * @return the remote (client side) address of the request\n+   * @return the remote address for this connection, possibly {@code null} (e.g a server bound on a domain socket).\n+   * If {@code useProxyProtocol} is set to {@code true}, the address returned will be of the actual connecting client.\n    */\n   @CacheReturn\n   default SocketAddress remoteAddress() {\n", "next_change": null}]}}]}}, {"oid": "70d9d24e20b84ab7b6b272ff8facb72f1753d5b0", "url": "https://github.com/eclipse-vertx/vert.x/commit/70d9d24e20b84ab7b6b272ff8facb72f1753d5b0", "message": "Added default value for query parameters.\n\nSigned-off-by: Ivo Hr\u00e1dek <ivohradek@gmail.com>", "committedDate": "2020-01-08T08:05:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIyMTIwMg==", "url": "https://github.com/eclipse-vertx/vert.x/pull/3239#discussion_r364221202", "body": "please start server like in other tests (using testAddress) so the test can run with other config such as native transport.", "bodyText": "please start server like in other tests (using testAddress) so the test can run with other config such as native transport.", "bodyHTML": "<p dir=\"auto\">please start server like in other tests (using testAddress) so the test can run with other config such as native transport.</p>", "author": "vietj", "createdAt": "2020-01-08T13:08:09Z", "path": "src/test/java/io/vertx/core/http/HttpTest.java", "diffHunk": "@@ -782,6 +782,29 @@ public void testNoParams() {\n     await();\n   }\n \n+  @Test\n+  public void testGetParamDefaultValue() {\n+    String paramName1 = \"foo\";\n+    String paramName1Value = \"bar\";\n+    String paramName2 = \"notPresentParam\";\n+    String defaultValue = \"defaultValue\";\n+    String reqUri = String.format(\"%s/?%s=%s\", DEFAULT_TEST_URI, paramName1, paramName1Value);\n+\n+    server.requestHandler(req -> {\n+      assertTrue(req.params().contains(paramName1));\n+      assertEquals(paramName1Value, req.getParam(paramName1, defaultValue));\n+      assertFalse(req.params().contains(paramName2));\n+      assertEquals(defaultValue, req.getParam(paramName2, defaultValue));\n+      req.response().end();\n+    });\n+\n+    server.listen(onSuccess(server -> {", "originalCommit": "70d9d24e20b84ab7b6b272ff8facb72f1753d5b0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "10a2b6c4cf6acffa5990f1c78fcbb40c2dc324af", "changed_code": [{"header": "diff --git a/src/test/java/io/vertx/core/http/HttpTest.java b/src/test/java/io/vertx/core/http/HttpTest.java\nindex 0bdd02739..8a1165cf2 100644\n--- a/src/test/java/io/vertx/core/http/HttpTest.java\n+++ b/src/test/java/io/vertx/core/http/HttpTest.java\n", "chunk": "@@ -787,24 +861,62 @@ public abstract class HttpTest extends HttpTestBase {\n     String paramName1 = \"foo\";\n     String paramName1Value = \"bar\";\n     String paramName2 = \"notPresentParam\";\n-    String defaultValue = \"defaultValue\";\n-    String reqUri = String.format(\"%s/?%s=%s\", DEFAULT_TEST_URI, paramName1, paramName1Value);\n+    String paramName2DefaultValue = \"defaultValue\";\n+    String reqUri = DEFAULT_TEST_URI + \"/?\" + paramName1 + \"=\" + paramName1Value;\n \n     server.requestHandler(req -> {\n       assertTrue(req.params().contains(paramName1));\n-      assertEquals(paramName1Value, req.getParam(paramName1, defaultValue));\n+      assertEquals(paramName1Value, req.getParam(paramName1, paramName2DefaultValue));\n       assertFalse(req.params().contains(paramName2));\n-      assertEquals(defaultValue, req.getParam(paramName2, defaultValue));\n+      assertEquals(paramName2DefaultValue, req.getParam(paramName2, paramName2DefaultValue));\n       req.response().end();\n     });\n \n-    server.listen(onSuccess(server -> {\n-      client.request(HttpMethod.GET, DEFAULT_HTTP_PORT, DEFAULT_HTTP_HOST, reqUri, resp -> testComplete()).end();\n+    server.listen(testAddress, onSuccess(server -> {\n+      client.request(new RequestOptions(requestOptions).setURI(reqUri))\n+        .onComplete(onSuccess(req -> {\n+          req.send(onSuccess(resp -> testComplete()));\n+        }));\n     }));\n \n     await();\n   }\n \n+  @Test\n+  public void testMissingContentTypeMultipartRequest() throws Exception {\n+    testInvalidMultipartRequest(null, HttpMethod.POST);\n+  }\n+\n+  @Test\n+  public void testInvalidContentTypeMultipartRequest() throws Exception {\n+    testInvalidMultipartRequest(\"application/json\", HttpMethod.POST);\n+  }\n+\n+  @Test\n+  public void testInvalidMethodMultipartRequest() throws Exception {\n+    testInvalidMultipartRequest(\"multipart/form-data\", HttpMethod.GET);\n+  }\n+\n+  private void testInvalidMultipartRequest(String contentType, HttpMethod method) throws Exception {\n+    server.requestHandler(req -> {\n+      try {\n+        req.setExpectMultipart(true);\n+        fail();\n+      } catch (IllegalStateException ignore) {\n+        req.response().end();\n+      }\n+    });\n+    startServer(testAddress);\n+    RequestOptions requestOptions = new RequestOptions(this.requestOptions).setMethod(method);\n+    client.request(requestOptions, onSuccess(req -> {\n+      if (contentType != null) {\n+        req.putHeader(HttpHeaders.CONTENT_TYPE, contentType);\n+      }\n+      req.send(onSuccess(resp -> testComplete()));\n+    }));\n+    await();\n+  }\n+\n   @Test\n   public void testDefaultRequestHeaders() {\n     server.requestHandler(req -> {\n", "next_change": null}]}}, {"oid": "10a2b6c4cf6acffa5990f1c78fcbb40c2dc324af", "url": "https://github.com/eclipse-vertx/vert.x/commit/10a2b6c4cf6acffa5990f1c78fcbb40c2dc324af", "message": "Added default value for query parameters.\n\nSigned-off-by: Ivo Hradek <ivohradek@gmail.com>", "committedDate": "2020-11-19T13:47:53Z", "type": "forcePushed"}, {"oid": "e0db7922631d000ea61ee9b2409198be193e3fd4", "url": "https://github.com/eclipse-vertx/vert.x/commit/e0db7922631d000ea61ee9b2409198be193e3fd4", "message": "Added default value for query parameters.\n\nSigned-off-by: Ivo Hradek <ivohradek@gmail.com>", "committedDate": "2021-07-02T06:30:22Z", "type": "commit"}, {"oid": "e0db7922631d000ea61ee9b2409198be193e3fd4", "url": "https://github.com/eclipse-vertx/vert.x/commit/e0db7922631d000ea61ee9b2409198be193e3fd4", "message": "Added default value for query parameters.\n\nSigned-off-by: Ivo Hradek <ivohradek@gmail.com>", "committedDate": "2021-07-02T06:30:22Z", "type": "forcePushed"}]}