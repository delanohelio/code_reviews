{"pr_number": 2339, "pr_title": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension", "pr_author": "fjtirado", "pr_createdAt": "2020-12-10T09:54:15Z", "pr_url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339", "timeline": [{"oid": "f6cc81aeb6358f8109386ab59cede93cf76ba9c4", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/f6cc81aeb6358f8109386ab59cede93cf76ba9c4", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed", "committedDate": "2020-12-10T09:56:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAzMTUxMw==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540031513", "body": "just set this as debug. We don't really care about this.", "bodyText": "just set this as debug. We don't really care about this.", "bodyHTML": "<p dir=\"auto\">just set this as debug. We don't really care about this.</p>", "author": "elguardian", "createdAt": "2020-12-10T09:59:08Z", "path": "kie-server-parent/kie-server-services/kie-server-services-kafka/src/main/java/org/kie/server/services/jbpm/kafka/KafkaServerExtension.java", "diffHunk": "@@ -248,8 +248,13 @@ public void onDeploy(DeploymentEvent event) {\n \n     @Override\n     public void onUnDeploy(DeploymentEvent event) {\n-        event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n-                .removeEventListener(this);\n+        try {\n+            event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n+                    .removeEventListener(this);\n+        } catch (Exception ex) {\n+            // it is very likely that Runtime Manager is already closed at this stage\n+            logger.info(\"ProcessEventListener cannot be removed. {}\", ex.getMessage());", "originalCommit": "f6cc81aeb6358f8109386ab59cede93cf76ba9c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "342d62d6ca439c1f0c0cf828d7ef5ed4cb0cc747", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/342d62d6ca439c1f0c0cf828d7ef5ed4cb0cc747", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed", "committedDate": "2020-12-10T10:00:45Z", "type": "forcePushed"}, {"oid": "c72f4f0b18e07f86a2751423d8be0e4b492859db", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/c72f4f0b18e07f86a2751423d8be0e4b492859db", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed", "committedDate": "2020-12-10T11:59:16Z", "type": "forcePushed"}, {"oid": "a4387dddb0986c1078ec751898900f63fa092528", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/a4387dddb0986c1078ec751898900f63fa092528", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed", "committedDate": "2020-12-10T12:07:45Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg0NjM2Mg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540846362", "body": "Just curious - if we are now not removing the listeners, shouldn't we try to avoid adding listener twice in case of a new [`onDeploy` event](https://github.com/kiegroup/droolsjbpm-integration/blob/a4387dddb0986c1078ec751898900f63fa092528/kie-server-parent/kie-server-services/kie-server-services-kafka/src/main/java/org/kie/server/services/jbpm/kafka/KafkaServerExtension.java#L245-L246)?", "bodyText": "Just curious - if we are now not removing the listeners, shouldn't we try to avoid adding listener twice in case of a new onDeploy event?", "bodyHTML": "<p dir=\"auto\">Just curious - if we are now not removing the listeners, shouldn't we try to avoid adding listener twice in case of a new <a href=\"https://github.com/kiegroup/droolsjbpm-integration/blob/a4387dddb0986c1078ec751898900f63fa092528/kie-server-parent/kie-server-services/kie-server-services-kafka/src/main/java/org/kie/server/services/jbpm/kafka/KafkaServerExtension.java#L245-L246\"><code>onDeploy</code> event</a>?</p>", "author": "afalhambra", "createdAt": "2020-12-11T10:28:41Z", "path": "kie-server-parent/kie-server-services/kie-server-services-kafka/src/main/java/org/kie/server/services/jbpm/kafka/KafkaServerExtension.java", "diffHunk": "@@ -241,15 +242,13 @@ public void destroy(KieServerImpl kieServer, KieServerRegistry registry) {\n \n     @Override\n     public void onDeploy(DeploymentEvent event) {\n-        event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n-                .addEventListener(this);\n+        ((InternalRegisterableItemsFactory) ((InternalRuntimeManager) event.getDeployedUnit().getRuntimeManager())\n+                .getEnvironment().getRegisterableItemsFactory()).addProcessListener(this);\n         updateRegistration(event, this::updateTopics);\n     }\n \n     @Override\n     public void onUnDeploy(DeploymentEvent event) {\n-        event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n-                .removeEventListener(this);", "originalCommit": "a4387dddb0986c1078ec751898900f63fa092528", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk3NTU1OA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540975558", "bodyText": "When Kjar is undeployed, the list of listeners is clear up. So when ondeploy is invoked againd, the list will be empty\nActually if we try to remove the listener on undeploy, we will get an exception because the deployment is already closed", "author": "fjtirado", "createdAt": "2020-12-11T14:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg0NjM2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk3ODg1OA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540978858", "bodyText": "I see - thanks", "author": "afalhambra", "createdAt": "2020-12-11T14:18:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg0NjM2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg1MjA3Mg==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540852072", "body": "you can just use only `forEach`, but no need to change anything here\r\n```suggestion\r\n        itemsFactory.getProcessEventListeners(runtimeEngine).forEach(l -> l.onMessage(new MessageEventImpl(\r\n```", "bodyText": "you can just use only forEach, but no need to change anything here\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    itemsFactory.getProcessEventListeners(runtimeEngine).stream().forEach(l -> l.onMessage(new MessageEventImpl(\n          \n          \n            \n                    itemsFactory.getProcessEventListeners(runtimeEngine).forEach(l -> l.onMessage(new MessageEventImpl(", "bodyHTML": "<p dir=\"auto\">you can just use only <code>forEach</code>, but no need to change anything here</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        itemsFactory<span class=\"pl-k\">.</span>getProcessEventListeners(runtimeEngine)<span class=\"pl-k\">.</span><span class=\"x x-first\">stream()</span><span class=\"pl-k x x-last\">.</span>forEach(l <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> l<span class=\"pl-k\">.</span>onMessage(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">MessageEventImpl</span>(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        itemsFactory<span class=\"pl-k\">.</span>getProcessEventListeners(runtimeEngine)<span class=\"pl-k\">.</span>forEach(l <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> l<span class=\"pl-k\">.</span>onMessage(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">MessageEventImpl</span>(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "afalhambra", "createdAt": "2020-12-11T10:37:58Z", "path": "kie-server-parent/kie-server-services/kie-server-services-kafka/src/test/java/org/kie/server/services/jbpm/kafka/KafkaServerExtensionProducerTest.java", "diffHunk": "@@ -129,7 +131,9 @@ public void close() {\n     @Test \n     public void testMessageSent() throws IOException, ParseException {\n         extension.onDeploy(new DeploymentEvent(\"MyDeploy1\", deployedUnit));\n-        extension.onMessage(new MessageEventImpl(pInstance, runtime, nInstance, \"MyMessage\", \"Javierito\"));\n+        itemsFactory.getProcessEventListeners(runtimeEngine).stream().forEach(l -> l.onMessage(new MessageEventImpl(", "originalCommit": "a4387dddb0986c1078ec751898900f63fa092528", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk3NjAyOA==", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540976028", "bodyText": "I took note for the next one, but I prefer to avoid a push just for that", "author": "fjtirado", "createdAt": "2020-12-11T14:14:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg1MjA3Mg=="}], "type": "inlineReview"}, {"oid": "cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed", "committedDate": "2020-12-11T14:19:43Z", "type": "commit"}, {"oid": "cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed", "committedDate": "2020-12-11T14:19:43Z", "type": "forcePushed"}]}