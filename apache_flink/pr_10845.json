{"pr_number": 10845, "pr_title": "[FLINK-15355][plugins]Classloader restricts access to parent to whitelist.", "pr_author": "AHeise", "pr_createdAt": "2020-01-13T15:43:03Z", "pr_url": "https://github.com/apache/flink/pull/10845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3NjQxNA==", "url": "https://github.com/apache/flink/pull/10845#discussion_r367276414", "body": "revert?", "bodyText": "revert?", "bodyHTML": "<p dir=\"auto\">revert?</p>", "author": "pnowojski", "createdAt": "2020-01-16T08:02:41Z", "path": "flink-core/src/main/java/org/apache/flink/configuration/CoreOptions.java", "diffHunk": "@@ -121,7 +121,7 @@\n \tpublic static final ConfigOption<String> PLUGIN_ALWAYS_PARENT_FIRST_LOADER_PATTERNS = ConfigOptions\n \t\t.key(\"plugin.classloader.parent-first-patterns.default\")\n \t\t.stringType()\n-\t\t.defaultValue(\"java.;scala.;org.apache.flink.;javax.annotation.;org.slf4j;org.apache.log4j;org.apache\" +\n+\t\t.defaultValue(\"java.;javax.;scala.;org.apache.flink.;org.slf4j;org.apache.log4j;org.apache\" +", "originalCommit": "c1bd37255a1fbdffba63def90f85f9c1a0557d32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3OTUxOQ==", "url": "https://github.com/apache/flink/pull/10845#discussion_r367279519", "body": "```\r\nreturn super.getResource(name);\r\n```\r\n?", "bodyText": "return super.getResource(name);\n\n?", "bodyHTML": "<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"return super.getResource(name);\n\"><pre><code>return super.getResource(name);\n</code></pre></div>\n<p dir=\"auto\">?</p>", "author": "pnowojski", "createdAt": "2020-01-16T08:12:06Z", "path": "flink-core/src/main/java/org/apache/flink/core/plugin/PluginLoader.java", "diffHunk": "@@ -100,4 +105,97 @@ public P next() {\n \t\t}\n \t}\n \n+\t/**\n+\t * Loads all classes from the plugin jar except for explicitly white-listed packages (org.apache.flink, logging).\n+\t *\n+\t * <p>No class/resource in the system class loader (everything in lib/) can be seen in the plugin except those\n+\t * starting with a whitelist prefix.\n+\t */\n+\tprivate static final class PluginClassLoader extends URLClassLoader {\n+\t\tprivate final ClassLoader flinkClassLoader;\n+\n+\t\tprivate final String[] allowedFlinkPackages;\n+\n+\t\tprivate final String[] allowedResourcePrefixes;\n+\n+\t\tPluginClassLoader(URL[] pluginResourceURLs, ClassLoader flinkClassLoader, String[] allowedFlinkPackages) {\n+\t\t\tsuper(pluginResourceURLs, null);\n+\t\t\tthis.flinkClassLoader = flinkClassLoader;\n+\t\t\tthis.allowedFlinkPackages = allowedFlinkPackages;\n+\t\t\tallowedResourcePrefixes = Arrays.stream(allowedFlinkPackages)\n+\t\t\t\t.map(packageName -> packageName.replace('.', '/'))\n+\t\t\t\t.toArray(String[]::new);\n+\t\t}\n+\n+\t\t@Override\n+\t\tprotected Class<?> loadClass(final String name, final boolean resolve) throws ClassNotFoundException {\n+\t\t\tsynchronized (getClassLoadingLock(name)) {\n+\t\t\t\tfinal Class<?> loadedClass = findLoadedClass(name);\n+\t\t\t\tif (loadedClass != null) {\n+\t\t\t\t\treturn resolveIfNeeded(resolve, loadedClass);\n+\t\t\t\t}\n+\n+\t\t\t\tif (isAllowedFlinkClass(name)) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\treturn resolveIfNeeded(resolve, flinkClassLoader.loadClass(name));\n+\t\t\t\t\t} catch (ClassNotFoundException e) {\n+\t\t\t\t\t\t// fallback to resolving it in this classloader\n+\t\t\t\t\t\t// for cases where the plugin uses org.apache.flink namespace\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\n+\t\t\t\treturn super.loadClass(name, resolve);\n+\t\t\t}\n+\t\t}\n+\n+\t\tprivate Class<?> resolveIfNeeded(final boolean resolve, final Class<?> loadedClass) {\n+\t\t\tif (resolve) {\n+\t\t\t\tresolveClass(loadedClass);\n+\t\t\t}\n+\t\t\treturn loadedClass;\n+\t\t}\n+\n+\t\t@Override\n+\t\tpublic URL getResource(final String name) {\n+\t\t\tif (isAllowedFlinkResource(name)) {\n+\t\t\t\treturn flinkClassLoader.getResource(name);\n+\t\t\t}\n+\n+\t\t\tURL urlClassLoaderResource = findResource(name);\n+\n+\t\t\tif (urlClassLoaderResource != null) {\n+\t\t\t\treturn urlClassLoaderResource;\n+\t\t\t}\n+\n+\t\t\treturn null;", "originalCommit": "c1bd37255a1fbdffba63def90f85f9c1a0557d32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI3OTkxNQ==", "url": "https://github.com/apache/flink/pull/10845#discussion_r367279915", "body": "Why have all the tests changed in this commit?", "bodyText": "Why have all the tests changed in this commit?", "bodyHTML": "<p dir=\"auto\">Why have all the tests changed in this commit?</p>", "author": "pnowojski", "createdAt": "2020-01-16T08:13:13Z", "path": "flink-tests/src/test/java/org/apache/flink/test/plugin/PluginLoaderTest.java", "diffHunk": "@@ -21,6 +21,7 @@\n import org.apache.flink.core.plugin.PluginDescriptor;\n import org.apache.flink.core.plugin.PluginLoader;\n import org.apache.flink.test.plugin.jar.plugina.TestServiceA;\n+import org.apache.flink.test.plugin.spi.TestSpi;", "originalCommit": "c1bd37255a1fbdffba63def90f85f9c1a0557d32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e725912b1cf6f948c5aa4d3b8c3c647deada9387", "url": "https://github.com/apache/flink/commit/e725912b1cf6f948c5aa4d3b8c3c647deada9387", "message": " [FLINK-15355][plugins]Classloader restricted to whitelisted system classes.\n\nNo class/resource in the system class loader (everything in lib/) can be seen in the plugin except those starting with a whitelist prefix.", "committedDate": "2020-01-16T09:56:28Z", "type": "commit"}, {"oid": "8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "url": "https://github.com/apache/flink/commit/8cfc8526790aeb1adf7bcb8ca39b4bd33dd6098b", "message": "[hotfix][plugins]Hide classloader pattern options from documentation.", "committedDate": "2020-01-16T10:06:28Z", "type": "commit"}]}