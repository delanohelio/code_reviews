{"pr_number": 11876, "pr_title": "[FLINK-17334] HIVE UDF BUGFIX", "pr_author": "z8r-coder", "pr_createdAt": "2020-04-23T08:07:29Z", "pr_url": "https://github.com/apache/flink/pull/11876", "timeline": [{"oid": "5b6f56044990bb180e8df45514e793868d84b43f", "url": "https://github.com/apache/flink/commit/5b6f56044990bb180e8df45514e793868d84b43f", "message": "[FLINK-17334] HIVE UDF BUGFIX", "committedDate": "2020-04-23T06:55:38Z", "type": "commit"}, {"oid": "ec30671bf09b056ef47b4b89001bd8118ab23513", "url": "https://github.com/apache/flink/commit/ec30671bf09b056ef47b4b89001bd8118ab23513", "message": "TEST CASES", "committedDate": "2020-04-23T09:54:14Z", "type": "commit"}, {"oid": "5dc081058c881b0165b44c37e53607ac891814f5", "url": "https://github.com/apache/flink/commit/5dc081058c881b0165b44c37e53607ac891814f5", "message": "SimpleUDF support array and map, add test cases", "committedDate": "2020-04-24T06:49:14Z", "type": "commit"}, {"oid": "2a7b13805feb162cf26a374609d6e03af6a58990", "url": "https://github.com/apache/flink/commit/2a7b13805feb162cf26a374609d6e03af6a58990", "message": "delete unuse file", "committedDate": "2020-04-27T03:33:25Z", "type": "commit"}, {"oid": "e1386aff448073520feb8effc3eac67a4f4577cb", "url": "https://github.com/apache/flink/commit/e1386aff448073520feb8effc3eac67a4f4577cb", "message": "code style", "committedDate": "2020-04-27T07:21:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNzUxMw==", "url": "https://github.com/apache/flink/pull/11876#discussion_r415737513", "body": "Why do we still need these changes? Actually I think this method is no longer needed", "bodyText": "Why do we still need these changes? Actually I think this method is no longer needed", "bodyHTML": "<p dir=\"auto\">Why do we still need these changes? Actually I think this method is no longer needed</p>", "author": "lirui-apache", "createdAt": "2020-04-27T11:36:46Z", "path": "flink-connectors/flink-connector-hive/src/main/java/org/apache/flink/table/functions/hive/conversion/HiveInspectors.java", "diffHunk": "@@ -354,25 +354,25 @@ public static ObjectInspector getObjectInspector(HiveShim hiveShim, Class clazz)\n \t\tif (clazz.equals(String.class) || clazz.equals(Text.class)) {\n \n \t\t\ttypeInfo = TypeInfoFactory.stringTypeInfo;\n-\t\t} else if (clazz.equals(Boolean.class) || clazz.equals(BooleanWritable.class)) {\n+\t\t} else if (clazz.equals(boolean.class) || clazz.equals(Boolean.class) || clazz.equals(BooleanWritable.class)) {", "originalCommit": "e1386aff448073520feb8effc3eac67a4f4577cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI3NjE0Mw==", "url": "https://github.com/apache/flink/pull/11876#discussion_r416276143", "bodyText": "Ok, I will remove the method.", "author": "z8r-coder", "createdAt": "2020-04-28T02:14:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTczNzUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MjM5NA==", "url": "https://github.com/apache/flink/pull/11876#discussion_r415742394", "body": "Why we allow a 1.0 delta here? And I think `3.0f` should be the expected value and `udf.eval(3.0f)` should be the actual value.", "bodyText": "Why we allow a 1.0 delta here? And I think 3.0f should be the expected value and udf.eval(3.0f) should be the actual value.", "bodyHTML": "<p dir=\"auto\">Why we allow a 1.0 delta here? And I think <code>3.0f</code> should be the expected value and <code>udf.eval(3.0f)</code> should be the actual value.</p>", "author": "lirui-apache", "createdAt": "2020-04-27T11:45:08Z", "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/table/functions/hive/HiveSimpleUDFTest.java", "diffHunk": "@@ -49,6 +50,30 @@\n public class HiveSimpleUDFTest {\n \tprivate static HiveShim hiveShim = HiveShimLoader.loadHiveShim(HiveShimLoader.getHiveVersion());\n \n+\t@Test\n+\tpublic void testBooleanUDF() {\n+\t\tHiveSimpleUDF udf = init(BooleanUDF.class, new DataType[]{ DataTypes.INT()});\n+\t\tassertTrue((boolean) udf.eval(1));\n+\t}\n+\n+\t@Test\n+\tpublic void testFloatUDF() {\n+\t\tHiveSimpleUDF udf = init(FloatUDF.class, new DataType[]{ DataTypes.FLOAT()});\n+\t\tassertEquals((float) udf.eval(3.0f), 3.0f, 1.0);", "originalCommit": "e1386aff448073520feb8effc3eac67a4f4577cb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI4MzIzMQ==", "url": "https://github.com/apache/flink/pull/11876#discussion_r416283231", "bodyText": "the function need a positive delta\nstatic public void assertEquals(float expected, float actual, float delta)\nasserts that two floats are equal to within a positive delta.\nI have set delta to 0", "author": "z8r-coder", "createdAt": "2020-04-28T02:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MjM5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MjkxNA==", "url": "https://github.com/apache/flink/pull/11876#discussion_r415742914", "body": "just return content == 1", "bodyText": "just return content == 1", "bodyHTML": "<p dir=\"auto\">just return content == 1</p>", "author": "lirui-apache", "createdAt": "2020-04-27T11:46:02Z", "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/table/functions/hive/HiveSimpleUDFTest.java", "diffHunk": "@@ -230,4 +255,64 @@ protected static HiveSimpleUDF init(Class hiveUdfClass, DataType[] argTypes) {\n \n \t\treturn udf;\n \t}\n+\n+\t/**\n+\t * Boolean Test UDF.\n+\t */\n+\tpublic static class BooleanUDF extends UDF {\n+\t\t/**\n+\t\t *\n+\t\t * @param content input\n+\t\t * @return\n+\t\t */\n+\t\tpublic boolean evaluate(int content) {\n+\t\t\tif (content == 1) {\n+\t\t\t\treturn true;\n+\t\t\t} else {\n+\t\t\t\treturn false;\n+\t\t\t}", "originalCommit": "e1386aff448073520feb8effc3eac67a4f4577cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc0MzQxMw==", "url": "https://github.com/apache/flink/pull/11876#discussion_r415743413", "body": "Please remove these java docs since they're meaningless.", "bodyText": "Please remove these java docs since they're meaningless.", "bodyHTML": "<p dir=\"auto\">Please remove these java docs since they're meaningless.</p>", "author": "lirui-apache", "createdAt": "2020-04-27T11:46:47Z", "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/table/functions/hive/HiveSimpleUDFTest.java", "diffHunk": "@@ -230,4 +255,64 @@ protected static HiveSimpleUDF init(Class hiveUdfClass, DataType[] argTypes) {\n \n \t\treturn udf;\n \t}\n+\n+\t/**\n+\t * Boolean Test UDF.\n+\t */\n+\tpublic static class BooleanUDF extends UDF {\n+\t\t/**\n+\t\t *\n+\t\t * @param content input\n+\t\t * @return\n+\t\t */\n+\t\tpublic boolean evaluate(int content) {\n+\t\t\tif (content == 1) {\n+\t\t\t\treturn true;\n+\t\t\t} else {\n+\t\t\t\treturn false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Float Test UDF.\n+\t */\n+\tpublic static class FloatUDF extends UDF {\n+\t\t/**\n+\t\t *\n+\t\t * @param content input\n+\t\t * @return\n+\t\t */", "originalCommit": "e1386aff448073520feb8effc3eac67a4f4577cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "46bde5253c0ce7b4c33ef7ab1868b843207a5dcb", "url": "https://github.com/apache/flink/commit/46bde5253c0ce7b4c33ef7ab1868b843207a5dcb", "message": "delete unuse code", "committedDate": "2020-04-28T04:27:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU0Mjg3MA==", "url": "https://github.com/apache/flink/pull/11876#discussion_r416542870", "body": "```suggestion\r\n\t\tassertEquals(3.0f, (float) udf.eval(3.0f), 0);\r\n```\r\nThe 1st argument is the expected value. Same goes for other tests.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tassertEquals((float) udf.eval(3.0f), 3.0f, 0);\n          \n          \n            \n            \t\tassertEquals(3.0f, (float) udf.eval(3.0f), 0);\n          \n      \n    \n    \n  \n\nThe 1st argument is the expected value. Same goes for other tests.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\tassertEquals((<span class=\"pl-k\">float</span>) udf<span class=\"pl-k\">.</span>eval(<span class=\"pl-c1\">3.0f</span>)<span class=\"x x-first\">, </span><span class=\"pl-c1 x x-last\">3.0f</span>, <span class=\"pl-c1\">0</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\tassertEquals(<span class=\"pl-c1 x x-first\">3.0f</span><span class=\"x x-last\">, </span>(<span class=\"pl-k\">float</span>) udf<span class=\"pl-k\">.</span>eval(<span class=\"pl-c1\">3.0f</span>), <span class=\"pl-c1\">0</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">The 1st argument is the expected value. Same goes for other tests.</p>", "author": "lirui-apache", "createdAt": "2020-04-28T11:37:32Z", "path": "flink-connectors/flink-connector-hive/src/test/java/org/apache/flink/table/functions/hive/HiveSimpleUDFTest.java", "diffHunk": "@@ -49,6 +50,30 @@\n public class HiveSimpleUDFTest {\n \tprivate static HiveShim hiveShim = HiveShimLoader.loadHiveShim(HiveShimLoader.getHiveVersion());\n \n+\t@Test\n+\tpublic void testBooleanUDF() {\n+\t\tHiveSimpleUDF udf = init(BooleanUDF.class, new DataType[]{ DataTypes.INT()});\n+\t\tassertTrue((boolean) udf.eval(1));\n+\t}\n+\n+\t@Test\n+\tpublic void testFloatUDF() {\n+\t\tHiveSimpleUDF udf = init(FloatUDF.class, new DataType[]{ DataTypes.FLOAT()});\n+\t\tassertEquals((float) udf.eval(3.0f), 3.0f, 0);", "originalCommit": "46bde5253c0ce7b4c33ef7ab1868b843207a5dcb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU0ODY2Mg==", "url": "https://github.com/apache/flink/pull/11876#discussion_r416548662", "bodyText": "ok", "author": "z8r-coder", "createdAt": "2020-04-28T11:48:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU0Mjg3MA=="}], "type": "inlineReview"}, {"oid": "373c591fb2c6773f2ff641bc4c32e72d5ae980af", "url": "https://github.com/apache/flink/commit/373c591fb2c6773f2ff641bc4c32e72d5ae980af", "message": "code style", "committedDate": "2020-04-28T12:45:00Z", "type": "commit"}]}