{"pr_number": 11868, "pr_title": " [FLINK-17258][tests] Enabling unaligned checkpoint in all tests by default", "pr_author": "AHeise", "pr_createdAt": "2020-04-22T19:20:02Z", "pr_url": "https://github.com/apache/flink/pull/11868", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442097622", "body": "Do we really need this method? Isn't `enableUnalignedCheckpoints(false);` enough? `enableUnalignedCheckpoints()` also is kind of redundant but probably more common.\r\n\r\nFor another `boolean` property we have just a single setter `setPreferCheckpointForRecovery`", "bodyText": "Do we really need this method? Isn't enableUnalignedCheckpoints(false); enough? enableUnalignedCheckpoints() also is kind of redundant but probably more common.\nFor another boolean property we have just a single setter setPreferCheckpointForRecovery", "bodyHTML": "<p dir=\"auto\">Do we really need this method? Isn't <code>enableUnalignedCheckpoints(false);</code> enough? <code>enableUnalignedCheckpoints()</code> also is kind of redundant but probably more common.</p>\n<p dir=\"auto\">For another <code>boolean</code> property we have just a single setter <code>setPreferCheckpointForRecovery</code></p>", "author": "pnowojski", "createdAt": "2020-06-18T09:34:26Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/environment/CheckpointConfig.java", "diffHunk": "@@ -414,9 +417,19 @@ public void enableUnalignedCheckpoints() {\n \t}\n \n \t/**\n-\t * Returns whether checkpoints should be persisted externally.\n+\t * Disables unaligned checkpoints.\n \t *\n-\t * @return <code>true</code> if checkpoints should be externalized.\n+\t * @see #enableUnalignedCheckpoints()\n+\t */\n+\t@PublicEvolving\n+\tpublic void disableUnalignedCheckpoints() {", "originalCommit": "2e55484af53240b19097d2536853b09c575f06d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2MDA0NQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442860045", "bodyText": "No we don't need it and I have no hard feelings for removing it.\ndisableUnalignedCheckpoints would be relevant when UC becomes the default (see also StreamExecutionEnvironment#disableOperatorChaining).", "author": "AHeise", "createdAt": "2020-06-19T14:04:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkzODgyOQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442938829", "bodyText": "would be relevant when UC becomes the default\n\nThat's a point, but maybe more in favour of dropping enableUnalignedCheckpoints ()? What about keeping and using just setUnalignedCheckpoints(boolean) (without the Enable infix)?", "author": "pnowojski", "createdAt": "2020-06-19T16:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3MzQ1NQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r443373455", "bodyText": "Yes, I'd probably go this way. Should we mend that also on 1.11?", "author": "AHeise", "createdAt": "2020-06-22T07:45:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MzEyNQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r443493125", "bodyText": "Extracted FLINK-18403, which will be backported (while this PR should only go to master).", "author": "AHeise", "createdAt": "2020-06-22T11:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5NzYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442097962", "body": "Isn't this an independent bug fix?", "bodyText": "Isn't this an independent bug fix?", "bodyHTML": "<p dir=\"auto\">Isn't this an independent bug fix?</p>", "author": "pnowojski", "createdAt": "2020-06-18T09:35:00Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -500,8 +500,9 @@ private void setVertexConfig(Integer vertexID, StreamConfig config,\n \n \t\tconfig.setStateBackend(streamGraph.getStateBackend());\n \t\tconfig.setCheckpointingEnabled(checkpointCfg.isCheckpointingEnabled());\n-\t\tconfig.setUnalignedCheckpointsEnabled(checkpointCfg.isUnalignedCheckpointsEnabled());\n \t\tconfig.setCheckpointMode(getCheckpointingMode(checkpointCfg));\n+\t\tconfig.setUnalignedCheckpointsEnabled(config.getCheckpointMode() == CheckpointingMode.EXACTLY_ONCE &&", "originalCommit": "2e55484af53240b19097d2536853b09c575f06d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2Mjk2MA==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442862960", "bodyText": "So far, we have assumed that the user only sets UC when checkpoint mode is exactly once. In this PR, we ignoring checkpoint mode and set it for all.\nThe question is where to address that:\n\nWe could fail on that combination. Then we would need to disable UC for every at least once test. Not my favorite.\nWe change checkpointing mode with a warning. Not my favorite.\nWe disable/ignore UC (current way) with a warning (needs to be added).\nWe could have a value UC if exactly once and make checkpointCfg.isUnalignedCheckpointsEnabled() more intelligent. Would also be plausible.", "author": "AHeise", "createdAt": "2020-06-19T14:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0MzAxNQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442943015", "bodyText": "I guess I would prefer the most:\n\nWe could fail on that combination. Then we would need to disable UC for every at least once test. Not my favorite.\n\nBut this one is probably also fine:\n\nWe disable/ignore UC (current way) with a warning (needs to be added).\n\nBut either way, I think this should deserve it's own ticket.", "author": "pnowojski", "createdAt": "2020-06-19T16:41:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ5MzE0NQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r443493145", "bodyText": "Extracted FLINK-18403, which will be backported (while this PR should only go to master).", "author": "AHeise", "createdAt": "2020-06-22T11:29:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5Nzk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5ODYzNQ==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442098635", "body": "This check seems duplicated `exactlyOnce && cfg.isUnalignedCheckpointsEnabled()` in two places. Maybe hide `exactlyOnce &&` check inside `isUnalignedCheckpointsEnabled`?", "bodyText": "This check seems duplicated exactlyOnce && cfg.isUnalignedCheckpointsEnabled() in two places. Maybe hide exactlyOnce && check inside isUnalignedCheckpointsEnabled?", "bodyHTML": "<p dir=\"auto\">This check seems duplicated <code>exactlyOnce &amp;&amp; cfg.isUnalignedCheckpointsEnabled()</code> in two places. Maybe hide <code>exactlyOnce &amp;&amp;</code> check inside <code>isUnalignedCheckpointsEnabled</code>?</p>", "author": "pnowojski", "createdAt": "2020-06-18T09:36:09Z", "path": "flink-streaming-java/src/main/java/org/apache/flink/streaming/api/graph/StreamingJobGraphGenerator.java", "diffHunk": "@@ -958,10 +960,10 @@ private void configureCheckpointing() {\n \t\t\t\t.setMinPauseBetweenCheckpoints(cfg.getMinPauseBetweenCheckpoints())\n \t\t\t\t.setMaxConcurrentCheckpoints(cfg.getMaxConcurrentCheckpoints())\n \t\t\t\t.setCheckpointRetentionPolicy(retentionAfterTermination)\n-\t\t\t\t.setExactlyOnce(getCheckpointingMode(cfg) == CheckpointingMode.EXACTLY_ONCE)\n+\t\t\t\t.setExactlyOnce(exactlyOnce)\n \t\t\t\t.setPreferCheckpointForRecovery(cfg.isPreferCheckpointForRecovery())\n \t\t\t\t.setTolerableCheckpointFailureNumber(cfg.getTolerableCheckpointFailureNumber())\n-\t\t\t\t.setUnalignedCheckpointsEnabled(cfg.isUnalignedCheckpointsEnabled())\n+\t\t\t\t.setUnalignedCheckpointsEnabled(exactlyOnce && cfg.isUnalignedCheckpointsEnabled())", "originalCommit": "2e55484af53240b19097d2536853b09c575f06d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2MzY2NA==", "url": "https://github.com/apache/flink/pull/11868#discussion_r442863664", "bodyText": "Also possible way, it's pretty much ignoring UC when at least once is set. See also above for a deeper discussion.", "author": "AHeise", "createdAt": "2020-06-19T14:11:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA5ODYzNQ=="}], "type": "inlineReview"}, {"oid": "54bb898e9c5616e615fd2660b2ddef5281900277", "url": "https://github.com/apache/flink/commit/54bb898e9c5616e615fd2660b2ddef5281900277", "message": "[hotfix][config] Remove CheckpointConfig#enableUnalignedCheckpoints without parameters.\n\nCheckpointConfig#enableUnalignedCheckpoints(boolean) makes it explicit and also is more future-proof. When unaligned checkpoints become the default, this method will be mostly useless and we would need to add a #disableUnalignedCheckpoints() for consistency.", "committedDate": "2020-06-22T09:42:25Z", "type": "commit"}, {"oid": "633d0f7aa6b9ee669d2b376d3bc4310ee2a9fd56", "url": "https://github.com/apache/flink/commit/633d0f7aa6b9ee669d2b376d3bc4310ee2a9fd56", "message": "[FLINK-18403][checkpointing] Ensure that unaligned checkpointing is only activated for EXACTLY_ONCE.", "committedDate": "2020-06-22T09:51:42Z", "type": "commit"}, {"oid": "5b05578dd320dc32441ec1c374c99f94d0c1e0c9", "url": "https://github.com/apache/flink/commit/5b05578dd320dc32441ec1c374c99f94d0c1e0c9", "message": "[FLINK-17258][tests] Enabling unaligned checkpoint in all tests by default.", "committedDate": "2020-06-22T11:23:02Z", "type": "commit"}]}