{"pr_number": 13834, "pr_title": "[FLINK-19872][csv] Fix CSV format is unable to parse millisecond for TIME type", "pr_author": "pyscala", "pr_createdAt": "2020-10-29T06:42:52Z", "pr_url": "https://github.com/apache/flink/pull/13834", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0Mjk4MQ==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514842981", "body": "```java\r\n\t\tfinal int precision = timeType.getPrecision();\r\n\t\tif (precision > 3) {\r\n\t\t\tthrow new IllegalArgumentException(\"CSV format does not support TIME type \" +\r\n\t\t\t\t\"with precision: \" + precision + \", it only supports precision 0 ~ 3.\");\r\n\t\t}\r\n\t\t// get number of milliseconds of the day\r\n\t\treturn jsonNode -> {\r\n\t\t\tLocalTime localTime = LocalTime.parse(jsonNode.asText());\r\n\t\t\tif (precision == 0) {\r\n\t\t\t\treturn localTime.toSecondOfDay() * 1000L;\r\n\t\t\t} else {\r\n\t\t\t\treturn (int) (localTime.toNanoOfDay() / 1000_000L);\r\n\t\t\t}\r\n\t\t};\r\n```\r\nThrows exception in compile phase instead during runtime. \r\nBesides, we can also support precision 0~3.", "bodyText": "final int precision = timeType.getPrecision();\n\t\tif (precision > 3) {\n\t\t\tthrow new IllegalArgumentException(\"CSV format does not support TIME type \" +\n\t\t\t\t\"with precision: \" + precision + \", it only supports precision 0 ~ 3.\");\n\t\t}\n\t\t// get number of milliseconds of the day\n\t\treturn jsonNode -> {\n\t\t\tLocalTime localTime = LocalTime.parse(jsonNode.asText());\n\t\t\tif (precision == 0) {\n\t\t\t\treturn localTime.toSecondOfDay() * 1000L;\n\t\t\t} else {\n\t\t\t\treturn (int) (localTime.toNanoOfDay() / 1000_000L);\n\t\t\t}\n\t\t};\nThrows exception in compile phase instead during runtime.\nBesides, we can also support precision 0~3.", "bodyHTML": "<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"\t\tfinal int precision = timeType.getPrecision();\n\t\tif (precision &gt; 3) {\n\t\t\tthrow new IllegalArgumentException(&quot;CSV format does not support TIME type &quot; +\n\t\t\t\t&quot;with precision: &quot; + precision + &quot;, it only supports precision 0 ~ 3.&quot;);\n\t\t}\n\t\t// get number of milliseconds of the day\n\t\treturn jsonNode -&gt; {\n\t\t\tLocalTime localTime = LocalTime.parse(jsonNode.asText());\n\t\t\tif (precision == 0) {\n\t\t\t\treturn localTime.toSecondOfDay() * 1000L;\n\t\t\t} else {\n\t\t\t\treturn (int) (localTime.toNanoOfDay() / 1000_000L);\n\t\t\t}\n\t\t};\n\"><pre>\t\t<span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> precision <span class=\"pl-k\">=</span> timeType<span class=\"pl-k\">.</span>getPrecision();\n\t\t<span class=\"pl-k\">if</span> (precision <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">3</span>) {\n\t\t\t<span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalArgumentException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>CSV format does not support TIME type <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span>\n\t\t\t\t<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>with precision: <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> precision <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, it only supports precision 0 ~ 3.<span class=\"pl-pds\">\"</span></span>);\n\t\t}\n\t\t<span class=\"pl-c\"><span class=\"pl-c\">//</span> get number of milliseconds of the day</span>\n\t\t<span class=\"pl-k\">return</span> jsonNode <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> {\n\t\t\t<span class=\"pl-smi\">LocalTime</span> localTime <span class=\"pl-k\">=</span> <span class=\"pl-smi\">LocalTime</span><span class=\"pl-k\">.</span>parse(jsonNode<span class=\"pl-k\">.</span>asText());\n\t\t\t<span class=\"pl-k\">if</span> (precision <span class=\"pl-k\">==</span> <span class=\"pl-c1\">0</span>) {\n\t\t\t\t<span class=\"pl-k\">return</span> localTime<span class=\"pl-k\">.</span>toSecondOfDay() <span class=\"pl-k\">*</span> <span class=\"pl-c1\">1000L</span>;\n\t\t\t} <span class=\"pl-k\">else</span> {\n\t\t\t\t<span class=\"pl-k\">return</span> (<span class=\"pl-k\">int</span>) (localTime<span class=\"pl-k\">.</span>toNanoOfDay() <span class=\"pl-k\">/</span> <span class=\"pl-c1\">1000_000L</span>);\n\t\t\t}\n\t\t};</pre></div>\n<p dir=\"auto\">Throws exception in compile phase instead during runtime.<br>\nBesides, we can also support precision 0~3.</p>", "author": "wuchong", "createdAt": "2020-10-30T04:36:58Z", "path": "flink-formats/flink-csv/src/main/java/org/apache/flink/formats/csv/CsvToRowDataConverters.java", "diffHunk": "@@ -221,12 +221,22 @@ private int convertToDate(JsonNode jsonNode) {\n \t\treturn (int) Date.valueOf(jsonNode.asText()).toLocalDate().toEpochDay();\n \t}\n \n-\tprivate int convertToTime(JsonNode jsonNode) {\n+\tprivate CsvToRowDataConverter convertToTime(TimeType timeType) {\n+\t\tfinal int precision = timeType.getPrecision();\n \t\t// csv currently is using Time.valueOf() to parse time string\n-\t\tLocalTime localTime = Time.valueOf(jsonNode.asText()).toLocalTime();\n \t\t// TODO: FLINK-17525 support millisecond and nanosecond\n \t\t// get number of milliseconds of the day\n-\t\treturn localTime.toSecondOfDay() * 1000;\n+\t\treturn jsonNode -> {\n+\t\t\tLocalTime localTime = LocalTime.parse(jsonNode.asText());\n+\t\t\tif (precision == 3) {\n+\t\t\t\treturn localTime.toNanoOfDay() / 1000_000L;\n+\t\t\t} else if (precision == 0) {\n+\t\t\t\treturn localTime.toSecondOfDay() * 1000L;\n+\t\t\t} else {\n+\t\t\t\tthrow new IllegalArgumentException(\"Csv does not support TIME type \" +\n+\t\t\t\t\t\"with precision: \" + precision + \", it only supports precision 0 or 3.\");\n+\t\t\t}\n+\t\t};", "originalCommit": "3792d96b470ee584cd60265925bf578d65fffa64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NTIyNw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514885227", "bodyText": "I will optimize.", "author": "pyscala", "createdAt": "2020-10-30T05:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0Mjk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0NDAyNw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514844027", "body": "We should still use `getInt`, because we always use `int` to represent number of milliseconds of the day in Flink SQL internally. See Javadoc of `RowData`.", "bodyText": "We should still use getInt, because we always use int to represent number of milliseconds of the day in Flink SQL internally. See Javadoc of RowData.", "bodyHTML": "<p dir=\"auto\">We should still use <code>getInt</code>, because we always use <code>int</code> to represent number of milliseconds of the day in Flink SQL internally. See Javadoc of <code>RowData</code>.</p>", "author": "wuchong", "createdAt": "2020-10-30T04:38:14Z", "path": "flink-formats/flink-csv/src/main/java/org/apache/flink/formats/csv/RowDataToCsvConverters.java", "diffHunk": "@@ -128,7 +128,7 @@ private static RowFieldConverter createRowFieldConverter(LogicalType fieldType)\n \t\t\tcase DATE:\n \t\t\t\treturn (csvMapper, container, row, pos) -> convertDate(row.getInt(pos), container);\n \t\t\tcase TIME_WITHOUT_TIME_ZONE:\n-\t\t\t\treturn (csvMapper, container, row, pos) -> convertTime(row.getInt(pos), container);\n+\t\t\t\treturn (csvMapper, container, row, pos) -> convertTime(row.getLong(pos), container);", "originalCommit": "3792d96b470ee584cd60265925bf578d65fffa64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg5MTIzMA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514891230", "bodyText": "Will overflow when supporting nanosecond precision in the future", "author": "pyscala", "createdAt": "2020-10-30T06:15:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0NDAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwMTIxNA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514901214", "bodyText": "That's why we don't support precision > 3 for now.\nWhen the planner supports precision > 3 in the future, we can update csv format to use the higer precision data structure (maybe long or otheres).", "author": "wuchong", "createdAt": "2020-10-30T06:51:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0NDAyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMDI4OA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514910288", "bodyText": "get it", "author": "pyscala", "createdAt": "2020-10-30T07:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0NDAyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTA3NA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514849074", "body": "Why not reuse the `testNullableField` method?", "bodyText": "Why not reuse the testNullableField method?", "bodyHTML": "<p dir=\"auto\">Why not reuse the <code>testNullableField</code> method?</p>", "author": "wuchong", "createdAt": "2020-10-30T04:44:06Z", "path": "flink-formats/flink-csv/src/test/java/org/apache/flink/formats/csv/CsvRowDataSerDeSchemaTest.java", "diffHunk": "@@ -109,6 +109,54 @@ public void testSerializeDeserialize() throws Exception {\n \t\t\tnew byte[] {107, 3, 11});\n \t}\n \n+\t@Test\n+\tpublic void testSerializeDeserializeForTime() throws Exception {\n+\t\ttestFieldForTime(\n+\t\t\tTIME(3),\n+\t\t\t\"12:12:12.232\",\n+\t\t\t\"12:12:12.232\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),", "originalCommit": "3792d96b470ee584cd60265925bf578d65fffa64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4NjcwNw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514886707", "bodyText": "For example, the input is \"12:12:12.232\", but the precision is 2, then the result should be \"12:12:12.23\". The existing test named testNullableField  must be modified to meet the needs of this test. But the change affects other test cases. So i add a new test methed named testFieldForTime.", "author": "pyscala", "createdAt": "2020-10-30T05:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwMDQ2Ng==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514900466", "bodyText": "For such case, I think you can use the test method only validate the deserialization.\ntestField(\n\t\t\tDataType fieldType,\n\t\t\tString csvValue,\n\t\t\tObject value,\n\t\t\tConsumer<CsvRowDataDeserializationSchema.Builder> deserializationConfig,\n\t\t\tString fieldDelimiter)", "author": "wuchong", "createdAt": "2020-10-30T06:48:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0MTY2Ng==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514941666", "bodyText": "Sorry for my carelessness, I will optimize it.", "author": "pyscala", "createdAt": "2020-10-30T08:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk4MzgxMA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514983810", "bodyText": "@wuchong\nthe following code\nRow actualRow = (Row) DataFormatConverters.getConverterForDataType(dataType).toExternal(deserializedRow); \nin methed\ntestField( DataType fieldType, String csvValue, Object value, Consumer<CsvRowDataDeserializationSchema.Builder> deserializationConfig, String fieldDelimiter)\nwill change TIME(n) (0<=n<=3) to  TIME(0) .Then the test will fail.\nI still use testFieldForTime().", "author": "pyscala", "createdAt": "2020-10-30T09:56:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk5Njg2NQ==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514996865", "bodyText": "This works in my environment:\n\t\ttestField(\n\t\t\tTIME(3),\n\t\t\t\"12:12:12.232421\",\n\t\t\tLocalTime.parse(\"12:12:12.232\"),\n\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n\t\t\t\",\");", "author": "wuchong", "createdAt": "2020-10-30T10:20:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTA3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTcxNDIxNA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r515714214", "bodyText": "fix it", "author": "pyscala", "createdAt": "2020-11-02T02:38:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTY4OA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514849688", "body": "Add more tests for `TIME(1)`, `TIME(2)`.", "bodyText": "Add more tests for TIME(1), TIME(2).", "bodyHTML": "<p dir=\"auto\">Add more tests for <code>TIME(1)</code>, <code>TIME(2)</code>.</p>", "author": "wuchong", "createdAt": "2020-10-30T04:44:43Z", "path": "flink-formats/flink-csv/src/test/java/org/apache/flink/formats/csv/CsvRowDataSerDeSchemaTest.java", "diffHunk": "@@ -109,6 +109,54 @@ public void testSerializeDeserialize() throws Exception {\n \t\t\tnew byte[] {107, 3, 11});\n \t}\n \n+\t@Test\n+\tpublic void testSerializeDeserializeForTime() throws Exception {\n+\t\ttestFieldForTime(\n+\t\t\tTIME(3),\n+\t\t\t\"12:12:12.232\",\n+\t\t\t\"12:12:12.232\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\",\");\n+\t\ttestFieldForTime(\n+\t\t\tTIME(3),\n+\t\t\t\"12:12:12.232421\",\n+\t\t\t\"12:12:12.232\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\",\");\n+\t\ttestFieldForTime(\n+\t\t\tTIME(3),\n+\t\t\t\"12:12:12.23\",\n+\t\t\t\"12:12:12.23\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\",\");\n+\t\ttestFieldForTime(\n+\t\t\tTIME(0),", "originalCommit": "3792d96b470ee584cd60265925bf578d65fffa64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg4Njc2Nw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514886767", "bodyText": "ok", "author": "pyscala", "createdAt": "2020-10-30T05:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg0OTY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDg1MDYwMw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r514850603", "body": "```suggestion\r\n\t\t\t\t\",\");\r\n\t\t\t\tfail(\"Exception should be thrown.\");\r\n\t\t} catch (Exception e) {\r\n\t\t\tassertEquals(expectedMessage, e.getCause().getMessage());\r\n\t\t}\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\",\");\n          \n          \n            \n            \t\t} catch (Exception e) {\n          \n          \n            \n            \t\t\tactualMessage = e.getCause().getMessage();\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\tassertEquals(expectedMessage, actualMessage);\n          \n          \n            \n            \t\t\t\t\",\");\n          \n          \n            \n            \t\t\t\tfail(\"Exception should be thrown.\");\n          \n          \n            \n            \t\t} catch (Exception e) {\n          \n          \n            \n            \t\t\tassertEquals(expectedMessage, e.getCause().getMessage());\n          \n          \n            \n            \t\t}", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t\t\t<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>,<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t<span class=\"x x-first\">} </span><span class=\"pl-k x\">catch</span><span class=\"x x-last\"> (</span><span class=\"pl-smi\">Exception</span> <span class=\"x x-first x-last\">e) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t<span class=\"x x-first\">\tactualMessage </span><span class=\"pl-k x\">=</span><span class=\"x\"> e</span><span class=\"pl-k x\">.</span><span class=\"x\">getCause()</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getMessage();</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t<span class=\"x x-first x-last\">}</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t<span class=\"x x-first x-last\">assertEquals(expectedMessage, actualMessage);</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t\t\t<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>,<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t<span class=\"x x-first\">\t\tfail(</span><span class=\"pl-s\"><span class=\"pl-pds x x-last\">\"</span>Exception <span class=\"x x-first\">should be thrown.</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">);</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t<span class=\"x x-first\">} </span><span class=\"pl-k x\">catch</span><span class=\"x\"> (</span><span class=\"pl-smi x\">Exception</span><span class=\"x x-last\"> e) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t<span class=\"x x-first\">\tassertEquals(expectedMessage, e</span><span class=\"pl-k x\">.</span><span class=\"x\">getCause()</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getMessage());</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t<span class=\"x x-first x-last\">}</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "wuchong", "createdAt": "2020-10-30T04:45:45Z", "path": "flink-formats/flink-csv/src/test/java/org/apache/flink/formats/csv/CsvRowDataSerDeSchemaTest.java", "diffHunk": "@@ -109,6 +109,54 @@ public void testSerializeDeserialize() throws Exception {\n \t\t\tnew byte[] {107, 3, 11});\n \t}\n \n+\t@Test\n+\tpublic void testSerializeDeserializeForTime() throws Exception {\n+\t\ttestFieldForTime(\n+\t\t\tTIME(3),\n+\t\t\t\"12:12:12.232\",\n+\t\t\t\"12:12:12.232\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\",\");\n+\t\ttestFieldForTime(\n+\t\t\tTIME(3),\n+\t\t\t\"12:12:12.232421\",\n+\t\t\t\"12:12:12.232\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\",\");\n+\t\ttestFieldForTime(\n+\t\t\tTIME(3),\n+\t\t\t\"12:12:12.23\",\n+\t\t\t\"12:12:12.23\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\",\");\n+\t\ttestFieldForTime(\n+\t\t\tTIME(0),\n+\t\t\t\"12:12:12.23\",\n+\t\t\t\"12:12:12\",\n+\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\",\");\n+\n+\t\tint precision = 2;\n+\t\tString expectedMessage = String.format(\"Csv does not support TIME type with precision: %d, it only supports precision 0 or 3.\", precision);\n+\t\tString actualMessage = null;\n+\t\ttry {\n+\t\t\ttestFieldForTime(\n+\t\t\t\tTIME(precision),\n+\t\t\t\t\"12:12:12.23\",\n+\t\t\t\t\"12:12:12\",\n+\t\t\t\t(deserSchema) -> deserSchema.setNullLiteral(\"null\"),\n+\t\t\t\t(serSchema) -> serSchema.setNullLiteral(\"null\"),\n+\t\t\t\t\",\");\n+\t\t} catch (Exception e) {\n+\t\t\tactualMessage = e.getCause().getMessage();\n+\t\t}\n+\t\tassertEquals(expectedMessage, actualMessage);", "originalCommit": "3792d96b470ee584cd60265925bf578d65fffa64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2Mjk1MA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r519662950", "body": "This is never used. ", "bodyText": "This is never used.", "bodyHTML": "<p dir=\"auto\">This is never used.</p>", "author": "wuchong", "createdAt": "2020-11-09T09:26:41Z", "path": "flink-formats/flink-csv/src/test/java/org/apache/flink/formats/csv/CsvRowDataSerDeSchemaTest.java", "diffHunk": "@@ -320,6 +339,34 @@ private void testField(\n \t\tassertEquals(expectedCsv, new String(serializedRow));\n \t}\n \n+\tprivate void testFieldForTime(", "originalCommit": "dc0a2a29d0fba59d7b7769353bd4d91aa1307ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5Nzg1OQ==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521297859", "bodyText": "i will clean up", "author": "pyscala", "createdAt": "2020-11-11T11:37:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2Mjk1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2MzMzMw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r519663333", "body": "Why not hard code the exception message?", "bodyText": "Why not hard code the exception message?", "bodyHTML": "<p dir=\"auto\">Why not hard code the exception message?</p>", "author": "wuchong", "createdAt": "2020-11-09T09:27:15Z", "path": "flink-formats/flink-csv/src/test/java/org/apache/flink/formats/csv/CsvRowDataSerDeSchemaTest.java", "diffHunk": "@@ -150,6 +151,24 @@ public void testSerializeDeserializeCustomizedProperties() throws Exception {\n \t\t\tdeserConfig,\n \t\t\t\";\");\n \t\ttestField(STRING(), \"null\", \"null\", serConfig, deserConfig, \";\"); // string because null literal has not been set\n+\t\ttestField(TIME(3), \"12:12:12.232\", LocalTime.parse(\"12:12:12.232\") , deserConfig , \";\");\n+\t\ttestField(TIME(3), \"12:12:12.232342\", LocalTime.parse(\"12:12:12.232\") , deserConfig , \";\");\n+\t\ttestField(TIME(3), \"12:12:12.23\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.23\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.232312\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.2\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12.2\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12.2235\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\ttestField(TIME(0), \"12:12:12\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\ttestField(TIME(0), \"12:12:12.45\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\tint precision = 5;\n+\t\tString expectedMessage = String.format(\"Csv does not support TIME type with precision: %d, it only supports precision 0 ~ 3.\", precision);", "originalCommit": "dc0a2a29d0fba59d7b7769353bd4d91aa1307ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5Nzk0MQ==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521297941", "bodyText": "fix it", "author": "pyscala", "createdAt": "2020-11-11T11:37:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2MzMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2NjMxMw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r519666313", "body": "Could you add a comment \"this is for rounding off values out of precision\"?", "bodyText": "Could you add a comment \"this is for rounding off values out of precision\"?", "bodyHTML": "<p dir=\"auto\">Could you add a comment \"this is for rounding off values out of precision\"?</p>", "author": "wuchong", "createdAt": "2020-11-09T09:31:40Z", "path": "flink-formats/flink-csv/src/main/java/org/apache/flink/formats/csv/CsvToRowDataConverters.java", "diffHunk": "@@ -221,12 +221,27 @@ private int convertToDate(JsonNode jsonNode) {\n \t\treturn (int) Date.valueOf(jsonNode.asText()).toLocalDate().toEpochDay();\n \t}\n \n-\tprivate int convertToTime(JsonNode jsonNode) {\n+\tprivate CsvToRowDataConverter convertToTime(TimeType timeType) {\n+\t\tfinal int precision = timeType.getPrecision();\n \t\t// csv currently is using Time.valueOf() to parse time string\n-\t\tLocalTime localTime = Time.valueOf(jsonNode.asText()).toLocalTime();\n \t\t// TODO: FLINK-17525 support millisecond and nanosecond\n \t\t// get number of milliseconds of the day\n-\t\treturn localTime.toSecondOfDay() * 1000;\n+\t\tif (precision > 3) {\n+\t\t\tthrow new IllegalArgumentException(\"Csv does not support TIME type \" +\n+\t\t\t\t\"with precision: \" + precision + \", it only supports precision 0 ~ 3.\");\n+\t\t}\n+\t\treturn jsonNode -> {\n+\t\t\tLocalTime localTime = LocalTime.parse(jsonNode.asText());\n+\t\t\tint mills = (int) (localTime.toNanoOfDay() / 1000_000L);\n+\t\t\tif (precision == 2) {\n+\t\t\t\tmills = mills / 10 * 10;", "originalCommit": "dc0a2a29d0fba59d7b7769353bd4d91aa1307ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5NTIxOA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521295218", "bodyText": "ok", "author": "pyscala", "createdAt": "2020-11-11T11:32:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2NjMxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2NjkzMg==", "url": "https://github.com/apache/flink/pull/13834#discussion_r519666932", "body": "This will not fail. Because it is not `TIME(5)`. \r\n\r\nYou should add `fail();` if you want to verify it should fail. ", "bodyText": "This will not fail. Because it is not TIME(5).\nYou should add fail(); if you want to verify it should fail.", "bodyHTML": "<p dir=\"auto\">This will not fail. Because it is not <code>TIME(5)</code>.</p>\n<p dir=\"auto\">You should add <code>fail();</code> if you want to verify it should fail.</p>", "author": "wuchong", "createdAt": "2020-11-09T09:32:44Z", "path": "flink-formats/flink-csv/src/test/java/org/apache/flink/formats/csv/CsvRowDataSerDeSchemaTest.java", "diffHunk": "@@ -150,6 +151,24 @@ public void testSerializeDeserializeCustomizedProperties() throws Exception {\n \t\t\tdeserConfig,\n \t\t\t\";\");\n \t\ttestField(STRING(), \"null\", \"null\", serConfig, deserConfig, \";\"); // string because null literal has not been set\n+\t\ttestField(TIME(3), \"12:12:12.232\", LocalTime.parse(\"12:12:12.232\") , deserConfig , \";\");\n+\t\ttestField(TIME(3), \"12:12:12.232342\", LocalTime.parse(\"12:12:12.232\") , deserConfig , \";\");\n+\t\ttestField(TIME(3), \"12:12:12.23\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.23\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.232312\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.2\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12.2\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12.2235\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\ttestField(TIME(0), \"12:12:12\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\ttestField(TIME(0), \"12:12:12.45\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\tint precision = 5;\n+\t\tString expectedMessage = String.format(\"Csv does not support TIME type with precision: %d, it only supports precision 0 ~ 3.\", precision);\n+\t\ttry {\n+\t\t\ttestField(TIME(0), \"12:12:12.45\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");", "originalCommit": "dc0a2a29d0fba59d7b7769353bd4d91aa1307ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5ODA4MA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521298080", "bodyText": "fix it", "author": "pyscala", "createdAt": "2020-11-11T11:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2NjkzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODY5NQ==", "url": "https://github.com/apache/flink/pull/13834#discussion_r519668695", "body": "All of these only test the deserialization. We should also add tests for serialization. I think we can use `testNullableField` for this purpose. \r\n\r\nBesides, we can rename method `testField(fieldType, csvValue, value, deserializationConfig, fieldDelimiter)` to `testFieldSerialization` to be more specific. ", "bodyText": "All of these only test the deserialization. We should also add tests for serialization. I think we can use testNullableField for this purpose.\nBesides, we can rename method testField(fieldType, csvValue, value, deserializationConfig, fieldDelimiter) to testFieldSerialization to be more specific.", "bodyHTML": "<p dir=\"auto\">All of these only test the deserialization. We should also add tests for serialization. I think we can use <code>testNullableField</code> for this purpose.</p>\n<p dir=\"auto\">Besides, we can rename method <code>testField(fieldType, csvValue, value, deserializationConfig, fieldDelimiter)</code> to <code>testFieldSerialization</code> to be more specific.</p>", "author": "wuchong", "createdAt": "2020-11-09T09:35:30Z", "path": "flink-formats/flink-csv/src/test/java/org/apache/flink/formats/csv/CsvRowDataSerDeSchemaTest.java", "diffHunk": "@@ -150,6 +151,24 @@ public void testSerializeDeserializeCustomizedProperties() throws Exception {\n \t\t\tdeserConfig,\n \t\t\t\";\");\n \t\ttestField(STRING(), \"null\", \"null\", serConfig, deserConfig, \";\"); // string because null literal has not been set\n+\t\ttestField(TIME(3), \"12:12:12.232\", LocalTime.parse(\"12:12:12.232\") , deserConfig , \";\");\n+\t\ttestField(TIME(3), \"12:12:12.232342\", LocalTime.parse(\"12:12:12.232\") , deserConfig , \";\");\n+\t\ttestField(TIME(3), \"12:12:12.23\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.23\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.232312\", LocalTime.parse(\"12:12:12.23\") , deserConfig , \";\");\n+\t\ttestField(TIME(2), \"12:12:12.2\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12.2\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12.2235\", LocalTime.parse(\"12:12:12.2\") , deserConfig , \";\");\n+\t\ttestField(TIME(1), \"12:12:12\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\ttestField(TIME(0), \"12:12:12\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");\n+\t\ttestField(TIME(0), \"12:12:12.45\", LocalTime.parse(\"12:12:12\") , deserConfig , \";\");", "originalCommit": "dc0a2a29d0fba59d7b7769353bd4d91aa1307ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMwMjkyNQ==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521302925", "bodyText": "rename method  testField(fieldType, csvValue, value, deserializationConfig, fieldDelimiter) to testFieldSerialization ?  or testFieldDeserialization ?", "author": "pyscala", "createdAt": "2020-11-11T11:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMxMTk2Mw==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521311963", "bodyText": "The reason for not using testNullableField  can be seen in our previous dialogue.", "author": "pyscala", "createdAt": "2020-11-11T12:05:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0MzM5MA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521343390", "bodyText": "Rename to testFieldDeserialization.", "author": "wuchong", "createdAt": "2020-11-11T13:03:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM0MzgxNQ==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521343815", "bodyText": "We only use testNullableField to test conversion without precision loss.", "author": "wuchong", "createdAt": "2020-11-11T13:04:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODY5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2OTgwNA==", "url": "https://github.com/apache/flink/pull/13834#discussion_r521769804", "bodyText": "done", "author": "pyscala", "createdAt": "2020-11-12T02:00:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY2ODY5NQ=="}], "type": "inlineReview"}, {"oid": "6dd7a167a257fe6379340600a53ab4262c35f62f", "url": "https://github.com/apache/flink/commit/6dd7a167a257fe6379340600a53ab4262c35f62f", "message": "[FLINK-19872][csv] Fix CSV format is unable to parse millisecond for TIME type\n\nThis closes #13834", "committedDate": "2020-11-12T03:14:20Z", "type": "commit"}, {"oid": "6dd7a167a257fe6379340600a53ab4262c35f62f", "url": "https://github.com/apache/flink/commit/6dd7a167a257fe6379340600a53ab4262c35f62f", "message": "[FLINK-19872][csv] Fix CSV format is unable to parse millisecond for TIME type\n\nThis closes #13834", "committedDate": "2020-11-12T03:14:20Z", "type": "forcePushed"}]}