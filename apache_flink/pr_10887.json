{"pr_number": 10887, "pr_title": "[FLINK-15150][tests] Prevent job from reaching terminal state", "pr_author": "zentol", "pr_createdAt": "2020-01-17T14:23:11Z", "pr_url": "https://github.com/apache/flink/pull/10887", "timeline": [{"oid": "a14c99309223cb36f6da40429910247dba35e226", "url": "https://github.com/apache/flink/commit/a14c99309223cb36f6da40429910247dba35e226", "message": "[FLINK-15150][tests] Prevent job from reaching terminal state\n\nExplicitly enable restarts; this is necessary since the shutdown may result in the job failing and hence being removed from ZooKeeper.\nWhat happens to running jobs if the Dispatcher shuts down in an orderly fashion is undefined behavior.\nBy allowing restarts we prevent the job from reaching a globally terminal state, causing it to be recovered by the next Dispatcher.", "committedDate": "2020-01-17T14:13:34Z", "type": "commit"}, {"oid": "7f91b3855bca5e7e2d2d9abf196cca861e122312", "url": "https://github.com/apache/flink/commit/7f91b3855bca5e7e2d2d9abf196cca861e122312", "message": "[hotfix][zookeeper] Log changes to SchedulingState", "committedDate": "2020-01-17T14:14:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MzM0Ng==", "url": "https://github.com/apache/flink/pull/10887#discussion_r369163346", "body": "```suggestion\r\n\t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(100, Duration.ofMillis(100).toMillis()));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(10, Duration.ofSeconds(10).toMillis()));\n          \n          \n            \n            \t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(100, Duration.ofMillis(100).toMillis()));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"160\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\texecutionConfig<span class=\"pl-k\">.</span>setRestartStrategy(<span class=\"pl-smi\">RestartStrategies</span><span class=\"pl-k\">.</span>fixedDelayRestart(<span class=\"pl-c1 x x-first x-last\">10</span>, <span class=\"pl-smi\">Duration</span><span class=\"pl-k\">.</span><span class=\"x x-first\">ofSeconds(</span><span class=\"pl-c1 x x-last\">10</span>)<span class=\"pl-k\">.</span>toMillis()));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"160\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\texecutionConfig<span class=\"pl-k\">.</span>setRestartStrategy(<span class=\"pl-smi\">RestartStrategies</span><span class=\"pl-k\">.</span>fixedDelayRestart(<span class=\"pl-c1 x x-first x-last\">100</span>, <span class=\"pl-smi\">Duration</span><span class=\"pl-k\">.</span><span class=\"x x-first\">ofMillis(</span><span class=\"pl-c1 x x-last\">100</span>)<span class=\"pl-k\">.</span>toMillis()));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "tillrohrmann", "createdAt": "2020-01-21T18:17:29Z", "path": "flink-tests/src/test/java/org/apache/flink/test/runtime/leaderelection/ZooKeeperLeaderElectionITCase.java", "diffHunk": "@@ -141,13 +144,23 @@ private DispatcherGateway getNextLeadingDispatcherGateway(TestingMiniCluster min\n \t\treturn miniCluster.getDispatcherGatewayFuture().get();\n \t}\n \n-\tprivate JobGraph createJobGraph(int parallelism) {\n+\tprivate JobGraph createJobGraph(int parallelism) throws IOException {\n \t\tBlockingOperator.isBlocking = true;\n \t\tfinal JobVertex vertex = new JobVertex(\"blocking operator\");\n \t\tvertex.setParallelism(parallelism);\n \t\tvertex.setInvokableClass(BlockingOperator.class);\n \n-\t\treturn new JobGraph(\"Blocking test job\", vertex);\n+\t\tJobGraph jobGraph = new JobGraph(\"Blocking test job\", vertex);\n+\n+\t\t// explicitly allow restarts; this is necessary since the shutdown may result in the job failing and hence being\n+\t\t// removed from ZooKeeper. What happens to running jobs if the Dispatcher shuts down in an orderly fashion\n+\t\t// is undefined behavior. By allowing restarts we prevent the job from reaching a globally terminal state,\n+\t\t// causing it to be recovered by the next Dispatcher.\n+\t\tExecutionConfig executionConfig = new ExecutionConfig();\n+\t\texecutionConfig.setRestartStrategy(RestartStrategies.fixedDelayRestart(10, Duration.ofSeconds(10).toMillis()));", "originalCommit": "7f91b3855bca5e7e2d2d9abf196cca861e122312", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE3MTQ1Mg==", "url": "https://github.com/apache/flink/pull/10887#discussion_r369171452", "bodyText": "My idea here was to not have the job actually restart since it shouldn't be relevant to the test whether the job is running/restarting (just that it's not failed), and these state transitions add additional noise to the logs.", "author": "zentol", "createdAt": "2020-01-21T18:33:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MzM0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTU0NjA1NQ==", "url": "https://github.com/apache/flink/pull/10887#discussion_r369546055", "bodyText": "Good point. Then ignore my comment.", "author": "tillrohrmann", "createdAt": "2020-01-22T13:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MzM0Ng=="}], "type": "inlineReview"}]}