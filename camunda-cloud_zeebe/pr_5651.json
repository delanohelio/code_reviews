{"pr_number": 5651, "pr_title": "feat(gateway): Add a health info in the gateway's API.", "pr_author": "aivinog1", "pr_createdAt": "2020-10-21T09:36:27Z", "pr_url": "https://github.com/camunda-cloud/zeebe/pull/5651", "timeline": [{"oid": "54c6cf6b3a13527ddcdd6e9afcd8d9657626787d", "url": "https://github.com/camunda-cloud/zeebe/commit/54c6cf6b3a13527ddcdd6e9afcd8d9657626787d", "message": "feat(gateway): Add a health info in the gateway's API.", "committedDate": "2020-10-23T12:51:48Z", "type": "forcePushed"}, {"oid": "5ceb7ec3a9e82a448bfd8690c20e5f3cb677ea0d", "url": "https://github.com/camunda-cloud/zeebe/commit/5ceb7ec3a9e82a448bfd8690c20e5f3cb677ea0d", "message": "chore(gateway): add gateway tests\n\nI've add some test to verify a partition health changing with a gateway's API.", "committedDate": "2020-11-05T15:18:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTU1NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518195555", "body": "I think this test is not necessary. You've changed a property of the topology and then again get the same object and alter it again. Just once is fine. Or am I missing something?", "bodyText": "I think this test is not necessary. You've changed a property of the topology and then again get the same object and alter it again. Just once is fine. Or am I missing something?", "bodyHTML": "<p dir=\"auto\">I think this test is not necessary. You've changed a property of the topology and then again get the same object and alter it again. Just once is fine. Or am I missing something?</p>", "author": "korthout", "createdAt": "2020-11-05T16:41:59Z", "path": "gateway/src/test/java/io/zeebe/gateway/api/topology/TopologyTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api.topology;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.gateway.api.util.GatewayTest;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterStateImpl;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.BrokerInfo;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.Partition.PartitionBrokerHealth;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyRequest;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyResponse;\n+import org.junit.Test;\n+\n+public class TopologyTest extends GatewayTest {\n+\n+  @Test\n+  public void shouldResponseWithInitialUnhealthyPartitions() {\n+    // when\n+    final TopologyResponse topologyResponse = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    assertThat(topologyResponse.getBrokersList())\n+        .isNotEmpty()\n+        .allSatisfy(\n+            brokerInfo ->\n+                assertThat(brokerInfo.getPartitionsList())\n+                    .isNotEmpty()\n+                    .allSatisfy(\n+                        partitionPerBroker ->\n+                            assertThat(partitionPerBroker.getHealth())\n+                                .isEqualTo(PartitionBrokerHealth.UNHEALTHY)));\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthHealthy() {\n+    // given\n+    final BrokerClusterStateImpl topology =\n+        (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);\n+\n+    // when\n+    final TopologyResponse topologyResponse = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    final PartitionBrokerHealth health =\n+        topologyResponse.getBrokers(0).getPartitions(0).getHealth();\n+    assertThat(health).isEqualTo(PartitionBrokerHealth.HEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthUnhealthy() {", "originalCommit": "5ceb7ec3a9e82a448bfd8690c20e5f3cb677ea0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUzNjI5Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518536296", "bodyText": "There I'm thinking to test simultaneously changing the health of two partitions. All can work fine if the broker changes the health of one partition but not for many :) I'm don't sure that this needs to be tested but anyway, what do you think? :)", "author": "aivinog1", "createdAt": "2020-11-06T05:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxMjQ5Ng==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518612496", "bodyText": "That makes sense, but you can do that in one go. No need for the additional setup. (I understand marking 1 partition first as healthy may matter for your implementation, but that should not be part of the test IMO)", "author": "korthout", "createdAt": "2020-11-06T09:05:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxNzI4NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518617285", "bodyText": "Also make sure to change the name of the test method accordingly. Something like: shouldUpdateMultiplePartitionHealths", "author": "korthout", "createdAt": "2020-11-06T09:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTU1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc3ODI0NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518778245", "bodyText": "Done :)", "author": "aivinog1", "createdAt": "2020-11-06T14:15:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTU1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTkyNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518195926", "body": "Please add an additional test case where you explicitly make this value unhealthy. Or change both in the same case and change the test case name to something like `shouldRespondWithUpdatedPartitionHealth`", "bodyText": "Please add an additional test case where you explicitly make this value unhealthy. Or change both in the same case and change the test case name to something like shouldRespondWithUpdatedPartitionHealth", "bodyHTML": "<p dir=\"auto\">Please add an additional test case where you explicitly make this value unhealthy. Or change both in the same case and change the test case name to something like <code>shouldRespondWithUpdatedPartitionHealth</code></p>", "author": "korthout", "createdAt": "2020-11-05T16:42:30Z", "path": "gateway/src/test/java/io/zeebe/gateway/api/topology/TopologyTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api.topology;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.gateway.api.util.GatewayTest;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterStateImpl;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.BrokerInfo;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.Partition.PartitionBrokerHealth;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyRequest;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyResponse;\n+import org.junit.Test;\n+\n+public class TopologyTest extends GatewayTest {\n+\n+  @Test\n+  public void shouldResponseWithInitialUnhealthyPartitions() {\n+    // when\n+    final TopologyResponse topologyResponse = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    assertThat(topologyResponse.getBrokersList())\n+        .isNotEmpty()\n+        .allSatisfy(\n+            brokerInfo ->\n+                assertThat(brokerInfo.getPartitionsList())\n+                    .isNotEmpty()\n+                    .allSatisfy(\n+                        partitionPerBroker ->\n+                            assertThat(partitionPerBroker.getHealth())\n+                                .isEqualTo(PartitionBrokerHealth.UNHEALTHY)));\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthHealthy() {\n+    // given\n+    final BrokerClusterStateImpl topology =\n+        (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);", "originalCommit": "5ceb7ec3a9e82a448bfd8690c20e5f3cb677ea0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUzOTM3NQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518539375", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-06T05:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NjM1OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518196359", "body": "nitpick: I suggest you change the name of the variable to `response` (its clear where it comes from) and change the type definition to `var` because it can easily be inferred.", "bodyText": "nitpick: I suggest you change the name of the variable to response (its clear where it comes from) and change the type definition to var because it can easily be inferred.", "bodyHTML": "<p dir=\"auto\">nitpick: I suggest you change the name of the variable to <code>response</code> (its clear where it comes from) and change the type definition to <code>var</code> because it can easily be inferred.</p>", "author": "korthout", "createdAt": "2020-11-05T16:43:07Z", "path": "gateway/src/test/java/io/zeebe/gateway/api/topology/TopologyTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api.topology;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.gateway.api.util.GatewayTest;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterStateImpl;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.BrokerInfo;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.Partition.PartitionBrokerHealth;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyRequest;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyResponse;\n+import org.junit.Test;\n+\n+public class TopologyTest extends GatewayTest {\n+\n+  @Test\n+  public void shouldResponseWithInitialUnhealthyPartitions() {\n+    // when\n+    final TopologyResponse topologyResponse = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    assertThat(topologyResponse.getBrokersList())\n+        .isNotEmpty()\n+        .allSatisfy(\n+            brokerInfo ->\n+                assertThat(brokerInfo.getPartitionsList())\n+                    .isNotEmpty()\n+                    .allSatisfy(\n+                        partitionPerBroker ->\n+                            assertThat(partitionPerBroker.getHealth())\n+                                .isEqualTo(PartitionBrokerHealth.UNHEALTHY)));\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthHealthy() {\n+    // given\n+    final BrokerClusterStateImpl topology =\n+        (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);\n+\n+    // when\n+    final TopologyResponse topologyResponse = client.topology(TopologyRequest.newBuilder().build());", "originalCommit": "5ceb7ec3a9e82a448bfd8690c20e5f3cb677ea0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NjUxMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518196512", "bodyText": "nitpick: There's some other places where you reduce the variable name length and where you can apply var instead of an explicit type.", "author": "korthout", "createdAt": "2020-11-05T16:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NjM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5ODQxMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518198412", "body": "generally our test classes are final.\r\n```suggestion\r\npublic final class TopologyTest extends GatewayTest {\r\n```", "bodyText": "generally our test classes are final.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class TopologyTest extends GatewayTest {\n          \n          \n            \n            public final class TopologyTest extends GatewayTest {", "bodyHTML": "<p dir=\"auto\">generally our test classes are final.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en\">TopologyTest</span> <span class=\"pl-k\">extends</span> <span class=\"pl-e\">GatewayTest</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">public</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-k\">class</span> <span class=\"pl-en\">TopologyTest</span> <span class=\"pl-k\">extends</span> <span class=\"pl-e\">GatewayTest</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "korthout", "createdAt": "2020-11-05T16:45:52Z", "path": "gateway/src/test/java/io/zeebe/gateway/api/topology/TopologyTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api.topology;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.gateway.api.util.GatewayTest;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterStateImpl;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.BrokerInfo;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.Partition.PartitionBrokerHealth;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyRequest;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyResponse;\n+import org.junit.Test;\n+\n+public class TopologyTest extends GatewayTest {", "originalCommit": "5ceb7ec3a9e82a448bfd8690c20e5f3cb677ea0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODUzOTI2OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518539269", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-06T05:59:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5ODQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxNjA0NA==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518616044", "body": "You don't need this line in this test. I understand that it may seem so due to your implementation, but I'd rather test behaviour. So just setting 1 partition to unhealthy should be enough for this test.", "bodyText": "You don't need this line in this test. I understand that it may seem so due to your implementation, but I'd rather test behaviour. So just setting 1 partition to unhealthy should be enough for this test.", "bodyHTML": "<p dir=\"auto\">You don't need this line in this test. I understand that it may seem so due to your implementation, but I'd rather test behaviour. So just setting 1 partition to unhealthy should be enough for this test.</p>", "author": "korthout", "createdAt": "2020-11-06T09:11:39Z", "path": "gateway/src/test/java/io/zeebe/gateway/api/topology/TopologyTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api.topology;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.gateway.api.util.GatewayTest;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterStateImpl;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.Partition.PartitionBrokerHealth;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyRequest;\n+import org.junit.Test;\n+\n+public final class TopologyTest extends GatewayTest {\n+\n+  @Test\n+  public void shouldResponseWithInitialUnhealthyPartitions() {\n+    // when\n+    final var response = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    assertThat(response.getBrokersList())\n+        .isNotEmpty()\n+        .allSatisfy(\n+            brokerInfo ->\n+                assertThat(brokerInfo.getPartitionsList())\n+                    .isNotEmpty()\n+                    .allSatisfy(\n+                        partitionPerBroker ->\n+                            assertThat(partitionPerBroker.getHealth())\n+                                .isEqualTo(PartitionBrokerHealth.UNHEALTHY)));\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthHealthy() {\n+    // given\n+    final var topology = (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);\n+\n+    // when\n+    final var response = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    final var health = response.getBrokers(0).getPartitions(0).getHealth();\n+    assertThat(health).isEqualTo(PartitionBrokerHealth.HEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealth() {\n+    // given\n+    final var topology = (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);", "originalCommit": "0e292157961e2e59f011f9cc48d18293797f2bcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc3ODM0OQ==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518778349", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-06T14:16:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxNjA0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxNjUyMg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518616522", "body": "nit: you can also make this variable name shorter\r\n```suggestion\r\n    final var response = client.topology(TopologyRequest.newBuilder().build());\r\n```", "bodyText": "nit: you can also make this variable name shorter\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final var responseAfterUpdate = client.topology(TopologyRequest.newBuilder().build());\n          \n          \n            \n                final var response = client.topology(TopologyRequest.newBuilder().build());", "bodyHTML": "<p dir=\"auto\">nit: you can also make this variable name shorter</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">final</span> <span class=\"pl-k\">var</span> <span class=\"x x-first x-last\">responseAfterUpdate</span> <span class=\"pl-k\">=</span> client<span class=\"pl-k\">.</span>topology(<span class=\"pl-smi\">TopologyRequest</span><span class=\"pl-k\">.</span>newBuilder()<span class=\"pl-k\">.</span>build());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">final</span> <span class=\"pl-k\">var</span> <span class=\"x x-first x-last\">response</span> <span class=\"pl-k\">=</span> client<span class=\"pl-k\">.</span>topology(<span class=\"pl-smi\">TopologyRequest</span><span class=\"pl-k\">.</span>newBuilder()<span class=\"pl-k\">.</span>build());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "korthout", "createdAt": "2020-11-06T09:12:33Z", "path": "gateway/src/test/java/io/zeebe/gateway/api/topology/TopologyTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api.topology;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.gateway.api.util.GatewayTest;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterStateImpl;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.Partition.PartitionBrokerHealth;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyRequest;\n+import org.junit.Test;\n+\n+public final class TopologyTest extends GatewayTest {\n+\n+  @Test\n+  public void shouldResponseWithInitialUnhealthyPartitions() {\n+    // when\n+    final var response = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    assertThat(response.getBrokersList())\n+        .isNotEmpty()\n+        .allSatisfy(\n+            brokerInfo ->\n+                assertThat(brokerInfo.getPartitionsList())\n+                    .isNotEmpty()\n+                    .allSatisfy(\n+                        partitionPerBroker ->\n+                            assertThat(partitionPerBroker.getHealth())\n+                                .isEqualTo(PartitionBrokerHealth.UNHEALTHY)));\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthHealthy() {\n+    // given\n+    final var topology = (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);\n+\n+    // when\n+    final var response = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    final var health = response.getBrokers(0).getPartitions(0).getHealth();\n+    assertThat(health).isEqualTo(PartitionBrokerHealth.HEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealth() {\n+    // given\n+    final var topology = (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);\n+    topology.setPartitionUnhealthy(0, 1);\n+\n+    // when\n+    final var response = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    final var health = response.getBrokers(0).getPartitions(0).getHealth();\n+    assertThat(health).isEqualTo(PartitionBrokerHealth.UNHEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthUnhealthy() {\n+    // given\n+    final var topology = (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);\n+    final var topologyAfterUpdate =\n+        (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topologyAfterUpdate.setPartitionUnhealthy(0, 1);\n+    topologyAfterUpdate.setPartitionHealthy(0, 6);\n+\n+    // when\n+    final var responseAfterUpdate = client.topology(TopologyRequest.newBuilder().build());", "originalCommit": "0e292157961e2e59f011f9cc48d18293797f2bcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc3ODQxNg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518778416", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-06T14:16:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxNjUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxNzQ4Mg==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518617482", "body": "```suggestion\r\n  public void shouldUpdatePartitionHealthUnhealthy() {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void shouldUpdatePartitionHealth() {\n          \n          \n            \n              public void shouldUpdatePartitionHealthUnhealthy() {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"53\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">shouldUpdatePartitionHealth</span>() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"53\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">shouldUpdatePartitionHealthUnhealthy</span>() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "korthout", "createdAt": "2020-11-06T09:14:16Z", "path": "gateway/src/test/java/io/zeebe/gateway/api/topology/TopologyTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under\n+ * one or more contributor license agreements. See the NOTICE file distributed\n+ * with this work for additional information regarding copyright ownership.\n+ * Licensed under the Zeebe Community License 1.0. You may not use this file\n+ * except in compliance with the Zeebe Community License 1.0.\n+ */\n+package io.zeebe.gateway.api.topology;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import io.zeebe.gateway.api.util.GatewayTest;\n+import io.zeebe.gateway.impl.broker.cluster.BrokerClusterStateImpl;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.Partition.PartitionBrokerHealth;\n+import io.zeebe.gateway.protocol.GatewayOuterClass.TopologyRequest;\n+import org.junit.Test;\n+\n+public final class TopologyTest extends GatewayTest {\n+\n+  @Test\n+  public void shouldResponseWithInitialUnhealthyPartitions() {\n+    // when\n+    final var response = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    assertThat(response.getBrokersList())\n+        .isNotEmpty()\n+        .allSatisfy(\n+            brokerInfo ->\n+                assertThat(brokerInfo.getPartitionsList())\n+                    .isNotEmpty()\n+                    .allSatisfy(\n+                        partitionPerBroker ->\n+                            assertThat(partitionPerBroker.getHealth())\n+                                .isEqualTo(PartitionBrokerHealth.UNHEALTHY)));\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealthHealthy() {\n+    // given\n+    final var topology = (BrokerClusterStateImpl) brokerClient.getTopologyManager().getTopology();\n+    topology.setPartitionHealthy(0, 1);\n+\n+    // when\n+    final var response = client.topology(TopologyRequest.newBuilder().build());\n+\n+    // then\n+    final var health = response.getBrokers(0).getPartitions(0).getHealth();\n+    assertThat(health).isEqualTo(PartitionBrokerHealth.HEALTHY);\n+  }\n+\n+  @Test\n+  public void shouldUpdatePartitionHealth() {", "originalCommit": "0e292157961e2e59f011f9cc48d18293797f2bcc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODc3ODUxNw==", "url": "https://github.com/camunda-cloud/zeebe/pull/5651#discussion_r518778517", "bodyText": "Done", "author": "aivinog1", "createdAt": "2020-11-06T14:16:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYxNzQ4Mg=="}], "type": "inlineReview"}, {"oid": "3d6a4c61bc3aec000d81757268ea559542906481", "url": "https://github.com/camunda-cloud/zeebe/commit/3d6a4c61bc3aec000d81757268ea559542906481", "message": "feat(gateway): Add a health info in the gateway's API.", "committedDate": "2020-11-06T15:04:50Z", "type": "commit"}, {"oid": "3d6a4c61bc3aec000d81757268ea559542906481", "url": "https://github.com/camunda-cloud/zeebe/commit/3d6a4c61bc3aec000d81757268ea559542906481", "message": "feat(gateway): Add a health info in the gateway's API.", "committedDate": "2020-11-06T15:04:50Z", "type": "forcePushed"}]}