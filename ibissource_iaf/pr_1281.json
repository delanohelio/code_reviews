{"pr_number": 1281, "pr_title": "Change outputType default from string to stream", "pr_author": "nielsm5", "pr_createdAt": "2020-11-20T15:00:20Z", "pr_url": "https://github.com/ibissource/iaf/pull/1281", "timeline": [{"oid": "9c8fce309899fd7d762a54486bbaef22e52463e3", "url": "https://github.com/ibissource/iaf/commit/9c8fce309899fd7d762a54486bbaef22e52463e3", "message": "Change outputType default from string to stream", "committedDate": "2020-11-20T14:54:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgxMTA4NA==", "url": "https://github.com/ibissource/iaf/pull/1281#discussion_r527811084", "body": "Het charset veld in Message is bedoeld als 'originalCharset', dus:\r\nJe krijgt bytes binnen van een listener, en die zegt er bij: \"dit waren bytes in deze charset.\r\nAls je dan naar String gaat converteren, dan moet je die charset gebruiken, (als hij gedefinieerd is).\"\r\nHet veld wordt ook alleen maar gezet vanuit constructors met een binary request type.\r\nJij gebruikt nu charset als 'compatibleCharset': \"Ik heb hier een string met bepaalde vreemde characters, als je deze string naar bytes wil converteren, dan zou je deze charset kunnen gebruiken.\"\r\nHet is maar de vraag of dat zinvol is. Ik denk eigenlijk van niet.\r\n\r\nIn beide gevallen van het gebruik zou het niet zo moeten zijn dat als je string of bytes leest, er iets\r\nzou moeten veranderen aan de oorspronkelijke charset.\r\n\r\nStel je hebt een message met bytes en je vraagt message.asReader(defaultCharset):\r\nDan moet je message.originalCharset gebruiken als die er is, of anders defaultCharset, of anders UTF-8.\r\nAls message.originalCharset leeg was, kan je je afvragen of dat na afloop nog steeds zo moet zijn:\r\nA) Na afloop moet message.originalCharset niet veranderd zijn, want wat doet het er toe dat je die bytes een keer gelezen hebt met 'defaultCharset' of UTF-8?\r\nB) Als je message.originalCharset zet op de charset die gebruikt is, dan zal je de volgende keer weer dezelfde charset gebruiken, dat is consistent.\r\nDe huidge asReader() (elders in Message.java) doet optie B). Ik neig er naar nu te zeggen dat dat eigenlijk niet goed is, dat het eigenlijk A) moet zijn.\r\n\r\nStel (in het geval van gebruik als 'compatibleCharset') je hebt een message met een string en je vraagt message.asStream(defaultCharset):\r\nDan moet je message.compatibleCharset gebruiken (als die er is), of anders defaultCharset, of anders UTF-8.\r\nNa afloop moet message.compatibleCharset niet veranderd zijn, want wat doet het er toe dat je die string een keer geschreven hebt met 'defaultCharset' of UTF-8? \r\nWaarom zou ik een andere keer die string niet met een andere charset mogen schrijven?\r\nIn jouw implementatie wordt nu de charset wel aangepast. Dat is niet goed.\r\n\r\nAls je wijzigingen maakt aan Message, dan moet je daar ook unit tests voor maken die falen op de oude code en goed gaan op de nieuwe.\r\n", "bodyText": "Het charset veld in Message is bedoeld als 'originalCharset', dus:\nJe krijgt bytes binnen van een listener, en die zegt er bij: \"dit waren bytes in deze charset.\nAls je dan naar String gaat converteren, dan moet je die charset gebruiken, (als hij gedefinieerd is).\"\nHet veld wordt ook alleen maar gezet vanuit constructors met een binary request type.\nJij gebruikt nu charset als 'compatibleCharset': \"Ik heb hier een string met bepaalde vreemde characters, als je deze string naar bytes wil converteren, dan zou je deze charset kunnen gebruiken.\"\nHet is maar de vraag of dat zinvol is. Ik denk eigenlijk van niet.\nIn beide gevallen van het gebruik zou het niet zo moeten zijn dat als je string of bytes leest, er iets\nzou moeten veranderen aan de oorspronkelijke charset.\nStel je hebt een message met bytes en je vraagt message.asReader(defaultCharset):\nDan moet je message.originalCharset gebruiken als die er is, of anders defaultCharset, of anders UTF-8.\nAls message.originalCharset leeg was, kan je je afvragen of dat na afloop nog steeds zo moet zijn:\nA) Na afloop moet message.originalCharset niet veranderd zijn, want wat doet het er toe dat je die bytes een keer gelezen hebt met 'defaultCharset' of UTF-8?\nB) Als je message.originalCharset zet op de charset die gebruikt is, dan zal je de volgende keer weer dezelfde charset gebruiken, dat is consistent.\nDe huidge asReader() (elders in Message.java) doet optie B). Ik neig er naar nu te zeggen dat dat eigenlijk niet goed is, dat het eigenlijk A) moet zijn.\nStel (in het geval van gebruik als 'compatibleCharset') je hebt een message met een string en je vraagt message.asStream(defaultCharset):\nDan moet je message.compatibleCharset gebruiken (als die er is), of anders defaultCharset, of anders UTF-8.\nNa afloop moet message.compatibleCharset niet veranderd zijn, want wat doet het er toe dat je die string een keer geschreven hebt met 'defaultCharset' of UTF-8?\nWaarom zou ik een andere keer die string niet met een andere charset mogen schrijven?\nIn jouw implementatie wordt nu de charset wel aangepast. Dat is niet goed.\nAls je wijzigingen maakt aan Message, dan moet je daar ook unit tests voor maken die falen op de oude code en goed gaan op de nieuwe.", "bodyHTML": "<p dir=\"auto\">Het charset veld in Message is bedoeld als 'originalCharset', dus:<br>\nJe krijgt bytes binnen van een listener, en die zegt er bij: \"dit waren bytes in deze charset.<br>\nAls je dan naar String gaat converteren, dan moet je die charset gebruiken, (als hij gedefinieerd is).\"<br>\nHet veld wordt ook alleen maar gezet vanuit constructors met een binary request type.<br>\nJij gebruikt nu charset als 'compatibleCharset': \"Ik heb hier een string met bepaalde vreemde characters, als je deze string naar bytes wil converteren, dan zou je deze charset kunnen gebruiken.\"<br>\nHet is maar de vraag of dat zinvol is. Ik denk eigenlijk van niet.</p>\n<p dir=\"auto\">In beide gevallen van het gebruik zou het niet zo moeten zijn dat als je string of bytes leest, er iets<br>\nzou moeten veranderen aan de oorspronkelijke charset.</p>\n<p dir=\"auto\">Stel je hebt een message met bytes en je vraagt message.asReader(defaultCharset):<br>\nDan moet je message.originalCharset gebruiken als die er is, of anders defaultCharset, of anders UTF-8.<br>\nAls message.originalCharset leeg was, kan je je afvragen of dat na afloop nog steeds zo moet zijn:<br>\nA) Na afloop moet message.originalCharset niet veranderd zijn, want wat doet het er toe dat je die bytes een keer gelezen hebt met 'defaultCharset' of UTF-8?<br>\nB) Als je message.originalCharset zet op de charset die gebruikt is, dan zal je de volgende keer weer dezelfde charset gebruiken, dat is consistent.<br>\nDe huidge asReader() (elders in Message.java) doet optie B). Ik neig er naar nu te zeggen dat dat eigenlijk niet goed is, dat het eigenlijk A) moet zijn.</p>\n<p dir=\"auto\">Stel (in het geval van gebruik als 'compatibleCharset') je hebt een message met een string en je vraagt message.asStream(defaultCharset):<br>\nDan moet je message.compatibleCharset gebruiken (als die er is), of anders defaultCharset, of anders UTF-8.<br>\nNa afloop moet message.compatibleCharset niet veranderd zijn, want wat doet het er toe dat je die string een keer geschreven hebt met 'defaultCharset' of UTF-8?<br>\nWaarom zou ik een andere keer die string niet met een andere charset mogen schrijven?<br>\nIn jouw implementatie wordt nu de charset wel aangepast. Dat is niet goed.</p>\n<p dir=\"auto\">Als je wijzigingen maakt aan Message, dan moet je daar ook unit tests voor maken die falen op de oude code en goed gaan op de nieuwe.</p>", "author": "gvanbrakel", "createdAt": "2020-11-20T16:33:15Z", "path": "core/src/main/java/nl/nn/adapterframework/stream/Message.java", "diffHunk": "@@ -209,19 +209,19 @@ public InputStream asInputStream(String defaultCharset) throws IOException {\n \t\t\t\tthrow new IOException(\"Cannot open file [\"+((File)request).getPath()+\"]\");\n \t\t\t}\n \t\t}\n-\t\tif (StringUtils.isEmpty(defaultCharset)) {\n-\t\t\tdefaultCharset=StreamUtil.DEFAULT_INPUT_STREAM_ENCODING;\n+\t\tif (StringUtils.isEmpty(charset)) {\n+\t\t\tcharset=StringUtils.isNotEmpty(defaultCharset)?defaultCharset:StreamUtil.DEFAULT_INPUT_STREAM_ENCODING;", "originalCommit": "9c8fce309899fd7d762a54486bbaef22e52463e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1NDk2MQ==", "url": "https://github.com/ibissource/iaf/pull/1281#discussion_r527854961", "body": "Charset kan worden gezet bij 'encode', reading from string, **any outputtype**: om de juiste karakters uit de string te krijgen.\r\nCharset kan worden gezet bij 'decode', om aan te geven wat de juiste string representatie van de binary data is.\r\nCharset zou alleen gebruikt moeten worden aan de binary kant van de codec, aan de base64 kant zou altijd de default charset gebruikt moeten worden (dus geen charset moeten worden opgegeven).\r\nOutputtype zou je eventueel helemaal weg kunnen laten.\r\n\r\nDus volgens mij:\r\n- charset alleen gebruiken aan de binary kant;\r\n- outputtype deprecaten", "bodyText": "Charset kan worden gezet bij 'encode', reading from string, any outputtype: om de juiste karakters uit de string te krijgen.\nCharset kan worden gezet bij 'decode', om aan te geven wat de juiste string representatie van de binary data is.\nCharset zou alleen gebruikt moeten worden aan de binary kant van de codec, aan de base64 kant zou altijd de default charset gebruikt moeten worden (dus geen charset moeten worden opgegeven).\nOutputtype zou je eventueel helemaal weg kunnen laten.\nDus volgens mij:\n\ncharset alleen gebruiken aan de binary kant;\noutputtype deprecaten", "bodyHTML": "<p dir=\"auto\">Charset kan worden gezet bij 'encode', reading from string, <strong>any outputtype</strong>: om de juiste karakters uit de string te krijgen.<br>\nCharset kan worden gezet bij 'decode', om aan te geven wat de juiste string representatie van de binary data is.<br>\nCharset zou alleen gebruikt moeten worden aan de binary kant van de codec, aan de base64 kant zou altijd de default charset gebruikt moeten worden (dus geen charset moeten worden opgegeven).<br>\nOutputtype zou je eventueel helemaal weg kunnen laten.</p>\n<p dir=\"auto\">Dus volgens mij:</p>\n<ul dir=\"auto\">\n<li>charset alleen gebruiken aan de binary kant;</li>\n<li>outputtype deprecaten</li>\n</ul>", "author": "gvanbrakel", "createdAt": "2020-11-20T17:35:04Z", "path": "core/src/main/java/nl/nn/adapterframework/pipes/Base64Pipe.java", "diffHunk": "@@ -89,6 +91,15 @@ public void configure() throws ConfigurationException {\n \t\tif(!convertToString && getDirection().equals(\"decode\")) {\n \t\t\tsetOutputType(\"bytes\");\n \t\t}\n+\n+\t\tif(charset == null) {\n+\t\t\tif(outputType.equals(\"string\")) {\n+\t\t\t\tcharset = StreamUtil.DEFAULT_INPUT_STREAM_ENCODING;\n+\t\t\t\tConfigurationWarnings.add(this, log, \"please consider changing the output type to bytes or stream instead\"); //if charset not set, why use strings?\n+\t\t\t}\n+\t\t} else if(!outputType.equals(\"string\")) {\n+\t\t\tConfigurationWarnings.add(this, log, \"charset can only be set when outputType='string'\");", "originalCommit": "9c8fce309899fd7d762a54486bbaef22e52463e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzg1NzAzMw==", "url": "https://github.com/ibissource/iaf/pull/1281#discussion_r527857033", "body": "eigenlijk: consider om de default output-type te gebruiken.", "bodyText": "eigenlijk: consider om de default output-type te gebruiken.", "bodyHTML": "<p dir=\"auto\">eigenlijk: consider om de default output-type te gebruiken.</p>", "author": "gvanbrakel", "createdAt": "2020-11-20T17:37:34Z", "path": "core/src/main/java/nl/nn/adapterframework/pipes/Base64Pipe.java", "diffHunk": "@@ -89,6 +91,15 @@ public void configure() throws ConfigurationException {\n \t\tif(!convertToString && getDirection().equals(\"decode\")) {\n \t\t\tsetOutputType(\"bytes\");\n \t\t}\n+\n+\t\tif(charset == null) {\n+\t\t\tif(outputType.equals(\"string\")) {\n+\t\t\t\tcharset = StreamUtil.DEFAULT_INPUT_STREAM_ENCODING;\n+\t\t\t\tConfigurationWarnings.add(this, log, \"please consider changing the output type to bytes or stream instead\"); //if charset not set, why use strings?", "originalCommit": "9c8fce309899fd7d762a54486bbaef22e52463e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bf96f457d5d4cb89b72fa46a8ba9ec2419bb2455", "url": "https://github.com/ibissource/iaf/commit/bf96f457d5d4cb89b72fa46a8ba9ec2419bb2455", "message": "Revert changes to Message asInputStream", "committedDate": "2020-11-23T13:58:09Z", "type": "commit"}, {"oid": "b4b1663df0e38fe0715b33ab07bb93b04ec4bdfc", "url": "https://github.com/ibissource/iaf/commit/b4b1663df0e38fe0715b33ab07bb93b04ec4bdfc", "message": "set default back to string", "committedDate": "2020-11-24T14:08:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MTIzNw==", "url": "https://github.com/ibissource/iaf/pull/1281#discussion_r530241237", "body": "De default moet steam zijn, en alleen string gebruiken als `charset` gezet is.", "bodyText": "De default moet steam zijn, en alleen string gebruiken als charset gezet is.", "bodyHTML": "<p dir=\"auto\">De default moet steam zijn, en alleen string gebruiken als <code>charset</code> gezet is.</p>", "author": "nielsm5", "createdAt": "2020-11-25T09:52:08Z", "path": "core/src/main/java/nl/nn/adapterframework/pipes/Base64Pipe.java", "diffHunk": "@@ -55,7 +55,7 @@\n \tprivate int lineLength = 76;\n \tprivate String lineSeparator = \"auto\";\n \tprivate String charset = null;\n-\tprivate String outputType = \"stream\";\n+\tprivate String outputType = \"string\";", "originalCommit": "b4b1663df0e38fe0715b33ab07bb93b04ec4bdfc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e4d37caf16a548cd005e1063164a3be1e263c02", "url": "https://github.com/ibissource/iaf/commit/5e4d37caf16a548cd005e1063164a3be1e263c02", "message": "restore original test input and output", "committedDate": "2020-11-27T10:53:08Z", "type": "commit"}, {"oid": "bbcda9427ab6ee984a2b17fb1e87d00cb0a0177a", "url": "https://github.com/ibissource/iaf/commit/bbcda9427ab6ee984a2b17fb1e87d00cb0a0177a", "message": "Suppress warnings", "committedDate": "2020-11-27T10:59:11Z", "type": "commit"}]}