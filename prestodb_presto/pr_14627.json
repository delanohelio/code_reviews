{"pr_number": 14627, "pr_title": "Fix missing nested streams due to column name mismatch", "pr_author": "bhhari", "pr_createdAt": "2020-06-09T21:21:05Z", "pr_url": "https://github.com/prestodb/presto/pull/14627", "timeline": [{"oid": "4282d6258382e2ab0bb1e60a8f4958180b2b8505", "url": "https://github.com/prestodb/presto/commit/4282d6258382e2ab0bb1e60a8f4958180b2b8505", "message": "Fix missing nested streams due to column name mismatch\n\nIn StripeReader we read only required nested streams\nby matching the requested nested field name to the name persisted.\nWhen written by other compute engines the name persisted can be\nuppercase which causes mismatch. Case conversion of persisted name fixes this.", "committedDate": "2020-06-10T03:15:04Z", "type": "forcePushed"}, {"oid": "503260d63f4f3212bd119c5f638b1604babbdb52", "url": "https://github.com/prestodb/presto/commit/503260d63f4f3212bd119c5f638b1604babbdb52", "message": "Fix missing nested streams due to column name mismatch\n\nIn StripeReader we read only required nested streams\nby matching the requested nested field name to the name persisted.\nWhen written by other compute engines the name persisted can be\nuppercase which causes mismatch. Case conversion of persisted name fixes this.", "committedDate": "2020-06-10T03:17:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NTEzMw==", "url": "https://github.com/prestodb/presto/pull/14627#discussion_r437985133", "body": "@bhhari Thanks for adding a test. A few nits:\r\n\r\n- name the table test_xxx for consistency, e.g. test_struct_with_uppercase_fields\r\n- add .dwrf extension to the file name for clarify, e.g. struct_with_uppercase_fields.dwrf\r\n- add space after // in comments for readability, e.g. // path to vs. //path to\r\n- fileWrittenBySpark -> sparkFile and oldFilePath -> prestoFile for clarity\r\n- move sparkFile variable closer to where it is used\r\n- run the same set of queries with presto and spark files\r\n- Files.copy statement can be shortened to `Files.copy(sparkFile, prestoPath);`\r\n- delete the test table when done\r\n\r\n```\r\n    @Test\r\n    public void testUpperCaseStructFields()\r\n            throws Exception\r\n    {\r\n        assertUpdate(\"CREATE TABLE test_struct_with_uppercase_field(field0) WITH (FORMAT = 'DWRF') AS \" +\r\n                \"SELECT CAST((1, 1) AS ROW(SUBFIELDCAP BIGINT, subfieldsmall BIGINT))\", 1);\r\n\r\n        try {\r\n            assertQuery(\"SELECT * FROM test_struct_with_uppercase_field\", \"SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))\");\r\n            assertQuery(\"SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\r\n            assertQuery(\"SELECT field0.subfieldcap FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\r\n\r\n            // delete the file written by Presto and corresponding crc file\r\n            Path prestoPath = getOnlyPath(\"test_struct_with_uppercase_field\");\r\n            Files.delete(prestoPath);\r\n            Files.deleteIfExists(prestoPath.getParent().resolve(\".\" + prestoPath.getFileName() + \".crc\"));\r\n\r\n            // copy the file written by Spark\r\n            Path sparkFile = Paths.get(this.getClass().getClassLoader().getResource(\"struct_with_uppercase_field.dwrf\").toURI());\r\n            Files.copy(sparkFile, prestoPath);\r\n\r\n            assertQuery(\"SELECT * FROM test_struct_with_uppercase_field\", \"SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))\");\r\n            assertQuery(\"SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\r\n            assertQuery(\"SELECT field0.subfieldcap FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\r\n        } finally {\r\n            assertUpdate(\"DROP TABLE test_struct_with_uppercase_field\");\r\n        }\r\n    }\r\n\r\n```", "bodyText": "@bhhari Thanks for adding a test. A few nits:\n\nname the table test_xxx for consistency, e.g. test_struct_with_uppercase_fields\nadd .dwrf extension to the file name for clarify, e.g. struct_with_uppercase_fields.dwrf\nadd space after // in comments for readability, e.g. // path to vs. //path to\nfileWrittenBySpark -> sparkFile and oldFilePath -> prestoFile for clarity\nmove sparkFile variable closer to where it is used\nrun the same set of queries with presto and spark files\nFiles.copy statement can be shortened to Files.copy(sparkFile, prestoPath);\ndelete the test table when done\n\n    @Test\n    public void testUpperCaseStructFields()\n            throws Exception\n    {\n        assertUpdate(\"CREATE TABLE test_struct_with_uppercase_field(field0) WITH (FORMAT = 'DWRF') AS \" +\n                \"SELECT CAST((1, 1) AS ROW(SUBFIELDCAP BIGINT, subfieldsmall BIGINT))\", 1);\n\n        try {\n            assertQuery(\"SELECT * FROM test_struct_with_uppercase_field\", \"SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))\");\n            assertQuery(\"SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n            assertQuery(\"SELECT field0.subfieldcap FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n\n            // delete the file written by Presto and corresponding crc file\n            Path prestoPath = getOnlyPath(\"test_struct_with_uppercase_field\");\n            Files.delete(prestoPath);\n            Files.deleteIfExists(prestoPath.getParent().resolve(\".\" + prestoPath.getFileName() + \".crc\"));\n\n            // copy the file written by Spark\n            Path sparkFile = Paths.get(this.getClass().getClassLoader().getResource(\"struct_with_uppercase_field.dwrf\").toURI());\n            Files.copy(sparkFile, prestoPath);\n\n            assertQuery(\"SELECT * FROM test_struct_with_uppercase_field\", \"SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))\");\n            assertQuery(\"SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n            assertQuery(\"SELECT field0.subfieldcap FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n        } finally {\n            assertUpdate(\"DROP TABLE test_struct_with_uppercase_field\");\n        }\n    }", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/bhhari/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/bhhari\">@bhhari</a> Thanks for adding a test. A few nits:</p>\n<ul dir=\"auto\">\n<li>name the table test_xxx for consistency, e.g. test_struct_with_uppercase_fields</li>\n<li>add .dwrf extension to the file name for clarify, e.g. struct_with_uppercase_fields.dwrf</li>\n<li>add space after // in comments for readability, e.g. // path to vs. //path to</li>\n<li>fileWrittenBySpark -&gt; sparkFile and oldFilePath -&gt; prestoFile for clarity</li>\n<li>move sparkFile variable closer to where it is used</li>\n<li>run the same set of queries with presto and spark files</li>\n<li>Files.copy statement can be shortened to <code>Files.copy(sparkFile, prestoPath);</code></li>\n<li>delete the test table when done</li>\n</ul>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    @Test\n    public void testUpperCaseStructFields()\n            throws Exception\n    {\n        assertUpdate(&quot;CREATE TABLE test_struct_with_uppercase_field(field0) WITH (FORMAT = 'DWRF') AS &quot; +\n                &quot;SELECT CAST((1, 1) AS ROW(SUBFIELDCAP BIGINT, subfieldsmall BIGINT))&quot;, 1);\n\n        try {\n            assertQuery(&quot;SELECT * FROM test_struct_with_uppercase_field&quot;, &quot;SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))&quot;);\n            assertQuery(&quot;SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field&quot;, &quot;SELECT CAST(1 AS BIGINT)&quot;);\n            assertQuery(&quot;SELECT field0.subfieldcap FROM test_struct_with_uppercase_field&quot;, &quot;SELECT CAST(1 AS BIGINT)&quot;);\n\n            // delete the file written by Presto and corresponding crc file\n            Path prestoPath = getOnlyPath(&quot;test_struct_with_uppercase_field&quot;);\n            Files.delete(prestoPath);\n            Files.deleteIfExists(prestoPath.getParent().resolve(&quot;.&quot; + prestoPath.getFileName() + &quot;.crc&quot;));\n\n            // copy the file written by Spark\n            Path sparkFile = Paths.get(this.getClass().getClassLoader().getResource(&quot;struct_with_uppercase_field.dwrf&quot;).toURI());\n            Files.copy(sparkFile, prestoPath);\n\n            assertQuery(&quot;SELECT * FROM test_struct_with_uppercase_field&quot;, &quot;SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))&quot;);\n            assertQuery(&quot;SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field&quot;, &quot;SELECT CAST(1 AS BIGINT)&quot;);\n            assertQuery(&quot;SELECT field0.subfieldcap FROM test_struct_with_uppercase_field&quot;, &quot;SELECT CAST(1 AS BIGINT)&quot;);\n        } finally {\n            assertUpdate(&quot;DROP TABLE test_struct_with_uppercase_field&quot;);\n        }\n    }\n\"><pre><code>    @Test\n    public void testUpperCaseStructFields()\n            throws Exception\n    {\n        assertUpdate(\"CREATE TABLE test_struct_with_uppercase_field(field0) WITH (FORMAT = 'DWRF') AS \" +\n                \"SELECT CAST((1, 1) AS ROW(SUBFIELDCAP BIGINT, subfieldsmall BIGINT))\", 1);\n\n        try {\n            assertQuery(\"SELECT * FROM test_struct_with_uppercase_field\", \"SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))\");\n            assertQuery(\"SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n            assertQuery(\"SELECT field0.subfieldcap FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n\n            // delete the file written by Presto and corresponding crc file\n            Path prestoPath = getOnlyPath(\"test_struct_with_uppercase_field\");\n            Files.delete(prestoPath);\n            Files.deleteIfExists(prestoPath.getParent().resolve(\".\" + prestoPath.getFileName() + \".crc\"));\n\n            // copy the file written by Spark\n            Path sparkFile = Paths.get(this.getClass().getClassLoader().getResource(\"struct_with_uppercase_field.dwrf\").toURI());\n            Files.copy(sparkFile, prestoPath);\n\n            assertQuery(\"SELECT * FROM test_struct_with_uppercase_field\", \"SELECT (CAST(1 AS BIGINT), CAST(1 AS BIGINT))\");\n            assertQuery(\"SELECT field0.SUBFIELDCAP FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n            assertQuery(\"SELECT field0.subfieldcap FROM test_struct_with_uppercase_field\", \"SELECT CAST(1 AS BIGINT)\");\n        } finally {\n            assertUpdate(\"DROP TABLE test_struct_with_uppercase_field\");\n        }\n    }\n\n</code></pre></div>", "author": "mbasmanova", "createdAt": "2020-06-10T09:23:16Z", "path": "presto-hive/src/test/java/com/facebook/presto/hive/TestHivePushdownFilterQueries.java", "diffHunk": "@@ -895,6 +895,25 @@ public void testStructSchemaEvolution()\n         assertQuery(\"SELECT count(*) FROM test_struct_add_column where x.c = 1\", \"SELECT 0\");\n     }\n \n+    @Test\n+    public void testStructFieldsIgnoreCase()", "originalCommit": "503260d63f4f3212bd119c5f638b1604babbdb52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI4MTIwMA==", "url": "https://github.com/prestodb/presto/pull/14627#discussion_r438281200", "bodyText": "thanks @mbasmanova, will update the test", "author": "bhhari", "createdAt": "2020-06-10T17:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NTEzMw=="}], "type": "inlineReview"}, {"oid": "1609c0d26c745c1fd68a07602d3dc25e39d724f8", "url": "https://github.com/prestodb/presto/commit/1609c0d26c745c1fd68a07602d3dc25e39d724f8", "message": "Fix missing nested streams due to column name mismatch\n\nIn StripeReader we read only required nested streams\nby matching the requested nested field name to the name persisted.\nWhen written by other compute engines the name persisted can be\nuppercase which causes mismatch. Case conversion of persisted name fixes this.", "committedDate": "2020-06-10T17:17:08Z", "type": "commit"}, {"oid": "1609c0d26c745c1fd68a07602d3dc25e39d724f8", "url": "https://github.com/prestodb/presto/commit/1609c0d26c745c1fd68a07602d3dc25e39d724f8", "message": "Fix missing nested streams due to column name mismatch\n\nIn StripeReader we read only required nested streams\nby matching the requested nested field name to the name persisted.\nWhen written by other compute engines the name persisted can be\nuppercase which causes mismatch. Case conversion of persisted name fixes this.", "committedDate": "2020-06-10T17:17:08Z", "type": "forcePushed"}]}