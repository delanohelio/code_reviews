{"pr_number": 14191, "pr_title": "Add tracking of memory allocation per operator", "pr_author": "mbasmanova", "pr_createdAt": "2020-03-02T21:45:26Z", "pr_url": "https://github.com/prestodb/presto/pull/14191", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2MTI0NA==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r386761244", "body": "- This is simpler to understand  :) \r\n     `!(trackOverallAllocation && THREAD_MX_BEAN_EX == null)`  \r\n    `!(trackOperationAllocation && !trackOverallAllocation)` \r\n- Move second check up\r\n\r\n", "bodyText": "This is simpler to understand  :)\n!(trackOverallAllocation && THREAD_MX_BEAN_EX == null)\n!(trackOperationAllocation && !trackOverallAllocation)\nMove second check up", "bodyHTML": "<ul dir=\"auto\">\n<li>This is simpler to understand  :)<br>\n<code>!(trackOverallAllocation &amp;&amp; THREAD_MX_BEAN_EX == null)</code><br>\n<code>!(trackOperationAllocation &amp;&amp; !trackOverallAllocation)</code></li>\n<li>Move second check up</li>\n</ul>", "author": "viczhang861", "createdAt": "2020-03-03T02:07:49Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/OperationTimer.java", "diffHunk": "@@ -53,11 +60,18 @@\n         this.trackOperationCpuTime = trackOperationCpuTime;\n         checkArgument(trackOverallCpuTime || !trackOperationCpuTime, \"tracking operation cpu time without tracking overall cpu time is not supported\");\n \n+        this.trackOverallAllocation = trackOverallAllocation;\n+        this.trackOperationAllocation = trackOperationAllocation;\n+        checkArgument(trackOverallAllocation || !trackOperationAllocation, \"tracking operation allocation without tracking overall allocation is not supported\");\n+        checkArgument(!trackOverallAllocation || THREAD_MX_BEAN_EX != null, \"tracking allocation is not supported by this JVM\");", "originalCommit": "9417e754d3cb6cb396acc8ff04535e52fbe9fed8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzA4NTU2OQ==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387085569", "bodyText": "@viczhang861 Changed to\n        this.trackOverallAllocation = trackOverallAllocation;\n        this.trackOperationAllocation = trackOperationAllocation;\n        if (trackOverallAllocation) {\n            checkArgument(THREAD_MX_BEAN_EX != null, \"tracking allocation is not supported by this JVM\");\n        }\n        else {\n            checkArgument(!trackOperationCpuTime, \"tracking operation cpu time without tracking overall cpu time is not supported\");\n        }", "author": "mbasmanova", "createdAt": "2020-03-03T15:11:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2MTI0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3NjQ1Nw==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387176457", "bodyText": "Much better. I restarted a failed test.", "author": "viczhang861", "createdAt": "2020-03-03T17:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njc2MTI0NA=="}], "type": "inlineReview"}, {"oid": "0bf4e22bb290be285d44681c544a99fead60e64f", "url": "https://github.com/prestodb/presto/commit/0bf4e22bb290be285d44681c544a99fead60e64f", "message": "Add allocation info to Task/Stage/QueryStats", "committedDate": "2020-03-03T15:07:34Z", "type": "forcePushed"}, {"oid": "99bfadc6033f7e930a764b8787be7e3dacea4305", "url": "https://github.com/prestodb/presto/commit/99bfadc6033f7e930a764b8787be7e3dacea4305", "message": "Add allocation info to Task/Stage/QueryStats", "committedDate": "2020-03-03T15:10:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNDM1Mw==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387314353", "body": "nit: maybe better `allocationTracker`? The word `timer` is used for the `CPU` because the CPU utilization is measured in \"time\" units (e.g.: milliseconds) ", "bodyText": "nit: maybe better allocationTracker? The word timer is used for the CPU because the CPU utilization is measured in \"time\" units (e.g.: milliseconds)", "bodyHTML": "<p dir=\"auto\">nit: maybe better <code>allocationTracker</code>? The word <code>timer</code> is used for the <code>CPU</code> because the CPU utilization is measured in \"time\" units (e.g.: milliseconds)</p>", "author": "arhimondr", "createdAt": "2020-03-03T21:49:16Z", "path": "presto-main/src/main/java/com/facebook/presto/execution/TaskManagerConfig.java", "diffHunk": "@@ -44,6 +44,8 @@\n     private boolean perOperatorCpuTimerEnabled = true;\n     private boolean taskCpuTimerEnabled = true;\n     private boolean statisticsCpuTimerEnabled = true;\n+    private boolean perOperatorAllocationTimerEnabled = true;", "originalCommit": "065566f8f9f01b422b3e30999ca90419489212e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxOTQ2OA==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387319468", "body": "Currently Presto does not support any other VM's than Oracle JVM. How about just trying to cast `((com.sun.management.ThreadMXBean) THREAD_MX_BEAN)` unconditionally inplace. In will throw a meaningful `ClassCastException` if for some very weird reson some other then `com.sun.management.ThreadMXBean` implementation is supplied. ", "bodyText": "Currently Presto does not support any other VM's than Oracle JVM. How about just trying to cast ((com.sun.management.ThreadMXBean) THREAD_MX_BEAN) unconditionally inplace. In will throw a meaningful ClassCastException if for some very weird reson some other then com.sun.management.ThreadMXBean implementation is supplied.", "bodyHTML": "<p dir=\"auto\">Currently Presto does not support any other VM's than Oracle JVM. How about just trying to cast <code>((com.sun.management.ThreadMXBean) THREAD_MX_BEAN)</code> unconditionally inplace. In will throw a meaningful <code>ClassCastException</code> if for some very weird reson some other then <code>com.sun.management.ThreadMXBean</code> implementation is supplied.</p>", "author": "arhimondr", "createdAt": "2020-03-03T21:59:27Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/OperationTimer.java", "diffHunk": "@@ -53,11 +60,22 @@\n         this.trackOperationCpuTime = trackOperationCpuTime;\n         checkArgument(trackOverallCpuTime || !trackOperationCpuTime, \"tracking operation cpu time without tracking overall cpu time is not supported\");\n \n+        this.trackOverallAllocation = trackOverallAllocation;\n+        this.trackOperationAllocation = trackOperationAllocation;\n+        if (trackOverallAllocation) {\n+            checkArgument(THREAD_MX_BEAN_EX != null, \"tracking allocation is not supported by this JVM\");", "originalCommit": "dff02fca12caf9e15655f9b983c7c9775cc5e793", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxOTc1Ng==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387319756", "body": "`tracking operator allocations without ...`", "bodyText": "tracking operator allocations without ...", "bodyHTML": "<p dir=\"auto\"><code>tracking operator allocations without ...</code></p>", "author": "arhimondr", "createdAt": "2020-03-03T22:00:02Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/OperationTimer.java", "diffHunk": "@@ -53,11 +60,22 @@\n         this.trackOperationCpuTime = trackOperationCpuTime;\n         checkArgument(trackOverallCpuTime || !trackOperationCpuTime, \"tracking operation cpu time without tracking overall cpu time is not supported\");\n \n+        this.trackOverallAllocation = trackOverallAllocation;\n+        this.trackOperationAllocation = trackOperationAllocation;\n+        if (trackOverallAllocation) {\n+            checkArgument(THREAD_MX_BEAN_EX != null, \"tracking allocation is not supported by this JVM\");\n+        }\n+        else {\n+            checkArgument(!trackOperationCpuTime, \"tracking operation cpu time without tracking overall cpu time is not supported\");", "originalCommit": "dff02fca12caf9e15655f9b983c7c9775cc5e793", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "85294107e733d5a8c6d92a8d5df090aaa96980c7", "url": "https://github.com/prestodb/presto/commit/85294107e733d5a8c6d92a8d5df090aaa96980c7", "message": "Add allocation info to Task/Stage/QueryStats", "committedDate": "2020-03-03T22:17:09Z", "type": "forcePushed"}, {"oid": "0c8a8299e7fc76ae41428331700ef2a714587e12", "url": "https://github.com/prestodb/presto/commit/0c8a8299e7fc76ae41428331700ef2a714587e12", "message": "Add config properties to enable tracking memory allocations", "committedDate": "2020-03-03T22:21:15Z", "type": "commit"}, {"oid": "632113214b2d92b0df700e76c403165d31e49ebc", "url": "https://github.com/prestodb/presto/commit/632113214b2d92b0df700e76c403165d31e49ebc", "message": "Add allocation info to Task/Stage/QueryStats", "committedDate": "2020-03-03T22:21:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzQ4OQ==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387973489", "body": "Still says timer", "bodyText": "Still says timer", "bodyHTML": "<p dir=\"auto\">Still says timer</p>", "author": "aweisberg", "createdAt": "2020-03-04T22:29:33Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/TaskContext.java", "diffHunk": "@@ -113,6 +116,8 @@ public static TaskContext createTaskContext(\n             MemoryTrackingContext taskMemoryContext,\n             boolean perOperatorCpuTimerEnabled,\n             boolean cpuTimerEnabled,\n+            boolean perOperatorAllocationTimerEnabled,\n+            boolean allocationTimerEnabled,", "originalCommit": "632113214b2d92b0df700e76c403165d31e49ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3Mzg3OA==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387973878", "body": "Timer here as well", "bodyText": "Timer here as well", "bodyHTML": "<p dir=\"auto\">Timer here as well</p>", "author": "aweisberg", "createdAt": "2020-03-04T22:30:31Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecutorFactory.java", "diffHunk": "@@ -135,7 +140,9 @@ public PrestoSparkTaskExecutorFactory(\n             DataSize maxSpillMemory,\n             DataSize sinkMaxBufferSize,\n             boolean perOperatorCpuTimerEnabled,\n-            boolean cpuTimerEnabled)\n+            boolean cpuTimerEnabled,\n+            boolean perOperatorAllocationTimerEnabled,\n+            boolean allocationTimerEnabled)", "originalCommit": "632113214b2d92b0df700e76c403165d31e49ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3Mzk0MA==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387973940", "body": "And these two", "bodyText": "And these two", "bodyHTML": "<p dir=\"auto\">And these two</p>", "author": "aweisberg", "createdAt": "2020-03-04T22:30:40Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecutorFactory.java", "diffHunk": "@@ -149,6 +156,8 @@ public PrestoSparkTaskExecutorFactory(\n         this.sinkMaxBufferSize = requireNonNull(sinkMaxBufferSize, \"sinkMaxBufferSize is null\");\n         this.perOperatorCpuTimerEnabled = perOperatorCpuTimerEnabled;\n         this.cpuTimerEnabled = cpuTimerEnabled;\n+        this.perOperatorAllocationTimerEnabled = perOperatorAllocationTimerEnabled;\n+        this.allocationTimerEnabled = allocationTimerEnabled;", "originalCommit": "632113214b2d92b0df700e76c403165d31e49ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDA4MA==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387974080", "body": "Last one!", "bodyText": "Last one!", "bodyHTML": "<p dir=\"auto\">Last one!</p>", "author": "aweisberg", "createdAt": "2020-03-04T22:30:54Z", "path": "presto-spark-base/src/main/java/com/facebook/presto/spark/execution/PrestoSparkTaskExecutorFactory.java", "diffHunk": "@@ -192,6 +201,8 @@ public IPrestoSparkTaskExecutor create(\n                 session,\n                 perOperatorCpuTimerEnabled,\n                 cpuTimerEnabled,\n+                perOperatorAllocationTimerEnabled,\n+                allocationTimerEnabled,", "originalCommit": "632113214b2d92b0df700e76c403165d31e49ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDM5OQ==", "url": "https://github.com/prestodb/presto/pull/14191#discussion_r387974399", "body": "Timer", "bodyText": "Timer", "bodyHTML": "<p dir=\"auto\">Timer</p>", "author": "aweisberg", "createdAt": "2020-03-04T22:31:44Z", "path": "presto-main/src/main/java/com/facebook/presto/operator/TaskContext.java", "diffHunk": "@@ -125,6 +130,8 @@ public static TaskContext createTaskContext(\n                 taskMemoryContext,\n                 perOperatorCpuTimerEnabled,\n                 cpuTimerEnabled,\n+                perOperatorAllocationTimerEnabled,\n+                allocationTimerEnabled,", "originalCommit": "632113214b2d92b0df700e76c403165d31e49ebc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "83c5628ae11d68b76509f3a0873e81cb5585f2e1", "url": "https://github.com/prestodb/presto/commit/83c5628ae11d68b76509f3a0873e81cb5585f2e1", "message": "Propagate flags to track allocation to OperationTimer", "committedDate": "2020-03-05T10:55:11Z", "type": "commit"}, {"oid": "1715ef3f694b090f61ce0b7ea934d25a5832b648", "url": "https://github.com/prestodb/presto/commit/1715ef3f694b090f61ce0b7ea934d25a5832b648", "message": "Track allocations per operator", "committedDate": "2020-03-05T10:55:11Z", "type": "commit"}, {"oid": "95fb2be242513e33337e0b2616be5d3250569f9d", "url": "https://github.com/prestodb/presto/commit/95fb2be242513e33337e0b2616be5d3250569f9d", "message": "Add allocation info to OperatorStats", "committedDate": "2020-03-05T10:55:11Z", "type": "commit"}, {"oid": "d1dce980fb506c077a43b4fb875b50a7338e97b7", "url": "https://github.com/prestodb/presto/commit/d1dce980fb506c077a43b4fb875b50a7338e97b7", "message": "Refactor TestQueryStats", "committedDate": "2020-03-05T10:55:11Z", "type": "commit"}, {"oid": "5d2dc4c5ec6686d1f2ad70a5dae17b29fc166d2b", "url": "https://github.com/prestodb/presto/commit/5d2dc4c5ec6686d1f2ad70a5dae17b29fc166d2b", "message": "Add allocation into to DriverStats", "committedDate": "2020-03-05T10:55:12Z", "type": "commit"}, {"oid": "30b8761a400fc89882dc34f11e929230abb4d37f", "url": "https://github.com/prestodb/presto/commit/30b8761a400fc89882dc34f11e929230abb4d37f", "message": "Add allocation info to PipelineStats", "committedDate": "2020-03-05T10:55:12Z", "type": "commit"}, {"oid": "7caf111a8917bb7601286791b5dbe90a69ad118e", "url": "https://github.com/prestodb/presto/commit/7caf111a8917bb7601286791b5dbe90a69ad118e", "message": "Add allocation info to Task/Stage/QueryStats", "committedDate": "2020-03-05T10:55:12Z", "type": "commit"}, {"oid": "7caf111a8917bb7601286791b5dbe90a69ad118e", "url": "https://github.com/prestodb/presto/commit/7caf111a8917bb7601286791b5dbe90a69ad118e", "message": "Add allocation info to Task/Stage/QueryStats", "committedDate": "2020-03-05T10:55:12Z", "type": "forcePushed"}]}