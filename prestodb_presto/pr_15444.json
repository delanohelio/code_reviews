{"pr_number": 15444, "pr_title": "Add UDF to map enum value to key", "pr_author": "daniel-ohayon", "pr_createdAt": "2020-11-17T00:39:56Z", "pr_url": "https://github.com/prestodb/presto/pull/15444", "timeline": [{"oid": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "url": "https://github.com/prestodb/presto/commit/d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "message": "Add UDF to map enum value to key", "committedDate": "2020-11-17T17:02:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjQxODAzMQ==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r526418031", "body": "If you want to further improve the performance, we can make this map lazily instantiated. Add an `AtomicBoolean` to mark whether the map is instantiated, and create it on first call of `getKeyForValue`. That way, if the query doesn't need it, you don't need to create this.", "bodyText": "If you want to further improve the performance, we can make this map lazily instantiated. Add an AtomicBoolean to mark whether the map is instantiated, and create it on first call of getKeyForValue. That way, if the query doesn't need it, you don't need to create this.", "bodyHTML": "<p dir=\"auto\">If you want to further improve the performance, we can make this map lazily instantiated. Add an <code>AtomicBoolean</code> to mark whether the map is instantiated, and create it on first call of <code>getKeyForValue</code>. That way, if the query doesn't need it, you don't need to create this.</p>", "author": "rongrong", "createdAt": "2020-11-18T21:02:06Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +80,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private final Map<Long, String> flippedEnumMap;\n \n         @JsonCreator\n         public LongEnumMap(@JsonProperty(\"enumMap\") Map<String, Long> enumMap)\n         {\n             validateEnumMap(enumMap);\n             this.enumMap = normalizeEnumMap(enumMap);\n+            this.flippedEnumMap = this.enumMap.entrySet().stream()", "originalCommit": "d5128f2e660d2ffdff9f6e221451b113d1f3f7b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "url": "https://github.com/prestodb/presto/commit/a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "message": "Add UDF to map enum value to key", "committedDate": "2020-11-19T04:15:21Z", "type": "commit"}, {"oid": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "url": "https://github.com/prestodb/presto/commit/a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "message": "Add UDF to map enum value to key", "committedDate": "2020-11-19T04:15:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2OTgzMw==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527069833", "body": "You can simply use the existing guava feature.\r\n```Java\r\nprivate Supplier<Map<Long, String>> flippedEnumMap = Supplier.memorize(this::getKeyForValue);\r\n```\r\n\r\naccording to its Javadoc\r\n> Returns a supplier which caches the instance retrieved during the first call to {@code get()} and returns that value on subsequent calls to {@code get()}", "bodyText": "You can simply use the existing guava feature.\nprivate Supplier<Map<Long, String>> flippedEnumMap = Supplier.memorize(this::getKeyForValue);\naccording to its Javadoc\n\nReturns a supplier which caches the instance retrieved during the first call to {@code get()} and returns that value on subsequent calls to {@code get()}", "bodyHTML": "<p dir=\"auto\">You can simply use the existing guava feature.</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"private Supplier&lt;Map&lt;Long, String&gt;&gt; flippedEnumMap = Supplier.memorize(this::getKeyForValue);\"><pre><span class=\"pl-k\">private</span> <span class=\"pl-k\">Supplier&lt;<span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">Long</span>, <span class=\"pl-smi\">String</span>&gt;</span>&gt;</span> flippedEnumMap <span class=\"pl-k\">=</span> <span class=\"pl-smi\">Supplier</span><span class=\"pl-k\">.</span>memorize(<span class=\"pl-c1\">this</span><span class=\"pl-k\">::</span>getKeyForValue);</pre></div>\n<p dir=\"auto\">according to its Javadoc</p>\n<blockquote>\n<p dir=\"auto\">Returns a supplier which caches the instance retrieved during the first call to {<a class=\"user-mention\" data-hovercard-type=\"organization\" data-hovercard-url=\"/orgs/code/hovercard\" href=\"https://github.com/code\">@code</a> get()} and returns that value on subsequent calls to {<a class=\"user-mention\" data-hovercard-type=\"organization\" data-hovercard-url=\"/orgs/code/hovercard\" href=\"https://github.com/code\">@code</a> get()}</p>\n</blockquote>", "author": "caithagoras", "createdAt": "2020-11-19T17:30:39Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +81,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private Map<Long, String> flippedEnumMap;\n+        private final AtomicBoolean isFlippedEnumComputed = new AtomicBoolean();", "originalCommit": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIxNTM1OA==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527215358", "bodyText": "same problem there \u2013 guava isn't a runtime dependency of presto-common", "author": "daniel-ohayon", "createdAt": "2020-11-19T21:36:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA2OTgzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MzU5Nw==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527073597", "body": "Have we considered using a `BiMap`? e.g. `ImmutableBiMap`.", "bodyText": "Have we considered using a BiMap? e.g. ImmutableBiMap.", "bodyHTML": "<p dir=\"auto\">Have we considered using a <code>BiMap</code>? e.g. <code>ImmutableBiMap</code>.</p>", "author": "caithagoras", "createdAt": "2020-11-19T17:36:26Z", "path": "presto-common/src/main/java/com/facebook/presto/common/type/LongEnumType.java", "diffHunk": "@@ -72,12 +81,15 @@ public String getDisplayName()\n     public static class LongEnumMap\n     {\n         private final Map<String, Long> enumMap;\n+        private Map<Long, String> flippedEnumMap;", "originalCommit": "a377190c7bf4193740ce6dfe448c5c7a0ded6d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIxMzQ5MA==", "url": "https://github.com/prestodb/presto/pull/15444#discussion_r527213490", "bodyText": "I tried that but that requires adding a maven dependency, and since this code lives in presto-common, that is not desirable", "author": "daniel-ohayon", "createdAt": "2020-11-19T21:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3MzU5Nw=="}], "type": "inlineReview"}]}