{"pr_number": 945, "pr_title": "Change editLabel to edit Filename", "pr_author": "lfarrell", "pr_createdAt": "2020-03-30T18:25:55Z", "pr_url": "https://github.com/UNC-Libraries/box-c/pull/945", "merge_commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "timeline": [{"oid": "862010e5f4665e1b3ac0d0de1deb75f2de1740e0", "url": "https://github.com/UNC-Libraries/box-c/commit/862010e5f4665e1b3ac0d0de1deb75f2de1740e0", "message": "* Change editLabel to edit Filename\n* Update Premis event and tests", "committedDate": "2020-03-30T18:23:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5MjE3OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r400892178", "body": "should throw a more specific exception. Maybe either `java.lang.IllegalArgumentException` or`ServiceException` are options. `ObjectTypeMismatchException` may not quite be the right fit.", "bodyText": "should throw a more specific exception. Maybe either java.lang.IllegalArgumentException orServiceException are options. ObjectTypeMismatchException may not quite be the right fit.", "bodyHTML": "<p dir=\"auto\">should throw a more specific exception. Maybe either <code>java.lang.IllegalArgumentException</code> or<code>ServiceException</code> are options. <code>ObjectTypeMismatchException</code> may not quite be the right fit.</p>", "author": "bbpennel", "createdAt": "2020-03-31T12:58:52Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java", "diffHunk": "@@ -67,17 +69,21 @@ public void editLabel(AgentPrincipals agent, PID pid, String label) {\n \n         try (Timer.Context context = timer.time()) {\n             aclService.assertHasAccess(\n-                    \"User does not have permissions to edit labels\",\n+                    \"User does not have permissions to edit filenames\",\n                     pid, agent.getPrincipals(), Permission.editDescription);\n \n             RepositoryObject obj = repoObjLoader.getRepositoryObject(pid);\n \n+            if (!(obj instanceof FileObject)) {\n+                throw new Exception(\"Failed to edit filename for \" + obj.getPid());", "originalCommit": "862010e5f4665e1b3ac0d0de1deb75f2de1740e0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d42aff7840a5eea72e4e4a0d6816eed5ce42d241", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex 7700b17e9..d144b75ec 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -75,12 +74,12 @@ public class EditFilenameService {\n             RepositoryObject obj = repoObjLoader.getRepositoryObject(pid);\n \n             if (!(obj instanceof FileObject)) {\n-                throw new Exception(\"Failed to edit filename for \" + obj.getPid());\n+                throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n             String oldLabel = getOldLabel(obj);\n \n-            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n+            repoObjFactory.createExclusiveRelationship(obj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "62d956c4149d461bf2472d81dde58942578741b8", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex d144b75ec..3ec2d4f36 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -77,9 +78,10 @@ public class EditFilenameService {\n                 throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n-            String oldLabel = getOldLabel(obj);\n+            BinaryObject binaryObj = ((FileObject) obj).getOriginalFile();\n+            String oldLabel = getOldLabel(binaryObj.getFilename());\n \n-            repoObjFactory.createExclusiveRelationship(obj, Ebucore.filename, label);\n+            repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex 7700b17e9..dec85279e 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -75,12 +71,13 @@ public class EditFilenameService {\n             RepositoryObject obj = repoObjLoader.getRepositoryObject(pid);\n \n             if (!(obj instanceof FileObject)) {\n-                throw new Exception(\"Failed to edit filename for \" + obj.getPid());\n+                throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n-            String oldLabel = getOldLabel(obj);\n+            BinaryObject binaryObj = ((FileObject) obj).getOriginalFile();\n+            String oldLabel = getOldLabel(binaryObj.getFilename());\n \n-            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n+            repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "b6636263c2969e36daf1c721554e39b3aee4bb80", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex dec85279e..31304f42d 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -78,6 +80,7 @@ public class EditFilenameService {\n             String oldLabel = getOldLabel(binaryObj.getFilename());\n \n             repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n+            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex 31304f42d..fc3fd5582 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -84,7 +84,7 @@ public class EditFilenameService {\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n-                .addImplementorAgent(agent.getUsernameUri())\n+                .addImplementorAgent(AgentPids.forPerson(agent))\n                 .addEventDetail(\"Object renamed from \" + oldLabel + \" to \" + label)\n                 .writeAndClose();\n         } catch (Exception e) {\n", "next_change": {"commit": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex fc3fd5582..0defc45af 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -82,7 +84,7 @@ public class EditFilenameService {\n             repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n             repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n \n-            obj.getPremisLog()\n+            premisLoggerFactory.createPremisLogger(obj)\n                 .buildEvent(Premis.FilenameChange)\n                 .addImplementorAgent(AgentPids.forPerson(agent))\n                 .addEventDetail(\"Object renamed from \" + oldLabel + \" to \" + label)\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "b6636263c2969e36daf1c721554e39b3aee4bb80", "committedDate": "2020-05-04 10:42:43 -0400", "message": "Update dc:title on fileObject (#977)"}, {"oid": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "committedDate": "2020-08-27 13:14:32 -0400", "message": "Adding implementator and authorizing agents to premis events expect agent pids. Update tests and usage to reflect this change"}, {"oid": "f580221852b673e1af442859d229393e80518b13", "committedDate": "2021-06-25 09:59:51 -0400", "message": "BXC-3187 - Create common-utils module (#1267)"}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5ac2f7f656ff72aa85becedbf158eba2a648d076", "committedDate": "2021-08-02 10:17:30 -0400", "message": "BXC-3190 - Reorganize persistence module (#1278)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5MzUwNw==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r400893507", "body": "i sort of regret how these transaction exceptions take over, since they can mask many types of failures. You could wrap the service call in a try/catch and check that the cause of the exception is the expected type ", "bodyText": "i sort of regret how these transaction exceptions take over, since they can mask many types of failures. You could wrap the service call in a try/catch and check that the cause of the exception is the expected type", "bodyHTML": "<p dir=\"auto\">i sort of regret how these transaction exceptions take over, since they can mask many types of failures. You could wrap the service call in a try/catch and check that the cause of the exception is the expected type</p>", "author": "bbpennel", "createdAt": "2020-03-31T13:00:57Z", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java", "diffHunk": "@@ -156,6 +160,15 @@ public void editLabelTest() {\n         assertEquals(pid, pidCaptor.getValue().get(0));\n     }\n \n+    @Test(expected = TransactionCancelledException.class)", "originalCommit": "862010e5f4665e1b3ac0d0de1deb75f2de1740e0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d42aff7840a5eea72e4e4a0d6816eed5ce42d241", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex 00354efdf..631ad4802 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -150,23 +149,27 @@ public class EditFilenameServiceTest {\n         String label = \"a brand-new title!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(DcElements.title), any(Resource.class));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(Ebucore.filename), any(Resource.class));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n-        assertEquals(labelCaptor.getValue(), \"Object renamed from \" + \"no dc:title\" +\" to \" + label);\n+        assertEquals(labelCaptor.getValue(), \"Object renamed from \" + \"no ebucore:filename\" +\" to \" + label);\n         verify(eventBuilder).writeAndClose();\n \n         verify(messageSender).sendUpdateDescriptionOperation(anyString(), pidCaptor.capture());\n         assertEquals(pid, pidCaptor.getValue().get(0));\n     }\n \n-    @Test(expected = TransactionCancelledException.class)\n+    @Test\n     public void editFilenamelNonFileObjTest() {\n         when(repoObjLoader.getRepositoryObject(any(PID.class))).thenReturn(workObj);\n-        doThrow(new AccessRestrictionException()).when(aclService)\n+        doThrow(new IllegalArgumentException()).when(aclService)\n                 .assertHasAccess(anyString(), eq(pid), any(AccessGroupSet.class), eq(Permission.editDescription));\n \n-        service.editLabel(agent, pid, \"label\");\n+        try {\n+            service.editLabel(agent, pid, \"label\");\n+        } catch (Exception e) {\n+           assertEquals(e.getCause().getClass(), IllegalArgumentException.class);\n+        }\n     }\n \n     @Test(expected = TransactionCancelledException.class)\n", "next_change": null}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex 00354efdf..f001cf29c 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -147,26 +146,44 @@ public class EditFilenameServiceTest {\n \n     @Test\n     public void editFilenameTest() {\n+        when(binaryObj.getFilename()).thenReturn(\"Old file name\");\n         String label = \"a brand-new title!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(DcElements.title), any(Resource.class));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n-        assertEquals(labelCaptor.getValue(), \"Object renamed from \" + \"no dc:title\" +\" to \" + label);\n+        assertEquals(labelCaptor.getValue(), \"Object renamed from Old file name to \" + label);\n         verify(eventBuilder).writeAndClose();\n \n         verify(messageSender).sendUpdateDescriptionOperation(anyString(), pidCaptor.capture());\n         assertEquals(pid, pidCaptor.getValue().get(0));\n     }\n \n-    @Test(expected = TransactionCancelledException.class)\n+    @Test\n+    public void editNoFilenameTest() {\n+        String label = \"a brand-new title too!\";\n+        service.editLabel(agent, pid, label);\n+\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n+        verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n+        verify(eventBuilder).addEventDetail(labelCaptor.capture());\n+        assertEquals(labelCaptor.getValue(), \"Object renamed from no ebucore:filename to \" + label);\n+        verify(eventBuilder).writeAndClose();\n+\n+        verify(messageSender).sendUpdateDescriptionOperation(anyString(), pidCaptor.capture());\n+        assertEquals(pid, pidCaptor.getValue().get(0));\n+    }\n+\n+    @Test\n     public void editFilenamelNonFileObjTest() {\n         when(repoObjLoader.getRepositoryObject(any(PID.class))).thenReturn(workObj);\n-        doThrow(new AccessRestrictionException()).when(aclService)\n-                .assertHasAccess(anyString(), eq(pid), any(AccessGroupSet.class), eq(Permission.editDescription));\n \n-        service.editLabel(agent, pid, \"label\");\n+        try {\n+            service.editLabel(agent, pid, \"label\");\n+        } catch (Exception e) {\n+           assertEquals(e.getCause().getClass(), IllegalArgumentException.class);\n+        }\n     }\n \n     @Test(expected = TransactionCancelledException.class)\n", "next_change": {"commit": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex f001cf29c..bcc96cb7b 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -189,9 +198,8 @@ public class EditFilenameServiceTest {\n     @Test(expected = TransactionCancelledException.class)\n     public void insufficientAccessTest() {\n         doThrow(new AccessRestrictionException()).when(aclService)\n-            .assertHasAccess(anyString(), eq(pid), any(AccessGroupSet.class), eq(Permission.editDescription));\n+            .assertHasAccess(anyString(), eq(pid), any(AccessGroupSetImpl.class), eq(Permission.editDescription));\n \n         service.editLabel(agent, pid, \"label\");\n     }\n-\n-}\n+}\n\\ No newline at end of file\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "b6636263c2969e36daf1c721554e39b3aee4bb80", "committedDate": "2020-05-04 10:42:43 -0400", "message": "Update dc:title on fileObject (#977)"}, {"oid": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "committedDate": "2020-08-27 13:14:32 -0400", "message": "Adding implementator and authorizing agents to premis events expect agent pids. Update tests and usage to reflect this change"}, {"oid": "f580221852b673e1af442859d229393e80518b13", "committedDate": "2021-06-25 09:59:51 -0400", "message": "BXC-3187 - Create common-utils module (#1267)"}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5ac2f7f656ff72aa85becedbf158eba2a648d076", "committedDate": "2021-08-02 10:17:30 -0400", "message": "BXC-3190 - Reorganize persistence module (#1278)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkzNjgzNg==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r400936836", "body": "Its occurring to me now that we should change the filename instead of the label. Could you change this to setting the ebucore:filename? We retain the original filename in the PREMIS, so that should be okay.", "bodyText": "Its occurring to me now that we should change the filename instead of the label. Could you change this to setting the ebucore:filename? We retain the original filename in the PREMIS, so that should be okay.", "bodyHTML": "<p dir=\"auto\">Its occurring to me now that we should change the filename instead of the label. Could you change this to setting the ebucore:filename? We retain the original filename in the PREMIS, so that should be okay.</p>", "author": "bbpennel", "createdAt": "2020-03-31T14:00:12Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java", "diffHunk": "@@ -67,17 +69,21 @@ public void editLabel(AgentPrincipals agent, PID pid, String label) {\n \n         try (Timer.Context context = timer.time()) {\n             aclService.assertHasAccess(\n-                    \"User does not have permissions to edit labels\",\n+                    \"User does not have permissions to edit filenames\",\n                     pid, agent.getPrincipals(), Permission.editDescription);\n \n             RepositoryObject obj = repoObjLoader.getRepositoryObject(pid);\n \n+            if (!(obj instanceof FileObject)) {\n+                throw new Exception(\"Failed to edit filename for \" + obj.getPid());\n+            }\n+\n             String oldLabel = getOldLabel(obj);\n \n             repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);", "originalCommit": "862010e5f4665e1b3ac0d0de1deb75f2de1740e0", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d42aff7840a5eea72e4e4a0d6816eed5ce42d241", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex 7700b17e9..d144b75ec 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -75,12 +74,12 @@ public class EditFilenameService {\n             RepositoryObject obj = repoObjLoader.getRepositoryObject(pid);\n \n             if (!(obj instanceof FileObject)) {\n-                throw new Exception(\"Failed to edit filename for \" + obj.getPid());\n+                throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n             String oldLabel = getOldLabel(obj);\n \n-            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n+            repoObjFactory.createExclusiveRelationship(obj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "62d956c4149d461bf2472d81dde58942578741b8", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex d144b75ec..3ec2d4f36 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -77,9 +78,10 @@ public class EditFilenameService {\n                 throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n-            String oldLabel = getOldLabel(obj);\n+            BinaryObject binaryObj = ((FileObject) obj).getOriginalFile();\n+            String oldLabel = getOldLabel(binaryObj.getFilename());\n \n-            repoObjFactory.createExclusiveRelationship(obj, Ebucore.filename, label);\n+            repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex 7700b17e9..dec85279e 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -75,12 +71,13 @@ public class EditFilenameService {\n             RepositoryObject obj = repoObjLoader.getRepositoryObject(pid);\n \n             if (!(obj instanceof FileObject)) {\n-                throw new Exception(\"Failed to edit filename for \" + obj.getPid());\n+                throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n-            String oldLabel = getOldLabel(obj);\n+            BinaryObject binaryObj = ((FileObject) obj).getOriginalFile();\n+            String oldLabel = getOldLabel(binaryObj.getFilename());\n \n-            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n+            repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "b6636263c2969e36daf1c721554e39b3aee4bb80", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex dec85279e..31304f42d 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -78,6 +80,7 @@ public class EditFilenameService {\n             String oldLabel = getOldLabel(binaryObj.getFilename());\n \n             repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n+            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex 31304f42d..fc3fd5582 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -84,7 +84,7 @@ public class EditFilenameService {\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n-                .addImplementorAgent(agent.getUsernameUri())\n+                .addImplementorAgent(AgentPids.forPerson(agent))\n                 .addEventDetail(\"Object renamed from \" + oldLabel + \" to \" + label)\n                 .writeAndClose();\n         } catch (Exception e) {\n", "next_change": {"commit": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex fc3fd5582..0defc45af 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -82,7 +84,7 @@ public class EditFilenameService {\n             repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n             repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n \n-            obj.getPremisLog()\n+            premisLoggerFactory.createPremisLogger(obj)\n                 .buildEvent(Premis.FilenameChange)\n                 .addImplementorAgent(AgentPids.forPerson(agent))\n                 .addEventDetail(\"Object renamed from \" + oldLabel + \" to \" + label)\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "b6636263c2969e36daf1c721554e39b3aee4bb80", "committedDate": "2020-05-04 10:42:43 -0400", "message": "Update dc:title on fileObject (#977)"}, {"oid": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "committedDate": "2020-08-27 13:14:32 -0400", "message": "Adding implementator and authorizing agents to premis events expect agent pids. Update tests and usage to reflect this change"}, {"oid": "f580221852b673e1af442859d229393e80518b13", "committedDate": "2021-06-25 09:59:51 -0400", "message": "BXC-3187 - Create common-utils module (#1267)"}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5ac2f7f656ff72aa85becedbf158eba2a648d076", "committedDate": "2021-08-02 10:17:30 -0400", "message": "BXC-3190 - Reorganize persistence module (#1278)"}]}, {"oid": "d42aff7840a5eea72e4e4a0d6816eed5ce42d241", "url": "https://github.com/UNC-Libraries/box-c/commit/d42aff7840a5eea72e4e4a0d6816eed5ce42d241", "message": "Switch event to ebucore:filename and update tests", "committedDate": "2020-03-31T17:19:25Z", "type": "commit"}, {"oid": "d42aff7840a5eea72e4e4a0d6816eed5ce42d241", "url": "https://github.com/UNC-Libraries/box-c/commit/d42aff7840a5eea72e4e4a0d6816eed5ce42d241", "message": "Switch event to ebucore:filename and update tests", "committedDate": "2020-03-31T17:19:25Z", "type": "forcePushed"}, {"oid": "6ff0bf329d60a0bd1915db86b77504572cef9143", "url": "https://github.com/UNC-Libraries/box-c/commit/6ff0bf329d60a0bd1915db86b77504572cef9143", "message": "* Update and rename IT test\n* Fix import ordering", "committedDate": "2020-03-31T18:25:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI2Njk3NQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r401266975", "body": "You shouldn't need this throw, the fact that the repoObjLoader returns a work should trigger the expected exception", "bodyText": "You shouldn't need this throw, the fact that the repoObjLoader returns a work should trigger the expected exception", "bodyHTML": "<p dir=\"auto\">You shouldn't need this throw, the fact that the repoObjLoader returns a work should trigger the expected exception</p>", "author": "bbpennel", "createdAt": "2020-03-31T23:09:53Z", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java", "diffHunk": "@@ -142,20 +145,33 @@ public Object answer(InvocationOnMock invocation) throws Throwable {\n     }\n \n     @Test\n-    public void editLabelTest() {\n+    public void editFilenameTest() {\n         String label = \"a brand-new title!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(DcElements.title), any(Resource.class));\n-        verify(premisLogger).buildEvent(eq(Premis.Migration));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(Ebucore.filename), any(Resource.class));\n+        verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n-        assertEquals(labelCaptor.getValue(), \"Object renamed from \" + \"no dc:title\" +\" to \" + label);\n+        assertEquals(labelCaptor.getValue(), \"Object renamed from \" + \"no ebucore:filename\" +\" to \" + label);\n         verify(eventBuilder).writeAndClose();\n \n         verify(messageSender).sendUpdateDescriptionOperation(anyString(), pidCaptor.capture());\n         assertEquals(pid, pidCaptor.getValue().get(0));\n     }\n \n+    @Test\n+    public void editFilenamelNonFileObjTest() {\n+        when(repoObjLoader.getRepositoryObject(any(PID.class))).thenReturn(workObj);\n+        doThrow(new IllegalArgumentException()).when(aclService)", "originalCommit": "6ff0bf329d60a0bd1915db86b77504572cef9143", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "62d956c4149d461bf2472d81dde58942578741b8", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex b9c043296..aa3dbf91d 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -162,8 +181,6 @@ public class EditFilenameServiceTest {\n     @Test\n     public void editFilenamelNonFileObjTest() {\n         when(repoObjLoader.getRepositoryObject(any(PID.class))).thenReturn(workObj);\n-        doThrow(new IllegalArgumentException()).when(aclService)\n-                .assertHasAccess(anyString(), eq(pid), any(AccessGroupSet.class), eq(Permission.editDescription));\n \n         try {\n             service.editLabel(agent, pid, \"label\");\n", "next_change": null}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex b9c043296..f001cf29c 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -162,8 +178,6 @@ public class EditFilenameServiceTest {\n     @Test\n     public void editFilenamelNonFileObjTest() {\n         when(repoObjLoader.getRepositoryObject(any(PID.class))).thenReturn(workObj);\n-        doThrow(new IllegalArgumentException()).when(aclService)\n-                .assertHasAccess(anyString(), eq(pid), any(AccessGroupSet.class), eq(Permission.editDescription));\n \n         try {\n             service.editLabel(agent, pid, \"label\");\n", "next_change": null}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "b6636263c2969e36daf1c721554e39b3aee4bb80", "committedDate": "2020-05-04 10:42:43 -0400", "message": "Update dc:title on fileObject (#977)"}, {"oid": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "committedDate": "2020-08-27 13:14:32 -0400", "message": "Adding implementator and authorizing agents to premis events expect agent pids. Update tests and usage to reflect this change"}, {"oid": "f580221852b673e1af442859d229393e80518b13", "committedDate": "2021-06-25 09:59:51 -0400", "message": "BXC-3187 - Create common-utils module (#1267)"}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5ac2f7f656ff72aa85becedbf158eba2a648d076", "committedDate": "2021-08-02 10:17:30 -0400", "message": "BXC-3190 - Reorganize persistence module (#1278)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI3MDUyNA==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r401270524", "body": "actually I'm realizing that that this relationship needs to be set on the binary rather than the FileObject. You can get the binary by calling `fileObj.getOriginalFile()`. You'll also need to get the old label from the same place. Sorry I didn't notice that sooner, I haven't gotten to manually test yet.", "bodyText": "actually I'm realizing that that this relationship needs to be set on the binary rather than the FileObject. You can get the binary by calling fileObj.getOriginalFile(). You'll also need to get the old label from the same place. Sorry I didn't notice that sooner, I haven't gotten to manually test yet.", "bodyHTML": "<p dir=\"auto\">actually I'm realizing that that this relationship needs to be set on the binary rather than the FileObject. You can get the binary by calling <code>fileObj.getOriginalFile()</code>. You'll also need to get the old label from the same place. Sorry I didn't notice that sooner, I haven't gotten to manually test yet.</p>", "author": "bbpennel", "createdAt": "2020-03-31T23:21:09Z", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java", "diffHunk": "@@ -67,17 +68,21 @@ public void editLabel(AgentPrincipals agent, PID pid, String label) {\n \n         try (Timer.Context context = timer.time()) {\n             aclService.assertHasAccess(\n-                    \"User does not have permissions to edit labels\",\n+                    \"User does not have permissions to edit filenames\",\n                     pid, agent.getPrincipals(), Permission.editDescription);\n \n             RepositoryObject obj = repoObjLoader.getRepositoryObject(pid);\n \n+            if (!(obj instanceof FileObject)) {\n+                throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n+            }\n+\n             String oldLabel = getOldLabel(obj);\n \n-            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n+            repoObjFactory.createExclusiveRelationship(obj, Ebucore.filename, label);", "originalCommit": "6ff0bf329d60a0bd1915db86b77504572cef9143", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "62d956c4149d461bf2472d81dde58942578741b8", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex aa52a78eb..3ec2d4f36 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -77,9 +78,10 @@ public class EditFilenameService {\n                 throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n-            String oldLabel = getOldLabel(obj);\n+            BinaryObject binaryObj = ((FileObject) obj).getOriginalFile();\n+            String oldLabel = getOldLabel(binaryObj.getFilename());\n \n-            repoObjFactory.createExclusiveRelationship(obj, Ebucore.filename, label);\n+            repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": null}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex aa52a78eb..dec85279e 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -77,9 +74,10 @@ public class EditFilenameService {\n                 throw new IllegalArgumentException(\"Failed to edit filename for \" + obj.getPid());\n             }\n \n-            String oldLabel = getOldLabel(obj);\n+            BinaryObject binaryObj = ((FileObject) obj).getOriginalFile();\n+            String oldLabel = getOldLabel(binaryObj.getFilename());\n \n-            repoObjFactory.createExclusiveRelationship(obj, Ebucore.filename, label);\n+            repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "b6636263c2969e36daf1c721554e39b3aee4bb80", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex dec85279e..31304f42d 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -78,6 +80,7 @@ public class EditFilenameService {\n             String oldLabel = getOldLabel(binaryObj.getFilename());\n \n             repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n+            repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n", "next_change": {"commit": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex 31304f42d..fc3fd5582 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -84,7 +84,7 @@ public class EditFilenameService {\n \n             obj.getPremisLog()\n                 .buildEvent(Premis.FilenameChange)\n-                .addImplementorAgent(agent.getUsernameUri())\n+                .addImplementorAgent(AgentPids.forPerson(agent))\n                 .addEventDetail(\"Object renamed from \" + oldLabel + \" to \" + label)\n                 .writeAndClose();\n         } catch (Exception e) {\n", "next_change": {"commit": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "changed_code": [{"header": "diff --git a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\nindex fc3fd5582..0defc45af 100644\n--- a/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n+++ b/persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/EditFilenameService.java\n", "chunk": "@@ -82,7 +84,7 @@ public class EditFilenameService {\n             repoObjFactory.createExclusiveRelationship(binaryObj, Ebucore.filename, label);\n             repoObjFactory.createExclusiveRelationship(obj, DcElements.title, label);\n \n-            obj.getPremisLog()\n+            premisLoggerFactory.createPremisLogger(obj)\n                 .buildEvent(Premis.FilenameChange)\n                 .addImplementorAgent(AgentPids.forPerson(agent))\n                 .addEventDetail(\"Object renamed from \" + oldLabel + \" to \" + label)\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "b6636263c2969e36daf1c721554e39b3aee4bb80", "committedDate": "2020-05-04 10:42:43 -0400", "message": "Update dc:title on fileObject (#977)"}, {"oid": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "committedDate": "2020-08-27 13:14:32 -0400", "message": "Adding implementator and authorizing agents to premis events expect agent pids. Update tests and usage to reflect this change"}, {"oid": "f580221852b673e1af442859d229393e80518b13", "committedDate": "2021-06-25 09:59:51 -0400", "message": "BXC-3187 - Create common-utils module (#1267)"}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5ac2f7f656ff72aa85becedbf158eba2a648d076", "committedDate": "2021-08-02 10:17:30 -0400", "message": "BXC-3190 - Reorganize persistence module (#1278)"}]}, {"oid": "62d956c4149d461bf2472d81dde58942578741b8", "url": "https://github.com/UNC-Libraries/box-c/commit/62d956c4149d461bf2472d81dde58942578741b8", "message": "* Change where event takes place\n* Move method call", "committedDate": "2020-04-01T14:38:22Z", "type": "commit"}, {"oid": "2bff7c6a33ffadd67cf96296db2a1295503c913a", "url": "https://github.com/UNC-Libraries/box-c/commit/2bff7c6a33ffadd67cf96296db2a1295503c913a", "message": "Remove unused imports", "committedDate": "2020-04-01T14:59:05Z", "type": "commit"}, {"oid": "263830a208fa37aeeb9dbe27f6a936a3fa871218", "url": "https://github.com/UNC-Libraries/box-c/commit/263830a208fa37aeeb9dbe27f6a936a3fa871218", "message": "Update tests to look for orignal file metadata", "committedDate": "2020-04-01T18:23:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzNTE4OA==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r401835188", "body": "you should make sure that its setting the object of the relationship to the expected filename in all these tests. ", "bodyText": "you should make sure that its setting the object of the relationship to the expected filename in all these tests.", "bodyHTML": "<p dir=\"auto\">you should make sure that its setting the object of the relationship to the expected filename in all these tests.</p>", "author": "bbpennel", "createdAt": "2020-04-01T18:50:16Z", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java", "diffHunk": "@@ -142,20 +148,47 @@ public Object answer(InvocationOnMock invocation) throws Throwable {\n     }\n \n     @Test\n-    public void editLabelTest() {\n+    public void editFilenameTest() {\n+        when(binaryObj.getFilename()).thenReturn(\"Old file name\");\n         String label = \"a brand-new title!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(DcElements.title), any(Resource.class));\n-        verify(premisLogger).buildEvent(eq(Premis.Migration));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));\n+        verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n-        assertEquals(labelCaptor.getValue(), \"Object renamed from \" + \"no dc:title\" +\" to \" + label);\n+        assertEquals(labelCaptor.getValue(), \"Object renamed from Old file name to \" + label);\n         verify(eventBuilder).writeAndClose();\n \n         verify(messageSender).sendUpdateDescriptionOperation(anyString(), pidCaptor.capture());\n         assertEquals(pid, pidCaptor.getValue().get(0));\n     }\n \n+    @Test\n+    public void editNoFilenameTest() {\n+        String label = \"a brand-new title too!\";\n+        service.editLabel(agent, pid, label);\n+\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));", "originalCommit": "263830a208fa37aeeb9dbe27f6a936a3fa871218", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7213583b1cf52a2bdcb6ee02a4147c4279e286db", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex aa3dbf91d..5ac175208 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -169,6 +167,7 @@ public class EditFilenameServiceTest {\n         service.editLabel(agent, pid, label);\n \n         verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), labelCaptor.capture());\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n         assertEquals(labelCaptor.getValue(), \"Object renamed from no ebucore:filename to \" + label);\n", "next_change": {"commit": "2718804f1981a48ed3b3b1f9a015e85d6bfe2d6f", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex 5ac175208..f001cf29c 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -166,8 +165,7 @@ public class EditFilenameServiceTest {\n         String label = \"a brand-new title too!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));\n-        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), labelCaptor.capture());\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n         assertEquals(labelCaptor.getValue(), \"Object renamed from no ebucore:filename to \" + label);\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex aa3dbf91d..f001cf29c 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -168,7 +165,7 @@ public class EditFilenameServiceTest {\n         String label = \"a brand-new title too!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n         assertEquals(labelCaptor.getValue(), \"Object renamed from no ebucore:filename to \" + label);\n", "next_change": {"commit": "b6636263c2969e36daf1c721554e39b3aee4bb80", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex f001cf29c..eb1b19765 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -166,6 +168,7 @@ public class EditFilenameServiceTest {\n         service.editLabel(agent, pid, label);\n \n         verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(DcElements.title), eq(label));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n         assertEquals(labelCaptor.getValue(), \"Object renamed from no ebucore:filename to \" + label);\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "b6636263c2969e36daf1c721554e39b3aee4bb80", "committedDate": "2020-05-04 10:42:43 -0400", "message": "Update dc:title on fileObject (#977)"}, {"oid": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "committedDate": "2020-08-27 13:14:32 -0400", "message": "Adding implementator and authorizing agents to premis events expect agent pids. Update tests and usage to reflect this change"}, {"oid": "f580221852b673e1af442859d229393e80518b13", "committedDate": "2021-06-25 09:59:51 -0400", "message": "BXC-3187 - Create common-utils module (#1267)"}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5ac2f7f656ff72aa85becedbf158eba2a648d076", "committedDate": "2021-08-02 10:17:30 -0400", "message": "BXC-3190 - Reorganize persistence module (#1278)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzNzI3OQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r401837279", "body": "just pass in null for the model", "bodyText": "just pass in null for the model", "bodyHTML": "<p dir=\"auto\">just pass in null for the model</p>", "author": "bbpennel", "createdAt": "2020-04-01T18:53:55Z", "path": "services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java", "diffHunk": "@@ -48,18 +51,22 @@\n @ContextHierarchy({\n     @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n     @ContextConfiguration(\"/spring-test/cdr-client-container.xml\"),\n-    @ContextConfiguration(\"/edit-label-it-servlet.xml\")\n+    @ContextConfiguration(\"/edit-filename-it-servlet.xml\")\n })\n-public class EditLabelIT extends AbstractAPIIT {\n+public class EditFilenameIT extends AbstractAPIIT {\n+    private String filename = \"file.txt\";\n+    private String mimetype = \"text/plain\";\n \n     @Test\n     public void testCreateLabelWhereNoneExists() throws UnsupportedOperationException, Exception {\n         PID pid = makePid();\n \n-        WorkObject work = repositoryObjectFactory.createWorkObject(pid, null);\n+        Path file = createTempFile(\"test\", \"txt\");\n+        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, ModelFactory.createDefaultModel());", "originalCommit": "263830a208fa37aeeb9dbe27f6a936a3fa871218", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7213583b1cf52a2bdcb6ee02a4147c4279e286db", "changed_code": [{"header": "diff --git a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\nindex f05370997..afb26da55 100644\n--- a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n+++ b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n", "chunk": "@@ -62,7 +62,7 @@ public class EditFilenameIT extends AbstractAPIIT {\n         PID pid = makePid();\n \n         Path file = createTempFile(\"test\", \"txt\");\n-        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, ModelFactory.createDefaultModel());\n+        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, null);\n         fileObj.addOriginalFile(file.toUri(), filename, mimetype, null, null);\n \n         String label = \"work_filename\";\n", "next_change": null}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\nindex f05370997..afb26da55 100644\n--- a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n+++ b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n", "chunk": "@@ -62,7 +62,7 @@ public class EditFilenameIT extends AbstractAPIIT {\n         PID pid = makePid();\n \n         Path file = createTempFile(\"test\", \"txt\");\n-        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, ModelFactory.createDefaultModel());\n+        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, null);\n         fileObj.addOriginalFile(file.toUri(), filename, mimetype, null, null);\n \n         String label = \"work_filename\";\n", "next_change": null}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5311444f3a4e5c1552148cf29f7ce6c8291e8e5f", "committedDate": "2021-08-27 16:08:39 -0400", "message": "BXC-3193 - Reorganize application and fcrepo-clients modules (#1286)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzOTA1OQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r401839059", "body": "you can save some steps here by doing `fileObj.getOriginalFile().getResource().hasProperty(...)` (or maybe its hasLiteral, one of those two), or `fileObj.getOriginalFile().getResource().getProperty(...)` if you want to keep using assertEquals.\r\n\r\nthis is the case for most of the tests.", "bodyText": "you can save some steps here by doing fileObj.getOriginalFile().getResource().hasProperty(...) (or maybe its hasLiteral, one of those two), or fileObj.getOriginalFile().getResource().getProperty(...) if you want to keep using assertEquals.\nthis is the case for most of the tests.", "bodyHTML": "<p dir=\"auto\">you can save some steps here by doing <code>fileObj.getOriginalFile().getResource().hasProperty(...)</code> (or maybe its hasLiteral, one of those two), or <code>fileObj.getOriginalFile().getResource().getProperty(...)</code> if you want to keep using assertEquals.</p>\n<p dir=\"auto\">this is the case for most of the tests.</p>", "author": "bbpennel", "createdAt": "2020-04-01T18:56:52Z", "path": "services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java", "diffHunk": "@@ -69,21 +76,25 @@ public void testCreateLabelWhereNoneExists() throws UnsupportedOperationExceptio\n         assertEquals(pid.getUUID(), respMap.get(\"pid\"));\n         assertEquals(\"editLabel\", respMap.get(\"action\"));\n \n-        assertEquals(\"work_label\",\n-                work.getModel().getRequiredProperty(work.getResource(), DcElements.title).getLiteral().toString());\n+        assertEquals(\"work_filename\",\n+                fileObj.getOriginalFile().getModel().getRequiredProperty(", "originalCommit": "263830a208fa37aeeb9dbe27f6a936a3fa871218", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7213583b1cf52a2bdcb6ee02a4147c4279e286db", "changed_code": [{"header": "diff --git a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\nindex f05370997..afb26da55 100644\n--- a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n+++ b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n", "chunk": "@@ -77,20 +77,16 @@ public class EditFilenameIT extends AbstractAPIIT {\n         assertEquals(\"editLabel\", respMap.get(\"action\"));\n \n         assertEquals(\"work_filename\",\n-                fileObj.getOriginalFile().getModel().getRequiredProperty(\n-                        fileObj.getOriginalFile().getResource(), Ebucore.filename).getLiteral().toString());\n+                fileObj.getOriginalFile().getResource().getProperty(Ebucore.filename)\n+                        .getLiteral().toString());\n     }\n \n     @Test\n     public void testReplaceLabel() throws UnsupportedOperationException, Exception {\n         PID pid = makePid();\n-        String oldLabel = \"old_work_label\";\n-        Model fileModel = ModelFactory.createDefaultModel();\n-        fileModel.add(fileModel.createResource(pid.getRepositoryPath()), Ebucore.filename,\n-                oldLabel);\n         Path file = createTempFile(\"test\", \"txt\");\n \n-        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, fileModel);\n+        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, null);\n         fileObj.addOriginalFile(file.toUri(), filename, mimetype, null, null);\n \n         String newLabel = \"new_work_filename\";\n", "next_change": null}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\nindex f05370997..afb26da55 100644\n--- a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n+++ b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n", "chunk": "@@ -77,20 +77,16 @@ public class EditFilenameIT extends AbstractAPIIT {\n         assertEquals(\"editLabel\", respMap.get(\"action\"));\n \n         assertEquals(\"work_filename\",\n-                fileObj.getOriginalFile().getModel().getRequiredProperty(\n-                        fileObj.getOriginalFile().getResource(), Ebucore.filename).getLiteral().toString());\n+                fileObj.getOriginalFile().getResource().getProperty(Ebucore.filename)\n+                        .getLiteral().toString());\n     }\n \n     @Test\n     public void testReplaceLabel() throws UnsupportedOperationException, Exception {\n         PID pid = makePid();\n-        String oldLabel = \"old_work_label\";\n-        Model fileModel = ModelFactory.createDefaultModel();\n-        fileModel.add(fileModel.createResource(pid.getRepositoryPath()), Ebucore.filename,\n-                oldLabel);\n         Path file = createTempFile(\"test\", \"txt\");\n \n-        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, fileModel);\n+        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, null);\n         fileObj.addOriginalFile(file.toUri(), filename, mimetype, null, null);\n \n         String newLabel = \"new_work_filename\";\n", "next_change": null}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5311444f3a4e5c1552148cf29f7ce6c8291e8e5f", "committedDate": "2021-08-27 16:08:39 -0400", "message": "BXC-3193 - Reorganize application and fcrepo-clients modules (#1286)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MDUxMA==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r401840510", "body": "the filename shouldn't be set on the FileObject. ebucore:filename gets automatically generated on the binary by passing the filename parameter in `addOriginalFile`, so you can remove the model stuff for the fileobj", "bodyText": "the filename shouldn't be set on the FileObject. ebucore:filename gets automatically generated on the binary by passing the filename parameter in addOriginalFile, so you can remove the model stuff for the fileobj", "bodyHTML": "<p dir=\"auto\">the filename shouldn't be set on the FileObject. ebucore:filename gets automatically generated on the binary by passing the filename parameter in <code>addOriginalFile</code>, so you can remove the model stuff for the fileobj</p>", "author": "bbpennel", "createdAt": "2020-04-01T18:59:17Z", "path": "services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java", "diffHunk": "@@ -69,21 +76,25 @@ public void testCreateLabelWhereNoneExists() throws UnsupportedOperationExceptio\n         assertEquals(pid.getUUID(), respMap.get(\"pid\"));\n         assertEquals(\"editLabel\", respMap.get(\"action\"));\n \n-        assertEquals(\"work_label\",\n-                work.getModel().getRequiredProperty(work.getResource(), DcElements.title).getLiteral().toString());\n+        assertEquals(\"work_filename\",\n+                fileObj.getOriginalFile().getModel().getRequiredProperty(\n+                        fileObj.getOriginalFile().getResource(), Ebucore.filename).getLiteral().toString());\n     }\n \n     @Test\n     public void testReplaceLabel() throws UnsupportedOperationException, Exception {\n         PID pid = makePid();\n         String oldLabel = \"old_work_label\";\n-        Model workModel = ModelFactory.createDefaultModel();\n-        workModel.add(workModel.createResource(pid.getRepositoryPath()), DcElements.title,\n+        Model fileModel = ModelFactory.createDefaultModel();", "originalCommit": "263830a208fa37aeeb9dbe27f6a936a3fa871218", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7213583b1cf52a2bdcb6ee02a4147c4279e286db", "changed_code": [{"header": "diff --git a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\nindex f05370997..afb26da55 100644\n--- a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n+++ b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n", "chunk": "@@ -77,20 +77,16 @@ public class EditFilenameIT extends AbstractAPIIT {\n         assertEquals(\"editLabel\", respMap.get(\"action\"));\n \n         assertEquals(\"work_filename\",\n-                fileObj.getOriginalFile().getModel().getRequiredProperty(\n-                        fileObj.getOriginalFile().getResource(), Ebucore.filename).getLiteral().toString());\n+                fileObj.getOriginalFile().getResource().getProperty(Ebucore.filename)\n+                        .getLiteral().toString());\n     }\n \n     @Test\n     public void testReplaceLabel() throws UnsupportedOperationException, Exception {\n         PID pid = makePid();\n-        String oldLabel = \"old_work_label\";\n-        Model fileModel = ModelFactory.createDefaultModel();\n-        fileModel.add(fileModel.createResource(pid.getRepositoryPath()), Ebucore.filename,\n-                oldLabel);\n         Path file = createTempFile(\"test\", \"txt\");\n \n-        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, fileModel);\n+        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, null);\n         fileObj.addOriginalFile(file.toUri(), filename, mimetype, null, null);\n \n         String newLabel = \"new_work_filename\";\n", "next_change": null}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\nindex f05370997..afb26da55 100644\n--- a/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n+++ b/services/src/test/java/edu/unc/lib/dl/cdr/services/rest/modify/EditFilenameIT.java\n", "chunk": "@@ -77,20 +77,16 @@ public class EditFilenameIT extends AbstractAPIIT {\n         assertEquals(\"editLabel\", respMap.get(\"action\"));\n \n         assertEquals(\"work_filename\",\n-                fileObj.getOriginalFile().getModel().getRequiredProperty(\n-                        fileObj.getOriginalFile().getResource(), Ebucore.filename).getLiteral().toString());\n+                fileObj.getOriginalFile().getResource().getProperty(Ebucore.filename)\n+                        .getLiteral().toString());\n     }\n \n     @Test\n     public void testReplaceLabel() throws UnsupportedOperationException, Exception {\n         PID pid = makePid();\n-        String oldLabel = \"old_work_label\";\n-        Model fileModel = ModelFactory.createDefaultModel();\n-        fileModel.add(fileModel.createResource(pid.getRepositoryPath()), Ebucore.filename,\n-                oldLabel);\n         Path file = createTempFile(\"test\", \"txt\");\n \n-        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, fileModel);\n+        FileObject fileObj = repositoryObjectFactory.createFileObject(pid, null);\n         fileObj.addOriginalFile(file.toUri(), filename, mimetype, null, null);\n \n         String newLabel = \"new_work_filename\";\n", "next_change": null}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5311444f3a4e5c1552148cf29f7ce6c8291e8e5f", "committedDate": "2021-08-27 16:08:39 -0400", "message": "BXC-3193 - Reorganize application and fcrepo-clients modules (#1286)"}]}, {"oid": "7213583b1cf52a2bdcb6ee02a4147c4279e286db", "url": "https://github.com/UNC-Libraries/box-c/commit/7213583b1cf52a2bdcb6ee02a4147c4279e286db", "message": "Update tests", "committedDate": "2020-04-02T15:11:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5OTcyOQ==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r402499729", "body": "You shouldn't need to verify this method was called twice in a row, so you should be able to get rid of this line. Also I don't think you're verify the value before it is getting overwritten by line 156 before you verify it. Have you tried just doing `verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label))` ? If that doesn't work, then you'll need another assertEquals for the label right after this capture.\r\n\r\nYou'll want to make the same changes in the other test.", "bodyText": "You shouldn't need to verify this method was called twice in a row, so you should be able to get rid of this line. Also I don't think you're verify the value before it is getting overwritten by line 156 before you verify it. Have you tried just doing verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label)) ? If that doesn't work, then you'll need another assertEquals for the label right after this capture.\nYou'll want to make the same changes in the other test.", "bodyHTML": "<p dir=\"auto\">You shouldn't need to verify this method was called twice in a row, so you should be able to get rid of this line. Also I don't think you're verify the value before it is getting overwritten by line 156 before you verify it. Have you tried just doing <code>verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label))</code> ? If that doesn't work, then you'll need another assertEquals for the label right after this capture.</p>\n<p dir=\"auto\">You'll want to make the same changes in the other test.</p>", "author": "bbpennel", "createdAt": "2020-04-02T17:46:30Z", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java", "diffHunk": "@@ -154,6 +151,7 @@ public void editFilenameTest() {\n         service.editLabel(agent, pid, label);\n \n         verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));", "originalCommit": "7213583b1cf52a2bdcb6ee02a4147c4279e286db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0MzgwMg==", "url": "https://github.com/UNC-Libraries/box-c/pull/945#discussion_r402543802", "bodyText": "eq(label) seems to work fine. Updated", "author": "lfarrell", "createdAt": "2020-04-02T19:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ5OTcyOQ=="}], "type": "inlineReview", "revised_code": {"commit": "2718804f1981a48ed3b3b1f9a015e85d6bfe2d6f", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex 5ac175208..f001cf29c 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -150,8 +150,7 @@ public class EditFilenameServiceTest {\n         String label = \"a brand-new title!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));\n-        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), labelCaptor.capture());\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n         assertEquals(labelCaptor.getValue(), \"Object renamed from Old file name to \" + label);\n", "next_change": null}]}, "revised_code_in_main": {"commit": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex 5ac175208..f001cf29c 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -150,8 +150,7 @@ public class EditFilenameServiceTest {\n         String label = \"a brand-new title!\";\n         service.editLabel(agent, pid, label);\n \n-        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), any(Resource.class));\n-        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), labelCaptor.capture());\n+        verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n         assertEquals(labelCaptor.getValue(), \"Object renamed from Old file name to \" + label);\n", "next_change": {"commit": "b6636263c2969e36daf1c721554e39b3aee4bb80", "changed_code": [{"header": "diff --git a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\nindex f001cf29c..eb1b19765 100644\n--- a/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n+++ b/persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/EditFilenameServiceTest.java\n", "chunk": "@@ -151,6 +152,7 @@ public class EditFilenameServiceTest {\n         service.editLabel(agent, pid, label);\n \n         verify(repoObjFactory).createExclusiveRelationship(eq(binaryObj), eq(Ebucore.filename), eq(label));\n+        verify(repoObjFactory).createExclusiveRelationship(eq(repoObj), eq(DcElements.title), eq(label));\n         verify(premisLogger).buildEvent(eq(Premis.FilenameChange));\n         verify(eventBuilder).addEventDetail(labelCaptor.capture());\n         assertEquals(labelCaptor.getValue(), \"Object renamed from Old file name to \" + label);\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "e9b686b9396ce31abdc9d906512fa2029ca469dc", "message": "Merge commit", "committedDate": null}, {"oid": "b6636263c2969e36daf1c721554e39b3aee4bb80", "committedDate": "2020-05-04 10:42:43 -0400", "message": "Update dc:title on fileObject (#977)"}, {"oid": "559a61b78f6b60f7d6ecc62e40c19c83778d6086", "committedDate": "2020-08-27 13:14:32 -0400", "message": "Adding implementator and authorizing agents to premis events expect agent pids. Update tests and usage to reflect this change"}, {"oid": "f580221852b673e1af442859d229393e80518b13", "committedDate": "2021-06-25 09:59:51 -0400", "message": "BXC-3187 - Create common-utils module (#1267)"}, {"oid": "0c980788be444c9b9239d03bb7e68e8d6f92add3", "committedDate": "2021-07-06 14:02:28 -0400", "message": "BXC-3188 - Reorganize modules to create model (#1271)"}, {"oid": "53af2e72cc1561bebd4f0f3ad9cc6eb237400e26", "committedDate": "2021-07-15 14:24:08 -0400", "message": "BXC-3189 - Refactor security into auth modules (#1276)"}, {"oid": "5ac2f7f656ff72aa85becedbf158eba2a648d076", "committedDate": "2021-08-02 10:17:30 -0400", "message": "BXC-3190 - Reorganize persistence module (#1278)"}]}, {"oid": "2718804f1981a48ed3b3b1f9a015e85d6bfe2d6f", "url": "https://github.com/UNC-Libraries/box-c/commit/2718804f1981a48ed3b3b1f9a015e85d6bfe2d6f", "message": "Update title verification", "committedDate": "2020-04-02T18:57:21Z", "type": "commit"}]}