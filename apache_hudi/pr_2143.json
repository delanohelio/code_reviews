{"pr_number": 2143, "pr_title": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable", "pr_author": "xushiyan", "pr_createdAt": "2020-10-04T17:10:27Z", "pr_url": "https://github.com/apache/hudi/pull/2143", "timeline": [{"oid": "1d9dac8ea23598dc778a4d86058b919580da0d3d", "url": "https://github.com/apache/hudi/commit/1d9dac8ea23598dc778a4d86058b919580da0d3d", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in `HoodieTestUtils`\n- listAllDataFilesAndLogFilesInPath\n- listAllLogFilesInPath\n- listAllDataFilesInPath\n- writeRecordsToLogFiles\n- createCleanFiles\n- createPendingCleanFiles\n\nMigrate the callers to use `HoodieTestTable` and `HoodieWriteableTestTable` with new APIs added\n- listAllBaseAndLogFiles\n- listAllLogFiles\n- listAllBaseFiles\n- withLogAppends\n- addClean\n- addInflightClean\n\nAlso added related APIs in `FileCreateUtils`\n- createCleanFile\n- createRequestedCleanFile\n- createInflightCleanFile", "committedDate": "2020-10-05T02:15:41Z", "type": "commit"}, {"oid": "1d9dac8ea23598dc778a4d86058b919580da0d3d", "url": "https://github.com/apache/hudi/commit/1d9dac8ea23598dc778a4d86058b919580da0d3d", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nRemove APIs in `HoodieTestUtils`\n- listAllDataFilesAndLogFilesInPath\n- listAllLogFilesInPath\n- listAllDataFilesInPath\n- writeRecordsToLogFiles\n- createCleanFiles\n- createPendingCleanFiles\n\nMigrate the callers to use `HoodieTestTable` and `HoodieWriteableTestTable` with new APIs added\n- listAllBaseAndLogFiles\n- listAllLogFiles\n- listAllBaseFiles\n- withLogAppends\n- addClean\n- addInflightClean\n\nAlso added related APIs in `FileCreateUtils`\n- createCleanFile\n- createRequestedCleanFile\n- createInflightCleanFile", "committedDate": "2020-10-05T02:15:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMyMDE4OQ==", "url": "https://github.com/apache/hudi/pull/2143#discussion_r499320189", "body": "refer to hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestUtils.java#writeRecordsToLogFiles", "bodyText": "refer to hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestUtils.java#writeRecordsToLogFiles", "bodyHTML": "<p dir=\"auto\">refer to hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestUtils.java#writeRecordsToLogFiles</p>", "author": "xushiyan", "createdAt": "2020-10-05T02:24:55Z", "path": "hudi-client/hudi-spark-client/src/test/java/org/apache/hudi/testutils/HoodieWriteableTestTable.java", "diffHunk": "@@ -128,4 +148,37 @@ public HoodieWriteableTestTable withInserts(String partition, String fileId, Hoo\n \n     return this;\n   }\n+\n+  public HoodieWriteableTestTable withLogAppends(HoodieRecord... records) throws Exception {\n+    return withLogAppends(Arrays.asList(records));\n+  }\n+\n+  public HoodieWriteableTestTable withLogAppends(List<HoodieRecord> records) throws Exception {\n+    for (List<HoodieRecord> groupedRecords: records.stream()\n+        .collect(Collectors.groupingBy(HoodieRecord::getCurrentLocation)).values()) {\n+      appendRecordsToLogFile(groupedRecords);\n+    }\n+    return this;\n+  }\n+\n+  private void appendRecordsToLogFile(List<HoodieRecord> groupedRecords) throws Exception {\n+    String partitionPath = groupedRecords.get(0).getPartitionPath();\n+    HoodieRecordLocation location = groupedRecords.get(0).getCurrentLocation();\n+    try (HoodieLogFormat.Writer logWriter = HoodieLogFormat.newWriterBuilder().onParentPath(new Path(basePath, partitionPath))\n+        .withFileExtension(HoodieLogFile.DELTA_EXTENSION).withFileId(location.getFileId())\n+        .overBaseCommit(location.getInstantTime()).withFs(fs).build()) {\n+      Map<HoodieLogBlock.HeaderMetadataType, String> header = new HashMap<>();\n+      header.put(HoodieLogBlock.HeaderMetadataType.INSTANT_TIME, location.getInstantTime());\n+      header.put(HoodieLogBlock.HeaderMetadataType.SCHEMA, schema.toString());\n+      logWriter.appendBlock(new HoodieAvroDataBlock(groupedRecords.stream().map(r -> {\n+        try {\n+          GenericRecord val = (GenericRecord) r.getData().getInsertValue(schema).get();\n+          HoodieAvroUtils.addHoodieKeyToRecord(val, r.getRecordKey(), r.getPartitionPath(), \"\");\n+          return (IndexedRecord) val;\n+        } catch (IOException e) {\n+          return null;\n+        }\n+      }).collect(Collectors.toList()), header));", "originalCommit": "1d9dac8ea23598dc778a4d86058b919580da0d3d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMyMDY2Ng==", "url": "https://github.com/apache/hudi/pull/2143#discussion_r499320666", "body": "change to return array to work with `HoodieTableFileSystemView` APIs which take in array", "bodyText": "change to return array to work with HoodieTableFileSystemView APIs which take in array", "bodyHTML": "<p dir=\"auto\">change to return array to work with <code>HoodieTableFileSystemView</code> APIs which take in array</p>", "author": "xushiyan", "createdAt": "2020-10-05T02:27:28Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestTable.java", "diffHunk": "@@ -348,12 +372,36 @@ public String getBaseFileNameById(String fileId) {\n     return baseFileName(currentInstantTime, fileId);\n   }\n \n-  public List<FileStatus> listAllFiles(String partitionPath) throws IOException {\n-    return FileSystemTestUtils.listRecursive(fs, new Path(Paths.get(basePath, partitionPath).toString()));\n+  public FileStatus[] listAllBaseFiles() throws IOException {\n+    return listAllBaseFiles(HoodieFileFormat.PARQUET.getFileExtension());\n+  }\n+\n+  public FileStatus[] listAllBaseFiles(String fileExtension) throws IOException {\n+    return FileSystemTestUtils.listRecursive(fs, new Path(basePath)).stream()\n+        .filter(status -> status.getPath().getName().endsWith(fileExtension))\n+        .toArray(FileStatus[]::new);\n+  }\n+\n+  public FileStatus[] listAllLogFiles() throws IOException {\n+    return listAllLogFiles(HoodieFileFormat.HOODIE_LOG.getFileExtension());\n+  }\n+\n+  public FileStatus[] listAllLogFiles(String fileExtension) throws IOException {\n+    return FileSystemTestUtils.listRecursive(fs, new Path(basePath)).stream()\n+        .filter(status -> status.getPath().getName().contains(fileExtension))\n+        .toArray(FileStatus[]::new);\n+  }\n+\n+  public FileStatus[] listAllBaseAndLogFiles() throws IOException {\n+    return Stream.concat(Stream.of(listAllBaseFiles()), Stream.of(listAllLogFiles())).toArray(FileStatus[]::new);\n+  }\n+\n+  public FileStatus[] listAllFilesInPartition(String partitionPath) throws IOException {\n+    return FileSystemTestUtils.listRecursive(fs, new Path(Paths.get(basePath, partitionPath).toString())).toArray(new FileStatus[0]);\n   }\n \n-  public List<FileStatus> listAllFilesInTempFolder() throws IOException {\n-    return FileSystemTestUtils.listRecursive(fs, new Path(Paths.get(basePath, HoodieTableMetaClient.TEMPFOLDER_NAME).toString()));\n+  public FileStatus[] listAllFilesInTempFolder() throws IOException {\n+    return FileSystemTestUtils.listRecursive(fs, new Path(Paths.get(basePath, HoodieTableMetaClient.TEMPFOLDER_NAME).toString())).toArray(new FileStatus[0]);", "originalCommit": "1d9dac8ea23598dc778a4d86058b919580da0d3d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEwMzE2OQ==", "url": "https://github.com/apache/hudi/pull/2143#discussion_r502103169", "body": "Considering the fluent APIs have one general pattern: method `withXXX` returns `HoodieWriteableTestTable ` itself. However, this method and above break this rule. WDYT about renaming them to `getFileIdWithInserts` or `returnFileIdWithInserts`?", "bodyText": "Considering the fluent APIs have one general pattern: method withXXX returns HoodieWriteableTestTable  itself. However, this method and above break this rule. WDYT about renaming them to getFileIdWithInserts or returnFileIdWithInserts?", "bodyHTML": "<p dir=\"auto\">Considering the fluent APIs have one general pattern: method <code>withXXX</code> returns <code>HoodieWriteableTestTable </code> itself. However, this method and above break this rule. WDYT about renaming them to <code>getFileIdWithInserts</code> or <code>returnFileIdWithInserts</code>?</p>", "author": "yanghua", "createdAt": "2020-10-09T00:50:25Z", "path": "hudi-client/hudi-spark-client/src/test/java/org/apache/hudi/testutils/HoodieWriteableTestTable.java", "diffHunk": "@@ -94,6 +106,10 @@ public String withInserts(String partition) throws Exception {\n   }\n \n   public String withInserts(String partition, HoodieRecord... records) throws Exception {\n+    return withInserts(partition, Arrays.asList(records));\n+  }\n+\n+  public String withInserts(String partition, List<HoodieRecord> records) throws Exception {", "originalCommit": "1d9dac8ea23598dc778a4d86058b919580da0d3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEyMzQ5Mw==", "url": "https://github.com/apache/hudi/pull/2143#discussion_r502123493", "bodyText": "sounds good.", "author": "xushiyan", "createdAt": "2020-10-09T01:28:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEwMzE2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEwMzc1NQ==", "url": "https://github.com/apache/hudi/pull/2143#discussion_r502103755", "body": "Logging the detailed exception information looks better?", "bodyText": "Logging the detailed exception information looks better?", "bodyHTML": "<p dir=\"auto\">Logging the detailed exception information looks better?</p>", "author": "yanghua", "createdAt": "2020-10-09T00:51:30Z", "path": "hudi-client/hudi-spark-client/src/test/java/org/apache/hudi/testutils/HoodieWriteableTestTable.java", "diffHunk": "@@ -128,4 +148,37 @@ public HoodieWriteableTestTable withInserts(String partition, String fileId, Hoo\n \n     return this;\n   }\n+\n+  public HoodieWriteableTestTable withLogAppends(HoodieRecord... records) throws Exception {\n+    return withLogAppends(Arrays.asList(records));\n+  }\n+\n+  public HoodieWriteableTestTable withLogAppends(List<HoodieRecord> records) throws Exception {\n+    for (List<HoodieRecord> groupedRecords: records.stream()\n+        .collect(Collectors.groupingBy(HoodieRecord::getCurrentLocation)).values()) {\n+      appendRecordsToLogFile(groupedRecords);\n+    }\n+    return this;\n+  }\n+\n+  private void appendRecordsToLogFile(List<HoodieRecord> groupedRecords) throws Exception {\n+    String partitionPath = groupedRecords.get(0).getPartitionPath();\n+    HoodieRecordLocation location = groupedRecords.get(0).getCurrentLocation();\n+    try (HoodieLogFormat.Writer logWriter = HoodieLogFormat.newWriterBuilder().onParentPath(new Path(basePath, partitionPath))\n+        .withFileExtension(HoodieLogFile.DELTA_EXTENSION).withFileId(location.getFileId())\n+        .overBaseCommit(location.getInstantTime()).withFs(fs).build()) {\n+      Map<HoodieLogBlock.HeaderMetadataType, String> header = new HashMap<>();\n+      header.put(HoodieLogBlock.HeaderMetadataType.INSTANT_TIME, location.getInstantTime());\n+      header.put(HoodieLogBlock.HeaderMetadataType.SCHEMA, schema.toString());\n+      logWriter.appendBlock(new HoodieAvroDataBlock(groupedRecords.stream().map(r -> {\n+        try {\n+          GenericRecord val = (GenericRecord) r.getData().getInsertValue(schema).get();\n+          HoodieAvroUtils.addHoodieKeyToRecord(val, r.getRecordKey(), r.getPartitionPath(), \"\");\n+          return (IndexedRecord) val;\n+        } catch (IOException e) {", "originalCommit": "1d9dac8ea23598dc778a4d86058b919580da0d3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEyNDg3NA==", "url": "https://github.com/apache/hudi/pull/2143#discussion_r502124874", "bodyText": "@yanghua ok fixed.", "author": "xushiyan", "createdAt": "2020-10-09T01:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjEwMzc1NQ=="}], "type": "inlineReview"}, {"oid": "cabcf317c2bdf1874f3b4e2fc8478b8e63e730a6", "url": "https://github.com/apache/hudi/commit/cabcf317c2bdf1874f3b4e2fc8478b8e63e730a6", "message": "add log warn and fix API namings", "committedDate": "2020-10-09T01:34:22Z", "type": "commit"}]}