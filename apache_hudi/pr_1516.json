{"pr_number": 1516, "pr_title": "[HUDI-784] Adressing issue with log reader on GCS", "pr_author": "afilipchik", "pr_createdAt": "2020-04-14T21:53:45Z", "pr_url": "https://github.com/apache/hudi/pull/1516", "timeline": [{"oid": "57c02459d4acc27a644183b5c52d31e91dab62fe", "url": "https://github.com/apache/hudi/commit/57c02459d4acc27a644183b5c52d31e91dab62fe", "message": "Adressing issue with log reader on GCS", "committedDate": "2020-04-14T21:51:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5NDkwMw==", "url": "https://github.com/apache/hudi/pull/1516#discussion_r411494903", "body": "makes sense to be non-static.", "bodyText": "makes sense to be non-static.", "bodyHTML": "<p dir=\"auto\">makes sense to be non-static.</p>", "author": "bvaradar", "createdAt": "2020-04-20T15:57:15Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final FSDataInputStream inputStream;\n   private final HoodieLogFile logFile;\n-  private static final byte[] MAGIC_BUFFER = new byte[6];\n+  private final byte[] magicBuffer = new byte[6];", "originalCommit": "57c02459d4acc27a644183b5c52d31e91dab62fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5Nzg4NQ==", "url": "https://github.com/apache/hudi/pull/1516#discussion_r411497885", "body": "What is the original exception were you seeing ? \r\n\r\nThis seek() call is immediately after open() so should be innocuous for other file-systems. right ?\r\n\r\nIt would be better to inline document the reasoning behind this change for future understanding.", "bodyText": "What is the original exception were you seeing ?\nThis seek() call is immediately after open() so should be innocuous for other file-systems. right ?\nIt would be better to inline document the reasoning behind this change for future understanding.", "bodyHTML": "<p dir=\"auto\">What is the original exception were you seeing ?</p>\n<p dir=\"auto\">This seek() call is immediately after open() so should be innocuous for other file-systems. right ?</p>\n<p dir=\"auto\">It would be better to inline document the reasoning behind this change for future understanding.</p>", "author": "bvaradar", "createdAt": "2020-04-20T16:00:59Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -79,6 +79,7 @@\n       this.inputStream = fsDataInputStream;\n     }\n \n+    fsDataInputStream.seek(0);", "originalCommit": "57c02459d4acc27a644183b5c52d31e91dab62fe", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MDE5Mg==", "url": "https://github.com/apache/hudi/pull/1516#discussion_r411560192", "bodyText": "magicBuffer check was failing on file open, as it couldn't find a beginning of the HUDI block in the log file.\nThat was throwing exception that was killing compaction. In the debug, it appeared that content of magicBuffer was incorrect, and steam offsets were off. Only happened when more that 1 files was scheduled to be processed. So, I didn't test all the variations originally (non static magicBuffer without seek and seek with static) as was in hurry to fix, so not sure which one actually fixes the issue. Agree that seek(0) is weird and probably non static is a fix. Added comment and additional check..", "author": "afilipchik", "createdAt": "2020-04-20T17:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQ5Nzg4NQ=="}], "type": "inlineReview"}, {"oid": "b3d67edbd90a1fb81500f491dcfcec6f92bb13e6", "url": "https://github.com/apache/hudi/commit/b3d67edbd90a1fb81500f491dcfcec6f92bb13e6", "message": "Added comemnt and a check", "committedDate": "2020-04-20T17:29:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzNTYyMQ==", "url": "https://github.com/apache/hudi/pull/1516#discussion_r416935621", "body": "@afilipchik : Can we revert this change then and try as it is likely the issue with static vs non-static ? ", "bodyText": "@afilipchik : Can we revert this change then and try as it is likely the issue with static vs non-static ?", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/afilipchik/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/afilipchik\">@afilipchik</a> : Can we revert this change then and try as it is likely the issue with static vs non-static ?</p>", "author": "bvaradar", "createdAt": "2020-04-28T21:30:35Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/table/log/HoodieLogFileReader.java", "diffHunk": "@@ -79,6 +79,11 @@\n       this.inputStream = fsDataInputStream;\n     }\n \n+    // Defensive measure to make sure nothing advanced the stream.\n+    if (fsDataInputStream.getPos() != 0) {", "originalCommit": "b3d67edbd90a1fb81500f491dcfcec6f92bb13e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg1MDMxOQ==", "url": "https://github.com/apache/hudi/pull/1516#discussion_r419850319", "bodyText": "oks", "author": "afilipchik", "createdAt": "2020-05-05T03:54:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjkzNTYyMQ=="}], "type": "inlineReview"}, {"oid": "e1dd6ef23eba4a1b81a8006a1404ec31d65ecadb", "url": "https://github.com/apache/hudi/commit/e1dd6ef23eba4a1b81a8006a1404ec31d65ecadb", "message": "Removing defensive seek 0", "committedDate": "2020-05-05T03:55:42Z", "type": "commit"}]}