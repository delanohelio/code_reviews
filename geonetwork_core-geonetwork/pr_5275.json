{"pr_number": 5275, "pr_title": "Update-fixed-info / Use db dates ", "pr_author": "fxprunayre", "pr_createdAt": "2020-12-18T08:14:38Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/5275", "timeline": [{"oid": "c264cdeced8f69eac9e3e9f2f48917ba90804b95", "url": "https://github.com/geonetwork/core-geonetwork/commit/c264cdeced8f69eac9e3e9f2f48917ba90804b95", "message": "Update-fixed-info / Set the update date to the same date as in the database. In ISO19115-3, also set record creation date from the database date.", "committedDate": "2020-12-18T08:11:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzQxNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546693415", "body": "There's some previous code doing similar stuff:\r\n\r\nhttps://github.com/geonetwork/core-geonetwork/blob/c264cdeced8f69eac9e3e9f2f48917ba90804b95/core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java#L918-L920\r\n\r\n", "bodyText": "There's some previous code doing similar stuff:\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java\n    \n    \n        Lines 918 to 920\n      in\n      c264cde\n    \n    \n    \n    \n\n        \n          \n           if (metadataId.isPresent()) { \n        \n\n        \n          \n               metadata = metadataUtils.findOne(metadataId.get()); \n        \n\n        \n          \n           }", "bodyHTML": "<p dir=\"auto\">There's some previous code doing similar stuff:</p>\n<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/geonetwork/core-geonetwork/blob/c264cdeced8f69eac9e3e9f2f48917ba90804b95/core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java#L918-L920\">core-geonetwork/core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 918 to 920\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/geonetwork/core-geonetwork/commit/c264cdeced8f69eac9e3e9f2f48917ba90804b95\">c264cde</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L918\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"918\"></td>\n          <td id=\"LC918\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (metadataId<span class=\"pl-k\">.</span>isPresent()) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L919\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"919\"></td>\n          <td id=\"LC919\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     metadata <span class=\"pl-k\">=</span> metadataUtils<span class=\"pl-k\">.</span>findOne(metadataId<span class=\"pl-k\">.</span>get()); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L920\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"920\"></td>\n          <td id=\"LC920\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "josegar74", "createdAt": "2020-12-21T13:02:24Z", "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {", "originalCommit": "c264cdeced8f69eac9e3e9f2f48917ba90804b95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI2MDUyNA==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r612260524", "bodyText": "Indeed", "author": "fxprunayre", "createdAt": "2021-04-13T08:54:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzQxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzgwNQ==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546693805", "body": "update-fixed-info is applied before the metadata is saved in the database, no? I think this code will retrieve the previous change date?", "bodyText": "update-fixed-info is applied before the metadata is saved in the database, no? I think this code will retrieve the previous change date?", "bodyHTML": "<p dir=\"auto\">update-fixed-info is applied before the metadata is saved in the database, no? I think this code will retrieve the previous change date?</p>", "author": "josegar74", "createdAt": "2020-12-21T13:03:24Z", "path": "core/src/main/java/org/fao/geonet/kernel/datamanager/base/BaseMetadataManager.java", "diffHunk": "@@ -935,7 +935,17 @@ public Element updateFixedInfo(String schema, Optional<Integer> metadataId, Stri\n             env.addContent(schemaLoc);\n \n             if (updateDatestamp == UpdateDatestamp.YES) {\n-                env.addContent(new Element(\"changeDate\").setText(new ISODate().toString()));\n+                String changeDate = new ISODate().toString();\n+                String createDate = \"\";\n+                if (metadataId.isPresent()) {\n+                    java.util.Optional<Metadata> record = metadataRepository.findById(metadataId.get());\n+                    if (record.isPresent()) {\n+                        changeDate = record.get().getDataInfo().getChangeDate().getDateAndTime();", "originalCommit": "c264cdeced8f69eac9e3e9f2f48917ba90804b95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcwMTEzMw==", "url": "https://github.com/geonetwork/core-geonetwork/pull/5275#discussion_r546701133", "bodyText": "Metadata object is modified before so this is fine.\nBut it does not work on newly created record because the record is not yet in the database. Not sure how can this be solved without adding the creation date as method parameter?", "author": "fxprunayre", "createdAt": "2020-12-21T13:19:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjY5MzgwNQ=="}], "type": "inlineReview"}, {"oid": "357c70cdc236888e71f7c1cb6b7f0354065f481f", "url": "https://github.com/geonetwork/core-geonetwork/commit/357c70cdc236888e71f7c1cb6b7f0354065f481f", "message": "Update-fixed-info / Use db dates / Remove existing check", "committedDate": "2021-04-13T08:52:34Z", "type": "commit"}, {"oid": "6c5d30dd0d595fc0ca910635c3242e39aa4272d1", "url": "https://github.com/geonetwork/core-geonetwork/commit/6c5d30dd0d595fc0ca910635c3242e39aa4272d1", "message": "Update-fixed-info / Use db dates / Remove existing check", "committedDate": "2021-04-13T08:53:31Z", "type": "commit"}]}