{"pr_number": 4482, "pr_title": "fix memory leak due to incorrect ref count handling (#4481)", "pr_author": "davidblasby", "pr_createdAt": "2020-02-27T21:19:46Z", "pr_url": "https://github.com/geonetwork/core-geonetwork/pull/4482", "timeline": [{"oid": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "url": "https://github.com/geonetwork/core-geonetwork/commit/dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "message": "4481: fix memory leak due to incorrect ref count handling", "committedDate": "2020-02-27T21:07:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUzMTgxMg==", "url": "https://github.com/geonetwork/core-geonetwork/pull/4482#discussion_r385531812", "body": "The `taxonomyReader` is used in `LuceneSearcher` and `CatalogSearcher` during the searches to build the facet summary.  In `LuceneSearcher`:\r\n\r\nhttps://github.com/geonetwork/core-geonetwork/blob/c0855205156ec0f8a6cb062071e9ac2afbd9a157/core/src/main/java/org/fao/geonet/kernel/search/LuceneSearcher.java#L1649-L1662\r\n\r\nProbably can be closed, but the existing code is not even calling `IndexAndTaxonomy.close()`, but `_sm.releaseIndexReader(indexAndTaxonomy);` that does the same code as in `IndexAndTaxonomy.close()`:\r\n\r\nhttps://github.com/geonetwork/core-geonetwork/blob/c0855205156ec0f8a6cb062071e9ac2afbd9a157/core/src/main/java/org/fao/geonet/kernel/search/SearchManager.java#L1211-L1213", "bodyText": "The taxonomyReader is used in LuceneSearcher and CatalogSearcher during the searches to build the facet summary.  In LuceneSearcher:\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/LuceneSearcher.java\n    \n    \n        Lines 1649 to 1662\n      in\n      c085520\n    \n    \n    \n    \n\n        \n          \n           private TopDocs performQuery(ServiceContext context, int startHit, int endHit, boolean buildSummary) throws Exception { \n        \n\n        \n          \n               IndexAndTaxonomy indexAndTaxonomy = _sm.getIndexReader(_language.presentationLanguage, _versionToken); \n        \n\n        \n          \n               _versionToken = indexAndTaxonomy.version; \n        \n\n        \n          \n               Pair<TopDocs, Element> results; \n        \n\n        \n          \n               try { \n        \n\n        \n          \n                   results = doSearchAndMakeSummary(endHit, startHit, endHit, \n        \n\n        \n          \n                       _language.presentationLanguage, \n        \n\n        \n          \n                       _summaryConfig, _luceneConfig, \n        \n\n        \n          \n                       indexAndTaxonomy.indexReader, \n        \n\n        \n          \n                       _query, _filter, _sort, indexAndTaxonomy.taxonomyReader, \n        \n\n        \n          \n                       buildSummary); \n        \n\n        \n          \n               } finally { \n        \n\n        \n          \n                   _sm.releaseIndexReader(indexAndTaxonomy); \n        \n\n        \n          \n               } \n        \n    \n  \n\n\nProbably can be closed, but the existing code is not even calling IndexAndTaxonomy.close(), but _sm.releaseIndexReader(indexAndTaxonomy); that does the same code as in IndexAndTaxonomy.close():\n\n  \n    \n      core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/SearchManager.java\n    \n    \n        Lines 1211 to 1213\n      in\n      c085520\n    \n    \n    \n    \n\n        \n          \n           public void releaseIndexReader(IndexAndTaxonomy reader) throws InterruptedException, IOException { \n        \n\n        \n          \n               reader.indexReader.releaseToNRTManager(); \n        \n\n        \n          \n           }", "bodyHTML": "<p dir=\"auto\">The <code>taxonomyReader</code> is used in <code>LuceneSearcher</code> and <code>CatalogSearcher</code> during the searches to build the facet summary.  In <code>LuceneSearcher</code>:</p>\n<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/geonetwork/core-geonetwork/blob/c0855205156ec0f8a6cb062071e9ac2afbd9a157/core/src/main/java/org/fao/geonet/kernel/search/LuceneSearcher.java#L1649-L1662\">core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/LuceneSearcher.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 1649 to 1662\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/geonetwork/core-geonetwork/commit/c0855205156ec0f8a6cb062071e9ac2afbd9a157\">c085520</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L1649\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1649\"></td>\n          <td id=\"LC1649\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">private</span> <span class=\"pl-smi\">TopDocs</span> <span class=\"pl-en\">performQuery</span>(<span class=\"pl-smi\">ServiceContext</span> <span class=\"pl-v\">context</span>, <span class=\"pl-k\">int</span> <span class=\"pl-v\">startHit</span>, <span class=\"pl-k\">int</span> <span class=\"pl-v\">endHit</span>, <span class=\"pl-k\">boolean</span> <span class=\"pl-v\">buildSummary</span>) <span class=\"pl-k\">throws</span> <span class=\"pl-smi\">Exception</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1650\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1650\"></td>\n          <td id=\"LC1650\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-smi\">IndexAndTaxonomy</span> indexAndTaxonomy <span class=\"pl-k\">=</span> _sm<span class=\"pl-k\">.</span>getIndexReader(_language<span class=\"pl-k\">.</span>presentationLanguage, _versionToken); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1651\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1651\"></td>\n          <td id=\"LC1651\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     _versionToken <span class=\"pl-k\">=</span> indexAndTaxonomy<span class=\"pl-k\">.</span>version; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1652\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1652\"></td>\n          <td id=\"LC1652\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">Pair&lt;<span class=\"pl-smi\">TopDocs</span>, <span class=\"pl-smi\">Element</span>&gt;</span> results; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1653\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1653\"></td>\n          <td id=\"LC1653\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">try</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1654\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1654\"></td>\n          <td id=\"LC1654\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         results <span class=\"pl-k\">=</span> doSearchAndMakeSummary(endHit, startHit, endHit, </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1655\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1655\"></td>\n          <td id=\"LC1655\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             _language<span class=\"pl-k\">.</span>presentationLanguage, </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1656\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1656\"></td>\n          <td id=\"LC1656\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             _summaryConfig, _luceneConfig, </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1657\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1657\"></td>\n          <td id=\"LC1657\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             indexAndTaxonomy<span class=\"pl-k\">.</span>indexReader, </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1658\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1658\"></td>\n          <td id=\"LC1658\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             _query, _filter, _sort, indexAndTaxonomy<span class=\"pl-k\">.</span>taxonomyReader, </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1659\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1659\"></td>\n          <td id=\"LC1659\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             buildSummary); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1660\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1660\"></td>\n          <td id=\"LC1660\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } <span class=\"pl-k\">finally</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1661\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1661\"></td>\n          <td id=\"LC1661\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         _sm<span class=\"pl-k\">.</span>releaseIndexReader(indexAndTaxonomy); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1662\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1662\"></td>\n          <td id=\"LC1662\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">Probably can be closed, but the existing code is not even calling <code>IndexAndTaxonomy.close()</code>, but <code>_sm.releaseIndexReader(indexAndTaxonomy);</code> that does the same code as in <code>IndexAndTaxonomy.close()</code>:</p>\n<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/geonetwork/core-geonetwork/blob/c0855205156ec0f8a6cb062071e9ac2afbd9a157/core/src/main/java/org/fao/geonet/kernel/search/SearchManager.java#L1211-L1213\">core-geonetwork/core/src/main/java/org/fao/geonet/kernel/search/SearchManager.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 1211 to 1213\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/geonetwork/core-geonetwork/commit/c0855205156ec0f8a6cb062071e9ac2afbd9a157\">c085520</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L1211\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1211\"></td>\n          <td id=\"LC1211\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"pl-en\">releaseIndexReader</span>(<span class=\"pl-smi\">IndexAndTaxonomy</span> <span class=\"pl-v\">reader</span>) <span class=\"pl-k\">throws</span> <span class=\"pl-smi\">InterruptedException</span>, <span class=\"pl-smi\">IOException</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1212\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1212\"></td>\n          <td id=\"LC1212\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     reader<span class=\"pl-k\">.</span>indexReader<span class=\"pl-k\">.</span>releaseToNRTManager(); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L1213\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"1213\"></td>\n          <td id=\"LC1213\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "josegar74", "createdAt": "2020-02-28T06:47:03Z", "path": "core/src/main/java/org/fao/geonet/kernel/search/IndexAndTaxonomy.java", "diffHunk": "@@ -44,5 +44,7 @@ public IndexAndTaxonomy(long version, GeonetworkMultiReader indexReader, Taxonom\n     @Override\n     public void close() throws IOException {\n         indexReader.releaseToNRTManager();\n+        //TODO: this has a taxonomyReader in it, and it should be \"closed\" (decrement a ref)", "originalCommit": "dfe48ce70b13d509fae5a0434b532c1fce6b30f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}