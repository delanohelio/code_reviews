{"pr_number": 4853, "pr_title": "Fix ldap connection pool shut down - phase 2", "pr_author": "leeyc0", "pr_createdAt": "2020-05-14T07:01:22Z", "pr_url": "https://github.com/apereo/cas/pull/4853", "timeline": [{"oid": "7b529802ad51090bc8f1894fd2bd1ecee47aabc3", "url": "https://github.com/apereo/cas/commit/7b529802ad51090bc8f1894fd2bd1ecee47aabc3", "message": "LdapUserGraphicalAuthenticationRepository convert to DisposableBean", "committedDate": "2020-05-14T07:07:29Z", "type": "commit"}, {"oid": "a6c007452c7318983fa8706cc23410f8262def97", "url": "https://github.com/apereo/cas/commit/a6c007452c7318983fa8706cc23410f8262def97", "message": "LdapAcceptableUsagePolicyRepository convert to DisposableBean", "committedDate": "2020-05-14T07:07:29Z", "type": "commit"}, {"oid": "bb27dc603c6f424705d180a20b2190de0e1519a0", "url": "https://github.com/apereo/cas/commit/bb27dc603c6f424705d180a20b2190de0e1519a0", "message": "LdapPasswordManagementService convert to DisposableBean", "committedDate": "2020-05-14T07:07:29Z", "type": "commit"}, {"oid": "742aed44ea600f973397b3acd73e81557a32f7dd", "url": "https://github.com/apereo/cas/commit/742aed44ea600f973397b3acd73e81557a32f7dd", "message": "CasWebSecurityConfigurerAdapter convert to DisposableBean", "committedDate": "2020-05-14T07:07:29Z", "type": "commit"}, {"oid": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "url": "https://github.com/apereo/cas/commit/146998c17e45a59efb8b311bb01cbd8d953c21bd", "message": "ldapAttributeRepositories use ListFactoryBean to store objects that need to be disposed", "committedDate": "2020-05-14T09:11:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxODc1NQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425018755", "body": "```suggestion\r\n    private final Map<String, ConnectionFactory> connectionFactoryList = new ConcurrentHashMap<>();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private HashMap<LdapAcceptableUsagePolicyProperties, ConnectionFactory> connectionFactoryList = new HashMap<>();\n          \n          \n            \n                private final Map<String, ConnectionFactory> connectionFactoryList = new ConcurrentHashMap<>();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\"><span class=\"x x-first\">HashMap&lt;</span><span class=\"pl-smi x x-last\">LdapAcceptableUsagePolicyProperties</span>, <span class=\"pl-smi\">ConnectionFactory</span>&gt;</span> connectionFactoryList <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">HashMap</span>&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x\"> </span><span class=\"pl-k\"><span class=\"x\">Map&lt;</span><span class=\"pl-smi x x-last\">String</span>, <span class=\"pl-smi\">ConnectionFactory</span>&gt;</span> connectionFactoryList <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">ConcurrentHashMap</span>&lt;&gt;</span>();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:01:22Z", "path": "support/cas-server-support-aup-ldap/src/main/java/org/apereo/cas/aup/LdapAcceptableUsagePolicyRepository.java", "diffHunk": "@@ -30,12 +32,17 @@\n  * @since 4.2\n  */\n @Slf4j\n-public class LdapAcceptableUsagePolicyRepository extends BaseAcceptableUsagePolicyRepository {\n+public class LdapAcceptableUsagePolicyRepository extends BaseAcceptableUsagePolicyRepository implements DisposableBean {\n     private static final long serialVersionUID = 1600024683199961892L;\n \n+    private HashMap<LdapAcceptableUsagePolicyProperties, ConnectionFactory> connectionFactoryList = new HashMap<>();", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTE0MA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425019140", "body": "```suggestion\r\n        val connectionFactory = connectionFactoryList.get(ldap.getLdapUrl());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    val connectionFactory = connectionFactoryList.get(ldap);\n          \n          \n            \n                    val connectionFactory = connectionFactoryList.get(ldap.getLdapUrl());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        val connectionFactory <span class=\"pl-k\">=</span> connectionFactoryList<span class=\"pl-k\">.</span>get(ldap);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        val connectionFactory <span class=\"pl-k\">=</span> connectionFactoryList<span class=\"pl-k\">.</span>get(ldap<span class=\"pl-k x x-first\">.</span><span class=\"x x-last\">getLdapUrl()</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:02:03Z", "path": "support/cas-server-support-aup-ldap/src/main/java/org/apereo/cas/aup/LdapAcceptableUsagePolicyRepository.java", "diffHunk": "@@ -52,7 +59,7 @@ public LdapAcceptableUsagePolicyRepository(final TicketRegistrySupport ticketReg\n             LdapUtils.LDAP_SEARCH_FILTER_DEFAULT_PARAM_NAME,\n             CollectionUtils.wrap(id));\n         LOGGER.debug(\"Constructed LDAP filter [{}]\", filter);\n-        val connectionFactory = LdapUtils.newLdaptiveConnectionFactory(ldap);\n+        val connectionFactory = connectionFactoryList.get(ldap);", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEzNzkwNw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425137907", "bodyText": "Do you want to make getLdapUrl as key? If so then I need to rewrite the corresponding set method too.", "author": "leeyc0", "createdAt": "2020-05-14T13:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTE0MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5OTE1NQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425199155", "bodyText": "Yes. Using a key based on a properties object here is scary since the object's structure is controlled by lombok. The key would be somewhat \"non-deterministic\". Using an LDAP url as a String is safer, and possibly slightly faster as a lookup key.", "author": "mmoayyed", "createdAt": "2020-05-14T14:52:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTE0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTI4Nw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425019287", "body": "```suggestion\r\n        connectionFactoryList.forEach((ldap, connectionFactory) -> \r\n            connectionFactory.close();\r\n        );\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    connectionFactoryList.forEach((ldap, connectionFactory) -> {\n          \n          \n            \n                        connectionFactory.close();\n          \n          \n            \n                    });\n          \n          \n            \n                    connectionFactoryList.forEach((ldap, connectionFactory) -> \n          \n          \n            \n                        connectionFactory.close();\n          \n          \n            \n                    );", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        connectionFactoryList<span class=\"pl-k\">.</span>forEach((ldap, connectionFactory) <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"x x-first x-last\">{</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            connectionFactory<span class=\"pl-k\">.</span>close();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"x x-first x-last\">}</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        connectionFactoryList<span class=\"pl-k\">.</span>forEach((ldap, connectionFactory) <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            connectionFactory<span class=\"pl-k\">.</span>close();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        );</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:02:17Z", "path": "support/cas-server-support-aup-ldap/src/main/java/org/apereo/cas/aup/LdapAcceptableUsagePolicyRepository.java", "diffHunk": "@@ -85,4 +92,11 @@ public boolean submit(final RequestContext requestContext, final Credential cred\n         }\n         return false;\n     }\n+\n+    @Override\n+    public void destroy() {\n+        connectionFactoryList.forEach((ldap, connectionFactory) -> {\n+            connectionFactory.close();\n+        });", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTgxMg==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425019812", "body": "Pass the connection factory, remove ctor and use lombok.", "bodyText": "Pass the connection factory, remove ctor and use lombok.", "bodyHTML": "<p dir=\"auto\">Pass the connection factory, remove ctor and use lombok.</p>", "author": "mmoayyed", "createdAt": "2020-05-14T10:03:08Z", "path": "support/cas-server-support-gua/src/main/java/org/apereo/cas/gua/impl/LdapUserGraphicalAuthenticationRepository.java", "diffHunk": "@@ -20,12 +21,24 @@\n  * @since 5.1.0\n  */\n @Slf4j\n-@RequiredArgsConstructor\n-public class LdapUserGraphicalAuthenticationRepository implements UserGraphicalAuthenticationRepository {\n+public class LdapUserGraphicalAuthenticationRepository implements UserGraphicalAuthenticationRepository, DisposableBean {\n     private static final long serialVersionUID = 421732017215881244L;\n \n     private final CasConfigurationProperties casProperties;\n \n+    private ConnectionFactory connectionFactory;\n+\n+    public LdapUserGraphicalAuthenticationRepository(final CasConfigurationProperties casProperties) {\n+        this.casProperties = casProperties;\n+        this.connectionFactory = LdapUtils.newLdaptiveConnectionFactory(\n+            casProperties.getAuthn().getGua().getLdap());\n+    }", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEzODc4NQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425138785", "bodyText": "Do you want to convert connectionFactory to a separate bean? I think this is a overkill to create a separate bean just to wrap connectionFactory into a DisposableBean.", "author": "leeyc0", "createdAt": "2020-05-14T13:32:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTgxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE5Nzg3NQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425197875", "bodyText": "Not quite. Let me clarify: There is a bean somewhere that is creating an instance of LdapUserGraphicalAuthenticationRepository, right? Inside that bean, you need to build the connection factory (as you're doing above in the ctor) and then pass to the ctor here as an argument.\nThis is so that,\n\nBuilding \"bean\" instance should happen during the configuration of the bean itself.\nDoing this allows you to delete the manual ctor and use lombok directly to generate it. Fewer LOC.\nMakes it easier to write unit tests, in case something has to be mocked down the line.\n\nI think the same pattern more or less applies to other areas in the patch.", "author": "mmoayyed", "createdAt": "2020-05-14T14:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxOTkyOQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425019929", "body": "```suggestion\r\n    private final ConnectionFactory connectionFactory;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private ConnectionFactory connectionFactory;\n          \n          \n            \n                private final ConnectionFactory connectionFactory;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">ConnectionFactory</span> connectionFactory;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">ConnectionFactory</span> connectionFactory;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:03:19Z", "path": "support/cas-server-support-gua/src/main/java/org/apereo/cas/gua/impl/LdapUserGraphicalAuthenticationRepository.java", "diffHunk": "@@ -20,12 +21,24 @@\n  * @since 5.1.0\n  */\n @Slf4j\n-@RequiredArgsConstructor\n-public class LdapUserGraphicalAuthenticationRepository implements UserGraphicalAuthenticationRepository {\n+public class LdapUserGraphicalAuthenticationRepository implements UserGraphicalAuthenticationRepository, DisposableBean {\n     private static final long serialVersionUID = 421732017215881244L;\n \n     private final CasConfigurationProperties casProperties;\n \n+    private ConnectionFactory connectionFactory;", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMDE0Nw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425020147", "body": "Necessary? ", "bodyText": "Necessary?", "bodyHTML": "<p dir=\"auto\">Necessary?</p>", "author": "mmoayyed", "createdAt": "2020-05-14T10:03:41Z", "path": "support/cas-server-support-person-directory/src/main/java/org/apereo/cas/config/CasPersonDirectoryConfiguration.java", "diffHunk": "@@ -260,11 +264,31 @@ public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepos\n     @Configuration(\"CasPersonDirectoryLdapConfiguration\")\n     public class CasPersonDirectoryLdapConfiguration implements PersonDirectoryAttributeRepositoryPlanConfigurer {\n \n+        @Bean\n+        @RefreshScope", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTEzOTU4OQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425139589", "bodyText": "ldapAttributeRepositories is a RefreshScope. If ldapAttributeRepositories refreshes then the corresponding ConnectionFactory should be closed too to free resources.", "author": "leeyc0", "createdAt": "2020-05-14T13:33:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMDE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE4NTIwMg==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425185202", "bodyText": "Anyway this is no longer relevant now after refactoring.", "author": "leeyc0", "createdAt": "2020-05-14T14:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMDE0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMDI4MA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425020280", "body": "```suggestion\r\n            bean.setSourceList(new ArrayList<>(0));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        bean.setSourceList(new ArrayList<>());\n          \n          \n            \n                        bean.setSourceList(new ArrayList<>(0));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            bean<span class=\"pl-k\">.</span>setSourceList(<span class=\"pl-k\">new</span> <span class=\"pl-k\">ArrayList&lt;&gt;</span>());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            bean<span class=\"pl-k\">.</span>setSourceList(<span class=\"pl-k\">new</span> <span class=\"pl-k\">ArrayList&lt;&gt;</span>(<span class=\"pl-c1 x x-first x-last\">0</span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:03:57Z", "path": "support/cas-server-support-person-directory/src/main/java/org/apereo/cas/config/CasPersonDirectoryConfiguration.java", "diffHunk": "@@ -260,11 +264,31 @@ public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepos\n     @Configuration(\"CasPersonDirectoryLdapConfiguration\")\n     public class CasPersonDirectoryLdapConfiguration implements PersonDirectoryAttributeRepositoryPlanConfigurer {\n \n+        @Bean\n+        @RefreshScope\n+        public ListFactoryBean personDirectoryAttributeRepositoryPlanConfigurerListConnectionFactoryListBean() {\n+            val bean = new ListFactoryBean() {\n+                @Override\n+                protected void destroyInstance(final List list) {\n+                    list.forEach(dao ->\n+                        ((ConnectionFactory) dao).close()\n+                    );\n+                }\n+            };\n+            bean.setSourceList(new ArrayList<>());", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMTU4NQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425021585", "body": "This is not a good pattern. Here's what you should do instead:\r\n\r\n- Remove the `PersonDirectoryAttributeRepositoryPlanConfigurer` from the class\r\n- Create a Bean of type `PersonDirectoryAttributeRepositoryPlanConfigurer`. Mark as conditional.\r\n- Inject and qualify `personDirectoryAttributeRepositoryPlanConfigurerListConnectionFactoryListBean` into that bean.\r\n- Register the ldap attribute repository into the plan as usual.\r\n\r\n", "bodyText": "This is not a good pattern. Here's what you should do instead:\n\nRemove the PersonDirectoryAttributeRepositoryPlanConfigurer from the class\nCreate a Bean of type PersonDirectoryAttributeRepositoryPlanConfigurer. Mark as conditional.\nInject and qualify personDirectoryAttributeRepositoryPlanConfigurerListConnectionFactoryListBean into that bean.\nRegister the ldap attribute repository into the plan as usual.", "bodyHTML": "<p dir=\"auto\">This is not a good pattern. Here's what you should do instead:</p>\n<ul dir=\"auto\">\n<li>Remove the <code>PersonDirectoryAttributeRepositoryPlanConfigurer</code> from the class</li>\n<li>Create a Bean of type <code>PersonDirectoryAttributeRepositoryPlanConfigurer</code>. Mark as conditional.</li>\n<li>Inject and qualify <code>personDirectoryAttributeRepositoryPlanConfigurerListConnectionFactoryListBean</code> into that bean.</li>\n<li>Register the ldap attribute repository into the plan as usual.</li>\n</ul>", "author": "mmoayyed", "createdAt": "2020-05-14T10:06:09Z", "path": "support/cas-server-support-person-directory/src/main/java/org/apereo/cas/config/CasPersonDirectoryConfiguration.java", "diffHunk": "@@ -307,7 +333,9 @@ public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepos\n \n         @Override\n         public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepositoryPlan plan) {\n-            plan.registerAttributeRepositories(ldapAttributeRepositories());\n+            plan.registerAttributeRepositories(ldapAttributeRepositories(\n+                personDirectoryAttributeRepositoryPlanConfigurerListConnectionFactoryListBean()\n+            ));\n         }", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3NzcyNw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425177727", "bodyText": "Do you want me to refactor like this?\ne007c63\nBTW I found that I have to create a named class to make check style to pass (lambda too long), I took this chance to put the connectionFactoryList into the class. Therefore no more ListFactoryBean needed.", "author": "leeyc0", "createdAt": "2020-05-14T14:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMTU4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMTg0NQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425021845", "body": "```suggestion\r\n    private final Map<String, ConnectionFactory> connectionFactoryMap = new ConcurrentHashMap<>();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final HashMap<LdapPasswordManagementProperties, ConnectionFactory> connectionFactoryMap = new HashMap<>();\n          \n          \n            \n                private final Map<String, ConnectionFactory> connectionFactoryMap = new ConcurrentHashMap<>();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\"><span class=\"x x-first\">HashMap&lt;</span><span class=\"pl-smi x x-last\">LdapPasswordManagementProperties</span>, <span class=\"pl-smi\">ConnectionFactory</span>&gt;</span> connectionFactoryMap <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">HashMap</span>&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\"><span class=\"x x-first\">Map&lt;</span><span class=\"pl-smi x x-last\">String</span>, <span class=\"pl-smi\">ConnectionFactory</span>&gt;</span> connectionFactoryMap <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">ConcurrentHashMap</span>&lt;&gt;</span>();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:06:37Z", "path": "support/cas-server-support-pm-ldap/src/main/java/org/apereo/cas/pm/LdapPasswordManagementService.java", "diffHunk": "@@ -29,8 +31,9 @@\n  * @since 5.0.0\n  */\n @Slf4j\n-public class LdapPasswordManagementService extends BasePasswordManagementService {\n+public class LdapPasswordManagementService extends BasePasswordManagementService implements DisposableBean {\n     private final List<LdapPasswordManagementProperties> ldapProperties;\n+    private final HashMap<LdapPasswordManagementProperties, ConnectionFactory> connectionFactoryMap = new HashMap<>();", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMjQ3Mg==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425022472", "body": "Pass the connection factory map as a ctor argument; build the map inside the bean", "bodyText": "Pass the connection factory map as a ctor argument; build the map inside the bean", "bodyHTML": "<p dir=\"auto\">Pass the connection factory map as a ctor argument; build the map inside the bean</p>", "author": "mmoayyed", "createdAt": "2020-05-14T10:07:37Z", "path": "support/cas-server-support-pm-ldap/src/main/java/org/apereo/cas/pm/LdapPasswordManagementService.java", "diffHunk": "@@ -39,6 +42,16 @@ public LdapPasswordManagementService(final CipherExecutor<Serializable, String>\n                                          final PasswordHistoryService passwordHistoryService) {\n         super(passwordManagementProperties, cipherExecutor, issuer, passwordHistoryService);\n         this.ldapProperties = passwordManagementProperties.getLdap();\n+        this.ldapProperties.forEach(ldap -> {\n+            this.connectionFactoryMap.put(ldap, LdapUtils.newLdaptiveConnectionFactory(ldap));\n+        });", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0MDE4NQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425140185", "bodyText": "See above. I believe making connectionFactoryMap into a separate bean is a overkill.", "author": "leeyc0", "createdAt": "2020-05-14T13:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMjQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMjU5OA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425022598", "body": "```suggestion\r\n        this.connectionFactoryMap.forEach((ldap, connectionFactory) -> \r\n            connectionFactory.close();\r\n        );\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.connectionFactoryMap.forEach((ldap, connectionFactory) -> {\n          \n          \n            \n                        connectionFactory.close();\n          \n          \n            \n                    });\n          \n          \n            \n                    this.connectionFactoryMap.forEach((ldap, connectionFactory) -> \n          \n          \n            \n                        connectionFactory.close();\n          \n          \n            \n                    );", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>connectionFactoryMap<span class=\"pl-k\">.</span>forEach((ldap, connectionFactory) <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"x x-first x-last\">{</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            connectionFactory<span class=\"pl-k\">.</span>close();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"x x-first x-last\">}</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>connectionFactoryMap<span class=\"pl-k\">.</span>forEach((ldap, connectionFactory) <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            connectionFactory<span class=\"pl-k\">.</span>close();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        );</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:07:47Z", "path": "support/cas-server-support-pm-ldap/src/main/java/org/apereo/cas/pm/LdapPasswordManagementService.java", "diffHunk": "@@ -39,6 +42,16 @@ public LdapPasswordManagementService(final CipherExecutor<Serializable, String>\n                                          final PasswordHistoryService passwordHistoryService) {\n         super(passwordManagementProperties, cipherExecutor, issuer, passwordHistoryService);\n         this.ldapProperties = passwordManagementProperties.getLdap();\n+        this.ldapProperties.forEach(ldap -> {\n+            this.connectionFactoryMap.put(ldap, LdapUtils.newLdaptiveConnectionFactory(ldap));\n+        });\n+    }\n+\n+    @Override\n+    public void destroy() {\n+        this.connectionFactoryMap.forEach((ldap, connectionFactory) -> {\n+            connectionFactory.close();\n+        });", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMjc2MA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425022760", "body": "```suggestion\r\n                val ldapConnectionFactory = this.connectionFactoryMap.get(ldap.getLdapUrl());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            val ldapConnectionFactory = this.connectionFactoryMap.get(ldap);\n          \n          \n            \n                            val ldapConnectionFactory = this.connectionFactoryMap.get(ldap.getLdapUrl());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                val ldapConnectionFactory <span class=\"pl-k\">=</span> <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>connectionFactoryMap<span class=\"pl-k\">.</span>get(ldap);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                val ldapConnectionFactory <span class=\"pl-k\">=</span> <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>connectionFactoryMap<span class=\"pl-k\">.</span>get(ldap<span class=\"pl-k x x-first\">.</span><span class=\"x x-last\">getLdapUrl()</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:08:05Z", "path": "support/cas-server-support-pm-ldap/src/main/java/org/apereo/cas/pm/LdapPasswordManagementService.java", "diffHunk": "@@ -75,7 +88,7 @@ public String findUsername(final String email) {\n                     LdapUtils.LDAP_SEARCH_FILTER_DEFAULT_PARAM_NAME,\n                     CollectionUtils.wrap(username));\n                 LOGGER.debug(\"Constructed LDAP filter [{}] to locate security questions\", filter);\n-                val ldapConnectionFactory = LdapUtils.newLdaptiveConnectionFactory(ldap);\n+                val ldapConnectionFactory = this.connectionFactoryMap.get(ldap);", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMzM5Nw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425023397", "body": "Pass to the ctor as argument; build inside the bean definition during construction time.", "bodyText": "Pass to the ctor as argument; build inside the bean definition during construction time.", "bodyHTML": "<p dir=\"auto\">Pass to the ctor as argument; build inside the bean definition during construction time.</p>", "author": "mmoayyed", "createdAt": "2020-05-14T10:09:08Z", "path": "webapp/cas-server-webapp-config/src/main/java/org/apereo/cas/web/security/authentication/MonitorEndpointLdapAuthenticationProvider.java", "diffHunk": "@@ -43,10 +43,24 @@\n  * @since 5.1.0\n  */\n @Slf4j\n-@RequiredArgsConstructor\n public class MonitorEndpointLdapAuthenticationProvider implements AuthenticationProvider {\n     private final MonitorProperties.Endpoints.LdapSecurity ldapProperties;\n     private final SecurityProperties securityProperties;\n+    private ConnectionFactory connectionFactory;\n+    private Authenticator authenticator;\n+\n+    public MonitorEndpointLdapAuthenticationProvider(final MonitorProperties.Endpoints.LdapSecurity ldapProperties,\n+                                                     final SecurityProperties securityProperties) {\n+        this.ldapProperties = ldapProperties;\n+        this.securityProperties = securityProperties;\n+        this.connectionFactory = LdapUtils.newLdaptiveConnectionFactory(this.ldapProperties);\n+        this.authenticator = LdapUtils.newLdaptiveAuthenticator(this.ldapProperties);\n+    }", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0MDMxMw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425140313", "bodyText": "See above", "author": "leeyc0", "createdAt": "2020-05-14T13:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMzM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMzg0Mw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425023843", "body": "Missing `@Override`?", "bodyText": "Missing @Override?", "bodyHTML": "<p dir=\"auto\">Missing <code>@Override</code>?</p>", "author": "mmoayyed", "createdAt": "2020-05-14T10:09:53Z", "path": "webapp/cas-server-webapp-config/src/main/java/org/apereo/cas/web/security/authentication/MonitorEndpointLdapAuthenticationProvider.java", "diffHunk": "@@ -43,10 +43,24 @@\n  * @since 5.1.0\n  */\n @Slf4j\n-@RequiredArgsConstructor\n public class MonitorEndpointLdapAuthenticationProvider implements AuthenticationProvider {\n     private final MonitorProperties.Endpoints.LdapSecurity ldapProperties;\n     private final SecurityProperties securityProperties;\n+    private ConnectionFactory connectionFactory;\n+    private Authenticator authenticator;\n+\n+    public MonitorEndpointLdapAuthenticationProvider(final MonitorProperties.Endpoints.LdapSecurity ldapProperties,\n+                                                     final SecurityProperties securityProperties) {\n+        this.ldapProperties = ldapProperties;\n+        this.securityProperties = securityProperties;\n+        this.connectionFactory = LdapUtils.newLdaptiveConnectionFactory(this.ldapProperties);\n+        this.authenticator = LdapUtils.newLdaptiveAuthenticator(this.ldapProperties);\n+    }\n+\n+    public void destroy() {", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0MDc0MQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425140741", "bodyText": "This particular class is not a bean so I am not declaring it as a DisposableBean.", "author": "leeyc0", "createdAt": "2020-05-14T13:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMzg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMzk5MQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425023991", "body": "```suggestion\r\n    private final ConnectionFactory connectionFactory;\r\n    private final Authenticator authenticator;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private ConnectionFactory connectionFactory;\n          \n          \n            \n                private Authenticator authenticator;\n          \n          \n            \n                private final ConnectionFactory connectionFactory;\n          \n          \n            \n                private final Authenticator authenticator;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">ConnectionFactory</span> connectionFactory;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">Authenticator</span> authenticator;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">ConnectionFactory</span> connectionFactory;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">Authenticator</span> authenticator;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-14T10:10:05Z", "path": "webapp/cas-server-webapp-config/src/main/java/org/apereo/cas/web/security/authentication/MonitorEndpointLdapAuthenticationProvider.java", "diffHunk": "@@ -43,10 +43,24 @@\n  * @since 5.1.0\n  */\n @Slf4j\n-@RequiredArgsConstructor\n public class MonitorEndpointLdapAuthenticationProvider implements AuthenticationProvider {\n     private final MonitorProperties.Endpoints.LdapSecurity ldapProperties;\n     private final SecurityProperties securityProperties;\n+    private ConnectionFactory connectionFactory;\n+    private Authenticator authenticator;", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyNDk0MQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425024941", "body": "Pass the connection factory map as argument; build inside the bean in config class.", "bodyText": "Pass the connection factory map as argument; build inside the bean in config class.", "bodyHTML": "<p dir=\"auto\">Pass the connection factory map as argument; build inside the bean in config class.</p>", "author": "mmoayyed", "createdAt": "2020-05-14T10:11:36Z", "path": "support/cas-server-support-aup-ldap/src/main/java/org/apereo/cas/aup/LdapAcceptableUsagePolicyRepository.java", "diffHunk": "@@ -30,12 +32,17 @@\n  * @since 4.2\n  */\n @Slf4j\n-public class LdapAcceptableUsagePolicyRepository extends BaseAcceptableUsagePolicyRepository {\n+public class LdapAcceptableUsagePolicyRepository extends BaseAcceptableUsagePolicyRepository implements DisposableBean {\n     private static final long serialVersionUID = 1600024683199961892L;\n \n+    private HashMap<LdapAcceptableUsagePolicyProperties, ConnectionFactory> connectionFactoryList = new HashMap<>();\n+\n     public LdapAcceptableUsagePolicyRepository(final TicketRegistrySupport ticketRegistrySupport,\n                                                final AcceptableUsagePolicyProperties aupProperties) {\n         super(ticketRegistrySupport, aupProperties);\n+        aupProperties.getLdap().forEach(ldap -> {\n+            connectionFactoryList.put(ldap, LdapUtils.newLdaptiveConnectionFactory(ldap));\n+        });", "originalCommit": "146998c17e45a59efb8b311bb01cbd8d953c21bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE0MDkyNA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r425140924", "bodyText": "See above.", "author": "leeyc0", "createdAt": "2020-05-14T13:35:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyNDk0MQ=="}], "type": "inlineReview"}, {"oid": "bb436419395abdf2741aa2f494bb0eb2a5ca14b8", "url": "https://github.com/apereo/cas/commit/bb436419395abdf2741aa2f494bb0eb2a5ca14b8", "message": "misc code fixes", "committedDate": "2020-05-14T14:08:21Z", "type": "commit"}, {"oid": "e007c63ec51b55d019fbba7c9ef9cbba151a5430", "url": "https://github.com/apereo/cas/commit/e007c63ec51b55d019fbba7c9ef9cbba151a5430", "message": "refactor LDAP Attribute Repository", "committedDate": "2020-05-14T14:20:53Z", "type": "commit"}, {"oid": "0e9ccd2fe6b3d8f0339093575496e6579b06f8f6", "url": "https://github.com/apereo/cas/commit/0e9ccd2fe6b3d8f0339093575496e6579b06f8f6", "message": "move ConnectionFactory Object out of the Bean class", "committedDate": "2020-05-14T15:55:24Z", "type": "commit"}, {"oid": "2cf34340239d921511851b449d2143a837d2b948", "url": "https://github.com/apereo/cas/commit/2cf34340239d921511851b449d2143a837d2b948", "message": "fix unit tests", "committedDate": "2020-05-15T01:41:58Z", "type": "commit"}, {"oid": "984dbec0bd1e23a25c23e567123136aa86e8c4c4", "url": "https://github.com/apereo/cas/commit/984dbec0bd1e23a25c23e567123136aa86e8c4c4", "message": "Merge branch 'master' into fix-LdapShutdown-master-phase2", "committedDate": "2020-05-19T19:21:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1MzczNQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r427953735", "body": "Remove Autowired.", "bodyText": "Remove Autowired.", "bodyHTML": "<p dir=\"auto\">Remove Autowired.</p>", "author": "mmoayyed", "createdAt": "2020-05-20T12:03:20Z", "path": "support/cas-server-support-person-directory/src/main/java/org/apereo/cas/config/CasPersonDirectoryConfiguration.java", "diffHunk": "@@ -257,23 +260,36 @@ public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepos\n     }\n \n     @ConditionalOnProperty(name = \"cas.authn.attribute-repository.ldap[0].ldap-url\")\n-    @Configuration(\"CasPersonDirectoryLdapConfiguration\")\n-    public class CasPersonDirectoryLdapConfiguration implements PersonDirectoryAttributeRepositoryPlanConfigurer {\n+    @Bean\n+    @Autowired", "originalCommit": "984dbec0bd1e23a25c23e567123136aa86e8c4c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1NDAwNw==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r427954007", "body": "```suggestion\r\n        private final List<ConnectionFactory> connectionFactoryList = new ArrayList<>(0);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private final ArrayList<ConnectionFactory> connectionFactoryList = new ArrayList<>(0);\n          \n          \n            \n                    private final List<ConnectionFactory> connectionFactoryList = new ArrayList<>(0);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">ArrayList</span>&lt;<span class=\"pl-smi\">ConnectionFactory</span>&gt;</span> connectionFactoryList <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ArrayList&lt;&gt;</span>(<span class=\"pl-c1\">0</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">List</span>&lt;<span class=\"pl-smi\">ConnectionFactory</span>&gt;</span> connectionFactoryList <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ArrayList&lt;&gt;</span>(<span class=\"pl-c1\">0</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mmoayyed", "createdAt": "2020-05-20T12:03:53Z", "path": "support/cas-server-support-person-directory/src/main/java/org/apereo/cas/config/CasPersonDirectoryConfiguration.java", "diffHunk": "@@ -257,23 +260,36 @@ public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepos\n     }\n \n     @ConditionalOnProperty(name = \"cas.authn.attribute-repository.ldap[0].ldap-url\")\n-    @Configuration(\"CasPersonDirectoryLdapConfiguration\")\n-    public class CasPersonDirectoryLdapConfiguration implements PersonDirectoryAttributeRepositoryPlanConfigurer {\n+    @Bean\n+    @Autowired\n+    @RefreshScope\n+    public PersonDirectoryAttributeRepositoryPlanConfigurer ldapAttributeRepositoryPlanConfigurer() {\n+        return new LdapAttributeRepositoryPlanConfigurer();\n+    }\n \n-        @ConditionalOnMissingBean(name = \"ldapAttributeRepositories\")\n-        @Bean\n-        @RefreshScope\n-        public List<IPersonAttributeDao> ldapAttributeRepositories() {\n-            val list = new ArrayList<IPersonAttributeDao>();\n+    private class LdapAttributeRepositoryPlanConfigurer implements PersonDirectoryAttributeRepositoryPlanConfigurer, DisposableBean {\n+        private final ArrayList<ConnectionFactory> connectionFactoryList = new ArrayList<>(0);", "originalCommit": "984dbec0bd1e23a25c23e567123136aa86e8c4c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1NDA4OA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r427954088", "body": "Can this be a static class? ", "bodyText": "Can this be a static class?", "bodyHTML": "<p dir=\"auto\">Can this be a static class?</p>", "author": "mmoayyed", "createdAt": "2020-05-20T12:04:03Z", "path": "support/cas-server-support-person-directory/src/main/java/org/apereo/cas/config/CasPersonDirectoryConfiguration.java", "diffHunk": "@@ -257,23 +260,36 @@ public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepos\n     }\n \n     @ConditionalOnProperty(name = \"cas.authn.attribute-repository.ldap[0].ldap-url\")\n-    @Configuration(\"CasPersonDirectoryLdapConfiguration\")\n-    public class CasPersonDirectoryLdapConfiguration implements PersonDirectoryAttributeRepositoryPlanConfigurer {\n+    @Bean\n+    @Autowired\n+    @RefreshScope\n+    public PersonDirectoryAttributeRepositoryPlanConfigurer ldapAttributeRepositoryPlanConfigurer() {\n+        return new LdapAttributeRepositoryPlanConfigurer();\n+    }\n \n-        @ConditionalOnMissingBean(name = \"ldapAttributeRepositories\")\n-        @Bean\n-        @RefreshScope\n-        public List<IPersonAttributeDao> ldapAttributeRepositories() {\n-            val list = new ArrayList<IPersonAttributeDao>();\n+    private class LdapAttributeRepositoryPlanConfigurer implements PersonDirectoryAttributeRepositoryPlanConfigurer, DisposableBean {", "originalCommit": "984dbec0bd1e23a25c23e567123136aa86e8c4c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEyNjMyMA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r428126320", "bodyText": "configureAttributeRepositoryPlan() have a reference to casProperties, which is instance property. It is possible to convert to static if we tweak LdapAttributeRepositoryPlanConfigurer and add casProperties as a inner class attribute. Is it absolutely necessary?", "author": "leeyc0", "createdAt": "2020-05-20T15:57:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1NDA4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODEzMDE1OA==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r428130158", "bodyText": "It's not. Thanks for the note. Let's keep it the way you have it now.", "author": "mmoayyed", "createdAt": "2020-05-20T16:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1NDA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk1NTAzOQ==", "url": "https://github.com/apereo/cas/pull/4853#discussion_r427955039", "body": "Managing the connection factory should be the responsibility of the LDAP DAO itself. On dispose, you should call the plan for each LDAP DAO to invoke each DAO to destroy/close, and the DAO will know what to do on close. Consider merging with master once where you can take advantage of the DAO#close() ops for LDAP DAOs, and also you'd have the ability to filter attribute repositories by a type predicate. ", "bodyText": "Managing the connection factory should be the responsibility of the LDAP DAO itself. On dispose, you should call the plan for each LDAP DAO to invoke each DAO to destroy/close, and the DAO will know what to do on close. Consider merging with master once where you can take advantage of the DAO#close() ops for LDAP DAOs, and also you'd have the ability to filter attribute repositories by a type predicate.", "bodyHTML": "<p dir=\"auto\">Managing the connection factory should be the responsibility of the LDAP DAO itself. On dispose, you should call the plan for each LDAP DAO to invoke each DAO to destroy/close, and the DAO will know what to do on close. Consider merging with master once where you can take advantage of the DAO#close() ops for LDAP DAOs, and also you'd have the ability to filter attribute repositories by a type predicate.</p>", "author": "mmoayyed", "createdAt": "2020-05-20T12:05:54Z", "path": "support/cas-server-support-person-directory/src/main/java/org/apereo/cas/config/CasPersonDirectoryConfiguration.java", "diffHunk": "@@ -257,23 +260,36 @@ public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepos\n     }\n \n     @ConditionalOnProperty(name = \"cas.authn.attribute-repository.ldap[0].ldap-url\")\n-    @Configuration(\"CasPersonDirectoryLdapConfiguration\")\n-    public class CasPersonDirectoryLdapConfiguration implements PersonDirectoryAttributeRepositoryPlanConfigurer {\n+    @Bean\n+    @Autowired\n+    @RefreshScope\n+    public PersonDirectoryAttributeRepositoryPlanConfigurer ldapAttributeRepositoryPlanConfigurer() {\n+        return new LdapAttributeRepositoryPlanConfigurer();\n+    }\n \n-        @ConditionalOnMissingBean(name = \"ldapAttributeRepositories\")\n-        @Bean\n-        @RefreshScope\n-        public List<IPersonAttributeDao> ldapAttributeRepositories() {\n-            val list = new ArrayList<IPersonAttributeDao>();\n+    private class LdapAttributeRepositoryPlanConfigurer implements PersonDirectoryAttributeRepositoryPlanConfigurer, DisposableBean {\n+        private final ArrayList<ConnectionFactory> connectionFactoryList = new ArrayList<>(0);\n+\n+        @Override\n+        public void destroy() {\n+            connectionFactoryList.forEach(ConnectionFactory::close);\n+        }\n+\n+        @Override\n+        @SneakyThrows\n+        public void configureAttributeRepositoryPlan(final PersonDirectoryAttributeRepositoryPlan plan) {\n             val attrs = casProperties.getAuthn().getAttributeRepository();\n+\n             attrs.getLdap()\n                 .stream()\n                 .filter(ldap -> StringUtils.isNotBlank(ldap.getBaseDn()) && StringUtils.isNotBlank(ldap.getLdapUrl()))\n                 .forEach(ldap -> {\n                     val ldapDao = new LdaptivePersonAttributeDao();\n                     FunctionUtils.doIfNotNull(ldap.getId(), ldapDao::setId);\n                     LOGGER.debug(\"Configured LDAP attribute source for [{}] and baseDn [{}]\", ldap.getLdapUrl(), ldap.getBaseDn());\n-                    ldapDao.setConnectionFactory(LdapUtils.newLdaptiveConnectionFactory(ldap));\n+                    val connectionFactory = LdapUtils.newLdaptiveConnectionFactory(ldap);\n+                    connectionFactoryList.add(connectionFactory);\n+                    ldapDao.setConnectionFactory(connectionFactory);", "originalCommit": "984dbec0bd1e23a25c23e567123136aa86e8c4c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d184ce39ea927d01d5d4096ff063aa606f7c7e0d", "url": "https://github.com/apereo/cas/commit/d184ce39ea927d01d5d4096ff063aa606f7c7e0d", "message": "Merge branch 'master' of https://github.com/apereo/cas into fix-LdapShutdown-master-phase2", "committedDate": "2020-05-21T01:12:21Z", "type": "commit"}, {"oid": "b14b80e515734dad4938c6c80ef3666ea615acd6", "url": "https://github.com/apereo/cas/commit/b14b80e515734dad4938c6c80ef3666ea615acd6", "message": "misc code fixes", "committedDate": "2020-05-21T01:20:24Z", "type": "commit"}, {"oid": "e1957c33c278db0f68ad67b101c5b1114f7b3fce", "url": "https://github.com/apereo/cas/commit/e1957c33c278db0f68ad67b101c5b1114f7b3fce", "message": "Merge branch 'master' into fix-LdapShutdown-master-phase2", "committedDate": "2020-05-21T07:26:19Z", "type": "commit"}]}