{"pr_number": 2326, "pr_title": "fix #2325 Add method to snapshot factory+global schedulers, used by VTS", "pr_author": "simonbasle", "pr_createdAt": "2020-08-13T14:11:42Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2326", "timeline": [{"oid": "0d0295e8ca2933547c42cfdb213c0d6e865d5e6b", "url": "https://github.com/reactor/reactor-core/commit/0d0295e8ca2933547c42cfdb213c0d6e865d5e6b", "message": "fix #2325 Add method to snapshot factory+global schedulers, used by VTS", "committedDate": "2020-08-13T14:10:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NzM1Nw==", "url": "https://github.com/reactor/reactor-core/pull/2326#discussion_r470597357", "body": "This should be the second sentence. The current javadoc doesn't mention that this allows setting the factory in the first place.", "bodyText": "This should be the second sentence. The current javadoc doesn't mention that this allows setting the factory in the first place.", "bodyHTML": "<p dir=\"auto\">This should be the second sentence. The current javadoc doesn't mention that this allows setting the factory in the first place.</p>", "author": "ericbottard", "createdAt": "2020-08-14T12:36:47Z", "path": "reactor-core/src/main/java/reactor/core/scheduler/Schedulers.java", "diffHunk": "@@ -677,16 +678,62 @@ public static void disableMetrics() {\n \t/**\n \t * Re-apply default factory to {@link Schedulers}\n \t */\n-\tpublic static void resetFactory(){\n+\tpublic static void resetFactory() {\n \t\tsetFactory(DEFAULT);\n \t}\n \n+\t/**\n+\t * Set the current {@link Schedulers} aside in a capturing {@link Snapshot} that", "originalCommit": "0d0295e8ca2933547c42cfdb213c0d6e865d5e6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwMjA4OA==", "url": "https://github.com/reactor/reactor-core/pull/2326#discussion_r470602088", "body": "```suggestion\r\n\t * Reset the Factory and Schedulers with the ones saved in a \r\n\t * previously {@link #setFactoryWithSnapshot(Factory) captured} snapshot.\r\n\t * <p>Passing {@code null} re-applies the default factory.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @param snapshot\n          \n          \n            \n            \t * Reset the Factory and Schedulers with the ones saved in a \n          \n          \n            \n            \t * previously {@link #setFactoryWithSnapshot(Factory) captured} snapshot.\n          \n          \n            \n            \t * <p>Passing {@code null} re-applies the default factory.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> <span class=\"pl-k x x-first\">@param</span><span class=\"x x-last\"> snapshot</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> <span class=\"pl-smi x x-first\">Reset</span><span class=\"x\"> the </span><span class=\"pl-smi x\">Factory</span><span class=\"x\"> and </span><span class=\"pl-smi x\">Schedulers</span><span class=\"x x-last\"> with the ones saved in a </span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> previously {<span class=\"pl-k\">@link</span> #setFactoryWithSnapshot(<span class=\"pl-smi\">Factory</span>) captured} snapshot.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> <span class=\"pl-k\">&lt;</span>p<span class=\"pl-k\">&gt;</span><span class=\"pl-smi\">Passing</span> {<span class=\"pl-k\">@code</span> <span class=\"pl-c1\">null</span>} re<span class=\"pl-k\">-</span>applies the <span class=\"pl-k\">default</span> factory.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ericbottard", "createdAt": "2020-08-14T12:46:57Z", "path": "reactor-core/src/main/java/reactor/core/scheduler/Schedulers.java", "diffHunk": "@@ -677,16 +678,62 @@ public static void disableMetrics() {\n \t/**\n \t * Re-apply default factory to {@link Schedulers}\n \t */\n-\tpublic static void resetFactory(){\n+\tpublic static void resetFactory() {\n \t\tsetFactory(DEFAULT);\n \t}\n \n+\t/**\n+\t * Set the current {@link Schedulers} aside in a capturing {@link Snapshot} that\n+\t * can be later restored via {@link #resetFrom(Snapshot)}.\n+\t *\n+\t * @return a {@link Snapshot} representing a restorable snapshot of {@link Schedulers}\n+\t */\n+\tpublic static Snapshot setFactoryWithSnapshot(Factory newFactory) {\n+\t\t//nulling out CACHED references ensures that the schedulers won't be disposed\n+\t\t//when setting the newFactory via setFactory\n+\t\tSnapshot snapshot = new Snapshot(\n+\t\t\t\tCACHED_ELASTIC.getAndSet(null),\n+\t\t\t\tCACHED_BOUNDED_ELASTIC.getAndSet(null),\n+\t\t\t\tCACHED_PARALLEL.getAndSet(null),\n+\t\t\t\tCACHED_SINGLE.getAndSet(null),\n+\t\t\t\tfactory);\n+\t\tsetFactory(newFactory);\n+\t\treturn snapshot;\n+\t}\n+\n+\t/**\n+\t * @param snapshot", "originalCommit": "0d0295e8ca2933547c42cfdb213c0d6e865d5e6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwMjUwNg==", "url": "https://github.com/reactor/reactor-core/pull/2326#discussion_r470602506", "body": "```suggestion\r\n\t * (setup/beforeAll/beforeClass...). The created Scheduler is returned.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * (setup/beforeAll/beforeClass...). The create Scheduler is returned.\n          \n          \n            \n            \t * (setup/beforeAll/beforeClass...). The created Scheduler is returned.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> (setup<span class=\"pl-k\">/</span>beforeAll<span class=\"pl-k\">/</span>beforeClass<span class=\"pl-k\">.</span><span class=\"pl-c1\">..</span>)<span class=\"pl-c1\">.</span> <span class=\"pl-smi\">The</span> <span class=\"x x-first x-last\">create</span> <span class=\"pl-smi\">Scheduler</span> is returned.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> (setup<span class=\"pl-k\">/</span>beforeAll<span class=\"pl-k\">/</span>beforeClass<span class=\"pl-k\">.</span><span class=\"pl-c1\">..</span>)<span class=\"pl-c1\">.</span> <span class=\"pl-smi\">The</span> <span class=\"x x-first x-last\">created</span> <span class=\"pl-smi\">Scheduler</span> is returned.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ericbottard", "createdAt": "2020-08-14T12:47:52Z", "path": "reactor-test/src/main/java/reactor/test/scheduler/VirtualTimeScheduler.java", "diffHunk": "@@ -77,8 +77,12 @@ public static VirtualTimeScheduler create(boolean defer) {\n \t * Assign a newly created {@link VirtualTimeScheduler} to all {@link reactor.core.scheduler.Schedulers.Factory}\n \t * factories ONLY if no {@link VirtualTimeScheduler} is currently set. In case of scheduler creation,\n \t * there is no deferring of time operations (see {@link #create(boolean)}.\n-\t * While the method is thread safe, its usually advised to execute such\n-\t * wide-impact BEFORE all tested code runs (setup etc). The created scheduler is returned.\n+\t * Note that prior to replacing the factories, a {@link Schedulers#setFactoryWithSnapshot(Schedulers.Factory) snapshot}\n+\t * will be performed. Resetting the factory will restore said snapshot.\n+\t * <p>\n+\t * While this methods makes best effort to be thread safe, it is usually advised to\n+\t * perform such wide-impact setup serially and BEFORE all test code runs\n+\t * (setup/beforeAll/beforeClass...). The create Scheduler is returned.", "originalCommit": "0d0295e8ca2933547c42cfdb213c0d6e865d5e6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwMjYyMA==", "url": "https://github.com/reactor/reactor-core/pull/2326#discussion_r470602620", "body": "```suggestion\r\n\t * (setup/beforeAll/beforeClass...). The created Scheduler is returned.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * (setup/beforeAll/beforeClass...). The create Scheduler is returned.\n          \n          \n            \n            \t * (setup/beforeAll/beforeClass...). The created Scheduler is returned.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> (setup<span class=\"pl-k\">/</span>beforeAll<span class=\"pl-k\">/</span>beforeClass<span class=\"pl-k\">.</span><span class=\"pl-c1\">..</span>)<span class=\"pl-c1\">.</span> <span class=\"pl-smi\">The</span> <span class=\"x x-first x-last\">create</span> <span class=\"pl-smi\">Scheduler</span> is returned.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> (setup<span class=\"pl-k\">/</span>beforeAll<span class=\"pl-k\">/</span>beforeClass<span class=\"pl-k\">.</span><span class=\"pl-c1\">..</span>)<span class=\"pl-c1\">.</span> <span class=\"pl-smi\">The</span> <span class=\"x x-first x-last\">created</span> <span class=\"pl-smi\">Scheduler</span> is returned.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ericbottard", "createdAt": "2020-08-14T12:48:07Z", "path": "reactor-test/src/main/java/reactor/test/scheduler/VirtualTimeScheduler.java", "diffHunk": "@@ -90,8 +94,13 @@ public static VirtualTimeScheduler getOrSet() {\n \t * Assign a newly created {@link VirtualTimeScheduler} to all {@link reactor.core.scheduler.Schedulers.Factory}\n \t * factories ONLY if no {@link VirtualTimeScheduler} is currently set. In case of scheduler creation,\n \t * there is opt-in deferring of time related operations (see {@link #create(boolean)}.\n-\t * While the method is thread safe, its usually advised to execute such\n-\t * wide-impact BEFORE all tested code runs (setup etc). The created scheduler is returned.\n+\t * Note that prior to replacing the factories, a {@link Schedulers#setFactoryWithSnapshot(Schedulers.Factory) snapshot}\n+\t * will be performed. Resetting the factory will restore said snapshot.\n+\t * <p>\n+\t * While this methods makes best effort to be thread safe, it is usually advised to\n+\t * perform such wide-impact setup serially and BEFORE all test code runs\n+\t * (setup/beforeAll/beforeClass...). The create Scheduler is returned.", "originalCommit": "0d0295e8ca2933547c42cfdb213c0d6e865d5e6b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "71008cd714df113ee778bf63650d4c7b492f2714", "url": "https://github.com/reactor/reactor-core/commit/71008cd714df113ee778bf63650d4c7b492f2714", "message": "Apply suggestions from code review\n\nCo-authored-by: Eric Bottard <313494+ericbottard@users.noreply.github.com>", "committedDate": "2020-08-14T15:28:09Z", "type": "commit"}, {"oid": "2563adff85e8a0ae57f7f5af098eb6e246db1db2", "url": "https://github.com/reactor/reactor-core/commit/2563adff85e8a0ae57f7f5af098eb6e246db1db2", "message": "Improve javadoc of setFactoryWithSnapshot and resetFrom", "committedDate": "2020-08-14T15:51:54Z", "type": "commit"}]}