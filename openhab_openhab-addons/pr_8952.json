{"pr_number": 8952, "pr_title": "[Vigicrues] OH3 enhancements", "pr_author": "clinique", "pr_createdAt": "2020-11-03T15:40:14Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8952", "timeline": [{"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3", "url": "https://github.com/openhab/openhab-addons/commit/cfa65cbc4d78b31a831625487b8437ff3b25fae3", "message": "Staging work\nSaving my work\nVigicrues extensions for OH3\nFirst code review\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-03T15:44:50Z", "type": "commit"}, {"oid": "cfa65cbc4d78b31a831625487b8437ff3b25fae3", "url": "https://github.com/openhab/openhab-addons/commit/cfa65cbc4d78b31a831625487b8437ff3b25fae3", "message": "Staging work\nSaving my work\nVigicrues extensions for OH3\nFirst code review\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-03T15:44:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNzc1NA==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517007754", "body": "You don't even check if the handler being removed is even related to the service you are unregistering?\r\nTypically you keep track of a map of handler instances to registered services.", "bodyText": "You don't even check if the handler being removed is even related to the service you are unregistering?\nTypically you keep track of a map of handler instances to registered services.", "bodyHTML": "<p dir=\"auto\">You don't even check if the handler being removed is even related to the service you are unregistering?<br>\nTypically you keep track of a map of handler instances to registered services.</p>", "author": "cpmeister", "createdAt": "2020-11-03T23:06:43Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "diffHunk": "@@ -64,10 +72,13 @@ public boolean supportsThingType(ThingTypeUID thingTypeUID) {\n     protected @Nullable ThingHandler createHandler(Thing thing) {\n         ThingTypeUID thingTypeUID = thing.getThingTypeUID();\n \n-        if (thingTypeUID.equals(THING_TYPE_VIGI_CRUES)) {\n-            return new VigiCruesHandler(thing, timeZoneProvider, gson);\n-        }\n+        return supportsThingType(thingTypeUID) ? new VigiCruesHandler(thing, locationProvider, apiHandler) : null;\n+    }\n \n-        return null;\n+    @Override\n+    protected void removeHandler(ThingHandler thingHandler) {\n+        if (serviceReg != null) {\n+            serviceReg.unregister();\n+        }\n     }", "originalCommit": "cfa65cbc4d78b31a831625487b8437ff3b25fae3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517008105", "body": "Why isn't the VigiCruesDiscoveryService a `@Component`?", "bodyText": "Why isn't the VigiCruesDiscoveryService a @Component?", "bodyHTML": "<p dir=\"auto\">Why isn't the VigiCruesDiscoveryService a <code>@Component</code>?</p>", "author": "cpmeister", "createdAt": "2020-11-03T23:07:41Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/VigiCruesHandlerFactory.java", "diffHunk": "@@ -42,17 +44,23 @@\n @Component(service = ThingHandlerFactory.class, configurationPid = \"binding.vigicrues\")\n @NonNullByDefault\n public class VigiCruesHandlerFactory extends BaseThingHandlerFactory {\n-    private final Gson gson;\n-    // Needed for converting UTC time to local time\n-    private final TimeZoneProvider timeZoneProvider;\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+    private @Nullable ServiceRegistration<?> serviceReg;\n \n     @Activate\n-    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider) {\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = new GsonBuilder()\n-                .registerTypeAdapter(ZonedDateTime.class, (JsonDeserializer<ZonedDateTime>) (json, type,\n-                        jsonDeserializationContext) -> ZonedDateTime.parse(json.getAsJsonPrimitive().getAsString()))\n-                .create();\n+    public VigiCruesHandlerFactory(@Reference TimeZoneProvider timeZoneProvider,\n+            @Reference LocationProvider locationProvider) {\n+        this.locationProvider = locationProvider;\n+        this.apiHandler = new ApiHandler(timeZoneProvider);\n+    }\n+\n+    @Override\n+    protected void activate(ComponentContext componentContext) {\n+        super.activate(componentContext);\n+        VigiCruesDiscoveryService discoveryService = new VigiCruesDiscoveryService(apiHandler, locationProvider);\n+        serviceReg = bundleContext.registerService(DiscoveryService.class.getName(), discoveryService,\n+                new Hashtable<>());", "originalCommit": "cfa65cbc4d78b31a831625487b8437ff3b25fae3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1Mzc5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517253795", "bodyText": "Because it needs the ApiHandler", "author": "clinique", "createdAt": "2020-11-04T10:45:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MzMyMw==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517583323", "bodyText": "Why not make the ApiHandler a @Component as well then?", "author": "cpmeister", "createdAt": "2020-11-04T19:33:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk3MDgwMg==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517970802", "bodyText": "Did it.", "author": "clinique", "createdAt": "2020-11-05T11:10:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwODEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMzM3NA==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517013374", "body": "I don't see much of a purpose of this class. It would be much simpler to replace this class with a series of methods in API handler instead, one for each type of api request.", "bodyText": "I don't see much of a purpose of this class. It would be much simpler to replace this class with a series of methods in API handler instead, one for each type of api request.", "bodyHTML": "<p dir=\"auto\">I don't see much of a purpose of this class. It would be much simpler to replace this class with a series of methods in API handler instead, one for each type of api request.</p>", "author": "cpmeister", "createdAt": "2020-11-03T23:23:37Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiRequest.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.library.types.PointType;\n+\n+/**\n+ * The {@link APIRequests} defines all the action classes that can be used\n+ * when interaction with Vigicrues API\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ApiRequest {", "originalCommit": "cfa65cbc4d78b31a831625487b8437ff3b25fae3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI2NTQxMA==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517265410", "bodyText": "Removed", "author": "clinique", "createdAt": "2020-11-04T11:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAxMzM3NA=="}], "type": "inlineReview"}, {"oid": "685bf8f3e20a730fbaec799b0a7efd673368b306", "url": "https://github.com/openhab/openhab-addons/commit/685bf8f3e20a730fbaec799b0a7efd673368b306", "message": "Code review and some corrections\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-04T11:25:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MTY4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517581683", "body": "You can simplify your api calls a bit by handling the json parsing in this method as well.\r\n\r\n```suggestion\r\n    private <T> T execute(String url, Class<T> responseType) throws VigiCruesException {\r\n       try {\r\n            String jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\r\n            return gson.fromJson(response, responseType);\r\n        } catch (IOException e) {\r\n            throw new VigiCruesException(e);\r\n        } catch (JsonSyntaxException e) {\r\n            throw new VigiCruesException(e);\r\n        }\r\n    }\r\n```", "bodyText": "You can simplify your api calls a bit by handling the json parsing in this method as well.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private String execute(String url) throws VigiCruesException {\n          \n          \n            \n                    String jsonResponse = \"\";\n          \n          \n            \n                    try {\n          \n          \n            \n                        jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n          \n          \n            \n                        return jsonResponse;\n          \n          \n            \n                    } catch (IOException e) {\n          \n          \n            \n                        throw new VigiCruesException(e);\n          \n          \n            \n                    }\n          \n          \n            \n                }\n          \n          \n            \n                private <T> T execute(String url, Class<T> responseType) throws VigiCruesException {\n          \n          \n            \n                   try {\n          \n          \n            \n                        String jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n          \n          \n            \n                        return gson.fromJson(response, responseType);\n          \n          \n            \n                    } catch (IOException e) {\n          \n          \n            \n                        throw new VigiCruesException(e);\n          \n          \n            \n                    } catch (JsonSyntaxException e) {\n          \n          \n            \n                        throw new VigiCruesException(e);\n          \n          \n            \n                    }\n          \n          \n            \n                }", "bodyHTML": "<p dir=\"auto\">You can simplify your api calls a bit by handling the json parsing in this method as well.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"70\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">String</span> execute(<span class=\"pl-smi\">String</span> url) throws <span class=\"pl-smi\">VigiCruesException</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"71\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">String</span> jsonResponse <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"72\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"73\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            jsonResponse <span class=\"pl-k\">=</span> <span class=\"pl-smi\">HttpUtil</span><span class=\"pl-k\">.</span>executeUrl(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>GET<span class=\"pl-pds\">\"</span></span>, url, <span class=\"pl-c1\">TIMEOUT_MS</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"74\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">return</span> jsonResponse;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"75\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">IOException</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"76\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">VigiCruesException</span>(e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"77\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"78\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"70\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">&lt;</span><span class=\"pl-smi\">T</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">T</span> execute(<span class=\"pl-smi\">String</span> url, <span class=\"pl-k\">Class&lt;<span class=\"pl-smi\">T</span>&gt;</span> responseType) throws <span class=\"pl-smi\">VigiCruesException</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"71\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">       <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"72\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">String</span> jsonResponse <span class=\"pl-k\">=</span> <span class=\"pl-smi\">HttpUtil</span><span class=\"pl-k\">.</span>executeUrl(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>GET<span class=\"pl-pds\">\"</span></span>, url, <span class=\"pl-c1\">TIMEOUT_MS</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"73\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span> gson<span class=\"pl-k\">.</span>fromJson(response, responseType);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"74\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">IOException</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"75\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">VigiCruesException</span>(e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"76\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">JsonSyntaxException</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"77\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">VigiCruesException</span>(e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"78\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"79\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-11-04T19:30:01Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.io.IOException;\n+import java.time.ZonedDateTime;\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.i18n.TimeZoneProvider;\n+import org.openhab.core.io.net.http.HttpUtil;\n+import org.openhab.core.library.types.PointType;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link ApiHandler} is the responsible to call a given\n+ * url and transform the answer in the appropriate dto class\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ApiHandler {\n+    private static final int TIMEOUT_MS = 30000;\n+    private final Gson gson;\n+\n+    public ApiHandler(TimeZoneProvider timeZoneProvider) {\n+        this.gson = new GsonBuilder().registerTypeAdapter(ZonedDateTime.class,\n+                (JsonDeserializer<ZonedDateTime>) (json, type, jsonDeserializationContext) -> ZonedDateTime\n+                        .parse(json.getAsJsonPrimitive().getAsString())\n+                        .withZoneSameInstant(timeZoneProvider.getTimeZone()))\n+                .create();\n+    }\n+\n+    private String execute(String url) throws VigiCruesException {\n+        String jsonResponse = \"\";\n+        try {\n+            jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n+            return jsonResponse;\n+        } catch (IOException e) {\n+            throw new VigiCruesException(e);\n+        }\n+    }", "originalCommit": "685bf8f3e20a730fbaec799b0a7efd673368b306", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzU4MTk5MQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r517581991", "body": "Please make sure all of your method names are camelcase.\r\n```suggestion\r\n    public InfoVigiCru getTronconStatus(String tronconId) throws VigiCruesException {\r\n```", "bodyText": "Please make sure all of your method names are camelcase.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public InfoVigiCru GetTronconStatus(String tronconId) throws VigiCruesException {\n          \n          \n            \n                public InfoVigiCru getTronconStatus(String tronconId) throws VigiCruesException {", "bodyHTML": "<p dir=\"auto\">Please make sure all of your method names are camelcase.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">InfoVigiCru</span> <span class=\"x x-first x-last\">GetTronconStatus</span>(<span class=\"pl-smi\">String</span> tronconId) throws <span class=\"pl-smi\">VigiCruesException</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">InfoVigiCru</span> <span class=\"x x-first x-last\">getTronconStatus</span>(<span class=\"pl-smi\">String</span> tronconId) throws <span class=\"pl-smi\">VigiCruesException</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-11-04T19:30:36Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.io.IOException;\n+import java.time.ZonedDateTime;\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.i18n.TimeZoneProvider;\n+import org.openhab.core.io.net.http.HttpUtil;\n+import org.openhab.core.library.types.PointType;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link ApiHandler} is the responsible to call a given\n+ * url and transform the answer in the appropriate dto class\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@NonNullByDefault\n+public class ApiHandler {\n+    private static final int TIMEOUT_MS = 30000;\n+    private final Gson gson;\n+\n+    public ApiHandler(TimeZoneProvider timeZoneProvider) {\n+        this.gson = new GsonBuilder().registerTypeAdapter(ZonedDateTime.class,\n+                (JsonDeserializer<ZonedDateTime>) (json, type, jsonDeserializationContext) -> ZonedDateTime\n+                        .parse(json.getAsJsonPrimitive().getAsString())\n+                        .withZoneSameInstant(timeZoneProvider.getTimeZone()))\n+                .create();\n+    }\n+\n+    private String execute(String url) throws VigiCruesException {\n+        String jsonResponse = \"\";\n+        try {\n+            jsonResponse = HttpUtil.executeUrl(\"GET\", url, TIMEOUT_MS);\n+            return jsonResponse;\n+        } catch (IOException e) {\n+            throw new VigiCruesException(e);\n+        }\n+    }\n+\n+    public InfoVigiCru GetTronconStatus(String tronconId) throws VigiCruesException {", "originalCommit": "685bf8f3e20a730fbaec799b0a7efd673368b306", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "url": "https://github.com/openhab/openhab-addons/commit/62f3e8140ee58b135d1d1d9ed6900475f794982e", "message": "Code review enhancements\nChanged alert to Number\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-05T11:12:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1MTE2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518351167", "body": "You don't need to supply a configurationPid if your component isn't configurable.\r\n\r\n```suggestion\r\n@Component(service = ApiHandler.class)\r\n```", "bodyText": "You don't need to supply a configurationPid if your component isn't configurable.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            @Component(service = ApiHandler.class, configurationPid = \"binding.vigicrues.apiHandler\")\n          \n          \n            \n            @Component(service = ApiHandler.class)", "bodyHTML": "<p dir=\"auto\">You don't need to supply a configurationPid if your component isn't configurable.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-k\">@Component</span>(<span class=\"pl-c1\">service</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">ApiHandler</span><span class=\"pl-k\">.</span>class<span class=\"x x-first\">, </span><span class=\"pl-c1 x\">configurationPid</span><span class=\"x\"> </span><span class=\"pl-k x\">=</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">binding.vigicrues.apiHandler</span><span class=\"pl-pds x x-last\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">@Component</span>(<span class=\"pl-c1\">service</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">ApiHandler</span><span class=\"pl-k\">.</span>class)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-11-05T20:40:48Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/api/ApiHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.api;\n+\n+import java.io.IOException;\n+import java.time.ZonedDateTime;\n+import java.util.Locale;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.binding.vigicrues.internal.dto.opendatasoft.OpenDatasoftResponse;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.CdStationHydro;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.InfoVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TerEntVigiCru;\n+import org.openhab.binding.vigicrues.internal.dto.vigicrues.TronEntVigiCru;\n+import org.openhab.core.i18n.TimeZoneProvider;\n+import org.openhab.core.io.net.http.HttpUtil;\n+import org.openhab.core.library.types.PointType;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+import com.google.gson.Gson;\n+import com.google.gson.GsonBuilder;\n+import com.google.gson.JsonDeserializer;\n+import com.google.gson.JsonSyntaxException;\n+\n+/**\n+ * The {@link ApiHandler} is the responsible to call a given\n+ * url and transform the answer in the appropriate dto class\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+\n+@Component(service = ApiHandler.class, configurationPid = \"binding.vigicrues.apiHandler\")", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1MzI4NA==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518353284", "body": "This value only ever increases, is it ever reset anywhere? Should it reset as part of `stopScan()`?", "bodyText": "This value only ever increases, is it ever reset anywhere? Should it reset as part of stopScan()?", "bodyHTML": "<p dir=\"auto\">This value only ever increases, is it ever reset anywhere? Should it reset as part of <code>stopScan()</code>?</p>", "author": "cpmeister", "createdAt": "2020-11-05T20:44:50Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/discovery/VigiCruesDiscoveryService.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.binding.vigicrues.internal.discovery;\n+\n+import static org.openhab.binding.vigicrues.internal.VigiCruesBindingConstants.*;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.openhab.binding.vigicrues.internal.StationConfiguration;\n+import org.openhab.binding.vigicrues.internal.api.ApiHandler;\n+import org.openhab.binding.vigicrues.internal.api.VigiCruesException;\n+import org.openhab.binding.vigicrues.internal.dto.hubeau.HubEauResponse;\n+import org.openhab.core.config.discovery.AbstractDiscoveryService;\n+import org.openhab.core.config.discovery.DiscoveryResultBuilder;\n+import org.openhab.core.config.discovery.DiscoveryService;\n+import org.openhab.core.i18n.LocationProvider;\n+import org.openhab.core.library.types.PointType;\n+import org.openhab.core.thing.ThingUID;\n+import org.osgi.service.component.annotations.Activate;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The {@link VigiCruesDiscoveryService} searches for available\n+ * hydro stations discoverable through API\n+ *\n+ * @author Ga\u00ebl L'hopital - Initial contribution\n+ */\n+@Component(service = DiscoveryService.class, configurationPid = \"discovery.vigicrues\")\n+@NonNullByDefault\n+public class VigiCruesDiscoveryService extends AbstractDiscoveryService {\n+    private static final int SEARCH_TIME = 5;\n+\n+    private final Logger logger = LoggerFactory.getLogger(VigiCruesDiscoveryService.class);\n+    private final LocationProvider locationProvider;\n+    private final ApiHandler apiHandler;\n+\n+    private int searchRange = 10;\n+\n+    @Activate\n+    public VigiCruesDiscoveryService(@Reference ApiHandler apiHandler, @Reference LocationProvider locationProvider) {\n+        super(SUPPORTED_THING_TYPES_UIDS, SEARCH_TIME, false);\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n+    }\n+\n+    @Override\n+    public void startScan() {\n+        PointType location = locationProvider.getLocation();\n+        if (location != null) {\n+            try {\n+                HubEauResponse response = apiHandler.discoverStations(location, searchRange);\n+                if (response.count > 0) {\n+                    response.stations.stream().filter(station -> station.enService).forEach(station -> {\n+                        thingDiscovered(DiscoveryResultBuilder\n+                                .create(new ThingUID(THING_TYPE_STATION, station.codeStation))\n+                                .withLabel(station.libelleStation).withRepresentationProperty(StationConfiguration.ID)\n+                                .withProperty(StationConfiguration.ID, station.codeStation).build());\n+                    });\n+                } else {\n+                    logger.info(\"No station exists in a neighbourhood of {} km\", searchRange);\n+                }\n+            } catch (VigiCruesException e) {\n+                logger.warn(\"Error discovering nearby hydro stations : {}\", e.getMessage());\n+            }\n+            searchRange += 10;", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYwMjI1Mg==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518602252", "bodyText": "Yes, the value increases each time a scan is manually launched so the radius of the search is extended per 10km each time. Isn't it a nice idea ?", "author": "clinique", "createdAt": "2020-11-06T08:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1MzI4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518354121", "body": "Is there any reason you are using QuantityType here? It doesn't seem that you care about the units when you are later using the values as references. Wouldn't just storing as a Double suffice?", "bodyText": "Is there any reason you are using QuantityType here? It doesn't seem that you care about the units when you are later using the values as references. Wouldn't just storing as a Double suffice?", "bodyHTML": "<p dir=\"auto\">Is there any reason you are using QuantityType here? It doesn't seem that you care about the units when you are later using the values as references. Wouldn't just storing as a Double suffice?</p>", "author": "cpmeister", "createdAt": "2020-11-05T20:46:31Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -54,35 +74,124 @@\n  */\n @NonNullByDefault\n public class VigiCruesHandler extends BaseThingHandler {\n-    private static final String URL = OPENDATASOFT_URL + \"?dataset=vigicrues&sort=timestamp&q=\";\n-    private static final int TIMEOUT_MS = 30000;\n     private final Logger logger = LoggerFactory.getLogger(VigiCruesHandler.class);\n+    private final LocationProvider locationProvider;\n \n-    // Time zone provider representing time zone configured in openHAB configuration\n-    private final TimeZoneProvider timeZoneProvider;\n-    private final Gson gson;\n     private @Nullable ScheduledFuture<?> refreshJob;\n-    private @Nullable String queryUrl;\n+    private final ApiHandler apiHandler;\n+\n+    private List<QuantityType<?>> referenceHeights = new ArrayList<>();\n+    private List<QuantityType<?>> referenceFlows = new ArrayList<>();\n+    private @Nullable String portion;\n \n-    public VigiCruesHandler(Thing thing, TimeZoneProvider timeZoneProvider, Gson gson) {\n+    public VigiCruesHandler(Thing thing, LocationProvider locationProvider, ApiHandler apiHandler) {\n         super(thing);\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = gson;\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n     }\n \n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing VigiCrues handler.\");\n \n-        VigiCruesConfiguration config = getConfigAs(VigiCruesConfiguration.class);\n-        logger.debug(\"config station = {}\", config.id);\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         logger.debug(\"config refresh = {} min\", config.refresh);\n \n         updateStatus(ThingStatus.UNKNOWN);\n-        queryUrl = URL + config.id;\n+\n+        if (thing.getProperties().isEmpty()) {\n+            Map<String, String> properties = discoverAttributes(config);\n+            updateProperties(properties);\n+        }\n+        getReferences();\n         refreshJob = scheduler.scheduleWithFixedDelay(this::updateAndPublish, 0, config.refresh, TimeUnit.MINUTES);\n     }\n \n+    private void getReferences() {\n+        List<QuantityType<?>> heights = new ArrayList<>();\n+        List<QuantityType<?>> flows = new ArrayList<>();\n+        thing.getProperties().keySet().stream().filter(key -> key.startsWith(FLOOD)).forEach(key -> {\n+            String value = thing.getProperties().get(key);\n+            if (key.contains(FLOW)) {\n+                flows.add(new QuantityType<>(value));\n+            } else {\n+                heights.add(new QuantityType<>(value));", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYwMzMwMA==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518603300", "bodyText": "It is a lazy approach to avoid having to cope with units :)", "author": "clinique", "createdAt": "2020-11-06T08:48:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIzNjE0MQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r519236141", "bodyText": "Well a unitless QuantityType is a bit misleading. Can you just use a Double instead?", "author": "cpmeister", "createdAt": "2020-11-07T23:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM1NDYxMg==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r519354612", "bodyText": "There is a unit in the incoming data", "author": "clinique", "createdAt": "2020-11-08T11:12:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1NDEyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1OTUzOQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518359539", "body": "I don't think that bindings should be interacting with the osgi framework directly like this. Since your resources would be located in the same jar as the compiled code It should be more than sufficient to load the resource using the classloader found from `VigiCruesHandler.class.getClassLoader()`\r\n```suggestion\r\n        try (InputStream stream = VigiCruesHandler.class.getClassLoader().getResourceAsStream()) {\r\n```", "bodyText": "I don't think that bindings should be interacting with the osgi framework directly like this. Since your resources would be located in the same jar as the compiled code It should be more than sufficient to load the resource using the classloader found from VigiCruesHandler.class.getClassLoader()\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Bundle bundle = FrameworkUtil.getBundle(getClass());\n          \n          \n            \n                    try (InputStream stream = bundle.getResource(iconPath).openStream()) {\n          \n          \n            \n                    try (InputStream stream = VigiCruesHandler.class.getClassLoader().getResourceAsStream()) {", "bodyHTML": "<p dir=\"auto\">I don't think that bindings should be interacting with the osgi framework directly like this. Since your resources would be located in the same jar as the compiled code It should be more than sufficient to load the resource using the classloader found from <code>VigiCruesHandler.class.getClassLoader()</code></p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">Bundle</span> bundle <span class=\"pl-k\">=</span> <span class=\"pl-smi\">FrameworkUtil</span><span class=\"pl-k\">.</span>getBundle(getClass());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">try</span> (<span class=\"pl-smi\">InputStream</span> stream <span class=\"pl-k\">=</span> bundle<span class=\"pl-k\">.</span>getResource(iconPath)<span class=\"pl-k\">.</span>openStream()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">try</span> (<span class=\"pl-smi\">InputStream</span> stream <span class=\"pl-k\">=</span> <span class=\"pl-smi\">VigiCruesHandler</span><span class=\"pl-k\">.</span>class<span class=\"pl-k\">.</span>getClassLoader()<span class=\"pl-k\">.</span>getResourceAsStream()) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-11-05T20:56:43Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -133,8 +258,29 @@ private void updateQuantity(String channelId, Double value, Unit<?> unit) {\n \n     public void updateDate(String channelId, ZonedDateTime zonedDateTime) {\n         if (isLinked(channelId)) {\n-            ZonedDateTime localDateTime = zonedDateTime.withZoneSameInstant(timeZoneProvider.getTimeZone());\n-            updateState(channelId, new DateTimeType(localDateTime));\n+            updateState(channelId, new DateTimeType(zonedDateTime));\n+        }\n+    }\n+\n+    public void updateAlert(String channelId, int value) {\n+        String channelIcon = channelId + \"-icon\";\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new DecimalType(value));\n+        }\n+        if (isLinked(channelIcon)) {\n+            String resource = getResource(String.format(\"picto/crue-%d.svg\", value));\n+            updateState(channelIcon,\n+                    resource != null ? new RawType(resource.getBytes(), \"image/svg+xml\") : UnDefType.UNDEF);\n+        }\n+    }\n+\n+    public @Nullable String getResource(String iconPath) {\n+        Bundle bundle = FrameworkUtil.getBundle(getClass());\n+        try (InputStream stream = bundle.getResource(iconPath).openStream()) {", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2MDUxMA==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518360510", "body": "Since you are only using this to load binary data perhaps you should just return a byte array instead.\r\n```suggestion\r\n    public byte @Nullable [] getResource(String iconPath) {\r\n```", "bodyText": "Since you are only using this to load binary data perhaps you should just return a byte array instead.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @Nullable String getResource(String iconPath) {\n          \n          \n            \n                public byte @Nullable [] getResource(String iconPath) {", "bodyHTML": "<p dir=\"auto\">Since you are only using this to load binary data perhaps you should just return a byte array instead.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">@Nullable</span> <span class=\"pl-smi x x-first x-last\">String</span> getResource(<span class=\"pl-smi\">String</span> iconPath) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k x x-first\">byte</span><span class=\"x x-last\"> </span><span class=\"pl-k\">@Nullable</span> <span class=\"x x-first x-last\">[]</span> getResource(<span class=\"pl-smi\">String</span> iconPath) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-11-05T20:58:47Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -133,8 +258,29 @@ private void updateQuantity(String channelId, Double value, Unit<?> unit) {\n \n     public void updateDate(String channelId, ZonedDateTime zonedDateTime) {\n         if (isLinked(channelId)) {\n-            ZonedDateTime localDateTime = zonedDateTime.withZoneSameInstant(timeZoneProvider.getTimeZone());\n-            updateState(channelId, new DateTimeType(localDateTime));\n+            updateState(channelId, new DateTimeType(zonedDateTime));\n+        }\n+    }\n+\n+    public void updateAlert(String channelId, int value) {\n+        String channelIcon = channelId + \"-icon\";\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new DecimalType(value));\n+        }\n+        if (isLinked(channelIcon)) {\n+            String resource = getResource(String.format(\"picto/crue-%d.svg\", value));\n+            updateState(channelIcon,\n+                    resource != null ? new RawType(resource.getBytes(), \"image/svg+xml\") : UnDefType.UNDEF);\n+        }\n+    }\n+\n+    public @Nullable String getResource(String iconPath) {", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2MTMxOQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518361319", "body": "If you want to just return a binary array this can be vastly simplified due to java 11.\r\n```suggestion\r\n            return stream.readAllBytes();\r\n```", "bodyText": "If you want to just return a binary array this can be vastly simplified due to java 11.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return new BufferedReader(new InputStreamReader(stream)).lines().collect(Collectors.joining(\"\\n\"));\n          \n          \n            \n                        return stream.readAllBytes();", "bodyHTML": "<p dir=\"auto\">If you want to just return a binary array this can be vastly simplified due to java 11.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">return</span> <span class=\"pl-k x x-first\">new</span><span class=\"x\"> </span><span class=\"pl-smi x\">BufferedReader</span><span class=\"x\">(</span><span class=\"pl-k x\">new</span><span class=\"x\"> </span><span class=\"pl-smi x\">InputStreamReader</span><span class=\"x x-last\">(</span>stream<span class=\"x x-first\">))</span><span class=\"pl-k x\">.</span><span class=\"x\">lines()</span><span class=\"pl-k x\">.</span><span class=\"x\">collect(</span><span class=\"pl-smi x\">Collectors</span><span class=\"pl-k x\">.</span><span class=\"x\">joining(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"pl-cce x\">\\n</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">)</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span> stream<span class=\"pl-k x x-first\">.</span><span class=\"x x-last\">readAllBytes(</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-11-05T21:00:18Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -133,8 +258,29 @@ private void updateQuantity(String channelId, Double value, Unit<?> unit) {\n \n     public void updateDate(String channelId, ZonedDateTime zonedDateTime) {\n         if (isLinked(channelId)) {\n-            ZonedDateTime localDateTime = zonedDateTime.withZoneSameInstant(timeZoneProvider.getTimeZone());\n-            updateState(channelId, new DateTimeType(localDateTime));\n+            updateState(channelId, new DateTimeType(zonedDateTime));\n+        }\n+    }\n+\n+    public void updateAlert(String channelId, int value) {\n+        String channelIcon = channelId + \"-icon\";\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new DecimalType(value));\n+        }\n+        if (isLinked(channelIcon)) {\n+            String resource = getResource(String.format(\"picto/crue-%d.svg\", value));\n+            updateState(channelIcon,\n+                    resource != null ? new RawType(resource.getBytes(), \"image/svg+xml\") : UnDefType.UNDEF);\n+        }\n+    }\n+\n+    public @Nullable String getResource(String iconPath) {\n+        Bundle bundle = FrameworkUtil.getBundle(getClass());\n+        try (InputStream stream = bundle.getResource(iconPath).openStream()) {\n+            return new BufferedReader(new InputStreamReader(stream)).lines().collect(Collectors.joining(\"\\n\"));", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2MjUxNA==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518362514", "body": "IIRC QuantityType accepts a plain Number argument and DecimalType extends Number.\r\n```suggestion\r\n                    properties.put(DISTANCE, new QuantityType<>(distance, SIUnits.METRE).toString());\r\n```", "bodyText": "IIRC QuantityType accepts a plain Number argument and DecimalType extends Number.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                properties.put(DISTANCE, new QuantityType<>(distance.intValue(), SIUnits.METRE).toString());\n          \n          \n            \n                                properties.put(DISTANCE, new QuantityType<>(distance, SIUnits.METRE).toString());", "bodyHTML": "<p dir=\"auto\">IIRC QuantityType accepts a plain Number argument and DecimalType extends Number.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    properties<span class=\"pl-k\">.</span>put(<span class=\"pl-c1\">DISTANCE</span>, <span class=\"pl-k\">new</span> <span class=\"pl-k\">QuantityType&lt;&gt;</span>(distance<span class=\"pl-k x x-first\">.</span><span class=\"x x-last\">intValue()</span>, <span class=\"pl-smi\">SIUnits</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>METRE</span>)<span class=\"pl-k\">.</span>toString());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    properties<span class=\"pl-k\">.</span>put(<span class=\"pl-c1\">DISTANCE</span>, <span class=\"pl-k\">new</span> <span class=\"pl-k\">QuantityType&lt;&gt;</span>(distance, <span class=\"pl-smi\">SIUnits</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>METRE</span>)<span class=\"pl-k\">.</span>toString());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-11-05T21:02:39Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -54,35 +74,124 @@\n  */\n @NonNullByDefault\n public class VigiCruesHandler extends BaseThingHandler {\n-    private static final String URL = OPENDATASOFT_URL + \"?dataset=vigicrues&sort=timestamp&q=\";\n-    private static final int TIMEOUT_MS = 30000;\n     private final Logger logger = LoggerFactory.getLogger(VigiCruesHandler.class);\n+    private final LocationProvider locationProvider;\n \n-    // Time zone provider representing time zone configured in openHAB configuration\n-    private final TimeZoneProvider timeZoneProvider;\n-    private final Gson gson;\n     private @Nullable ScheduledFuture<?> refreshJob;\n-    private @Nullable String queryUrl;\n+    private final ApiHandler apiHandler;\n+\n+    private List<QuantityType<?>> referenceHeights = new ArrayList<>();\n+    private List<QuantityType<?>> referenceFlows = new ArrayList<>();\n+    private @Nullable String portion;\n \n-    public VigiCruesHandler(Thing thing, TimeZoneProvider timeZoneProvider, Gson gson) {\n+    public VigiCruesHandler(Thing thing, LocationProvider locationProvider, ApiHandler apiHandler) {\n         super(thing);\n-        this.timeZoneProvider = timeZoneProvider;\n-        this.gson = gson;\n+        this.apiHandler = apiHandler;\n+        this.locationProvider = locationProvider;\n     }\n \n     @Override\n     public void initialize() {\n         logger.debug(\"Initializing VigiCrues handler.\");\n \n-        VigiCruesConfiguration config = getConfigAs(VigiCruesConfiguration.class);\n-        logger.debug(\"config station = {}\", config.id);\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         logger.debug(\"config refresh = {} min\", config.refresh);\n \n         updateStatus(ThingStatus.UNKNOWN);\n-        queryUrl = URL + config.id;\n+\n+        if (thing.getProperties().isEmpty()) {\n+            Map<String, String> properties = discoverAttributes(config);\n+            updateProperties(properties);\n+        }\n+        getReferences();\n         refreshJob = scheduler.scheduleWithFixedDelay(this::updateAndPublish, 0, config.refresh, TimeUnit.MINUTES);\n     }\n \n+    private void getReferences() {\n+        List<QuantityType<?>> heights = new ArrayList<>();\n+        List<QuantityType<?>> flows = new ArrayList<>();\n+        thing.getProperties().keySet().stream().filter(key -> key.startsWith(FLOOD)).forEach(key -> {\n+            String value = thing.getProperties().get(key);\n+            if (key.contains(FLOW)) {\n+                flows.add(new QuantityType<>(value));\n+            } else {\n+                heights.add(new QuantityType<>(value));\n+            }\n+        });\n+        referenceHeights = heights.stream().distinct().sorted().collect(Collectors.toList());\n+        referenceFlows = flows.stream().distinct().sorted().collect(Collectors.toList());\n+        portion = thing.getProperties().get(TRONCON);\n+    }\n+\n+    private Map<String, String> discoverAttributes(StationConfiguration config) {\n+        Map<String, String> properties = new HashMap<>();\n+\n+        ThingBuilder thingBuilder = editThing();\n+        List<Channel> channels = new ArrayList<>(getThing().getChannels());\n+\n+        try {\n+            HubEauResponse stationDetails = apiHandler.discoverStations(config.id);\n+            stationDetails.stations.stream().findFirst().ifPresent(station -> {\n+                PointType stationLocation = new PointType(\n+                        String.format(Locale.US, \"%f,%f\", station.latitudeStation, station.longitudeStation));\n+                properties.put(LOCATION, stationLocation.toString());\n+                PointType serverLocation = locationProvider.getLocation();\n+                if (serverLocation != null) {\n+                    DecimalType distance = serverLocation.distanceFrom(stationLocation);\n+                    properties.put(DISTANCE, new QuantityType<>(distance.intValue(), SIUnits.METRE).toString());", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2NTI5Mg==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518365292", "body": "What is the point of keeping track of multiple reference values if you only care about the first one?", "bodyText": "What is the point of keeping track of multiple reference values if you only care about the first one?", "bodyHTML": "<p dir=\"auto\">What is the point of keeping track of multiple reference values if you only care about the first one?</p>", "author": "cpmeister", "createdAt": "2020-11-05T21:08:15Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -102,26 +211,42 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n     }\n \n     private void updateAndPublish() {\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         try {\n-            if (queryUrl != null) {\n-                String response = HttpUtil.executeUrl(\"GET\", queryUrl, TIMEOUT_MS);\n-                updateStatus(ThingStatus.ONLINE);\n-                OpenDatasoftResponse apiResponse = gson.fromJson(response, OpenDatasoftResponse.class);\n-                Arrays.stream(apiResponse.getRecords()).findFirst().flatMap(Record::getFields).ifPresent(field -> {\n-                    field.getHeight().ifPresent(height -> updateQuantity(HEIGHT, height, METRE));\n-                    field.getFlow().ifPresent(flow -> updateQuantity(FLOW, flow, CUBICMETRE_PER_SECOND));\n-                    field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            OpenDatasoftResponse measures = apiHandler.getMeasures(config.id);\n+            measures.getFirstRecord().ifPresent(field -> {\n+                field.getHeight().ifPresent(height -> {\n+                    updateQuantity(HEIGHT, height, SIUnits.METRE);\n+                    updateRelativeMeasure(RELATIVE_HEIGHT, referenceHeights, height);\n                 });\n-            } else {\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED,\n-                        \"queryUrl should never be null, but it is !\");\n+                field.getFlow().ifPresent(flow -> {\n+                    updateQuantity(FLOW, flow, SmartHomeUnits.CUBICMETRE_PER_SECOND);\n+                    updateRelativeMeasure(RELATIVE_FLOW, referenceFlows, flow);\n+                });\n+                field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            });\n+            if (portion != null) {\n+                InfoVigiCru status = apiHandler.getTronconStatus(portion);\n+                updateAlert(ALERT, status.vicInfoVigiCru.vicNivInfoVigiCru - 1);\n+                updateString(SHORT_COMMENT, status.vicInfoVigiCru.vicSituActuInfoVigiCru);\n+                updateString(COMMENT, status.vicInfoVigiCru.vicQualifInfoVigiCru);\n             }\n-        } catch (MalformedURLException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    String.format(\"Querying '%s' raised : %s\", queryUrl, e.getMessage()));\n-        } catch (IOException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                    String.format(\"Error opening connection to VigiCrues webservice : {}\", e.getMessage()));\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (VigiCruesException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED, e.getMessage());\n+        }\n+    }\n+\n+    private void updateString(String channelId, String value) {\n+        if (isLinked(channelId)) {\n+            updateState(channelId, new StringType(value));\n+        }\n+    }\n+\n+    private void updateRelativeMeasure(String channelId, List<QuantityType<?>> reference, double value) {\n+        if (reference.size() > 0) {\n+            double percent = value / reference.get(0).doubleValue() * 100;", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODYwODk0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518608947", "bodyText": "I currently use the lowest value as reference, but maybe we could introduce a setting to let the user decide if he wants it compared to lowest or highest. Reason why I did it this way.", "author": "clinique", "createdAt": "2020-11-06T08:58:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2NTI5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2Nzc3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518367775", "body": "Bindings should never use `ThingStatusDetail.DISABLED`, that is reserved for the core. Please use `ThingStatusDetail.COMMUNICATION_ERROR` instead.", "bodyText": "Bindings should never use ThingStatusDetail.DISABLED, that is reserved for the core. Please use ThingStatusDetail.COMMUNICATION_ERROR instead.", "bodyHTML": "<p dir=\"auto\">Bindings should never use <code>ThingStatusDetail.DISABLED</code>, that is reserved for the core. Please use <code>ThingStatusDetail.COMMUNICATION_ERROR</code> instead.</p>", "author": "cpmeister", "createdAt": "2020-11-05T21:13:25Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/handler/VigiCruesHandler.java", "diffHunk": "@@ -102,26 +211,42 @@ public void handleCommand(ChannelUID channelUID, Command command) {\n     }\n \n     private void updateAndPublish() {\n+        StationConfiguration config = getConfigAs(StationConfiguration.class);\n         try {\n-            if (queryUrl != null) {\n-                String response = HttpUtil.executeUrl(\"GET\", queryUrl, TIMEOUT_MS);\n-                updateStatus(ThingStatus.ONLINE);\n-                OpenDatasoftResponse apiResponse = gson.fromJson(response, OpenDatasoftResponse.class);\n-                Arrays.stream(apiResponse.getRecords()).findFirst().flatMap(Record::getFields).ifPresent(field -> {\n-                    field.getHeight().ifPresent(height -> updateQuantity(HEIGHT, height, METRE));\n-                    field.getFlow().ifPresent(flow -> updateQuantity(FLOW, flow, CUBICMETRE_PER_SECOND));\n-                    field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            OpenDatasoftResponse measures = apiHandler.getMeasures(config.id);\n+            measures.getFirstRecord().ifPresent(field -> {\n+                field.getHeight().ifPresent(height -> {\n+                    updateQuantity(HEIGHT, height, SIUnits.METRE);\n+                    updateRelativeMeasure(RELATIVE_HEIGHT, referenceHeights, height);\n                 });\n-            } else {\n-                updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED,\n-                        \"queryUrl should never be null, but it is !\");\n+                field.getFlow().ifPresent(flow -> {\n+                    updateQuantity(FLOW, flow, SmartHomeUnits.CUBICMETRE_PER_SECOND);\n+                    updateRelativeMeasure(RELATIVE_FLOW, referenceFlows, flow);\n+                });\n+                field.getTimestamp().ifPresent(date -> updateDate(OBSERVATION_TIME, date));\n+            });\n+            if (portion != null) {\n+                InfoVigiCru status = apiHandler.getTronconStatus(portion);\n+                updateAlert(ALERT, status.vicInfoVigiCru.vicNivInfoVigiCru - 1);\n+                updateString(SHORT_COMMENT, status.vicInfoVigiCru.vicSituActuInfoVigiCru);\n+                updateString(COMMENT, status.vicInfoVigiCru.vicQualifInfoVigiCru);\n             }\n-        } catch (MalformedURLException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    String.format(\"Querying '%s' raised : %s\", queryUrl, e.getMessage()));\n-        } catch (IOException e) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                    String.format(\"Error opening connection to VigiCrues webservice : {}\", e.getMessage()));\n+            updateStatus(ThingStatus.ONLINE);\n+        } catch (VigiCruesException e) {\n+            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.DISABLED, e.getMessage());", "originalCommit": "62f3e8140ee58b135d1d1d9ed6900475f794982e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3885b5e6d8bd9b08de9914df6ede5d89f53f9557", "url": "https://github.com/openhab/openhab-addons/commit/3885b5e6d8bd9b08de9914df6ede5d89f53f9557", "message": "Code review corrections\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-06T09:05:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4Mjg4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/8952#discussion_r518882886", "body": "You shouldn't have changed this one. You were supposed to remove the one from `ApiHandler` instead.", "bodyText": "You shouldn't have changed this one. You were supposed to remove the one from ApiHandler instead.", "bodyHTML": "<p dir=\"auto\">You shouldn't have changed this one. You were supposed to remove the one from <code>ApiHandler</code> instead.</p>", "author": "cpmeister", "createdAt": "2020-11-06T17:01:23Z", "path": "bundles/org.openhab.binding.vigicrues/src/main/java/org/openhab/binding/vigicrues/internal/discovery/VigiCruesDiscoveryService.java", "diffHunk": "@@ -37,7 +37,7 @@\n  *\n  * @author Ga\u00ebl L'hopital - Initial contribution\n  */\n-@Component(service = DiscoveryService.class, configurationPid = \"discovery.vigicrues\")\n+@Component(service = DiscoveryService.class)", "originalCommit": "3885b5e6d8bd9b08de9914df6ede5d89f53f9557", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29399df11d6d1b6404852cc97597fbe26e65dda1", "url": "https://github.com/openhab/openhab-addons/commit/29399df11d6d1b6404852cc97597fbe26e65dda1", "message": "Correcting my error\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-07T11:04:13Z", "type": "commit"}, {"oid": "410747abb4d72acff07d4f3342c4f378a283d684", "url": "https://github.com/openhab/openhab-addons/commit/410747abb4d72acff07d4f3342c4f378a283d684", "message": "Adressing SAT finding\n\nSigned-off-by: clinique <gael@lhopital.org>", "committedDate": "2020-11-09T07:43:15Z", "type": "commit"}]}