{"pr_number": 8516, "pr_title": "[jsscripting] ES6+ Support", "pr_author": "jpg0", "pr_createdAt": "2020-09-21T10:06:44Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/8516", "timeline": [{"oid": "ff7955fe51489d3bd24a093fdb7b0bed5e2f1b6c", "url": "https://github.com/openhab/openhab-addons/commit/ff7955fe51489d3bd24a093fdb7b0bed5e2f1b6c", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2020-12-14T08:41:03Z", "type": "forcePushed"}, {"oid": "9c59be7c81b4b206ad440144b8fac419cf155545", "url": "https://github.com/openhab/openhab-addons/commit/9c59be7c81b4b206ad440144b8fac419cf155545", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2020-12-18T23:31:49Z", "type": "forcePushed"}, {"oid": "10c91403ac49cf64b6da8c4b51078a8af8a6fd78", "url": "https://github.com/openhab/openhab-addons/commit/10c91403ac49cf64b6da8c4b51078a8af8a6fd78", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2020-12-21T03:44:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQ5NTg2MA==", "url": "https://github.com/openhab/openhab-addons/pull/8516#discussion_r602495860", "body": "It's more clear and saves 1 line when you annotate the type:\r\n\r\n```suggestion\r\n    private @NonNullByDefault({}) String engineIdentifier;\r\n```\r\n\r\nPlease also check the others.", "bodyText": "It's more clear and saves 1 line when you annotate the type:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @NonNullByDefault({})\n          \n          \n            \n                private String engineIdentifier;\n          \n          \n            \n                private @NonNullByDefault({}) String engineIdentifier;\n          \n      \n    \n    \n  \n\nPlease also check the others.", "bodyHTML": "<p dir=\"auto\">It's more clear and saves 1 line when you annotate the type:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"58\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@NonNullByDefault</span>({})</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"59\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">String</span> engineIdentifier;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"58\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">@NonNullByDefault</span>({}) <span class=\"pl-smi\">String</span> engineIdentifier;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Please also check the others.</p>", "author": "wborn", "createdAt": "2021-03-26T18:06:13Z", "path": "bundles/org.openhab.automation.jsscripting/src/main/java/org/openhab/automation/jsscripting/internal/OpenhabGraalJSScriptEngine.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.automation.jsscripting.internal;\n+\n+import static org.openhab.core.automation.module.script.ScriptEngineFactory.*;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.channels.SeekableByteChannel;\n+import java.nio.file.FileSystems;\n+import java.nio.file.OpenOption;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.FileAttribute;\n+import java.util.Set;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n+import javax.script.*;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.graalvm.polyglot.Context;\n+import org.openhab.automation.jsscripting.internal.fs.DelegatingFileSystem;\n+import org.openhab.automation.jsscripting.internal.fs.PrefixedSeekableByteChannel;\n+import org.openhab.automation.jsscripting.internal.scriptengine.InvocationInterceptingScriptEngineWithInvocable;\n+import org.openhab.core.OpenHAB;\n+import org.openhab.core.automation.module.script.ScriptExtensionAccessor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.oracle.truffle.js.scriptengine.GraalJSScriptEngine;\n+\n+/**\n+ * GraalJS Script Engine implementation\n+ *\n+ * @author Jonathan Gilbert - Initial contribution\n+ */\n+public class OpenhabGraalJSScriptEngine extends InvocationInterceptingScriptEngineWithInvocable<GraalJSScriptEngine> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(OpenhabGraalJSScriptEngine.class);\n+\n+    private static final String REQUIRE_WRAPPER_NAME = \"__wraprequire__\";\n+    private static final String MODULE_DIR = String.join(File.separator, OpenHAB.getConfigFolder(), \"automation\", \"lib\",\n+            \"javascript\", \"personal\");\n+\n+    // these fields start as null because they are populated on first use\n+    @NonNullByDefault({})\n+    private String engineIdentifier;", "originalCommit": "9dead4836e01237e3a679b8f9efde5599114faac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQ5NjYxMA==", "url": "https://github.com/openhab/openhab-addons/pull/8516#discussion_r602496610", "body": "All headers probably need to be updated to 2021:\r\n\r\n```suggestion\r\n * Copyright (c) 2010-2021 Contributors to the openHAB project\r\n```", "bodyText": "All headers probably need to be updated to 2021:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright (c) 2010-2020 Contributors to the openHAB project\n          \n          \n            \n             * Copyright (c) 2010-2021 Contributors to the openHAB project", "bodyHTML": "<p dir=\"auto\">All headers probably need to be updated to 2021:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Copyright</span> (c) <span class=\"pl-c1\">2010</span><span class=\"pl-k\">-</span><span class=\"pl-c1 x x-first x-last\">2020</span> <span class=\"pl-smi\">Contributors</span> to the openHAB project</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Copyright</span> (c) <span class=\"pl-c1\">2010</span><span class=\"pl-k\">-</span><span class=\"pl-c1 x x-first x-last\">2021</span> <span class=\"pl-smi\">Contributors</span> to the openHAB project</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "wborn", "createdAt": "2021-03-26T18:07:27Z", "path": "bundles/org.openhab.automation.jsscripting/src/main/java/org/openhab/automation/jsscripting/internal/scriptengine/InvocationInterceptingScriptEngineWithInvocable.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project", "originalCommit": "9dead4836e01237e3a679b8f9efde5599114faac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQ5Nzc0NA==", "url": "https://github.com/openhab/openhab-addons/pull/8516#discussion_r602497744", "body": "Please remove any `@NonNull` annotations, see https://www.openhab.org/docs/developer/guidelines.html#null-annotations. Only `@NonNullByDefault`  and  `@Nullable` should be used.", "bodyText": "Please remove any @NonNull annotations, see https://www.openhab.org/docs/developer/guidelines.html#null-annotations. Only @NonNullByDefault  and  @Nullable should be used.", "bodyHTML": "<p dir=\"auto\">Please remove any <code>@NonNull</code> annotations, see <a href=\"https://www.openhab.org/docs/developer/guidelines.html#null-annotations\" rel=\"nofollow\">https://www.openhab.org/docs/developer/guidelines.html#null-annotations</a>. Only <code>@NonNullByDefault</code>  and  <code>@Nullable</code> should be used.</p>", "author": "wborn", "createdAt": "2021-03-26T18:09:18Z", "path": "bundles/org.openhab.automation.jsscripting/src/main/java/org/openhab/automation/jsscripting/internal/scriptengine/InvocationInterceptingScriptEngineWithInvocable.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.automation.jsscripting.internal.scriptengine;\n+\n+import java.io.Reader;\n+\n+import javax.script.*;\n+\n+import org.eclipse.jdt.annotation.NonNull;\n+\n+/**\n+ * Delegate allowing AOP-style interception of calls, either before Invocation, or upon a {@link ScriptException}.\n+ * being thrown.\n+ *\n+ * @author Jonathan Gilbert - Initial contribution\n+ *\n+ * @param <T> The delegate class\n+ */\n+public abstract class InvocationInterceptingScriptEngineWithInvocable<T extends ScriptEngine & Invocable>\n+        extends DelegatingScriptEngineWithInvocable<T> {\n+\n+    public InvocationInterceptingScriptEngineWithInvocable(T delegate) {\n+        super(delegate);\n+    }\n+\n+    protected void beforeInvocation() {\n+    }\n+\n+    protected @NonNull ScriptException afterThrowsInvocation(@NonNull ScriptException se) {", "originalCommit": "9dead4836e01237e3a679b8f9efde5599114faac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjYxMjczNg==", "url": "https://github.com/openhab/openhab-addons/pull/8516#discussion_r602612736", "bodyText": "I have a question about this: I originally started with @NonNullByDefault but because this is a delegate class which implements something without null annotations, it requires @NonNull annotations on pretty much everything in the class.  This is why I inverted the annotations. In this case should I proceed and put @NonNull on everything? Or maybe just remove the @NonNullByDefault annotation entirely?", "author": "jpg0", "createdAt": "2021-03-26T22:20:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQ5Nzc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQ5ODA2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/8516#discussion_r602498065", "body": "```suggestion\r\n    public @Nullable String getTemplateUID() {\r\n```\r\n\r\nPlease also fix the others.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                public String getTemplateUID() {\n          \n          \n            \n                public @Nullable String getTemplateUID() {\n          \n      \n    \n    \n  \n\nPlease also fix the others.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"69\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@Nullable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"70\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">String</span> getTemplateUID() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"69\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">@Nullable</span> <span class=\"pl-smi\">String</span> getTemplateUID() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Please also fix the others.</p>", "author": "wborn", "createdAt": "2021-03-26T18:09:48Z", "path": "bundles/org.openhab.automation.jsscripting/src/main/java/org/openhab/automation/jsscripting/internal/threading/ThreadsafeSimpleRuleDelegate.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.automation.jsscripting.internal.threading;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.openhab.core.automation.Action;\n+import org.openhab.core.automation.Condition;\n+import org.openhab.core.automation.Module;\n+import org.openhab.core.automation.Rule;\n+import org.openhab.core.automation.Trigger;\n+import org.openhab.core.automation.Visibility;\n+import org.openhab.core.automation.module.script.rulesupport.shared.simple.SimpleRule;\n+import org.openhab.core.automation.module.script.rulesupport.shared.simple.SimpleRuleActionHandler;\n+import org.openhab.core.config.core.ConfigDescriptionParameter;\n+import org.openhab.core.config.core.Configuration;\n+\n+/**\n+ * An version of {@link SimpleRule} which controls multithreaded execution access to this specific rule. This is useful\n+ * for rules which wrap GraalJS Contexts, which are not multithreaded.\n+ *\n+ * @author Jonathan Gilbert - Initial contribution\n+ */\n+@NonNullByDefault\n+class ThreadsafeSimpleRuleDelegate implements Rule, SimpleRuleActionHandler {\n+\n+    private final Object lock;\n+    private final SimpleRule delegate;\n+\n+    /**\n+     * Constructor requires a lock object and delegate to forward invocations to.\n+     *\n+     * @param lock rule executions will synchronize on this object\n+     * @param delegate the delegate to forward invocations to\n+     */\n+    ThreadsafeSimpleRuleDelegate(Object lock, SimpleRule delegate) {\n+        this.lock = lock;\n+        this.delegate = delegate;\n+    }\n+\n+    @Override\n+    @NonNullByDefault({})\n+    public Object execute(Action module, Map<String, ?> inputs) {\n+        synchronized (lock) {\n+            return delegate.execute(module, inputs);\n+        }\n+    }\n+\n+    @Override\n+    public String getUID() {\n+        return delegate.getUID();\n+    }\n+\n+    @Override\n+    @Nullable\n+    public String getTemplateUID() {", "originalCommit": "9dead4836e01237e3a679b8f9efde5599114faac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQ5OTcyNg==", "url": "https://github.com/openhab/openhab-addons/pull/8516#discussion_r602499726", "body": "Please check your IDE settings. * imports should only be used with static imports. The next time an openHAB Eclipse IDE user saves this file it will results in unnecessary diffs. :slightly_frowning_face: ", "bodyText": "Please check your IDE settings. * imports should only be used with static imports. The next time an openHAB Eclipse IDE user saves this file it will results in unnecessary diffs. \ud83d\ude41", "bodyHTML": "<p dir=\"auto\">Please check your IDE settings. * imports should only be used with static imports. The next time an openHAB Eclipse IDE user saves this file it will results in unnecessary diffs. <g-emoji class=\"g-emoji\" alias=\"slightly_frowning_face\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f641.png\">\ud83d\ude41</g-emoji></p>", "author": "wborn", "createdAt": "2021-03-26T18:12:45Z", "path": "bundles/org.openhab.automation.jsscripting/src/main/java/org/openhab/automation/jsscripting/internal/DebuggingGraalScriptEngine.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.automation.jsscripting.internal;\n+\n+import javax.script.*;", "originalCommit": "9dead4836e01237e3a679b8f9efde5599114faac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjUxMzQzMw==", "url": "https://github.com/openhab/openhab-addons/pull/8516#discussion_r602513433", "body": "Curly braces should always be used with if statements. So please again check your IDE settings.\r\n\r\n```suggestion\r\n        if (initialized) {\r\n            return;\r\n        }\r\n```", "bodyText": "Curly braces should always be used with if statements. So please again check your IDE settings.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (initialized)\n          \n          \n            \n                        return;\n          \n          \n            \n                    if (initialized) {\n          \n          \n            \n                        return;\n          \n          \n            \n                    }", "bodyHTML": "<p dir=\"auto\">Curly braces should always be used with if statements. So please again check your IDE settings.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"98\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (initialized)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"99\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">return</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"98\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (initialized) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"99\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"100\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "wborn", "createdAt": "2021-03-26T18:37:08Z", "path": "bundles/org.openhab.automation.jsscripting/src/main/java/org/openhab/automation/jsscripting/internal/OpenhabGraalJSScriptEngine.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.automation.jsscripting.internal;\n+\n+import static org.openhab.core.automation.module.script.ScriptEngineFactory.*;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.channels.SeekableByteChannel;\n+import java.nio.file.FileSystems;\n+import java.nio.file.OpenOption;\n+import java.nio.file.Path;\n+import java.nio.file.attribute.FileAttribute;\n+import java.util.Set;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+\n+import javax.script.*;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.graalvm.polyglot.Context;\n+import org.openhab.automation.jsscripting.internal.fs.DelegatingFileSystem;\n+import org.openhab.automation.jsscripting.internal.fs.PrefixedSeekableByteChannel;\n+import org.openhab.automation.jsscripting.internal.scriptengine.InvocationInterceptingScriptEngineWithInvocable;\n+import org.openhab.core.OpenHAB;\n+import org.openhab.core.automation.module.script.ScriptExtensionAccessor;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.oracle.truffle.js.scriptengine.GraalJSScriptEngine;\n+\n+/**\n+ * GraalJS Script Engine implementation\n+ *\n+ * @author Jonathan Gilbert - Initial contribution\n+ */\n+public class OpenhabGraalJSScriptEngine extends InvocationInterceptingScriptEngineWithInvocable<GraalJSScriptEngine> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(OpenhabGraalJSScriptEngine.class);\n+\n+    private static final String REQUIRE_WRAPPER_NAME = \"__wraprequire__\";\n+    private static final String MODULE_DIR = String.join(File.separator, OpenHAB.getConfigFolder(), \"automation\", \"lib\",\n+            \"javascript\", \"personal\");\n+\n+    // these fields start as null because they are populated on first use\n+    @NonNullByDefault({})\n+    private String engineIdentifier;\n+    @NonNullByDefault({})\n+    private Consumer<String> scriptDependencyListener;\n+\n+    private boolean initialized = false;\n+\n+    /**\n+     * Creates an implementation of ScriptEngine (& Invocable), wrapping the contained engine, that tracks the script\n+     * lifecycle and provides hooks for scripts to do so too.\n+     */\n+    public OpenhabGraalJSScriptEngine() {\n+        super(null); // delegate depends on fields not yet initialised, so we cannot set it immediately\n+        delegate = GraalJSScriptEngine.create(null,\n+                Context.newBuilder(\"js\").allowExperimentalOptions(true).allowAllAccess(true)\n+                        .option(\"js.commonjs-require-cwd\", MODULE_DIR).option(\"js.nashorn-compat\", \"true\") // to ease\n+                                                                                                           // migration\n+                        .option(\"js.commonjs-require\", \"true\") // enable CommonJS module support\n+                        .fileSystem(new DelegatingFileSystem(FileSystems.getDefault().provider()) {\n+                            @Override\n+                            public SeekableByteChannel newByteChannel(Path path, Set<? extends OpenOption> options,\n+                                    FileAttribute<?>... attrs) throws IOException {\n+                                if (scriptDependencyListener != null) {\n+                                    scriptDependencyListener.accept(path.toString());\n+                                }\n+\n+                                if (path.toString().endsWith(\".js\")) {\n+                                    return new PrefixedSeekableByteChannel(\n+                                            (\"require=\" + REQUIRE_WRAPPER_NAME + \"(require);\").getBytes(),\n+                                            super.newByteChannel(path, options, attrs));\n+                                } else {\n+                                    return super.newByteChannel(path, options, attrs);\n+                                }\n+                            }\n+                        }));\n+    }\n+\n+    @Override\n+    protected void beforeInvocation() {\n+        if (initialized)\n+            return;", "originalCommit": "9dead4836e01237e3a679b8f9efde5599114faac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb91f7d4428dd34ef97bc22bc5640e9964d12156", "url": "https://github.com/openhab/openhab-addons/commit/bb91f7d4428dd34ef97bc22bc5640e9964d12156", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-26T21:45:42Z", "type": "forcePushed"}, {"oid": "5f47eff07b26ba90ac3fd037fcbc3aebc99aaa60", "url": "https://github.com/openhab/openhab-addons/commit/5f47eff07b26ba90ac3fd037fcbc3aebc99aaa60", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-26T21:47:29Z", "type": "forcePushed"}, {"oid": "08a181318eeb89319daabdf37c6076434a120bf1", "url": "https://github.com/openhab/openhab-addons/commit/08a181318eeb89319daabdf37c6076434a120bf1", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-26T21:50:24Z", "type": "forcePushed"}, {"oid": "3fe478dfd04a892c77a628b951e477be6d9101e2", "url": "https://github.com/openhab/openhab-addons/commit/3fe478dfd04a892c77a628b951e477be6d9101e2", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-26T21:59:36Z", "type": "forcePushed"}, {"oid": "996cdd40794e99f6953044add93357ffeb27affd", "url": "https://github.com/openhab/openhab-addons/commit/996cdd40794e99f6953044add93357ffeb27affd", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-26T22:09:32Z", "type": "forcePushed"}, {"oid": "bdb333674b8a08f7aa454c0026ffd710500f7722", "url": "https://github.com/openhab/openhab-addons/commit/bdb333674b8a08f7aa454c0026ffd710500f7722", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-26T22:11:57Z", "type": "forcePushed"}, {"oid": "5b990791d414fe60fb6c67ff53a4b9770910d315", "url": "https://github.com/openhab/openhab-addons/commit/5b990791d414fe60fb6c67ff53a4b9770910d315", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-26T22:24:09Z", "type": "forcePushed"}, {"oid": "2a6314e049e97f577cacd5b27f14e3342adc7033", "url": "https://github.com/openhab/openhab-addons/commit/2a6314e049e97f577cacd5b27f14e3342adc7033", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-27T00:53:00Z", "type": "forcePushed"}, {"oid": "a43e61670eea21de5f03f66dd3e1f95444cceaa2", "url": "https://github.com/openhab/openhab-addons/commit/a43e61670eea21de5f03f66dd3e1f95444cceaa2", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-27T03:17:09Z", "type": "commit"}, {"oid": "a43e61670eea21de5f03f66dd3e1f95444cceaa2", "url": "https://github.com/openhab/openhab-addons/commit/a43e61670eea21de5f03f66dd3e1f95444cceaa2", "message": "[jsscripting] Initial contribution of JSScripting bundle, based on GraalJS\n\nSigned-off-by: Jonathan Gilbert <jpg@trillica.com>", "committedDate": "2021-03-27T03:17:09Z", "type": "forcePushed"}, {"oid": "0a51afaad17d748ece7af0c765731552232ea6dc", "url": "https://github.com/openhab/openhab-addons/commit/0a51afaad17d748ece7af0c765731552232ea6dc", "message": "Update CODEOWNERS\r\n\r\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-06T07:04:31Z", "type": "commit"}, {"oid": "b033bb7e63651befcd102d2d934625d4468c6d2b", "url": "https://github.com/openhab/openhab-addons/commit/b033bb7e63651befcd102d2d934625d4468c6d2b", "message": "Update CODEOWNERS\r\n\r\nSigned-off-by: Wouter Born <github@maindrain.net>", "committedDate": "2021-05-06T07:07:25Z", "type": "commit"}]}