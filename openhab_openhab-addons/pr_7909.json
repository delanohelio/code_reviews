{"pr_number": 7909, "pr_title": "[hue] Set bridge status to ONLINE only after a polling success", "pr_author": "lolodomo", "pr_createdAt": "2020-06-12T19:41:04Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7909", "timeline": [{"oid": "f9f6ea69c425a2e248a2107c9c23e7a016152e7d", "url": "https://github.com/openhab/openhab-addons/commit/f9f6ea69c425a2e248a2107c9c23e7a016152e7d", "message": "[hue] Set bridge status to ONLINE only after a polling success\n\nFix #7905\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-12T20:09:35Z", "type": "commit"}, {"oid": "f9f6ea69c425a2e248a2107c9c23e7a016152e7d", "url": "https://github.com/openhab/openhab-addons/commit/f9f6ea69c425a2e248a2107c9c23e7a016152e7d", "message": "[hue] Set bridge status to ONLINE only after a polling success\n\nFix #7905\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-06-12T20:09:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3ODY2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7909#discussion_r439678667", "body": "Let the framework handle the checking for you.\r\n```suggestion\r\n                    updateStatus(ThingStatus.ONLINE);\r\n```", "bodyText": "Let the framework handle the checking for you.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (thing.getStatus() != ThingStatus.ONLINE) {\n          \n          \n            \n                                    updateStatus(ThingStatus.ONLINE);\n          \n          \n            \n                                }\n          \n          \n            \n                                updateStatus(ThingStatus.ONLINE);", "bodyHTML": "<p dir=\"auto\">Let the framework handle the checking for you.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"117\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">if</span> (thing<span class=\"pl-k\">.</span>getStatus() <span class=\"pl-k\">!=</span> <span class=\"pl-smi\">ThingStatus</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ONLINE</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"118\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        updateStatus(<span class=\"pl-smi\">ThingStatus</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ONLINE</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"119\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"117\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    updateStatus(<span class=\"pl-smi\">ThingStatus</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ONLINE</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-06-12T23:26:59Z", "path": "bundles/org.openhab.binding.hue/src/main/java/org/openhab/binding/hue/internal/handler/HueBridgeHandler.java", "diffHunk": "@@ -114,6 +114,9 @@ public void run() {\n                 }\n                 if (lastBridgeConnectionState) {\n                     doConnectedRun();\n+                    if (thing.getStatus() != ThingStatus.ONLINE) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                    }", "originalCommit": "f9f6ea69c425a2e248a2107c9c23e7a016152e7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcxNDIwMw==", "url": "https://github.com/openhab/openhab-addons/pull/7909#discussion_r439714203", "bodyText": "I checked the framework code and each call to updateStatus will produce one event on the event bus (even 2 in case of status change).\nWith the sensor polling run by default twice per second and possibly every 50 ms, this could lead to a massive event publishing on the bus. My test is here to avoid that.", "author": "lolodomo", "createdAt": "2020-06-13T06:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3ODY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTcxNDgyNw==", "url": "https://github.com/openhab/openhab-addons/pull/7909#discussion_r439714827", "bodyText": "I realize that we could have a massive number of OFFLINE events on the bus too. I think the same check should be applied to updateStatus(OFFLINE).\nThis case is of course less common.", "author": "lolodomo", "createdAt": "2020-06-13T06:38:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3ODY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2MjgwOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7909#discussion_r439762809", "bodyText": "I think in general that this is something that the framework should have been optimized for since bindings shouldn't be expected to perform this check themselves.\nAfter looking up the core code it does seem that it would publish to the event bus every time you call that, but it wouldn't publish the additional change event if it hasn't changed.\nhttps://github.com/openhab/openhab-core/blob/61e17ce39e83daa7f1d8c41512dead8d95d6e5d9/bundles/org.openhab.core.thing/src/main/java/org/openhab/core/thing/internal/ThingManagerImpl.java#L1147\nSo I guess you might have a point in trying to prevent that mandatory event publish. Seems weird that it would do that but we can't really change the core atm and your check is harmless so just leave your status check in place.", "author": "cpmeister", "createdAt": "2020-06-13T19:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3ODY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc2MzAwMA==", "url": "https://github.com/openhab/openhab-addons/pull/7909#discussion_r439763000", "bodyText": "I realize that we could have a massive number of OFFLINE events on the bus too. I think the same check should be applied to updateStatus(OFFLINE).\nThis case is of course less common.\n\nI don't think you should check in this case since it doesn't occur as often.", "author": "cpmeister", "createdAt": "2020-06-13T19:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTY3ODY2Nw=="}], "type": "inlineReview"}]}