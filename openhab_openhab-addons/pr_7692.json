{"pr_number": 7692, "pr_title": "[openweathermap] bridge / thing handling", "pr_author": "lolodomo", "pr_createdAt": "2020-05-18T21:52:54Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7692", "timeline": [{"oid": "52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "url": "https://github.com/openhab/openhab-addons/commit/52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "message": "[openweathermap] bridge / thing handling\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-05-18T21:49:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NDcyNg==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r426974726", "body": "You should eliminate the requirement for subclasses to have to call super and then exit early. Instead you should just move all the  `AbstractOpenWeatherMapHandler.initializeThing` logic into `AbstractOpenWeatherMapHandler.initialize`, make `AbstractOpenWeatherMapHandler.initializeThing` abstract and only call `initializeThing` when `bridgeHandler != null && bridgeStatus == ThingStatus.ONLINE`.", "bodyText": "You should eliminate the requirement for subclasses to have to call super and then exit early. Instead you should just move all the  AbstractOpenWeatherMapHandler.initializeThing logic into AbstractOpenWeatherMapHandler.initialize, make AbstractOpenWeatherMapHandler.initializeThing abstract and only call initializeThing when bridgeHandler != null && bridgeStatus == ThingStatus.ONLINE.", "bodyHTML": "<p dir=\"auto\">You should eliminate the requirement for subclasses to have to call super and then exit early. Instead you should just move all the  <code>AbstractOpenWeatherMapHandler.initializeThing</code> logic into <code>AbstractOpenWeatherMapHandler.initialize</code>, make <code>AbstractOpenWeatherMapHandler.initializeThing</code> abstract and only call <code>initializeThing</code> when <code>bridgeHandler != null &amp;&amp; bridgeStatus == ThingStatus.ONLINE</code>.</p>", "author": "cpmeister", "createdAt": "2020-05-19T01:13:28Z", "path": "bundles/org.openhab.binding.openweathermap/src/main/java/org/openhab/binding/openweathermap/internal/handler/OpenWeatherMapWeatherAndForecastHandler.java", "diffHunk": "@@ -82,8 +83,11 @@ public OpenWeatherMapWeatherAndForecastHandler(Thing thing) {\n     }\n \n     @Override\n-    public void initialize() {\n-        super.initialize();\n+    protected void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n+        super.initializeThing(bridgeHandler, bridgeStatus);\n+        if (bridgeHandler == null || bridgeStatus != ThingStatus.ONLINE) {\n+            return;\n+        }", "originalCommit": "52c1f707c6e8a62e75d1d6c6e0f5aaa7aabea0fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA1NjU5Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427056593", "bodyText": "I see what you mean and you're right. I am going to improve that.", "author": "lolodomo", "createdAt": "2020-05-19T06:24:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NDcyNg=="}], "type": "inlineReview"}, {"oid": "2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "url": "https://github.com/openhab/openhab-addons/commit/2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "message": "Create an abstract method\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-05-19T06:38:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427487106", "body": "Since `bridge.getStatus()` should reflect the most recently changed status. It should be possible to refactor the logic from `bridgeStatusChanged` and `initialize` into `initializeThing`. Of course we would have to change the name here to avoid naming conflicts with our abstract method.\r\n```suggestion\r\n    private void initializeThingInternal() {\r\n        Bridge bridge = getBridge();\r\n        ThingHandler bridgeHandler = bridge != null ? bridge.getHandler() : null;\r\n        ThingStatus bridgeStatus = bridge != null ? bridge.getStatus() : null;\r\n        if (bridgeHandler != null && bridgeStatus != null) {\r\n```", "bodyText": "Since bridge.getStatus() should reflect the most recently changed status. It should be possible to refactor the logic from bridgeStatusChanged and initialize into initializeThing. Of course we would have to change the name here to avoid naming conflicts with our abstract method.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n          \n          \n            \n                    if (bridgeHandler != null && bridgeStatus != null) {\n          \n          \n            \n                private void initializeThingInternal() {\n          \n          \n            \n                    Bridge bridge = getBridge();\n          \n          \n            \n                    ThingHandler bridgeHandler = bridge != null ? bridge.getHandler() : null;\n          \n          \n            \n                    ThingStatus bridgeStatus = bridge != null ? bridge.getStatus() : null;\n          \n          \n            \n                    if (bridgeHandler != null && bridgeStatus != null) {", "bodyHTML": "<p dir=\"auto\">Since <code>bridge.getStatus()</code> should reflect the most recently changed status. It should be possible to refactor the logic from <code>bridgeStatusChanged</code> and <code>initialize</code> into <code>initializeThing</code>. Of course we would have to change the name here to avoid naming conflicts with our abstract method.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"95\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> initializeThing(<span class=\"pl-k\">@Nullable</span> <span class=\"pl-smi\">ThingHandler</span> bridgeHandler, <span class=\"pl-k\">@Nullable</span> <span class=\"pl-smi\">ThingStatus</span> bridgeStatus) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"96\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (bridgeHandler <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> bridgeStatus <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"95\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> initializeThingInternal() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"96\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">Bridge</span> bridge <span class=\"pl-k\">=</span> getBridge();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"97\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">ThingHandler</span> bridgeHandler <span class=\"pl-k\">=</span> bridge <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">?</span> bridge<span class=\"pl-k\">.</span>getHandler() <span class=\"pl-k\">:</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"98\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">ThingStatus</span> bridgeStatus <span class=\"pl-k\">=</span> bridge <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">?</span> bridge<span class=\"pl-k\">.</span>getStatus() <span class=\"pl-k\">:</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"99\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (bridgeHandler <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> bridgeStatus <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-05-19T17:47:18Z", "path": "bundles/org.openhab.binding.openweathermap/src/main/java/org/openhab/binding/openweathermap/internal/handler/AbstractOpenWeatherMapHandler.java", "diffHunk": "@@ -82,29 +84,50 @@ public AbstractOpenWeatherMapHandler(Thing thing) {\n \n     @Override\n     public void initialize() {\n-        OpenWeatherMapLocationConfiguration config = getConfigAs(OpenWeatherMapLocationConfiguration.class);\n-\n-        boolean configValid = true;\n-        if (StringUtils.trimToNull(config.getLocation()) == null) {\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"@text/offline.conf-error-missing-location\");\n-            configValid = false;\n+        logger.debug(\"initializing handler for thing {}\", getThing().getUID());\n+        Bridge bridge = getBridge();\n+        if (bridge == null) {\n+            initializeThing(null, null);\n+        } else {\n+            initializeThing(bridge.getHandler(), bridge.getStatus());\n         }\n+    }\n \n-        try {\n-            location = new PointType(config.getLocation());\n-        } catch (IllegalArgumentException e) {\n-            location = null;\n-            updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.CONFIGURATION_ERROR,\n-                    \"@text/offline.conf-error-parsing-location\");\n-            configValid = false;\n-        }\n+    private void initializeThing(@Nullable ThingHandler bridgeHandler, @Nullable ThingStatus bridgeStatus) {\n+        if (bridgeHandler != null && bridgeStatus != null) {", "originalCommit": "2a1a3b5dedcc78730e44987a6f46f4d685a8957f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMDkyMA==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427520920", "bodyText": "In this case, you don't use at all the value provided as parameter toi bridgeStatusChanged.\nI don't know how big is the risk to do that.\nBut why would have been provided the bridge status as parameter if it is useless ?", "author": "lolodomo", "createdAt": "2020-05-19T18:42:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3MDM2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427570363", "bodyText": "The super implementation of bridgeStatusChanged uses that bridge status param just fine. But it doesn't take into account the bridge becoming null like your new code is doing.\nAs will all event handling, sometimes the event handler doesn't care about the event that is getting handled, only that something happened. This is often the case with refresh handlers which don't care what kind of event took place and thus would ignore the event parameter in its handler method.", "author": "cpmeister", "createdAt": "2020-05-19T20:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU4MTAxNg==", "url": "https://github.com/openhab/openhab-addons/pull/7692#discussion_r427581016", "bodyText": "This is not the usual pattern I have found in different bindings.\nWe could at least provide the bridgeStatus as parameter to the common internal method ?", "author": "lolodomo", "createdAt": "2020-05-19T20:30:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ4NzEwNg=="}], "type": "inlineReview"}, {"oid": "f87846b1d94ce803d20e5cf91e521731c4eeef34", "url": "https://github.com/openhab/openhab-addons/commit/f87846b1d94ce803d20e5cf91e521731c4eeef34", "message": "Only bridgeStatus as parameter for method initializeThing\n\nSigned-off-by: Laurent Garnier <lg.hc@free.fr>", "committedDate": "2020-05-19T20:58:46Z", "type": "commit"}]}