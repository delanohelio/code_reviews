{"pr_number": 6993, "pr_title": "[somfytahoma] added dynamic RSSI channel", "pr_author": "octa22", "pr_createdAt": "2020-02-10T20:32:37Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/6993", "timeline": [{"oid": "889f3fbab6bb960201e40e059dece5215a7b151f", "url": "https://github.com/openhab/openhab-addons/commit/889f3fbab6bb960201e40e059dece5215a7b151f", "message": "[somfytahoma] added dynamic rssi channel\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>", "committedDate": "2020-03-01T12:55:41Z", "type": "commit"}, {"oid": "89f9ea65f011b094b90bf7e3f292515137afea42", "url": "https://github.com/openhab/openhab-addons/commit/89f9ea65f011b094b90bf7e3f292515137afea42", "message": "[somfytahoma] added extra channels for sensor things\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>", "committedDate": "2020-03-01T12:55:41Z", "type": "commit"}, {"oid": "1f4e5c048545d92912ef80588ee74fa6121ee118", "url": "https://github.com/openhab/openhab-addons/commit/1f4e5c048545d92912ef80588ee74fa6121ee118", "message": "[somfytahoma] code cleanup\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>", "committedDate": "2020-03-01T12:55:41Z", "type": "commit"}, {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "url": "https://github.com/openhab/openhab-addons/commit/c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "message": "[somfytahoma] improved logging\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>", "committedDate": "2020-03-01T12:57:41Z", "type": "commit"}, {"oid": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "url": "https://github.com/openhab/openhab-addons/commit/c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "message": "[somfytahoma] improved logging\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>", "committedDate": "2020-03-01T12:57:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3NTc2MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387175761", "body": "`getURL` is quite expensive and called even if the log level is lower than DEBUG. Is there any reason why the URL is not set during initialization and stored in a String field? In case of configuration change the thing handler is disposed and re-initialized, so this should not be a problem. (also applies below)", "bodyText": "getURL is quite expensive and called even if the log level is lower than DEBUG. Is there any reason why the URL is not set during initialization and stored in a String field? In case of configuration change the thing handler is disposed and re-initialized, so this should not be a problem. (also applies below)", "bodyHTML": "<p dir=\"auto\"><code>getURL</code> is quite expensive and called even if the log level is lower than DEBUG. Is there any reason why the URL is not set during initialization and stored in a String field? In case of configuration change the thing handler is disposed and re-initialized, so this should not be a problem. (also applies below)</p>", "author": "J-N-K", "createdAt": "2020-03-03T17:24:03Z", "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBaseThingHandler.java", "diffHunk": "@@ -62,12 +64,29 @@ public SomfyTahomaBaseThingHandler(Thing thing) {\n \n     @Override\n     public void initialize() {\n+        if (getThing().getProperties().containsKey(RSSI_LEVEL_STATE)) {\n+            createRSSIChannel();\n+        }\n         updateStatus(ThingStatus.ONLINE);\n     }\n \n+    private void createRSSIChannel() {\n+        if (thing.getChannel(RSSI) == null) {\n+            logger.debug(\"{} Creating a rssi channel\", getURL());\n+            createChannel(RSSI, \"Number\",\"RSSI Level\");\n+        }\n+    }\n+\n+    private void createChannel(String name, String type, String label) {\n+        ThingBuilder thingBuilder = editThing();\n+        Channel channel = ChannelBuilder.create(new ChannelUID(thing.getUID(), name), type).withLabel(label).build();\n+        thingBuilder.withChannel(channel);\n+        updateThing(thingBuilder.build());\n+    }\n+\n     @Override\n     public void handleCommand(ChannelUID channelUID, Command command) {\n-        logger.debug(\"Received command {} for channel {}\", command, channelUID);\n+        logger.debug(\"{} Received command {} for channel {}\", getURL(), command, channelUID);", "originalCommit": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwMzk0OA==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387203948", "bodyText": "nice hint! fixed", "author": "octa22", "createdAt": "2020-03-03T18:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3NTc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3ODY5NQ==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387178695", "body": "`isChannelLinked` is quite expensive, while `parseTahomaState` seems to be cheap. Is there a special reason to check the channel link state (I know that has been done before, but ...)", "bodyText": "isChannelLinked is quite expensive, while parseTahomaState seems to be cheap. Is there a special reason to check the channel link state (I know that has been done before, but ...)", "bodyHTML": "<p dir=\"auto\"><code>isChannelLinked</code> is quite expensive, while <code>parseTahomaState</code> seems to be cheap. Is there a special reason to check the channel link state (I know that has been done before, but ...)</p>", "author": "J-N-K", "createdAt": "2020-03-03T17:29:15Z", "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBaseThingHandler.java", "diffHunk": "@@ -275,21 +294,40 @@ private void updateThingStatus(@Nullable SomfyTahomaState state) {\n     public void updateThingChannels(List<SomfyTahomaState> states) {\n         Map<String, String> properties = new HashMap<>();\n         for (SomfyTahomaState state : states) {\n-            logger.trace(\"processing state: {} with value: {}\", state.getName(), state.getValue());\n+            logger.trace(\"{} processing state: {} with value: {}\", getURL(), state.getName(), state.getValue());\n             properties.put(state.getName(), state.getValue().toString());\n-            updateThingChannels(state);\n+            if (RSSI_LEVEL_STATE.equals(state.getName())) {\n+                // RSSI channel is a dynamic one\n+                updateRSSIChannel(state);\n+            } else {\n+                updateThingChannels(state);\n+            }\n         }\n         updateProperties(properties);\n     }\n \n+    private void updateRSSIChannel(SomfyTahomaState state) {\n+        createRSSIChannel();\n+        Channel ch = thing.getChannel(RSSI);\n+        if (ch != null && isChannelLinked(ch)) {", "originalCommit": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwNDM2OA==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387204368", "bodyText": "removed the check for a linked channel", "author": "octa22", "createdAt": "2020-03-03T18:17:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE3ODY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4NDk2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387184962", "body": "This looks strange. Maybe run the spotless formatter before we merge", "bodyText": "This looks strange. Maybe run the spotless formatter before we merge", "bodyHTML": "<p dir=\"auto\">This looks strange. Maybe run the spotless formatter before we merge</p>", "author": "J-N-K", "createdAt": "2020-03-03T17:41:20Z", "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaWaterSensorHandler.java", "diffHunk": "@@ -12,8 +12,8 @@\n  */\n package org.openhab.binding.somfytahoma.internal.handler;\n \n-import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.CONTACT;\n-import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.WATER_DETECTION_STATE;\n+import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.*;\n+import static org.openhab.binding.somfytahoma.internal.SomfyTahomaBindingConstants.SENSOR_DEFECT_STATE;", "originalCommit": "c29df786a9949d4a7b14fe0f2ac3cdfe926910c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwNDg1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387204856", "bodyText": "fixed", "author": "octa22", "createdAt": "2020-03-03T18:18:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4NDk2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyNTk4MQ==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387225981", "body": "Unfortunately this will not work, the config might not be available when the handler is constructed.\r\n```suggestion\r\n    private final String url = \"\";\r\n```\r\n\r\nAnd call `url=getURL();` in `initialize();`", "bodyText": "Unfortunately this will not work, the config might not be available when the handler is constructed.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String url = getURL();\n          \n          \n            \n                private final String url = \"\";\n          \n      \n    \n    \n  \n\nAnd call url=getURL(); in initialize();", "bodyHTML": "<p dir=\"auto\">Unfortunately this will not work, the config might not be available when the handler is constructed.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> url <span class=\"pl-k\">=</span> <span class=\"x x-first x-last\">getURL()</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> url <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds x x-first\">\"</span><span class=\"pl-pds x x-last\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">And call <code>url=getURL();</code> in <code>initialize();</code></p>", "author": "J-N-K", "createdAt": "2020-03-03T18:56:10Z", "path": "bundles/org.openhab.binding.somfytahoma/src/main/java/org/openhab/binding/somfytahoma/internal/handler/SomfyTahomaBaseThingHandler.java", "diffHunk": "@@ -62,6 +62,8 @@ public SomfyTahomaBaseThingHandler(Thing thing) {\n         return stateNames;\n     }\n \n+    private final String url = getURL();", "originalCommit": "07f364e07152ada7b5106a44a4fbd88d57700a4e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyNzk4Mg==", "url": "https://github.com/openhab/openhab-addons/pull/6993#discussion_r387227982", "bodyText": "fixed, thanks", "author": "octa22", "createdAt": "2020-03-03T18:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIyNTk4MQ=="}], "type": "inlineReview"}, {"oid": "2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "url": "https://github.com/openhab/openhab-addons/commit/2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "message": "[somfytahoma] fixes based on a code review\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>", "committedDate": "2020-03-03T18:58:59Z", "type": "commit"}, {"oid": "2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "url": "https://github.com/openhab/openhab-addons/commit/2f5d3b8db9ecf8e28d55c45bd482c1590ddd2098", "message": "[somfytahoma] fixes based on a code review\n\nSigned-off-by: Ondrej Pecta <opecta@gmail.com>", "committedDate": "2020-03-03T18:58:59Z", "type": "forcePushed"}]}