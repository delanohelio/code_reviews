{"pr_number": 9227, "pr_title": "[icalendar] Reload calendar file asynchronously", "pr_author": "cweitkamp", "pr_createdAt": "2020-12-04T19:29:59Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/9227", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r536385625", "body": "Maybe it would be better to just let the scheduled pull task handle the asynchronous part instead?\r\n```suggestion\r\n                updateStatus(ThingStatus.UNKNOWN);\r\n                pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, 0, refreshTime,\r\n                        TimeUnit.MINUTES);\r\n```", "bodyText": "Maybe it would be better to just let the scheduled pull task handle the asynchronous part instead?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n            \n          \n          \n            \n                            scheduler.submit(() -> {\n          \n          \n            \n                                // reload calendar file asynchronously\n          \n          \n            \n                                if (reloadCalendar()) {\n          \n          \n            \n                                    updateStatus(ThingStatus.ONLINE);\n          \n          \n            \n                                    updateStates();\n          \n          \n            \n                                    rescheduleCalendarStateUpdate();\n          \n          \n            \n                                } else {\n          \n          \n            \n                                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n          \n          \n            \n                                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n          \n          \n            \n                                }\n          \n          \n            \n                            });\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);\n          \n          \n            \n                            updateStatus(ThingStatus.UNKNOWN);\n          \n          \n            \n                            pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, 0, refreshTime,\n          \n          \n            \n                                    TimeUnit.MINUTES);", "bodyHTML": "<p dir=\"auto\">Maybe it would be better to just let the scheduled pull task handle the asynchronous part instead?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"167\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                updateStatus(<span class=\"pl-smi\">ThingStatus</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>UNKNOWN</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"168\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"169\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                scheduler<span class=\"pl-k\">.</span>submit(() <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"170\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-c\"><span class=\"pl-c\">//</span> reload calendar file asynchronously</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"171\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">if</span> (reloadCalendar()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"172\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        updateStatus(<span class=\"pl-smi\">ThingStatus</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>ONLINE</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"173\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        updateStates();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"174\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        rescheduleCalendarStateUpdate();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"175\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"176\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        updateStatus(<span class=\"pl-smi\">ThingStatus</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>OFFLINE</span>, <span class=\"pl-smi\">ThingStatusDetail</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>COMMUNICATION_ERROR</span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"177\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                                <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"178\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"179\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                });</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"180\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                pullJobFuture <span class=\"pl-k\">=</span> scheduler<span class=\"pl-k\">.</span>scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"181\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        <span class=\"pl-smi\">TimeUnit</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MINUTES</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"167\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                updateStatus(<span class=\"pl-smi\">ThingStatus</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>UNKNOWN</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"168\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                pullJobFuture <span class=\"pl-k\">=</span> scheduler<span class=\"pl-k\">.</span>scheduleWithFixedDelay(regularPull, <span class=\"pl-c1\">0</span>, refreshTime,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"169\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        <span class=\"pl-smi\">TimeUnit</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MINUTES</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-12-04T21:19:30Z", "path": "bundles/org.openhab.binding.icalendar/src/main/java/org/openhab/binding/icalendar/internal/handler/ICalendarHandler.java", "diffHunk": "@@ -154,14 +152,19 @@ public void initialize() {\n             }\n             final long refreshTime = refreshTimeBD.longValue();\n             if (calendarFile.isFile()) {\n-                if (reloadCalendar()) {\n-                    updateStatus(ThingStatus.ONLINE);\n-                    updateStates();\n-                    rescheduleCalendarStateUpdate();\n-                } else {\n-                    updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n-                            \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n-                }\n+                updateStatus(ThingStatus.UNKNOWN);\n+\n+                scheduler.submit(() -> {\n+                    // reload calendar file asynchronously\n+                    if (reloadCalendar()) {\n+                        updateStatus(ThingStatus.ONLINE);\n+                        updateStates();\n+                        rescheduleCalendarStateUpdate();\n+                    } else {\n+                        updateStatus(ThingStatus.OFFLINE, ThingStatusDetail.COMMUNICATION_ERROR,\n+                                \"The calendar seems to be configured correctly, but the local copy of calendar could not be loaded.\");\n+                    }\n+                });\n                 pullJobFuture = scheduler.scheduleWithFixedDelay(regularPull, refreshTime, refreshTime,\n                         TimeUnit.MINUTES);", "originalCommit": "02bd093d133e941609e3d10d08857b6fa4de91ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwOTgxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537109815", "bodyText": "I am not sure if that will work. IIRC downloading the calendar is not part of the pull job. We might want to ask @daMihe for his opinion.", "author": "cweitkamp", "createdAt": "2020-12-06T19:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzExMzA1MA==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537113050", "bodyText": "Asynchronously loading the calendar works, it's already triggered by PullJob via CalendarUpdateListener.onCalendarUpdated() this way (regularly via scheduleWithFixedDelay). However, just using the PullJob for reloading may cause the calendar to be in OFFLINE state if e.g. being offline even if a cached copy exists. So i think this is not a good idea.", "author": "daMihe", "createdAt": "2020-12-06T20:05:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI0NjA5Nw==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537246097", "bodyText": "Well this PR will put the calendar into an UNKNOWN state, which is a kind of offline state, while it loads the cached copy anyway. If we can assert that any stored copy of the calendar is a valid one then I can see allowing the binding to initially enter an ONLINE state if it finds a file is present already.", "author": "cpmeister", "createdAt": "2020-12-07T05:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgzNDYzMg==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537834632", "bodyText": "Yes, sounds reasonable. I just saw that reloadCalendar() calls rescheduleCalendarStateUpdate() too which makes the second call inside the if superfluous. I will remove that too.", "author": "cweitkamp", "createdAt": "2020-12-07T21:09:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MDE4MA==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r537870180", "bodyText": "Yes this seems to be redundant. You can also remove the updateStatus inside the if as its already done in updateStates. I assume this went into code about time and after several changes.", "author": "daMihe", "createdAt": "2020-12-07T22:09:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODU0MzU2MQ==", "url": "https://github.com/openhab/openhab-addons/pull/9227#discussion_r538543561", "bodyText": "Dine in 906c1c2.", "author": "cweitkamp", "createdAt": "2020-12-08T16:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NTYyNQ=="}], "type": "inlineReview"}, {"oid": "06003c1188f6d8a3b0ae55f68224be214ef2173f", "url": "https://github.com/openhab/openhab-addons/commit/06003c1188f6d8a3b0ae55f68224be214ef2173f", "message": "Reload calendar file asynchronously\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-08T07:36:13Z", "type": "commit"}, {"oid": "906c1c273faecf1a243199598b2b832554b4627d", "url": "https://github.com/openhab/openhab-addons/commit/906c1c273faecf1a243199598b2b832554b4627d", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-08T07:42:15Z", "type": "commit"}, {"oid": "906c1c273faecf1a243199598b2b832554b4627d", "url": "https://github.com/openhab/openhab-addons/commit/906c1c273faecf1a243199598b2b832554b4627d", "message": "Incorporated comments from review\n\nSigned-off-by: Christoph Weitkamp <github@christophweitkamp.de>", "committedDate": "2020-12-08T07:42:15Z", "type": "forcePushed"}]}