{"pr_number": 7662, "pr_title": "[insteon] remove support for multiple ports", "pr_author": "robnielsen", "pr_createdAt": "2020-05-17T17:41:12Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7662", "timeline": [{"oid": "715fb9be64ce1536a3536fc411c56be51d1e0b54", "url": "https://github.com/openhab/openhab-addons/commit/715fb9be64ce1536a3536fc411c56be51d1e0b54", "message": "[insteon] remove support for multiple ports\n\nSigned-off-by: Rob Nielsen <rob.nielsen@yahoo.com>", "committedDate": "2020-05-17T17:33:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426323762", "body": "Any reason this is no longer evaluated at the end of the constructor? You should make sure not the leak any references of `this` until after you have finished essential configuration.", "bodyText": "Any reason this is no longer evaluated at the end of the constructor? You should make sure not the leak any references of this until after you have finished essential configuration.", "bodyHTML": "<p dir=\"auto\">Any reason this is no longer evaluated at the end of the constructor? You should make sure not the leak any references of <code>this</code> until after you have finished essential configuration.</p>", "author": "cpmeister", "createdAt": "2020-05-18T00:33:42Z", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/InsteonBinding.java", "diffHunk": "@@ -125,6 +125,12 @@ public InsteonBinding(InsteonNetworkHandler handler, @Nullable InsteonNetworkCon\n             @Nullable SerialPortManager serialPortManager) {\n         this.handler = handler;\n \n+        String port = config.getPort();\n+        logger.debug(\"port = '{}'\", Utils.redactPassword(port));\n+\n+        driver = new Driver(port, portListener, serialPortManager);\n+        driver.addMsgListener(portListener);", "originalCommit": "715fb9be64ce1536a3536fc411c56be51d1e0b54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTEwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426335102", "bodyText": "Driver previously didn't have a constructor and was created when driver was declared above.  This change allowed the removal of @SuppressWarnings(\"null\") from Driver by passing them in as parameters to the constructor instead of using setters.", "author": "robnielsen", "createdAt": "2020-05-18T01:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0MDA5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426340099", "bodyText": "What I meant is that this new code was put at the beginning of the InsteonBinding constructor whereas the old code was at the end of the InsteonBinding constructor.", "author": "cpmeister", "createdAt": "2020-05-18T02:21:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0NjY2Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426346666", "bodyText": "Yes that's because the old code had this above:\nprivate Driver driver = new Driver();\nWhy does it matter? Where is this leaked?", "author": "robnielsen", "createdAt": "2020-05-18T02:56:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0ODQ2OA==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426348468", "bodyText": "this is leaked through the PortListener.", "author": "cpmeister", "createdAt": "2020-05-18T03:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1MDI3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426350279", "bodyText": "I still don't understand the concern, and why it matters. If it's a big deal, maybe I'll just delete this PR and stop contributing.", "author": "robnielsen", "createdAt": "2020-05-18T03:16:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NzY3OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426357679", "bodyText": "The general concern over a leak of this is that other might start calling methods on your InsteonBinding class when it hasn't even finished constructing. What would happen if PortListener starts getting call on its methods before you have finished loading devices? The instant you leak this in a constructor you put yourself at risk of bugs NPE bugs that would normally not be possible if an object was constructed completely before exposing it to other objects.\nIn this case it might not cause a problem since things shouldn't start calling PortListener until you call driver.start() but leaking the this reference is a general problem to be aware of.\nThat said leaking the this is often the most convenient way to code something so at the very least try to make sure you leak this at the very end of your constructor when you know all the other class fields have been initialized, thus this would be \"safe\" to call from outside classes.\nhttp://www.javapractices.com/topic/TopicAction.do?Id=252", "author": "cpmeister", "createdAt": "2020-05-18T03:57:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1ODc0Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426358747", "bodyText": "You might notice from the link I posted that they suggest not leaking this at ALL. While I agree with it in principle, I also think that trying to enforce that would cause a bit a code bloat so that is why I recommend just leaking this at the end of the constructor.", "author": "cpmeister", "createdAt": "2020-05-18T04:02:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4MTgxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426581813", "bodyText": "@kaikreuzer, this is ridiculous, lot of assumptions here. I thought I was doing a good thing by removing @SuppressWarnings(\"null\") from Driver and rearranging the code, but I guess not according to @cpmeister.\nThis sort of nitpicking is what causes people to stop contributing, and I'm about to that point.  I have some other features that I was thinking about implementing, but probably won't if this continues.", "author": "robnielsen", "createdAt": "2020-05-18T12:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgwNjc1Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426806756", "bodyText": "@robnielsen I am very sure that @cpmeister is not meaning to annoy you in any way. Like you and others, he wants to help and ensure that openHAB has a proper code base.\nNobody should be felt pissed off by anyone else, when everybody is doing their best - so please consider this and try to solve any discussions in a collaborative manner. You should be aware that many developers LOVE such discussions, because they learn from each other and become better developers in the long run - it is part of the fun. If it is no fun for you, just express it or simply give in to the arguments.", "author": "kaikreuzer", "createdAt": "2020-05-18T18:09:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMyMzc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NzkzNw==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426357937", "body": "This is where I would suggest to move the code.\r\n```suggestion\r\n        String port = config.getPort();\r\n        logger.debug(\"port = '{}'\", Utils.redactPassword(port));\r\n\r\n        driver = new Driver(port, portListener, serialPortManager);\r\n        driver.addMsgListener(portListener);\r\n    }\r\n```", "bodyText": "This is where I would suggest to move the code.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                }\n          \n          \n            \n                    String port = config.getPort();\n          \n          \n            \n                    logger.debug(\"port = '{}'\", Utils.redactPassword(port));\n          \n          \n            \n            \n          \n          \n            \n                    driver = new Driver(port, portListener, serialPortManager);\n          \n          \n            \n                    driver.addMsgListener(portListener);\n          \n          \n            \n                }", "bodyHTML": "<p dir=\"auto\">This is where I would suggest to move the code.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"164\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"x x-first x-last\">}</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"164\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"x x-first\">    </span><span class=\"pl-smi x\">String</span><span class=\"x\"> port </span><span class=\"pl-k x\">=</span><span class=\"x\"> config</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getPort();</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"165\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        logger<span class=\"pl-k\">.</span>debug(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>port = '{}'<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-smi\">Utils</span><span class=\"pl-k\">.</span>redactPassword(port));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"166\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"167\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        driver <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">Driver</span>(port, portListener, serialPortManager);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"168\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        driver<span class=\"pl-k\">.</span>addMsgListener(portListener);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"169\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-05-18T03:58:37Z", "path": "bundles/org.openhab.binding.insteon/src/main/java/org/openhab/binding/insteon/internal/InsteonBinding.java", "diffHunk": "@@ -155,34 +161,12 @@ public InsteonBinding(InsteonNetworkHandler handler, @Nullable InsteonNetworkCon\n \n         deadDeviceTimeout = devicePollIntervalMilliseconds * DEAD_DEVICE_COUNT;\n         logger.debug(\"dead device timeout set to {} seconds\", deadDeviceTimeout / 1000);\n-\n-        String port = config.getPort();\n-        logger.debug(\"port = '{}'\", Utils.redactPassword(port));\n-        driver.addPort(\"port\", port, serialPortManager);\n-        driver.addMsgListener(portListener, port);\n-\n-        logger.debug(\"setting driver listener\");\n-        driver.setDriverListener(portListener);\n     }", "originalCommit": "715fb9be64ce1536a3536fc411c56be51d1e0b54", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4MTg2MA==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426581860", "bodyText": "If you look there is code above of this that depends on driver being initialized.", "author": "robnielsen", "createdAt": "2020-05-18T12:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NzkzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjczOTAxNQ==", "url": "https://github.com/openhab/openhab-addons/pull/7662#discussion_r426739015", "bodyText": "Ah, didn't notice that. My bad.", "author": "cpmeister", "createdAt": "2020-05-18T16:09:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM1NzkzNw=="}], "type": "inlineReview"}]}