{"pr_number": 7825, "pr_title": "[homekit] bugfix 7491 / add support for merging several updates to one command", "pr_author": "yfre", "pr_createdAt": "2020-05-31T14:29:34Z", "pr_url": "https://github.com/openhab/openhab-addons/pull/7825", "timeline": [{"oid": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "url": "https://github.com/openhab/openhab-addons/commit/c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "message": "add support for merging several updates to one command\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-05-31T14:08:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MjIzNw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433142237", "body": "If the class is not annotated `@NonNullByDefault` why do you need `@Nullable` here?", "bodyText": "If the class is not annotated @NonNullByDefault why do you need @Nullable here?", "bodyHTML": "<p dir=\"auto\">If the class is not annotated <code>@NonNullByDefault</code> why do you need <code>@Nullable</code> here?</p>", "author": "J-N-K", "createdAt": "2020-06-01T09:51:29Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    // delay, how long wait for further commands.\n+    // TODO: make it configurable ?\n+    private final int DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    @Nullable", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE5NjU1MA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433196550", "bodyText": "yeah, i tried to make it @NonNullByDefault but i had to make too many exceptions and suppress warnings so i decided to remove NoNullByDefault but forgot nullable", "author": "yfre", "createdAt": "2020-06-01T12:08:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MjIzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433148324", "body": "I'm not 100% sure that is the correct behaviour. Is 100% always send along ON? or can it be 50% and ON? The reason I ask is that I have a lot of KNX dimmers (in fact they are DALI, but connected over KNX). If I select the light in the HomeKit app (state was OFF) and set it to 50% via the slider it always turns on at 100%. IMO this is because ON is interpreted as 100% and overrides the brightness send before. So I think that ON should not be send but the actual brightness if both commands are available.", "bodyText": "I'm not 100% sure that is the correct behaviour. Is 100% always send along ON? or can it be 50% and ON? The reason I ask is that I have a lot of KNX dimmers (in fact they are DALI, but connected over KNX). If I select the light in the HomeKit app (state was OFF) and set it to 50% via the slider it always turns on at 100%. IMO this is because ON is interpreted as 100% and overrides the brightness send before. So I think that ON should not be send but the actual brightness if both commands are available.", "bodyHTML": "<p dir=\"auto\">I'm not 100% sure that is the correct behaviour. Is 100% always send along ON? or can it be 50% and ON? The reason I ask is that I have a lot of KNX dimmers (in fact they are DALI, but connected over KNX). If I select the light in the HomeKit app (state was OFF) and set it to 50% via the slider it always turns on at 100%. IMO this is because ON is interpreted as 100% and overrides the brightness send before. So I think that ON should not be send but the actual brightness if both commands are available.</p>", "author": "J-N-K", "createdAt": "2020-06-01T10:05:58Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    // delay, how long wait for further commands.\n+    // TODO: make it configurable ?\n+    private final int DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    @Nullable\n+    private ConcurrentHashMap<String, State> commandCache;\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    private void sendCommand() {\n+        if (item instanceof ColorItem) {\n+            final State currentState = item.getState() instanceof UnDefType ? HSBType.BLACK : item.getState();\n+            final State hue = commandCache.containsKey(HUE_COMMAND) ? commandCache.remove(HUE_COMMAND)\n+                    : ((HSBType) currentState).getHue();\n+            final State saturation = commandCache.containsKey(SATURATION_COMMAND)\n+                    ? commandCache.remove(SATURATION_COMMAND)\n+                    : ((HSBType) currentState).getSaturation();\n+            final State brightness = commandCache.containsKey(BRIGHTNESS_COMMAND)\n+                    ? commandCache.remove(BRIGHTNESS_COMMAND)\n+                    : ((HSBType) currentState).getBrightness();\n+            ((ColorItem) item).send(new HSBType((DecimalType) hue, (PercentType) saturation, (PercentType) brightness));\n+            logger.trace(\"send HSB command for item {} with following values h {} s{} b{}\", item, hue, saturation,\n+                    brightness);\n+        } else if (item instanceof DimmerItem) { // not ColorItem but DimmerItem\n+            final State on = commandCache.remove(ON_COMMAND);\n+            final State brightness = commandCache.remove(BRIGHTNESS_COMMAND);\n+\n+            // if \"ON\" command received we dont need to send brightness.\n+            // TODO: make brightness suppression on \"On\" configurable.\n+            if (on != null) {", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwMTA4NA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433201084", "bodyText": "did some tests:\n\n\nDimmer Off and i click on \"device icon\": home app sends \"On\" and Brightness = 100% independent on brightness which was before.\n\n\nDimmer On and i change brightness, e.g. from 50% to 60%, home app sends \"On\" and selected brightness (e.g. 60%). this was not covered by PR. will add commit\n\n\nDimmer is off and i open \"Control\" and select brightness, e.g. 60%,  home apps sends \"On\" and selected brightness.\n\n\nto me - we need only to suppress brightness=100% in the first case.\ndo we need to suppress \"On\" in the 2)?", "author": "yfre", "createdAt": "2020-06-01T12:19:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwNDgwMQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433204801", "bodyText": "Well, at least in my setup \u201eON\u201c always results in 100% on KNX dimmers. So I would prefer to suppress the ON instead of the brightness. However, for ZigBee devices this would lead to 100% even if the light was at 40% before and could resume that state.", "author": "J-N-K", "createdAt": "2020-06-01T12:28:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIyMzc4Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433223786", "bodyText": "ok. looks like we need to make configurable.\ndo i understand correctly we have 2 cases:\n\nsuppress \"ON\". so, never sends \"ON\" update only Brightness.\nsuppress 100% brightness (which typically comes with \"ON\" event)\n\nanything missing ? do we need to suppress \"OFF\"?", "author": "yfre", "createdAt": "2020-06-01T13:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NzQ0OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433287449", "bodyText": "The problem is that this would need to be configured on item level.\nWhat is send along with OFF? 0%? For hue/deconz lights (not sure about zigbee) sending 0% would result in a light going to on after the next ON command but with brightness 0, so actually the light is still off.\nIn what situation would you want to suppress 100%? All my devices would work perfectly if we only send brightness. Obviously HomeKit wants to turn the light full on if it sends ON and 100%. Or is this a limitation of HAP-Java which generates two commands where HomeKit sends only ON?", "author": "J-N-K", "createdAt": "2020-06-01T15:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzOTc5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433339799", "bodyText": "we had this use case in some tickets/discussion - Dimmer could have  a soft launch on On, i.e. increasing brightness slowly to 100%.\nHomeKit home app is sending always \"On\" and \"brightness\", both with one request, e.g. setting brightness with to 72", "author": "yfre", "createdAt": "2020-06-01T16:14:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1MTI0NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433351245", "bodyText": "Of course I don't know all devices, but at least all of my device also use some sort of transition time when the brightness changes (i.e. 100% and ON are equal). Also the change from say 10% to 90% is not instantaneous but is slower or faster depending on the configured time for that.\nAt least for KNX, DMX, deconz and hue lights this works. I agree that the \"double command\" is wrong in most cases, but I don't know of any device that would fail or behave wrong in case only the brightness is send.\nMaybe the following would be a good scheme:\nON / 100 % -> ON\nON / 1-99% -> 1-99%\nOFF / 0% -> OFF\nWould that cover everything?", "author": "J-N-K", "createdAt": "2020-06-01T16:34:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5MjQ4NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433392485", "bodyText": "yes, probably your case will cover most of the setups.\nbut let's make configurable on the item level.\ni add following 4 modes (better names are welcome)\n\nnone: nothing is filtered. this is default\nfilterOn: all \"on\" events are filtered. only brightness is sent.\nfilterBrightness100: brightness 100 is filtered when \"ON\" is sent. everything else with no changes. i.e. \"on\" along with brightness. this would support \"soft launch\"\nfilterOnExceptBrightness100: your proposal. brightness <100% -> \"ON\" event filtered, brightness = 100% -> only ON is sent\n\ncode committed. please take a look.\nonce we are ok with the logic and naming, i will update README", "author": "yfre", "createdAt": "2020-06-01T17:52:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0ODMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1MjE3NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433152175", "body": "```suggestion\r\n    private final HomekitOHItemProxy proxyItem;\r\n```\r\n\r\nI would suggest to rename this field as it is a bit confusing to have a field named `item` and call `.getItem()` on it to get the actual item.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final HomekitOHItemProxy item;\n          \n          \n            \n                private final HomekitOHItemProxy proxyItem;\n          \n      \n    \n    \n  \n\nI would suggest to rename this field as it is a bit confusing to have a field named item and call .getItem() on it to get the actual item.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">HomekitOHItemProxy</span> <span class=\"x x-first x-last\">item</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">HomekitOHItemProxy</span> <span class=\"x x-first x-last\">proxyItem</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I would suggest to rename this field as it is a bit confusing to have a field named <code>item</code> and call <code>.getItem()</code> on it to get the actual item.</p>", "author": "J-N-K", "createdAt": "2020-06-01T10:15:07Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitTaggedItem.java", "diffHunk": "@@ -39,47 +40,55 @@\n     public final static String STEP = \"step\";\n \n     private static final Map<Integer, String> CREATED_ACCESSORY_IDS = new ConcurrentHashMap<>();\n-    /**\n-     * The type of HomekitDevice we've decided this was. If the item is question is the member of a group which is a\n-     * HomekitDevice, then this is null.\n-     */\n-    private final Item item;\n+\n+    // proxy item used to group commands for complex item types like Color or Dimmer\n+    private final HomekitOHItemProxy item;", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1NTY5OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433155699", "body": "My comment regarding the naming is also valid here. It would be better to have somthing like \r\n\r\n```\r\nfinal Item item = taggedItem.getItem();\r\n```", "bodyText": "My comment regarding the naming is also valid here. It would be better to have somthing like\nfinal Item item = taggedItem.getItem();", "bodyHTML": "<p dir=\"auto\">My comment regarding the naming is also valid here. It would be better to have somthing like</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"final Item item = taggedItem.getItem();\n\"><pre><code>final Item item = taggedItem.getItem();\n</code></pre></div>", "author": "J-N-K", "createdAt": "2020-06-01T10:24:11Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitCharacteristicFactory.java", "diffHunk": "@@ -379,12 +378,8 @@ private static BrightnessCharacteristic createBrightnessCharacteristic(final Hom\n             return CompletableFuture.completedFuture(value);\n         }, (brightness) -> {\n             final Item oItem = item.getItem();", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1ODMxMw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433158313", "body": "```suggestion\r\n        taggedItem.ifPresent(taggedItem -> { ... });\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (taggedItem.isPresent()) {\n          \n          \n            \n                    taggedItem.ifPresent(taggedItem -> { ... });", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k x x-first\">if</span><span class=\"x x-last\"> (</span>taggedItem<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">isPresent()) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        taggedItem<span class=\"pl-k\">.</span><span class=\"x x-first\">ifPresent(taggedItem </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x\"> { </span><span class=\"pl-c1 x\">...</span><span class=\"x x-last\"> });</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "J-N-K", "createdAt": "2020-06-01T10:30:22Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/accessories/HomekitLightbulbImpl.java", "diffHunk": "@@ -49,11 +52,17 @@ public HomekitLightbulbImpl(HomekitTaggedItem taggedItem, List<HomekitTaggedItem\n \n     @Override\n     public CompletableFuture<Void> setLightbulbPowerState(boolean value) {\n-        GenericItem item = getItem(HomekitCharacteristicType.ON_STATE, GenericItem.class);\n-        if (item instanceof SwitchItem) {\n-            ((SwitchItem) item).send(OnOffType.from(value));\n-        } else if (item instanceof GroupItem) {\n-            ((GroupItem) item).send(OnOffType.from(value));\n+        final Optional<HomekitTaggedItem> taggedItem = getCharacteristic(HomekitCharacteristicType.ON_STATE);\n+        if (taggedItem.isPresent()) {", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1OTM4Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433159383", "body": "```suggestion\r\n        // if timer is not already set, create a new one to ensure that the command command is send even if no follow up\r\n        // commands are received.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // it timer is not there create one. this will ensure that we will send command out even if no follow up\n          \n          \n            \n                    // commands were received.\n          \n          \n            \n                    // if timer is not already set, create a new one to ensure that the command command is send even if no follow up\n          \n          \n            \n                    // commands are received.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">it</span> timer is not <span class=\"x x-first x-last\">there </span>create <span class=\"x x-first x-last\">one. this will </span>ensure that <span class=\"x x-first x-last\">we will send </span>command <span class=\"x x-first x-last\">out</span> even if no follow up</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> commands <span class=\"x x-first x-last\">were</span> received.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">if</span> timer is not <span class=\"x x-first x-last\">already set, </span>create <span class=\"x x-first x-last\">a new one to </span>ensure that <span class=\"x x-first x-last\">the command </span>command <span class=\"x x-first x-last\">is send</span> even if no follow up</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> commands <span class=\"x x-first x-last\">are</span> received.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "J-N-K", "createdAt": "2020-06-01T10:32:56Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    // delay, how long wait for further commands.\n+    // TODO: make it configurable ?\n+    private final int DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    @Nullable\n+    private ConcurrentHashMap<String, State> commandCache;\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    private void sendCommand() {\n+        if (item instanceof ColorItem) {\n+            final State currentState = item.getState() instanceof UnDefType ? HSBType.BLACK : item.getState();\n+            final State hue = commandCache.containsKey(HUE_COMMAND) ? commandCache.remove(HUE_COMMAND)\n+                    : ((HSBType) currentState).getHue();\n+            final State saturation = commandCache.containsKey(SATURATION_COMMAND)\n+                    ? commandCache.remove(SATURATION_COMMAND)\n+                    : ((HSBType) currentState).getSaturation();\n+            final State brightness = commandCache.containsKey(BRIGHTNESS_COMMAND)\n+                    ? commandCache.remove(BRIGHTNESS_COMMAND)\n+                    : ((HSBType) currentState).getBrightness();\n+            ((ColorItem) item).send(new HSBType((DecimalType) hue, (PercentType) saturation, (PercentType) brightness));\n+            logger.trace(\"send HSB command for item {} with following values h {} s{} b{}\", item, hue, saturation,\n+                    brightness);\n+        } else if (item instanceof DimmerItem) { // not ColorItem but DimmerItem\n+            final State on = commandCache.remove(ON_COMMAND);\n+            final State brightness = commandCache.remove(BRIGHTNESS_COMMAND);\n+\n+            // if \"ON\" command received we dont need to send brightness.\n+            // TODO: make brightness suppression on \"On\" configurable.\n+            if (on != null) {\n+                logger.trace(\"send OnOff command for item {} with value {}\", item, on);\n+                ((DimmerItem) item).send((OnOffType) on);\n+            } else {\n+                if (brightness != null) {\n+                    logger.trace(\"send brightness command for item {} with value {}\", item, brightness);\n+                    ((DimmerItem) item).send((PercentType) brightness);\n+                }\n+            }\n+        }\n+    }\n+\n+    public synchronized void sendCommandProxy(final String commandType, final State state) {\n+        if (commandCache == null) {\n+            // we dont need commandCache for all item types, therefore late instantiation here only for item we use\n+            // commandProxy\n+            commandCache = new ConcurrentHashMap<>();\n+        }\n+        commandCache.put(commandType, state);\n+\n+        logger.trace(\"add command to command cache: item {}, command type {}, command state {}. cache state after: {}\",\n+                this, commandType, state, commandCache);\n+\n+        // if cache has already HUE+SATURATION or BRIGTHNESS+ON then we dont expect any further relevant command\n+        // send the command immediately\n+        if ((commandCache.containsKey(HUE_COMMAND) && commandCache.containsKey(SATURATION_COMMAND))\n+                || (commandCache.containsKey(BRIGHTNESS_COMMAND) && commandCache.containsKey(ON_COMMAND))) {\n+            if (future != null)\n+                future.cancel(true);\n+            sendCommand();\n+            return;\n+        }\n+\n+        // it timer is not there create one. this will ensure that we will send command out even if no follow up\n+        // commands were received.", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE1OTUxMA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433159510", "body": "```suggestion\r\n        // if cache has already HUE+SATURATION or BRIGHTNESS+ON then we don't expect any further relevant command\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // if cache has already HUE+SATURATION or BRIGTHNESS+ON then we dont expect any further relevant command\n          \n          \n            \n                    // if cache has already HUE+SATURATION or BRIGHTNESS+ON then we don't expect any further relevant command", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> if cache has already HUE+SATURATION or <span class=\"x x-first x-last\">BRIGTHNESS</span>+ON then we <span class=\"x x-first x-last\">dont</span> expect any further relevant command</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> if cache has already HUE+SATURATION or <span class=\"x x-first x-last\">BRIGHTNESS</span>+ON then we <span class=\"x x-first x-last\">don't</span> expect any further relevant command</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "J-N-K", "createdAt": "2020-06-01T10:33:14Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    // delay, how long wait for further commands.\n+    // TODO: make it configurable ?\n+    private final int DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    @Nullable\n+    private ConcurrentHashMap<String, State> commandCache;\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    private void sendCommand() {\n+        if (item instanceof ColorItem) {\n+            final State currentState = item.getState() instanceof UnDefType ? HSBType.BLACK : item.getState();\n+            final State hue = commandCache.containsKey(HUE_COMMAND) ? commandCache.remove(HUE_COMMAND)\n+                    : ((HSBType) currentState).getHue();\n+            final State saturation = commandCache.containsKey(SATURATION_COMMAND)\n+                    ? commandCache.remove(SATURATION_COMMAND)\n+                    : ((HSBType) currentState).getSaturation();\n+            final State brightness = commandCache.containsKey(BRIGHTNESS_COMMAND)\n+                    ? commandCache.remove(BRIGHTNESS_COMMAND)\n+                    : ((HSBType) currentState).getBrightness();\n+            ((ColorItem) item).send(new HSBType((DecimalType) hue, (PercentType) saturation, (PercentType) brightness));\n+            logger.trace(\"send HSB command for item {} with following values h {} s{} b{}\", item, hue, saturation,\n+                    brightness);\n+        } else if (item instanceof DimmerItem) { // not ColorItem but DimmerItem\n+            final State on = commandCache.remove(ON_COMMAND);\n+            final State brightness = commandCache.remove(BRIGHTNESS_COMMAND);\n+\n+            // if \"ON\" command received we dont need to send brightness.\n+            // TODO: make brightness suppression on \"On\" configurable.\n+            if (on != null) {\n+                logger.trace(\"send OnOff command for item {} with value {}\", item, on);\n+                ((DimmerItem) item).send((OnOffType) on);\n+            } else {\n+                if (brightness != null) {\n+                    logger.trace(\"send brightness command for item {} with value {}\", item, brightness);\n+                    ((DimmerItem) item).send((PercentType) brightness);\n+                }\n+            }\n+        }\n+    }\n+\n+    public synchronized void sendCommandProxy(final String commandType, final State state) {\n+        if (commandCache == null) {\n+            // we dont need commandCache for all item types, therefore late instantiation here only for item we use\n+            // commandProxy\n+            commandCache = new ConcurrentHashMap<>();\n+        }\n+        commandCache.put(commandType, state);\n+\n+        logger.trace(\"add command to command cache: item {}, command type {}, command state {}. cache state after: {}\",\n+                this, commandType, state, commandCache);\n+\n+        // if cache has already HUE+SATURATION or BRIGTHNESS+ON then we dont expect any further relevant command", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2MDU1Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433160557", "body": "For null safety I would prefer to instantiate on object creation I don't think we'll have so many items that an empty HashMap creates a significant burden on the whole system ", "bodyText": "For null safety I would prefer to instantiate on object creation I don't think we'll have so many items that an empty HashMap creates a significant burden on the whole system", "bodyHTML": "<p dir=\"auto\">For null safety I would prefer to instantiate on object creation I don't think we'll have so many items that an empty HashMap creates a significant burden on the whole system</p>", "author": "J-N-K", "createdAt": "2020-06-01T10:35:50Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    // delay, how long wait for further commands.\n+    // TODO: make it configurable ?\n+    private final int DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    @Nullable\n+    private ConcurrentHashMap<String, State> commandCache;\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    private void sendCommand() {\n+        if (item instanceof ColorItem) {\n+            final State currentState = item.getState() instanceof UnDefType ? HSBType.BLACK : item.getState();\n+            final State hue = commandCache.containsKey(HUE_COMMAND) ? commandCache.remove(HUE_COMMAND)\n+                    : ((HSBType) currentState).getHue();\n+            final State saturation = commandCache.containsKey(SATURATION_COMMAND)\n+                    ? commandCache.remove(SATURATION_COMMAND)\n+                    : ((HSBType) currentState).getSaturation();\n+            final State brightness = commandCache.containsKey(BRIGHTNESS_COMMAND)\n+                    ? commandCache.remove(BRIGHTNESS_COMMAND)\n+                    : ((HSBType) currentState).getBrightness();\n+            ((ColorItem) item).send(new HSBType((DecimalType) hue, (PercentType) saturation, (PercentType) brightness));\n+            logger.trace(\"send HSB command for item {} with following values h {} s{} b{}\", item, hue, saturation,\n+                    brightness);\n+        } else if (item instanceof DimmerItem) { // not ColorItem but DimmerItem\n+            final State on = commandCache.remove(ON_COMMAND);\n+            final State brightness = commandCache.remove(BRIGHTNESS_COMMAND);\n+\n+            // if \"ON\" command received we dont need to send brightness.\n+            // TODO: make brightness suppression on \"On\" configurable.\n+            if (on != null) {\n+                logger.trace(\"send OnOff command for item {} with value {}\", item, on);\n+                ((DimmerItem) item).send((OnOffType) on);\n+            } else {\n+                if (brightness != null) {\n+                    logger.trace(\"send brightness command for item {} with value {}\", item, brightness);\n+                    ((DimmerItem) item).send((PercentType) brightness);\n+                }\n+            }\n+        }\n+    }\n+\n+    public synchronized void sendCommandProxy(final String commandType, final State state) {\n+        if (commandCache == null) {", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwNzY3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433207670", "bodyText": "my reasoning was -  i have around 80 items and 0 dimmer and 0 hue devices, so, it will create 80 empty hashMap without having usage for it.\nhm.. but actually, on other side, it will also create 80 HomekitOHItemProxy without real need for it.\nso, if we go for optimisation to probably at much earlier point - dont create HomekitOHItemProxy in first place which makes the logic even more complex.", "author": "yfre", "createdAt": "2020-06-01T12:34:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2MDU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2MTcwOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433161709", "body": "```suggestion\r\n            final State hue = commandCache.getOrDefault(HUE_COMMAND, ((HSBType) currentState).getHue());\r\n```\r\n\r\nand clear the total cache at the end of the method.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        final State hue = commandCache.containsKey(HUE_COMMAND) ? commandCache.remove(HUE_COMMAND)\n          \n          \n            \n                                : ((HSBType) currentState).getHue();\n          \n          \n            \n                        final State hue = commandCache.getOrDefault(HUE_COMMAND, ((HSBType) currentState).getHue());\n          \n      \n    \n    \n  \n\nand clear the total cache at the end of the method.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">final</span> <span class=\"pl-smi\">State</span> hue <span class=\"pl-k\">=</span> commandCache<span class=\"pl-k\">.</span>containsKey(<span class=\"pl-c1\">HUE_COMMAND</span>) <span class=\"pl-k\">?</span> commandCache<span class=\"pl-k\">.</span>remove(<span class=\"pl-c1\">HUE_COMMAND</span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">:</span> ((<span class=\"pl-smi\">HSBType</span>) currentState)<span class=\"pl-k\">.</span>getHue();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">final</span> <span class=\"pl-smi\">State</span> hue <span class=\"pl-k\">=</span> commandCache<span class=\"pl-k\">.</span>getOrDefault(<span class=\"pl-c1\">HUE_COMMAND</span>, ((<span class=\"pl-smi\">HSBType</span>) currentState)<span class=\"pl-k\">.</span>getHue());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">and clear the total cache at the end of the method.</p>", "author": "J-N-K", "createdAt": "2020-06-01T10:38:47Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    // delay, how long wait for further commands.\n+    // TODO: make it configurable ?\n+    private final int DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    @Nullable\n+    private ConcurrentHashMap<String, State> commandCache;\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    private void sendCommand() {\n+        if (item instanceof ColorItem) {\n+            final State currentState = item.getState() instanceof UnDefType ? HSBType.BLACK : item.getState();\n+            final State hue = commandCache.containsKey(HUE_COMMAND) ? commandCache.remove(HUE_COMMAND)\n+                    : ((HSBType) currentState).getHue();", "originalCommit": "c3ad86b3c376938b1d6de1ed3d2a5f30f6920737", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwOTY1Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433209653", "bodyText": "yes, probably better readable.", "author": "yfre", "createdAt": "2020-06-01T12:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE2MTcwOQ=="}], "type": "inlineReview"}, {"oid": "a0c277960f95693c79905bfa08cb4b87b6e10525", "url": "https://github.com/openhab/openhab-addons/commit/a0c277960f95693c79905bfa08cb4b87b6e10525", "message": "incorporate J-N-K feedback, adapt the logic for dimmer\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-06-01T17:50:35Z", "type": "commit"}, {"oid": "b75818f339adf072f01b01f7afecc9970d76c31c", "url": "https://github.com/openhab/openhab-addons/commit/b75818f339adf072f01b01f7afecc9970d76c31c", "message": "add yfre to CODEOWNERS\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-06-01T17:53:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwODEwNg==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433408106", "body": "```suggestion\r\n    public static final int DIMMER_MODE_NORMAL = 0;\r\n```\r\n\r\nI would suggest an enum for the mode: NORMAL, SUPPRESS_ON, SUPPRESS_BRIGHTNESS, SMART with explantation as comments", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final int DIMMER_MODE_NONE = 0;\n          \n          \n            \n                public static final int DIMMER_MODE_NORMAL = 0;\n          \n      \n    \n    \n  \n\nI would suggest an enum for the mode: NORMAL, SUPPRESS_ON, SUPPRESS_BRIGHTNESS, SMART with explantation as comments", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> <span class=\"pl-c1 x x-first x-last\">DIMMER_MODE_NONE</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> <span class=\"pl-c1 x x-first x-last\">DIMMER_MODE_NORMAL</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I would suggest an enum for the mode: NORMAL, SUPPRESS_ON, SUPPRESS_BRIGHTNESS, SMART with explantation as comments</p>", "author": "J-N-K", "createdAt": "2020-06-01T18:21:53Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -48,18 +47,24 @@\n     public static final String BRIGHTNESS_COMMAND = \"brightness\";\n     public static final String ON_COMMAND = \"on\";\n \n-    // delay, how long wait for further commands.\n-    // TODO: make it configurable ?\n-    private final int DELAY = 50;\n+    public static final int DIMMER_MODE_NONE = 0;", "originalCommit": "a0c277960f95693c79905bfa08cb4b87b6e10525", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NTUxOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433485519", "bodyText": "good idea. done", "author": "yfre", "createdAt": "2020-06-01T20:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwODEwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ5MTU4OA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433491588", "bodyText": "you could also do this for the command types above", "author": "J-N-K", "createdAt": "2020-06-01T21:09:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwODEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMjE2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433412165", "body": "```suggestion\r\n            if (dimmerModeConfig instanceof String) {\r\n                setDimmerMode(DimmerMode.valueOf((String) dimmerModeConfig);\r\n            }\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (dimmerModeConfig instanceof String) {\n          \n          \n            \n                        if (dimmerModeConfig instanceof String) {\n          \n          \n            \n                            setDimmerMode(DimmerMode.valueOf((String) dimmerModeConfig);\n          \n          \n            \n                        }", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"185\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (dimmerModeConfig <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">String</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"185\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (dimmerModeConfig <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">String</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"186\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                setDimmerMode(<span class=\"pl-smi\">DimmerMode</span><span class=\"pl-k\">.</span>valueOf((<span class=\"pl-smi\">String</span>) dimmerModeConfig);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"187\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "J-N-K", "createdAt": "2020-06-01T18:29:37Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitTaggedItem.java", "diffHunk": "@@ -176,6 +180,28 @@ public boolean isMemberOfAccessoryGroup() {\n         return parentGroupItem != null;\n     }\n \n+    private void parseConfiguration() {\n+        if (configuration != null) {\n+            Object dimmerModeConfig = configuration.get(DIMMER_MODE);\n+            if (dimmerModeConfig instanceof String) {", "originalCommit": "a0c277960f95693c79905bfa08cb4b87b6e10525", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5ODI5NA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433398294", "body": "Please add `@NonNullByDefault`", "bodyText": "Please add @NonNullByDefault", "bodyHTML": "<p dir=\"auto\">Please add <code>@NonNullByDefault</code></p>", "author": "cpmeister", "createdAt": "2020-06-01T18:02:46Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5ODQxNw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433398417", "body": "```suggestion\r\n    private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n          \n          \n            \n                private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">static</span><span class=\"x x-last\"> </span><span class=\"pl-k\">final</span> <span class=\"pl-smi\">Logger</span> logger <span class=\"pl-k\">=</span> <span class=\"pl-smi\">LoggerFactory</span><span class=\"pl-k\">.</span>getLogger(<span class=\"pl-smi\">HomekitOHItemProxy</span><span class=\"pl-k\">.</span>class);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">Logger</span> logger <span class=\"pl-k\">=</span> <span class=\"pl-smi\">LoggerFactory</span><span class=\"pl-k\">.</span>getLogger(<span class=\"pl-smi\">HomekitOHItemProxy</span><span class=\"pl-k\">.</span>class);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-06-01T18:02:58Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1NTQyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433455429", "bodyText": "thanks. for some reasons i used to have loggers static and im typing \"static\" automatically.\ni will fix that one.", "author": "yfre", "createdAt": "2020-06-01T19:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5ODQxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5ODcwNA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433398704", "body": "```suggestion\r\n    private Map<String, State> commandCache = new ConcurrentHashMap<>();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private ConcurrentHashMap<String, State> commandCache = new ConcurrentHashMap<>();\n          \n          \n            \n                private Map<String, State> commandCache = new ConcurrentHashMap<>();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">ConcurrentHashMap</span>&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">State</span>&gt;</span> commandCache <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ConcurrentHashMap&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\"><span class=\"x x-first x-last\">Map</span>&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">State</span>&gt;</span> commandCache <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ConcurrentHashMap&lt;&gt;</span>();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-06-01T18:03:28Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    public static final int DIMMER_MODE_NONE = 0;\n+    public static final int DIMMER_MODE_FILTER_BRIGHTNESS_100 = 1;\n+    public static final int DIMMER_MODE_FILTER_ON = 2;\n+    public static final int DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100 = 3;\n+\n+    private static final int DEFAULT_DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    private int dimmerMode = DIMMER_MODE_NONE;\n+\n+    // delay, how long wait for further commands. in ms.\n+    private int delay = DEFAULT_DELAY;\n+    private ConcurrentHashMap<String, State> commandCache = new ConcurrentHashMap<>();", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5OTcxMg==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433399712", "body": "all if statements should have brackets", "bodyText": "all if statements should have brackets", "bodyHTML": "<p dir=\"auto\">all if statements should have brackets</p>", "author": "cpmeister", "createdAt": "2020-06-01T18:05:32Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    public static final int DIMMER_MODE_NONE = 0;\n+    public static final int DIMMER_MODE_FILTER_BRIGHTNESS_100 = 1;\n+    public static final int DIMMER_MODE_FILTER_ON = 2;\n+    public static final int DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100 = 3;\n+\n+    private static final int DEFAULT_DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    private int dimmerMode = DIMMER_MODE_NONE;\n+\n+    // delay, how long wait for further commands. in ms.\n+    private int delay = DEFAULT_DELAY;\n+    private ConcurrentHashMap<String, State> commandCache = new ConcurrentHashMap<>();\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    public void setDimmerMode(int mode) {\n+        dimmerMode = mode;\n+    }\n+\n+    public void setDelay(int delay) {\n+        this.delay = delay;\n+    }\n+\n+    private void sendCommand() {\n+        final OnOffType on = (OnOffType) commandCache.remove(ON_COMMAND);\n+        final PercentType brightness = (PercentType) commandCache.remove(BRIGHTNESS_COMMAND);\n+        final DecimalType hue = (DecimalType) commandCache.remove(HUE_COMMAND);\n+        final PercentType saturation = (PercentType) commandCache.remove(SATURATION_COMMAND);\n+\n+        if (on != null) {\n+            // always sends OFF.\n+            // sends ON only if\n+            // - DIMMER_MODE_NONE is enabled OR\n+            // - DIMMER_MODE_FILTER_BRIGHTNESS_100 is enabled OR\n+            // - DIMMER_MODE_FILTER_ON_EXCEPT100 is not enabled and brightness is null or below 100\n+            if ((on == OnOffType.OFF) || (dimmerMode == DIMMER_MODE_NONE)\n+                    || (dimmerMode == DIMMER_MODE_FILTER_BRIGHTNESS_100)\n+                    || ((dimmerMode == DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100)\n+                            && ((brightness == null) || (brightness.intValue() == 100)))) {\n+                logger.trace(\"send OnOff command for item {} with value {}\", item, on);\n+                ((DimmerItem) item).send(on);\n+            }\n+        }\n+\n+        // if hue or saturation present, send an HSBType state update. no filter applied for HUE & Saturation\n+        if ((hue != null) || (saturation != null)) {\n+            if (item instanceof ColorItem) {\n+                // logic for ColorItem = combine hue, saturation and brightness update to one command\n+                final HSBType currentState = item.getState() instanceof UnDefType ? HSBType.BLACK\n+                        : (HSBType) item.getState();\n+                ((ColorItem) item).send(new HSBType(hue != null ? hue : currentState.getHue(),\n+                        saturation != null ? saturation : currentState.getSaturation(),\n+                        brightness != null ? brightness : currentState.getBrightness()));\n+                logger.trace(\"send HSB command for item {} with following values hue={} saturation={} brightness={}\",\n+                        item, hue, saturation, brightness);\n+            }\n+        } else if ((brightness != null) && (item instanceof DimmerItem)) {\n+            // sends brightness:\n+            // - DIMMER_MODE_NONE\n+            // - DIMMER_MODE_FILTER_ON\n+            // - other modes (DIMMER_MODE_FILTER_BRIGHTNESS_100 or DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100) and\n+            // <100%.\n+            if ((dimmerMode == DIMMER_MODE_NONE) || (dimmerMode == DIMMER_MODE_FILTER_ON)\n+                    || (brightness.intValue() < 100)) {\n+                logger.trace(\"send brightness command for item {} with value {}\", item, brightness);\n+                ((DimmerItem) item).send(brightness);\n+            }\n+        }\n+        commandCache.clear();\n+    }\n+\n+    public synchronized void sendCommandProxy(final String commandType, final State state) {\n+        commandCache.put(commandType, state);\n+        logger.trace(\"add command to command cache: item {}, command type {}, command state {}. cache state after: {}\",\n+                this, commandType, state, commandCache);\n+\n+        // if cache has already HUE+SATURATION or BRIGHTNESS+ON then we don't expect any further relevant command\n+        if ((commandCache.containsKey(HUE_COMMAND) && commandCache.containsKey(SATURATION_COMMAND))\n+                || (commandCache.containsKey(BRIGHTNESS_COMMAND) && commandCache.containsKey(ON_COMMAND))) {\n+            if (future != null)", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwMDkzMA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433400930", "body": "This doesn't look like a safe cast", "bodyText": "This doesn't look like a safe cast", "bodyHTML": "<p dir=\"auto\">This doesn't look like a safe cast</p>", "author": "cpmeister", "createdAt": "2020-06-01T18:07:48Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    public static final int DIMMER_MODE_NONE = 0;\n+    public static final int DIMMER_MODE_FILTER_BRIGHTNESS_100 = 1;\n+    public static final int DIMMER_MODE_FILTER_ON = 2;\n+    public static final int DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100 = 3;\n+\n+    private static final int DEFAULT_DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    private int dimmerMode = DIMMER_MODE_NONE;\n+\n+    // delay, how long wait for further commands. in ms.\n+    private int delay = DEFAULT_DELAY;\n+    private ConcurrentHashMap<String, State> commandCache = new ConcurrentHashMap<>();\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    public void setDimmerMode(int mode) {\n+        dimmerMode = mode;\n+    }\n+\n+    public void setDelay(int delay) {\n+        this.delay = delay;\n+    }\n+\n+    private void sendCommand() {\n+        final OnOffType on = (OnOffType) commandCache.remove(ON_COMMAND);\n+        final PercentType brightness = (PercentType) commandCache.remove(BRIGHTNESS_COMMAND);\n+        final DecimalType hue = (DecimalType) commandCache.remove(HUE_COMMAND);\n+        final PercentType saturation = (PercentType) commandCache.remove(SATURATION_COMMAND);\n+\n+        if (on != null) {\n+            // always sends OFF.\n+            // sends ON only if\n+            // - DIMMER_MODE_NONE is enabled OR\n+            // - DIMMER_MODE_FILTER_BRIGHTNESS_100 is enabled OR\n+            // - DIMMER_MODE_FILTER_ON_EXCEPT100 is not enabled and brightness is null or below 100\n+            if ((on == OnOffType.OFF) || (dimmerMode == DIMMER_MODE_NONE)\n+                    || (dimmerMode == DIMMER_MODE_FILTER_BRIGHTNESS_100)\n+                    || ((dimmerMode == DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100)\n+                            && ((brightness == null) || (brightness.intValue() == 100)))) {\n+                logger.trace(\"send OnOff command for item {} with value {}\", item, on);\n+                ((DimmerItem) item).send(on);", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNDE1NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433404155", "body": "You should adjust this logic to take into account that DimmerItem only cares about the BRIGHTNESS_COMMAND and ON_COMMAND and a ColorItem only cares about the HUE_COMMAND and SATURATION_COMMAND.", "bodyText": "You should adjust this logic to take into account that DimmerItem only cares about the BRIGHTNESS_COMMAND and ON_COMMAND and a ColorItem only cares about the HUE_COMMAND and SATURATION_COMMAND.", "bodyHTML": "<p dir=\"auto\">You should adjust this logic to take into account that DimmerItem only cares about the BRIGHTNESS_COMMAND and ON_COMMAND and a ColorItem only cares about the HUE_COMMAND and SATURATION_COMMAND.</p>", "author": "cpmeister", "createdAt": "2020-06-01T18:14:11Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    public static final int DIMMER_MODE_NONE = 0;\n+    public static final int DIMMER_MODE_FILTER_BRIGHTNESS_100 = 1;\n+    public static final int DIMMER_MODE_FILTER_ON = 2;\n+    public static final int DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100 = 3;\n+\n+    private static final int DEFAULT_DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    private int dimmerMode = DIMMER_MODE_NONE;\n+\n+    // delay, how long wait for further commands. in ms.\n+    private int delay = DEFAULT_DELAY;\n+    private ConcurrentHashMap<String, State> commandCache = new ConcurrentHashMap<>();\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    public void setDimmerMode(int mode) {\n+        dimmerMode = mode;\n+    }\n+\n+    public void setDelay(int delay) {\n+        this.delay = delay;\n+    }\n+\n+    private void sendCommand() {\n+        final OnOffType on = (OnOffType) commandCache.remove(ON_COMMAND);\n+        final PercentType brightness = (PercentType) commandCache.remove(BRIGHTNESS_COMMAND);\n+        final DecimalType hue = (DecimalType) commandCache.remove(HUE_COMMAND);\n+        final PercentType saturation = (PercentType) commandCache.remove(SATURATION_COMMAND);\n+\n+        if (on != null) {\n+            // always sends OFF.\n+            // sends ON only if\n+            // - DIMMER_MODE_NONE is enabled OR\n+            // - DIMMER_MODE_FILTER_BRIGHTNESS_100 is enabled OR\n+            // - DIMMER_MODE_FILTER_ON_EXCEPT100 is not enabled and brightness is null or below 100\n+            if ((on == OnOffType.OFF) || (dimmerMode == DIMMER_MODE_NONE)\n+                    || (dimmerMode == DIMMER_MODE_FILTER_BRIGHTNESS_100)\n+                    || ((dimmerMode == DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100)\n+                            && ((brightness == null) || (brightness.intValue() == 100)))) {\n+                logger.trace(\"send OnOff command for item {} with value {}\", item, on);\n+                ((DimmerItem) item).send(on);\n+            }\n+        }\n+\n+        // if hue or saturation present, send an HSBType state update. no filter applied for HUE & Saturation\n+        if ((hue != null) || (saturation != null)) {\n+            if (item instanceof ColorItem) {\n+                // logic for ColorItem = combine hue, saturation and brightness update to one command\n+                final HSBType currentState = item.getState() instanceof UnDefType ? HSBType.BLACK\n+                        : (HSBType) item.getState();\n+                ((ColorItem) item).send(new HSBType(hue != null ? hue : currentState.getHue(),\n+                        saturation != null ? saturation : currentState.getSaturation(),\n+                        brightness != null ? brightness : currentState.getBrightness()));\n+                logger.trace(\"send HSB command for item {} with following values hue={} saturation={} brightness={}\",\n+                        item, hue, saturation, brightness);\n+            }\n+        } else if ((brightness != null) && (item instanceof DimmerItem)) {\n+            // sends brightness:\n+            // - DIMMER_MODE_NONE\n+            // - DIMMER_MODE_FILTER_ON\n+            // - other modes (DIMMER_MODE_FILTER_BRIGHTNESS_100 or DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100) and\n+            // <100%.\n+            if ((dimmerMode == DIMMER_MODE_NONE) || (dimmerMode == DIMMER_MODE_FILTER_ON)\n+                    || (brightness.intValue() < 100)) {\n+                logger.trace(\"send brightness command for item {} with value {}\", item, brightness);\n+                ((DimmerItem) item).send(brightness);\n+            }\n+        }\n+        commandCache.clear();\n+    }\n+\n+    public synchronized void sendCommandProxy(final String commandType, final State state) {\n+        commandCache.put(commandType, state);\n+        logger.trace(\"add command to command cache: item {}, command type {}, command state {}. cache state after: {}\",\n+                this, commandType, state, commandCache);\n+\n+        // if cache has already HUE+SATURATION or BRIGHTNESS+ON then we don't expect any further relevant command\n+        if ((commandCache.containsKey(HUE_COMMAND) && commandCache.containsKey(SATURATION_COMMAND))\n+                || (commandCache.containsKey(BRIGHTNESS_COMMAND) && commandCache.containsKey(ON_COMMAND))) {", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1Nzk3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433457970", "bodyText": "ColorItem can handle \"On\" and \"Brightness\" as well as it extends the DimmerItem. so, probably i only need to exclude the combination \"DimmerItem + hue or/and saturation\"", "author": "yfre", "createdAt": "2020-06-01T20:00:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNDE1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1OTU2Mw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433459563", "bodyText": "Ah, you are right about the ColorItem extending DimmerItem.", "author": "cpmeister", "createdAt": "2020-06-01T20:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNDE1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNTEwMg==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433405102", "body": "Might as well cast a wider net on what the config could return.\r\n```suggestion\r\n            if (delayConfig instanceof Number) {\r\n                proxyItem.setDelay(((Number) delayConfig).intValue());\r\n            }\r\n```", "bodyText": "Might as well cast a wider net on what the config could return.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (delayConfig instanceof BigDecimal) {\n          \n          \n            \n                            proxyItem.setDelay(((BigDecimal) delayConfig).intValue());\n          \n          \n            \n                        }\n          \n          \n            \n                        if (delayConfig instanceof Number) {\n          \n          \n            \n                            proxyItem.setDelay(((Number) delayConfig).intValue());\n          \n          \n            \n                        }", "bodyHTML": "<p dir=\"auto\">Might as well cast a wider net on what the config could return.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"191\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (delayConfig <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi x x-first x-last\">BigDecimal</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"192\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                proxyItem<span class=\"pl-k\">.</span>setDelay(((<span class=\"pl-smi x x-first x-last\">BigDecimal</span>) delayConfig)<span class=\"pl-k\">.</span>intValue());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"193\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"191\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (delayConfig <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi x x-first x-last\">Number</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"192\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                proxyItem<span class=\"pl-k\">.</span>setDelay(((<span class=\"pl-smi x x-first x-last\">Number</span>) delayConfig)<span class=\"pl-k\">.</span>intValue());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"193\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-06-01T18:16:05Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitTaggedItem.java", "diffHunk": "@@ -141,6 +180,28 @@ public boolean isMemberOfAccessoryGroup() {\n         return parentGroupItem != null;\n     }\n \n+    private void parseConfiguration() {\n+        if (configuration != null) {\n+            Object dimmerModeConfig = configuration.get(DIMMER_MODE);\n+            if (dimmerModeConfig instanceof String) {\n+                final String dimmerModeConfigStr = (String) dimmerModeConfig;\n+                if (dimmerModeConfigStr.equalsIgnoreCase(\"none\")) {\n+                    proxyItem.setDimmerMode(HomekitOHItemProxy.DIMMER_MODE_NONE);\n+                } else if (dimmerModeConfigStr.equalsIgnoreCase(\"filterOn\")) {\n+                    proxyItem.setDimmerMode(HomekitOHItemProxy.DIMMER_MODE_FILTER_ON);\n+                } else if (dimmerModeConfigStr.equalsIgnoreCase(\"filterBrightness100\")) {\n+                    proxyItem.setDimmerMode(HomekitOHItemProxy.DIMMER_MODE_FILTER_BRIGHTNESS_100);\n+                } else if (dimmerModeConfigStr.equalsIgnoreCase(\"filterOnExceptBrightness100\")) {\n+                    proxyItem.setDimmerMode(HomekitOHItemProxy.DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100);\n+                }\n+            }\n+            Object delayConfig = configuration.get(DELAY);\n+            if (delayConfig instanceof BigDecimal) {\n+                proxyItem.setDelay(((BigDecimal) delayConfig).intValue());\n+            }", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNjQ2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433406465", "body": "I'm not sure how much good cancelling with interrupt would do here, might cause more problems than if you just let the future complete if it was already running.\r\n```suggestion\r\n                future.cancel(false);\r\n```", "bodyText": "I'm not sure how much good cancelling with interrupt would do here, might cause more problems than if you just let the future complete if it was already running.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            future.cancel(true);\n          \n          \n            \n                            future.cancel(false);", "bodyHTML": "<p dir=\"auto\">I'm not sure how much good cancelling with interrupt would do here, might cause more problems than if you just let the future complete if it was already running.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                future<span class=\"pl-k\">.</span>cancel(<span class=\"pl-c1 x x-first x-last\">true</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                future<span class=\"pl-k\">.</span>cancel(<span class=\"pl-c1 x x-first x-last\">false</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-06-01T18:18:41Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter Initial contribution\n+ *\n+ */\n+\n+public class HomekitOHItemProxy {\n+    private static final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+    public static final String HUE_COMMAND = \"hue\";\n+    public static final String SATURATION_COMMAND = \"saturation\";\n+    public static final String BRIGHTNESS_COMMAND = \"brightness\";\n+    public static final String ON_COMMAND = \"on\";\n+\n+    public static final int DIMMER_MODE_NONE = 0;\n+    public static final int DIMMER_MODE_FILTER_BRIGHTNESS_100 = 1;\n+    public static final int DIMMER_MODE_FILTER_ON = 2;\n+    public static final int DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100 = 3;\n+\n+    private static final int DEFAULT_DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    private int dimmerMode = DIMMER_MODE_NONE;\n+\n+    // delay, how long wait for further commands. in ms.\n+    private int delay = DEFAULT_DELAY;\n+    private ConcurrentHashMap<String, State> commandCache = new ConcurrentHashMap<>();\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    public void setDimmerMode(int mode) {\n+        dimmerMode = mode;\n+    }\n+\n+    public void setDelay(int delay) {\n+        this.delay = delay;\n+    }\n+\n+    private void sendCommand() {\n+        final OnOffType on = (OnOffType) commandCache.remove(ON_COMMAND);\n+        final PercentType brightness = (PercentType) commandCache.remove(BRIGHTNESS_COMMAND);\n+        final DecimalType hue = (DecimalType) commandCache.remove(HUE_COMMAND);\n+        final PercentType saturation = (PercentType) commandCache.remove(SATURATION_COMMAND);\n+\n+        if (on != null) {\n+            // always sends OFF.\n+            // sends ON only if\n+            // - DIMMER_MODE_NONE is enabled OR\n+            // - DIMMER_MODE_FILTER_BRIGHTNESS_100 is enabled OR\n+            // - DIMMER_MODE_FILTER_ON_EXCEPT100 is not enabled and brightness is null or below 100\n+            if ((on == OnOffType.OFF) || (dimmerMode == DIMMER_MODE_NONE)\n+                    || (dimmerMode == DIMMER_MODE_FILTER_BRIGHTNESS_100)\n+                    || ((dimmerMode == DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100)\n+                            && ((brightness == null) || (brightness.intValue() == 100)))) {\n+                logger.trace(\"send OnOff command for item {} with value {}\", item, on);\n+                ((DimmerItem) item).send(on);\n+            }\n+        }\n+\n+        // if hue or saturation present, send an HSBType state update. no filter applied for HUE & Saturation\n+        if ((hue != null) || (saturation != null)) {\n+            if (item instanceof ColorItem) {\n+                // logic for ColorItem = combine hue, saturation and brightness update to one command\n+                final HSBType currentState = item.getState() instanceof UnDefType ? HSBType.BLACK\n+                        : (HSBType) item.getState();\n+                ((ColorItem) item).send(new HSBType(hue != null ? hue : currentState.getHue(),\n+                        saturation != null ? saturation : currentState.getSaturation(),\n+                        brightness != null ? brightness : currentState.getBrightness()));\n+                logger.trace(\"send HSB command for item {} with following values hue={} saturation={} brightness={}\",\n+                        item, hue, saturation, brightness);\n+            }\n+        } else if ((brightness != null) && (item instanceof DimmerItem)) {\n+            // sends brightness:\n+            // - DIMMER_MODE_NONE\n+            // - DIMMER_MODE_FILTER_ON\n+            // - other modes (DIMMER_MODE_FILTER_BRIGHTNESS_100 or DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100) and\n+            // <100%.\n+            if ((dimmerMode == DIMMER_MODE_NONE) || (dimmerMode == DIMMER_MODE_FILTER_ON)\n+                    || (brightness.intValue() < 100)) {\n+                logger.trace(\"send brightness command for item {} with value {}\", item, brightness);\n+                ((DimmerItem) item).send(brightness);\n+            }\n+        }\n+        commandCache.clear();\n+    }\n+\n+    public synchronized void sendCommandProxy(final String commandType, final State state) {\n+        commandCache.put(commandType, state);\n+        logger.trace(\"add command to command cache: item {}, command type {}, command state {}. cache state after: {}\",\n+                this, commandType, state, commandCache);\n+\n+        // if cache has already HUE+SATURATION or BRIGHTNESS+ON then we don't expect any further relevant command\n+        if ((commandCache.containsKey(HUE_COMMAND) && commandCache.containsKey(SATURATION_COMMAND))\n+                || (commandCache.containsKey(BRIGHTNESS_COMMAND) && commandCache.containsKey(ON_COMMAND))) {\n+            if (future != null)\n+                future.cancel(true);", "originalCommit": "b75818f339adf072f01b01f7afecc9970d76c31c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1NjQyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433456429", "bodyText": "it should make much difference in that case. we would interrupt \"sendCommand\" which we will re-run directly after cancelation. but you are right, false is probably the saver option.", "author": "yfre", "createdAt": "2020-06-01T19:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNjQ2NQ=="}], "type": "inlineReview"}, {"oid": "8fb23d3437b04903ad025452671114f48ee85a9f", "url": "https://github.com/openhab/openhab-addons/commit/8fb23d3437b04903ad025452671114f48ee85a9f", "message": "incorporate feedback\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-06-01T21:41:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxOTM2NQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433519365", "body": "Please add `@NonNullByDefault`", "bodyText": "Please add @NonNullByDefault", "bodyHTML": "<p dir=\"auto\">Please add <code>@NonNullByDefault</code></p>", "author": "cpmeister", "createdAt": "2020-06-01T22:17:08Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitCommandType.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.io.homekit.internal;\n+\n+/**\n+ *\n+ * Different command types supported by HomekitOHItemProxy.\n+ *\n+ * @author Eugen Freiter - Initial contribution\n+ */\n+public enum HomekitCommandType {", "originalCommit": "8fb23d3437b04903ad025452671114f48ee85a9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxOTQwNw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433519407", "body": "Please add `@NonNullByDefault`", "bodyText": "Please add @NonNullByDefault", "bodyHTML": "<p dir=\"auto\">Please add <code>@NonNullByDefault</code></p>", "author": "cpmeister", "createdAt": "2020-06-01T22:17:16Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitDimmerMode.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Dimmer commands are handled differently by different devices.\n+ * Some devices expect only the brightness updates, some other expect brightness as well as \"On/Off\" commands.\n+ * This enum describes different modes of dimmer handling in the context of HomeKit binding.\n+ *\n+ * Following modes are supported:\n+ * DIMMER_MODE_NORMAL - no filtering. The commands will be send to device as received from HomeKit.\n+ * DIMMER_MODE_FILTER_ON - ON events are filtered out. only OFF and brightness information are sent\n+ * DIMMER_MODE_FILTER_BRIGHTNESS_100 - only Brightness=100% is filtered out. everything else unchanged. This allows\n+ * custom logic for soft launch in devices.\n+ * DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100 - ON events are filter out in all cases except of Brightness = 100%.\n+ *\n+ * @author Eugen Freiter - Initial contribution\n+ */\n+public enum HomekitDimmerMode {", "originalCommit": "8fb23d3437b04903ad025452671114f48ee85a9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgzMzg4MA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433833880", "bodyText": "right. forgot that one. fixed", "author": "yfre", "createdAt": "2020-06-02T12:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxOTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyMTA2NA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433521064", "body": "Why not just make the `item` field a `DimmerItem`?", "bodyText": "Why not just make the item field a DimmerItem?", "bodyHTML": "<p dir=\"auto\">Why not just make the <code>item</code> field a <code>DimmerItem</code>?</p>", "author": "cpmeister", "createdAt": "2020-06-01T22:22:20Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import static org.openhab.io.homekit.internal.HomekitCommandType.*;\n+import static org.openhab.io.homekit.internal.HomekitDimmerMode.*;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class HomekitOHItemProxy {\n+    private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+\n+    private static final int DEFAULT_DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+\n+    @Nullable\n+    private ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    private HomekitDimmerMode dimmerMode = DIMMER_MODE_NORMAL;\n+\n+    // delay, how long wait for further commands. in ms.\n+    private int delay = DEFAULT_DELAY;\n+    private Map<HomekitCommandType, State> commandCache = new ConcurrentHashMap<>();\n+\n+    public HomekitOHItemProxy(final Item item) {\n+        this.item = item;\n+    }\n+\n+    public Item getItem() {\n+        return item;\n+    }\n+\n+    public void setDimmerMode(HomekitDimmerMode mode) {\n+        dimmerMode = mode;\n+    }\n+\n+    public void setDelay(int delay) {\n+        this.delay = delay;\n+    }\n+\n+    @SuppressWarnings(\"null\")\n+    private void sendCommand() {\n+\n+        if (!(item instanceof DimmerItem)) {\n+            // currently supports only DimmerItem and ColorItem (which extends DimmerItem)\n+            logger.debug(\"unexpected item type {}. Only DimmerItem and ColorItem are supported.\", item);\n+            return;\n+        }", "originalCommit": "8fb23d3437b04903ad025452671114f48ee85a9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzgzMzY4OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r433833689", "bodyText": "i was just thinking, maybe in the future we will need to add further item types, e.g. groups.", "author": "yfre", "createdAt": "2020-06-02T12:22:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyMTA2NA=="}], "type": "inlineReview"}, {"oid": "6601d623464a3080422f8ed4fb25b3f0435d6329", "url": "https://github.com/openhab/openhab-addons/commit/6601d623464a3080422f8ed4fb25b3f0435d6329", "message": "add NonNullByDefault\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-06-02T12:26:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTQwOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r434001409", "body": "```suggestion\r\n    private static final Map<String, HomekitDimmerMode> TAG_MAP = Arrays.stream(HomekitDimmerMode.values())\r\n            .collect(Collectors.toMap(type -> type.tag.toUpperCase(), type -> type));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Map<String, HomekitDimmerMode> TAG_MAP = new HashMap<>();\n          \n          \n            \n            \n          \n          \n            \n                static {\n          \n          \n            \n                    for (HomekitDimmerMode type : HomekitDimmerMode.values()) {\n          \n          \n            \n                        TAG_MAP.put(type.tag.toUpperCase(), type);\n          \n          \n            \n                    }\n          \n          \n            \n                }\n          \n          \n            \n                private static final Map<String, HomekitDimmerMode> TAG_MAP = Arrays.stream(HomekitDimmerMode.values())\n          \n          \n            \n                        .collect(Collectors.toMap(type -> type.tag.toUpperCase(), type -> type));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">HomekitDimmerMode</span>&gt;</span> <span class=\"pl-c1\">TAG_MAP</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashMap&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">static</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">for</span> (<span class=\"pl-smi\">HomekitDimmerMode</span> type <span class=\"pl-k\">:</span> <span class=\"pl-smi\">HomekitDimmerMode</span><span class=\"pl-k\">.</span>values()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c1\">TAG_MAP</span><span class=\"pl-k\">.</span>put(type<span class=\"pl-k\">.</span>tag<span class=\"pl-k\">.</span>toUpperCase(), type);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">HomekitDimmerMode</span>&gt;</span> <span class=\"pl-c1\">TAG_MAP</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">Arrays</span><span class=\"pl-k\">.</span>stream(<span class=\"pl-smi\">HomekitDimmerMode</span><span class=\"pl-k\">.</span>values())</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            .collect(<span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>toMap(type <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> type<span class=\"pl-k\">.</span>tag<span class=\"pl-k\">.</span>toUpperCase(), type <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> type));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "J-N-K", "createdAt": "2020-06-02T16:10:56Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitDimmerMode.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+package org.openhab.io.homekit.internal;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+\n+/**\n+ * Dimmer commands are handled differently by different devices.\n+ * Some devices expect only the brightness updates, some other expect brightness as well as \"On/Off\" commands.\n+ * This enum describes different modes of dimmer handling in the context of HomeKit binding.\n+ *\n+ * Following modes are supported:\n+ * DIMMER_MODE_NORMAL - no filtering. The commands will be send to device as received from HomeKit.\n+ * DIMMER_MODE_FILTER_ON - ON events are filtered out. only OFF and brightness information are sent\n+ * DIMMER_MODE_FILTER_BRIGHTNESS_100 - only Brightness=100% is filtered out. everything else unchanged. This allows\n+ * custom logic for soft launch in devices.\n+ * DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100 - ON events are filter out in all cases except of Brightness = 100%.\n+ *\n+ * @author Eugen Freiter - Initial contribution\n+ */\n+\n+@NonNullByDefault\n+public enum HomekitDimmerMode {\n+    DIMMER_MODE_NORMAL(\"normal\"),\n+    DIMMER_MODE_FILTER_ON(\"filterOn\"),\n+    DIMMER_MODE_FILTER_BRIGHTNESS_100(\"filterBrightness100\"),\n+    DIMMER_MODE_FILTER_ON_EXCEPT_BRIGHTNESS_100(\"filterOnExceptBrightness100\");\n+\n+    private static final Map<String, HomekitDimmerMode> TAG_MAP = new HashMap<>();\n+\n+    static {\n+        for (HomekitDimmerMode type : HomekitDimmerMode.values()) {\n+            TAG_MAP.put(type.tag.toUpperCase(), type);\n+        }\n+    }", "originalCommit": "6601d623464a3080422f8ed4fb25b3f0435d6329", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAxMjE3MA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r434012170", "bodyText": "cool. one-liner", "author": "yfre", "createdAt": "2020-06-02T16:27:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTQwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMTg5Ng==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r434001896", "body": "```suggestion\r\n    private static final int DEFAULT_DELAY = 50; // in ms\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final int DEFAULT_DELAY = 50;\n          \n          \n            \n                private static final int DEFAULT_DELAY = 50; // in ms", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> <span class=\"pl-c1\">DEFAULT_DELAY</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">50</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">int</span> <span class=\"pl-c1\">DEFAULT_DELAY</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">50</span>;<span class=\"x x-first\"> </span><span class=\"pl-c\"><span class=\"pl-c x\">//</span><span class=\"x x-last\"> in ms</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "J-N-K", "createdAt": "2020-06-02T16:11:41Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import static org.openhab.io.homekit.internal.HomekitCommandType.*;\n+import static org.openhab.io.homekit.internal.HomekitDimmerMode.*;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class HomekitOHItemProxy {\n+    private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+\n+    private static final int DEFAULT_DELAY = 50;", "originalCommit": "6601d623464a3080422f8ed4fb25b3f0435d6329", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDAwMjE2OQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r434002169", "body": "```suggestion\r\n    private @Nullable ScheduledFuture<?> future;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                private ScheduledFuture<?> future;\n          \n          \n            \n                private @Nullable ScheduledFuture<?> future;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@Nullable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">ScheduledFuture&lt;?&gt;</span> future;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">@Nullable</span> <span class=\"pl-k\">ScheduledFuture&lt;?&gt;</span> future;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "J-N-K", "createdAt": "2020-06-02T16:12:06Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import static org.openhab.io.homekit.internal.HomekitCommandType.*;\n+import static org.openhab.io.homekit.internal.HomekitDimmerMode.*;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class HomekitOHItemProxy {\n+    private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+\n+    private static final int DEFAULT_DELAY = 50;\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+\n+    @Nullable\n+    private ScheduledFuture<?> future;", "originalCommit": "6601d623464a3080422f8ed4fb25b3f0435d6329", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0c0b4c66b09c696d2abd18f7e5c4dc8a9733e9b6", "url": "https://github.com/openhab/openhab-addons/commit/0c0b4c66b09c696d2abd18f7e5c4dc8a9733e9b6", "message": "update README and incorporate further review feedback\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-06-02T18:50:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2MDc5NA==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r436160794", "body": "move final fields above non final fields", "bodyText": "move final fields above non final fields", "bodyHTML": "<p dir=\"auto\">move final fields above non final fields</p>", "author": "cpmeister", "createdAt": "2020-06-05T20:57:05Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import static org.openhab.io.homekit.internal.HomekitCommandType.*;\n+import static org.openhab.io.homekit.internal.HomekitDimmerMode.*;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class HomekitOHItemProxy {\n+    private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+\n+    private static final int DEFAULT_DELAY = 50; // in ms\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+\n+\n+    private @Nullable ScheduledFuture<?> future;\n+\n+    private final Item item;", "originalCommit": "0c0b4c66b09c696d2abd18f7e5c4dc8a9733e9b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2MDgyOQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r436160829", "body": "remove blank line", "bodyText": "remove blank line", "bodyHTML": "<p dir=\"auto\">remove blank line</p>", "author": "cpmeister", "createdAt": "2020-06-05T20:57:10Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import static org.openhab.io.homekit.internal.HomekitCommandType.*;\n+import static org.openhab.io.homekit.internal.HomekitDimmerMode.*;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class HomekitOHItemProxy {\n+    private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+\n+    private static final int DEFAULT_DELAY = 50; // in ms\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+\n+", "originalCommit": "0c0b4c66b09c696d2abd18f7e5c4dc8a9733e9b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2MDk2MQ==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r436160961", "body": "```suggestion\r\n    private final Map<HomekitCommandType, State> commandCache = new ConcurrentHashMap<>();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Map<HomekitCommandType, State> commandCache = new ConcurrentHashMap<>();\n          \n          \n            \n                private final Map<HomekitCommandType, State> commandCache = new ConcurrentHashMap<>();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">HomekitCommandType</span>, <span class=\"pl-smi\">State</span>&gt;</span> commandCache <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ConcurrentHashMap&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">HomekitCommandType</span>, <span class=\"pl-smi\">State</span>&gt;</span> commandCache <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ConcurrentHashMap&lt;&gt;</span>();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cpmeister", "createdAt": "2020-06-05T20:57:29Z", "path": "bundles/org.openhab.io.homekit/src/main/java/org/openhab/io/homekit/internal/HomekitOHItemProxy.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/**\n+ * Copyright (c) 2010-2020 Contributors to the openHAB project\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ */\n+\n+package org.openhab.io.homekit.internal;\n+\n+import static org.openhab.io.homekit.internal.HomekitCommandType.*;\n+import static org.openhab.io.homekit.internal.HomekitDimmerMode.*;\n+\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.jdt.annotation.NonNullByDefault;\n+import org.eclipse.jdt.annotation.Nullable;\n+import org.eclipse.smarthome.core.common.ThreadPoolManager;\n+import org.eclipse.smarthome.core.items.Item;\n+import org.eclipse.smarthome.core.library.items.ColorItem;\n+import org.eclipse.smarthome.core.library.items.DimmerItem;\n+import org.eclipse.smarthome.core.library.types.DecimalType;\n+import org.eclipse.smarthome.core.library.types.HSBType;\n+import org.eclipse.smarthome.core.library.types.OnOffType;\n+import org.eclipse.smarthome.core.library.types.PercentType;\n+import org.eclipse.smarthome.core.types.State;\n+import org.eclipse.smarthome.core.types.UnDefType;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ *\n+ * Proxy class that can collect multiple commands for the same openHAB item and merge them to one command.\n+ * e.g. Hue and Saturation update for Color Item\n+ * \n+ * @author Eugen Freiter - Initial contribution\n+ *\n+ */\n+@NonNullByDefault\n+public class HomekitOHItemProxy {\n+    private final Logger logger = LoggerFactory.getLogger(HomekitOHItemProxy.class);\n+\n+    private static final int DEFAULT_DELAY = 50; // in ms\n+\n+    private final ScheduledExecutorService scheduler = ThreadPoolManager\n+            .getScheduledPool(ThreadPoolManager.THREAD_POOL_NAME_COMMON);\n+\n+\n+    private @Nullable ScheduledFuture<?> future;\n+\n+    private final Item item;\n+\n+    private HomekitDimmerMode dimmerMode = DIMMER_MODE_NORMAL;\n+\n+    // delay, how long wait for further commands. in ms.\n+    private int delay = DEFAULT_DELAY;\n+    private Map<HomekitCommandType, State> commandCache = new ConcurrentHashMap<>();", "originalCommit": "0c0b4c66b09c696d2abd18f7e5c4dc8a9733e9b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1NjA2Nw==", "url": "https://github.com/openhab/openhab-addons/pull/7825#discussion_r436256067", "bodyText": "@cpmeister  thank for the review. suggest changes committed, i.e. final added to map, all finals are moved up before non-final. blank lines removed. spotless executed", "author": "yfre", "createdAt": "2020-06-06T10:03:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE2MDk2MQ=="}], "type": "inlineReview"}, {"oid": "0be49990941c33a575863ba4406ecc7d4f16cdb0", "url": "https://github.com/openhab/openhab-addons/commit/0be49990941c33a575863ba4406ecc7d4f16cdb0", "message": "incorporate feedback from @cpmeister\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-06-06T10:02:46Z", "type": "commit"}, {"oid": "e653a660151cb6e81c657500299d27530e2a07f9", "url": "https://github.com/openhab/openhab-addons/commit/e653a660151cb6e81c657500299d27530e2a07f9", "message": "remove some blank lines\n\nSigned-off-by: Eugen Freiter <freiter@gmx.de>", "committedDate": "2020-06-07T19:21:19Z", "type": "commit"}]}