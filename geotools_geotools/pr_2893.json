{"pr_number": 2893, "pr_title": "[GEOT-6557] Add support for GEOMETRY_GENERALIZATION in MBTiles store [GEOT-6558] Make MBTilesStore to remove features in mbtiles file buffer when a rendering transformation is issued", "pr_author": "taba90", "pr_createdAt": "2020-04-21T08:24:43Z", "pr_url": "https://github.com/geotools/geotools/pull/2893", "timeline": [{"oid": "0171212a83c41c7026883defb594f169c4ff2876", "url": "https://github.com/geotools/geotools/commit/0171212a83c41c7026883defb594f169c4ff2876", "message": "[GEOT-6557] Add support for GEOMETRY_GENERALIZATION in MBTiles store", "committedDate": "2020-04-21T08:19:58Z", "type": "commit"}, {"oid": "1fcc7b16f553df77154299b19ccc7fc9c295923b", "url": "https://github.com/geotools/geotools/commit/1fcc7b16f553df77154299b19ccc7fc9c295923b", "message": "fix fmt check on Java 11", "committedDate": "2020-04-21T13:40:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1ODg3NQ==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417358875", "body": "The name is unclear, there is no just a single \"pixel\", and in the future, things can be more complicated, like having a buffer in meters.\r\nThe implementation is also asymmetric, StreamingRenderer uses the clip from the feature metadata for tile rendering already, but here a new hint has been added to delegate to the store instead. Can we wrap the collection and clip just before passing the data to the rendering transformation instead? No need for new hints in this case.\r\nIf the rework is considered too big, at least let's call this \"REMOVE_TILE_BUFFER\" instead.", "bodyText": "The name is unclear, there is no just a single \"pixel\", and in the future, things can be more complicated, like having a buffer in meters.\nThe implementation is also asymmetric, StreamingRenderer uses the clip from the feature metadata for tile rendering already, but here a new hint has been added to delegate to the store instead. Can we wrap the collection and clip just before passing the data to the rendering transformation instead? No need for new hints in this case.\nIf the rework is considered too big, at least let's call this \"REMOVE_TILE_BUFFER\" instead.", "bodyHTML": "<p dir=\"auto\">The name is unclear, there is no just a single \"pixel\", and in the future, things can be more complicated, like having a buffer in meters.<br>\nThe implementation is also asymmetric, StreamingRenderer uses the clip from the feature metadata for tile rendering already, but here a new hint has been added to delegate to the store instead. Can we wrap the collection and clip just before passing the data to the rendering transformation instead? No need for new hints in this case.<br>\nIf the rework is considered too big, at least let's call this \"REMOVE_TILE_BUFFER\" instead.</p>", "author": "aaime", "createdAt": "2020-04-29T14:27:51Z", "path": "modules/library/metadata/src/main/java/org/geotools/util/factory/Hints.java", "diffHunk": "@@ -688,6 +688,11 @@\n      */\n     public static final ClassKey GEOMETRY_CLIP = new ClassKey(\"org.locationtech.jts.geom.Geometry\");\n \n+    /**\n+     * Used when a rendering transformation is applied to a vector tile geometries, to lead the\n+     * store using the clip mask to remove geometries outside tiles.\n+     */\n+    public static final Key REMOVE_BUFFER_PIXEL = new Key(Boolean.class);", "originalCommit": "1fcc7b16f553df77154299b19ccc7fc9c295923b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MjAxMQ==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417972011", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-04-30T12:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1ODg3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1OTgwOQ==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417359809", "body": "This could be easily turned into a DecoratingFeatureIterator instead, which a ClippingFeatureCollection would use.", "bodyText": "This could be easily turned into a DecoratingFeatureIterator instead, which a ClippingFeatureCollection would use.", "bodyHTML": "<p dir=\"auto\">This could be easily turned into a DecoratingFeatureIterator instead, which a ClippingFeatureCollection would use.</p>", "author": "aaime", "createdAt": "2020-04-29T14:28:58Z", "path": "modules/unsupported/mbtiles/src/main/java/org/geotools/mbtiles/ClippingFeatureReader.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.mbtiles;\n+\n+import java.io.IOException;\n+import java.util.NoSuchElementException;\n+import org.geotools.data.simple.SimpleFeatureReader;\n+import org.geotools.util.factory.Hints;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.simple.SimpleFeatureType;\n+import org.opengis.feature.type.GeometryDescriptor;\n+\n+/**\n+ * The class takes care to return features that intersects the geometry passed with a\n+ * Hints.GEOMETRY_CLIP, in order to avoid that features' buffer in mbtiles data gets deployed when a\n+ * rendering transformation is issued.\n+ */\n+class ClippingFeatureReader implements SimpleFeatureReader {", "originalCommit": "1fcc7b16f553df77154299b19ccc7fc9c295923b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MTk0Ng==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417971946", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-04-30T12:27:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1OTgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2MDQ2NQ==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417360465", "body": "Here one could advertise the existing Hints.GEOMETRY_CLIP, so that the StreamingRenderer instantiates the clipping collection only when needed.", "bodyText": "Here one could advertise the existing Hints.GEOMETRY_CLIP, so that the StreamingRenderer instantiates the clipping collection only when needed.", "bodyHTML": "<p dir=\"auto\">Here one could advertise the existing Hints.GEOMETRY_CLIP, so that the StreamingRenderer instantiates the clipping collection only when needed.</p>", "author": "aaime", "createdAt": "2020-04-29T14:29:45Z", "path": "modules/unsupported/mbtiles/src/main/java/org/geotools/mbtiles/MBTilesFeatureSource.java", "diffHunk": "@@ -68,7 +61,10 @@ public MBTilesFeatureSource(\n \n     @Override\n     protected void addHints(Set<Hints.Key> hints) {\n+\n         hints.add(Hints.GEOMETRY_SIMPLIFICATION);\n+        hints.add(Hints.GEOMETRY_GENERALIZATION);\n+        hints.add(Hints.REMOVE_BUFFER_PIXEL);", "originalCommit": "1fcc7b16f553df77154299b19ccc7fc9c295923b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MTg4NA==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417971884", "bodyText": "fixed", "author": "taba90", "createdAt": "2020-04-30T12:27:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2MDQ2NQ=="}], "type": "inlineReview"}, {"oid": "c301d0eef1b4280ceb5b43392897d13a9469f7bd", "url": "https://github.com/geotools/geotools/commit/c301d0eef1b4280ceb5b43392897d13a9469f7bd", "message": "[GEOT-6558] Make MBTilesStore to remove features in mbtiles file buffer when a rendering transformation is issued", "committedDate": "2020-04-29T20:36:58Z", "type": "commit"}, {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4", "url": "https://github.com/geotools/geotools/commit/67418d5f80de3539ae8ba7f40801afd274a6cac4", "message": "reviewer's feedback applied", "committedDate": "2020-04-30T11:43:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzE3OA==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743178", "body": "\r\nThanks for making this a general functionality.\r\n\r\n```suggestion\r\npublic class ClippingFeatureCollection extends DecoratingSimpleFeatureCollection {\r\n```\r\n\r\nNone of the existing decorators reminds you that it's a decorator in the name:\r\n\r\n![image](https://user-images.githubusercontent.com/325433/81175529-fc169100-8fa3-11ea-932e-8e7703303794.png)\r\n", "bodyText": "Thanks for making this a general functionality.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class DecoratingClippingFeatureCollection extends DecoratingSimpleFeatureCollection {\n          \n          \n            \n            public class ClippingFeatureCollection extends DecoratingSimpleFeatureCollection {\n          \n      \n    \n    \n  \n\nNone of the existing decorators reminds you that it's a decorator in the name:", "bodyHTML": "<p dir=\"auto\">Thanks for making this a general functionality.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">DecoratingClippingFeatureCollection</span> <span class=\"pl-k\">extends</span> <span class=\"pl-e\">DecoratingSimpleFeatureCollection</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">ClippingFeatureCollection</span> <span class=\"pl-k\">extends</span> <span class=\"pl-e\">DecoratingSimpleFeatureCollection</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">None of the existing decorators reminds you that it's a decorator in the name:</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://user-images.githubusercontent.com/325433/81175529-fc169100-8fa3-11ea-932e-8e7703303794.png\"><img src=\"https://user-images.githubusercontent.com/325433/81175529-fc169100-8fa3-11ea-932e-8e7703303794.png\" alt=\"image\" style=\"max-width: 100%;\"></a></p>", "author": "aaime", "createdAt": "2020-05-06T12:15:09Z", "path": "modules/library/main/src/main/java/org/geotools/feature/collection/DecoratingClippingFeatureCollection.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.feature.collection;\n+\n+import org.geotools.data.simple.SimpleFeatureCollection;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+\n+/**\n+ * The class decorates a SimpleFeatureCollection with one that returns features that intersect the\n+ * geometry passed with a Hints.GEOMETRY_CLIP\n+ */\n+public class DecoratingClippingFeatureCollection extends DecoratingSimpleFeatureCollection {", "originalCommit": "67418d5f80de3539ae8ba7f40801afd274a6cac4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzMzNw==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743337", "body": "Same as above.", "bodyText": "Same as above.", "bodyHTML": "<p dir=\"auto\">Same as above.</p>", "author": "aaime", "createdAt": "2020-05-06T12:15:25Z", "path": "modules/library/main/src/main/java/org/geotools/feature/collection/DecoratingClippingFeatureIterator.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.feature.collection;\n+\n+import java.util.NoSuchElementException;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+import org.geotools.feature.FeatureIterator;\n+import org.geotools.util.factory.Hints;\n+import org.locationtech.jts.geom.Geometry;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.type.GeometryDescriptor;\n+\n+/**\n+ * Decorates a SimpleFeatureIterator with one that return features if intersect the Geometry passed\n+ * with the Hint.GEOMETRY_CLIP\n+ */\n+public class DecoratingClippingFeatureIterator extends DecoratingSimpleFeatureIterator {", "originalCommit": "67418d5f80de3539ae8ba7f40801afd274a6cac4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzUxNg==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743516", "body": "Align test name while renaming main class.", "bodyText": "Align test name while renaming main class.", "bodyHTML": "<p dir=\"auto\">Align test name while renaming main class.</p>", "author": "aaime", "createdAt": "2020-05-06T12:15:46Z", "path": "modules/library/main/src/test/java/org/geotools/feature/collection/DecoratingClippingFeatureCollectionTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.feature.collection;\n+\n+import junit.framework.TestCase;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+import org.geotools.feature.DefaultFeatureCollection;\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\n+import org.geotools.util.factory.Hints;\n+import org.junit.Test;\n+import org.locationtech.jts.geom.Coordinate;\n+import org.locationtech.jts.geom.GeometryFactory;\n+import org.locationtech.jts.geom.Point;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.simple.SimpleFeatureType;\n+\n+public class DecoratingClippingFeatureCollectionTest extends TestCase {", "originalCommit": "67418d5f80de3539ae8ba7f40801afd274a6cac4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzY2Mg==", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743662", "body": "Nice", "bodyText": "Nice", "bodyHTML": "<p dir=\"auto\">Nice</p>", "author": "aaime", "createdAt": "2020-05-06T12:16:00Z", "path": "modules/library/render/src/main/java/org/geotools/renderer/lite/RenderingTransformationHelper.java", "diffHunk": "@@ -276,6 +279,12 @@ public Object applyRenderingTransformation(\n             // grab the original features\n             Query mixedQuery = DataUtilities.mixQueries(layerQuery, optimizedQuery, null);\n             originalFeatures = featureSource.getFeatures(mixedQuery);\n+            if (featureSource.getSupportedHints().contains(Hints.GEOMETRY_CLIP)\n+                    && originalFeatures instanceof SimpleFeatureCollection) {\n+                originalFeatures =", "originalCommit": "67418d5f80de3539ae8ba7f40801afd274a6cac4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "317fea2ad2cfe37139c24d87d9fd1dffda66c866", "url": "https://github.com/geotools/geotools/commit/317fea2ad2cfe37139c24d87d9fd1dffda66c866", "message": "reviewer's feedback applied", "committedDate": "2020-05-07T05:54:20Z", "type": "commit"}, {"oid": "317fea2ad2cfe37139c24d87d9fd1dffda66c866", "url": "https://github.com/geotools/geotools/commit/317fea2ad2cfe37139c24d87d9fd1dffda66c866", "message": "reviewer's feedback applied", "committedDate": "2020-05-07T05:54:20Z", "type": "forcePushed"}]}