{"pr_number": 2299, "pr_title": "Use Set instead of List for TextSubmission.textBlocks", "pr_author": "krusche", "pr_createdAt": "2020-10-29T21:08:26Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/2299", "timeline": [{"oid": "d6663724673a03ef56f55c223efe5e6db1bfea0c", "url": "https://github.com/ls1intum/Artemis/commit/d6663724673a03ef56f55c223efe5e6db1bfea0c", "message": "List -> Set for TextSubmission.textBlocks", "committedDate": "2020-10-29T20:17:08Z", "type": "commit"}, {"oid": "845799d5c14232a591b76d1be8636ac419a54c02", "url": "https://github.com/ls1intum/Artemis/commit/845799d5c14232a591b76d1be8636ac419a54c02", "message": "fix tests", "committedDate": "2020-10-29T21:04:51Z", "type": "commit"}, {"oid": "b225128d540f2e876d0ba30dfb9528f61a2cb35d", "url": "https://github.com/ls1intum/Artemis/commit/b225128d540f2e876d0ba30dfb9528f61a2cb35d", "message": "Merge branch 'develop' into chore/text-block-set", "committedDate": "2020-11-06T00:03:20Z", "type": "commit"}, {"oid": "8f222259dc78b3d9cc4fcbabd0b45e3190b9b2a6", "url": "https://github.com/ls1intum/Artemis/commit/8f222259dc78b3d9cc4fcbabd0b45e3190b9b2a6", "message": "TextBlockService\n\nReturn Set in splitSubmissionIntoBlocks()\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:03:21Z", "type": "commit"}, {"oid": "161326ce22f3dedf6eb1f0f9466a539e9d75f61c", "url": "https://github.com/ls1intum/Artemis/commit/161326ce22f3dedf6eb1f0f9466a539e9d75f61c", "message": "AutomaticTextAssessmentConflictService\n\ngroupingBy with toSet()\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:03:55Z", "type": "commit"}, {"oid": "6d55c2ea62ecf0b9b23e69ee19a53261116a638b", "url": "https://github.com/ls1intum/Artemis/commit/6d55c2ea62ecf0b9b23e69ee19a53261116a638b", "message": "TextAssessmentResource\n\ndo not overwrite parameters of saveTextBlocks()\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:05:37Z", "type": "commit"}, {"oid": "89af7f5ea49a7f8855dc50bb0269e442a3714b14", "url": "https://github.com/ls1intum/Artemis/commit/89af7f5ea49a7f8855dc50bb0269e442a3714b14", "message": "TextExerciseUtilService\n\nJavaDoc\n\nSigned-off-by: Jan Philip Bernius <janphilip.bernius@tum.de>", "committedDate": "2020-11-06T08:11:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU3MTM2NQ==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r518571365", "body": "Should be possible to allocate the HashSet in the groupingBy\r\n```suggestion\r\n        final Map<Long, List<TextBlock>> textBlocks = allTextBlocks.stream().collect(groupingBy(block -> block.getSubmission().getId(), toSet()));\r\n        textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(textBlocks.get(textSubmission.getId())));\r\n```", "bodyText": "Should be possible to allocate the HashSet in the groupingBy\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final Map<Long, List<TextBlock>> textBlocks = allTextBlocks.stream().collect(groupingBy(block -> block.getSubmission().getId()));\n          \n          \n            \n                    textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(new HashSet<>(textBlocks.get(textSubmission.getId()))));\n          \n          \n            \n                    final Map<Long, List<TextBlock>> textBlocks = allTextBlocks.stream().collect(groupingBy(block -> block.getSubmission().getId(), toSet()));\n          \n          \n            \n                    textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(textBlocks.get(textSubmission.getId())));", "bodyHTML": "<p dir=\"auto\">Should be possible to allocate the HashSet in the groupingBy</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">final</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">Long</span>, <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">TextBlock</span>&gt;</span>&gt;</span> textBlocks <span class=\"pl-k\">=</span> allTextBlocks<span class=\"pl-k\">.</span>stream()<span class=\"pl-k\">.</span>collect(groupingBy(block <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> block<span class=\"pl-k\">.</span>getSubmission()<span class=\"pl-k\">.</span>getId()));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        textSubmissionSet<span class=\"pl-k\">.</span>forEach(textSubmission <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> textSubmission<span class=\"pl-k\">.</span>setBlocks(<span class=\"pl-k x x-first\">new</span><span class=\"x\"> </span><span class=\"pl-k x\">HashSet&lt;&gt;</span><span class=\"x x-last\">(</span>textBlocks<span class=\"pl-k\">.</span>get(textSubmission<span class=\"pl-k\">.</span>getId(<span class=\"x x-first x-last\">)</span>))));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">final</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">Long</span>, <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">TextBlock</span>&gt;</span>&gt;</span> textBlocks <span class=\"pl-k\">=</span> allTextBlocks<span class=\"pl-k\">.</span>stream()<span class=\"pl-k\">.</span>collect(groupingBy(block <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> block<span class=\"pl-k\">.</span>getSubmission()<span class=\"pl-k\">.</span>getId()<span class=\"x x-first x-last\">, toSet()</span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        textSubmissionSet<span class=\"pl-k\">.</span>forEach(textSubmission <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> textSubmission<span class=\"pl-k\">.</span>setBlocks(textBlocks<span class=\"pl-k\">.</span>get(textSubmission<span class=\"pl-k\">.</span>getId())));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jpbernius", "createdAt": "2020-11-06T07:40:36Z", "path": "src/main/java/de/tum/in/www1/artemis/service/AutomaticTextAssessmentConflictService.java", "diffHunk": "@@ -149,9 +145,9 @@ public void asyncCheckFeedbackConsistency(List<TextBlock> textBlocks, List<Feedb\n                 return (TextSubmission) conflict.getFirstFeedback().getResult().getSubmission();\n             }\n         }).collect(toSet());\n-        final Map<Long, List<TextBlock>> textBlocks = textBlockRepository.findAllBySubmissionIdIn(textSubmissionSet.stream().map(TextSubmission::getId).collect(toList())).stream()\n-                .collect(groupingBy(b -> b.getSubmission().getId()));\n-        textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(textBlocks.get(textSubmission.getId())));\n+        var allTextBlocks = textBlockRepository.findAllBySubmissionIdIn(textSubmissionSet.stream().map(TextSubmission::getId).collect(toSet()));\n+        final Map<Long, List<TextBlock>> textBlocks = allTextBlocks.stream().collect(groupingBy(block -> block.getSubmission().getId()));\n+        textSubmissionSet.forEach(textSubmission -> textSubmission.setBlocks(new HashSet<>(textBlocks.get(textSubmission.getId()))));", "originalCommit": "b225128d540f2e876d0ba30dfb9528f61a2cb35d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU3OTM5Ng==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r518579396", "body": "This can be changed to `public Set<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission)`. Will submit a commit.", "bodyText": "This can be changed to public Set<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission). Will submit a commit.", "bodyHTML": "<p dir=\"auto\">This can be changed to <code>public Set&lt;TextBlock&gt; splitSubmissionIntoBlocks(TextSubmission submission)</code>. Will submit a commit.</p>", "author": "jpbernius", "createdAt": "2020-11-06T07:59:28Z", "path": "src/main/java/de/tum/in/www1/artemis/service/TextBlockService.java", "diffHunk": "@@ -49,11 +46,11 @@\n      * @param submission TextSubmission to split\n      * @return List of TextBlocks\n      */\n-    @Transactional(readOnly = true)\n     public List<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {", "originalCommit": "b225128d540f2e876d0ba30dfb9528f61a2cb35d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMDY2Nw==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r522900667", "body": "Would it make sense to use [Collections.emptySet()](https://docs.oracle.com/javase/7/docs/api/java/util/Collections.html#emptySet%28%29) here, which avoids allocating a new `HashSet` if we don't need it?", "bodyText": "Would it make sense to use Collections.emptySet() here, which avoids allocating a new HashSet if we don't need it?", "bodyHTML": "<p dir=\"auto\">Would it make sense to use <a href=\"https://docs.oracle.com/javase/7/docs/api/java/util/Collections.html#emptySet%28%29\" rel=\"nofollow\">Collections.emptySet()</a> here, which avoids allocating a new <code>HashSet</code> if we don't need it?</p>", "author": "FrankeLukas", "createdAt": "2020-11-13T11:46:34Z", "path": "src/main/java/de/tum/in/www1/artemis/service/TextBlockService.java", "diffHunk": "@@ -49,23 +46,24 @@\n      * @param submission TextSubmission to split\n      * @return List of TextBlocks\n      */\n-    @Transactional(readOnly = true)\n-    public List<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+    public Set<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+        final Set<TextBlock> blocks = new HashSet<>();\n+\n+        // Return empty set for missing submission text.\n         final String submissionText = submission.getText();\n-        if (submissionText == null)\n-            return new ArrayList<>();\n-        // Return empty list for missing submission text.\n+        if (submissionText == null) {\n+            return blocks;", "originalCommit": "89af7f5ea49a7f8855dc50bb0269e442a3714b14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyNzAyOQ==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r523727029", "bodyText": "changed it, but I don't think it will make a noticeable difference (maybe 1ns faster ;-)", "author": "krusche", "createdAt": "2020-11-15T08:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMDY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMTYyOA==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r522901628", "body": "Typo: `expectedText`", "bodyText": "Typo: expectedText", "bodyHTML": "<p dir=\"auto\">Typo: <code>expectedText</code></p>", "author": "FrankeLukas", "createdAt": "2020-11-13T11:48:55Z", "path": "src/test/java/de/tum/in/www1/artemis/service/TextBlockServiceTest.java", "diffHunk": "@@ -47,42 +45,57 @@ public void splitSubmissionIntoBlocksForEmptyText() {\n     @Test\n     public void splitSubmissionIntoBlocksForSingleSentence() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Hello World.\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         assertThat(textBlocks, hasSize(1));\n-        assertThat(textBlocks.get(0).getText(), is(equalTo(\"Hello World.\")));\n+        assertThat(textBlocks.iterator().next().getText(), is(equalTo(\"Hello World.\")));\n     }\n \n     @Test\n     public void splitSubmissionIntoBlocksForTwoSentencesWithoutNewLine() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Hello World. This is a Test.\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         assertThat(textBlocks, hasSize(2));\n-        assertThat(textBlocks.get(0).getText(), is(equalTo(\"Hello World.\")));\n-        assertThat(textBlocks.get(1).getText(), is(equalTo(\"This is a Test.\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"Hello World.\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"This is a Test.\")));\n     }\n \n     @Test\n     public void splitSubmissionsIntoBlocksForManySentencesWithNewlinesWithoutFullstop() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Hello World. This is a Test\\n\\n\\nAnother Test\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         assertThat(textBlocks, hasSize(3));\n-        assertThat(textBlocks.get(0).getText(), is(equalTo(\"Hello World.\")));\n-        assertThat(textBlocks.get(1).getText(), is(equalTo(\"This is a Test\")));\n-        assertThat(textBlocks.get(2).getText(), is(equalTo(\"Another Test\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"Hello World.\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"This is a Test\")));\n+        assertThat(textBlocks, hasItem(textBlockWithEqualText(\"Another Test\")));\n     }\n \n     @Test\n     public void splitSubmissionIntoBlocksForManySentencesWithoutPunctuation() {\n         final TextSubmission submission = new TextSubmission(0L).text(\"Example:\\nThis is the first example\\n\\nSection 2:\\n- Here is a list\\n- Of many bullet  points\\n\\n\");\n-        final List<TextBlock> textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n+        final var textBlocks = textBlockService.splitSubmissionIntoBlocks(submission);\n \n         String[] sections = new String[] { \"Example:\", \"This is the first example\", \"Section 2:\", \"- Here is a list\", \"- Of many bullet  points\" };\n         assertThat(textBlocks, hasSize(sections.length));\n-        for (int i = 0; i < sections.length; i++) {\n-            assertThat(textBlocks.get(i).getText(), is(equalTo(sections[i])));\n+        for (String section : sections) {\n+            assertThat(textBlocks, hasItem(textBlockWithEqualText(section)));\n         }\n     }\n+\n+    private Matcher<TextBlock> textBlockWithEqualText(String expextedText) {", "originalCommit": "89af7f5ea49a7f8855dc50bb0269e442a3714b14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyNjk4OA==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r523726988", "bodyText": "fixed", "author": "krusche", "createdAt": "2020-11-15T08:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwMTYyOA=="}], "type": "inlineReview"}, {"oid": "70c97c50dcb38a9c6a88ab324e337726e7706299", "url": "https://github.com/ls1intum/Artemis/commit/70c97c50dcb38a9c6a88ab324e337726e7706299", "message": "fixed issues found in comments", "committedDate": "2020-11-15T08:37:35Z", "type": "commit"}, {"oid": "08ff0671c4916522654e75ba2ab846d4beffcfb6", "url": "https://github.com/ls1intum/Artemis/commit/08ff0671c4916522654e75ba2ab846d4beffcfb6", "message": "Merge branch 'develop' into chore/text-block-set", "committedDate": "2020-11-15T08:38:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzcyOTczNA==", "url": "https://github.com/ls1intum/Artemis/pull/2299#discussion_r523729734", "body": "Does it make sense to use a immutable set here? The other returned set are mutable. Maybe refactor to only return immutable sets? `Set<String> immutable = ImmutableSet.copyOf(set);`", "bodyText": "Does it make sense to use a immutable set here? The other returned set are mutable. Maybe refactor to only return immutable sets? Set<String> immutable = ImmutableSet.copyOf(set);", "bodyHTML": "<p dir=\"auto\">Does it make sense to use a immutable set here? The other returned set are mutable. Maybe refactor to only return immutable sets? <code>Set&lt;String&gt; immutable = ImmutableSet.copyOf(set);</code></p>", "author": "stefanwaldhauser", "createdAt": "2020-11-15T09:02:41Z", "path": "src/main/java/de/tum/in/www1/artemis/service/TextBlockService.java", "diffHunk": "@@ -49,23 +46,23 @@\n      * @param submission TextSubmission to split\n      * @return List of TextBlocks\n      */\n-    @Transactional(readOnly = true)\n-    public List<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+    public Set<TextBlock> splitSubmissionIntoBlocks(TextSubmission submission) {\n+\n+        // Return empty set for missing submission text.\n         final String submissionText = submission.getText();\n-        if (submissionText == null)\n-            return new ArrayList<>();\n-        // Return empty list for missing submission text.\n+        if (submissionText == null) {\n+            return Collections.emptySet();", "originalCommit": "08ff0671c4916522654e75ba2ab846d4beffcfb6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}