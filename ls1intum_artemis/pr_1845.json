{"pr_number": 1845, "pr_title": "Export metrics in prometheus format", "pr_author": "sleiss", "pr_createdAt": "2020-07-09T21:50:20Z", "pr_url": "https://github.com/ls1intum/Artemis/pull/1845", "timeline": [{"oid": "76b9a7cdbc1ef85645280f601d07756bf9369167", "url": "https://github.com/ls1intum/Artemis/commit/76b9a7cdbc1ef85645280f601d07756bf9369167", "message": "Add health indicator metrics, allow access to endpoint.", "committedDate": "2020-07-09T06:56:46Z", "type": "commit"}, {"oid": "b21f17eb348e6bbe1802284e4b0e7115ad36dbae", "url": "https://github.com/ls1intum/Artemis/commit/b21f17eb348e6bbe1802284e4b0e7115ad36dbae", "message": "Move Prometheus Configuration, only allow from specified IP.", "committedDate": "2020-07-09T21:38:45Z", "type": "commit"}, {"oid": "617836921f4a85b79dbc3cd5103dfe0e7448696f", "url": "https://github.com/ls1intum/Artemis/commit/617836921f4a85b79dbc3cd5103dfe0e7448696f", "message": "Merge branch 'develop' into feature/prometheus-metrics-export", "committedDate": "2020-07-10T07:24:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc5ODk0MQ==", "url": "https://github.com/ls1intum/Artemis/pull/1845#discussion_r452798941", "body": "Is this a typo? \"healthindicator\"", "bodyText": "Is this a typo? \"healthindicator\"", "bodyHTML": "<p dir=\"auto\">Is this a typo? \"healthindicator\"</p>", "author": "kloessst", "createdAt": "2020-07-10T11:59:23Z", "path": "src/main/java/de/tum/in/www1/artemis/config/MetricsBean.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package de.tum.in.www1.artemis.config;\n+\n+import java.util.List;\n+\n+import org.springframework.boot.actuate.health.*;\n+import org.springframework.cloud.client.discovery.health.DiscoveryCompositeHealthContributor;\n+import org.springframework.messaging.simp.user.SimpUserRegistry;\n+import org.springframework.stereotype.Component;\n+\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.MeterRegistry;\n+\n+@Component\n+public class MetricsBean {\n+\n+    public MetricsBean(MeterRegistry meterRegistry, SimpUserRegistry simpUserRegistry, List<HealthContributor> healthContributors) {\n+        Gauge.builder(\"artemis.instance.websocket.users\", simpUserRegistry, SimpUserRegistry::getUserCount).strongReference(true)\n+                .description(\"Number of users connected to this Artemis instance\").register(meterRegistry);\n+\n+        for (HealthContributor healthContributor : healthContributors) {\n+            if (healthContributor instanceof HealthIndicator) {\n+                HealthIndicator healthIndicator = (HealthIndicator) healthContributor;\n+                Gauge.builder(\"artemis.health\", healthIndicator, h -> mapHealthToDouble(h.health())).strongReference(true).description(\"Artemis Health Indicator\")\n+                        .tag(\"healtindicator\", healthIndicator.getClass().getSimpleName().toLowerCase()).register(meterRegistry);", "originalCommit": "617836921f4a85b79dbc3cd5103dfe0e7448696f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE4Njc3Mg==", "url": "https://github.com/ls1intum/Artemis/pull/1845#discussion_r453186772", "bodyText": "Good catch, I extracted it into a constant.", "author": "sleiss", "createdAt": "2020-07-11T11:43:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc5ODk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjc5OTgxNA==", "url": "https://github.com/ls1intum/Artemis/pull/1845#discussion_r452799814", "body": "Is this a typo? \"healthindicator\"", "bodyText": "Is this a typo? \"healthindicator\"", "bodyHTML": "<p dir=\"auto\">Is this a typo? \"healthindicator\"</p>", "author": "kloessst", "createdAt": "2020-07-10T12:01:21Z", "path": "src/main/java/de/tum/in/www1/artemis/config/MetricsBean.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package de.tum.in.www1.artemis.config;\n+\n+import java.util.List;\n+\n+import org.springframework.boot.actuate.health.*;\n+import org.springframework.cloud.client.discovery.health.DiscoveryCompositeHealthContributor;\n+import org.springframework.messaging.simp.user.SimpUserRegistry;\n+import org.springframework.stereotype.Component;\n+\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.MeterRegistry;\n+\n+@Component\n+public class MetricsBean {\n+\n+    public MetricsBean(MeterRegistry meterRegistry, SimpUserRegistry simpUserRegistry, List<HealthContributor> healthContributors) {\n+        Gauge.builder(\"artemis.instance.websocket.users\", simpUserRegistry, SimpUserRegistry::getUserCount).strongReference(true)\n+                .description(\"Number of users connected to this Artemis instance\").register(meterRegistry);\n+\n+        for (HealthContributor healthContributor : healthContributors) {\n+            if (healthContributor instanceof HealthIndicator) {\n+                HealthIndicator healthIndicator = (HealthIndicator) healthContributor;\n+                Gauge.builder(\"artemis.health\", healthIndicator, h -> mapHealthToDouble(h.health())).strongReference(true).description(\"Artemis Health Indicator\")\n+                        .tag(\"healtindicator\", healthIndicator.getClass().getSimpleName().toLowerCase()).register(meterRegistry);\n+            }\n+            if (healthContributor instanceof DiscoveryCompositeHealthContributor) {\n+                DiscoveryCompositeHealthContributor discoveryCompositeHealthContributor = (DiscoveryCompositeHealthContributor) healthContributor;\n+                for (NamedContributor<HealthContributor> discoveryHealthContributor : discoveryCompositeHealthContributor) {\n+                    if (discoveryHealthContributor.getContributor() instanceof HealthIndicator) {\n+                        HealthIndicator healthIndicator = (HealthIndicator) discoveryHealthContributor.getContributor();\n+                        Gauge.builder(\"artemis.health\", healthIndicator, h -> mapHealthToDouble(h.health())).strongReference(true).description(\"Artemis Health Indicator\")\n+                                .tag(\"healtindicator\", discoveryHealthContributor.getName().toLowerCase()).register(meterRegistry);", "originalCommit": "617836921f4a85b79dbc3cd5103dfe0e7448696f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwMDU1MQ==", "url": "https://github.com/ls1intum/Artemis/pull/1845#discussion_r452800551", "body": "```suggestion\r\n        // Only enable the endpoint if an ip-address is specified\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Only enable the endpoint an ip-address is specified\n          \n          \n            \n                    // Only enable the endpoint if an ip-address is specified", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> Only enable the endpoint an ip-address is specified</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c\"><span class=\"pl-c\">//</span> Only enable the endpoint <span class=\"x x-first x-last\">if </span>an ip-address is specified</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "kloessst", "createdAt": "2020-07-10T12:03:12Z", "path": "src/main/java/de/tum/in/www1/artemis/config/PrometheusAuthConfiguration.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package de.tum.in.www1.artemis.config;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.config.http.SessionCreationPolicy;\n+\n+@Configuration\n+@Order(1)\n+@ConditionalOnProperty(prefix = \"management\", name = \"metrics.export.prometheus.enabled\")\n+public class PrometheusAuthConfiguration extends WebSecurityConfigurerAdapter {\n+\n+    @Value(\"${spring.prometheus.monitoringIp}\")\n+    private String monitoringIpAddress;\n+\n+    @Override\n+    protected void configure(HttpSecurity http) throws Exception {\n+        // Only enable the endpoint an ip-address is specified", "originalCommit": "617836921f4a85b79dbc3cd5103dfe0e7448696f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE4Njg2Mw==", "url": "https://github.com/ls1intum/Artemis/pull/1845#discussion_r453186863", "bodyText": "Thanks, I fixed the documentation.", "author": "sleiss", "createdAt": "2020-07-11T11:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwMDU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgwMTQzNg==", "url": "https://github.com/ls1intum/Artemis/pull/1845#discussion_r452801436", "body": "You could define constants for \"artemis.health\", \"Artemis Health Indicator\", \"healt(h)indicator\". But this could also hurt readability.", "bodyText": "You could define constants for \"artemis.health\", \"Artemis Health Indicator\", \"healt(h)indicator\". But this could also hurt readability.", "bodyHTML": "<p dir=\"auto\">You could define constants for \"artemis.health\", \"Artemis Health Indicator\", \"healt(h)indicator\". But this could also hurt readability.</p>", "author": "kloessst", "createdAt": "2020-07-10T12:05:08Z", "path": "src/main/java/de/tum/in/www1/artemis/config/MetricsBean.java", "diffHunk": "@@ -0,0 +1,54 @@\n+package de.tum.in.www1.artemis.config;\n+\n+import java.util.List;\n+\n+import org.springframework.boot.actuate.health.*;\n+import org.springframework.cloud.client.discovery.health.DiscoveryCompositeHealthContributor;\n+import org.springframework.messaging.simp.user.SimpUserRegistry;\n+import org.springframework.stereotype.Component;\n+\n+import io.micrometer.core.instrument.Gauge;\n+import io.micrometer.core.instrument.MeterRegistry;\n+\n+@Component\n+public class MetricsBean {\n+\n+    public MetricsBean(MeterRegistry meterRegistry, SimpUserRegistry simpUserRegistry, List<HealthContributor> healthContributors) {\n+        Gauge.builder(\"artemis.instance.websocket.users\", simpUserRegistry, SimpUserRegistry::getUserCount).strongReference(true)\n+                .description(\"Number of users connected to this Artemis instance\").register(meterRegistry);\n+\n+        for (HealthContributor healthContributor : healthContributors) {\n+            if (healthContributor instanceof HealthIndicator) {\n+                HealthIndicator healthIndicator = (HealthIndicator) healthContributor;\n+                Gauge.builder(\"artemis.health\", healthIndicator, h -> mapHealthToDouble(h.health())).strongReference(true).description(\"Artemis Health Indicator\")", "originalCommit": "617836921f4a85b79dbc3cd5103dfe0e7448696f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6503ab10001ab5a0223cd6f2d65ecd7b86c0d905", "url": "https://github.com/ls1intum/Artemis/commit/6503ab10001ab5a0223cd6f2d65ecd7b86c0d905", "message": "Apply feedback, add more documentation.", "committedDate": "2020-07-11T11:43:26Z", "type": "commit"}, {"oid": "61628e96639bb4d2623508cd3d1a62f27692ef00", "url": "https://github.com/ls1intum/Artemis/commit/61628e96639bb4d2623508cd3d1a62f27692ef00", "message": "Merge remote-tracking branch 'origin/feature/prometheus-metrics-export' into feature/prometheus-metrics-export", "committedDate": "2020-07-11T11:46:31Z", "type": "commit"}]}