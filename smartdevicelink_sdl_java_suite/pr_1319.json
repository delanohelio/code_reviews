{"pr_number": 1319, "pr_title": "Cache Lock Screen Icons Retrieved from URL", "pr_author": "RHenigan", "pr_createdAt": "2020-03-24T16:11:18Z", "pr_url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319", "timeline": [{"oid": "25264c22003a862f668fdc9af8daf69b87080f75", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/25264c22003a862f668fdc9af8daf69b87080f75", "message": "Initial pass at Caching Lock Screen icon", "committedDate": "2020-03-23T20:55:01Z", "type": "commit"}, {"oid": "99934709fe36c32a171d434d70404e49b1a83d9f", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/99934709fe36c32a171d434d70404e49b1a83d9f", "message": "Update Exceptions and integrate to lockscrnManager", "committedDate": "2020-03-24T14:58:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI4MjczNA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r397282734", "body": "can the class be package-private as it is not supposed to be used by the devs?", "bodyText": "can the class be package-private as it is not supposed to be used by the devs?", "bodyHTML": "<p dir=\"auto\">can the class be package-private as it is not supposed to be used by the devs?</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-24T16:18:38Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.proxy.rpc.DateTime;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.util.Date;\n+\n+public class LockScreenDeviceIconManager {", "originalCommit": "99934709fe36c32a171d434d70404e49b1a83d9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI4OTY5Mg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r397289692", "body": "I would use a more descriptive name and create a constant for that string instead of hard-coding it in multiple places. That applies to other hardcoded strings in the code. Something like:\r\nhttps://github.com/smartdevicelink/sdl_java_suite/blob/797b7a14a7fd67fdf6faa504865e4e22228858ef/android/sdl_android/src/main/java/com/smartdevicelink/transport/SdlRouterService.java#L186", "bodyText": "I would use a more descriptive name and create a constant for that string instead of hard-coding it in multiple places. That applies to other hardcoded strings in the code. Something like:\n\n  \n    \n      sdl_java_suite/android/sdl_android/src/main/java/com/smartdevicelink/transport/SdlRouterService.java\n    \n    \n         Line 186\n      in\n      797b7a1\n    \n    \n    \n    \n\n        \n          \n           protected static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.device.status\";", "bodyHTML": "<p dir=\"auto\">I would use a more descriptive name and create a constant for that string instead of hard-coding it in multiple places. That applies to other hardcoded strings in the code. Something like:<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/smartdevicelink/sdl_java_suite/blob/797b7a14a7fd67fdf6faa504865e4e22228858ef/android/sdl_android/src/main/java/com/smartdevicelink/transport/SdlRouterService.java#L186\">sdl_java_suite/android/sdl_android/src/main/java/com/smartdevicelink/transport/SdlRouterService.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 186\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/smartdevicelink/sdl_java_suite/commit/797b7a14a7fd67fdf6faa504865e4e22228858ef\">797b7a1</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L186\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"186\"></td>\n          <td id=\"LC186\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">protected</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1\">SDL_DEVICE_STATUS_SHARED_PREFS</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>sdl.device.status<span class=\"pl-pds\">\"</span></span>; </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-24T16:27:18Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,107 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.proxy.rpc.DateTime;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileNotFoundException;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.util.Date;\n+\n+public class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+    }\n+\n+    boolean updateCachedImage(String iconIUrl) {\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(\"sdl\", Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconIUrl, null);\n+        if(iconParameters == null) {\n+            return true;\n+        } else {\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(iconParameters);\n+                long lastUpdatedTime = 0;\n+                lastUpdatedTime = (long) jsonObject.get(\"lastUpdatedTime\");\n+                long currentTime = System.currentTimeMillis();\n+\n+                long timeDifference = currentTime - lastUpdatedTime;\n+                long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+\n+                return daysBetweenLastUpdate >= 30;\n+\n+            } catch (JSONException e) {\n+                e.printStackTrace();\n+                return true;\n+            }\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+        File f = new File(this.context.getCacheDir(), iconUrl);\n+        try {\n+            f.createNewFile();\n+            ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+            icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+            byte[] bitmapdata = bos.toByteArray();\n+\n+            FileOutputStream fos = null;\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapdata);\n+            fos.flush();\n+            fos.close();\n+            JSONObject iconParams;\n+\n+            iconParams = buildDeviceIconParameters(f.getAbsolutePath());\n+            writeDeviceIconParametersToSystemPreferences(iconUrl, iconParams);\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(\"sdl\", Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconUrl, null);\n+\n+        if (iconParameters != null) {\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(\"storedUrl\");\n+                String storedUrl = jsonObject.getString(\"storedUrl\");\n+                return BitmapFactory.decodeFile(storedUrl);\n+            } catch (JSONException e) {\n+                e.printStackTrace();\n+                return null;\n+            }\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    private void writeDeviceIconParametersToSystemPreferences(String iconUrl, JSONObject jsonObject) throws JSONException {\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(\"sdl\", Context.MODE_PRIVATE);", "originalCommit": "99934709fe36c32a171d434d70404e49b1a83d9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2a5835bad1df51353b9614d9ad3fdd93f7788c1", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f2a5835bad1df51353b9614d9ad3fdd93f7788c1", "message": "Hash iconUrl and fix minor issues", "committedDate": "2020-03-24T18:39:22Z", "type": "commit"}, {"oid": "3958a341d058493a74ef48df75a22b81757bf008", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/3958a341d058493a74ef48df75a22b81757bf008", "message": "Handle Edge Cases and initial tests", "committedDate": "2020-03-25T18:44:42Z", "type": "commit"}, {"oid": "95ae9b19db7179491574cbd1b0437ef69457a68a", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/95ae9b19db7179491574cbd1b0437ef69457a68a", "message": "Continue Testing", "committedDate": "2020-03-25T20:35:24Z", "type": "commit"}, {"oid": "ae6aee4f0c95135e660294993b598e0275c151c2", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/ae6aee4f0c95135e660294993b598e0275c151c2", "message": "Add passing test for saveFileToCache", "committedDate": "2020-03-25T21:00:23Z", "type": "commit"}, {"oid": "9855cacefcdc42ce3377e8f812a3ac9471aa1997", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/9855cacefcdc42ce3377e8f812a3ac9471aa1997", "message": "Add test for getFileFromCache", "committedDate": "2020-03-25T21:05:42Z", "type": "commit"}, {"oid": "35cc26b3536d61f04b891119194226492a890d0a", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/35cc26b3536d61f04b891119194226492a890d0a", "message": "Add happy path test for getFileFromCache", "committedDate": "2020-03-25T21:17:38Z", "type": "commit"}, {"oid": "641a48ce265b0203cd24c4c58816b109a0569d61", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/641a48ce265b0203cd24c4c58816b109a0569d61", "message": "Replace Logcat with DebugTool", "committedDate": "2020-03-26T15:21:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4ODIyNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400488225", "body": "can we rename this method to something like `shouldUpdateCachedImage()` `isCachedImageExpired()`?  just to make it clear from the name that the method only checks if we need to update and it doesn't actually do the update.", "bodyText": "can we rename this method to something like shouldUpdateCachedImage() isCachedImageExpired()?  just to make it clear from the name that the method only checks if we need to update and it doesn't actually do the update.", "bodyHTML": "<p dir=\"auto\">can we rename this method to something like <code>shouldUpdateCachedImage()</code> <code>isCachedImageExpired()</code>?  just to make it clear from the name that the method only checks if we need to update and it doesn't actually do the update.</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T20:55:42Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+import android.util.Log;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_URL = \"storedUrl\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean updateCachedImage(String iconUrl) {", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA2OTEwMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401069101", "bodyText": "shouldUpdateCachedImage sounds good to me", "author": "RHenigan", "createdAt": "2020-03-31T16:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4ODIyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTQ0Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400489443", "body": "Can we put the three error messages in one log statement using String.format()?", "bodyText": "Can we put the three error messages in one log statement using String.format()?", "bodyHTML": "<p dir=\"auto\">Can we put the three error messages in one log statement using String.format()?</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T20:58:03Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -376,16 +379,34 @@ private void downloadDeviceIcon(final String url){\n \t\t\t@Override\n \t\t\tpublic void run(){\n \t\t\t\ttry{\n-\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\tif(mLockScreenDeviceIconManager.updateCachedImage(url)) {\n+\t\t\t\t\t\tLog.d(TAG, \"URL: \" + url);\n+\t\t\t\t\t\tLog.d(TAG, \"Image Update Needed\");\n+\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tLog.d(TAG, \"Image Is Up To Date\");\n+\t\t\t\t\t\tdeviceLogo = mLockScreenDeviceIconManager.getFileFromCache(url);\n+\t\t\t\t\t\tif (deviceLogo == null) {\n+\t\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t} catch(IOException e){\n+\t\t\t\t\tLog.e(TAG, \"device Icon Error Downloading\");", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3NTI2MQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401075261", "bodyText": "made into one log statement", "author": "RHenigan", "createdAt": "2020-03-31T17:07:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTg1MQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400489851", "body": "Can we put the two messages in one log statement using String.format() and use DebuggerTool instead?\r\n\r\n", "bodyText": "Can we put the two messages in one log statement using String.format() and use DebuggerTool instead?", "bodyHTML": "<p dir=\"auto\">Can we put the two messages in one log statement using String.format() and use DebuggerTool instead?</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T20:58:51Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -376,16 +379,34 @@ private void downloadDeviceIcon(final String url){\n \t\t\t@Override\n \t\t\tpublic void run(){\n \t\t\t\ttry{\n-\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\tif(mLockScreenDeviceIconManager.updateCachedImage(url)) {\n+\t\t\t\t\t\tLog.d(TAG, \"URL: \" + url);", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDAyNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401070025", "bodyText": "changed to debugTool and removed unecessary URL log", "author": "RHenigan", "createdAt": "2020-03-31T16:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ4OTg1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5MTA2Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400491063", "body": "it is better to use DebugTool for logging D/I messages", "bodyText": "it is better to use DebugTool for logging D/I messages", "bodyHTML": "<p dir=\"auto\">it is better to use DebugTool for logging D/I messages</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T21:01:12Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -376,16 +379,34 @@ private void downloadDeviceIcon(final String url){\n \t\t\t@Override\n \t\t\tpublic void run(){\n \t\t\t\ttry{\n-\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\tif(mLockScreenDeviceIconManager.updateCachedImage(url)) {\n+\t\t\t\t\t\tLog.d(TAG, \"URL: \" + url);\n+\t\t\t\t\t\tLog.d(TAG, \"Image Update Needed\");\n+\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tLog.d(TAG, \"Image Is Up To Date\");", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3MDQ4MQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401070481", "bodyText": "changed to. DebugTool", "author": "RHenigan", "createdAt": "2020-03-31T16:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5MTA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5Nzk0NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400497945", "body": "This doesn't always mean the image is up to date right? I believe the app will hit this else statement if the image is not cached at all. \r\nI suggest updating the log to be more clear or restructuring the if statements to separate the three cases to make it easier to follow:\r\n1-image not cached\r\n2-image cached and valid \r\n3-image cached but expired", "bodyText": "This doesn't always mean the image is up to date right? I believe the app will hit this else statement if the image is not cached at all.\nI suggest updating the log to be more clear or restructuring the if statements to separate the three cases to make it easier to follow:\n1-image not cached\n2-image cached and valid\n3-image cached but expired", "bodyHTML": "<p dir=\"auto\">This doesn't always mean the image is up to date right? I believe the app will hit this else statement if the image is not cached at all.<br>\nI suggest updating the log to be more clear or restructuring the if statements to separate the three cases to make it easier to follow:<br>\n1-image not cached<br>\n2-image cached and valid<br>\n3-image cached but expired</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T21:14:01Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -376,16 +379,34 @@ private void downloadDeviceIcon(final String url){\n \t\t\t@Override\n \t\t\tpublic void run(){\n \t\t\t\ttry{\n-\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\tif(mLockScreenDeviceIconManager.updateCachedImage(url)) {\n+\t\t\t\t\t\tLog.d(TAG, \"URL: \" + url);\n+\t\t\t\t\t\tLog.d(TAG, \"Image Update Needed\");\n+\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tLog.d(TAG, \"Image Is Up To Date\");", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEwNzA1NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401107055", "bodyText": "the method should only return false if the image is cached and valid, all other instances return true meaning we need to cache a new icon", "author": "RHenigan", "createdAt": "2020-03-31T17:58:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5Nzk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcwNDYwNQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401704605", "bodyText": "Ahh, gotcha. Can we name the method isIconCachedAndValid() in that case and flip the returned result accordingly? I think that makes it easier to follow what is happening.", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ5Nzk0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUwNDc4Nw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400504787", "body": "Would it be possible to reuse the method in `LockScreenDeviceIconManager()` by making it package-private?", "bodyText": "Would it be possible to reuse the method in LockScreenDeviceIconManager() by making it package-private?", "bodyHTML": "<p dir=\"auto\">Would it be possible to reuse the method in <code>LockScreenDeviceIconManager()</code> by making it package-private?</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T21:27:34Z", "path": "android/sdl_android/src/androidTest/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManagerTests.java", "diffHunk": "@@ -0,0 +1,242 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+import android.util.Log;\n+\n+import com.smartdevicelink.AndroidTestCase2;\n+import com.smartdevicelink.util.AndroidTools;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.Mockito;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.isNull;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+public class LockScreenDeviceIconManagerTests extends AndroidTestCase2 {\n+\n+    TemporaryFolder tempFolder = new TemporaryFolder();\n+    private LockScreenDeviceIconManager lockScreenDeviceIconManager;\n+    private static final String ICON_URL = \"http://i.imgur.com/TgkvOIZ.png\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_URL = \"storedUrl\";\n+    private static final String INVALID_JSON_STRING = \"Invalid JSON\";\n+\n+    public void setup() throws Exception {\n+        super.setUp();\n+    }\n+\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueWhenSharedPreferencesDoesNotExist() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(null);\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.updateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueWhenUnableToReadSharedPreference() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(INVALID_JSON_STRING);\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.updateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueSharedPreferenceReturnsAnOutdatedIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(35, \"\"));\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.updateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnFalseWhenSharedPreferenceReturnsAnUpdatedIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(15, \"\"));\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.updateCachedImage(ICON_URL);\n+        assertFalse(shouldUpdate);\n+    }\n+\n+    public void testSaveFileToCacheShouldReturnBeforeWritingSharedPrefsIfSavingToCacheFails() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+\n+        Bitmap deviceLogo = null;\n+        try {\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+            lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+            verify(sharedPrefs, times(0)).edit();\n+            verify(sharedPrefsEditor, times(0)).putString(anyString(), anyString());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void testSaveFileToCacheShouldWriteToSharedPrefsIfSaveIconIsSuccessful() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        try {\n+            tempFolder.create();\n+            Mockito.when(context.getCacheDir()).thenReturn(tempFolder.newFolder());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+        Bitmap deviceLogo = null;\n+        try {\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+            lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+            verify(sharedPrefs, times(1)).edit();\n+            verify(sharedPrefsEditor, times(1)).putString(anyString(), anyString());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfFailedToGetSystemPref() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(null);\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfInvalidDataFromSharedPref() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(INVALID_JSON_STRING);\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfFailedToFindIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(15, \"\"));\n+\n+        try {\n+            tempFolder.create();\n+            Mockito.when(context.getCacheDir()).thenReturn(tempFolder.newFolder());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnBitmapIfIconFoundInCache() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Bitmap deviceLogo = null;\n+\n+        try {\n+            tempFolder.create();\n+            File newFolder = tempFolder.newFolder();\n+            Mockito.when(context.getCacheDir()).thenReturn(newFolder);\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(15, newFolder.getPath() + \"/sdl/lock_screen_icon/\" + getMD5HashFromIconUrl(ICON_URL)));\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNotNull(cachedIcon);\n+    }\n+\n+    private String buildJSONAsString(long DaysOld, String cahceIconUrl) {\n+        JSONObject jsonObject = new JSONObject();\n+        try {\n+            jsonObject.put(STORED_URL, cahceIconUrl);\n+            long timeDifferenceInMilliSeconds = DaysOld * 1000 * 60 * 60 * 24;\n+            jsonObject.put(LAST_UPDATED_TIME, System.currentTimeMillis() - timeDifferenceInMilliSeconds);\n+            return jsonObject.toString();\n+        } catch (JSONException e) {\n+            e.printStackTrace();\n+            return null;\n+        }\n+    }\n+\n+    private String getMD5HashFromIconUrl(String iconUrl) {", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3NDU4Nw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401074587", "bodyText": "The way it is implemented I need to define the mock (using the md5 hash method) before the class in instantiated, if the class is instantiated before the mock is defined it breaks the test.", "author": "RHenigan", "createdAt": "2020-03-31T17:06:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUwNDc4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY4NTI2MQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401685261", "bodyText": "Will passing new LockScreenDeviceIconManager(null).getMD5HashFromIconUrl(ICON_URL)) work? we will have to check for null in the LockScreenDeviceIconManager constructor in that case.", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUwNDc4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxMDQxOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400510418", "body": "Do you think we can simplify that a bit by only storing the hash as key and the time as a value instead of saving the JSON in shared prefs?\r\n\r\ncurrently, this is how the share prefs xml look like. We save the hash twice. I feel that is unesceasry \r\n```\r\n<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\r\n<map>\r\n    <string name=\"935e06761f887b20a5a10242faaf6ecf\">{&quot;storedUrl&quot;:&quot;\\/data\\/user\\/0\\/io.livio.sdltestsuite.app1\\/cache\\/sdl\\/lock_screen_icon\\/935e06761f887b20a5a10242faaf6ecf&quot;,&quot;lastUpdatedTime&quot;:1585600940171}</string>\r\n</map>\r\n```\r\n\r\nCannot we just store them like that? This way we don't even need to make s JSON.\r\n```\r\n<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\r\n<map>\r\n    <string name=\"935e06761f887b20a5a10242faaf6ecf\">1585600940171</string>\r\n</map>\r\n```", "bodyText": "Do you think we can simplify that a bit by only storing the hash as key and the time as a value instead of saving the JSON in shared prefs?\ncurrently, this is how the share prefs xml look like. We save the hash twice. I feel that is unesceasry\n<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n<map>\n    <string name=\"935e06761f887b20a5a10242faaf6ecf\">{&quot;storedUrl&quot;:&quot;\\/data\\/user\\/0\\/io.livio.sdltestsuite.app1\\/cache\\/sdl\\/lock_screen_icon\\/935e06761f887b20a5a10242faaf6ecf&quot;,&quot;lastUpdatedTime&quot;:1585600940171}</string>\n</map>\n\nCannot we just store them like that? This way we don't even need to make s JSON.\n<?xml version='1.0' encoding='utf-8' standalone='yes' ?>\n<map>\n    <string name=\"935e06761f887b20a5a10242faaf6ecf\">1585600940171</string>\n</map>", "bodyHTML": "<p dir=\"auto\">Do you think we can simplify that a bit by only storing the hash as key and the time as a value instead of saving the JSON in shared prefs?</p>\n<p dir=\"auto\">currently, this is how the share prefs xml look like. We save the hash twice. I feel that is unesceasry</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"&lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt;\n&lt;map&gt;\n    &lt;string name=&quot;935e06761f887b20a5a10242faaf6ecf&quot;&gt;{&amp;quot;storedUrl&amp;quot;:&amp;quot;\\/data\\/user\\/0\\/io.livio.sdltestsuite.app1\\/cache\\/sdl\\/lock_screen_icon\\/935e06761f887b20a5a10242faaf6ecf&amp;quot;,&amp;quot;lastUpdatedTime&amp;quot;:1585600940171}&lt;/string&gt;\n&lt;/map&gt;\"><pre><code>&lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt;\n&lt;map&gt;\n    &lt;string name=\"935e06761f887b20a5a10242faaf6ecf\"&gt;{&amp;quot;storedUrl&amp;quot;:&amp;quot;\\/data\\/user\\/0\\/io.livio.sdltestsuite.app1\\/cache\\/sdl\\/lock_screen_icon\\/935e06761f887b20a5a10242faaf6ecf&amp;quot;,&amp;quot;lastUpdatedTime&amp;quot;:1585600940171}&lt;/string&gt;\n&lt;/map&gt;\n</code></pre></div>\n<p dir=\"auto\">Cannot we just store them like that? This way we don't even need to make s JSON.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"&lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt;\n&lt;map&gt;\n    &lt;string name=&quot;935e06761f887b20a5a10242faaf6ecf&quot;&gt;1585600940171&lt;/string&gt;\n&lt;/map&gt;\"><pre><code>&lt;?xml version='1.0' encoding='utf-8' standalone='yes' ?&gt;\n&lt;map&gt;\n    &lt;string name=\"935e06761f887b20a5a10242faaf6ecf\"&gt;1585600940171&lt;/string&gt;\n&lt;/map&gt;\n</code></pre></div>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T21:38:58Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+import android.util.Log;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_URL = \"storedUrl\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean updateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+        if(iconParameters == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return true;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(iconParameters);\n+                long lastUpdatedTime = 0;\n+                lastUpdatedTime = (long) jsonObject.get(LAST_UPDATED_TIME);\n+                long currentTime = System.currentTimeMillis();\n+\n+                long timeDifference = currentTime - lastUpdatedTime;\n+                long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+                return daysBetweenLastUpdate >= 30;\n+            } catch (JSONException e) {\n+                e.printStackTrace();\n+                DebugTool.logError(\"Exception Trying to read shared preferences\");\n+                return true;\n+            }\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapdata = bos.toByteArray();\n+\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapdata);\n+            fos.flush();\n+            fos.close();\n+        } catch (Exception e) {\n+            DebugTool.logError(\"Failed to save icon to cache\");\n+            e.printStackTrace();\n+            return;\n+        }\n+\n+        JSONObject iconParams;\n+        try {\n+            iconParams = buildDeviceIconParameters(f.getAbsolutePath());\n+            writeDeviceIconParametersToSystemPreferences(iconHash, iconParams);\n+        } catch (JSONException e) {\n+            DebugTool.logError(\"Failed to save to shared preferences, clearing cache icon directory\");\n+            clearIconDirectory();\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+\n+        if (iconParameters != null) {\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(iconParameters);\n+                String storedUrl = jsonObject.getString(STORED_URL);\n+                Bitmap cachedIcon = BitmapFactory.decodeFile(storedUrl);\n+                if(cachedIcon == null) {\n+                    DebugTool.logError(\"Failed to get Bitmap from decoding file cache\");\n+                    clearIconDirectory();\n+                    return null;\n+                } else {\n+                    return cachedIcon;\n+                }\n+            } catch (JSONException e) {\n+                DebugTool.logError(\"Failed to get file from cache, removing shared pref\");\n+                sharedPref.edit().remove(iconHash).commit();\n+                e.printStackTrace();\n+                return null;\n+            }\n+        } else {\n+            DebugTool.logError(\"Failed to get system preferences\");\n+            return null;\n+        }\n+    }\n+\n+    private void writeDeviceIconParametersToSystemPreferences(String iconHash, JSONObject jsonObject) {\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        SharedPreferences.Editor editor = sharedPref.edit();\n+        editor.putString(iconHash, jsonObject.toString());\n+        editor.commit();\n+    }\n+\n+    private JSONObject buildDeviceIconParameters(String storedUrl) throws JSONException {", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTEzODg5OA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401138898", "bodyText": "Implemented suggestion and fixed associated code", "author": "RHenigan", "createdAt": "2020-03-31T18:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxMDQxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxMjU3NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400512575", "body": "If I understand it correctly, this saves the file path, not the url right? If so, can we change the name to `filePath`  to make it easier to read?", "bodyText": "If I understand it correctly, this saves the file path, not the url right? If so, can we change the name to filePath  to make it easier to read?", "bodyHTML": "<p dir=\"auto\">If I understand it correctly, this saves the file path, not the url right? If so, can we change the name to <code>filePath</code>  to make it easier to read?</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T21:43:26Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+import android.util.Log;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_URL = \"storedUrl\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean updateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+        if(iconParameters == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return true;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(iconParameters);\n+                long lastUpdatedTime = 0;\n+                lastUpdatedTime = (long) jsonObject.get(LAST_UPDATED_TIME);\n+                long currentTime = System.currentTimeMillis();\n+\n+                long timeDifference = currentTime - lastUpdatedTime;\n+                long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+                return daysBetweenLastUpdate >= 30;\n+            } catch (JSONException e) {\n+                e.printStackTrace();\n+                DebugTool.logError(\"Exception Trying to read shared preferences\");\n+                return true;\n+            }\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapdata = bos.toByteArray();\n+\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapdata);\n+            fos.flush();\n+            fos.close();\n+        } catch (Exception e) {\n+            DebugTool.logError(\"Failed to save icon to cache\");\n+            e.printStackTrace();\n+            return;\n+        }\n+\n+        JSONObject iconParams;\n+        try {\n+            iconParams = buildDeviceIconParameters(f.getAbsolutePath());\n+            writeDeviceIconParametersToSystemPreferences(iconHash, iconParams);\n+        } catch (JSONException e) {\n+            DebugTool.logError(\"Failed to save to shared preferences, clearing cache icon directory\");\n+            clearIconDirectory();\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+\n+        if (iconParameters != null) {\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(iconParameters);\n+                String storedUrl = jsonObject.getString(STORED_URL);\n+                Bitmap cachedIcon = BitmapFactory.decodeFile(storedUrl);\n+                if(cachedIcon == null) {\n+                    DebugTool.logError(\"Failed to get Bitmap from decoding file cache\");\n+                    clearIconDirectory();\n+                    return null;\n+                } else {\n+                    return cachedIcon;\n+                }\n+            } catch (JSONException e) {\n+                DebugTool.logError(\"Failed to get file from cache, removing shared pref\");\n+                sharedPref.edit().remove(iconHash).commit();\n+                e.printStackTrace();\n+                return null;\n+            }\n+        } else {\n+            DebugTool.logError(\"Failed to get system preferences\");\n+            return null;\n+        }\n+    }\n+\n+    private void writeDeviceIconParametersToSystemPreferences(String iconHash, JSONObject jsonObject) {\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        SharedPreferences.Editor editor = sharedPref.edit();\n+        editor.putString(iconHash, jsonObject.toString());\n+        editor.commit();\n+    }\n+\n+    private JSONObject buildDeviceIconParameters(String storedUrl) throws JSONException {\n+        JSONObject parametersJson = new JSONObject();\n+        parametersJson.put(STORED_URL, storedUrl);", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3NzM5Mg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401077392", "bodyText": "Refactored", "author": "RHenigan", "createdAt": "2020-03-31T17:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxMjU3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDAyMw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400514023", "body": "```suggestion\r\n        byte[] bitmapData = bos.toByteArray();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    byte[] bitmapdata = bos.toByteArray();\n          \n          \n            \n                    byte[] bitmapData = bos.toByteArray();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">byte</span>[] <span class=\"x x-first x-last\">bitmapdata</span> <span class=\"pl-k\">=</span> bos<span class=\"pl-k\">.</span>toByteArray();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">byte</span>[] <span class=\"x x-first x-last\">bitmapData</span> <span class=\"pl-k\">=</span> bos<span class=\"pl-k\">.</span>toByteArray();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bilal-alsharifi", "createdAt": "2020-03-30T21:46:24Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+import android.util.Log;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_URL = \"storedUrl\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean updateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+        if(iconParameters == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return true;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(iconParameters);\n+                long lastUpdatedTime = 0;\n+                lastUpdatedTime = (long) jsonObject.get(LAST_UPDATED_TIME);\n+                long currentTime = System.currentTimeMillis();\n+\n+                long timeDifference = currentTime - lastUpdatedTime;\n+                long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+                return daysBetweenLastUpdate >= 30;\n+            } catch (JSONException e) {\n+                e.printStackTrace();\n+                DebugTool.logError(\"Exception Trying to read shared preferences\");\n+                return true;\n+            }\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapdata = bos.toByteArray();", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDUxNDIxOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r400514218", "body": "Can we remove the extra lines before and after this line?", "bodyText": "Can we remove the extra lines before and after this line?", "bodyHTML": "<p dir=\"auto\">Can we remove the extra lines before and after this line?</p>", "author": "bilal-alsharifi", "createdAt": "2020-03-30T21:46:48Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,164 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+import android.util.Log;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_URL = \"storedUrl\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean updateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+        if(iconParameters == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return true;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            JSONObject jsonObject = null;\n+            try {\n+                jsonObject = new JSONObject(iconParameters);\n+                long lastUpdatedTime = 0;\n+                lastUpdatedTime = (long) jsonObject.get(LAST_UPDATED_TIME);\n+                long currentTime = System.currentTimeMillis();\n+\n+                long timeDifference = currentTime - lastUpdatedTime;\n+                long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+                return daysBetweenLastUpdate >= 30;\n+            } catch (JSONException e) {\n+                e.printStackTrace();\n+                DebugTool.logError(\"Exception Trying to read shared preferences\");\n+                return true;\n+            }\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);", "originalCommit": "641a48ce265b0203cd24c4c58816b109a0569d61", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8facbe9d4102a10348060ff06b0b3195ffe00bb2", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/8facbe9d4102a10348060ff06b0b3195ffe00bb2", "message": "Update android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java\n\nCo-Authored-By: Bilal Alsharifi <599206+bilal-alsharifi@users.noreply.github.com>", "committedDate": "2020-03-31T17:01:31Z", "type": "commit"}, {"oid": "fcc44e9cdb1eb4e26e20c061a217c92fc22baed3", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/fcc44e9cdb1eb4e26e20c061a217c92fc22baed3", "message": "Fixes from PR Review", "committedDate": "2020-03-31T18:50:28Z", "type": "commit"}, {"oid": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/4105cbd349f557ea7af53647d268d2fc8cacd66d", "message": "Merge branch 'bugfix/issue_1316' of github.com:smartdevicelink/sdl_java_suite into bugfix/issue_1316", "committedDate": "2020-03-31T18:50:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY4NjMwNw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401686307", "body": "Can we remove the extra lines here?", "bodyText": "Can we remove the extra lines here?", "bodyHTML": "<p dir=\"auto\">Can we remove the extra lines here?</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:03:55Z", "path": "android/sdl_android/src/androidTest/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManagerTests.java", "diffHunk": "@@ -0,0 +1,251 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+\n+import com.smartdevicelink.AndroidTestCase2;\n+import com.smartdevicelink.util.AndroidTools;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.Mockito;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.isNull;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+public class LockScreenDeviceIconManagerTests extends AndroidTestCase2 {\n+\n+    TemporaryFolder tempFolder = new TemporaryFolder();\n+    private LockScreenDeviceIconManager lockScreenDeviceIconManager;\n+    private static final String ICON_URL = \"http://i.imgur.com/TgkvOIZ.png\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_PATH = \"storedPath\";\n+    private static final String INVALID_JSON_STRING = \"Invalid JSON\";\n+\n+    public void setup() throws Exception {\n+        super.setUp();\n+    }\n+\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueWhenSharedPreferencesDoesNotExist() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(null);\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueWhenUnableToReadSharedPreference() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(\"\");\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueSharedPreferenceReturnsAnOutdatedIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(daysToMillisecondsAsString(35));\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnFalseWhenSharedPreferenceReturnsAnUpdatedIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(daysToMillisecondsAsString(15));\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertFalse(shouldUpdate);\n+    }\n+\n+    public void testSaveFileToCacheShouldReturnBeforeWritingSharedPrefsIfSavingToCacheFails() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+\n+        Bitmap deviceLogo = null;\n+        try {\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+            lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+            verify(sharedPrefs, times(0)).edit();\n+            verify(sharedPrefsEditor, times(0)).putString(anyString(), anyString());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void testSaveFileToCacheShouldWriteToSharedPrefsIfSaveIconIsSuccessful() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        try {\n+            tempFolder.create();\n+            Mockito.when(context.getCacheDir()).thenReturn(tempFolder.newFolder());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+        Bitmap deviceLogo = null;\n+        try {\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+            lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+            verify(sharedPrefs, times(1)).edit();\n+            verify(sharedPrefsEditor, times(1)).putString(anyString(), anyString());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfFailedToGetSystemPref() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(null);\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfInvalidDataFromSharedPref() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(\"\");\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfFailedToFindIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(15, \"\"));\n+\n+        try {\n+            tempFolder.create();\n+            Mockito.when(context.getCacheDir()).thenReturn(tempFolder.newFolder());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnBitmapIfIconFoundInCache() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Bitmap deviceLogo = null;\n+\n+        try {\n+            tempFolder.create();\n+            File newFolder = tempFolder.newFolder();\n+            Mockito.when(context.getCacheDir()).thenReturn(newFolder);\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(15, newFolder.getPath() + \"/sdl/lock_screen_icon/\" + getMD5HashFromIconUrl(ICON_URL)));\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNotNull(cachedIcon);\n+    }\n+\n+    private String buildJSONAsString(long DaysOld, String cahceIconPath) {\n+        JSONObject jsonObject = new JSONObject();\n+        try {\n+            jsonObject.put(STORED_PATH, cahceIconPath);\n+            long timeDifferenceInMilliSeconds = DaysOld * 1000 * 60 * 60 * 24;\n+            jsonObject.put(LAST_UPDATED_TIME, System.currentTimeMillis() - timeDifferenceInMilliSeconds);\n+            return jsonObject.toString();\n+        } catch (JSONException e) {\n+            e.printStackTrace();\n+            return null;\n+        }\n+    }\n+\n+    private String getMD5HashFromIconUrl(String iconUrl) {\n+        String iconHash = null;\n+        try {\n+            MessageDigest md = MessageDigest.getInstance(\"MD5\");\n+            byte[] messageDigest = md.digest(iconUrl.getBytes());\n+            BigInteger no = new BigInteger(1, messageDigest);\n+            String hashtext = no.toString(16);\n+            while (hashtext.length() < 32) {\n+                hashtext = \"0\" + hashtext;\n+            }\n+            iconHash = hashtext;\n+        } catch (NoSuchAlgorithmException e) {\n+            e.printStackTrace();\n+        }\n+        return iconHash;\n+    }\n+\n+    private String daysToMillisecondsAsString(int days) {\n+        long milliSeconds = (long) days * 24 * 60 * 60 * 1000;\n+        long previousDay = System.currentTimeMillis() - milliSeconds;\n+        return previousDay + \"\";\n+    }\n+", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxMjEwOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401712108", "body": "the last three vars are not used anymore", "bodyText": "the last three vars are not used anymore", "bodyHTML": "<p dir=\"auto\">the last three vars are not used anymore</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:38:16Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxNzY4Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401717686", "body": "`iconParameters` has only the time now after removing the JOSN file. Can we rename the `iconParameters` var to `iconLastUpdatedTime`?", "bodyText": "iconParameters has only the time now after removing the JOSN file. Can we rename the iconParameters var to iconLastUpdatedTime?", "bodyHTML": "<p dir=\"auto\"><code>iconParameters</code> has only the time now after removing the JOSN file. Can we rename the <code>iconParameters</code> var to <code>iconLastUpdatedTime</code>?</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:45:55Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_PATH = \"storedPath\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean shouldUpdateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyMDExMw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401720113", "body": "```suggestion\r\n    private void writeDeviceIconParametersToSharedPreferences(String iconHash) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void writeDeviceIconParametersToSystemPreferences(String iconHash) {\n          \n          \n            \n                private void writeDeviceIconParametersToSharedPreferences(String iconHash) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">writeDeviceIconParametersToSystemPreferences</span>(<span class=\"pl-smi\">String</span> iconHash) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">writeDeviceIconParametersToSharedPreferences</span>(<span class=\"pl-smi\">String</span> iconHash) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:49:04Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_PATH = \"storedPath\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean shouldUpdateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+        if(iconParameters == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return true;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            long lastUpdatedTime = 0;\n+            try {\n+                lastUpdatedTime = Long.parseLong(iconParameters);\n+            } catch (NumberFormatException e) {\n+                DebugTool.logInfo(\"Invalid time stamp stored to shared preferences, clearing cache and share preferences\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+            }\n+            long currentTime = System.currentTimeMillis();\n+\n+            long timeDifference = currentTime - lastUpdatedTime;\n+            long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+            return daysBetweenLastUpdate >= 30;\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapData = bos.toByteArray();\n+\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapData);\n+            fos.flush();\n+            fos.close();\n+        } catch (Exception e) {\n+            DebugTool.logError(\"Failed to save icon to cache\");\n+            e.printStackTrace();\n+            return;\n+        }\n+\n+        writeDeviceIconParametersToSystemPreferences(iconHash);\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+\n+        if (iconParameters != null) {\n+            Bitmap cachedIcon = BitmapFactory.decodeFile(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH + \"/\" + iconHash);\n+            if(cachedIcon == null) {\n+                DebugTool.logError(\"Failed to get Bitmap from decoding file cache\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+                return null;\n+            } else {\n+                return cachedIcon;\n+            }\n+        } else {\n+            DebugTool.logError(\"Failed to get system preferences\");\n+            return null;\n+        }\n+    }\n+\n+    private void writeDeviceIconParametersToSystemPreferences(String iconHash) {", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyMTQwMw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401721403", "body": "I suggest using `String valueOf(long l)` instead of contacting an empty string to convert a long to string", "bodyText": "I suggest using String valueOf(long l) instead of contacting an empty string to convert a long to string", "bodyHTML": "<p dir=\"auto\">I suggest using <code>String valueOf(long l)</code> instead of contacting an empty string to convert a long to string</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:50:49Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_PATH = \"storedPath\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean shouldUpdateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+        if(iconParameters == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return true;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            long lastUpdatedTime = 0;\n+            try {\n+                lastUpdatedTime = Long.parseLong(iconParameters);\n+            } catch (NumberFormatException e) {\n+                DebugTool.logInfo(\"Invalid time stamp stored to shared preferences, clearing cache and share preferences\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+            }\n+            long currentTime = System.currentTimeMillis();\n+\n+            long timeDifference = currentTime - lastUpdatedTime;\n+            long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+            return daysBetweenLastUpdate >= 30;\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapData = bos.toByteArray();\n+\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapData);\n+            fos.flush();\n+            fos.close();\n+        } catch (Exception e) {\n+            DebugTool.logError(\"Failed to save icon to cache\");\n+            e.printStackTrace();\n+            return;\n+        }\n+\n+        writeDeviceIconParametersToSystemPreferences(iconHash);\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+\n+        if (iconParameters != null) {\n+            Bitmap cachedIcon = BitmapFactory.decodeFile(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH + \"/\" + iconHash);\n+            if(cachedIcon == null) {\n+                DebugTool.logError(\"Failed to get Bitmap from decoding file cache\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+                return null;\n+            } else {\n+                return cachedIcon;\n+            }\n+        } else {\n+            DebugTool.logError(\"Failed to get system preferences\");\n+            return null;\n+        }\n+    }\n+\n+    private void writeDeviceIconParametersToSystemPreferences(String iconHash) {\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        SharedPreferences.Editor editor = sharedPref.edit();\n+        editor.putString(iconHash, System.currentTimeMillis() + \"\");", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyMjM5NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401722394", "body": "```suggestion\r\n        String iconLastUpdatedTime = sharedPref.getString(iconHash, null);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String iconParameters = sharedPref.getString(iconHash, null);\n          \n          \n            \n                    String iconLastUpdatedTime = sharedPref.getString(iconHash, null);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">String</span> <span class=\"x x-first x-last\">iconParameters</span> <span class=\"pl-k\">=</span> sharedPref<span class=\"pl-k\">.</span>getString(iconHash, <span class=\"pl-c1\">null</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">String</span> <span class=\"x x-first x-last\">iconLastUpdatedTime</span> <span class=\"pl-k\">=</span> sharedPref<span class=\"pl-k\">.</span>getString(iconHash, <span class=\"pl-c1\">null</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:52:16Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,137 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_PATH = \"storedPath\";\n+    private static final String TAG = \"LockScreenManager\";\n+\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean shouldUpdateCachedImage(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);\n+        if(iconParameters == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return true;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            long lastUpdatedTime = 0;\n+            try {\n+                lastUpdatedTime = Long.parseLong(iconParameters);\n+            } catch (NumberFormatException e) {\n+                DebugTool.logInfo(\"Invalid time stamp stored to shared preferences, clearing cache and share preferences\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+            }\n+            long currentTime = System.currentTimeMillis();\n+\n+            long timeDifference = currentTime - lastUpdatedTime;\n+            long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+            return daysBetweenLastUpdate >= 30;\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapData = bos.toByteArray();\n+\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapData);\n+            fos.flush();\n+            fos.close();\n+        } catch (Exception e) {\n+            DebugTool.logError(\"Failed to save icon to cache\");\n+            e.printStackTrace();\n+            return;\n+        }\n+\n+        writeDeviceIconParametersToSystemPreferences(iconHash);\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconParameters = sharedPref.getString(iconHash, null);", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyNDU0Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401724546", "body": "this is unused ", "bodyText": "this is unused", "bodyHTML": "<p dir=\"auto\">this is unused</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:55:09Z", "path": "android/sdl_android/src/androidTest/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManagerTests.java", "diffHunk": "@@ -0,0 +1,251 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+\n+import com.smartdevicelink.AndroidTestCase2;\n+import com.smartdevicelink.util.AndroidTools;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.Mockito;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.isNull;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+public class LockScreenDeviceIconManagerTests extends AndroidTestCase2 {\n+\n+    TemporaryFolder tempFolder = new TemporaryFolder();\n+    private LockScreenDeviceIconManager lockScreenDeviceIconManager;\n+    private static final String ICON_URL = \"http://i.imgur.com/TgkvOIZ.png\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_PATH = \"storedPath\";\n+    private static final String INVALID_JSON_STRING = \"Invalid JSON\";", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcyNTU5NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r401725595", "body": "I am not sure why we still need that method if JSON is not used anymore", "bodyText": "I am not sure why we still need that method if JSON is not used anymore", "bodyHTML": "<p dir=\"auto\">I am not sure why we still need that method if JSON is not used anymore</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-01T15:56:38Z", "path": "android/sdl_android/src/androidTest/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManagerTests.java", "diffHunk": "@@ -0,0 +1,251 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+\n+import com.smartdevicelink.AndroidTestCase2;\n+import com.smartdevicelink.util.AndroidTools;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+import org.junit.rules.TemporaryFolder;\n+import org.mockito.Mockito;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.isNull;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+\n+public class LockScreenDeviceIconManagerTests extends AndroidTestCase2 {\n+\n+    TemporaryFolder tempFolder = new TemporaryFolder();\n+    private LockScreenDeviceIconManager lockScreenDeviceIconManager;\n+    private static final String ICON_URL = \"http://i.imgur.com/TgkvOIZ.png\";\n+    private static final String LAST_UPDATED_TIME = \"lastUpdatedTime\";\n+    private static final String STORED_PATH = \"storedPath\";\n+    private static final String INVALID_JSON_STRING = \"Invalid JSON\";\n+\n+    public void setup() throws Exception {\n+        super.setUp();\n+    }\n+\n+    public void tearDown() throws Exception {\n+        super.tearDown();\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueWhenSharedPreferencesDoesNotExist() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(null);\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueWhenUnableToReadSharedPreference() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(\"\");\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnTrueSharedPreferenceReturnsAnOutdatedIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(daysToMillisecondsAsString(35));\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertTrue(shouldUpdate);\n+    }\n+\n+    public void testUpdateCacheImageShouldReturnFalseWhenSharedPreferenceReturnsAnUpdatedIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(daysToMillisecondsAsString(15));\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        boolean shouldUpdate = lockScreenDeviceIconManager.shouldUpdateCachedImage(ICON_URL);\n+        assertFalse(shouldUpdate);\n+    }\n+\n+    public void testSaveFileToCacheShouldReturnBeforeWritingSharedPrefsIfSavingToCacheFails() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+\n+        Bitmap deviceLogo = null;\n+        try {\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+            lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+            verify(sharedPrefs, times(0)).edit();\n+            verify(sharedPrefsEditor, times(0)).putString(anyString(), anyString());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void testSaveFileToCacheShouldWriteToSharedPrefsIfSaveIconIsSuccessful() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        try {\n+            tempFolder.create();\n+            Mockito.when(context.getCacheDir()).thenReturn(tempFolder.newFolder());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+        Bitmap deviceLogo = null;\n+        try {\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+            lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+            verify(sharedPrefs, times(1)).edit();\n+            verify(sharedPrefsEditor, times(1)).putString(anyString(), anyString());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfFailedToGetSystemPref() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(null);\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfInvalidDataFromSharedPref() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(\"\");\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnNullIfFailedToFindIcon() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(15, \"\"));\n+\n+        try {\n+            tempFolder.create();\n+            Mockito.when(context.getCacheDir()).thenReturn(tempFolder.newFolder());\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNull(cachedIcon);\n+    }\n+\n+    public void testGetFileFromCacheShouldReturnBitmapIfIconFoundInCache() {\n+        final SharedPreferences sharedPrefs = Mockito.mock(SharedPreferences.class);\n+        final SharedPreferences.Editor sharedPrefsEditor = Mockito.mock(SharedPreferences.Editor.class);\n+        final Context context = Mockito.mock(Context.class);\n+        Mockito.when(context.getSharedPreferences(anyString(), anyInt())).thenReturn(sharedPrefs);\n+        Mockito.when(sharedPrefs.edit()).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.remove(anyString())).thenReturn(sharedPrefsEditor);\n+        Mockito.when(sharedPrefsEditor.commit()).thenReturn(true);\n+        Bitmap deviceLogo = null;\n+\n+        try {\n+            tempFolder.create();\n+            File newFolder = tempFolder.newFolder();\n+            Mockito.when(context.getCacheDir()).thenReturn(newFolder);\n+            deviceLogo = AndroidTools.downloadImage(ICON_URL);\n+            Mockito.when(sharedPrefs.getString(anyString(), (String) isNull())).thenReturn(buildJSONAsString(15, newFolder.getPath() + \"/sdl/lock_screen_icon/\" + getMD5HashFromIconUrl(ICON_URL)));\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+        }\n+\n+        lockScreenDeviceIconManager = new LockScreenDeviceIconManager(context);\n+        lockScreenDeviceIconManager.saveFileToCache(deviceLogo, ICON_URL);\n+        Bitmap cachedIcon = lockScreenDeviceIconManager.getFileFromCache(ICON_URL);\n+        assertNotNull(cachedIcon);\n+    }\n+\n+    private String buildJSONAsString(long DaysOld, String cahceIconPath) {", "originalCommit": "4105cbd349f557ea7af53647d268d2fc8cacd66d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8f0062e2da867e9e19b48d52bfb3d36f85ca6e74", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/8f0062e2da867e9e19b48d52bfb3d36f85ca6e74", "message": "Updates based on PR feedback", "committedDate": "2020-04-01T17:10:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU1MjU0NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r402552544", "body": "```suggestion\r\n    private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\r\n```\r\n\r\nJust a suggestion to be clear with file and directory naming", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n          \n          \n            \n                private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\n          \n      \n    \n    \n  \n\nJust a suggestion to be clear with file and directory naming", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">STORED_ICON_PATH</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>sdl/lock_screen_icon/<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">STORED_ICON_DIRECTORY_PATH</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>sdl/lock_screen_icon/<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Just a suggestion to be clear with file and directory naming</p>", "author": "joeljfischer", "createdAt": "2020-04-02T19:16:15Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";", "originalCommit": "8f0062e2da867e9e19b48d52bfb3d36f85ca6e74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MDAxNA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r402560014", "body": "On iOS, this logic is all contained by the `SDLCacheFileManager` (your `LockScreenDeviceIconManager`) itself, I think that's a better solution. iOS calls a method with a completion handler that returns either an image or an error.", "bodyText": "On iOS, this logic is all contained by the SDLCacheFileManager (your LockScreenDeviceIconManager) itself, I think that's a better solution. iOS calls a method with a completion handler that returns either an image or an error.", "bodyHTML": "<p dir=\"auto\">On iOS, this logic is all contained by the <code>SDLCacheFileManager</code> (your <code>LockScreenDeviceIconManager</code>) itself, I think that's a better solution. iOS calls a method with a completion handler that returns either an image or an error.</p>", "author": "joeljfischer", "createdAt": "2020-04-02T19:29:43Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -376,16 +380,31 @@ private void downloadDeviceIcon(final String url){\n \t\t\t@Override\n \t\t\tpublic void run(){\n \t\t\t\ttry{\n-\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\tif(mLockScreenDeviceIconManager.isIconCachedAndValid(url)) {\n+\t\t\t\t\t\tDebugTool.logInfo(\"Image Is Up To Date\");\n+\t\t\t\t\t\tdeviceLogo = mLockScreenDeviceIconManager.getFileFromCache(url);\n+\t\t\t\t\t\tif (deviceLogo == null) {\n+\t\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tDebugTool.logInfo(\"Lock Screen Icon Update Needed\");\n+\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n+\t\t\t\t\t}\n+\t\t\t\t} catch(IOException e){\n+\t\t\t\t\tLog.e(TAG, \"device Icon Error Downloading, Will attempt to grab cached Icon even if expired: \\n\" + e.toString());\n+\t\t\t\t\tdeviceLogo = mLockScreenDeviceIconManager.getFileFromCache(url);\n+\t\t\t\t}", "originalCommit": "8f0062e2da867e9e19b48d52bfb3d36f85ca6e74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMzE0Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r403133143", "bodyText": "Logic pulled into LockScreenDeviceIconManager", "author": "RHenigan", "createdAt": "2020-04-03T16:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MDAxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4Mjc1Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r402582753", "body": "As mentioned above, I think a better entry into this class is something like:\r\n\r\n```java\r\nvoid retrieveIcon(String iconURL, OnImageRetrievedListener imageRetrievedListener)\r\n```\r\n\r\nWhere `OnImageRetrievedListener` is something like:\r\n\r\n```java\r\ninterface OnImageRetrievedListener {\r\n\tvoid onImageRetrieved(Bitmap icon);\r\n\tvoid onError(String info);\r\n}\r\n```", "bodyText": "As mentioned above, I think a better entry into this class is something like:\nvoid retrieveIcon(String iconURL, OnImageRetrievedListener imageRetrievedListener)\nWhere OnImageRetrievedListener is something like:\ninterface OnImageRetrievedListener {\n\tvoid onImageRetrieved(Bitmap icon);\n\tvoid onError(String info);\n}", "bodyHTML": "<p dir=\"auto\">As mentioned above, I think a better entry into this class is something like:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"void retrieveIcon(String iconURL, OnImageRetrievedListener imageRetrievedListener)\"><pre><span class=\"pl-k\">void</span> retrieveIcon(<span class=\"pl-smi\">String</span> iconURL, <span class=\"pl-smi\">OnImageRetrievedListener</span> imageRetrievedListener)</pre></div>\n<p dir=\"auto\">Where <code>OnImageRetrievedListener</code> is something like:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"interface OnImageRetrievedListener {\n\tvoid onImageRetrieved(Bitmap icon);\n\tvoid onError(String info);\n}\"><pre><span class=\"pl-k\">interface</span> <span class=\"pl-en\">OnImageRetrievedListener</span> {\n\t<span class=\"pl-k\">void</span> <span class=\"pl-en\">onImageRetrieved</span>(<span class=\"pl-smi\">Bitmap</span> <span class=\"pl-v\">icon</span>);\n\t<span class=\"pl-k\">void</span> <span class=\"pl-en\">onError</span>(<span class=\"pl-smi\">String</span> <span class=\"pl-v\">info</span>);\n}</pre></div>", "author": "joeljfischer", "createdAt": "2020-04-02T20:12:07Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean isIconCachedAndValid(String iconUrl) {", "originalCommit": "8f0062e2da867e9e19b48d52bfb3d36f85ca6e74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMzc0Ng==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r403133746", "bodyText": "OnIconRetrievedListener Implemented", "author": "RHenigan", "createdAt": "2020-04-03T16:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4Mjc1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4NTEzOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r402585138", "body": "```suggestion\r\n    private String getMD5HashFromIconUrl(String iconUrl) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String getMD5HashFromIconUrl(String iconUrl) {\n          \n          \n            \n                private String getMD5HashFromIconUrl(String iconUrl) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-smi\">String</span> getMD5HashFromIconUrl(<span class=\"pl-smi\">String</span> iconUrl) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k x x-first\">private</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">String</span> getMD5HashFromIconUrl(<span class=\"pl-smi\">String</span> iconUrl) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "joeljfischer", "createdAt": "2020-04-02T20:17:27Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean isIconCachedAndValid(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconLastUpdatedTime = sharedPref.getString(iconHash, null);\n+        if(iconLastUpdatedTime == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return false;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            long lastUpdatedTime = 0;\n+            try {\n+                lastUpdatedTime = Long.parseLong(iconLastUpdatedTime);\n+            } catch (NumberFormatException e) {\n+                DebugTool.logInfo(\"Invalid time stamp stored to shared preferences, clearing cache and share preferences\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+            }\n+            long currentTime = System.currentTimeMillis();\n+\n+            long timeDifference = currentTime - lastUpdatedTime;\n+            long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+            return daysBetweenLastUpdate < 30;\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapData = bos.toByteArray();\n+\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapData);\n+            fos.flush();\n+            fos.close();\n+        } catch (Exception e) {\n+            DebugTool.logError(\"Failed to save icon to cache\");\n+            e.printStackTrace();\n+            return;\n+        }\n+\n+        writeDeviceIconParametersToSharedPreferences(iconHash);\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconLastUpdatedTime = sharedPref.getString(iconHash, null);\n+\n+        if (iconLastUpdatedTime != null) {\n+            Bitmap cachedIcon = BitmapFactory.decodeFile(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH + \"/\" + iconHash);\n+            if(cachedIcon == null) {\n+                DebugTool.logError(\"Failed to get Bitmap from decoding file cache\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+                return null;\n+            } else {\n+                return cachedIcon;\n+            }\n+        } else {\n+            DebugTool.logError(\"Failed to get system preferences\");\n+            return null;\n+        }\n+    }\n+\n+    private void writeDeviceIconParametersToSharedPreferences(String iconHash) {\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        SharedPreferences.Editor editor = sharedPref.edit();\n+        editor.putString(iconHash, String.valueOf(System.currentTimeMillis()));\n+        editor.commit();\n+    }\n+\n+    String getMD5HashFromIconUrl(String iconUrl) {", "originalCommit": "8f0062e2da867e9e19b48d52bfb3d36f85ca6e74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk5ODY1NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r402998655", "bodyText": "This was changed to be package private to access from the tests to avoid duplicating this method in the test", "author": "RHenigan", "createdAt": "2020-04-03T13:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4NTEzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMzQ0OA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r403133448", "bodyText": "No longer needed in tests, method made private", "author": "RHenigan", "createdAt": "2020-04-03T16:36:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4NTEzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4NzkwMg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r402587902", "body": "Can this be `private`?", "bodyText": "Can this be private?", "bodyHTML": "<p dir=\"auto\">Can this be <code>private</code>?</p>", "author": "joeljfischer", "createdAt": "2020-04-02T20:24:11Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,130 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.DebugTool;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    boolean isIconCachedAndValid(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconLastUpdatedTime = sharedPref.getString(iconHash, null);\n+        if(iconLastUpdatedTime == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return false;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            long lastUpdatedTime = 0;\n+            try {\n+                lastUpdatedTime = Long.parseLong(iconLastUpdatedTime);\n+            } catch (NumberFormatException e) {\n+                DebugTool.logInfo(\"Invalid time stamp stored to shared preferences, clearing cache and share preferences\");\n+                clearIconDirectory();\n+                sharedPref.edit().remove(iconHash).commit();\n+            }\n+            long currentTime = System.currentTimeMillis();\n+\n+            long timeDifference = currentTime - lastUpdatedTime;\n+            long daysBetweenLastUpdate = timeDifference / (1000 * 60 * 60 * 24);\n+            return daysBetweenLastUpdate < 30;\n+        }\n+    }\n+\n+    void saveFileToCache(Bitmap icon, String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        File f = new File(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH, iconHash);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+        icon.compress(Bitmap.CompressFormat.PNG, 0 /*ignored for PNG*/, bos);\n+        byte[] bitmapData = bos.toByteArray();\n+\n+        FileOutputStream fos = null;\n+        try {\n+            fos = new FileOutputStream(f);\n+            fos.write(bitmapData);\n+            fos.flush();\n+            fos.close();\n+        } catch (Exception e) {\n+            DebugTool.logError(\"Failed to save icon to cache\");\n+            e.printStackTrace();\n+            return;\n+        }\n+\n+        writeDeviceIconParametersToSharedPreferences(iconHash);\n+    }\n+\n+    Bitmap getFileFromCache(String iconUrl) {", "originalCommit": "8f0062e2da867e9e19b48d52bfb3d36f85ca6e74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEzMzUyOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r403133528", "bodyText": "made private", "author": "RHenigan", "createdAt": "2020-04-03T16:36:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4NzkwMg=="}], "type": "inlineReview"}, {"oid": "f9b3dba9e36564e370de47e08610077a5f933c5c", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/f9b3dba9e36564e370de47e08610077a5f933c5c", "message": "Pull logic into DeviceIconManager and use listener", "committedDate": "2020-04-03T15:40:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5OTAzNA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404299034", "body": "```suggestion\r\n                // The icon is unknown or expired. Download the image, save it to the cache, and update the archive file\r\n                DebugTool.logInfo(\"Lock Screen Icon Update Needed\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            DebugTool.logInfo(\"Lock Screen Icon Update Needed\");\n          \n          \n            \n                            // The icon is unknown or expired. Download the image, save it to the cache, and update the archive file\n          \n          \n            \n                            DebugTool.logInfo(\"Lock Screen Icon Update Needed\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"67\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi x x-first\">DebugTool</span><span class=\"pl-k x\">.</span><span class=\"x\">logInfo(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">Lock Screen Icon Update Needed</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">);</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"67\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-c\"><span class=\"pl-c x x-first\">//</span><span class=\"x x-last\"> The icon is unknown or expired. Download the image, save it to the cache, and update the archive file</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"68\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">DebugTool</span><span class=\"pl-k\">.</span>logInfo(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Lock Screen Icon Update Needed<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "joeljfischer", "createdAt": "2020-04-06T18:25:41Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -18,15 +20,45 @@\n \n     private Context context;\n     private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n-    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\n+\n+    interface OnIconRetrievedListener {\n+        void onImageRetrieved(Bitmap icon);\n+        void onError(String info);\n+    }\n \n     LockScreenDeviceIconManager(Context context) {\n         this.context = context;\n-        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_DIRECTORY_PATH);\n         lockScreenDirectory.mkdirs();\n     }\n \n-    boolean isIconCachedAndValid(String iconUrl) {\n+    void retrieveIcon(String iconURL, OnIconRetrievedListener iconRetrievedListener) {\n+        Bitmap icon = null;\n+        try {\n+            if (isIconCachedAndValid(iconURL)) {\n+                DebugTool.logInfo(\"Icon Is Up To Date\");\n+                icon = getFileFromCache(iconURL);\n+                if (icon == null) {\n+                    DebugTool.logInfo(\"Icon from cache was null, attempting to re-download\");\n+                    icon = AndroidTools.downloadImage(iconURL);\n+                    saveFileToCache(icon, iconURL);\n+                }\n+                iconRetrievedListener.onImageRetrieved(icon);\n+            } else {\n+                DebugTool.logInfo(\"Lock Screen Icon Update Needed\");", "originalCommit": "f9b3dba9e36564e370de47e08610077a5f933c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NDU4OQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404984589", "bodyText": "added", "author": "RHenigan", "createdAt": "2020-04-07T17:26:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5OTAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4ODY3OA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404788678", "body": "Please add documentation to all methods", "bodyText": "Please add documentation to all methods", "bodyHTML": "<p dir=\"auto\">Please add documentation to all methods</p>", "author": "joeljfischer", "createdAt": "2020-04-07T13:00:01Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -18,15 +20,45 @@\n \n     private Context context;\n     private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n-    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\n+\n+    interface OnIconRetrievedListener {\n+        void onImageRetrieved(Bitmap icon);\n+        void onError(String info);\n+    }\n \n     LockScreenDeviceIconManager(Context context) {\n         this.context = context;\n-        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_DIRECTORY_PATH);\n         lockScreenDirectory.mkdirs();\n     }\n \n-    boolean isIconCachedAndValid(String iconUrl) {\n+    void retrieveIcon(String iconURL, OnIconRetrievedListener iconRetrievedListener) {", "originalCommit": "f9b3dba9e36564e370de47e08610077a5f933c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA5NzM5NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405097394", "bodyText": "Documentation added, If you have any feedback or feel I am missing any details please let me know", "author": "RHenigan", "createdAt": "2020-04-07T20:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4ODY3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5MDQ2MQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404790461", "body": "Do you want to write the icon parameters to shared prefs if the write of the image to disk failed?", "bodyText": "Do you want to write the icon parameters to shared prefs if the write of the image to disk failed?", "bodyHTML": "<p dir=\"auto\">Do you want to write the icon parameters to shared prefs if the write of the image to disk failed?</p>", "author": "joeljfischer", "createdAt": "2020-04-07T13:02:40Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -73,13 +105,13 @@ void saveFileToCache(Bitmap icon, String iconUrl) {\n         writeDeviceIconParametersToSharedPreferences(iconHash);", "originalCommit": "f9b3dba9e36564e370de47e08610077a5f933c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NDQyMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404984421", "bodyText": "moved call to be within the try block, if write fails details will no longer be saved to shared preferences", "author": "RHenigan", "createdAt": "2020-04-07T17:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5MDQ2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg0MjU5MQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404842591", "body": "If the icon is `null` here, it should return an error, right?", "bodyText": "If the icon is null here, it should return an error, right?", "bodyHTML": "<p dir=\"auto\">If the icon is <code>null</code> here, it should return an error, right?</p>", "author": "joeljfischer", "createdAt": "2020-04-07T14:14:43Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -18,15 +20,45 @@\n \n     private Context context;\n     private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n-    private static final String STORED_ICON_PATH = \"sdl/lock_screen_icon/\";\n+    private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\n+\n+    interface OnIconRetrievedListener {\n+        void onImageRetrieved(Bitmap icon);\n+        void onError(String info);\n+    }\n \n     LockScreenDeviceIconManager(Context context) {\n         this.context = context;\n-        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_PATH);\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_DIRECTORY_PATH);\n         lockScreenDirectory.mkdirs();\n     }\n \n-    boolean isIconCachedAndValid(String iconUrl) {\n+    void retrieveIcon(String iconURL, OnIconRetrievedListener iconRetrievedListener) {\n+        Bitmap icon = null;\n+        try {\n+            if (isIconCachedAndValid(iconURL)) {\n+                DebugTool.logInfo(\"Icon Is Up To Date\");\n+                icon = getFileFromCache(iconURL);\n+                if (icon == null) {\n+                    DebugTool.logInfo(\"Icon from cache was null, attempting to re-download\");\n+                    icon = AndroidTools.downloadImage(iconURL);\n+                    saveFileToCache(icon, iconURL);\n+                }\n+                iconRetrievedListener.onImageRetrieved(icon);\n+            } else {\n+                DebugTool.logInfo(\"Lock Screen Icon Update Needed\");\n+                icon = AndroidTools.downloadImage(iconURL);\n+                saveFileToCache(icon, iconURL);\n+                iconRetrievedListener.onImageRetrieved(icon);\n+            }\n+        } catch (IOException e) {\n+            iconRetrievedListener.onError(\"device Icon Error Downloading, Will attempt to grab cached Icon even if expired: \\n\" + e.toString());\n+            icon = getFileFromCache(iconURL);", "originalCommit": "f9b3dba9e36564e370de47e08610077a5f933c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4NTA1MA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404985050", "bodyText": "added check, will call onError if downloaded icon is null", "author": "RHenigan", "createdAt": "2020-04-07T17:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg0MjU5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2NjE2MQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404866161", "body": "I don't think that this is necessarily what we want to do here, unlike iOS. On iOS, all the image file information is contained in one file. So on iOS, when you clear the icon directory, the file went along with it. Here, if the directory is cleared, all the icon information remains in `SharedPreferences`. That means that attempting to retrieve an icon may fail and then we'll have a cascading set of retrieval failures because old data is contained in `SharedPreferences` that we know isn't accurate.\r\n\r\nI can think of a few possibilities to solve this:\r\n1. We don't clear the icon directory if an error occurs. This isn't aligned with iOS' mitigation strategy and has the possibility of leaving icons in the directory that are unused.\r\n2. Instead of storing the data in separate SharedPreferences keys, use a single key, store the information in JSON and store the JSON in the SharedPreferences under that single key. Then when you clear the icon directory, you clear the JSON document as well.", "bodyText": "I don't think that this is necessarily what we want to do here, unlike iOS. On iOS, all the image file information is contained in one file. So on iOS, when you clear the icon directory, the file went along with it. Here, if the directory is cleared, all the icon information remains in SharedPreferences. That means that attempting to retrieve an icon may fail and then we'll have a cascading set of retrieval failures because old data is contained in SharedPreferences that we know isn't accurate.\nI can think of a few possibilities to solve this:\n\nWe don't clear the icon directory if an error occurs. This isn't aligned with iOS' mitigation strategy and has the possibility of leaving icons in the directory that are unused.\nInstead of storing the data in separate SharedPreferences keys, use a single key, store the information in JSON and store the JSON in the SharedPreferences under that single key. Then when you clear the icon directory, you clear the JSON document as well.", "bodyHTML": "<p dir=\"auto\">I don't think that this is necessarily what we want to do here, unlike iOS. On iOS, all the image file information is contained in one file. So on iOS, when you clear the icon directory, the file went along with it. Here, if the directory is cleared, all the icon information remains in <code>SharedPreferences</code>. That means that attempting to retrieve an icon may fail and then we'll have a cascading set of retrieval failures because old data is contained in <code>SharedPreferences</code> that we know isn't accurate.</p>\n<p dir=\"auto\">I can think of a few possibilities to solve this:</p>\n<ol dir=\"auto\">\n<li>We don't clear the icon directory if an error occurs. This isn't aligned with iOS' mitigation strategy and has the possibility of leaving icons in the directory that are unused.</li>\n<li>Instead of storing the data in separate SharedPreferences keys, use a single key, store the information in JSON and store the JSON in the SharedPreferences under that single key. Then when you clear the icon directory, you clear the JSON document as well.</li>\n</ol>", "author": "joeljfischer", "createdAt": "2020-04-07T14:44:47Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -73,13 +105,13 @@ void saveFileToCache(Bitmap icon, String iconUrl) {\n         writeDeviceIconParametersToSharedPreferences(iconHash);\n     }\n \n-    Bitmap getFileFromCache(String iconUrl) {\n+    private Bitmap getFileFromCache(String iconUrl) {\n         String iconHash = getMD5HashFromIconUrl(iconUrl);\n         SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n         String iconLastUpdatedTime = sharedPref.getString(iconHash, null);\n \n         if (iconLastUpdatedTime != null) {\n-            Bitmap cachedIcon = BitmapFactory.decodeFile(this.context.getCacheDir() + \"/\" + STORED_ICON_PATH + \"/\" + iconHash);\n+            Bitmap cachedIcon = BitmapFactory.decodeFile(this.context.getCacheDir() + \"/\" + STORED_ICON_DIRECTORY_PATH + \"/\" + iconHash);\n             if(cachedIcon == null) {\n                 DebugTool.logError(\"Failed to get Bitmap from decoding file cache\");\n                 clearIconDirectory();", "originalCommit": "f9b3dba9e36564e370de47e08610077a5f933c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MjQ4NQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404982485", "bodyText": "I see what you mean, we would also have the option of sharedPref.edit().clear().commit();\nhttps://developer.android.com/reference/android/content/SharedPreferences.Editor#clear()\nwould this be closer to the ios implementation?", "author": "RHenigan", "createdAt": "2020-04-07T17:22:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2NjE2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NjYzMg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405076632", "bodyText": "If that clears all data about cached icons and their expiration dates, then yes, I believe it would.", "author": "joeljfischer", "createdAt": "2020-04-07T20:00:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2NjE2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2Njc4NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404866784", "body": "The indentation seems off on these", "bodyText": "The indentation seems off on these", "bodyHTML": "<p dir=\"auto\">The indentation seems off on these</p>", "author": "joeljfischer", "createdAt": "2020-04-07T14:45:40Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -379,23 +379,17 @@ private void downloadDeviceIcon(final String url){\n \t\tnew Thread(new Runnable(){\n \t\t\t@Override\n \t\t\tpublic void run(){\n-\t\t\t\ttry{\n-\t\t\t\t\tif(mLockScreenDeviceIconManager.isIconCachedAndValid(url)) {\n-\t\t\t\t\t\tDebugTool.logInfo(\"Image Is Up To Date\");\n-\t\t\t\t\t\tdeviceLogo = mLockScreenDeviceIconManager.getFileFromCache(url);\n-\t\t\t\t\t\tif (deviceLogo == null) {\n-\t\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n-\t\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tDebugTool.logInfo(\"Lock Screen Icon Update Needed\");\n-\t\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n-\t\t\t\t\t\tmLockScreenDeviceIconManager.saveFileToCache(deviceLogo, url);\n+\t\t\t\tmLockScreenDeviceIconManager.retrieveIcon(url, new LockScreenDeviceIconManager.OnIconRetrievedListener() {", "originalCommit": "f9b3dba9e36564e370de47e08610077a5f933c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3NjU5MA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r404976590", "bodyText": "this is the removed code, the new code seems aligned correctly with the run method above to me.", "author": "RHenigan", "createdAt": "2020-04-07T17:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2Njc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NDkzMg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405074932", "bodyText": "I just pulled your latest updates, it still appears incorrect on the new code. They appear to have an extra tab of indentation.", "author": "joeljfischer", "createdAt": "2020-04-07T19:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2Njc4NA=="}], "type": "inlineReview"}, {"oid": "0259aba1670b0268e61490f7e55d141132afd314", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/0259aba1670b0268e61490f7e55d141132afd314", "message": "Adding documentation and PR changes", "committedDate": "2020-04-07T18:01:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4NDA0Mg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405084042", "body": "If the `getFileFromCache` returns a null icon, it shouldn't return it here. It should return an error through the `onImageRetrieved`, right?", "bodyText": "If the getFileFromCache returns a null icon, it shouldn't return it here. It should return an error through the onImageRetrieved, right?", "bodyHTML": "<p dir=\"auto\">If the <code>getFileFromCache</code> returns a null icon, it shouldn't return it here. It should return an error through the <code>onImageRetrieved</code>, right?</p>", "author": "joeljfischer", "createdAt": "2020-04-07T20:14:34Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,205 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.AndroidTools;\n+import com.smartdevicelink.util.DebugTool;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+/**\n+ * <strong>LockScreenDeviceIconManager</strong> <br>\n+ *\n+ * The LockScreenDeviceIconManager handles the logic of caching and retrieving cached lock screen icons <br>\n+ *\n+ */\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\n+\n+    interface OnIconRetrievedListener {\n+        void onImageRetrieved(Bitmap icon);\n+        void onError(String info);\n+    }\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_DIRECTORY_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    /**\n+     * Will try to return a lock screen icon either from cache or downloaded\n+     * if it fails iconRetrievedListener.OnError will be called with corresponding error message\n+     * @param iconURL url that the lock screen icon is downloaded from\n+     * @param iconRetrievedListener an interface that will implement onIconReceived and OnError methods\n+     */\n+    void retrieveIcon(String iconURL, OnIconRetrievedListener iconRetrievedListener) {\n+        Bitmap icon = null;\n+        try {\n+            if (isIconCachedAndValid(iconURL)) {\n+                DebugTool.logInfo(\"Icon Is Up To Date\");\n+                icon = getFileFromCache(iconURL);\n+                if (icon == null) {\n+                    DebugTool.logInfo(\"Icon from cache was null, attempting to re-download\");\n+                    icon = AndroidTools.downloadImage(iconURL);\n+                    saveFileToCache(icon, iconURL);\n+                }\n+                iconRetrievedListener.onImageRetrieved(icon);\n+            } else {\n+                // The icon is unknown or expired. Download the image, save it to the cache, and update the archive file\n+                DebugTool.logInfo(\"Lock Screen Icon Update Needed\");\n+                icon = AndroidTools.downloadImage(iconURL);\n+                if (icon != null) {\n+                    saveFileToCache(icon, iconURL);\n+                    iconRetrievedListener.onImageRetrieved(icon);\n+                } else {\n+                    iconRetrievedListener.onError(\"Icon downloaded was null\");\n+                }\n+            }\n+        } catch (IOException e) {\n+            iconRetrievedListener.onError(\"device Icon Error Downloading, Will attempt to grab cached Icon even if expired: \\n\" + e.toString());\n+            icon = getFileFromCache(iconURL);", "originalCommit": "0259aba1670b0268e61490f7e55d141132afd314", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMTk5Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405101993", "bodyText": "null check added", "author": "RHenigan", "createdAt": "2020-04-07T20:46:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4NDA0Mg=="}], "type": "inlineReview"}, {"oid": "92d01bfe8a9f5e03fccf47827ed574b7b9fa2b49", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/92d01bfe8a9f5e03fccf47827ed574b7b9fa2b49", "message": "Add null check", "committedDate": "2020-04-07T20:46:20Z", "type": "commit"}, {"oid": "40f79a08ae69f2f45d0eb1c11bdfaf119a78adc1", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/40f79a08ae69f2f45d0eb1c11bdfaf119a78adc1", "message": "Fix test", "committedDate": "2020-04-07T21:04:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyNzUwNA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405627504", "body": "There are some unused imports in the class ", "bodyText": "There are some unused imports in the class", "bodyHTML": "<p dir=\"auto\">There are some unused imports in the class</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-08T15:48:53Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -82,11 +83,14 @@\n \tprivate boolean mLockScreenHasBeenDismissed, lockscreenDismissReceiverRegistered, receivedFirstDDNotification;\n \tprivate String mLockscreenWarningMsg;\n \tprivate BroadcastReceiver mLockscreenDismissedReceiver;\n+\tprivate LockScreenDeviceIconManager mLockScreenDeviceIconManager;", "originalCommit": "40f79a08ae69f2f45d0eb1c11bdfaf119a78adc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMDEwMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405810101", "bodyText": "removed", "author": "RHenigan", "createdAt": "2020-04-08T20:57:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyNzUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYzMTU4OA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405631588", "body": "can we get the url and replace it in one line?\r\n```\r\ndeviceIconUrl = msg.getUrl().replace(\"http://\", \"https://\");\r\n```", "bodyText": "can we get the url and replace it in one line?\ndeviceIconUrl = msg.getUrl().replace(\"http://\", \"https://\");", "bodyHTML": "<p dir=\"auto\">can we get the url and replace it in one line?</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"deviceIconUrl = msg.getUrl().replace(&quot;http://&quot;, &quot;https://&quot;);\"><pre><code>deviceIconUrl = msg.getUrl().replace(\"http://\", \"https://\");\n</code></pre></div>", "author": "bilal-alsharifi", "createdAt": "2020-04-08T15:54:22Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -232,6 +236,7 @@ public void onNotified(RPCNotification notification) {\n \t\t\t\t\t\t\tmsg.getUrl() != null) {\n \t\t\t\t\t\t// send intent to activity to download icon from core\n \t\t\t\t\t\tdeviceIconUrl = msg.getUrl();", "originalCommit": "40f79a08ae69f2f45d0eb1c11bdfaf119a78adc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxMDUwNw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405810507", "bodyText": "yes, made the change", "author": "RHenigan", "createdAt": "2020-04-08T20:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYzMTU4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NTU0NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405645544", "body": "what happens if the code hits the if statement on line 54 but failed to download the icon? I think it should call `onError()` in that case", "bodyText": "what happens if the code hits the if statement on line 54 but failed to download the icon? I think it should call onError() in that case", "bodyHTML": "<p dir=\"auto\">what happens if the code hits the if statement on line 54 but failed to download the icon? I think it should call <code>onError()</code> in that case</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-08T16:14:47Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.AndroidTools;\n+import com.smartdevicelink.util.DebugTool;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+/**\n+ * <strong>LockScreenDeviceIconManager</strong> <br>\n+ *\n+ * The LockScreenDeviceIconManager handles the logic of caching and retrieving cached lock screen icons <br>\n+ *\n+ */\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\n+\n+    interface OnIconRetrievedListener {\n+        void onImageRetrieved(Bitmap icon);\n+        void onError(String info);\n+    }\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_DIRECTORY_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    /**\n+     * Will try to return a lock screen icon either from cache or downloaded\n+     * if it fails iconRetrievedListener.OnError will be called with corresponding error message\n+     * @param iconURL url that the lock screen icon is downloaded from\n+     * @param iconRetrievedListener an interface that will implement onIconReceived and OnError methods\n+     */\n+    void retrieveIcon(String iconURL, OnIconRetrievedListener iconRetrievedListener) {\n+        Bitmap icon = null;\n+        try {\n+            if (isIconCachedAndValid(iconURL)) {\n+                DebugTool.logInfo(\"Icon Is Up To Date\");\n+                icon = getFileFromCache(iconURL);\n+                if (icon == null) {", "originalCommit": "40f79a08ae69f2f45d0eb1c11bdfaf119a78adc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwODY3NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405808674", "bodyText": "If the download fails it throws an IOException which is caught below", "author": "RHenigan", "createdAt": "2020-04-08T20:54:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgzOTczMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405839731", "bodyText": "Hmm, that is right. In that case, the else statement on line 67 will never be hit right?", "author": "bilal-alsharifi", "createdAt": "2020-04-08T21:59:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg0MTU5Mw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405841593", "bodyText": "line 67 would occur if dowonloadImage returns null rather than throw an exception, so I would need to look and see if downloadImage can return null", "author": "RHenigan", "createdAt": "2020-04-08T22:03:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5MTExMw==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r406191113", "bodyText": "downloadImage is returning the following\nBitmap result = BitmapFactory.decodeStream(bis);\nbis.close();\nreturn result;\n.decodeStream can return null so it is possible to get null from downloadImage without an excption being thrown", "author": "RHenigan", "createdAt": "2020-04-09T13:09:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIwNTYzNg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r406205636", "bodyText": "in that case, we should always check if the value is null after trying to download the image.", "author": "bilal-alsharifi", "createdAt": "2020-04-09T13:31:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NTU0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIyMzg4NA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r406223884", "bodyText": "Yeah, I will add a null check", "author": "RHenigan", "createdAt": "2020-04-09T13:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY0NTU0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1NjcyMg==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405656722", "body": "I don't think that will work. We are retrieving the icon in an async way and immediately use the icon without waiting for onImageRetrieved () to be called. I think deviceLogo will always be null. I suggest moving the code after the async call to be inside the `onImageRetrieved()` callback. ", "bodyText": "I don't think that will work. We are retrieving the icon in an async way and immediately use the icon without waiting for onImageRetrieved () to be called. I think deviceLogo will always be null. I suggest moving the code after the async call to be inside the onImageRetrieved() callback.", "bodyHTML": "<p dir=\"auto\">I don't think that will work. We are retrieving the icon in an async way and immediately use the icon without waiting for onImageRetrieved () to be called. I think deviceLogo will always be null. I suggest moving the code after the async call to be inside the <code>onImageRetrieved()</code> callback.</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-08T16:31:32Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenManager.java", "diffHunk": "@@ -375,17 +380,26 @@ private void downloadDeviceIcon(final String url){\n \t\tnew Thread(new Runnable(){\n \t\t\t@Override\n \t\t\tpublic void run(){\n-\t\t\t\ttry{\n-\t\t\t\t\tdeviceLogo = AndroidTools.downloadImage(url);\n+\t\t\t\tmLockScreenDeviceIconManager.retrieveIcon(url, new LockScreenDeviceIconManager.OnIconRetrievedListener() {\n+\t\t\t\t\t@Override\n+\t\t\t\t\tpublic void onImageRetrieved(Bitmap icon) {", "originalCommit": "40f79a08ae69f2f45d0eb1c11bdfaf119a78adc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNzkxNA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405807914", "bodyText": "moved", "author": "RHenigan", "createdAt": "2020-04-08T20:52:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1NjcyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDgwMQ==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405660801", "body": "Just to confirm, this clears only the icon shared preferences not all shared prefs for the app, right?", "bodyText": "Just to confirm, this clears only the icon shared preferences not all shared prefs for the app, right?", "bodyHTML": "<p dir=\"auto\">Just to confirm, this clears only the icon shared preferences not all shared prefs for the app, right?</p>", "author": "bilal-alsharifi", "createdAt": "2020-04-08T16:37:52Z", "path": "android/sdl_android/src/main/java/com/smartdevicelink/managers/lockscreen/LockScreenDeviceIconManager.java", "diffHunk": "@@ -0,0 +1,209 @@\n+package com.smartdevicelink.managers.lockscreen;\n+\n+import android.content.Context;\n+import android.content.SharedPreferences;\n+import android.graphics.Bitmap;\n+import android.graphics.BitmapFactory;\n+\n+import com.smartdevicelink.util.AndroidTools;\n+import com.smartdevicelink.util.DebugTool;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.math.BigInteger;\n+import java.security.MessageDigest;\n+import java.security.NoSuchAlgorithmException;\n+\n+/**\n+ * <strong>LockScreenDeviceIconManager</strong> <br>\n+ *\n+ * The LockScreenDeviceIconManager handles the logic of caching and retrieving cached lock screen icons <br>\n+ *\n+ */\n+class LockScreenDeviceIconManager {\n+\n+    private Context context;\n+    private static final String SDL_DEVICE_STATUS_SHARED_PREFS = \"sdl.lockScreenIcon\";\n+    private static final String STORED_ICON_DIRECTORY_PATH = \"sdl/lock_screen_icon/\";\n+\n+    interface OnIconRetrievedListener {\n+        void onImageRetrieved(Bitmap icon);\n+        void onError(String info);\n+    }\n+\n+    LockScreenDeviceIconManager(Context context) {\n+        this.context = context;\n+        File lockScreenDirectory = new File(context.getCacheDir(), STORED_ICON_DIRECTORY_PATH);\n+        lockScreenDirectory.mkdirs();\n+    }\n+\n+    /**\n+     * Will try to return a lock screen icon either from cache or downloaded\n+     * if it fails iconRetrievedListener.OnError will be called with corresponding error message\n+     * @param iconURL url that the lock screen icon is downloaded from\n+     * @param iconRetrievedListener an interface that will implement onIconReceived and OnError methods\n+     */\n+    void retrieveIcon(String iconURL, OnIconRetrievedListener iconRetrievedListener) {\n+        Bitmap icon = null;\n+        try {\n+            if (isIconCachedAndValid(iconURL)) {\n+                DebugTool.logInfo(\"Icon Is Up To Date\");\n+                icon = getFileFromCache(iconURL);\n+                if (icon == null) {\n+                    DebugTool.logInfo(\"Icon from cache was null, attempting to re-download\");\n+                    icon = AndroidTools.downloadImage(iconURL);\n+                    saveFileToCache(icon, iconURL);\n+                }\n+                iconRetrievedListener.onImageRetrieved(icon);\n+            } else {\n+                // The icon is unknown or expired. Download the image, save it to the cache, and update the archive file\n+                DebugTool.logInfo(\"Lock Screen Icon Update Needed\");\n+                icon = AndroidTools.downloadImage(iconURL);\n+                if (icon != null) {\n+                    saveFileToCache(icon, iconURL);\n+                    iconRetrievedListener.onImageRetrieved(icon);\n+                } else {\n+                    iconRetrievedListener.onError(\"Icon downloaded was null\");\n+                }\n+            }\n+        } catch (IOException e) {\n+            iconRetrievedListener.onError(\"device Icon Error Downloading, Will attempt to grab cached Icon even if expired: \\n\" + e.toString());\n+            icon = getFileFromCache(iconURL);\n+            if (icon != null) {\n+                iconRetrievedListener.onImageRetrieved(icon);\n+            } else {\n+                iconRetrievedListener.onError(\"Unable to retrieve icon from cache\");\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Will decide if a cached icon is available and up to date\n+     * @param iconUrl url will be hashed and used to look up last updated timestamp in shared preferences\n+     * @return True when icon details are in shared preferences and less than 30 days old, False if icon details are too old or not found\n+     */\n+    private boolean isIconCachedAndValid(String iconUrl) {\n+        String iconHash = getMD5HashFromIconUrl(iconUrl);\n+        SharedPreferences sharedPref = this.context.getSharedPreferences(SDL_DEVICE_STATUS_SHARED_PREFS, Context.MODE_PRIVATE);\n+        String iconLastUpdatedTime = sharedPref.getString(iconHash, null);\n+        if(iconLastUpdatedTime == null) {\n+            DebugTool.logInfo(\"No Icon Details Found In Shared Preferences\");\n+            return false;\n+        } else {\n+            DebugTool.logInfo(\"Icon Details Found\");\n+            long lastUpdatedTime = 0;\n+            try {\n+                lastUpdatedTime = Long.parseLong(iconLastUpdatedTime);\n+            } catch (NumberFormatException e) {\n+                DebugTool.logInfo(\"Invalid time stamp stored to shared preferences, clearing cache and share preferences\");\n+                clearIconDirectory();\n+                sharedPref.edit().clear().commit();", "originalCommit": "40f79a08ae69f2f45d0eb1c11bdfaf119a78adc1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgwNzUyOA==", "url": "https://github.com/smartdevicelink/sdl_java_suite/pull/1319#discussion_r405807528", "bodyText": "Yes, we create a new sharedPreference witht the key of sdl.lockScreenIcon, this is the only shared preference we are referencing withing this class", "author": "RHenigan", "createdAt": "2020-04-08T20:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDgwMQ=="}], "type": "inlineReview"}, {"oid": "1831f2e8218f31bb9fb3128714b28ce4a32c6671", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/1831f2e8218f31bb9fb3128714b28ce4a32c6671", "message": "PR Changes requested", "committedDate": "2020-04-08T20:59:25Z", "type": "commit"}, {"oid": "0aaf1f77007fa170d9f8aa3fc3c1702c91ba21c8", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/0aaf1f77007fa170d9f8aa3fc3c1702c91ba21c8", "message": "Checkout manifest from develop", "committedDate": "2020-04-08T21:57:29Z", "type": "commit"}, {"oid": "2714061ca222d0282437ac2fc9a22c77da0e4ba8", "url": "https://github.com/smartdevicelink/sdl_java_suite/commit/2714061ca222d0282437ac2fc9a22c77da0e4ba8", "message": "Add null check for downloaded image", "committedDate": "2020-04-09T14:00:02Z", "type": "commit"}]}