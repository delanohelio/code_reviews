{"pr_number": 10457, "pr_title": "Fix sys.health.health state for partitions", "pr_author": "seut", "pr_createdAt": "2020-08-28T15:10:20Z", "pr_url": "https://github.com/crate/crate/pull/10457", "timeline": [{"oid": "ff4909bddec1911f2494689eba3b3f44369722e5", "url": "https://github.com/crate/crate/commit/ff4909bddec1911f2494689eba3b3f44369722e5", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the \npartition itself, using the tables value will result in missing shards\nand thus a `RED` health.", "committedDate": "2020-08-28T15:10:23Z", "type": "forcePushed"}, {"oid": "3419d25c22c6d511215b99755cedbe1b3b6ea638", "url": "https://github.com/crate/crate/commit/3419d25c22c6d511215b99755cedbe1b3b6ea638", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health.", "committedDate": "2020-08-28T15:28:26Z", "type": "forcePushed"}, {"oid": "eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "url": "https://github.com/crate/crate/commit/eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health.", "committedDate": "2020-08-28T15:57:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5NDQxNQ==", "url": "https://github.com/crate/crate/pull/10457#discussion_r479394415", "body": "```suggestion\r\n            var partitionIndexName = IndexParts.toIndexName(\r\n                ident.tableSchema,\r\n                ident.tableName,\r\n                ident.partitionIdent\r\n            );\r\n```\r\n\r\nThere is an overload that takes schema and name directly - avoids the `RelationName` construction and some indirection.\r\n", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        var partitionIndexName = IndexParts.toIndexName(\n          \n          \n            \n                            new RelationName(ident.tableSchema, ident.tableName),\n          \n          \n            \n                            ident.partitionIdent\n          \n          \n            \n                        );\n          \n          \n            \n                        var partitionIndexName = IndexParts.toIndexName(\n          \n          \n            \n                            ident.tableSchema,\n          \n          \n            \n                            ident.tableName,\n          \n          \n            \n                            ident.partitionIdent\n          \n          \n            \n                        );\n          \n      \n    \n    \n  \n\nThere is an overload that takes schema and name directly - avoids the RelationName construction and some indirection.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"175\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">var</span> partitionIndexName <span class=\"pl-k\">=</span> <span class=\"pl-smi\">IndexParts</span><span class=\"pl-k\">.</span>toIndexName(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"176\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RelationName</span>(ident<span class=\"pl-k\">.</span>tableSchema, ident<span class=\"pl-k\">.</span>tableName),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"177\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                ident<span class=\"pl-k\">.</span>partitionIdent</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"178\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            );</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"175\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">var</span> partitionIndexName <span class=\"pl-k\">=</span> <span class=\"pl-smi\">IndexParts</span><span class=\"pl-k\">.</span>toIndexName(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"176\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                ident<span class=\"pl-k\">.</span>tableSchema,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"177\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                ident<span class=\"pl-k\">.</span>tableName,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"178\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                ident<span class=\"pl-k\">.</span>partitionIdent</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"179\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            );</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">There is an overload that takes schema and name directly - avoids the <code>RelationName</code> construction and some indirection.</p>", "author": "mfussenegger", "createdAt": "2020-08-28T15:58:04Z", "path": "server/src/main/java/io/crate/metadata/sys/TableHealthService.java", "diffHunk": "@@ -165,7 +167,23 @@ private TableHealth tableHealthFromEntry(Map.Entry<TablePartitionIdent, ShardsIn\n         } catch (RelationUnknown e) {\n             return null;\n         }\n-        return calculateHealth(ident, shardsInfo, tableInfo.numberOfShards());\n+        int shardsCount = tableInfo.numberOfShards();\n+        if (ident.partitionIdent != null) {\n+            var partitionIndexName = IndexParts.toIndexName(\n+                new RelationName(ident.tableSchema, ident.tableName),\n+                ident.partitionIdent\n+            );", "originalCommit": "3419d25c22c6d511215b99755cedbe1b3b6ea638", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5NTY4OA==", "url": "https://github.com/crate/crate/pull/10457#discussion_r479395688", "body": "I think it's legitimate for the indexMetaData to be absent if the partition is deleted concurrently. We should probably return `null` if `indexMetaData` is null - similar to how we handle the `RelationUnknown` case.", "bodyText": "I think it's legitimate for the indexMetaData to be absent if the partition is deleted concurrently. We should probably return null if indexMetaData is null - similar to how we handle the RelationUnknown case.", "bodyHTML": "<p dir=\"auto\">I think it's legitimate for the indexMetaData to be absent if the partition is deleted concurrently. We should probably return <code>null</code> if <code>indexMetaData</code> is null - similar to how we handle the <code>RelationUnknown</code> case.</p>", "author": "mfussenegger", "createdAt": "2020-08-28T16:00:29Z", "path": "server/src/main/java/io/crate/metadata/sys/TableHealthService.java", "diffHunk": "@@ -165,7 +167,23 @@ private TableHealth tableHealthFromEntry(Map.Entry<TablePartitionIdent, ShardsIn\n         } catch (RelationUnknown e) {\n             return null;\n         }\n-        return calculateHealth(ident, shardsInfo, tableInfo.numberOfShards());\n+        int shardsCount = tableInfo.numberOfShards();\n+        if (ident.partitionIdent != null) {\n+            var partitionIndexName = IndexParts.toIndexName(\n+                new RelationName(ident.tableSchema, ident.tableName),\n+                ident.partitionIdent\n+            );\n+            var indexMetaData = clusterService.state().getMetadata().index(partitionIndexName);\n+            assert indexMetaData != null : \"index meta data for partition \" + partitionIndexName + \" not found\";", "originalCommit": "eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5NjUzNQ==", "url": "https://github.com/crate/crate/pull/10457#discussion_r479396535", "body": "```suggestion\r\n            shardsCount = indexMetadata.getNumberOfShards();\r\n```\r\n\r\nNo need to go through the `PartitionInfo`  to access the shard count.\r\n", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        var partitionInfo = PartitionInfos.createPartitionInfo(\n          \n          \n            \n                            partitionIndexName,\n          \n          \n            \n                            indexMetaData\n          \n          \n            \n                        );\n          \n          \n            \n                        assert partitionInfo != null : \"cannot resolve partition info for \" + partitionIndexName;\n          \n          \n            \n                        shardsCount = partitionInfo.numberOfShards();\n          \n          \n            \n                        shardsCount = indexMetadata.getNumberOfShards();\n          \n      \n    \n    \n  \n\nNo need to go through the PartitionInfo  to access the shard count.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">var</span> partitionInfo <span class=\"pl-k\">=</span> <span class=\"pl-smi\">PartitionInfos</span><span class=\"pl-k\">.</span>createPartitionInfo(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                partitionIndexName,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                indexMetaData</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            );</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">assert</span> partitionInfo <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">:</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>cannot resolve partition info for <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> partitionIndexName;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            shardsCount <span class=\"pl-k\">=</span> partitionInfo<span class=\"pl-k\">.</span>numberOfShards();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            shardsCount <span class=\"pl-k\">=</span> indexMetadata<span class=\"pl-k\">.</span>getNumberOfShards();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">No need to go through the <code>PartitionInfo</code>  to access the shard count.</p>", "author": "mfussenegger", "createdAt": "2020-08-28T16:01:55Z", "path": "server/src/main/java/io/crate/metadata/sys/TableHealthService.java", "diffHunk": "@@ -165,7 +167,23 @@ private TableHealth tableHealthFromEntry(Map.Entry<TablePartitionIdent, ShardsIn\n         } catch (RelationUnknown e) {\n             return null;\n         }\n-        return calculateHealth(ident, shardsInfo, tableInfo.numberOfShards());\n+        int shardsCount = tableInfo.numberOfShards();\n+        if (ident.partitionIdent != null) {\n+            var partitionIndexName = IndexParts.toIndexName(\n+                new RelationName(ident.tableSchema, ident.tableName),\n+                ident.partitionIdent\n+            );\n+            var indexMetaData = clusterService.state().getMetadata().index(partitionIndexName);\n+            assert indexMetaData != null : \"index meta data for partition \" + partitionIndexName + \" not found\";\n+            var partitionInfo = PartitionInfos.createPartitionInfo(\n+                partitionIndexName,\n+                indexMetaData\n+            );\n+            assert partitionInfo != null : \"cannot resolve partition info for \" + partitionIndexName;\n+            shardsCount = partitionInfo.numberOfShards();", "originalCommit": "eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "104cc34e4f49c1fd9cc09f91a6000d451a8df182", "url": "https://github.com/crate/crate/commit/104cc34e4f49c1fd9cc09f91a6000d451a8df182", "message": "fixup! Fix sys.health.health state for partitions", "committedDate": "2020-08-28T16:30:45Z", "type": "forcePushed"}, {"oid": "b9ab5a592abdd8c99e6bbb1b62deed7c68aaa5a7", "url": "https://github.com/crate/crate/commit/b9ab5a592abdd8c99e6bbb1b62deed7c68aaa5a7", "message": "Fix value of sys.health.partition_ident\n\nAs documented, a NULL should be returned instead of an empty string\nfor non-partitioned tables.", "committedDate": "2020-08-29T11:35:18Z", "type": "commit"}, {"oid": "d1e006ace0c2829e00b1383a13307a05ec558fd2", "url": "https://github.com/crate/crate/commit/d1e006ace0c2829e00b1383a13307a05ec558fd2", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health.", "committedDate": "2020-08-29T11:35:19Z", "type": "commit"}, {"oid": "d1e006ace0c2829e00b1383a13307a05ec558fd2", "url": "https://github.com/crate/crate/commit/d1e006ace0c2829e00b1383a13307a05ec558fd2", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health.", "committedDate": "2020-08-29T11:35:19Z", "type": "forcePushed"}]}