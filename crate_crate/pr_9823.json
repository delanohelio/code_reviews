{"pr_number": 9823, "pr_title": "Refactor all geo scalars to new function registry", "pr_author": "seut", "pr_createdAt": "2020-03-30T13:36:08Z", "pr_url": "https://github.com/crate/crate/pull/9823", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMDUwNw==", "url": "https://github.com/crate/crate/pull/9823#discussion_r400210507", "body": "```suggestion\r\n        DataTypes.STRING, DataTypes.GEO_POINT, DataTypes.DOUBLE_ARRAY);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    DataTypes.STRING, DataTypes.GEO_POINT, new ArrayType<>(DataTypes.DOUBLE));\n          \n          \n            \n                    DataTypes.STRING, DataTypes.GEO_POINT, DataTypes.DOUBLE_ARRAY);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">DataTypes</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>STRING</span>, <span class=\"pl-smi\">DataTypes</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>GEO_POINT</span>, <span class=\"pl-k x x-first\">new</span><span class=\"x\"> </span><span class=\"pl-k x\">ArrayType&lt;&gt;</span><span class=\"x x-last\">(</span><span class=\"pl-smi\">DataTypes</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span><span class=\"x x-first\">DOUBLE</span></span><span class=\"x x-last\">)</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">DataTypes</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>STRING</span>, <span class=\"pl-smi\">DataTypes</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>GEO_POINT</span>, <span class=\"pl-smi\">DataTypes</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">DOUBLE_ARRAY</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "kovrus", "createdAt": "2020-03-30T13:55:02Z", "path": "sql/src/main/java/io/crate/expression/scalar/geo/DistanceFunction.java", "diffHunk": "@@ -44,22 +40,30 @@\n import java.util.Arrays;\n import java.util.List;\n \n+import static io.crate.metadata.functions.Signature.scalar;\n+import static io.crate.types.TypeSignature.parseTypeSignature;\n+\n public class DistanceFunction extends Scalar<Double, Point> {\n \n     public static final String NAME = \"distance\";\n-    private static final Param ALLOWED_PARAM = Param.of(\n-        DataTypes.STRING, DataTypes.GEO_POINT, new ArrayType(DataTypes.DOUBLE));\n+    private static final List<DataType<?>> SUPPORTED_TYPES = List.of(\n+        DataTypes.STRING, DataTypes.GEO_POINT, new ArrayType<>(DataTypes.DOUBLE));", "originalCommit": "f3f8abb54460f320f0ae06cfd6dcba6c4f8866af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMzkwMQ==", "url": "https://github.com/crate/crate/pull/9823#discussion_r400213901", "body": "what is the preferable way of defining the signature\r\n```\r\nparseTypeSignature(\"double precision\")\r\n```\r\nor \r\n```\r\nDataTypes.DOUBLE.getTypeSignature()\r\n```\r\n?", "bodyText": "what is the preferable way of defining the signature\nparseTypeSignature(\"double precision\")\n\nor\nDataTypes.DOUBLE.getTypeSignature()\n\n?", "bodyHTML": "<p dir=\"auto\">what is the preferable way of defining the signature</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"parseTypeSignature(&quot;double precision&quot;)\"><pre><code>parseTypeSignature(\"double precision\")\n</code></pre></div>\n<p dir=\"auto\">or</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"DataTypes.DOUBLE.getTypeSignature()\"><pre><code>DataTypes.DOUBLE.getTypeSignature()\n</code></pre></div>\n<p dir=\"auto\">?</p>", "author": "kovrus", "createdAt": "2020-03-30T13:59:20Z", "path": "sql/src/main/java/io/crate/expression/scalar/geo/CoordinateFunction.java", "diffHunk": "@@ -31,13 +30,20 @@\n import java.util.List;\n import java.util.function.Function;\n \n+import static io.crate.metadata.functions.Signature.scalar;\n+import static io.crate.types.TypeSignature.parseTypeSignature;\n+\n public final class CoordinateFunction {\n \n-    private static final List<DataType> SUPPORTED_INPUT_TYPES = ImmutableList.of(DataTypes.GEO_POINT, DataTypes.STRING, DataTypes.DOUBLE_ARRAY, DataTypes.UNDEFINED);\n+    private static final List<DataType<?>> SUPPORTED_INPUT_TYPES =\n+        List.of(DataTypes.GEO_POINT, DataTypes.STRING, DataTypes.DOUBLE_ARRAY, DataTypes.UNDEFINED);\n \n     private static void register(ScalarFunctionModule module, String name, Function<Object, Double> func) {\n-        for (DataType inputType : SUPPORTED_INPUT_TYPES) {\n-            module.register(new UnaryScalar<>(name, inputType, DataTypes.DOUBLE, func));\n+        for (DataType<?> inputType : SUPPORTED_INPUT_TYPES) {\n+            module.register(\n+                scalar(name, inputType.getTypeSignature(), parseTypeSignature(\"double precision\")),", "originalCommit": "f3f8abb54460f320f0ae06cfd6dcba6c4f8866af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxOTU2Ng==", "url": "https://github.com/crate/crate/pull/9823#discussion_r400219566", "bodyText": "No strict preference, both is valid. I prefer parseTypeSignature(\"double precision\") as I think is more readable, but may be just a personal preference.", "author": "seut", "createdAt": "2020-03-30T14:07:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIzMTMzNg==", "url": "https://github.com/crate/crate/pull/9823#discussion_r400231336", "bodyText": "Wouldn't the second variant be safer, since the type name must be valid to create the DataType instance later on?", "author": "mfussenegger", "createdAt": "2020-03-30T14:22:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIzNTgzOQ==", "url": "https://github.com/crate/crate/pull/9823#discussion_r400235839", "bodyText": "parseTypeSignature() will also fail on invalid types as it will call DataTypes.ofName() eventually.", "author": "seut", "createdAt": "2020-03-30T14:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0MTQ1NA==", "url": "https://github.com/crate/crate/pull/9823#discussion_r400241454", "bodyText": "parseTypeSignature() will also fail on invalid types as it will call DataTypes.ofName() eventually.\n\nGood point, although I think DataTypes.DOUBLE.getTypeSignature()  or parseTypeSignature(DataTypes.DOUBLE.getName())  would make the relationship clearer and make refactorings easier.\nProbably not worth going through all open PRs again, but maybe going forward?", "author": "mfussenegger", "createdAt": "2020-03-30T14:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMzkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1MzAwNg==", "url": "https://github.com/crate/crate/pull/9823#discussion_r400253006", "bodyText": "Refactoring is a good point although I really like the literal variant. But yes lets use then DataTypes.DOUBLE.getTypeSignature() in future.", "author": "seut", "createdAt": "2020-03-30T14:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMzkwMQ=="}], "type": "inlineReview"}, {"oid": "7f32609238cd803447975ce35cfc590d0b5cf634", "url": "https://github.com/crate/crate/commit/7f32609238cd803447975ce35cfc590d0b5cf634", "message": "Refactor all geo scalars to new function registry", "committedDate": "2020-03-30T14:10:49Z", "type": "commit"}, {"oid": "7f32609238cd803447975ce35cfc590d0b5cf634", "url": "https://github.com/crate/crate/commit/7f32609238cd803447975ce35cfc590d0b5cf634", "message": "Refactor all geo scalars to new function registry", "committedDate": "2020-03-30T14:10:49Z", "type": "forcePushed"}, {"oid": "8f559a11ba91d6353be4c793a77ff9d451892fcb", "url": "https://github.com/crate/crate/commit/8f559a11ba91d6353be4c793a77ff9d451892fcb", "message": "Merge branch 'master' into s/geo-scalars", "committedDate": "2020-03-30T14:47:51Z", "type": "commit"}]}