{"pr_number": 1435, "pr_title": "avoid allocation of byte[] in MessagePacker.writeString", "pr_author": "richardstartin", "pr_createdAt": "2020-05-07T10:10:23Z", "pr_url": "https://github.com/DataDog/dd-trace-java/pull/1435", "timeline": [{"oid": "38a24a0de2570c1a5bd2e54a5b946cfc33a71dd6", "url": "https://github.com/DataDog/dd-trace-java/commit/38a24a0de2570c1a5bd2e54a5b946cfc33a71dd6", "message": "avoid allocation of byte[] in MessagePacker.writeString", "committedDate": "2020-05-07T10:42:29Z", "type": "forcePushed"}, {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32", "url": "https://github.com/DataDog/dd-trace-java/commit/bb98cc955939cc2ea1472c204b33cc721d910c32", "message": "avoid allocation of byte[] in MessagePacker.writeString", "committedDate": "2020-05-07T10:55:52Z", "type": "commit"}, {"oid": "bb98cc955939cc2ea1472c204b33cc721d910c32", "url": "https://github.com/DataDog/dd-trace-java/commit/bb98cc955939cc2ea1472c204b33cc721d910c32", "message": "avoid allocation of byte[] in MessagePacker.writeString", "committedDate": "2020-05-07T10:55:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0MTE0MQ==", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#discussion_r421541141", "body": "clone():\r\n \r\n`MessagePack.DEFAULT_PACKER_CONFIG.clone().withSmallStringOptimizationThreshold(16)`", "bodyText": "clone():\nMessagePack.DEFAULT_PACKER_CONFIG.clone().withSmallStringOptimizationThreshold(16)", "bodyHTML": "<p dir=\"auto\">clone():</p>\n<p dir=\"auto\"><code>MessagePack.DEFAULT_PACKER_CONFIG.clone().withSmallStringOptimizationThreshold(16)</code></p>", "author": "lpriima", "createdAt": "2020-05-07T14:19:09Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -46,6 +46,9 @@\n   private static final String TRACES_ENDPOINT_V4 = \"v0.4/traces\";\n   private static final long MILLISECONDS_BETWEEN_ERROR_LOG = TimeUnit.MINUTES.toMillis(5);\n \n+  private static final MessagePack.PackerConfig MESSAGE_PACKER_CONFIG =\n+      MessagePack.DEFAULT_PACKER_CONFIG.withSmallStringOptimizationThreshold(16);", "originalCommit": "bb98cc955939cc2ea1472c204b33cc721d910c32", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0MzEyOA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#discussion_r421543128", "bodyText": "Here is the source code of the method:\n        /**\n         * Use String.getBytes() for converting Java Strings that are shorter than this threshold.\n         * Note that this parameter is subject to change.\n         */\n        public PackerConfig withSmallStringOptimizationThreshold(int length)\n        {\n            PackerConfig copy = clone();\n            copy.smallStringOptimizationThreshold = length;\n            return copy;\n        }", "author": "richardstartin", "createdAt": "2020-05-07T14:21:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0MTE0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU2MjcwMA==", "url": "https://github.com/DataDog/dd-trace-java/pull/1435#discussion_r421562700", "body": "So it wasn't directly obvious to me what this did, and I had to check the code. I think a comment about why this is done would be great. AFAICS, this limits the size of `Strings` that are considered for this _optimization_ from `512` chars to `16` chars, and so the number of calls to `String.getBytes` get fewer, and hence fewer allocations of `byte[]`.", "bodyText": "So it wasn't directly obvious to me what this did, and I had to check the code. I think a comment about why this is done would be great. AFAICS, this limits the size of Strings that are considered for this optimization from 512 chars to 16 chars, and so the number of calls to String.getBytes get fewer, and hence fewer allocations of byte[].", "bodyHTML": "<p dir=\"auto\">So it wasn't directly obvious to me what this did, and I had to check the code. I think a comment about why this is done would be great. AFAICS, this limits the size of <code>Strings</code> that are considered for this <em>optimization</em> from <code>512</code> chars to <code>16</code> chars, and so the number of calls to <code>String.getBytes</code> get fewer, and hence fewer allocations of <code>byte[]</code>.</p>", "author": "bantonsson", "createdAt": "2020-05-07T14:45:33Z", "path": "dd-trace-core/src/main/java/datadog/trace/common/writer/ddagent/DDAgentApi.java", "diffHunk": "@@ -46,6 +46,9 @@\n   private static final String TRACES_ENDPOINT_V4 = \"v0.4/traces\";\n   private static final long MILLISECONDS_BETWEEN_ERROR_LOG = TimeUnit.MINUTES.toMillis(5);\n \n+  private static final MessagePack.PackerConfig MESSAGE_PACKER_CONFIG =\n+      MessagePack.DEFAULT_PACKER_CONFIG.withSmallStringOptimizationThreshold(16);", "originalCommit": "bb98cc955939cc2ea1472c204b33cc721d910c32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a62f6bc5a5792f39f10534faff5830d76d452ba4", "url": "https://github.com/DataDog/dd-trace-java/commit/a62f6bc5a5792f39f10534faff5830d76d452ba4", "message": "add explanatory comment for MessagePacker configuration", "committedDate": "2020-05-07T15:27:47Z", "type": "commit"}]}