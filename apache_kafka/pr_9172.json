{"pr_number": 9172, "pr_title": "KAFKA-10387: Fix inclusion of transformation configs when topic creation is enabled in Connect", "pr_author": "kkonstantine", "pr_createdAt": "2020-08-12T19:27:29Z", "pr_url": "https://github.com/apache/kafka/pull/9172", "timeline": [{"oid": "5560bd4bb093449bb13b354fb35e192ee2d25f7e", "url": "https://github.com/apache/kafka/commit/5560bd4bb093449bb13b354fb35e192ee2d25f7e", "message": "KAFKA-10387: Fix inclusion of transformation configs when topic creation is enabled in Connect", "committedDate": "2020-08-12T19:19:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3MjY1MQ==", "url": "https://github.com/apache/kafka/pull/9172#discussion_r469572651", "body": "Super tiny nit: the wrapping even from the original was confusing, and maybe it's worth changing one more line and cleaning up the wrapping:\r\n```suggestion\r\n            enrichedSourceConfig = new EnrichedSourceConnectorConfig(plugins,\r\n                    enrich(defaultConfigDef, props, defaultGroup), \r\n                    propsWithoutRegexForDefaultGroup);\r\n```\r\nWDYT?", "bodyText": "Super tiny nit: the wrapping even from the original was confusing, and maybe it's worth changing one more line and cleaning up the wrapping:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        enrichedSourceConfig = new EnrichedSourceConnectorConfig(plugins,\n          \n          \n            \n                                enrich(defaultConfigDef, props,\n          \n          \n            \n                                defaultGroup), propsWithoutRegexForDefaultGroup);\n          \n          \n            \n                        enrichedSourceConfig = new EnrichedSourceConnectorConfig(plugins,\n          \n          \n            \n                                enrich(defaultConfigDef, props, defaultGroup), \n          \n          \n            \n                                propsWithoutRegexForDefaultGroup);\n          \n      \n    \n    \n  \n\nWDYT?", "bodyHTML": "<p dir=\"auto\">Super tiny nit: the wrapping even from the original was confusing, and maybe it's worth changing one more line and cleaning up the wrapping:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            enrichedSourceConfig <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">EnrichedSourceConnectorConfig</span>(plugins,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    enrich(defaultConfigDef, props,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"x x-first x-last\">defaultGroup), </span>propsWithoutRegexForDefaultGroup);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            enrichedSourceConfig <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">EnrichedSourceConnectorConfig</span>(plugins,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    enrich(defaultConfigDef, props,<span class=\"x x-first x-last\"> defaultGroup), </span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    propsWithoutRegexForDefaultGroup);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">WDYT?</p>", "author": "rhauch", "createdAt": "2020-08-12T22:04:20Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/SourceConnectorConfig.java", "diffHunk": "@@ -129,7 +129,8 @@ public SourceConnectorConfig(Plugins plugins, Map<String, String> props, boolean\n             propsWithoutRegexForDefaultGroup.entrySet()\n                     .removeIf(e -> e.getKey().equals(DEFAULT_TOPIC_CREATION_PREFIX + INCLUDE_REGEX_CONFIG)\n                             || e.getKey().equals(DEFAULT_TOPIC_CREATION_PREFIX + EXCLUDE_REGEX_CONFIG));\n-            enrichedSourceConfig = new EnrichedSourceConnectorConfig(enrich(defaultConfigDef, props,\n+            enrichedSourceConfig = new EnrichedSourceConnectorConfig(plugins,\n+                    enrich(defaultConfigDef, props,\n                     defaultGroup), propsWithoutRegexForDefaultGroup);", "originalCommit": "5560bd4bb093449bb13b354fb35e192ee2d25f7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NzM3MQ==", "url": "https://github.com/apache/kafka/pull/9172#discussion_r469577371", "bodyText": "Good catch. The break was added by accident there.", "author": "kkonstantine", "createdAt": "2020-08-12T22:16:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3MjY1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NDEzMA==", "url": "https://github.com/apache/kafka/pull/9172#discussion_r469574130", "body": "Do we need another test here, or could we essentially replace the previous test with this one?\r\n\r\nEither way, the test that uses topic creation should probably have a comment (either in the method JavaDoc or in a line comment below) that explicitly mentions enabling topic creation. We don't want someone removing the topic creation configs at a later time.\r\n\r\nWDYT?", "bodyText": "Do we need another test here, or could we essentially replace the previous test with this one?\nEither way, the test that uses topic creation should probably have a comment (either in the method JavaDoc or in a line comment below) that explicitly mentions enabling topic creation. We don't want someone removing the topic creation configs at a later time.\nWDYT?", "bodyHTML": "<p dir=\"auto\">Do we need another test here, or could we essentially replace the previous test with this one?</p>\n<p dir=\"auto\">Either way, the test that uses topic creation should probably have a comment (either in the method JavaDoc or in a line comment below) that explicitly mentions enabling topic creation. We don't want someone removing the topic creation configs at a later time.</p>\n<p dir=\"auto\">WDYT?</p>", "author": "rhauch", "createdAt": "2020-08-12T22:08:10Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/integration/TransformationIntegrationTest.java", "diffHunk": "@@ -318,4 +323,61 @@ public void testFilterOnHasHeaderKeyWithSourceConnector() throws Exception {\n         // delete connector\n         connect.deleteConnector(CONNECTOR_NAME);\n     }\n+\n+    /**\n+     * Test the {@link Filter} transformer with a\n+     * {@link HasHeaderKey} predicate on a source connector.\n+     */\n+    @Test\n+    public void testFilterOnHasHeaderKeyWithSourceConnectorAndTopicCreation() throws Exception {", "originalCommit": "5560bd4bb093449bb13b354fb35e192ee2d25f7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3ODE5NQ==", "url": "https://github.com/apache/kafka/pull/9172#discussion_r469578195", "bodyText": "Since we have a few other tests replacing should be fine.\nI'll add comments. But also, the test will fail if we don't create it (I removed the admin command) because we disable auto topic creation at the broker.", "author": "kkonstantine", "createdAt": "2020-08-12T22:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NDEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU4Njc2NA==", "url": "https://github.com/apache/kafka/pull/9172#discussion_r469586764", "bodyText": "Sounds good. I just want to avoid someone trying to simplify the tests in the future without understanding that this test is verifying both features work together.", "author": "rhauch", "createdAt": "2020-08-12T22:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NDEzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDE4MzY5OA==", "url": "https://github.com/apache/kafka/pull/9172#discussion_r470183698", "bodyText": "I added the logic to the previous test.\nAdded another unit test to test 2 groups with 2 transformations.", "author": "kkonstantine", "createdAt": "2020-08-13T19:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU3NDEzMA=="}], "type": "inlineReview"}, {"oid": "1261ce93fad2f5d834d423edc645579d2de75145", "url": "https://github.com/apache/kafka/commit/1261ce93fad2f5d834d423edc645579d2de75145", "message": "KAFKA-10387: Adress comments and add another test", "committedDate": "2020-08-13T19:01:22Z", "type": "commit"}]}