{"pr_number": 9671, "pr_title": "KAFKA-10793: move handling of FindCoordinatorFuture to fix race condition", "pr_author": "ableegoldman", "pr_createdAt": "2020-12-02T02:43:04Z", "pr_url": "https://github.com/apache/kafka/pull/9671", "timeline": [{"oid": "a6022afc2a03a4c8f52311944c79db8756fc2dc8", "url": "https://github.com/apache/kafka/commit/a6022afc2a03a4c8f52311944c79db8756fc2dc8", "message": "move handling of future", "committedDate": "2021-01-20T23:59:53Z", "type": "commit"}, {"oid": "deec9a2fca29c661d0ad5bf8754aa936d8b6ed4e", "url": "https://github.com/apache/kafka/commit/deec9a2fca29c661d0ad5bf8754aa936d8b6ed4e", "message": "review suggestions", "committedDate": "2021-01-20T23:59:53Z", "type": "commit"}, {"oid": "84b39c6646597fe03650b3be500b4d958dde19d4", "url": "https://github.com/apache/kafka/commit/84b39c6646597fe03650b3be500b4d958dde19d4", "message": "find checkstyle, add comment", "committedDate": "2021-01-20T23:59:53Z", "type": "commit"}, {"oid": "3e5e9d2c0b5bc1a30a35df7e515880b475c1a5bb", "url": "https://github.com/apache/kafka/commit/3e5e9d2c0b5bc1a30a35df7e515880b475c1a5bb", "message": "logging suggestion", "committedDate": "2021-01-20T23:59:53Z", "type": "commit"}, {"oid": "bd921db0e23d7eb024106f53ab76bb10dcd9f2a9", "url": "https://github.com/apache/kafka/commit/bd921db0e23d7eb024106f53ab76bb10dcd9f2a9", "message": "logic refactoring", "committedDate": "2021-01-20T23:59:53Z", "type": "commit"}, {"oid": "bd921db0e23d7eb024106f53ab76bb10dcd9f2a9", "url": "https://github.com/apache/kafka/commit/bd921db0e23d7eb024106f53ab76bb10dcd9f2a9", "message": "logic refactoring", "committedDate": "2021-01-20T23:59:53Z", "type": "forcePushed"}, {"oid": "92777103e0c4637a0aac4cf1165ff4d71814091b", "url": "https://github.com/apache/kafka/commit/92777103e0c4637a0aac4cf1165ff4d71814091b", "message": "fix for hanging #testCoordinatorFailover", "committedDate": "2021-01-26T03:48:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg5OTc3Ng==", "url": "https://github.com/apache/kafka/pull/9671#discussion_r564899776", "body": "I think the issue is spot-on! The logic here becomes a bit hard to understand for other readers now and I'd suggest update the cmment as:\r\n\r\n\"Clear the future so that after the backoff in the next iteration, if hb still sees coordinator unknown it will try re-discover the coordinator in case the main thread cannot\"\r\n\r\nOtherwise, LGTM.", "bodyText": "I think the issue is spot-on! The logic here becomes a bit hard to understand for other readers now and I'd suggest update the cmment as:\n\"Clear the future so that after the backoff in the next iteration, if hb still sees coordinator unknown it will try re-discover the coordinator in case the main thread cannot\"\nOtherwise, LGTM.", "bodyHTML": "<p dir=\"auto\">I think the issue is spot-on! The logic here becomes a bit hard to understand for other readers now and I'd suggest update the cmment as:</p>\n<p dir=\"auto\">\"Clear the future so that after the backoff in the next iteration, if hb still sees coordinator unknown it will try re-discover the coordinator in case the main thread cannot\"</p>\n<p dir=\"auto\">Otherwise, LGTM.</p>", "author": "guozhangwang", "createdAt": "2021-01-26T23:06:49Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/internals/AbstractCoordinator.java", "diffHunk": "@@ -1359,10 +1368,15 @@ public void run() {\n                         long now = time.milliseconds();\n \n                         if (coordinatorUnknown()) {\n-                            if (findCoordinatorFuture != null || lookupCoordinator().failed())\n-                                // the immediate future check ensures that we backoff properly in the case that no\n-                                // brokers are available to connect to.\n+                            if (findCoordinatorFuture != null) {", "originalCommit": "92777103e0c4637a0aac4cf1165ff4d71814091b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDkwMjg0OA==", "url": "https://github.com/apache/kafka/pull/9671#discussion_r564902848", "bodyText": "SG", "author": "ableegoldman", "createdAt": "2021-01-26T23:13:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDg5OTc3Ng=="}], "type": "inlineReview"}, {"oid": "5d111d889e7b994b2c9d6f2d522dc032ff7237d9", "url": "https://github.com/apache/kafka/commit/5d111d889e7b994b2c9d6f2d522dc032ff7237d9", "message": "improve code comment", "committedDate": "2021-01-26T23:14:07Z", "type": "commit"}]}