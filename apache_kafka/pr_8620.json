{"pr_number": 8620, "pr_title": "KAFKA-9944: Added supporting customized HTTP response headers for Kafka Connect.", "pr_author": "jeffhuang26", "pr_createdAt": "2020-05-05T22:27:30Z", "pr_url": "https://github.com/apache/kafka/pull/8620", "timeline": [{"oid": "a2b69910f6f015255f26d09b743d7ad410759a15", "url": "https://github.com/apache/kafka/commit/a2b69910f6f015255f26d09b743d7ad410759a15", "message": "Added supporting customized HTTP response headers for Kafka Connect.", "committedDate": "2020-05-05T22:20:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2NTU4Mg==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420465582", "body": "I don't think we should expose `Jetty` here. Yes, we're following the Jetty grammar and format for these, but let's not unnecessarily expose the internals.\r\n```suggestion\r\n    public static final String RESPONSE_HTTP_HEADERS_DOC = \"Rules for REST API HTTP response headers\";\r\n```", "bodyText": "I don't think we should expose Jetty here. Yes, we're following the Jetty grammar and format for these, but let's not unnecessarily expose the internals.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String RESPONSE_HTTP_HEADERS_DOC = \"Set values for Jetty HTTP response headers\";\n          \n          \n            \n                public static final String RESPONSE_HTTP_HEADERS_DOC = \"Rules for REST API HTTP response headers\";", "bodyHTML": "<p dir=\"auto\">I don't think we should expose <code>Jetty</code> here. Yes, we're following the Jetty grammar and format for these, but let's not unnecessarily expose the internals.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1\">RESPONSE_HTTP_HEADERS_DOC</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">Set values </span>for <span class=\"x x-first x-last\">Jetty</span> HTTP response headers<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1\">RESPONSE_HTTP_HEADERS_DOC</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">Rules </span>for <span class=\"x x-first x-last\">REST API</span> HTTP response headers<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-05T23:24:24Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -244,6 +244,14 @@\n             + \"user requests to reset the set of active topics per connector.\";\n     protected static final boolean TOPIC_TRACKING_ALLOW_RESET_DEFAULT = true;\n \n+    /**\n+     * @link \"https://www.eclipse.org/jetty/documentation/current/header-filter.html\"\n+     * @link \"https://www.eclipse.org/jetty/javadoc/9.4.28.v20200408/org/eclipse/jetty/servlets/HeaderFilter.html\"\n+     **/\n+    public static final String RESPONSE_HTTP_HEADERS_CONFIG = \"response.http.headers.config\";\n+    public static final String RESPONSE_HTTP_HEADERS_DOC = \"Set values for Jetty HTTP response headers\";", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2NjA1Nw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420466057", "body": "Why not implement these as a `ConfigDef.Validator` implementation, similar to the existing `AdminListenersValidator` below?", "bodyText": "Why not implement these as a ConfigDef.Validator implementation, similar to the existing AdminListenersValidator below?", "bodyHTML": "<p dir=\"auto\">Why not implement these as a <code>ConfigDef.Validator</code> implementation, similar to the existing <code>AdminListenersValidator</code> below?</p>", "author": "rhauch", "createdAt": "2020-05-05T23:25:46Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -400,6 +410,52 @@ public WorkerConfig(ConfigDef definition, Map<String, String> props) {\n         logInternalConverterDeprecationWarnings(props);\n     }\n \n+    public static void validateHttpResponseHeaderConfig(String config) {", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2NjYwMg==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420466602", "body": "Is this line really necessary? Isn't the `response.http.headers.config` property already logged at INFO level when the worker starts up, via the WorkerConfig (or rather DistributedConfig or StandaloneConfig) constructor?", "bodyText": "Is this line really necessary? Isn't the response.http.headers.config property already logged at INFO level when the worker starts up, via the WorkerConfig (or rather DistributedConfig or StandaloneConfig) constructor?", "bodyHTML": "<p dir=\"auto\">Is this line really necessary? Isn't the <code>response.http.headers.config</code> property already logged at INFO level when the worker starts up, via the WorkerConfig (or rather DistributedConfig or StandaloneConfig) constructor?</p>", "author": "rhauch", "createdAt": "2020-05-05T23:27:36Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/RestServer.java", "diffHunk": "@@ -461,4 +469,18 @@ public static String urlJoin(String base, String path) {\n             return base + path;\n     }\n \n+    /**\n+     * Register header filter to ServletContextHandler.\n+     * @param context The serverlet context handler\n+     */\n+    protected void configureHttpResponsHeaderFilter(ServletContextHandler context) {\n+        String headerConfig = config.getString(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG);\n+        log.debug(\"headerConfig : \" + headerConfig);", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2NjkxOA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420466918", "body": "Is there a reason we don't want to validate these properties up front when all of the other configuration validation is being performed, via `ConfigDef.Validator` on `response.http.headers.config`? If we do that, we don't need this line.", "bodyText": "Is there a reason we don't want to validate these properties up front when all of the other configuration validation is being performed, via ConfigDef.Validator on response.http.headers.config? If we do that, we don't need this line.", "bodyHTML": "<p dir=\"auto\">Is there a reason we don't want to validate these properties up front when all of the other configuration validation is being performed, via <code>ConfigDef.Validator</code> on <code>response.http.headers.config</code>? If we do that, we don't need this line.</p>", "author": "rhauch", "createdAt": "2020-05-05T23:28:34Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/RestServer.java", "diffHunk": "@@ -461,4 +469,18 @@ public static String urlJoin(String base, String path) {\n             return base + path;\n     }\n \n+    /**\n+     * Register header filter to ServletContextHandler.\n+     * @param context The serverlet context handler\n+     */\n+    protected void configureHttpResponsHeaderFilter(ServletContextHandler context) {\n+        String headerConfig = config.getString(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG);\n+        log.debug(\"headerConfig : \" + headerConfig);\n+        String[] configs = StringUtil.csvSplit(headerConfig);\n+        Arrays.stream(configs)\n+                .forEach(WorkerConfig::validateHttpResponseHeaderConfig);", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2NzkxOQ==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420467919", "body": "Nit:\r\n```suggestion\r\n    public void testDefaultCustomizedHttpResponseHeaders() throws IOException  {\r\n```", "bodyText": "Nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void TestDefaultCustomizedHttpResponseHeaders() throws IOException  {\n          \n          \n            \n                public void testDefaultCustomizedHttpResponseHeaders() throws IOException  {", "bodyHTML": "<p dir=\"auto\">Nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">TestDefaultCustomizedHttpResponseHeaders</span>() throws <span class=\"pl-smi\">IOException</span>  {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">testDefaultCustomizedHttpResponseHeaders</span>() throws <span class=\"pl-smi\">IOException</span>  {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-05T23:31:35Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +393,106 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void TestValidCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig =\n+                \"add X-XSS-Protection: 1; mode=block, \\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        expectedHeaders.put(\"X-XSS-Protection\", \"1; mode=block\");\n+        expectedHeaders.put(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void TestDefaultCustomizedHttpResponseHeaders() throws IOException  {", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2Nzk4Nw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420467987", "body": "Nit:\r\n```suggestion\r\n    public void testValidCustomizedHttpResponseHeaders() throws IOException  {\r\n```", "bodyText": "Nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void TestValidCustomizedHttpResponseHeaders() throws IOException  {\n          \n          \n            \n                public void testValidCustomizedHttpResponseHeaders() throws IOException  {", "bodyHTML": "<p dir=\"auto\">Nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">TestValidCustomizedHttpResponseHeaders</span>() throws <span class=\"pl-smi\">IOException</span>  {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">testValidCustomizedHttpResponseHeaders</span>() throws <span class=\"pl-smi\">IOException</span>  {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-05T23:31:47Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +393,106 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void TestValidCustomizedHttpResponseHeaders() throws IOException  {", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2ODA4Mg==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420468082", "body": "The advantage of using `ConfigDef.validator` on the `response.http.headers.config` config key is that this constructor call would throw an exception if any invalid value is used, and much sooner, too.", "bodyText": "The advantage of using ConfigDef.validator on the response.http.headers.config config key is that this constructor call would throw an exception if any invalid value is used, and much sooner, too.", "bodyHTML": "<p dir=\"auto\">The advantage of using <code>ConfigDef.validator</code> on the <code>response.http.headers.config</code> config key is that this constructor call would throw an exception if any invalid value is used, and much sooner, too.</p>", "author": "rhauch", "createdAt": "2020-05-05T23:32:06Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +393,106 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void TestValidCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig =\n+                \"add X-XSS-Protection: 1; mode=block, \\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        expectedHeaders.put(\"X-XSS-Protection\", \"1; mode=block\");\n+        expectedHeaders.put(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void TestDefaultCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig = \"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigFormat() {\n+        String headerConfig = \"add X-XSS-Protection\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new StandaloneConfig(workerProps);\n+\n+        EasyMock.expect(herder.kafkaClusterId()).andReturn(KAFKA_CLUSTER_ID);\n+        EasyMock.expect(herder.plugins()).andStubReturn(plugins);\n+        EasyMock.expect(plugins.newPlugins(Collections.emptyList(),\n+                workerConfig,\n+                ConnectRestExtension.class)).andStubReturn(Collections.emptyList());\n+\n+        EasyMock.expect(herder.connectors()).andReturn(Arrays.asList(\"a\", \"b\"));\n+\n+        PowerMock.replayAll();\n+\n+        server = new RestServer(workerConfig);\n+        server.initializeServer();\n+        server.initializeResources(herder);\n+        server.stop();\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigAction() {\n+        String headerConfig = \"badaction X-XSS-Protection: 1; mode=block\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new StandaloneConfig(workerProps);\n+\n+        EasyMock.expect(herder.kafkaClusterId()).andReturn(KAFKA_CLUSTER_ID);\n+        EasyMock.expect(herder.plugins()).andStubReturn(plugins);\n+        EasyMock.expect(plugins.newPlugins(Collections.emptyList(),\n+                workerConfig,\n+                ConnectRestExtension.class)).andStubReturn(Collections.emptyList());\n+\n+        EasyMock.expect(herder.connectors()).andReturn(Arrays.asList(\"a\", \"b\"));\n+\n+        PowerMock.replayAll();\n+\n+        server = new RestServer(workerConfig);\n+        server.initializeServer();\n+        server.initializeResources(herder);\n+        server.stop();\n+    }\n+\n+    public void checkCustomizedHttpResponseHeaders(String headerConfig, Map<String, String> expectedHeaders)\n+            throws IOException  {\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new StandaloneConfig(workerProps);", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2ODUyNg==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420468526", "body": "Should we have tests for the `DistributedConfig` class? Again, much of the logic should be the same, but the tests would each be simpler if using a `ConfigDef.Validator`.", "bodyText": "Should we have tests for the DistributedConfig class? Again, much of the logic should be the same, but the tests would each be simpler if using a ConfigDef.Validator.", "bodyHTML": "<p dir=\"auto\">Should we have tests for the <code>DistributedConfig</code> class? Again, much of the logic should be the same, but the tests would each be simpler if using a <code>ConfigDef.Validator</code>.</p>", "author": "rhauch", "createdAt": "2020-05-05T23:33:13Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +393,106 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void TestValidCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig =\n+                \"add X-XSS-Protection: 1; mode=block, \\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        expectedHeaders.put(\"X-XSS-Protection\", \"1; mode=block\");\n+        expectedHeaders.put(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void TestDefaultCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig = \"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigFormat() {\n+        String headerConfig = \"add X-XSS-Protection\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new StandaloneConfig(workerProps);", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2ODg2MQ==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420468861", "body": "If using `ConfigDef.Validator`, all of these lines would go away, and we actually don't need mocks of any kind.", "bodyText": "If using ConfigDef.Validator, all of these lines would go away, and we actually don't need mocks of any kind.", "bodyHTML": "<p dir=\"auto\">If using <code>ConfigDef.Validator</code>, all of these lines would go away, and we actually don't need mocks of any kind.</p>", "author": "rhauch", "createdAt": "2020-05-05T23:34:17Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +393,106 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void TestValidCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig =\n+                \"add X-XSS-Protection: 1; mode=block, \\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        expectedHeaders.put(\"X-XSS-Protection\", \"1; mode=block\");\n+        expectedHeaders.put(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void TestDefaultCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig = \"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigFormat() {\n+        String headerConfig = \"add X-XSS-Protection\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new StandaloneConfig(workerProps);\n+\n+        EasyMock.expect(herder.kafkaClusterId()).andReturn(KAFKA_CLUSTER_ID);\n+        EasyMock.expect(herder.plugins()).andStubReturn(plugins);\n+        EasyMock.expect(plugins.newPlugins(Collections.emptyList(),\n+                workerConfig,\n+                ConnectRestExtension.class)).andStubReturn(Collections.emptyList());\n+\n+        EasyMock.expect(herder.connectors()).andReturn(Arrays.asList(\"a\", \"b\"));\n+\n+        PowerMock.replayAll();\n+\n+        server = new RestServer(workerConfig);\n+        server.initializeServer();\n+        server.initializeResources(herder);\n+        server.stop();\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigAction() {\n+        String headerConfig = \"badaction X-XSS-Protection: 1; mode=block\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new StandaloneConfig(workerProps);\n+\n+        EasyMock.expect(herder.kafkaClusterId()).andReturn(KAFKA_CLUSTER_ID);\n+        EasyMock.expect(herder.plugins()).andStubReturn(plugins);\n+        EasyMock.expect(plugins.newPlugins(Collections.emptyList(),\n+                workerConfig,\n+                ConnectRestExtension.class)).andStubReturn(Collections.emptyList());\n+\n+        EasyMock.expect(herder.connectors()).andReturn(Arrays.asList(\"a\", \"b\"));\n+\n+        PowerMock.replayAll();\n+\n+        server = new RestServer(workerConfig);\n+        server.initializeServer();\n+        server.initializeResources(herder);\n+        server.stop();", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ2OTE4OA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420469188", "body": "Might be nice to have quite a few of these tests that verify various values are invalid and valid, to act as regression tests.", "bodyText": "Might be nice to have quite a few of these tests that verify various values are invalid and valid, to act as regression tests.", "bodyHTML": "<p dir=\"auto\">Might be nice to have quite a few of these tests that verify various values are invalid and valid, to act as regression tests.</p>", "author": "rhauch", "createdAt": "2020-05-05T23:35:20Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +393,106 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void TestValidCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig =\n+                \"add X-XSS-Protection: 1; mode=block, \\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        expectedHeaders.put(\"X-XSS-Protection\", \"1; mode=block\");\n+        expectedHeaders.put(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void TestDefaultCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig = \"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigFormat() {\n+        String headerConfig = \"add X-XSS-Protection\";", "originalCommit": "a2b69910f6f015255f26d09b743d7ad410759a15", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "98c1cf0eb18a8481291b913f324489bd99904e7f", "url": "https://github.com/apache/kafka/commit/98c1cf0eb18a8481291b913f324489bd99904e7f", "message": "Updated code based on review comments.", "committedDate": "2020-05-06T05:54:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgzNzY0OQ==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420837649", "body": "~How about using `strValue.split(',')`, and avoiding the need to import `org.eclipse.jetty.util.StringUtil`?~\r\n\r\nOkay, I see now that `cvsSplit` handles quotes. How about a comment:\r\n```suggestion\r\n            String[] configs = StringUtil.csvSplit(strValue); // handles and removes surrounding quotes\r\n```", "bodyText": "How about using strValue.split(','), and avoiding the need to import org.eclipse.jetty.util.StringUtil?\nOkay, I see now that cvsSplit handles quotes. How about a comment:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String[] configs = StringUtil.csvSplit(strValue);\n          \n          \n            \n                        String[] configs = StringUtil.csvSplit(strValue); // handles and removes surrounding quotes", "bodyHTML": "<p dir=\"auto\"><del>How about using <code>strValue.split(',')</code>, and avoiding the need to import <code>org.eclipse.jetty.util.StringUtil</code>?</del></p>\n<p dir=\"auto\">Okay, I see now that <code>cvsSplit</code> handles quotes. How about a comment:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">String</span>[] configs <span class=\"pl-k\">=</span> <span class=\"pl-smi\">StringUtil</span><span class=\"pl-k\">.</span>csvSplit(strValue);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">String</span>[] configs <span class=\"pl-k\">=</span> <span class=\"pl-smi\">StringUtil</span><span class=\"pl-k\">.</span>csvSplit(strValue);<span class=\"x x-first\"> </span><span class=\"pl-c\"><span class=\"pl-c x\">//</span><span class=\"x x-last\"> handles and removes surrounding quotes</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-06T14:30:28Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg0MzExMw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420843113", "body": "Should probably add this as the first bit in this method:\r\n```suggestion\r\n            String strValue = (String) value;\r\n            if (value == null || strValue.trim().isEmpty()) {\r\n                return;\r\n            }\r\n```", "bodyText": "Should probably add this as the first bit in this method:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String strValue = (String) value;\n          \n          \n            \n                        if (strValue.isEmpty()) {\n          \n          \n            \n                            return;\n          \n          \n            \n                        }\n          \n          \n            \n                        String strValue = (String) value;\n          \n          \n            \n                        if (value == null || strValue.trim().isEmpty()) {\n          \n          \n            \n                            return;\n          \n          \n            \n                        }", "bodyHTML": "<p dir=\"auto\">Should probably add this as the first bit in this method:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"490\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">String</span> strValue <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">String</span>) value;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"491\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (strValue<span class=\"pl-k\">.</span>isEmpty()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"492\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">return</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"493\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"490\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">String</span> strValue <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">String</span>) value;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"491\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (<span class=\"x x-first\">value </span><span class=\"pl-k x\">==</span><span class=\"x\"> </span><span class=\"pl-c1 x\">null</span><span class=\"x\"> </span><span class=\"pl-k x\">||</span><span class=\"x x-last\"> </span>strValue<span class=\"pl-k x x-first\">.</span><span class=\"x x-last\">trim()</span><span class=\"pl-k\">.</span>isEmpty()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"492\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">return</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"493\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-06T14:37:31Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg0NTYwNQ==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420845605", "body": "There's no benefit to having the `validateHttpResponseHeaderConfig(...)` method static, so how about making it non-static? And you can use a method reference to make it a tiny bit more readable:\r\n```suggestion\r\n            Arrays.stream(configs).forEach(this::validateHttpResponseHeaderConfig);\r\n        }\r\n\r\n        private void validateHttpResponseHeaderConfig(String config) {\r\n```\r\n\r\nOr, if you want to make it easier to test, then move to `WorkerConfig` class and make package-level static:\r\n```\r\n            Arrays.stream(configs).forEach(WorkerConfig::validateHttpResponseHeaderConfig);\r\n```\r\nI actually think this is the best way to go, because then you can easily add lots of test methods that thoroughly test each of these methods for both positive and negative cases.", "bodyText": "There's no benefit to having the validateHttpResponseHeaderConfig(...) method static, so how about making it non-static? And you can use a method reference to make it a tiny bit more readable:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    private static void validateHttpResponseHeaderConfig(String config) {\n          \n          \n            \n                        Arrays.stream(configs).forEach(this::validateHttpResponseHeaderConfig);\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    private void validateHttpResponseHeaderConfig(String config) {\n          \n      \n    \n    \n  \n\nOr, if you want to make it easier to test, then move to WorkerConfig class and make package-level static:\n            Arrays.stream(configs).forEach(WorkerConfig::validateHttpResponseHeaderConfig);\n\nI actually think this is the best way to go, because then you can easily add lots of test methods that thoroughly test each of these methods for both positive and negative cases.", "bodyHTML": "<p dir=\"auto\">There's no benefit to having the <code>validateHttpResponseHeaderConfig(...)</code> method static, so how about making it non-static? And you can use a method reference to make it a tiny bit more readable:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">Arrays</span><span class=\"pl-k\">.</span>stream(configs)<span class=\"pl-k\">.</span>forEach(<span class=\"x x-first\">config </span><span class=\"pl-k x\">-</span><span class=\"pl-k x\">&gt;</span><span class=\"x x-last\"> </span>validateHttpResponseHeaderConfig<span class=\"x x-first x-last\">(config)</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">static</span><span class=\"x x-last\"> </span><span class=\"pl-k\">void</span> validateHttpResponseHeaderConfig(<span class=\"pl-smi\">String</span> config) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">Arrays</span><span class=\"pl-k\">.</span>stream(configs)<span class=\"pl-k\">.</span>forEach(<span class=\"pl-c1 x x-first\">this</span><span class=\"pl-k x x-last\">::</span>validateHttpResponseHeaderConfig);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> validateHttpResponseHeaderConfig(<span class=\"pl-smi\">String</span> config) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Or, if you want to make it easier to test, then move to <code>WorkerConfig</code> class and make package-level static:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"            Arrays.stream(configs).forEach(WorkerConfig::validateHttpResponseHeaderConfig);\n\"><pre><code>            Arrays.stream(configs).forEach(WorkerConfig::validateHttpResponseHeaderConfig);\n</code></pre></div>\n<p dir=\"auto\">I actually think this is the best way to go, because then you can easily add lots of test methods that thoroughly test each of these methods for both positive and negative cases.</p>", "author": "rhauch", "createdAt": "2020-05-06T14:40:43Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);\n+            Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n+        }\n+\n+        private static void validateHttpResponseHeaderConfig(String config) {", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg0Njg2Mw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420846863", "body": "Nits:\r\n```suggestion\r\n                    throw new ConfigException(String.format(\"Invalid format of header config '%s'. \"\r\n                            + \"Expected: '[action] [header name]:[header value]'\", config));\r\n```", "bodyText": "Nits:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new ConfigException(String.format(\"Invalid format of header config \\\"%s\\\". \"\n          \n          \n            \n                                        + \"Expected: \\\"[ation] [header name]:[header value]\\\"\", config));\n          \n          \n            \n                                throw new ConfigException(String.format(\"Invalid format of header config '%s'. \"\n          \n          \n            \n                                        + \"Expected: '[action] [header name]:[header value]'\", config));", "bodyHTML": "<p dir=\"auto\">Nits:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid format of header config <span class=\"pl-cce x x-first\">\\\"</span><span class=\"x\">%s</span><span class=\"pl-cce x x-last\">\\\"</span>. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                            <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Expected: <span class=\"pl-cce x x-first\">\\\"</span><span class=\"x x-last\">[ation</span>] [header name]:[header value]<span class=\"pl-cce x x-first x-last\">\\\"</span><span class=\"pl-pds\">\"</span></span>, config));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid format of header config <span class=\"x x-first x-last\">'%s'</span>. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                            <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Expected: <span class=\"x x-first x-last\">'[action</span>] [header name]:[header value]<span class=\"x x-first x-last\">'</span><span class=\"pl-pds\">\"</span></span>, config));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-06T14:42:22Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);\n+            Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n+        }\n+\n+        private static void validateHttpResponseHeaderConfig(String config) {\n+            try {\n+                // validate format\n+                String[] configTokens = config.trim().split(\"\\\\s+\", 2);\n+                if (configTokens.length != 2) {\n+                    throw new ConfigException(String.format(\"Invalid format of header config \\\"%s\\\". \"\n+                            + \"Expected: \\\"[ation] [header name]:[header value]\\\"\", config));", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3MDg5OA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420870898", "body": "Nit:\r\n```suggestion\r\n                            String.format(\"Invalid format of header name and header value pair '%s'. \"\r\n                                    + \"Expected: '[header name]:[header value]'\", header));\r\n```", "bodyText": "Nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        String.format(\"Invalid format of header name and header value pair \\\"%s\\\". \"\n          \n          \n            \n                                                + \"Expected: \\\"[header name]:[header value]\\\"\", header));\n          \n          \n            \n                                        String.format(\"Invalid format of header name and header value pair '%s'. \"\n          \n          \n            \n                                                + \"Expected: '[header name]:[header value]'\", header));", "bodyHTML": "<p dir=\"auto\">Nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                            <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid format of header name and header value pair <span class=\"pl-cce x x-first\">\\\"</span><span class=\"x\">%s</span><span class=\"pl-cce x x-last\">\\\"</span>. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                                    <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Expected: <span class=\"pl-cce x x-first x-last\">\\\"</span>[header name]:[header value]<span class=\"pl-cce x x-first x-last\">\\\"</span><span class=\"pl-pds\">\"</span></span>, header));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                            <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid format of header name and header value pair <span class=\"x x-first x-last\">'%s'</span>. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                                    <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Expected: <span class=\"x x-first x-last\">'</span>[header name]:[header value]<span class=\"x x-first x-last\">'</span><span class=\"pl-pds\">\"</span></span>, header));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-06T15:12:22Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);\n+            Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n+        }\n+\n+        private static void validateHttpResponseHeaderConfig(String config) {\n+            try {\n+                // validate format\n+                String[] configTokens = config.trim().split(\"\\\\s+\", 2);\n+                if (configTokens.length != 2) {\n+                    throw new ConfigException(String.format(\"Invalid format of header config \\\"%s\\\". \"\n+                            + \"Expected: \\\"[ation] [header name]:[header value]\\\"\", config));\n+                }\n+\n+                // validate action\n+                String method = configTokens[0].trim();\n+                validateHeaderConfigAction(method);\n+\n+                // validate header name and header value pair\n+                String header = configTokens[1];\n+                String[] headerTokens = header.trim().split(\":\");\n+                if (headerTokens.length != 2) {\n+                    throw new ConfigException(\n+                            String.format(\"Invalid format of header name and header value pair \\\"%s\\\". \"\n+                                    + \"Expected: \\\"[header name]:[header value]\\\"\", header));", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3MTc4Mg==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420871782", "body": "Nit:\r\n```suggestion\r\n                    throw new ConfigException(String.format(\"Invalid header name '%s'. \"\r\n                            + \"The '[header name]' cannot contain whitespace\", headerName));\r\n```", "bodyText": "Nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new ConfigException(String.format(\"Invalid header name \\\"%s\\\". \"\n          \n          \n            \n                                        + \"The \\\"[header name]\\\" cannot contain whitespace\", headerName));\n          \n          \n            \n                                throw new ConfigException(String.format(\"Invalid header name '%s'. \"\n          \n          \n            \n                                        + \"The '[header name]' cannot contain whitespace\", headerName));", "bodyHTML": "<p dir=\"auto\">Nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid header name <span class=\"pl-cce x x-first\">\\\"</span><span class=\"x\">%s</span><span class=\"pl-cce x x-last\">\\\"</span>. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                            <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The <span class=\"pl-cce x x-first x-last\">\\\"</span>[header name]<span class=\"pl-cce x x-first x-last\">\\\"</span> cannot contain whitespace<span class=\"pl-pds\">\"</span></span>, headerName));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid header name <span class=\"x x-first x-last\">'%s'</span>. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                            <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The <span class=\"x x-first x-last\">'</span>[header name]<span class=\"x x-first x-last\">'</span> cannot contain whitespace<span class=\"pl-pds\">\"</span></span>, headerName));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-06T15:13:26Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);\n+            Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n+        }\n+\n+        private static void validateHttpResponseHeaderConfig(String config) {\n+            try {\n+                // validate format\n+                String[] configTokens = config.trim().split(\"\\\\s+\", 2);\n+                if (configTokens.length != 2) {\n+                    throw new ConfigException(String.format(\"Invalid format of header config \\\"%s\\\". \"\n+                            + \"Expected: \\\"[ation] [header name]:[header value]\\\"\", config));\n+                }\n+\n+                // validate action\n+                String method = configTokens[0].trim();\n+                validateHeaderConfigAction(method);\n+\n+                // validate header name and header value pair\n+                String header = configTokens[1];\n+                String[] headerTokens = header.trim().split(\":\");\n+                if (headerTokens.length != 2) {\n+                    throw new ConfigException(\n+                            String.format(\"Invalid format of header name and header value pair \\\"%s\\\". \"\n+                                    + \"Expected: \\\"[header name]:[header value]\\\"\", header));\n+                }\n+\n+                // validate header name\n+                String headerName = headerTokens[0].trim();\n+                if (headerName.isEmpty() || headerName.contains(\" \")) {\n+                    throw new ConfigException(String.format(\"Invalid header name \\\"%s\\\". \"\n+                            + \"The \\\"[header name]\\\" cannot contain whitespace\", headerName));", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3Mjk4Mw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420872983", "body": "Shouldn't this look for other whitespace characters, per the exception message? Something like:\r\n```suggestion\r\n                if (headerName.isEmpty() || headerName.matches(\"\\\\s\")) {\r\n```", "bodyText": "Shouldn't this look for other whitespace characters, per the exception message? Something like:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (headerName.isEmpty() || headerName.contains(\" \")) {\n          \n          \n            \n                            if (headerName.isEmpty() || headerName.matches(\"\\\\s\")) {", "bodyHTML": "<p dir=\"auto\">Shouldn't this look for other whitespace characters, per the exception message? Something like:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">if</span> (headerName<span class=\"pl-k\">.</span>isEmpty() <span class=\"pl-k\">||</span> headerName<span class=\"pl-k\">.</span><span class=\"x x-first\">contains(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x x-last\"> </span><span class=\"pl-pds\">\"</span></span>)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">if</span> (headerName<span class=\"pl-k\">.</span>isEmpty() <span class=\"pl-k\">||</span> headerName<span class=\"pl-k\">.</span><span class=\"x x-first\">matches(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"pl-cce x\">\\\\</span><span class=\"x x-last\">s</span><span class=\"pl-pds\">\"</span></span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-06T15:14:56Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);\n+            Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n+        }\n+\n+        private static void validateHttpResponseHeaderConfig(String config) {\n+            try {\n+                // validate format\n+                String[] configTokens = config.trim().split(\"\\\\s+\", 2);\n+                if (configTokens.length != 2) {\n+                    throw new ConfigException(String.format(\"Invalid format of header config \\\"%s\\\". \"\n+                            + \"Expected: \\\"[ation] [header name]:[header value]\\\"\", config));\n+                }\n+\n+                // validate action\n+                String method = configTokens[0].trim();\n+                validateHeaderConfigAction(method);\n+\n+                // validate header name and header value pair\n+                String header = configTokens[1];\n+                String[] headerTokens = header.trim().split(\":\");\n+                if (headerTokens.length != 2) {\n+                    throw new ConfigException(\n+                            String.format(\"Invalid format of header name and header value pair \\\"%s\\\". \"\n+                                    + \"Expected: \\\"[header name]:[header value]\\\"\", header));\n+                }\n+\n+                // validate header name\n+                String headerName = headerTokens[0].trim();\n+                if (headerName.isEmpty() || headerName.contains(\" \")) {", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3MzM0MA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420873340", "body": "Nit:\r\n```suggestion\r\n                throw new ConfigException(String.format(\"Invalid header config '%s'\", config), e);\r\n```", "bodyText": "Nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new ConfigException(String.format(\"Invalid header config \\\"%s\\\".\", config), e);\n          \n          \n            \n                            throw new ConfigException(String.format(\"Invalid header config '%s'\", config), e);", "bodyHTML": "<p dir=\"auto\">Nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid header config <span class=\"pl-cce x x-first\">\\\"</span><span class=\"x\">%s</span><span class=\"pl-cce x\">\\\"</span><span class=\"x x-last\">.</span><span class=\"pl-pds\">\"</span></span>, config), e);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid header config <span class=\"x x-first x-last\">'%s'</span><span class=\"pl-pds\">\"</span></span>, config), e);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-06T15:15:23Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);\n+            Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n+        }\n+\n+        private static void validateHttpResponseHeaderConfig(String config) {\n+            try {\n+                // validate format\n+                String[] configTokens = config.trim().split(\"\\\\s+\", 2);\n+                if (configTokens.length != 2) {\n+                    throw new ConfigException(String.format(\"Invalid format of header config \\\"%s\\\". \"\n+                            + \"Expected: \\\"[ation] [header name]:[header value]\\\"\", config));\n+                }\n+\n+                // validate action\n+                String method = configTokens[0].trim();\n+                validateHeaderConfigAction(method);\n+\n+                // validate header name and header value pair\n+                String header = configTokens[1];\n+                String[] headerTokens = header.trim().split(\":\");\n+                if (headerTokens.length != 2) {\n+                    throw new ConfigException(\n+                            String.format(\"Invalid format of header name and header value pair \\\"%s\\\". \"\n+                                    + \"Expected: \\\"[header name]:[header value]\\\"\", header));\n+                }\n+\n+                // validate header name\n+                String headerName = headerTokens[0].trim();\n+                if (headerName.isEmpty() || headerName.contains(\" \")) {\n+                    throw new ConfigException(String.format(\"Invalid header name \\\"%s\\\". \"\n+                            + \"The \\\"[header name]\\\" cannot contain whitespace\", headerName));\n+                }\n+            } catch (ArrayIndexOutOfBoundsException e) {\n+                throw new ConfigException(String.format(\"Invalid header config \\\"%s\\\".\", config), e);", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3NTE1Mw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420875153", "body": "This class should have a `toString()` method that describes what's required, so some string like:\r\n> Comma-separated header rules, where each header rule is of the form '[action] [header name]:[header value]' and optionally surrounded by double quotes if any part of a header rule contains a comma", "bodyText": "This class should have a toString() method that describes what's required, so some string like:\n\nComma-separated header rules, where each header rule is of the form '[action] [header name]:[header value]' and optionally surrounded by double quotes if any part of a header rule contains a comma", "bodyHTML": "<p dir=\"auto\">This class should have a <code>toString()</code> method that describes what's required, so some string like:</p>\n<blockquote>\n<p dir=\"auto\">Comma-separated header rules, where each header rule is of the form '[action] [header name]:[header value]' and optionally surrounded by double quotes if any part of a header rule contains a comma</p>\n</blockquote>", "author": "rhauch", "createdAt": "2020-05-06T15:17:48Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg3OTk5MA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420879990", "body": "How about defining a static immutable list as a constant:\r\n```\r\n    private static final Collection<String> HEADER_ACTIONS = Collections.unmodifiableList(\r\n            Arrays.asList(\"set\", \"add\", \"setDate\", \"addDate\")\r\n    );\r\n```\r\nso that these lines can become:\r\n```suggestion\r\n            if (!HEADER_ACTIONS.stream().anyMatch(action::equalsIgnoreCase)) {\r\n                throw new ConfigException(String.format(\"Invalid header config action: '%s'. \"\r\n                        + \"Expected one of %s\", action, HEADER_ACTIONS));\r\n```\r\nThis eliminates the duplication of the literal values (which is prone to future errors) and makes the code more readable.", "bodyText": "How about defining a static immutable list as a constant:\n    private static final Collection<String> HEADER_ACTIONS = Collections.unmodifiableList(\n            Arrays.asList(\"set\", \"add\", \"setDate\", \"addDate\")\n    );\n\nso that these lines can become:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (!Arrays.asList(\"set\", \"add\", \"setDate\", \"addDate\")\n          \n          \n            \n                                .stream()\n          \n          \n            \n                                .anyMatch(action::equalsIgnoreCase)) {\n          \n          \n            \n                            throw new ConfigException(String.format(\"Invalid header config action: \\\"%s\\\". \"\n          \n          \n            \n                                    + \"The action need be one of [\\\"set\\\", \\\"add\\\", \\\"setDate\\\", \\\"addDate\\\"]\", action));\n          \n          \n            \n                        if (!HEADER_ACTIONS.stream().anyMatch(action::equalsIgnoreCase)) {\n          \n          \n            \n                            throw new ConfigException(String.format(\"Invalid header config action: '%s'. \"\n          \n          \n            \n                                    + \"Expected one of %s\", action, HEADER_ACTIONS));\n          \n      \n    \n    \n  \n\nThis eliminates the duplication of the literal values (which is prone to future errors) and makes the code more readable.", "bodyHTML": "<p dir=\"auto\">How about defining a static immutable list as a constant:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    private static final Collection&lt;String&gt; HEADER_ACTIONS = Collections.unmodifiableList(\n            Arrays.asList(&quot;set&quot;, &quot;add&quot;, &quot;setDate&quot;, &quot;addDate&quot;)\n    );\n\"><pre><code>    private static final Collection&lt;String&gt; HEADER_ACTIONS = Collections.unmodifiableList(\n            Arrays.asList(\"set\", \"add\", \"setDate\", \"addDate\")\n    );\n</code></pre></div>\n<p dir=\"auto\">so that these lines can become:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span><span class=\"pl-smi\">Arrays</span><span class=\"pl-k\">.</span>asList(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>set<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>add<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>setDate<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>addDate<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    .stream()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    .anyMatch(action<span class=\"pl-k\">::</span>equalsIgnoreCase)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid header config action: <span class=\"pl-cce\">\\\"</span>%s<span class=\"pl-cce\">\\\"</span>. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The action need be one of [<span class=\"pl-cce\">\\\"</span>set<span class=\"pl-cce\">\\\"</span>, <span class=\"pl-cce\">\\\"</span>add<span class=\"pl-cce\">\\\"</span>, <span class=\"pl-cce\">\\\"</span>setDate<span class=\"pl-cce\">\\\"</span>, <span class=\"pl-cce\">\\\"</span>addDate<span class=\"pl-cce\">\\\"</span>]<span class=\"pl-pds\">\"</span></span>, action));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span><span class=\"pl-c1\">HEADER_ACTIONS</span><span class=\"pl-k\">.</span>stream()<span class=\"pl-k\">.</span>anyMatch(action<span class=\"pl-k\">::</span>equalsIgnoreCase)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ConfigException</span>(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Invalid header config action: '%s'. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Expected one of %s<span class=\"pl-pds\">\"</span></span>, action, <span class=\"pl-c1\">HEADER_ACTIONS</span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">This eliminates the duplication of the literal values (which is prone to future errors) and makes the code more readable.</p>", "author": "rhauch", "createdAt": "2020-05-06T15:24:21Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -427,4 +435,62 @@ public void ensureValid(String name, Object value) {\n         }\n     }\n \n+    private static class ResponseHttpHeadersValidator implements ConfigDef.Validator {\n+        @Override\n+        public void ensureValid(String name, Object value) {\n+            String strValue = (String) value;\n+            if (strValue.isEmpty()) {\n+                return;\n+            }\n+\n+            String[] configs = StringUtil.csvSplit(strValue);\n+            Arrays.stream(configs).forEach(config -> validateHttpResponseHeaderConfig(config));\n+        }\n+\n+        private static void validateHttpResponseHeaderConfig(String config) {\n+            try {\n+                // validate format\n+                String[] configTokens = config.trim().split(\"\\\\s+\", 2);\n+                if (configTokens.length != 2) {\n+                    throw new ConfigException(String.format(\"Invalid format of header config \\\"%s\\\". \"\n+                            + \"Expected: \\\"[ation] [header name]:[header value]\\\"\", config));\n+                }\n+\n+                // validate action\n+                String method = configTokens[0].trim();\n+                validateHeaderConfigAction(method);\n+\n+                // validate header name and header value pair\n+                String header = configTokens[1];\n+                String[] headerTokens = header.trim().split(\":\");\n+                if (headerTokens.length != 2) {\n+                    throw new ConfigException(\n+                            String.format(\"Invalid format of header name and header value pair \\\"%s\\\". \"\n+                                    + \"Expected: \\\"[header name]:[header value]\\\"\", header));\n+                }\n+\n+                // validate header name\n+                String headerName = headerTokens[0].trim();\n+                if (headerName.isEmpty() || headerName.contains(\" \")) {\n+                    throw new ConfigException(String.format(\"Invalid header name \\\"%s\\\". \"\n+                            + \"The \\\"[header name]\\\" cannot contain whitespace\", headerName));\n+                }\n+            } catch (ArrayIndexOutOfBoundsException e) {\n+                throw new ConfigException(String.format(\"Invalid header config \\\"%s\\\".\", config), e);\n+            }\n+        }\n+\n+        private static void validateHeaderConfigAction(String action) {\n+            /**\n+             * The following actions are defined following link.\n+             * {@link https://www.eclipse.org/jetty/documentation/current/header-filter.html}\n+             **/\n+            if (!Arrays.asList(\"set\", \"add\", \"setDate\", \"addDate\")\n+                    .stream()\n+                    .anyMatch(action::equalsIgnoreCase)) {\n+                throw new ConfigException(String.format(\"Invalid header config action: \\\"%s\\\". \"\n+                        + \"The action need be one of [\\\"set\\\", \\\"add\\\", \\\"setDate\\\", \\\"addDate\\\"]\", action));", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwNjUxMQ==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r420906511", "body": "These are great and very useful, but they still don't thoroughly test the `validateHttpResponseHeaderConfig` and `validateHeaderConfigAction` methods. If you make these methods static, package-protected in the `WorkerConfig` class (rather than in a nested class), then you can easily add more tests to `WorkerConfigTest` that thoroughly verify all of the logic in those methods.\r\n\r\nFor example, something like the following in `WorkerConfigTest`:\r\n```\r\n    protected static final List<String> VALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\r\n            // TODO: Add a lot more valid header configs\r\n            \"\\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\",\r\n            \"add X-XSS-Protection: 1; mode=block\",\r\n            \"add Strict-Transport-Security: max-age=31536000; includeSubDomains\",\r\n            \"AdD   Strict-Transport-Security:    max-age=31536000;  includeSubDomains\",\r\n            \"AdD \\t Strict-Transport-Security : \\n   max-age=31536000;  includeSubDomains\",\r\n            \"add X-Content-Type-Options: nosniff\"\r\n    );\r\n\r\n    protected static final List<String> VALID_QUOTE_REQUIRED_HEADER_CONFIGS = Arrays.asList(\r\n            // TODO: Add a lot more valid header configs\r\n            \"add Cache-Control: no-cache, no-store, must-revalidate\"\r\n    );\r\n\r\n    protected static final List<String> INVALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\r\n            // TODO: Add a lot more valid header configs\r\n            \"WRONG Cache-Control: no-cache\",\r\n            \"add Cache-Control no-cache\",\r\n            \"WRONG Cache-Control: no-cache, no-store, must-revalidate\",\r\n    );\r\n\r\n    protected static final String WHITESPACE = \" \\t \\n  \";\r\n\r\n    @Test\r\n    public void testSingleValidHeaderConfigs() {\r\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\r\n            assertValidHeaderConfig(config);\r\n        }\r\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\r\n            assertValidHeaderConfig(\"\\\"\" + config + \"\\\"\");\r\n        }\r\n    }\r\n\r\n    @Test\r\n    public void testSingleValidHeaderConfigsWithWhitespace() {\r\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\r\n            assertValidHeaderConfig(WHITESPACE + config + WHITESPACE);\r\n        }\r\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\r\n            assertValidHeaderConfig(WHITESPACE + \"\\\"\" + WHITESPACE + config + WHITESPACE + \"\\\"\" + WHITESPACE);\r\n        }\r\n    }\r\n\r\n    @Test\r\n    public void testMultipleValidHeaderConfigsWithoutWhitespace() {\r\n        assertValidHeaderConfig(String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS));\r\n        assertValidHeaderConfig(String.join(\" , \", VALID_UNQUOTED_HEADER_CONFIGS));\r\n    }\r\n\r\n    @Test\r\n    public void testHeaderConfigsThatRequireQuotes() {\r\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\r\n            assertInvalidHeaderConfig(config);\r\n        }\r\n    }\r\n\r\n    @Test\r\n    public void testInvalidHeaderConfigs() {\r\n        for (String config : INVALID_UNQUOTED_HEADER_CONFIGS) {\r\n            assertInvalidHeaderConfig(config);\r\n        }\r\n    }\r\n\r\n    @Test\r\n    public void testOneInvalidAndMultipleValidHeaderConfigs() {\r\n        assertInvalidHeaderConfig(String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS)\r\n                                  + \", \" + INVALID_UNQUOTED_HEADER_CONFIGS.get(0));\r\n        assertInvalidHeaderConfig(INVALID_UNQUOTED_HEADER_CONFIGS.get(0) + \", \"\r\n                                  + String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS));\r\n    }\r\n\r\n    protected void assertValidHeaderConfig(String config) {\r\n        WorkerConfig.validateHttpResponseHeaderConfig(config);\r\n        // any valid config should be valid per HeaderFilter\r\n        configureHeaderFilter(config);\r\n    }\r\n\r\n    protected void assertInvalidHeaderConfig(String config) {\r\n        assertThrows(ConfigException.class, () -> WorkerConfig.validateHttpResponseHeaderConfig(config));\r\n        // any invalid config should be also be invalid per HeaderFilter\r\n        assertThrows(ConfigException.class, () -> configureHeaderFilter(config));\r\n    }\r\n\r\n    protected void configureHeaderFilter(String headerConfig) {\r\n        FilterHolder headerFilterHolder = new FilterHolder(HeaderFilter.class);\r\n        headerFilterHolder.setInitParameter(\"headerConfig\", headerConfig);\r\n        try {\r\n            try {\r\n                headerFilterHolder.doStart();\r\n                headerFilterHolder.initialize();\r\n            } finally {\r\n                headerFilterHolder.doStop();\r\n            }\r\n        } catch (Exception e) {\r\n          // wrap in ConfigException to keep the test simple\r\n          throw new ConfigException(\"HeaderFilter failure\", e);\r\n        }\r\n    }\r\n```", "bodyText": "These are great and very useful, but they still don't thoroughly test the validateHttpResponseHeaderConfig and validateHeaderConfigAction methods. If you make these methods static, package-protected in the WorkerConfig class (rather than in a nested class), then you can easily add more tests to WorkerConfigTest that thoroughly verify all of the logic in those methods.\nFor example, something like the following in WorkerConfigTest:\n    protected static final List<String> VALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            \"\\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\",\n            \"add X-XSS-Protection: 1; mode=block\",\n            \"add Strict-Transport-Security: max-age=31536000; includeSubDomains\",\n            \"AdD   Strict-Transport-Security:    max-age=31536000;  includeSubDomains\",\n            \"AdD \\t Strict-Transport-Security : \\n   max-age=31536000;  includeSubDomains\",\n            \"add X-Content-Type-Options: nosniff\"\n    );\n\n    protected static final List<String> VALID_QUOTE_REQUIRED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            \"add Cache-Control: no-cache, no-store, must-revalidate\"\n    );\n\n    protected static final List<String> INVALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            \"WRONG Cache-Control: no-cache\",\n            \"add Cache-Control no-cache\",\n            \"WRONG Cache-Control: no-cache, no-store, must-revalidate\",\n    );\n\n    protected static final String WHITESPACE = \" \\t \\n  \";\n\n    @Test\n    public void testSingleValidHeaderConfigs() {\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(config);\n        }\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(\"\\\"\" + config + \"\\\"\");\n        }\n    }\n\n    @Test\n    public void testSingleValidHeaderConfigsWithWhitespace() {\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(WHITESPACE + config + WHITESPACE);\n        }\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(WHITESPACE + \"\\\"\" + WHITESPACE + config + WHITESPACE + \"\\\"\" + WHITESPACE);\n        }\n    }\n\n    @Test\n    public void testMultipleValidHeaderConfigsWithoutWhitespace() {\n        assertValidHeaderConfig(String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS));\n        assertValidHeaderConfig(String.join(\" , \", VALID_UNQUOTED_HEADER_CONFIGS));\n    }\n\n    @Test\n    public void testHeaderConfigsThatRequireQuotes() {\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertInvalidHeaderConfig(config);\n        }\n    }\n\n    @Test\n    public void testInvalidHeaderConfigs() {\n        for (String config : INVALID_UNQUOTED_HEADER_CONFIGS) {\n            assertInvalidHeaderConfig(config);\n        }\n    }\n\n    @Test\n    public void testOneInvalidAndMultipleValidHeaderConfigs() {\n        assertInvalidHeaderConfig(String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS)\n                                  + \", \" + INVALID_UNQUOTED_HEADER_CONFIGS.get(0));\n        assertInvalidHeaderConfig(INVALID_UNQUOTED_HEADER_CONFIGS.get(0) + \", \"\n                                  + String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS));\n    }\n\n    protected void assertValidHeaderConfig(String config) {\n        WorkerConfig.validateHttpResponseHeaderConfig(config);\n        // any valid config should be valid per HeaderFilter\n        configureHeaderFilter(config);\n    }\n\n    protected void assertInvalidHeaderConfig(String config) {\n        assertThrows(ConfigException.class, () -> WorkerConfig.validateHttpResponseHeaderConfig(config));\n        // any invalid config should be also be invalid per HeaderFilter\n        assertThrows(ConfigException.class, () -> configureHeaderFilter(config));\n    }\n\n    protected void configureHeaderFilter(String headerConfig) {\n        FilterHolder headerFilterHolder = new FilterHolder(HeaderFilter.class);\n        headerFilterHolder.setInitParameter(\"headerConfig\", headerConfig);\n        try {\n            try {\n                headerFilterHolder.doStart();\n                headerFilterHolder.initialize();\n            } finally {\n                headerFilterHolder.doStop();\n            }\n        } catch (Exception e) {\n          // wrap in ConfigException to keep the test simple\n          throw new ConfigException(\"HeaderFilter failure\", e);\n        }\n    }", "bodyHTML": "<p dir=\"auto\">These are great and very useful, but they still don't thoroughly test the <code>validateHttpResponseHeaderConfig</code> and <code>validateHeaderConfigAction</code> methods. If you make these methods static, package-protected in the <code>WorkerConfig</code> class (rather than in a nested class), then you can easily add more tests to <code>WorkerConfigTest</code> that thoroughly verify all of the logic in those methods.</p>\n<p dir=\"auto\">For example, something like the following in <code>WorkerConfigTest</code>:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    protected static final List&lt;String&gt; VALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            &quot;\\&quot;add Cache-Control: no-cache, no-store, must-revalidate\\&quot;&quot;,\n            &quot;add X-XSS-Protection: 1; mode=block&quot;,\n            &quot;add Strict-Transport-Security: max-age=31536000; includeSubDomains&quot;,\n            &quot;AdD   Strict-Transport-Security:    max-age=31536000;  includeSubDomains&quot;,\n            &quot;AdD \\t Strict-Transport-Security : \\n   max-age=31536000;  includeSubDomains&quot;,\n            &quot;add X-Content-Type-Options: nosniff&quot;\n    );\n\n    protected static final List&lt;String&gt; VALID_QUOTE_REQUIRED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            &quot;add Cache-Control: no-cache, no-store, must-revalidate&quot;\n    );\n\n    protected static final List&lt;String&gt; INVALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            &quot;WRONG Cache-Control: no-cache&quot;,\n            &quot;add Cache-Control no-cache&quot;,\n            &quot;WRONG Cache-Control: no-cache, no-store, must-revalidate&quot;,\n    );\n\n    protected static final String WHITESPACE = &quot; \\t \\n  &quot;;\n\n    @Test\n    public void testSingleValidHeaderConfigs() {\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(config);\n        }\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(&quot;\\&quot;&quot; + config + &quot;\\&quot;&quot;);\n        }\n    }\n\n    @Test\n    public void testSingleValidHeaderConfigsWithWhitespace() {\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(WHITESPACE + config + WHITESPACE);\n        }\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(WHITESPACE + &quot;\\&quot;&quot; + WHITESPACE + config + WHITESPACE + &quot;\\&quot;&quot; + WHITESPACE);\n        }\n    }\n\n    @Test\n    public void testMultipleValidHeaderConfigsWithoutWhitespace() {\n        assertValidHeaderConfig(String.join(&quot;, &quot;, VALID_UNQUOTED_HEADER_CONFIGS));\n        assertValidHeaderConfig(String.join(&quot; , &quot;, VALID_UNQUOTED_HEADER_CONFIGS));\n    }\n\n    @Test\n    public void testHeaderConfigsThatRequireQuotes() {\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertInvalidHeaderConfig(config);\n        }\n    }\n\n    @Test\n    public void testInvalidHeaderConfigs() {\n        for (String config : INVALID_UNQUOTED_HEADER_CONFIGS) {\n            assertInvalidHeaderConfig(config);\n        }\n    }\n\n    @Test\n    public void testOneInvalidAndMultipleValidHeaderConfigs() {\n        assertInvalidHeaderConfig(String.join(&quot;, &quot;, VALID_UNQUOTED_HEADER_CONFIGS)\n                                  + &quot;, &quot; + INVALID_UNQUOTED_HEADER_CONFIGS.get(0));\n        assertInvalidHeaderConfig(INVALID_UNQUOTED_HEADER_CONFIGS.get(0) + &quot;, &quot;\n                                  + String.join(&quot;, &quot;, VALID_UNQUOTED_HEADER_CONFIGS));\n    }\n\n    protected void assertValidHeaderConfig(String config) {\n        WorkerConfig.validateHttpResponseHeaderConfig(config);\n        // any valid config should be valid per HeaderFilter\n        configureHeaderFilter(config);\n    }\n\n    protected void assertInvalidHeaderConfig(String config) {\n        assertThrows(ConfigException.class, () -&gt; WorkerConfig.validateHttpResponseHeaderConfig(config));\n        // any invalid config should be also be invalid per HeaderFilter\n        assertThrows(ConfigException.class, () -&gt; configureHeaderFilter(config));\n    }\n\n    protected void configureHeaderFilter(String headerConfig) {\n        FilterHolder headerFilterHolder = new FilterHolder(HeaderFilter.class);\n        headerFilterHolder.setInitParameter(&quot;headerConfig&quot;, headerConfig);\n        try {\n            try {\n                headerFilterHolder.doStart();\n                headerFilterHolder.initialize();\n            } finally {\n                headerFilterHolder.doStop();\n            }\n        } catch (Exception e) {\n          // wrap in ConfigException to keep the test simple\n          throw new ConfigException(&quot;HeaderFilter failure&quot;, e);\n        }\n    }\n\"><pre><code>    protected static final List&lt;String&gt; VALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            \"\\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\",\n            \"add X-XSS-Protection: 1; mode=block\",\n            \"add Strict-Transport-Security: max-age=31536000; includeSubDomains\",\n            \"AdD   Strict-Transport-Security:    max-age=31536000;  includeSubDomains\",\n            \"AdD \\t Strict-Transport-Security : \\n   max-age=31536000;  includeSubDomains\",\n            \"add X-Content-Type-Options: nosniff\"\n    );\n\n    protected static final List&lt;String&gt; VALID_QUOTE_REQUIRED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            \"add Cache-Control: no-cache, no-store, must-revalidate\"\n    );\n\n    protected static final List&lt;String&gt; INVALID_UNQUOTED_HEADER_CONFIGS = Arrays.asList(\n            // TODO: Add a lot more valid header configs\n            \"WRONG Cache-Control: no-cache\",\n            \"add Cache-Control no-cache\",\n            \"WRONG Cache-Control: no-cache, no-store, must-revalidate\",\n    );\n\n    protected static final String WHITESPACE = \" \\t \\n  \";\n\n    @Test\n    public void testSingleValidHeaderConfigs() {\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(config);\n        }\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(\"\\\"\" + config + \"\\\"\");\n        }\n    }\n\n    @Test\n    public void testSingleValidHeaderConfigsWithWhitespace() {\n        for (String config : VALID_UNQUOTED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(WHITESPACE + config + WHITESPACE);\n        }\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertValidHeaderConfig(WHITESPACE + \"\\\"\" + WHITESPACE + config + WHITESPACE + \"\\\"\" + WHITESPACE);\n        }\n    }\n\n    @Test\n    public void testMultipleValidHeaderConfigsWithoutWhitespace() {\n        assertValidHeaderConfig(String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS));\n        assertValidHeaderConfig(String.join(\" , \", VALID_UNQUOTED_HEADER_CONFIGS));\n    }\n\n    @Test\n    public void testHeaderConfigsThatRequireQuotes() {\n        for (String config : VALID_QUOTE_REQUIRED_HEADER_CONFIGS) {\n            assertInvalidHeaderConfig(config);\n        }\n    }\n\n    @Test\n    public void testInvalidHeaderConfigs() {\n        for (String config : INVALID_UNQUOTED_HEADER_CONFIGS) {\n            assertInvalidHeaderConfig(config);\n        }\n    }\n\n    @Test\n    public void testOneInvalidAndMultipleValidHeaderConfigs() {\n        assertInvalidHeaderConfig(String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS)\n                                  + \", \" + INVALID_UNQUOTED_HEADER_CONFIGS.get(0));\n        assertInvalidHeaderConfig(INVALID_UNQUOTED_HEADER_CONFIGS.get(0) + \", \"\n                                  + String.join(\", \", VALID_UNQUOTED_HEADER_CONFIGS));\n    }\n\n    protected void assertValidHeaderConfig(String config) {\n        WorkerConfig.validateHttpResponseHeaderConfig(config);\n        // any valid config should be valid per HeaderFilter\n        configureHeaderFilter(config);\n    }\n\n    protected void assertInvalidHeaderConfig(String config) {\n        assertThrows(ConfigException.class, () -&gt; WorkerConfig.validateHttpResponseHeaderConfig(config));\n        // any invalid config should be also be invalid per HeaderFilter\n        assertThrows(ConfigException.class, () -&gt; configureHeaderFilter(config));\n    }\n\n    protected void configureHeaderFilter(String headerConfig) {\n        FilterHolder headerFilterHolder = new FilterHolder(HeaderFilter.class);\n        headerFilterHolder.setInitParameter(\"headerConfig\", headerConfig);\n        try {\n            try {\n                headerFilterHolder.doStart();\n                headerFilterHolder.initialize();\n            } finally {\n                headerFilterHolder.doStop();\n            }\n        } catch (Exception e) {\n          // wrap in ConfigException to keep the test simple\n          throw new ConfigException(\"HeaderFilter failure\", e);\n        }\n    }\n</code></pre></div>", "author": "rhauch", "createdAt": "2020-05-06T15:59:45Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +395,98 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void testValidCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig =\n+                \"add X-XSS-Protection: 1; mode=block, \\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        expectedHeaders.put(\"X-XSS-Protection\", \"1; mode=block\");\n+        expectedHeaders.put(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void testDefaultCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig = \"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigFormat() {\n+        String headerConfig = \"set add X-XSS-Protection: 1\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new DistributedConfig(workerProps);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testMissedAction() {\n+        String headerConfig = \"X-Frame-Options: DENY\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new DistributedConfig(workerProps);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testMissedHeaderName() {\n+        String headerConfig = \"add :DENY\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new DistributedConfig(workerProps);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testMissedHeaderValue() {\n+        String headerConfig = \"add X-Frame-Options\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new DistributedConfig(workerProps);\n+    }\n+\n+    @Test(expected = ConfigException.class)\n+    public void testInvalidHeaderConfigAction() {\n+        String headerConfig = \"badaction X-XSS-Protection: 1; mode=block\";\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new DistributedConfig(workerProps);\n+    }\n+\n+    public void checkCustomizedHttpResponseHeaders(String headerConfig, Map<String, String> expectedHeaders)\n+            throws IOException  {\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new DistributedConfig(workerProps);\n+\n+        EasyMock.expect(herder.kafkaClusterId()).andReturn(KAFKA_CLUSTER_ID);\n+        EasyMock.expect(herder.plugins()).andStubReturn(plugins);\n+        EasyMock.expect(plugins.newPlugins(Collections.emptyList(),\n+                workerConfig,\n+                ConnectRestExtension.class)).andStubReturn(Collections.emptyList());\n+\n+        EasyMock.expect(herder.connectors()).andReturn(Arrays.asList(\"a\", \"b\"));\n+\n+        PowerMock.replayAll();\n+\n+        server = new RestServer(workerConfig);\n+        server.initializeServer();\n+        server.initializeResources(herder);\n+        HttpRequest request = new HttpGet(\"/connectors\");\n+        CloseableHttpClient httpClient = HttpClients.createMinimal();\n+        HttpHost httpHost = new HttpHost(server.advertisedUrl().getHost(), server.advertisedUrl().getPort());\n+        CloseableHttpResponse response = httpClient.execute(httpHost, request);\n+        Assert.assertEquals(200, response.getStatusLine().getStatusCode());\n+        if (!headerConfig.isEmpty()) {\n+            expectedHeaders.forEach((k, v) ->\n+                    Assert.assertEquals(response.getFirstHeader(k).getValue(), v));\n+        } else {\n+            Assert.assertNull(response.getFirstHeader(\"X-Frame-Options\"));\n+        }\n+        response.close();\n+        server.stop();\n+    }\n+", "originalCommit": "98c1cf0eb18a8481291b913f324489bd99904e7f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE0NzIxOA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421147218", "bodyText": "It is good idea  to assert each checking using assertValidHeaderConfig and assertInvalidHeaderConfig. I think latest version will cover validation of header config. Please let me know. For all valid header config cases, testValidCustomizedHttpResponseHeaders should cover both config validation at config phase and validation on FilterHolder layer.", "author": "jeffhuang26", "createdAt": "2020-05-06T23:19:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwNjUxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2Mjk0Nw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421762947", "bodyText": "Looks good. I like the additional checking that you're doing here.", "author": "rhauch", "createdAt": "2020-05-07T20:06:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwNjUxMQ=="}], "type": "inlineReview"}, {"oid": "afc2c4e141e60097886119cc97561a8e4d2188b5", "url": "https://github.com/apache/kafka/commit/afc2c4e141e60097886119cc97561a8e4d2188b5", "message": "Updated code based on review comments.", "committedDate": "2020-05-06T23:13:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1ODg3Nw==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421758877", "body": "I think this method should be on `ResponseHttpHeadersValidator`, not the `WorkerConfig`.", "bodyText": "I think this method should be on ResponseHttpHeadersValidator, not the WorkerConfig.", "bodyHTML": "<p dir=\"auto\">I think this method should be on <code>ResponseHttpHeadersValidator</code>, not the <code>WorkerConfig</code>.</p>", "author": "rhauch", "createdAt": "2020-05-07T19:59:14Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -400,6 +412,53 @@ public WorkerConfig(ConfigDef definition, Map<String, String> props) {\n         logInternalConverterDeprecationWarnings(props);\n     }\n \n+    @Override\n+    public String toString() {\n+        return \"Comma-separated header rules, where each header rule is of the form \"\n+                + \"'[action] [header name]:[header value]' and optionally surrounded by double quotes \"\n+                + \"if any part of a header rule contains a comma\";\n+    }", "originalCommit": "afc2c4e141e60097886119cc97561a8e4d2188b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1OTE3OQ==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421759179", "body": "This could be package-level protected, right? The only place it should be called is in `ResponseHttpHeadersValidator` and in tests.\r\n```suggestion\r\n    // Visible for testing\r\n    static void validateHttpResponseHeaderConfig(String config) {\r\n```", "bodyText": "This could be package-level protected, right? The only place it should be called is in ResponseHttpHeadersValidator and in tests.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void validateHttpResponseHeaderConfig(String config) {\n          \n          \n            \n                // Visible for testing\n          \n          \n            \n                static void validateHttpResponseHeaderConfig(String config) {", "bodyHTML": "<p dir=\"auto\">This could be package-level protected, right? The only place it should be called is in <code>ResponseHttpHeadersValidator</code> and in tests.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">public</span><span class=\"x\"> </span><span class=\"pl-k x\">static</span><span class=\"x\"> </span><span class=\"pl-k x\">void</span><span class=\"x\"> validateHttpResponseHeaderConfig(</span><span class=\"pl-smi x\">String</span><span class=\"x x-last\"> config) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c x x-first\">//</span><span class=\"x x-last\"> Visible for testing</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">static</span> <span class=\"pl-k\">void</span> validateHttpResponseHeaderConfig(<span class=\"pl-smi\">String</span> config) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-07T19:59:43Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -400,6 +412,53 @@ public WorkerConfig(ConfigDef definition, Map<String, String> props) {\n         logInternalConverterDeprecationWarnings(props);\n     }\n \n+    @Override\n+    public String toString() {\n+        return \"Comma-separated header rules, where each header rule is of the form \"\n+                + \"'[action] [header name]:[header value]' and optionally surrounded by double quotes \"\n+                + \"if any part of a header rule contains a comma\";\n+    }\n+\n+    public static void validateHttpResponseHeaderConfig(String config) {", "originalCommit": "afc2c4e141e60097886119cc97561a8e4d2188b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk1NTU5NA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421955594", "bodyText": "Cannot pass compile after changed to either default package level or protected due to RestServerTest call it and they are on different package.", "author": "jeffhuang26", "createdAt": "2020-05-08T06:01:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1OTE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjM4NTMzMA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r422385330", "bodyText": "Then how about making these package-level protected (as I mentioned) and moving the tests of these methods to WorkerConfigTest instead?", "author": "rhauch", "createdAt": "2020-05-08T21:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1OTE3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMTI4OQ==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r422511289", "bodyText": "Actually should move these header config verification tests to WorkerConfigTest.", "author": "jeffhuang26", "createdAt": "2020-05-09T15:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1OTE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc1OTk4OA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421759988", "body": "What about adding valid configs for `set`, `addDate` and `setDate`, too?", "bodyText": "What about adding valid configs for set, addDate and setDate, too?", "bodyHTML": "<p dir=\"auto\">What about adding valid configs for <code>set</code>, <code>addDate</code> and <code>setDate</code>, too?</p>", "author": "rhauch", "createdAt": "2020-05-07T20:01:14Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -54,17 +55,40 @@\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.Map;\n+import java.util.List;\n \n import static org.apache.kafka.connect.runtime.WorkerConfig.ADMIN_LISTENERS_CONFIG;\n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertNotEquals;\n import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertNull;\n import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertThrows;\n \n @RunWith(PowerMockRunner.class)\n @PowerMockIgnore({\"javax.net.ssl.*\", \"javax.security.*\", \"javax.crypto.*\"})\n public class RestServerTest {\n+    protected static final String WHITESPACE = \" \\t \\n \\r \";\n+    protected static final List<String> VALID_HEADER_CONFIGS = Arrays.asList(\n+            \"add \\t Cache-Control: no-cache, no-store, must-revalidate\",\n+            \"add \\r X-XSS-Protection: 1; mode=block\",\n+            \"\\n add Strict-Transport-Security: max-age=31536000; includeSubDomains\",\n+            \"AdD   Strict-Transport-Security:  \\r  max-age=31536000;  includeSubDomains\",\n+            \"AdD \\t Strict-Transport-Security : \\n   max-age=31536000;  includeSubDomains\",\n+            \"add X-Content-Type-Options: \\r nosniff\"", "originalCommit": "afc2c4e141e60097886119cc97561a8e4d2188b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2MjY2NA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421762664", "body": "How about putting the `server.stop()` and `server = null` in a finally block? Also, `CloseableHttpResponse` is `AutoCloseable`, so we could actually use a try-with-resources here:\r\n```suggestion\r\n        server = new RestServer(workerConfig);\r\n        try {\r\n          server.initializeServer();\r\n          server.initializeResources(herder);\r\n          HttpRequest request = new HttpGet(\"/connectors\");\r\n          try (CloseableHttpClient httpClient = HttpClients.createMinimal()) {\r\n            HttpHost httpHost = new HttpHost(server.advertisedUrl().getHost(), server.advertisedUrl().getPort());\r\n            try (CloseableHttpResponse response = httpClient.execute(httpHost, request)) {\r\n              Assert.assertEquals(200, response.getStatusLine().getStatusCode());\r\n              if (!headerConfig.isEmpty()) {\r\n                  expectedHeaders.forEach((k, v) ->\r\n                          Assert.assertEquals(response.getFirstHeader(k).getValue(), v));\r\n              } else {\r\n                  Assert.assertNull(response.getFirstHeader(\"X-Frame-Options\"));\r\n              }\r\n            }\r\n          }\r\n        } finally {\r\n          server.stop();\r\n          server = null;\r\n        }\r\n```", "bodyText": "How about putting the server.stop() and server = null in a finally block? Also, CloseableHttpResponse is AutoCloseable, so we could actually use a try-with-resources here:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    server = new RestServer(workerConfig);\n          \n          \n            \n                    server.initializeServer();\n          \n          \n            \n                    server.initializeResources(herder);\n          \n          \n            \n                    HttpRequest request = new HttpGet(\"/connectors\");\n          \n          \n            \n                    CloseableHttpClient httpClient = HttpClients.createMinimal();\n          \n          \n            \n                    HttpHost httpHost = new HttpHost(server.advertisedUrl().getHost(), server.advertisedUrl().getPort());\n          \n          \n            \n                    CloseableHttpResponse response = httpClient.execute(httpHost, request);\n          \n          \n            \n                    Assert.assertEquals(200, response.getStatusLine().getStatusCode());\n          \n          \n            \n                    if (!headerConfig.isEmpty()) {\n          \n          \n            \n                        expectedHeaders.forEach((k, v) ->\n          \n          \n            \n                                Assert.assertEquals(response.getFirstHeader(k).getValue(), v));\n          \n          \n            \n                    } else {\n          \n          \n            \n                        Assert.assertNull(response.getFirstHeader(\"X-Frame-Options\"));\n          \n          \n            \n                    }\n          \n          \n            \n                    response.close();\n          \n          \n            \n                    server.stop();\n          \n          \n            \n                    server = new RestServer(workerConfig);\n          \n          \n            \n                    try {\n          \n          \n            \n                      server.initializeServer();\n          \n          \n            \n                      server.initializeResources(herder);\n          \n          \n            \n                      HttpRequest request = new HttpGet(\"/connectors\");\n          \n          \n            \n                      try (CloseableHttpClient httpClient = HttpClients.createMinimal()) {\n          \n          \n            \n                        HttpHost httpHost = new HttpHost(server.advertisedUrl().getHost(), server.advertisedUrl().getPort());\n          \n          \n            \n                        try (CloseableHttpResponse response = httpClient.execute(httpHost, request)) {\n          \n          \n            \n                          Assert.assertEquals(200, response.getStatusLine().getStatusCode());\n          \n          \n            \n                          if (!headerConfig.isEmpty()) {\n          \n          \n            \n                              expectedHeaders.forEach((k, v) ->\n          \n          \n            \n                                      Assert.assertEquals(response.getFirstHeader(k).getValue(), v));\n          \n          \n            \n                          } else {\n          \n          \n            \n                              Assert.assertNull(response.getFirstHeader(\"X-Frame-Options\"));\n          \n          \n            \n                          }\n          \n          \n            \n                        }\n          \n          \n            \n                      }\n          \n          \n            \n                    } finally {\n          \n          \n            \n                      server.stop();\n          \n          \n            \n                      server = null;\n          \n          \n            \n                    }", "bodyHTML": "<p dir=\"auto\">How about putting the <code>server.stop()</code> and <code>server = null</code> in a finally block? Also, <code>CloseableHttpResponse</code> is <code>AutoCloseable</code>, so we could actually use a try-with-resources here:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        server <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RestServer</span>(workerConfig);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        server<span class=\"pl-k\">.</span>initializeServer();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        server<span class=\"pl-k\">.</span>initializeResources(herder);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">HttpRequest</span> request <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">HttpGet</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/connectors<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">CloseableHttpClient</span> httpClient <span class=\"pl-k\">=</span> <span class=\"pl-smi\">HttpClients</span><span class=\"pl-k\">.</span>createMinimal();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">HttpHost</span> httpHost <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">HttpHost</span>(server<span class=\"pl-k\">.</span>advertisedUrl()<span class=\"pl-k\">.</span>getHost(), server<span class=\"pl-k\">.</span>advertisedUrl()<span class=\"pl-k\">.</span>getPort());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">CloseableHttpResponse</span> response <span class=\"pl-k\">=</span> httpClient<span class=\"pl-k\">.</span>execute(httpHost, request);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertEquals(<span class=\"pl-c1\">200</span>, response<span class=\"pl-k\">.</span>getStatusLine()<span class=\"pl-k\">.</span>getStatusCode());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>headerConfig<span class=\"pl-k\">.</span>isEmpty()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            expectedHeaders<span class=\"pl-k\">.</span>forEach((k, v) <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertEquals(response<span class=\"pl-k\">.</span>getFirstHeader(k)<span class=\"pl-k\">.</span>getValue(), v));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertNull(response<span class=\"pl-k\">.</span>getFirstHeader(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>X-Frame-Options<span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        response<span class=\"pl-k\">.</span>close();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        server<span class=\"pl-k\">.</span>stop();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        server <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RestServer</span>(workerConfig);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          server<span class=\"pl-k\">.</span>initializeServer();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          server<span class=\"pl-k\">.</span>initializeResources(herder);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          <span class=\"pl-smi\">HttpRequest</span> request <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">HttpGet</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/connectors<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          <span class=\"pl-k\">try</span> (<span class=\"pl-smi\">CloseableHttpClient</span> httpClient <span class=\"pl-k\">=</span> <span class=\"pl-smi\">HttpClients</span><span class=\"pl-k\">.</span>createMinimal()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">HttpHost</span> httpHost <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">HttpHost</span>(server<span class=\"pl-k\">.</span>advertisedUrl()<span class=\"pl-k\">.</span>getHost(), server<span class=\"pl-k\">.</span>advertisedUrl()<span class=\"pl-k\">.</span>getPort());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">try</span> (<span class=\"pl-smi\">CloseableHttpResponse</span> response <span class=\"pl-k\">=</span> httpClient<span class=\"pl-k\">.</span>execute(httpHost, request)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">              <span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertEquals(<span class=\"pl-c1\">200</span>, response<span class=\"pl-k\">.</span>getStatusLine()<span class=\"pl-k\">.</span>getStatusCode());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">              <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>headerConfig<span class=\"pl-k\">.</span>isEmpty()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                  expectedHeaders<span class=\"pl-k\">.</span>forEach((k, v) <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                          <span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertEquals(response<span class=\"pl-k\">.</span>getFirstHeader(k)<span class=\"pl-k\">.</span>getValue(), v));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">              } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                  <span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertNull(response<span class=\"pl-k\">.</span>getFirstHeader(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>X-Frame-Options<span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">              }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        } <span class=\"pl-k\">finally</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          server<span class=\"pl-k\">.</span>stop();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          server <span class=\"pl-k\">=</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-07T20:06:25Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/rest/RestServerTest.java", "diffHunk": "@@ -392,6 +418,80 @@ public void testDisableAdminEndpoint() throws IOException {\n         Assert.assertEquals(404, response.getStatusLine().getStatusCode());\n     }\n \n+    @Test\n+    public void testValidCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig =\n+                \"add X-XSS-Protection: 1; mode=block, \\\"add Cache-Control: no-cache, no-store, must-revalidate\\\"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        expectedHeaders.put(\"X-XSS-Protection\", \"1; mode=block\");\n+        expectedHeaders.put(\"Cache-Control\", \"no-cache, no-store, must-revalidate\");\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void testDefaultCustomizedHttpResponseHeaders() throws IOException  {\n+        String headerConfig = \"\";\n+        Map<String, String> expectedHeaders = new HashMap<>();\n+        checkCustomizedHttpResponseHeaders(headerConfig, expectedHeaders);\n+    }\n+\n+    @Test\n+    public void testInvalidHeaderConfigs() {\n+        for (String config : INVALID_HEADER_CONFIGS) {\n+            assertInvalidHeaderConfig(config);\n+        }\n+    }\n+\n+    @Test\n+    public void testValidHeaderConfigs() {\n+        for (String config : VALID_HEADER_CONFIGS) {\n+            assertValidHeaderConfig(config);\n+        }\n+    }\n+\n+    public void checkCustomizedHttpResponseHeaders(String headerConfig, Map<String, String> expectedHeaders)\n+            throws IOException  {\n+        Map<String, String> workerProps = baseWorkerProps();\n+        workerProps.put(\"offset.storage.file.filename\", \"/tmp\");\n+        workerProps.put(WorkerConfig.RESPONSE_HTTP_HEADERS_CONFIG, headerConfig);\n+        WorkerConfig workerConfig = new DistributedConfig(workerProps);\n+\n+        EasyMock.expect(herder.kafkaClusterId()).andReturn(KAFKA_CLUSTER_ID);\n+        EasyMock.expect(herder.plugins()).andStubReturn(plugins);\n+        EasyMock.expect(plugins.newPlugins(Collections.emptyList(),\n+                workerConfig,\n+                ConnectRestExtension.class)).andStubReturn(Collections.emptyList());\n+\n+        EasyMock.expect(herder.connectors()).andReturn(Arrays.asList(\"a\", \"b\"));\n+\n+        PowerMock.replayAll();\n+\n+        server = new RestServer(workerConfig);\n+        server.initializeServer();\n+        server.initializeResources(herder);\n+        HttpRequest request = new HttpGet(\"/connectors\");\n+        CloseableHttpClient httpClient = HttpClients.createMinimal();\n+        HttpHost httpHost = new HttpHost(server.advertisedUrl().getHost(), server.advertisedUrl().getPort());\n+        CloseableHttpResponse response = httpClient.execute(httpHost, request);\n+        Assert.assertEquals(200, response.getStatusLine().getStatusCode());\n+        if (!headerConfig.isEmpty()) {\n+            expectedHeaders.forEach((k, v) ->\n+                    Assert.assertEquals(response.getFirstHeader(k).getValue(), v));\n+        } else {\n+            Assert.assertNull(response.getFirstHeader(\"X-Frame-Options\"));\n+        }\n+        response.close();\n+        server.stop();", "originalCommit": "afc2c4e141e60097886119cc97561a8e4d2188b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTc2MzQwOA==", "url": "https://github.com/apache/kafka/pull/8620#discussion_r421763408", "body": "This should be package-level protected:\r\n```suggestion\r\n    // Visible for testing\r\n    static void validateHeaderConfigAction(String action) {\r\n```", "bodyText": "This should be package-level protected:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void validateHeaderConfigAction(String action) {\n          \n          \n            \n                // Visible for testing\n          \n          \n            \n                static void validateHeaderConfigAction(String action) {", "bodyHTML": "<p dir=\"auto\">This should be package-level protected:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">public</span><span class=\"x\"> </span><span class=\"pl-k x\">static</span><span class=\"x\"> </span><span class=\"pl-k x\">void</span><span class=\"x\"> validateHeaderConfigAction(</span><span class=\"pl-smi x\">String</span><span class=\"x x-last\"> action) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c x x-first\">//</span><span class=\"x x-last\"> Visible for testing</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">static</span> <span class=\"pl-k\">void</span> validateHeaderConfigAction(<span class=\"pl-smi\">String</span> action) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "rhauch", "createdAt": "2020-05-07T20:07:52Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfig.java", "diffHunk": "@@ -400,6 +412,53 @@ public WorkerConfig(ConfigDef definition, Map<String, String> props) {\n         logInternalConverterDeprecationWarnings(props);\n     }\n \n+    @Override\n+    public String toString() {\n+        return \"Comma-separated header rules, where each header rule is of the form \"\n+                + \"'[action] [header name]:[header value]' and optionally surrounded by double quotes \"\n+                + \"if any part of a header rule contains a comma\";\n+    }\n+\n+    public static void validateHttpResponseHeaderConfig(String config) {\n+        try {\n+            // validate format\n+            String[] configTokens = config.trim().split(\"\\\\s+\", 2);\n+            if (configTokens.length != 2) {\n+                throw new ConfigException(String.format(\"Invalid format of header config '%s\\'. \"\n+                        + \"Expected: '[ation] [header name]:[header value]'\", config));\n+            }\n+\n+            // validate action\n+            String method = configTokens[0].trim();\n+            validateHeaderConfigAction(method);\n+\n+            // validate header name and header value pair\n+            String header = configTokens[1];\n+            String[] headerTokens = header.trim().split(\":\");\n+            if (headerTokens.length != 2) {\n+                throw new ConfigException(\n+                        String.format(\"Invalid format of header name and header value pair '%s'. \"\n+                                + \"Expected: '[header name]:[header value]'\", header));\n+            }\n+\n+            // validate header name\n+            String headerName = headerTokens[0].trim();\n+            if (headerName.isEmpty() || headerName.matches(\".*\\\\s+.*\")) {\n+                throw new ConfigException(String.format(\"Invalid header name '%s'. \"\n+                        + \"The '[header name]' cannot contain whitespace\", headerName));\n+            }\n+        } catch (ArrayIndexOutOfBoundsException e) {\n+            throw new ConfigException(String.format(\"Invalid header config '%s'.\", config), e);\n+        }\n+    }\n+\n+    public static void validateHeaderConfigAction(String action) {", "originalCommit": "afc2c4e141e60097886119cc97561a8e4d2188b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3ceccb4b059c11327b79f93c203ac22413a35c06", "url": "https://github.com/apache/kafka/commit/3ceccb4b059c11327b79f93c203ac22413a35c06", "message": "Updated code based on review comments.", "committedDate": "2020-05-08T06:04:39Z", "type": "commit"}, {"oid": "f061423f4b5e2118563eb820fb8e88abb1490efe", "url": "https://github.com/apache/kafka/commit/f061423f4b5e2118563eb820fb8e88abb1490efe", "message": "Updated code based on review.", "committedDate": "2020-05-09T15:43:38Z", "type": "commit"}]}