{"pr_number": 9748, "pr_title": "MINOR: Simplify ApiKeys by relying on ApiMessageType", "pr_author": "ijuma", "pr_createdAt": "2020-12-14T15:42:17Z", "pr_url": "https://github.com/apache/kafka/pull/9748", "timeline": [{"oid": "ddad298d011353a6d188e53e9bcf00a26eda9496", "url": "https://github.com/apache/kafka/commit/ddad298d011353a6d188e53e9bcf00a26eda9496", "message": "MINOR: Simplify ApiKeys by relying on ApiMessageType and removing unused methods", "committedDate": "2020-12-15T06:44:23Z", "type": "commit"}, {"oid": "ddad298d011353a6d188e53e9bcf00a26eda9496", "url": "https://github.com/apache/kafka/commit/ddad298d011353a6d188e53e9bcf00a26eda9496", "message": "MINOR: Simplify ApiKeys by relying on ApiMessageType and removing unused methods", "committedDate": "2020-12-15T06:44:23Z", "type": "forcePushed"}, {"oid": "89ee566e466cd58023c6a4cac64893bfcf38b570", "url": "https://github.com/apache/kafka/commit/89ee566e466cd58023c6a4cac64893bfcf38b570", "message": "ListOffset -> ListOffsets for consistency with the existing API name", "committedDate": "2020-12-15T15:03:54Z", "type": "commit"}, {"oid": "69ae2114341290febe3d3360773b2ac25fd923d3", "url": "https://github.com/apache/kafka/commit/69ae2114341290febe3d3360773b2ac25fd923d3", "message": "Remove unused method", "committedDate": "2020-12-15T15:07:32Z", "type": "commit"}, {"oid": "53b72a8c2099c3a2bd746490b20b0db3628f6737", "url": "https://github.com/apache/kafka/commit/53b72a8c2099c3a2bd746490b20b0db3628f6737", "message": "Fix OffsetFetchResponseTest failure", "committedDate": "2020-12-15T15:07:43Z", "type": "commit"}, {"oid": "0378e08bd0c802b50ba8b7857158ee0dfee95b63", "url": "https://github.com/apache/kafka/commit/0378e08bd0c802b50ba8b7857158ee0dfee95b63", "message": "Don't assume ids are dense in ApiKeys and simplify the code", "committedDate": "2020-12-15T15:24:26Z", "type": "commit"}, {"oid": "dd7e8ea3d303e33b7af4cac3744680f666876024", "url": "https://github.com/apache/kafka/commit/dd7e8ea3d303e33b7af4cac3744680f666876024", "message": "Generate `highestSupportedVersion` and `lowestSupportedVersion`", "committedDate": "2020-12-15T15:34:37Z", "type": "commit"}, {"oid": "dc67beabe5124ac903bd42d085af08da5d0e2d2c", "url": "https://github.com/apache/kafka/commit/dc67beabe5124ac903bd42d085af08da5d0e2d2c", "message": "Replace checks in ApiKeys with unit tests in ApiMessageTypeTest", "committedDate": "2020-12-15T15:58:39Z", "type": "commit"}, {"oid": "37a7778af304326d41df5c60f754cf62ff4876f9", "url": "https://github.com/apache/kafka/commit/37a7778af304326d41df5c60f754cf62ff4876f9", "message": "Merge remote-tracking branch 'apache-github/trunk' into simplify-api-keys\n\n* apache-github/trunk:\n  KAFKA-10776: Add version attribute in RequestsPerSec metrics documentation (#9661)\n  KAFKA-10854: fix flaky testConnectionRatePerIp test (#9752)\n  KAFKA-10525: Emit JSONs with new auto-generated schema (KIP-673) (#9526)", "committedDate": "2020-12-15T16:03:20Z", "type": "commit"}, {"oid": "e8dc54737c14d60069348f23e71499bdb01f11b5", "url": "https://github.com/apache/kafka/commit/e8dc54737c14d60069348f23e71499bdb01f11b5", "message": "Fix compilation errors due to merge", "committedDate": "2020-12-15T16:19:22Z", "type": "commit"}, {"oid": "e8dc54737c14d60069348f23e71499bdb01f11b5", "url": "https://github.com/apache/kafka/commit/e8dc54737c14d60069348f23e71499bdb01f11b5", "message": "Fix compilation errors due to merge", "committedDate": "2020-12-15T16:19:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5OTYwMg==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r543799602", "body": "Does it need to check duplicate id?", "bodyText": "Does it need to check duplicate id?", "bodyHTML": "<p dir=\"auto\">Does it need to check duplicate id?</p>", "author": "chia7712", "createdAt": "2020-12-16T01:02:07Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/ApiKeys.java", "diffHunk": "@@ -157,124 +38,76 @@\n  * Identifiers for all the Kafka APIs\n  */\n public enum ApiKeys {\n-    PRODUCE(0, \"Produce\", ProduceRequestData.SCHEMAS, ProduceResponseData.SCHEMAS),\n-    FETCH(1, \"Fetch\", FetchRequestData.SCHEMAS, FetchResponseData.SCHEMAS),\n-    LIST_OFFSETS(2, \"ListOffsets\", ListOffsetRequestData.SCHEMAS, ListOffsetResponseData.SCHEMAS),\n-    METADATA(3, \"Metadata\", MetadataRequestData.SCHEMAS, MetadataResponseData.SCHEMAS),\n-    LEADER_AND_ISR(4, \"LeaderAndIsr\", true, LeaderAndIsrRequestData.SCHEMAS, LeaderAndIsrResponseData.SCHEMAS),\n-    STOP_REPLICA(5, \"StopReplica\", true, StopReplicaRequestData.SCHEMAS, StopReplicaResponseData.SCHEMAS),\n-    UPDATE_METADATA(6, \"UpdateMetadata\", true, UpdateMetadataRequestData.SCHEMAS, UpdateMetadataResponseData.SCHEMAS),\n-    CONTROLLED_SHUTDOWN(7, \"ControlledShutdown\", true, ControlledShutdownRequestData.SCHEMAS,\n-            ControlledShutdownResponseData.SCHEMAS),\n-    OFFSET_COMMIT(8, \"OffsetCommit\", OffsetCommitRequestData.SCHEMAS, OffsetCommitResponseData.SCHEMAS),\n-    OFFSET_FETCH(9, \"OffsetFetch\", OffsetFetchRequestData.SCHEMAS, OffsetFetchResponseData.SCHEMAS),\n-    FIND_COORDINATOR(10, \"FindCoordinator\", FindCoordinatorRequestData.SCHEMAS,\n-            FindCoordinatorResponseData.SCHEMAS),\n-    JOIN_GROUP(11, \"JoinGroup\", JoinGroupRequestData.SCHEMAS, JoinGroupResponseData.SCHEMAS),\n-    HEARTBEAT(12, \"Heartbeat\", HeartbeatRequestData.SCHEMAS, HeartbeatResponseData.SCHEMAS),\n-    LEAVE_GROUP(13, \"LeaveGroup\", LeaveGroupRequestData.SCHEMAS, LeaveGroupResponseData.SCHEMAS),\n-    SYNC_GROUP(14, \"SyncGroup\", SyncGroupRequestData.SCHEMAS, SyncGroupResponseData.SCHEMAS),\n-    DESCRIBE_GROUPS(15, \"DescribeGroups\", DescribeGroupsRequestData.SCHEMAS,\n-            DescribeGroupsResponseData.SCHEMAS),\n-    LIST_GROUPS(16, \"ListGroups\", ListGroupsRequestData.SCHEMAS, ListGroupsResponseData.SCHEMAS),\n-    SASL_HANDSHAKE(17, \"SaslHandshake\", SaslHandshakeRequestData.SCHEMAS, SaslHandshakeResponseData.SCHEMAS),\n-    API_VERSIONS(18, \"ApiVersions\", ApiVersionsRequestData.SCHEMAS, ApiVersionsResponseData.SCHEMAS) {\n-        @Override\n-        public Struct parseResponse(short version, ByteBuffer buffer) {\n-            // Fallback to version 0 for ApiVersions response. If a client sends an ApiVersionsRequest\n-            // using a version higher than that supported by the broker, a version 0 response is sent\n-            // to the client indicating UNSUPPORTED_VERSION.\n-            return parseResponse(version, buffer, (short) 0);\n-        }\n-    },\n-    CREATE_TOPICS(19, \"CreateTopics\", CreateTopicsRequestData.SCHEMAS, CreateTopicsResponseData.SCHEMAS, true),\n-    DELETE_TOPICS(20, \"DeleteTopics\", DeleteTopicsRequestData.SCHEMAS, DeleteTopicsResponseData.SCHEMAS, true),\n-    DELETE_RECORDS(21, \"DeleteRecords\", DeleteRecordsRequestData.SCHEMAS, DeleteRecordsResponseData.SCHEMAS),\n-    INIT_PRODUCER_ID(22, \"InitProducerId\", InitProducerIdRequestData.SCHEMAS, InitProducerIdResponseData.SCHEMAS),\n-    OFFSET_FOR_LEADER_EPOCH(23, \"OffsetForLeaderEpoch\", false, OffsetForLeaderEpochRequestData.SCHEMAS,\n-        OffsetForLeaderEpochResponseData.SCHEMAS),\n-    ADD_PARTITIONS_TO_TXN(24, \"AddPartitionsToTxn\", false, RecordBatch.MAGIC_VALUE_V2,\n-            AddPartitionsToTxnRequestData.SCHEMAS, AddPartitionsToTxnResponseData.SCHEMAS),\n-    ADD_OFFSETS_TO_TXN(25, \"AddOffsetsToTxn\", false, RecordBatch.MAGIC_VALUE_V2, AddOffsetsToTxnRequestData.SCHEMAS,\n-            AddOffsetsToTxnResponseData.SCHEMAS),\n-    END_TXN(26, \"EndTxn\", false, RecordBatch.MAGIC_VALUE_V2, EndTxnRequestData.SCHEMAS, EndTxnResponseData.SCHEMAS),\n-    WRITE_TXN_MARKERS(27, \"WriteTxnMarkers\", true, RecordBatch.MAGIC_VALUE_V2, WriteTxnMarkersRequestData.SCHEMAS,\n-            WriteTxnMarkersResponseData.SCHEMAS),\n-    TXN_OFFSET_COMMIT(28, \"TxnOffsetCommit\", false, RecordBatch.MAGIC_VALUE_V2, TxnOffsetCommitRequestData.SCHEMAS,\n-            TxnOffsetCommitResponseData.SCHEMAS),\n-    DESCRIBE_ACLS(29, \"DescribeAcls\", DescribeAclsRequestData.SCHEMAS, DescribeAclsResponseData.SCHEMAS),\n-    CREATE_ACLS(30, \"CreateAcls\", CreateAclsRequestData.SCHEMAS, CreateAclsResponseData.SCHEMAS, true),\n-    DELETE_ACLS(31, \"DeleteAcls\", DeleteAclsRequestData.SCHEMAS, DeleteAclsResponseData.SCHEMAS, true),\n-    DESCRIBE_CONFIGS(32, \"DescribeConfigs\", DescribeConfigsRequestData.SCHEMAS,\n-             DescribeConfigsResponseData.SCHEMAS),\n-    ALTER_CONFIGS(33, \"AlterConfigs\", AlterConfigsRequestData.SCHEMAS,\n-            AlterConfigsResponseData.SCHEMAS, true),\n-    ALTER_REPLICA_LOG_DIRS(34, \"AlterReplicaLogDirs\", AlterReplicaLogDirsRequestData.SCHEMAS,\n-            AlterReplicaLogDirsResponseData.SCHEMAS),\n-    DESCRIBE_LOG_DIRS(35, \"DescribeLogDirs\", DescribeLogDirsRequestData.SCHEMAS,\n-            DescribeLogDirsResponseData.SCHEMAS),\n-    SASL_AUTHENTICATE(36, \"SaslAuthenticate\", SaslAuthenticateRequestData.SCHEMAS,\n-            SaslAuthenticateResponseData.SCHEMAS),\n-    CREATE_PARTITIONS(37, \"CreatePartitions\", CreatePartitionsRequestData.SCHEMAS,\n-            CreatePartitionsResponseData.SCHEMAS, true),\n-    CREATE_DELEGATION_TOKEN(38, \"CreateDelegationToken\", CreateDelegationTokenRequestData.SCHEMAS,\n-            CreateDelegationTokenResponseData.SCHEMAS, true),\n-    RENEW_DELEGATION_TOKEN(39, \"RenewDelegationToken\", RenewDelegationTokenRequestData.SCHEMAS,\n-            RenewDelegationTokenResponseData.SCHEMAS, true),\n-    EXPIRE_DELEGATION_TOKEN(40, \"ExpireDelegationToken\", ExpireDelegationTokenRequestData.SCHEMAS,\n-            ExpireDelegationTokenResponseData.SCHEMAS, true),\n-    DESCRIBE_DELEGATION_TOKEN(41, \"DescribeDelegationToken\", DescribeDelegationTokenRequestData.SCHEMAS,\n-            DescribeDelegationTokenResponseData.SCHEMAS),\n-    DELETE_GROUPS(42, \"DeleteGroups\", DeleteGroupsRequestData.SCHEMAS, DeleteGroupsResponseData.SCHEMAS),\n-    ELECT_LEADERS(43, \"ElectLeaders\", ElectLeadersRequestData.SCHEMAS,\n-            ElectLeadersResponseData.SCHEMAS),\n-    INCREMENTAL_ALTER_CONFIGS(44, \"IncrementalAlterConfigs\", IncrementalAlterConfigsRequestData.SCHEMAS,\n-            IncrementalAlterConfigsResponseData.SCHEMAS, true),\n-    ALTER_PARTITION_REASSIGNMENTS(45, \"AlterPartitionReassignments\", AlterPartitionReassignmentsRequestData.SCHEMAS,\n-            AlterPartitionReassignmentsResponseData.SCHEMAS, true),\n-    LIST_PARTITION_REASSIGNMENTS(46, \"ListPartitionReassignments\", ListPartitionReassignmentsRequestData.SCHEMAS,\n-            ListPartitionReassignmentsResponseData.SCHEMAS),\n-    OFFSET_DELETE(47, \"OffsetDelete\", OffsetDeleteRequestData.SCHEMAS, OffsetDeleteResponseData.SCHEMAS),\n-    DESCRIBE_CLIENT_QUOTAS(48, \"DescribeClientQuotas\", DescribeClientQuotasRequestData.SCHEMAS,\n-            DescribeClientQuotasResponseData.SCHEMAS),\n-    ALTER_CLIENT_QUOTAS(49, \"AlterClientQuotas\", AlterClientQuotasRequestData.SCHEMAS,\n-            AlterClientQuotasResponseData.SCHEMAS, true),\n-    DESCRIBE_USER_SCRAM_CREDENTIALS(50, \"DescribeUserScramCredentials\", DescribeUserScramCredentialsRequestData.SCHEMAS,\n-            DescribeUserScramCredentialsResponseData.SCHEMAS),\n-    ALTER_USER_SCRAM_CREDENTIALS(51, \"AlterUserScramCredentials\", AlterUserScramCredentialsRequestData.SCHEMAS,\n-            AlterUserScramCredentialsResponseData.SCHEMAS, true),\n-    VOTE(52, \"Vote\", true, false,\n-        VoteRequestData.SCHEMAS, VoteResponseData.SCHEMAS),\n-    BEGIN_QUORUM_EPOCH(53, \"BeginQuorumEpoch\", true, false,\n-        BeginQuorumEpochRequestData.SCHEMAS, BeginQuorumEpochResponseData.SCHEMAS),\n-    END_QUORUM_EPOCH(54, \"EndQuorumEpoch\", true, false,\n-        EndQuorumEpochRequestData.SCHEMAS, EndQuorumEpochResponseData.SCHEMAS),\n-    DESCRIBE_QUORUM(55, \"DescribeQuorum\", true, false,\n-        DescribeQuorumRequestData.SCHEMAS, DescribeQuorumResponseData.SCHEMAS),\n-    ALTER_ISR(56, \"AlterIsr\", true, AlterIsrRequestData.SCHEMAS, AlterIsrResponseData.SCHEMAS),\n-    UPDATE_FEATURES(57, \"UpdateFeatures\",\n-        UpdateFeaturesRequestData.SCHEMAS, UpdateFeaturesResponseData.SCHEMAS, true),\n-    ENVELOPE(58, \"Envelope\", true, false, EnvelopeRequestData.SCHEMAS, EnvelopeResponseData.SCHEMAS);\n-\n-    private static final ApiKeys[] ID_TO_TYPE;\n-    private static final int MIN_API_KEY = 0;\n-    public static final int MAX_API_KEY;\n-\n+    PRODUCE(ApiMessageType.PRODUCE),\n+    FETCH(ApiMessageType.FETCH),\n+    LIST_OFFSETS(ApiMessageType.LIST_OFFSETS),\n+    METADATA(ApiMessageType.METADATA),\n+    LEADER_AND_ISR(ApiMessageType.LEADER_AND_ISR, true),\n+    STOP_REPLICA(ApiMessageType.STOP_REPLICA, true),\n+    UPDATE_METADATA(ApiMessageType.UPDATE_METADATA, true),\n+    CONTROLLED_SHUTDOWN(ApiMessageType.CONTROLLED_SHUTDOWN, true),\n+    OFFSET_COMMIT(ApiMessageType.OFFSET_COMMIT),\n+    OFFSET_FETCH(ApiMessageType.OFFSET_FETCH),\n+    FIND_COORDINATOR(ApiMessageType.FIND_COORDINATOR),\n+    JOIN_GROUP(ApiMessageType.JOIN_GROUP),\n+    HEARTBEAT(ApiMessageType.HEARTBEAT),\n+    LEAVE_GROUP(ApiMessageType.LEAVE_GROUP),\n+    SYNC_GROUP(ApiMessageType.SYNC_GROUP),\n+    DESCRIBE_GROUPS(ApiMessageType.DESCRIBE_GROUPS),\n+    LIST_GROUPS(ApiMessageType.LIST_GROUPS),\n+    SASL_HANDSHAKE(ApiMessageType.SASL_HANDSHAKE),\n+    API_VERSIONS(ApiMessageType.API_VERSIONS),\n+    CREATE_TOPICS(ApiMessageType.CREATE_TOPICS, false, true),\n+    DELETE_TOPICS(ApiMessageType.DELETE_TOPICS, false, true),\n+    DELETE_RECORDS(ApiMessageType.DELETE_RECORDS),\n+    INIT_PRODUCER_ID(ApiMessageType.INIT_PRODUCER_ID),\n+    OFFSET_FOR_LEADER_EPOCH(ApiMessageType.OFFSET_FOR_LEADER_EPOCH),\n+    ADD_PARTITIONS_TO_TXN(ApiMessageType.ADD_PARTITIONS_TO_TXN, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    ADD_OFFSETS_TO_TXN(ApiMessageType.ADD_OFFSETS_TO_TXN, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    END_TXN(ApiMessageType.END_TXN, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    WRITE_TXN_MARKERS(ApiMessageType.WRITE_TXN_MARKERS, true, RecordBatch.MAGIC_VALUE_V2, false),\n+    TXN_OFFSET_COMMIT(ApiMessageType.TXN_OFFSET_COMMIT, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    DESCRIBE_ACLS(ApiMessageType.DESCRIBE_ACLS),\n+    CREATE_ACLS(ApiMessageType.CREATE_ACLS, false, true),\n+    DELETE_ACLS(ApiMessageType.DELETE_ACLS, false, true),\n+    DESCRIBE_CONFIGS(ApiMessageType.DESCRIBE_CONFIGS),\n+    ALTER_CONFIGS(ApiMessageType.ALTER_CONFIGS, false, true),\n+    ALTER_REPLICA_LOG_DIRS(ApiMessageType.ALTER_REPLICA_LOG_DIRS),\n+    DESCRIBE_LOG_DIRS(ApiMessageType.DESCRIBE_LOG_DIRS),\n+    SASL_AUTHENTICATE(ApiMessageType.SASL_AUTHENTICATE),\n+    CREATE_PARTITIONS(ApiMessageType.CREATE_PARTITIONS, false, true),\n+    CREATE_DELEGATION_TOKEN(ApiMessageType.CREATE_DELEGATION_TOKEN, false, true),\n+    RENEW_DELEGATION_TOKEN(ApiMessageType.RENEW_DELEGATION_TOKEN, false, true),\n+    EXPIRE_DELEGATION_TOKEN(ApiMessageType.EXPIRE_DELEGATION_TOKEN, false, true),\n+    DESCRIBE_DELEGATION_TOKEN(ApiMessageType.DESCRIBE_DELEGATION_TOKEN),\n+    DELETE_GROUPS(ApiMessageType.DELETE_GROUPS),\n+    ELECT_LEADERS(ApiMessageType.ELECT_LEADERS),\n+    INCREMENTAL_ALTER_CONFIGS(ApiMessageType.INCREMENTAL_ALTER_CONFIGS, false, true),\n+    ALTER_PARTITION_REASSIGNMENTS(ApiMessageType.ALTER_PARTITION_REASSIGNMENTS, false, true),\n+    LIST_PARTITION_REASSIGNMENTS(ApiMessageType.LIST_PARTITION_REASSIGNMENTS),\n+    OFFSET_DELETE(ApiMessageType.OFFSET_DELETE),\n+    DESCRIBE_CLIENT_QUOTAS(ApiMessageType.DESCRIBE_CLIENT_QUOTAS),\n+    ALTER_CLIENT_QUOTAS(ApiMessageType.ALTER_CLIENT_QUOTAS, false, true),\n+    DESCRIBE_USER_SCRAM_CREDENTIALS(ApiMessageType.DESCRIBE_USER_SCRAM_CREDENTIALS),\n+    ALTER_USER_SCRAM_CREDENTIALS(ApiMessageType.ALTER_USER_SCRAM_CREDENTIALS, false, true),\n+    VOTE(ApiMessageType.VOTE, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    BEGIN_QUORUM_EPOCH(ApiMessageType.BEGIN_QUORUM_EPOCH, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    END_QUORUM_EPOCH(ApiMessageType.END_QUORUM_EPOCH, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    DESCRIBE_QUORUM(ApiMessageType.DESCRIBE_QUORUM, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    ALTER_ISR(ApiMessageType.ALTER_ISR, true),\n+    UPDATE_FEATURES(ApiMessageType.UPDATE_FEATURES, false, true),\n+    ENVELOPE(ApiMessageType.ENVELOPE, true, RecordBatch.MAGIC_VALUE_V0, false, false);\n+\n+    private static final Map<Integer, ApiKeys> ID_TO_TYPE = new HashMap<>();\n     static {\n-        int maxKey = -1;\n-        for (ApiKeys key : ApiKeys.values())\n-            maxKey = Math.max(maxKey, key.id);\n-        ApiKeys[] idToType = new ApiKeys[maxKey + 1];\n         for (ApiKeys key : ApiKeys.values())\n-            idToType[key.id] = key;\n-        ID_TO_TYPE = idToType;\n-        MAX_API_KEY = maxKey;\n+            ID_TO_TYPE.put((int) key.id, key);", "originalCommit": "e8dc54737c14d60069348f23e71499bdb01f11b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxNTQ2Nw==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r543815467", "bodyText": "I think the generator checks for this. I will double check.", "author": "ijuma", "createdAt": "2020-12-16T01:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5OTYwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk2MTAwOQ==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r543961009", "bodyText": "Yes, the generator checks it:\n\nCaused by: java.lang.RuntimeException: Found more than one response with API key 3\n\nThere's also ApiMessageTypeTest.testUniqueness that verifies it after the generation.\nI added a comment explaining that uniqueness is ensured.", "author": "ijuma", "createdAt": "2020-12-16T05:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5OTYwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwNDQ3NA==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r543804474", "body": "Is 'short' type more suitable?", "bodyText": "Is 'short' type more suitable?", "bodyHTML": "<p dir=\"auto\">Is 'short' type more suitable?</p>", "author": "chia7712", "createdAt": "2020-12-16T01:15:07Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/ApiKeys.java", "diffHunk": "@@ -361,69 +172,35 @@ private static boolean shouldRetainsBufferReference(Schema[] requestSchemas) {\n     }\n \n     public static ApiKeys forId(int id) {", "originalCommit": "e8dc54737c14d60069348f23e71499bdb01f11b5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwNDg1NA==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r543804854", "bodyText": "If the above comment is valid, it can be addressed in separate PR :)", "author": "chia7712", "createdAt": "2020-12-16T01:16:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwNDQ3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgxNjA5Nw==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r543816097", "bodyText": "We used int here because short in Java is a second class citizen and casting is required in some cases. If we decide to change this, a separate PR (as you suggested) would be better.", "author": "ijuma", "createdAt": "2020-12-16T01:46:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgwNDQ3NA=="}], "type": "inlineReview"}, {"oid": "73099b47f0021b3ba7961cc491204b73d9aa5d86", "url": "https://github.com/apache/kafka/commit/73099b47f0021b3ba7961cc491204b73d9aa5d86", "message": "Clarifying comment in ApiKeys", "committedDate": "2020-12-16T05:07:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk4NTg4Ng==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r543985886", "body": "It seems to me this initialization can be rewrite by following code.\r\n```\r\n    private static final Map<Integer, ApiKeys> ID_TO_TYPE = Arrays.stream(ApiKeys.values())\r\n            .collect(Collectors.toMap(key -> (int) key.id, Function.identity()));\r\n```\r\n\r\nThe benefit is that he static block can be removed.", "bodyText": "It seems to me this initialization can be rewrite by following code.\n    private static final Map<Integer, ApiKeys> ID_TO_TYPE = Arrays.stream(ApiKeys.values())\n            .collect(Collectors.toMap(key -> (int) key.id, Function.identity()));\n\nThe benefit is that he static block can be removed.", "bodyHTML": "<p dir=\"auto\">It seems to me this initialization can be rewrite by following code.</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    private static final Map&lt;Integer, ApiKeys&gt; ID_TO_TYPE = Arrays.stream(ApiKeys.values())\n            .collect(Collectors.toMap(key -&gt; (int) key.id, Function.identity()));\n\"><pre><code>    private static final Map&lt;Integer, ApiKeys&gt; ID_TO_TYPE = Arrays.stream(ApiKeys.values())\n            .collect(Collectors.toMap(key -&gt; (int) key.id, Function.identity()));\n</code></pre></div>\n<p dir=\"auto\">The benefit is that he static block can be removed.</p>", "author": "chia7712", "createdAt": "2020-12-16T05:40:08Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/ApiKeys.java", "diffHunk": "@@ -157,124 +38,78 @@\n  * Identifiers for all the Kafka APIs\n  */\n public enum ApiKeys {\n-    PRODUCE(0, \"Produce\", ProduceRequestData.SCHEMAS, ProduceResponseData.SCHEMAS),\n-    FETCH(1, \"Fetch\", FetchRequestData.SCHEMAS, FetchResponseData.SCHEMAS),\n-    LIST_OFFSETS(2, \"ListOffsets\", ListOffsetRequestData.SCHEMAS, ListOffsetResponseData.SCHEMAS),\n-    METADATA(3, \"Metadata\", MetadataRequestData.SCHEMAS, MetadataResponseData.SCHEMAS),\n-    LEADER_AND_ISR(4, \"LeaderAndIsr\", true, LeaderAndIsrRequestData.SCHEMAS, LeaderAndIsrResponseData.SCHEMAS),\n-    STOP_REPLICA(5, \"StopReplica\", true, StopReplicaRequestData.SCHEMAS, StopReplicaResponseData.SCHEMAS),\n-    UPDATE_METADATA(6, \"UpdateMetadata\", true, UpdateMetadataRequestData.SCHEMAS, UpdateMetadataResponseData.SCHEMAS),\n-    CONTROLLED_SHUTDOWN(7, \"ControlledShutdown\", true, ControlledShutdownRequestData.SCHEMAS,\n-            ControlledShutdownResponseData.SCHEMAS),\n-    OFFSET_COMMIT(8, \"OffsetCommit\", OffsetCommitRequestData.SCHEMAS, OffsetCommitResponseData.SCHEMAS),\n-    OFFSET_FETCH(9, \"OffsetFetch\", OffsetFetchRequestData.SCHEMAS, OffsetFetchResponseData.SCHEMAS),\n-    FIND_COORDINATOR(10, \"FindCoordinator\", FindCoordinatorRequestData.SCHEMAS,\n-            FindCoordinatorResponseData.SCHEMAS),\n-    JOIN_GROUP(11, \"JoinGroup\", JoinGroupRequestData.SCHEMAS, JoinGroupResponseData.SCHEMAS),\n-    HEARTBEAT(12, \"Heartbeat\", HeartbeatRequestData.SCHEMAS, HeartbeatResponseData.SCHEMAS),\n-    LEAVE_GROUP(13, \"LeaveGroup\", LeaveGroupRequestData.SCHEMAS, LeaveGroupResponseData.SCHEMAS),\n-    SYNC_GROUP(14, \"SyncGroup\", SyncGroupRequestData.SCHEMAS, SyncGroupResponseData.SCHEMAS),\n-    DESCRIBE_GROUPS(15, \"DescribeGroups\", DescribeGroupsRequestData.SCHEMAS,\n-            DescribeGroupsResponseData.SCHEMAS),\n-    LIST_GROUPS(16, \"ListGroups\", ListGroupsRequestData.SCHEMAS, ListGroupsResponseData.SCHEMAS),\n-    SASL_HANDSHAKE(17, \"SaslHandshake\", SaslHandshakeRequestData.SCHEMAS, SaslHandshakeResponseData.SCHEMAS),\n-    API_VERSIONS(18, \"ApiVersions\", ApiVersionsRequestData.SCHEMAS, ApiVersionsResponseData.SCHEMAS) {\n-        @Override\n-        public Struct parseResponse(short version, ByteBuffer buffer) {\n-            // Fallback to version 0 for ApiVersions response. If a client sends an ApiVersionsRequest\n-            // using a version higher than that supported by the broker, a version 0 response is sent\n-            // to the client indicating UNSUPPORTED_VERSION.\n-            return parseResponse(version, buffer, (short) 0);\n-        }\n-    },\n-    CREATE_TOPICS(19, \"CreateTopics\", CreateTopicsRequestData.SCHEMAS, CreateTopicsResponseData.SCHEMAS, true),\n-    DELETE_TOPICS(20, \"DeleteTopics\", DeleteTopicsRequestData.SCHEMAS, DeleteTopicsResponseData.SCHEMAS, true),\n-    DELETE_RECORDS(21, \"DeleteRecords\", DeleteRecordsRequestData.SCHEMAS, DeleteRecordsResponseData.SCHEMAS),\n-    INIT_PRODUCER_ID(22, \"InitProducerId\", InitProducerIdRequestData.SCHEMAS, InitProducerIdResponseData.SCHEMAS),\n-    OFFSET_FOR_LEADER_EPOCH(23, \"OffsetForLeaderEpoch\", false, OffsetForLeaderEpochRequestData.SCHEMAS,\n-        OffsetForLeaderEpochResponseData.SCHEMAS),\n-    ADD_PARTITIONS_TO_TXN(24, \"AddPartitionsToTxn\", false, RecordBatch.MAGIC_VALUE_V2,\n-            AddPartitionsToTxnRequestData.SCHEMAS, AddPartitionsToTxnResponseData.SCHEMAS),\n-    ADD_OFFSETS_TO_TXN(25, \"AddOffsetsToTxn\", false, RecordBatch.MAGIC_VALUE_V2, AddOffsetsToTxnRequestData.SCHEMAS,\n-            AddOffsetsToTxnResponseData.SCHEMAS),\n-    END_TXN(26, \"EndTxn\", false, RecordBatch.MAGIC_VALUE_V2, EndTxnRequestData.SCHEMAS, EndTxnResponseData.SCHEMAS),\n-    WRITE_TXN_MARKERS(27, \"WriteTxnMarkers\", true, RecordBatch.MAGIC_VALUE_V2, WriteTxnMarkersRequestData.SCHEMAS,\n-            WriteTxnMarkersResponseData.SCHEMAS),\n-    TXN_OFFSET_COMMIT(28, \"TxnOffsetCommit\", false, RecordBatch.MAGIC_VALUE_V2, TxnOffsetCommitRequestData.SCHEMAS,\n-            TxnOffsetCommitResponseData.SCHEMAS),\n-    DESCRIBE_ACLS(29, \"DescribeAcls\", DescribeAclsRequestData.SCHEMAS, DescribeAclsResponseData.SCHEMAS),\n-    CREATE_ACLS(30, \"CreateAcls\", CreateAclsRequestData.SCHEMAS, CreateAclsResponseData.SCHEMAS, true),\n-    DELETE_ACLS(31, \"DeleteAcls\", DeleteAclsRequestData.SCHEMAS, DeleteAclsResponseData.SCHEMAS, true),\n-    DESCRIBE_CONFIGS(32, \"DescribeConfigs\", DescribeConfigsRequestData.SCHEMAS,\n-             DescribeConfigsResponseData.SCHEMAS),\n-    ALTER_CONFIGS(33, \"AlterConfigs\", AlterConfigsRequestData.SCHEMAS,\n-            AlterConfigsResponseData.SCHEMAS, true),\n-    ALTER_REPLICA_LOG_DIRS(34, \"AlterReplicaLogDirs\", AlterReplicaLogDirsRequestData.SCHEMAS,\n-            AlterReplicaLogDirsResponseData.SCHEMAS),\n-    DESCRIBE_LOG_DIRS(35, \"DescribeLogDirs\", DescribeLogDirsRequestData.SCHEMAS,\n-            DescribeLogDirsResponseData.SCHEMAS),\n-    SASL_AUTHENTICATE(36, \"SaslAuthenticate\", SaslAuthenticateRequestData.SCHEMAS,\n-            SaslAuthenticateResponseData.SCHEMAS),\n-    CREATE_PARTITIONS(37, \"CreatePartitions\", CreatePartitionsRequestData.SCHEMAS,\n-            CreatePartitionsResponseData.SCHEMAS, true),\n-    CREATE_DELEGATION_TOKEN(38, \"CreateDelegationToken\", CreateDelegationTokenRequestData.SCHEMAS,\n-            CreateDelegationTokenResponseData.SCHEMAS, true),\n-    RENEW_DELEGATION_TOKEN(39, \"RenewDelegationToken\", RenewDelegationTokenRequestData.SCHEMAS,\n-            RenewDelegationTokenResponseData.SCHEMAS, true),\n-    EXPIRE_DELEGATION_TOKEN(40, \"ExpireDelegationToken\", ExpireDelegationTokenRequestData.SCHEMAS,\n-            ExpireDelegationTokenResponseData.SCHEMAS, true),\n-    DESCRIBE_DELEGATION_TOKEN(41, \"DescribeDelegationToken\", DescribeDelegationTokenRequestData.SCHEMAS,\n-            DescribeDelegationTokenResponseData.SCHEMAS),\n-    DELETE_GROUPS(42, \"DeleteGroups\", DeleteGroupsRequestData.SCHEMAS, DeleteGroupsResponseData.SCHEMAS),\n-    ELECT_LEADERS(43, \"ElectLeaders\", ElectLeadersRequestData.SCHEMAS,\n-            ElectLeadersResponseData.SCHEMAS),\n-    INCREMENTAL_ALTER_CONFIGS(44, \"IncrementalAlterConfigs\", IncrementalAlterConfigsRequestData.SCHEMAS,\n-            IncrementalAlterConfigsResponseData.SCHEMAS, true),\n-    ALTER_PARTITION_REASSIGNMENTS(45, \"AlterPartitionReassignments\", AlterPartitionReassignmentsRequestData.SCHEMAS,\n-            AlterPartitionReassignmentsResponseData.SCHEMAS, true),\n-    LIST_PARTITION_REASSIGNMENTS(46, \"ListPartitionReassignments\", ListPartitionReassignmentsRequestData.SCHEMAS,\n-            ListPartitionReassignmentsResponseData.SCHEMAS),\n-    OFFSET_DELETE(47, \"OffsetDelete\", OffsetDeleteRequestData.SCHEMAS, OffsetDeleteResponseData.SCHEMAS),\n-    DESCRIBE_CLIENT_QUOTAS(48, \"DescribeClientQuotas\", DescribeClientQuotasRequestData.SCHEMAS,\n-            DescribeClientQuotasResponseData.SCHEMAS),\n-    ALTER_CLIENT_QUOTAS(49, \"AlterClientQuotas\", AlterClientQuotasRequestData.SCHEMAS,\n-            AlterClientQuotasResponseData.SCHEMAS, true),\n-    DESCRIBE_USER_SCRAM_CREDENTIALS(50, \"DescribeUserScramCredentials\", DescribeUserScramCredentialsRequestData.SCHEMAS,\n-            DescribeUserScramCredentialsResponseData.SCHEMAS),\n-    ALTER_USER_SCRAM_CREDENTIALS(51, \"AlterUserScramCredentials\", AlterUserScramCredentialsRequestData.SCHEMAS,\n-            AlterUserScramCredentialsResponseData.SCHEMAS, true),\n-    VOTE(52, \"Vote\", true, false,\n-        VoteRequestData.SCHEMAS, VoteResponseData.SCHEMAS),\n-    BEGIN_QUORUM_EPOCH(53, \"BeginQuorumEpoch\", true, false,\n-        BeginQuorumEpochRequestData.SCHEMAS, BeginQuorumEpochResponseData.SCHEMAS),\n-    END_QUORUM_EPOCH(54, \"EndQuorumEpoch\", true, false,\n-        EndQuorumEpochRequestData.SCHEMAS, EndQuorumEpochResponseData.SCHEMAS),\n-    DESCRIBE_QUORUM(55, \"DescribeQuorum\", true, false,\n-        DescribeQuorumRequestData.SCHEMAS, DescribeQuorumResponseData.SCHEMAS),\n-    ALTER_ISR(56, \"AlterIsr\", true, AlterIsrRequestData.SCHEMAS, AlterIsrResponseData.SCHEMAS),\n-    UPDATE_FEATURES(57, \"UpdateFeatures\",\n-        UpdateFeaturesRequestData.SCHEMAS, UpdateFeaturesResponseData.SCHEMAS, true),\n-    ENVELOPE(58, \"Envelope\", true, false, EnvelopeRequestData.SCHEMAS, EnvelopeResponseData.SCHEMAS);\n-\n-    private static final ApiKeys[] ID_TO_TYPE;\n-    private static final int MIN_API_KEY = 0;\n-    public static final int MAX_API_KEY;\n-\n+    PRODUCE(ApiMessageType.PRODUCE),\n+    FETCH(ApiMessageType.FETCH),\n+    LIST_OFFSETS(ApiMessageType.LIST_OFFSETS),\n+    METADATA(ApiMessageType.METADATA),\n+    LEADER_AND_ISR(ApiMessageType.LEADER_AND_ISR, true),\n+    STOP_REPLICA(ApiMessageType.STOP_REPLICA, true),\n+    UPDATE_METADATA(ApiMessageType.UPDATE_METADATA, true),\n+    CONTROLLED_SHUTDOWN(ApiMessageType.CONTROLLED_SHUTDOWN, true),\n+    OFFSET_COMMIT(ApiMessageType.OFFSET_COMMIT),\n+    OFFSET_FETCH(ApiMessageType.OFFSET_FETCH),\n+    FIND_COORDINATOR(ApiMessageType.FIND_COORDINATOR),\n+    JOIN_GROUP(ApiMessageType.JOIN_GROUP),\n+    HEARTBEAT(ApiMessageType.HEARTBEAT),\n+    LEAVE_GROUP(ApiMessageType.LEAVE_GROUP),\n+    SYNC_GROUP(ApiMessageType.SYNC_GROUP),\n+    DESCRIBE_GROUPS(ApiMessageType.DESCRIBE_GROUPS),\n+    LIST_GROUPS(ApiMessageType.LIST_GROUPS),\n+    SASL_HANDSHAKE(ApiMessageType.SASL_HANDSHAKE),\n+    API_VERSIONS(ApiMessageType.API_VERSIONS),\n+    CREATE_TOPICS(ApiMessageType.CREATE_TOPICS, false, true),\n+    DELETE_TOPICS(ApiMessageType.DELETE_TOPICS, false, true),\n+    DELETE_RECORDS(ApiMessageType.DELETE_RECORDS),\n+    INIT_PRODUCER_ID(ApiMessageType.INIT_PRODUCER_ID),\n+    OFFSET_FOR_LEADER_EPOCH(ApiMessageType.OFFSET_FOR_LEADER_EPOCH),\n+    ADD_PARTITIONS_TO_TXN(ApiMessageType.ADD_PARTITIONS_TO_TXN, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    ADD_OFFSETS_TO_TXN(ApiMessageType.ADD_OFFSETS_TO_TXN, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    END_TXN(ApiMessageType.END_TXN, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    WRITE_TXN_MARKERS(ApiMessageType.WRITE_TXN_MARKERS, true, RecordBatch.MAGIC_VALUE_V2, false),\n+    TXN_OFFSET_COMMIT(ApiMessageType.TXN_OFFSET_COMMIT, false, RecordBatch.MAGIC_VALUE_V2, false),\n+    DESCRIBE_ACLS(ApiMessageType.DESCRIBE_ACLS),\n+    CREATE_ACLS(ApiMessageType.CREATE_ACLS, false, true),\n+    DELETE_ACLS(ApiMessageType.DELETE_ACLS, false, true),\n+    DESCRIBE_CONFIGS(ApiMessageType.DESCRIBE_CONFIGS),\n+    ALTER_CONFIGS(ApiMessageType.ALTER_CONFIGS, false, true),\n+    ALTER_REPLICA_LOG_DIRS(ApiMessageType.ALTER_REPLICA_LOG_DIRS),\n+    DESCRIBE_LOG_DIRS(ApiMessageType.DESCRIBE_LOG_DIRS),\n+    SASL_AUTHENTICATE(ApiMessageType.SASL_AUTHENTICATE),\n+    CREATE_PARTITIONS(ApiMessageType.CREATE_PARTITIONS, false, true),\n+    CREATE_DELEGATION_TOKEN(ApiMessageType.CREATE_DELEGATION_TOKEN, false, true),\n+    RENEW_DELEGATION_TOKEN(ApiMessageType.RENEW_DELEGATION_TOKEN, false, true),\n+    EXPIRE_DELEGATION_TOKEN(ApiMessageType.EXPIRE_DELEGATION_TOKEN, false, true),\n+    DESCRIBE_DELEGATION_TOKEN(ApiMessageType.DESCRIBE_DELEGATION_TOKEN),\n+    DELETE_GROUPS(ApiMessageType.DELETE_GROUPS),\n+    ELECT_LEADERS(ApiMessageType.ELECT_LEADERS),\n+    INCREMENTAL_ALTER_CONFIGS(ApiMessageType.INCREMENTAL_ALTER_CONFIGS, false, true),\n+    ALTER_PARTITION_REASSIGNMENTS(ApiMessageType.ALTER_PARTITION_REASSIGNMENTS, false, true),\n+    LIST_PARTITION_REASSIGNMENTS(ApiMessageType.LIST_PARTITION_REASSIGNMENTS),\n+    OFFSET_DELETE(ApiMessageType.OFFSET_DELETE),\n+    DESCRIBE_CLIENT_QUOTAS(ApiMessageType.DESCRIBE_CLIENT_QUOTAS),\n+    ALTER_CLIENT_QUOTAS(ApiMessageType.ALTER_CLIENT_QUOTAS, false, true),\n+    DESCRIBE_USER_SCRAM_CREDENTIALS(ApiMessageType.DESCRIBE_USER_SCRAM_CREDENTIALS),\n+    ALTER_USER_SCRAM_CREDENTIALS(ApiMessageType.ALTER_USER_SCRAM_CREDENTIALS, false, true),\n+    VOTE(ApiMessageType.VOTE, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    BEGIN_QUORUM_EPOCH(ApiMessageType.BEGIN_QUORUM_EPOCH, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    END_QUORUM_EPOCH(ApiMessageType.END_QUORUM_EPOCH, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    DESCRIBE_QUORUM(ApiMessageType.DESCRIBE_QUORUM, true, RecordBatch.MAGIC_VALUE_V0, false, false),\n+    ALTER_ISR(ApiMessageType.ALTER_ISR, true),\n+    UPDATE_FEATURES(ApiMessageType.UPDATE_FEATURES, false, true),\n+    ENVELOPE(ApiMessageType.ENVELOPE, true, RecordBatch.MAGIC_VALUE_V0, false, false);\n+\n+    private static final Map<Integer, ApiKeys> ID_TO_TYPE = new HashMap<>();", "originalCommit": "73099b47f0021b3ba7961cc491204b73d9aa5d86", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDAxMjA1MQ==", "url": "https://github.com/apache/kafka/pull/9748#discussion_r544012051", "bodyText": "Updated.", "author": "ijuma", "createdAt": "2020-12-16T06:14:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzk4NTg4Ng=="}], "type": "inlineReview"}, {"oid": "d6e0f72bfb6d16817228132c9825e4f24afa1bd3", "url": "https://github.com/apache/kafka/commit/d6e0f72bfb6d16817228132c9825e4f24afa1bd3", "message": "Simplify ID_TO_TYPE generation via stream API", "committedDate": "2020-12-16T06:14:35Z", "type": "commit"}]}