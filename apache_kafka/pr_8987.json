{"pr_number": 8987, "pr_title": "KAFKA-10221: Backport fix for KAFKA-9603 to 2.5", "pr_author": "cadonna", "pr_createdAt": "2020-07-06T19:49:21Z", "pr_url": "https://github.com/apache/kafka/pull/8987", "timeline": [{"oid": "652250344fcb6d59bd291d4588e41a84d6087470", "url": "https://github.com/apache/kafka/commit/652250344fcb6d59bd291d4588e41a84d6087470", "message": "KAFKA-10221: Backport fix for KAFKA-9603 to 2.5\n\nKAFKA-9603 reports that the number of open files keeps increasing\nin RocksDB. The reason is that bulk loading is turned on but\nnever turned off in segmented state stores for standby tasks.\n\nThis bug was fixed in 2.6 by using code that is not present in 2.5.\n\nThis PR backports the fix to 2.5.", "committedDate": "2020-07-06T19:37:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk2MTkxOQ==", "url": "https://github.com/apache/kafka/pull/8987#discussion_r450961919", "body": "Woah, this is subtle. IIUC, the fix works by asserting that we should only enable bulk loading if the provided context is a ProcessorContextImpl, which is the kind of context that is only provided when adding the store to an active task.\r\n\r\nThis seems correct to me, and although it's very subtle, it also seems ok as a patch for an older codebase that won't need to be maintained much. But maybe we can have a comment, or an internal method for the check, like \r\n\r\n```suggestion\r\n                if (!bulkLoadSegments.contains(segment) && isStoreForActiveTask(context)) {\r\n```\r\n\r\nso that it'll be more obvious what's going on here?", "bodyText": "Woah, this is subtle. IIUC, the fix works by asserting that we should only enable bulk loading if the provided context is a ProcessorContextImpl, which is the kind of context that is only provided when adding the store to an active task.\nThis seems correct to me, and although it's very subtle, it also seems ok as a patch for an older codebase that won't need to be maintained much. But maybe we can have a comment, or an internal method for the check, like\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (!bulkLoadSegments.contains(segment) && context instanceof ProcessorContextImpl) {\n          \n          \n            \n                            if (!bulkLoadSegments.contains(segment) && isStoreForActiveTask(context)) {\n          \n      \n    \n    \n  \n\nso that it'll be more obvious what's going on here?", "bodyHTML": "<p dir=\"auto\">Woah, this is subtle. IIUC, the fix works by asserting that we should only enable bulk loading if the provided context is a ProcessorContextImpl, which is the kind of context that is only provided when adding the store to an active task.</p>\n<p dir=\"auto\">This seems correct to me, and although it's very subtle, it also seems ok as a patch for an older codebase that won't need to be maintained much. But maybe we can have a comment, or an internal method for the check, like</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>bulkLoadSegments<span class=\"pl-k\">.</span>contains(segment) <span class=\"pl-k\">&amp;&amp;</span> context<span class=\"x x-first\"> </span><span class=\"pl-k x\">instanceof</span><span class=\"x\"> </span><span class=\"pl-smi x x-last\">ProcessorContextImpl</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>bulkLoadSegments<span class=\"pl-k\">.</span>contains(segment) <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first x-last\">isStoreForActiveTask(</span>context<span class=\"x x-first x-last\">)</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">so that it'll be more obvious what's going on here?</p>", "author": "vvcephei", "createdAt": "2020-07-07T15:41:50Z", "path": "streams/src/main/java/org/apache/kafka/streams/state/internals/AbstractRocksDBSegmentedBytesStore.java", "diffHunk": "@@ -251,7 +252,7 @@ void restoreAllInternal(final Collection<KeyValue<byte[], byte[]>> records) {\n                 // This handles the case that state store is moved to a new client and does not\n                 // have the local RocksDB instance for the segment. In this case, toggleDBForBulkLoading\n                 // will only close the database and open it again with bulk loading enabled.\n-                if (!bulkLoadSegments.contains(segment)) {\n+                if (!bulkLoadSegments.contains(segment) && context instanceof ProcessorContextImpl) {", "originalCommit": "652250344fcb6d59bd291d4588e41a84d6087470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk4OTAxNg==", "url": "https://github.com/apache/kafka/pull/8987#discussion_r450989016", "bodyText": "Good point! Will do!", "author": "cadonna", "createdAt": "2020-07-07T16:22:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk2MTkxOQ=="}], "type": "inlineReview"}, {"oid": "f4ae8ea190c2cddb65066bbbe3054f40fe7bcee7", "url": "https://github.com/apache/kafka/commit/f4ae8ea190c2cddb65066bbbe3054f40fe7bcee7", "message": "Make code more readable", "committedDate": "2020-07-07T19:55:12Z", "type": "commit"}]}