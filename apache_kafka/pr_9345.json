{"pr_number": 9345, "pr_title": "KAFKA-10338; Support PEM format for SSL key and trust stores (KIP-651)", "pr_author": "rajinisivaram", "pr_createdAt": "2020-09-28T19:01:02Z", "pr_url": "https://github.com/apache/kafka/pull/9345", "timeline": [{"oid": "ba3773c3fead43d4d30cc246f9e9fd9eb1736fa2", "url": "https://github.com/apache/kafka/commit/ba3773c3fead43d4d30cc246f9e9fd9eb1736fa2", "message": "KAFKA-10338; Support PEM format for SSL key and trust stores (KIP-651)", "committedDate": "2020-10-06T14:35:08Z", "type": "commit"}, {"oid": "b203a8373333ba3c64ce14ea397f39c0147f646e", "url": "https://github.com/apache/kafka/commit/b203a8373333ba3c64ce14ea397f39c0147f646e", "message": "Add new SSL configs to KafkaConfig", "committedDate": "2020-10-06T14:35:08Z", "type": "commit"}, {"oid": "19b83fa8e94c335677c02ef9e11c3cb582fab9d2", "url": "https://github.com/apache/kafka/commit/19b83fa8e94c335677c02ef9e11c3cb582fab9d2", "message": "Address review comments", "committedDate": "2020-10-06T14:54:14Z", "type": "commit"}, {"oid": "19b83fa8e94c335677c02ef9e11c3cb582fab9d2", "url": "https://github.com/apache/kafka/commit/19b83fa8e94c335677c02ef9e11c3cb582fab9d2", "message": "Address review comments", "committedDate": "2020-10-06T14:54:14Z", "type": "forcePushed"}, {"id": "PRRC_kwDOACG9q84tMthU", "url": "https://github.com/apache/kafka/pull/9345#discussion_r758306900", "body": "Is there an intention here to not allow a `FileBasedPemStore` containing an unencrypted private key when a key could be provided to `PemStore` with a `null`  `keyPassword`?", "bodyText": "Is there an intention here to not allow a FileBasedPemStore containing an unencrypted private key when a key could be provided to PemStore with a null  keyPassword?", "bodyHTML": "<p dir=\"auto\">Is there an intention here to not allow a <code>FileBasedPemStore</code> containing an unencrypted private key when a key could be provided to <code>PemStore</code> with a <code>null</code>  <code>keyPassword</code>?</p>", "author": "amccague", "createdAt": "2021-11-29T12:16:29Z", "path": "clients/src/main/java/org/apache/kafka/common/security/ssl/DefaultSslEngineFactory.java", "diffHunk": "@@ -246,56 +269,104 @@ private SSLContext createSSLContext() {\n         }\n     }\n \n-    private static SecurityStore createKeystore(String type, String path, Password password, Password keyPassword) {\n-        if (path == null && password != null) {\n-            throw new KafkaException(\"SSL key store is not specified, but key store password is specified.\");\n+    // Visibility to override for testing\n+    protected SecurityStore createKeystore(String type, String path, Password password, Password keyPassword, Password privateKey, Password certificateChain) {\n+        if (privateKey != null) {\n+            if (!PEM_TYPE.equals(type))\n+                throw new InvalidConfigurationException(\"SSL private key can be specified only for PEM, but key store type is \" + type + \".\");\n+            else if (certificateChain == null)\n+                throw new InvalidConfigurationException(\"SSL private key is specified, but certificate chain is not specified.\");\n+            else if (path != null)\n+                throw new InvalidConfigurationException(\"Both SSL key store location and separate private key are specified.\");\n+            else if (password != null)\n+                throw new InvalidConfigurationException(\"SSL key store password cannot be specified with PEM format, only key password may be specified.\");\n+            else\n+                return new PemStore(certificateChain, privateKey, keyPassword);\n+        } else if (certificateChain != null) {\n+            throw new InvalidConfigurationException(\"SSL certificate chain is specified, but private key is not specified\");\n+        } else if (PEM_TYPE.equals(type) && path != null) {\n+            if (password != null)\n+                throw new InvalidConfigurationException(\"SSL key store password cannot be specified with PEM format, only key password may be specified\");\n+            else if (keyPassword == null)\n+                throw new InvalidConfigurationException(\"SSL PEM key store is specified, but key password is not specified.\");", "originalCommit": "19b83fa8e94c335677c02ef9e11c3cb582fab9d2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}