{"pr_number": 9720, "pr_title": "KAFKA-10555: Improve client state machine", "pr_author": "wcarlson5", "pr_createdAt": "2020-12-09T20:52:06Z", "pr_url": "https://github.com/apache/kafka/pull/9720", "timeline": [{"oid": "c7412f83e29251fa1bc44e7931c8d9fe0c565a79", "url": "https://github.com/apache/kafka/commit/c7412f83e29251fa1bc44e7931c8d9fe0c565a79", "message": "init commit, one test is still failing", "committedDate": "2021-01-19T19:15:32Z", "type": "commit"}, {"oid": "42aa534515309ee728e4c5019668673c8be6a364", "url": "https://github.com/apache/kafka/commit/42aa534515309ee728e4c5019668673c8be6a364", "message": "debug", "committedDate": "2021-01-19T19:15:32Z", "type": "commit"}, {"oid": "7c3e014d30b40d7658fe8253d43d7fb3088354e3", "url": "https://github.com/apache/kafka/commit/7c3e014d30b40d7658fe8253d43d7fb3088354e3", "message": "fix state store wipe", "committedDate": "2021-01-19T19:15:32Z", "type": "commit"}, {"oid": "ae8ea329e0302621f1085435d18e4ebcb60750a0", "url": "https://github.com/apache/kafka/commit/ae8ea329e0302621f1085435d18e4ebcb60750a0", "message": "undo dep", "committedDate": "2021-01-19T19:15:32Z", "type": "commit"}, {"oid": "9aff9a7564156cbd77fdffc2610a90ac6ef5cd41", "url": "https://github.com/apache/kafka/commit/9aff9a7564156cbd77fdffc2610a90ac6ef5cd41", "message": "undo dep", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "836e9aeadc1b865452f2f7ed8312b5aaf7db5683", "url": "https://github.com/apache/kafka/commit/836e9aeadc1b865452f2f7ed8312b5aaf7db5683", "message": "quick fixes", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "280dab10ec1e0b66af9ebcc7d6c80325cd5c0959", "url": "https://github.com/apache/kafka/commit/280dab10ec1e0b66af9ebcc7d6c80325cd5c0959", "message": "rebase replace thread so global threads close correctly", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "4e0b5659b5dd6a61e45fe47c8401bd6ed6408850", "url": "https://github.com/apache/kafka/commit/4e0b5659b5dd6a61e45fe47c8401bd6ed6408850", "message": "init commit, one test is still failing", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "5f73045da8a02d287bceb4d8b5deee96e96fe03b", "url": "https://github.com/apache/kafka/commit/5f73045da8a02d287bceb4d8b5deee96e96fe03b", "message": "debug", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "e1b6bb08aafaf73edee5bc420d924b69aab76281", "url": "https://github.com/apache/kafka/commit/e1b6bb08aafaf73edee5bc420d924b69aab76281", "message": "fix state store wipe", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "468a0a62d49a51ed71887bb349913fefb64fa55a", "url": "https://github.com/apache/kafka/commit/468a0a62d49a51ed71887bb349913fefb64fa55a", "message": "undo dep", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "960365970af371dcff7cc08dfdc68ea7654ef496", "url": "https://github.com/apache/kafka/commit/960365970af371dcff7cc08dfdc68ea7654ef496", "message": "undo dep", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "0304647545c089b9572700625679a9461fee194b", "url": "https://github.com/apache/kafka/commit/0304647545c089b9572700625679a9461fee194b", "message": "quick fixes", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "a0a51d94ac65d4218572185c8c6d1cb44d755344", "url": "https://github.com/apache/kafka/commit/a0a51d94ac65d4218572185c8c6d1cb44d755344", "message": "address comments", "committedDate": "2021-01-19T21:51:04Z", "type": "commit"}, {"oid": "35241f4494836fc30c01795322a053b0735ccaf7", "url": "https://github.com/apache/kafka/commit/35241f4494836fc30c01795322a053b0735ccaf7", "message": "returned checks", "committedDate": "2021-01-19T21:55:40Z", "type": "commit"}, {"oid": "8078e962ba05d37251d11c0960df223fdfa24cfd", "url": "https://github.com/apache/kafka/commit/8078e962ba05d37251d11c0960df223fdfa24cfd", "message": "update fail msg", "committedDate": "2021-01-19T22:08:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUyOTgwMw==", "url": "https://github.com/apache/kafka/pull/9720#discussion_r560529803", "body": "Using just `PENDING_ERROR -> ERROR` because the transition to `PENDING_ERROR` can be from multiple sources. Also that transition is already tested so this check implies it", "bodyText": "Using just PENDING_ERROR -> ERROR because the transition to PENDING_ERROR can be from multiple sources. Also that transition is already tested so this check implies it", "bodyHTML": "<p dir=\"auto\">Using just <code>PENDING_ERROR -&gt; ERROR</code> because the transition to <code>PENDING_ERROR</code> can be from multiple sources. Also that transition is already tested so this check implies it</p>", "author": "wcarlson5", "createdAt": "2021-01-19T22:10:07Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -113,14 +114,7 @@\n     private static final List<KeyValue<KafkaStreams.State, KafkaStreams.State>> CRASH =\n         Collections.unmodifiableList(\n             Collections.singletonList(\n-                KeyValue.pair(KafkaStreams.State.RUNNING, KafkaStreams.State.ERROR)\n-            )\n-        );\n-    private static final List<KeyValue<KafkaStreams.State, KafkaStreams.State>> CLOSE_CRASHED =\n-        Collections.unmodifiableList(\n-            Arrays.asList(\n-                KeyValue.pair(KafkaStreams.State.ERROR, KafkaStreams.State.PENDING_SHUTDOWN),\n-                KeyValue.pair(KafkaStreams.State.PENDING_SHUTDOWN, KafkaStreams.State.NOT_RUNNING)\n+                KeyValue.pair(State.PENDING_ERROR, State.ERROR)", "originalCommit": "35241f4494836fc30c01795322a053b0735ccaf7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de99a7c297143372eccfc35bc48752d2bfbd2e8f", "url": "https://github.com/apache/kafka/commit/de99a7c297143372eccfc35bc48752d2bfbd2e8f", "message": "update fail msg", "committedDate": "2021-01-19T22:11:09Z", "type": "commit"}, {"oid": "93beb2f2437365270c5526946d51e3bb4961dd9c", "url": "https://github.com/apache/kafka/commit/93beb2f2437365270c5526946d51e3bb4961dd9c", "message": "close semantics", "committedDate": "2021-01-21T17:45:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIwMDg5MQ==", "url": "https://github.com/apache/kafka/pull/9720#discussion_r562200891", "body": "Why this change? We do wait for `RUNNING`?", "bodyText": "Why this change? We do wait for RUNNING?", "bodyHTML": "<p dir=\"auto\">Why this change? We do wait for <code>RUNNING</code>?</p>", "author": "mjsax", "createdAt": "2021-01-21T21:14:12Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -978,7 +971,7 @@ private void waitForRunning(final List<KeyValue<KafkaStreams.State, KafkaStreams\n         waitForCondition(\n             () -> !observed.isEmpty() && observed.get(observed.size() - 1).value.equals(State.RUNNING),\n             MAX_WAIT_TIME_MS,\n-            () -> \"Client did not startup on time. Observers transitions: \" + observed\n+            () -> \"Client did not have the expected state transition on time. Observers transitions: \" + observed", "originalCommit": "93beb2f2437365270c5526946d51e3bb4961dd9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIyMzMxOA==", "url": "https://github.com/apache/kafka/pull/9720#discussion_r562223318", "bodyText": "We do wait for running, I was thinking of bringing it to match with the other methods below but that doesn't make it anymore useful so I will revet it.", "author": "wcarlson5", "createdAt": "2021-01-21T21:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIwMDg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIwMTAwMg==", "url": "https://github.com/apache/kafka/pull/9720#discussion_r562201002", "body": "nit: fix indention", "bodyText": "nit: fix indention", "bodyHTML": "<p dir=\"auto\">nit: fix indention</p>", "author": "mjsax", "createdAt": "2021-01-21T21:14:23Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -993,6 +986,17 @@ private void waitForStateTransition(final List<KeyValue<KafkaStreams.State, Kafk\n         );\n     }\n \n+    private void waitForStateTransitionContains(final List<KeyValue<KafkaStreams.State, KafkaStreams.State>> observed,\n+                                        final List<KeyValue<KafkaStreams.State, KafkaStreams.State>> expected)", "originalCommit": "93beb2f2437365270c5526946d51e3bb4961dd9c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIwMTM2Ng==", "url": "https://github.com/apache/kafka/pull/9720#discussion_r562201366", "body": "Can we add the expected transitions, too? Easier to debug if the test fails.", "bodyText": "Can we add the expected transitions, too? Easier to debug if the test fails.", "bodyHTML": "<p dir=\"auto\">Can we add the expected transitions, too? Easier to debug if the test fails.</p>", "author": "mjsax", "createdAt": "2021-01-21T21:15:05Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -993,6 +986,17 @@ private void waitForStateTransition(final List<KeyValue<KafkaStreams.State, Kafk\n         );\n     }\n \n+    private void waitForStateTransitionContains(final List<KeyValue<KafkaStreams.State, KafkaStreams.State>> observed,\n+                                        final List<KeyValue<KafkaStreams.State, KafkaStreams.State>> expected)\n+            throws Exception {\n+\n+        waitForCondition(\n+            () -> observed.containsAll(expected),\n+            MAX_WAIT_TIME_MS,\n+            () -> \"Client did not have the expected state transition on time. Observers transitions: \" + observed", "originalCommit": "93beb2f2437365270c5526946d51e3bb4961dd9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIyNDQwOA==", "url": "https://github.com/apache/kafka/pull/9720#discussion_r562224408", "bodyText": "sure that is fine", "author": "wcarlson5", "createdAt": "2021-01-21T21:58:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjIwMTM2Ng=="}], "type": "inlineReview"}, {"oid": "034520223141396471406feb1f3786f91fca822d", "url": "https://github.com/apache/kafka/commit/034520223141396471406feb1f3786f91fca822d", "message": "nits", "committedDate": "2021-01-21T22:10:59Z", "type": "commit"}, {"oid": "e235b62f67fd1b2ab2323750f748e28ad87f9a98", "url": "https://github.com/apache/kafka/commit/e235b62f67fd1b2ab2323750f748e28ad87f9a98", "message": "extract system time change fix", "committedDate": "2021-01-21T22:43:21Z", "type": "commit"}]}