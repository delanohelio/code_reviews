{"pr_number": 692, "pr_title": "CXF-8227: Failure to comply with JAX-RS spec with ContainerRequestContext and WriterInterceptorContext", "pr_author": "reta", "pr_createdAt": "2020-09-09T01:48:12Z", "pr_url": "https://github.com/apache/cxf/pull/692", "timeline": [{"oid": "3caeb643068ee6a9cafb849deee6bd7bc67f2ed9", "url": "https://github.com/apache/cxf/commit/3caeb643068ee6a9cafb849deee6bd7bc67f2ed9", "message": "CXF-8227: Failure to comply with JAX-RS spec with ContainerRequestContext and WriterInterceptorContext", "committedDate": "2020-09-09T01:41:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxMDU5OA==", "url": "https://github.com/apache/cxf/pull/692#discussion_r485710598", "body": "```suggestion\r\n        private final HttpServletRequest request;\r\n```\r\n\r\nit looks like this is not intended to be changed, so we could explicitly mark it as final.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private HttpServletRequest request;\n          \n          \n            \n                    private final HttpServletRequest request;\n          \n      \n    \n    \n  \n\nit looks like this is not intended to be changed, so we could explicitly mark it as final.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">private</span> <span class=\"pl-smi\">HttpServletRequest</span> request;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">HttpServletRequest</span> request;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">it looks like this is not intended to be changed, so we could explicitly mark it as final.</p>", "author": "andymc12", "createdAt": "2020-09-09T15:39:01Z", "path": "rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/PropertyHolderFactory.java", "diffHunk": "@@ -41,6 +46,60 @@ public static PropertyHolder getPropertyHolder(Message m) {\n         void setProperty(String name, Object value);\n         Collection<String> getPropertyNames();\n     }\n+    \n+    private static class ServletRequestPropertyHolder extends MessagePropertyHolder {\n+        private static final String ENDPOINT_ADDRESS_PROPERTY = \"org.apache.cxf.transport.endpoint.address\";\n+        private HttpServletRequest request;", "originalCommit": "3caeb643068ee6a9cafb849deee6bd7bc67f2ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0MzYxNw==", "url": "https://github.com/apache/cxf/pull/692#discussion_r485943617", "bodyText": "\ud83d\udc4d correct, thank you!", "author": "reta", "createdAt": "2020-09-09T21:54:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxMDU5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNDk1MQ==", "url": "https://github.com/apache/cxf/pull/692#discussion_r485714951", "body": "```suggestion\r\n                context.getHeaders().putSingle(\"X-Book-Response-Header\", property);\r\n```\r\n\r\nJust a suggestion, but IIUC, the intent is to show that property set from the request filter is propagated to the writer interceptor (in the response flow).  By using a different header in the response, it makes it clear that the test is not just propagating headers from the request back to the response.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            context.getHeaders().putSingle(\"X-Book-Header\", property);\n          \n          \n            \n                            context.getHeaders().putSingle(\"X-Book-Response-Header\", property);\n          \n      \n    \n    \n  \n\nJust a suggestion, but IIUC, the intent is to show that property set from the request filter is propagated to the writer interceptor (in the response flow).  By using a different header in the response, it makes it clear that the test is not just propagating headers from the request back to the response.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                context<span class=\"pl-k\">.</span>getHeaders()<span class=\"pl-k\">.</span>putSingle(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>X-Book-Header<span class=\"pl-pds\">\"</span></span>, property);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                context<span class=\"pl-k\">.</span>getHeaders()<span class=\"pl-k\">.</span>putSingle(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>X-Book-<span class=\"x x-first x-last\">Response-</span>Header<span class=\"pl-pds\">\"</span></span>, property);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Just a suggestion, but IIUC, the intent is to show that property set from the request filter is propagated to the writer interceptor (in the response flow).  By using a different header in the response, it makes it clear that the test is not just propagating headers from the request back to the response.</p>", "author": "andymc12", "createdAt": "2020-09-09T15:44:54Z", "path": "systests/jaxrs/src/test/java/org/apache/cxf/systest/jaxrs/BookApplication.java", "diffHunk": "@@ -106,6 +106,12 @@ public void setDefaultId(List<String> ids) {\n         public void aroundWriteTo(WriterInterceptorContext context) throws IOException,\n             WebApplicationException {\n             context.getHeaders().putSingle(\"BookWriter\", \"TheBook\");\n+            \n+            final Object property = context.getProperty(\"x-book\");\n+            if (property != null) {\n+                context.getHeaders().putSingle(\"X-Book-Header\", property);", "originalCommit": "3caeb643068ee6a9cafb849deee6bd7bc67f2ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk2NDQwNw==", "url": "https://github.com/apache/cxf/pull/692#discussion_r485964407", "bodyText": "Completely agree, rewrote the test to reflect its purpose, thanks a lot!", "author": "reta", "createdAt": "2020-09-09T22:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNDk1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcxNTMwNQ==", "url": "https://github.com/apache/cxf/pull/692#discussion_r485715305", "body": "```suggestion\r\n        assertEquals(\"PropValue\", r.getHeaderString(\"X-Book-Response-Header\"));\r\n```\r\n\r\nsee previous comment", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertEquals(\"PropValue\", r.getHeaderString(\"X-Book-Header\"));\n          \n          \n            \n                    assertEquals(\"PropValue\", r.getHeaderString(\"X-Book-Response-Header\"));\n          \n      \n    \n    \n  \n\nsee previous comment", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        assertEquals(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>PropValue<span class=\"pl-pds\">\"</span></span>, r<span class=\"pl-k\">.</span>getHeaderString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>X-Book-Header<span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        assertEquals(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>PropValue<span class=\"pl-pds\">\"</span></span>, r<span class=\"pl-k\">.</span>getHeaderString(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>X-Book-<span class=\"x x-first x-last\">Response-</span>Header<span class=\"pl-pds\">\"</span></span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">see previous comment</p>", "author": "andymc12", "createdAt": "2020-09-09T15:45:23Z", "path": "systests/jaxrs/src/test/java/org/apache/cxf/systest/jaxrs/JAXRSClientServerNonSpringBookTest.java", "diffHunk": "@@ -186,17 +186,33 @@ public void testGetBook123Application11PerRequest() throws Exception {\n             doTestPerRequest(\"http://localhost:\" + PORT + \"/application11/thebooks/bookstore2/bookheaders\");\n         assertEquals(\"TheBook\", r.getHeaderString(\"BookWriter\"));\n     }\n+    \n+    @Test\n+    public void testGetBook123Application11PerRequestWithHeader() throws Exception {\n+        Response r = \n+            doTestPerRequest(\"http://localhost:\" + PORT + \"/application11/thebooks/bookstore2/bookheaders\", \n+                \"PropValue\");\n+        assertEquals(\"PropValue\", r.getHeaderString(\"X-Book-Header\"));", "originalCommit": "3caeb643068ee6a9cafb849deee6bd7bc67f2ed9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4e73867cc862983e64cc50dd1650ae031588090b", "url": "https://github.com/apache/cxf/commit/4e73867cc862983e64cc50dd1650ae031588090b", "message": "Addressing review comments", "committedDate": "2020-09-09T23:34:52Z", "type": "commit"}]}