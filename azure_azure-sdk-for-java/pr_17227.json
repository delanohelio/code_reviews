{"pr_number": 17227, "pr_title": "Sb track2 Fixing some live test ", "pr_author": "hemanttanwar", "pr_createdAt": "2020-11-05T17:22:19Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/17227", "timeline": [{"oid": "17f45bc17957ffbfceb9d6fab758428b5644d889", "url": "https://github.com/Azure/azure-sdk-for-java/commit/17f45bc17957ffbfceb9d6fab758428b5644d889", "message": "Continue to test", "committedDate": "2020-11-05T08:29:55Z", "type": "commit"}, {"oid": "43ccafbba6d31c56e235eb0045c356fc634b252f", "url": "https://github.com/Azure/azure-sdk-for-java/commit/43ccafbba6d31c56e235eb0045c356fc634b252f", "message": "Fixing live test", "committedDate": "2020-11-05T17:07:01Z", "type": "commit"}, {"oid": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce", "url": "https://github.com/Azure/azure-sdk-for-java/commit/0232012b14dc8c9b089165c0e4ef216a12b1e1ce", "message": "Removing unwanted test file", "committedDate": "2020-11-05T17:18:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MTM4OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518241388", "body": "sessionId can not be null or empty for this method. This branch isn't reachable at runtime?", "bodyText": "sessionId can not be null or empty for this method. This branch isn't reachable at runtime?", "bodyHTML": "<p dir=\"auto\">sessionId can not be null or empty for this method. This branch isn't reachable at runtime?</p>", "author": "YijunXieMS", "createdAt": "2020-11-05T17:44:30Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiverAsyncClient.java", "diffHunk": "@@ -113,13 +113,25 @@\n         final ReceiverOptions newReceiverOptions = new ReceiverOptions(receiverOptions.getReceiveMode(),\n             receiverOptions.getPrefetchCount(), receiverOptions.getMaxLockRenewDuration(),\n             receiverOptions.isEnableAutoComplete(), sessionId, null);\n+\n         final ServiceBusSessionManager sessionSpecificManager = new ServiceBusSessionManager(entityPath, entityType,\n             connectionProcessor, tracerProvider, messageSerializer, newReceiverOptions);\n \n-        return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n-            fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n-            ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> { },\n-            sessionSpecificManager));\n+        if (CoreUtils.isNullOrEmpty(sessionId)) {\n+            return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n+                fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n+                ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> {\n+            }, sessionSpecificManager));\n+        } else {", "originalCommit": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3MzYwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518273601", "bodyText": "removed.", "author": "hemanttanwar", "createdAt": "2020-11-05T18:32:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI0MTM4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NTc3MQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518265771", "body": "Why do we have this?", "bodyText": "Why do we have this?", "bodyHTML": "<p dir=\"auto\">Why do we have this?</p>", "author": "conniey", "createdAt": "2020-11-05T18:18:43Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -166,6 +166,15 @@\n         });\n     }\n \n+    ServiceBusReceiverAsyncClient(String fullyQualifiedNamespace, String entityPath, MessagingEntityType entityType,", "originalCommit": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI4NTk4MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518285980", "bodyText": "I am just following how Yijun did in acceptSession(), where a consumer is created (which create ReceiveLink)  and passed in the constructor . So  when ServiceBusReceiverAsyncClient is created it already have the consumer and it does not create new one.", "author": "hemanttanwar", "createdAt": "2020-11-05T18:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NTc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMxOTQzNg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518319436", "bodyText": "The ServiceBusAsyncClient contains an asyncConsumer.. that's why we have getOrCreate as a child of this.", "author": "conniey", "createdAt": "2020-11-05T19:41:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NTc3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM2Mzc2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518363766", "bodyText": "I changed it as we spoke on teams", "author": "hemanttanwar", "createdAt": "2020-11-05T21:05:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NTc3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NjY0Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518266642", "body": "Wait, why are we doing this logic here?", "bodyText": "Wait, why are we doing this logic here?", "bodyHTML": "<p dir=\"auto\">Wait, why are we doing this logic here?</p>", "author": "conniey", "createdAt": "2020-11-05T18:20:12Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiverAsyncClient.java", "diffHunk": "@@ -113,13 +113,25 @@\n         final ReceiverOptions newReceiverOptions = new ReceiverOptions(receiverOptions.getReceiveMode(),\n             receiverOptions.getPrefetchCount(), receiverOptions.getMaxLockRenewDuration(),\n             receiverOptions.isEnableAutoComplete(), sessionId, null);\n+\n         final ServiceBusSessionManager sessionSpecificManager = new ServiceBusSessionManager(entityPath, entityType,\n             connectionProcessor, tracerProvider, messageSerializer, newReceiverOptions);\n \n-        return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n-            fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n-            ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> { },\n-            sessionSpecificManager));\n+        if (CoreUtils.isNullOrEmpty(sessionId)) {", "originalCommit": "0232012b14dc8c9b089165c0e4ef216a12b1e1ce", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3MzM2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518273362", "bodyText": "This is not needed, this is me working late night.", "author": "hemanttanwar", "createdAt": "2020-11-05T18:31:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI2NjY0Mg=="}], "type": "inlineReview"}, {"oid": "2940f9678bf3bc7d5fe75e9921dff565a85ab225", "url": "https://github.com/Azure/azure-sdk-for-java/commit/2940f9678bf3bc7d5fe75e9921dff565a85ab225", "message": "removing unwanted check", "committedDate": "2020-11-05T18:30:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODMyMDUzNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518320534", "body": "This Async suffix is .NET", "bodyText": "This Async suffix is .NET", "bodyHTML": "<p dir=\"auto\">This Async suffix is .NET</p>", "author": "conniey", "createdAt": "2020-11-05T19:43:44Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1050,6 +1059,10 @@ private boolean isManagementToken(String lockToken) {\n             });\n     }\n \n+    Mono<ServiceBusAsyncConsumer> getOrCreateConsumerAsync() {", "originalCommit": "2940f9678bf3bc7d5fe75e9921dff565a85ab225", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "36c6c854f53191a1c3c454ae80133c9e546f5375", "url": "https://github.com/Azure/azure-sdk-for-java/commit/36c6c854f53191a1c3c454ae80133c9e546f5375", "message": "Review comments", "committedDate": "2020-11-05T21:04:29Z", "type": "commit"}, {"oid": "a7b212916c036623d949042c36c1e19155f99daa", "url": "https://github.com/Azure/azure-sdk-for-java/commit/a7b212916c036623d949042c36c1e19155f99daa", "message": "Review comments", "committedDate": "2020-11-05T21:10:23Z", "type": "commit"}, {"oid": "14038785e5c78938c2128a5d52c72bf56a80ced6", "url": "https://github.com/Azure/azure-sdk-for-java/commit/14038785e5c78938c2128a5d52c72bf56a80ced6", "message": "Review comments", "committedDate": "2020-11-05T21:12:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNjMxMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518436310", "body": "One last question. So we get and forget the returned result?", "bodyText": "One last question. So we get and forget the returned result?", "bodyHTML": "<p dir=\"auto\">One last question. So we get and forget the returned result?</p>", "author": "YijunXieMS", "createdAt": "2020-11-05T23:39:29Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1050,6 +1050,13 @@ private boolean isManagementToken(String lockToken) {\n             });\n     }\n \n+    Mono<ServiceBusReceiverAsyncClient> createConsumerWithReceiveLink() {\n+        return Mono.defer(() -> {\n+            getOrCreateConsumer();", "originalCommit": "14038785e5c78938c2128a5d52c72bf56a80ced6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzODUzMA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518438530", "bodyText": "This would be saved in existing consumer in this instance and will be used for all next calls.\nhttps://github.com/Azure/azure-sdk-for-java/pull/17227/files#diff-42c5fc794930edf5858987b570b871727693454acb27130ac5a9748e55d2de95L1054", "author": "hemanttanwar", "createdAt": "2020-11-05T23:45:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNjMxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MTE2NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518441165", "bodyText": "This will be saved on in class instance variable as cache consumer .", "author": "hemanttanwar", "createdAt": "2020-11-05T23:53:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQzNjMxMA=="}], "type": "inlineReview"}, {"oid": "4e70db071b76a3a660a73ed84850ac111917ac28", "url": "https://github.com/Azure/azure-sdk-for-java/commit/4e70db071b76a3a660a73ed84850ac111917ac28", "message": "removing space", "committedDate": "2020-11-05T23:41:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1NjM5Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518456393", "body": "Why are we returning the object again? We already have a reference to it.", "bodyText": "Why are we returning the object again? We already have a reference to it.", "bodyHTML": "<p dir=\"auto\">Why are we returning the object again? We already have a reference to it.</p>", "author": "conniey", "createdAt": "2020-11-06T00:42:12Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClient.java", "diffHunk": "@@ -1050,6 +1050,13 @@ private boolean isManagementToken(String lockToken) {\n             });\n     }\n \n+    Mono<ServiceBusReceiverAsyncClient> createConsumerWithReceiveLink() {\n+        return Mono.defer(() -> {\n+            getOrCreateConsumer();\n+            return Mono.just(this);", "originalCommit": "4e70db071b76a3a660a73ed84850ac111917ac28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1Njg2Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518456862", "body": "You should be disposing of the original `receiver` one before setting it again. ", "bodyText": "You should be disposing of the original receiver one before setting it again.", "bodyHTML": "<p dir=\"auto\">You should be disposing of the original <code>receiver</code> one before setting it again.</p>", "author": "conniey", "createdAt": "2020-11-06T00:43:57Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -897,7 +944,7 @@ void sendReceiveMessageWithVariousPropertyTypes(MessagingEntityType entityType)\n     void setAndGetSessionState(MessagingEntityType entityType) {\n         // Arrange\n         setSenderAndReceiver(entityType, 0, true);\n-\n+        receiver = receiverMono.block(TIMEOUT);", "originalCommit": "4e70db071b76a3a660a73ed84850ac111917ac28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1NzM0Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518457343", "body": "We're not cleaning up the existing receiver that was set.", "bodyText": "We're not cleaning up the existing receiver that was set.", "bodyHTML": "<p dir=\"auto\">We're not cleaning up the existing receiver that was set.</p>", "author": "conniey", "createdAt": "2020-11-06T00:45:27Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -897,7 +944,7 @@ void sendReceiveMessageWithVariousPropertyTypes(MessagingEntityType entityType)\n     void setAndGetSessionState(MessagingEntityType entityType) {\n         // Arrange\n         setSenderAndReceiver(entityType, 0, true);\n-\n+        receiver = receiverMono.block(TIMEOUT);", "originalCommit": "4e70db071b76a3a660a73ed84850ac111917ac28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ1ODA4NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518458084", "body": "We're not disposing of the receiver that was already set. This is some weird hack. If the flow is completely different, we should split test cases instead of shoehorning this in.\r\n\r\nAdditionally, you can do:\r\n\r\n```java\r\nvar receiver = sessionReceiver.acceptSession().cache(e -> Duration.MAX_VALUE, e -> Duration.MIN_VALUE, e -> Duration.MIN_VALUE);\r\ntry {\r\nStepVerifier.create(receiver.flatMap(e -> e.receive...))\r\n    .\r\n\r\n} finally {\r\n    receiver.close();\r\n}\r\n```", "bodyText": "We're not disposing of the receiver that was already set. This is some weird hack. If the flow is completely different, we should split test cases instead of shoehorning this in.\nAdditionally, you can do:\nvar receiver = sessionReceiver.acceptSession().cache(e -> Duration.MAX_VALUE, e -> Duration.MIN_VALUE, e -> Duration.MIN_VALUE);\ntry {\nStepVerifier.create(receiver.flatMap(e -> e.receive...))\n    .\n\n} finally {\n    receiver.close();\n}", "bodyHTML": "<p dir=\"auto\">We're not disposing of the receiver that was already set. This is some weird hack. If the flow is completely different, we should split test cases instead of shoehorning this in.</p>\n<p dir=\"auto\">Additionally, you can do:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"var receiver = sessionReceiver.acceptSession().cache(e -&gt; Duration.MAX_VALUE, e -&gt; Duration.MIN_VALUE, e -&gt; Duration.MIN_VALUE);\ntry {\nStepVerifier.create(receiver.flatMap(e -&gt; e.receive...))\n    .\n\n} finally {\n    receiver.close();\n}\"><pre><span class=\"pl-k\">var</span> receiver <span class=\"pl-k\">=</span> sessionReceiver<span class=\"pl-k\">.</span>acceptSession()<span class=\"pl-k\">.</span>cache(e <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">Duration</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MAX_VALUE</span>, e <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">Duration</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MIN_VALUE</span>, e <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-smi\">Duration</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MIN_VALUE</span>);\n<span class=\"pl-k\">try</span> {\n<span class=\"pl-smi\">StepVerifier</span><span class=\"pl-k\">.</span>create(receiver<span class=\"pl-k\">.</span>flatMap(e <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> e<span class=\"pl-k\">.</span>receive<span class=\"pl-k\">.</span><span class=\"pl-c1\">..</span>))\n    <span class=\"pl-c1\">.</span>\n\n} <span class=\"pl-k\">finally</span> {\n    receiver<span class=\"pl-k\">.</span>close();\n}</pre></div>", "author": "conniey", "createdAt": "2020-11-06T00:47:48Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -638,6 +671,10 @@ void receiveAndComplete(MessagingEntityType entityType, boolean isSessionEnabled\n         final String messageId = UUID.randomUUID().toString();\n         final ServiceBusMessage message = getMessage(messageId, isSessionEnabled);\n \n+        if (isSessionEnabled) {\n+            this.receiver = receiverMono.block(TIMEOUT);", "originalCommit": "4e70db071b76a3a660a73ed84850ac111917ac28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6e1e28295151b0774a6ecff1aa6a71f6f22c814c", "url": "https://github.com/Azure/azure-sdk-for-java/commit/6e1e28295151b0774a6ecff1aa6a71f6f22c814c", "message": "REview comments", "committedDate": "2020-11-06T03:36:59Z", "type": "commit"}, {"oid": "b53db70b3eeea4d77cd46e169ab1b598886ffc2b", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b53db70b3eeea4d77cd46e169ab1b598886ffc2b", "message": "Review comments and test cleanup", "committedDate": "2020-11-06T03:40:54Z", "type": "commit"}, {"oid": "be2f0919a0ed60d553143fc67acded1714535ea9", "url": "https://github.com/Azure/azure-sdk-for-java/commit/be2f0919a0ed60d553143fc67acded1714535ea9", "message": " test cleanup", "committedDate": "2020-11-06T04:06:29Z", "type": "commit"}, {"oid": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "url": "https://github.com/Azure/azure-sdk-for-java/commit/641ff343e9bedcf149c7920a3872b85c3d2ff650", "message": " more test cleanup", "committedDate": "2020-11-06T04:11:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU4OTU2Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518589566", "body": "I don't think is correct or the change above. This method _always_ returns a value. We only want the mono to complete successfully if it was able to acquire a lock on the session.\r\n\r\nThe logic before seems like the correct one.", "bodyText": "I don't think is correct or the change above. This method always returns a value. We only want the mono to complete successfully if it was able to acquire a lock on the session.\nThe logic before seems like the correct one.", "bodyHTML": "<p dir=\"auto\">I don't think is correct or the change above. This method <em>always</em> returns a value. We only want the mono to complete successfully if it was able to acquire a lock on the session.</p>\n<p dir=\"auto\">The logic before seems like the correct one.</p>", "author": "conniey", "createdAt": "2020-11-06T08:21:32Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/main/java/com/azure/messaging/servicebus/ServiceBusSessionReceiverAsyncClient.java", "diffHunk": "@@ -113,13 +113,17 @@\n         final ReceiverOptions newReceiverOptions = new ReceiverOptions(receiverOptions.getReceiveMode(),\n             receiverOptions.getPrefetchCount(), receiverOptions.getMaxLockRenewDuration(),\n             receiverOptions.isEnableAutoComplete(), sessionId, null);\n-        final ServiceBusSessionManager sessionSpecificManager = new ServiceBusSessionManager(entityPath, entityType,\n-            connectionProcessor, tracerProvider, messageSerializer, newReceiverOptions);\n \n-        return sessionSpecificManager.getActiveLink().map(receiveLink -> new ServiceBusReceiverAsyncClient(\n-            fullyQualifiedNamespace, entityPath, entityType, newReceiverOptions, connectionProcessor,\n-            ServiceBusConstants.OPERATION_TIMEOUT, tracerProvider, messageSerializer, () -> { },\n-            sessionSpecificManager));\n+        return  Mono.defer(() -> {", "originalCommit": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MDQxMw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518590413", "body": "There is a `messagesDeferredPending` that we no longer use and can be moved or removed. We never read its values.", "bodyText": "There is a messagesDeferredPending that we no longer use and can be moved or removed. We never read its values.", "bodyHTML": "<p dir=\"auto\">There is a <code>messagesDeferredPending</code> that we no longer use and can be moved or removed. We never read its values.</p>", "author": "conniey", "createdAt": "2020-11-06T08:23:15Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -64,12 +63,6 @@\n     private ServiceBusReceiverAsyncClient receiver;\n     private ServiceBusSenderAsyncClient sender;\n ", "originalCommit": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MTg3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518591876", "body": "Why are we explicitly completing these? the method suggests that these should be auto completed `receiveTwoMessagesAutoComplete`. Same with the one below.", "bodyText": "Why are we explicitly completing these? the method suggests that these should be auto completed receiveTwoMessagesAutoComplete. Same with the one below.", "bodyHTML": "<p dir=\"auto\">Why are we explicitly completing these? the method suggests that these should be auto completed <code>receiveTwoMessagesAutoComplete</code>. Same with the one below.</p>", "author": "conniey", "createdAt": "2020-11-06T08:25:53Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -329,12 +261,15 @@ void receiveTwoMessagesAutoComplete(MessagingEntityType entityType, boolean isSe\n         StepVerifier.create(receiver.receiveMessages())\n             .assertNext(receivedMessage -> {\n                 assertMessageEquals(receivedMessage, messageId, isSessionEnabled);\n+                receiver.complete(receivedMessage).block(Duration.ofSeconds(15));", "originalCommit": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MjkyOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518592929", "body": "Then consume while always returns true? Shouldn't we assert that `completed < messages.size()` and then stop when `completed >= messages.size()`? And instead of thenCancel(), expect a complete?", "bodyText": "Then consume while always returns true? Shouldn't we assert that completed < messages.size() and then stop when completed >= messages.size()? And instead of thenCancel(), expect a complete?", "bodyHTML": "<p dir=\"auto\">Then consume while always returns true? Shouldn't we assert that <code>completed &lt; messages.size()</code> and then stop when <code>completed &gt;= messages.size()</code>? And instead of thenCancel(), expect a complete?</p>", "author": "conniey", "createdAt": "2020-11-06T08:27:53Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -558,9 +486,13 @@ void peekMessages(MessagingEntityType entityType, boolean isSessionEnabled) {\n                 .assertNext(message -> checkCorrectMessage.accept(message, 7))\n                 .verifyComplete();\n         } finally {\n-            receiveAndDeleteReceiver.receiveMessages()\n-                .take(messages.size())\n-                .blockLast(Duration.ofSeconds(15));\n+            StepVerifier.create(receiver.receiveMessages().take(messages.size()))\n+                .thenConsumeWhile(receivedMessage -> {", "originalCommit": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5MzUxNA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518593514", "body": "We have a TIMEOUT duration already defined. We can replace all instances of this Duration.ofSeconds.", "bodyText": "We have a TIMEOUT duration already defined. We can replace all instances of this Duration.ofSeconds.", "bodyHTML": "<p dir=\"auto\">We have a TIMEOUT duration already defined. We can replace all instances of this Duration.ofSeconds.</p>", "author": "conniey", "createdAt": "2020-11-06T08:29:08Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -436,9 +362,10 @@ void sendScheduledMessageAndReceive(MessagingEntityType entityType, boolean isSe\n         sender.scheduleMessage(message, scheduledEnqueueTime).block(TIMEOUT);\n \n         // Assert & Act\n-        StepVerifier.create(Mono.delay(Duration.ofSeconds(3)).then(receiveAndDeleteReceiver.receiveMessages().next()))\n+        StepVerifier.create(Mono.delay(Duration.ofSeconds(4)).then(receiver.receiveMessages().next()))\n             .assertNext(receivedMessage -> {\n                 assertMessageEquals(receivedMessage, messageId, isSessionEnabled);\n+                receiver.complete(receivedMessage).block(Duration.ofSeconds(15));", "originalCommit": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODU5Mzc2Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/17227#discussion_r518593767", "body": "Same with this... wouldn't we expect `receiver.receiveMessages().take(2)` then not cancel?", "bodyText": "Same with this... wouldn't we expect receiver.receiveMessages().take(2) then not cancel?", "bodyHTML": "<p dir=\"auto\">Same with this... wouldn't we expect <code>receiver.receiveMessages().take(2)</code> then not cancel?</p>", "author": "conniey", "createdAt": "2020-11-06T08:29:33Z", "path": "sdk/servicebus/azure-messaging-servicebus/src/test/java/com/azure/messaging/servicebus/ServiceBusReceiverAsyncClientIntegrationTest.java", "diffHunk": "@@ -586,6 +518,17 @@ void peekMessagesFromSequence(MessagingEntityType entityType) {\n         StepVerifier.create(receiver.peekMessagesAt(maxMessages, fromSequenceNumber))\n             .expectNextCount(maxMessages)\n             .verifyComplete();\n+\n+        // cleanup\n+        StepVerifier.create(receiver.receiveMessages())", "originalCommit": "641ff343e9bedcf149c7920a3872b85c3d2ff650", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c3949a8e250fe77e6e852bc11d49e41d49c19483", "url": "https://github.com/Azure/azure-sdk-for-java/commit/c3949a8e250fe77e6e852bc11d49e41d49c19483", "message": "Review comment incorporated.", "committedDate": "2020-11-06T17:20:44Z", "type": "commit"}, {"oid": "b4ba7f43149fdbc2a8cc60af8d61e04200c8ac89", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b4ba7f43149fdbc2a8cc60af8d61e04200c8ac89", "message": "Review comment incorporated.", "committedDate": "2020-11-06T17:28:47Z", "type": "commit"}]}