{"pr_number": 11482, "pr_title": "Cosmos: public API and doc cleanup", "pr_author": "milismsft", "pr_createdAt": "2020-05-27T22:24:50Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/11482", "timeline": [{"oid": "e21262d1f70a82cc28a448a0f033fbe17f8904c2", "url": "https://github.com/Azure/azure-sdk-for-java/commit/e21262d1f70a82cc28a448a0f033fbe17f8904c2", "message": "Make remaning public APIs that take integer throughput value setting pakage private.\nMake readAll* APIs on control plane that take a FeedOption argument package private. Add missing simple readAll* public APIs.\nVarious doc related rewording.", "committedDate": "2020-05-27T22:23:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5Mzc5OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11482#discussion_r431493798", "body": "result validation validates page size, etc. that may fail. you need to update the validation section.", "bodyText": "result validation validates page size, etc. that may fail. you need to update the validation section.", "bodyHTML": "<p dir=\"auto\">result validation validates page size, etc. that may fail. you need to update the validation section.</p>", "author": "moderakh", "createdAt": "2020-05-27T23:11:47Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/ReadFeedUdfsTest.java", "diffHunk": "@@ -37,12 +37,10 @@ public ReadFeedUdfsTest(CosmosClientBuilder clientBuilder) {\n \n     @Test(groups = { \"simple\" }, timeOut = FEED_TIMEOUT)\n     public void readUserDefinedFunctions() throws Exception {\n-\n-        FeedOptions options = new FeedOptions();\n         int maxItemCount = 2;\n \n         CosmosPagedFlux<CosmosUserDefinedFunctionProperties> feedObservable = createdCollection.getScripts()\n-                                                                                               .readAllUserDefinedFunctions(options);\n+                                                                                               .readAllUserDefinedFunctions();", "originalCommit": "e21262d1f70a82cc28a448a0f033fbe17f8904c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMTM3MA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11482#discussion_r431521370", "bodyText": "Page sizes are controlled by maxItemCount which is no longer part of the FeedOptions since when we start returning PageFlux as results.", "author": "milismsft", "createdAt": "2020-05-28T00:45:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5Mzc5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5Mzg2NA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11482#discussion_r431493864", "body": "result validation validates page size, etc. that may fail. you need to update the validation section.", "bodyText": "result validation validates page size, etc. that may fail. you need to update the validation section.", "bodyHTML": "<p dir=\"auto\">result validation validates page size, etc. that may fail. you need to update the validation section.</p>", "author": "moderakh", "createdAt": "2020-05-27T23:11:54Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/ReadFeedUsersTest.java", "diffHunk": "@@ -37,11 +37,9 @@ public ReadFeedUsersTest(CosmosClientBuilder clientBuilder) {\n \n     @Test(groups = { \"simple\" }, timeOut = FEED_TIMEOUT)\n     public void readUsers() throws Exception {\n-\n-        FeedOptions options = new FeedOptions();\n         int maxItemCount = 2;\n \n-        CosmosPagedFlux<CosmosUserProperties> feedObservable = createdDatabase.readAllUsers(options);\n+        CosmosPagedFlux<CosmosUserProperties> feedObservable = createdDatabase.readAllUsers();\n \n         int expectedPageSize = (createdUsers.size() + maxItemCount - 1) / maxItemCount;", "originalCommit": "e21262d1f70a82cc28a448a0f033fbe17f8904c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMTI3Ng==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11482#discussion_r431521276", "bodyText": "Page sizes are controlled by maxItemCount which is no longer part of the FeedOptions since when we start returning PageFlux as results.", "author": "milismsft", "createdAt": "2020-05-28T00:44:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5Mzg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NDM0OA==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11482#discussion_r431494348", "body": "the page size validation may fail.\r\n\r\n```java\r\n        int expectedPageSize = (allDatabases.size() + maxItemCount - 1) / maxItemCount;\r\n        FeedResponseListValidator<CosmosDatabaseProperties> validator = new FeedResponseListValidator.Builder<CosmosDatabaseProperties>()\r\n                .totalSize(allDatabases.size())\r\n                .exactlyContainsInAnyOrder(allDatabases.stream().map(d -> d.getResourceId()).collect(Collectors.toList()))\r\n                .numberOfPages(expectedPageSize)\r\n                .pageSatisfy(0, new FeedResponseValidator.Builder<CosmosDatabaseProperties>()\r\n                        .requestChargeGreaterThanOrEqualTo(1.0).build())\r\n                .build();\r\n\r\n        validateQuerySuccess(feedObservable.byPage(maxItemCount), validator, FEED_TIMEOUT);\r\n```", "bodyText": "the page size validation may fail.\n        int expectedPageSize = (allDatabases.size() + maxItemCount - 1) / maxItemCount;\n        FeedResponseListValidator<CosmosDatabaseProperties> validator = new FeedResponseListValidator.Builder<CosmosDatabaseProperties>()\n                .totalSize(allDatabases.size())\n                .exactlyContainsInAnyOrder(allDatabases.stream().map(d -> d.getResourceId()).collect(Collectors.toList()))\n                .numberOfPages(expectedPageSize)\n                .pageSatisfy(0, new FeedResponseValidator.Builder<CosmosDatabaseProperties>()\n                        .requestChargeGreaterThanOrEqualTo(1.0).build())\n                .build();\n\n        validateQuerySuccess(feedObservable.byPage(maxItemCount), validator, FEED_TIMEOUT);", "bodyHTML": "<p dir=\"auto\">the page size validation may fail.</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"        int expectedPageSize = (allDatabases.size() + maxItemCount - 1) / maxItemCount;\n        FeedResponseListValidator&lt;CosmosDatabaseProperties&gt; validator = new FeedResponseListValidator.Builder&lt;CosmosDatabaseProperties&gt;()\n                .totalSize(allDatabases.size())\n                .exactlyContainsInAnyOrder(allDatabases.stream().map(d -&gt; d.getResourceId()).collect(Collectors.toList()))\n                .numberOfPages(expectedPageSize)\n                .pageSatisfy(0, new FeedResponseValidator.Builder&lt;CosmosDatabaseProperties&gt;()\n                        .requestChargeGreaterThanOrEqualTo(1.0).build())\n                .build();\n\n        validateQuerySuccess(feedObservable.byPage(maxItemCount), validator, FEED_TIMEOUT);\"><pre>        <span class=\"pl-k\">int</span> expectedPageSize <span class=\"pl-k\">=</span> (allDatabases<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">+</span> maxItemCount <span class=\"pl-k\">-</span> <span class=\"pl-c1\">1</span>) <span class=\"pl-k\">/</span> maxItemCount;\n        <span class=\"pl-k\">FeedResponseListValidator&lt;<span class=\"pl-smi\">CosmosDatabaseProperties</span>&gt;</span> validator <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">FeedResponseListValidator</span>.<span class=\"pl-k\">Builder&lt;<span class=\"pl-smi\">CosmosDatabaseProperties</span>&gt;</span>()\n                .totalSize(allDatabases<span class=\"pl-k\">.</span>size())\n                .exactlyContainsInAnyOrder(allDatabases<span class=\"pl-k\">.</span>stream()<span class=\"pl-k\">.</span>map(d <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> d<span class=\"pl-k\">.</span>getResourceId())<span class=\"pl-k\">.</span>collect(<span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>toList()))\n                .numberOfPages(expectedPageSize)\n                .pageSatisfy(<span class=\"pl-c1\">0</span>, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">FeedResponseValidator</span>.<span class=\"pl-k\">Builder&lt;<span class=\"pl-smi\">CosmosDatabaseProperties</span>&gt;</span>()\n                        .requestChargeGreaterThanOrEqualTo(<span class=\"pl-c1\">1.0</span>)<span class=\"pl-k\">.</span>build())\n                .build();\n\n        validateQuerySuccess(feedObservable<span class=\"pl-k\">.</span>byPage(maxItemCount), validator, <span class=\"pl-c1\">FEED_TIMEOUT</span>);</pre></div>", "author": "moderakh", "createdAt": "2020-05-27T23:13:21Z", "path": "sdk/cosmos/azure-cosmos/src/test/java/com/azure/cosmos/rx/ReadFeedDatabasesTest.java", "diffHunk": "@@ -36,11 +36,9 @@ public ReadFeedDatabasesTest(CosmosClientBuilder clientBuilder) {\n \n     @Test(groups = { \"simple\" }, timeOut = FEED_TIMEOUT)\n     public void readDatabases() throws Exception {\n-\n-        FeedOptions options = new FeedOptions();\n         int maxItemCount = 2;\n \n-        CosmosPagedFlux<CosmosDatabaseProperties> feedObservable = client.readAllDatabases(options);", "originalCommit": "e21262d1f70a82cc28a448a0f033fbe17f8904c2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMDg5NQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/11482#discussion_r431520895", "bodyText": "I'm not seeing any test failures when run locally...\nI'm not sure I understand the concern since we already moved the maxItemCount out of the FeedOptions when we transitioned to return PageFlux results... Plus under the new API we do exactly what the test does, which is to call the now package private readAll*() API with a \"new FeedOptions()\" argument value.", "author": "milismsft", "createdAt": "2020-05-28T00:43:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQ5NDM0OA=="}], "type": "inlineReview"}]}