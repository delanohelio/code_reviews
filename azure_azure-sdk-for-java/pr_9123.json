{"pr_number": 9123, "pr_title": "Generalized azurite endpoints", "pr_author": "rickle-msft", "pr_createdAt": "2020-03-16T09:22:19Z", "pr_url": "https://github.com/Azure/azure-sdk-for-java/pull/9123", "timeline": [{"oid": "9e1b4cd9540e75c16c395baf01b74094834eee55", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e1b4cd9540e75c16c395baf01b74094834eee55", "message": "Generalized azurite endpoints", "committedDate": "2020-03-16T09:23:18Z", "type": "commit"}, {"oid": "9e1b4cd9540e75c16c395baf01b74094834eee55", "url": "https://github.com/Azure/azure-sdk-for-java/commit/9e1b4cd9540e75c16c395baf01b74094834eee55", "message": "Generalized azurite endpoints", "committedDate": "2020-03-16T09:23:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1Mjk3Mg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r393152972", "body": "Any reason `/path` is required?", "bodyText": "Any reason /path is required?", "bodyHTML": "<p dir=\"auto\">Any reason <code>/path</code> is required?</p>", "author": "alzimmermsft", "createdAt": "2020-03-16T16:30:34Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/ModelHelper.java", "diffHunk": "@@ -15,8 +18,18 @@\n  * RESERVED FOR INTERNAL USE.\n  */\n public class ModelHelper {\n-    public static final Pattern IP_V4_URL_PATTERN = Pattern\n-        .compile(\"(?:\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3})|(?:localhost)\");\n+\n+    /**\n+     * Determines whether or not the passed authority is IP style, that is it is of the format\n+     * \"&lt;host&gt;:&lt;port&gt;\".\n+     *\n+     * @param authority The authority of a URL.\n+     * @throws MalformedURLException If the authority is malformed.\n+     * @return Whether the authority is IP style.\n+     */\n+    public static boolean determineAuthorityIsIpStyle(String authority) throws MalformedURLException {\n+        return new URL(\"http://\" +  authority + \"/path\").getPort() != -1;", "originalCommit": "9e1b4cd9540e75c16c395baf01b74094834eee55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5MTk3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r393891973", "bodyText": "It was a required parameter for an overload of URL constructor that I was initially trying to use, but I can try this without it and see if it still works", "author": "rickle-msft", "createdAt": "2020-03-17T18:38:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1Mjk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1MzM3Nw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r393153377", "body": "```suggestion\r\n     * {@code \"<host><port>\"}.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * \"&lt;host&gt;:&lt;port&gt;\".\n          \n          \n            \n                 * {@code \"<host><port>\"}.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-s\"><span class=\"pl-pds x x-first\">\"</span><span class=\"x x-last\">&amp;lt;</span>host<span class=\"x x-first x-last\">&amp;gt;:&amp;lt;</span>port<span class=\"x x-first\">&amp;gt;</span><span class=\"pl-pds x x-last\">\"</span></span><span class=\"pl-c1\">.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"x x-first\">{</span><span class=\"pl-k x\">@code</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x x-last\">&lt;</span>host<span class=\"x x-first x-last\">&gt;&lt;</span>port<span class=\"x x-first\">&gt;</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">}</span><span class=\"pl-c1\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alzimmermsft", "createdAt": "2020-03-16T16:31:09Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/ModelHelper.java", "diffHunk": "@@ -15,8 +18,18 @@\n  * RESERVED FOR INTERNAL USE.\n  */\n public class ModelHelper {\n-    public static final Pattern IP_V4_URL_PATTERN = Pattern\n-        .compile(\"(?:\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3})|(?:localhost)\");\n+\n+    /**\n+     * Determines whether or not the passed authority is IP style, that is it is of the format\n+     * \"&lt;host&gt;:&lt;port&gt;\".", "originalCommit": "9e1b4cd9540e75c16c395baf01b74094834eee55", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1NDMyMg==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r393154322", "body": "Does this issue affect Queues as well? I know it also supports IP-style URLs in Azurite.", "bodyText": "Does this issue affect Queues as well? I know it also supports IP-style URLs in Azurite.", "bodyHTML": "<p dir=\"auto\">Does this issue affect Queues as well? I know it also supports IP-style URLs in Azurite.</p>", "author": "alzimmermsft", "createdAt": "2020-03-16T16:32:41Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobUrlParts.java", "diffHunk": "@@ -102,7 +103,12 @@ public String getHost() {\n      */\n     public BlobUrlParts setHost(String host) {\n         this.host = host;\n-        this.isIpUrl = ModelHelper.IP_V4_URL_PATTERN.matcher(host).find();\n+        try {\n+            this.isIpUrl = ModelHelper.determineAuthorityIsIpStyle(host);\n+        } catch (MalformedURLException e) {\n+            throw logger.logExceptionAsError(new IllegalStateException(\"Authority is malformed. Host: \"\n+                + host));\n+        }", "originalCommit": "9e1b4cd9540e75c16c395baf01b74094834eee55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5MjE3Mw==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r393892173", "bodyText": "Yea I should probably bring it over there as well. Thanks for thinking of that.", "author": "rickle-msft", "createdAt": "2020-03-17T18:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1NDMyMg=="}], "type": "inlineReview"}, {"oid": "b236356178f4e08ffa3abc8da10ded4b0642ccf7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b236356178f4e08ffa3abc8da10ded4b0642ccf7", "message": "Added changes to queue", "committedDate": "2020-03-17T21:00:17Z", "type": "commit"}, {"oid": "b236356178f4e08ffa3abc8da10ded4b0642ccf7", "url": "https://github.com/Azure/azure-sdk-for-java/commit/b236356178f4e08ffa3abc8da10ded4b0642ccf7", "message": "Added changes to queue", "committedDate": "2020-03-17T21:00:17Z", "type": "forcePushed"}, {"oid": "3c8359460e57b5630a2cdd3bfb28b91605221a55", "url": "https://github.com/Azure/azure-sdk-for-java/commit/3c8359460e57b5630a2cdd3bfb28b91605221a55", "message": "Checkstyle", "committedDate": "2020-03-17T21:41:44Z", "type": "commit"}, {"oid": "1e71a00aee201839198eb27f459e72b0d31d9ee1", "url": "https://github.com/Azure/azure-sdk-for-java/commit/1e71a00aee201839198eb27f459e72b0d31d9ee1", "message": "Merge remote-tracking branch 'upstream/master' into azuriteEndpoints", "committedDate": "2020-03-17T21:45:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyODMwMQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r394028301", "body": "Should this be illegal state or illegal argument? isnt the url technically something the user provided to us?", "bodyText": "Should this be illegal state or illegal argument? isnt the url technically something the user provided to us?", "bodyHTML": "<p dir=\"auto\">Should this be illegal state or illegal argument? isnt the url technically something the user provided to us?</p>", "author": "gapra-msft", "createdAt": "2020-03-17T23:29:44Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobUrlParts.java", "diffHunk": "@@ -338,10 +343,15 @@ public static BlobUrlParts parse(String url) {\n     public static BlobUrlParts parse(URL url) {\n         BlobUrlParts parts = new BlobUrlParts().setScheme(url.getProtocol());\n \n-        if (ModelHelper.IP_V4_URL_PATTERN.matcher(url.getHost()).find()) {\n-            parseIpUrl(url, parts);\n-        } else {\n-            parseNonIpUrl(url, parts);\n+        try {\n+            if (ModelHelper.determineAuthorityIsIpStyle(url.getAuthority())) {\n+                parseIpUrl(url, parts);\n+            } else {\n+                parseNonIpUrl(url, parts);\n+            }\n+        } catch (MalformedURLException e) {\n+            throw parts.logger.logExceptionAsError(new IllegalStateException(\"Authority is malformed. Host: \"", "originalCommit": "1e71a00aee201839198eb27f459e72b0d31d9ee1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3NTgwOQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r394575809", "bodyText": "I think it should be IllegalState. The parameter type is URL, so that means we're starting with valid URL. The only way it's possibly malformed is if we constructed the dummy URL wrong, which is our fault. And given that we're using syntax that is known to be valid, if it somehow becomes malformed, I think it's fair to call the state illegal.", "author": "rickle-msft", "createdAt": "2020-03-18T19:03:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyODMwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyODUyNQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r394028525", "body": "nit. extra new lines", "bodyText": "nit. extra new lines", "bodyHTML": "<p dir=\"auto\">nit. extra new lines</p>", "author": "gapra-msft", "createdAt": "2020-03-17T23:30:30Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/BlobUrlParts.java", "diffHunk": "@@ -466,4 +476,6 @@ private static void parseNonIpUrl(URL url, BlobUrlParts parts) {\n \n         return retVals;\n     }\n+\n+", "originalCommit": "1e71a00aee201839198eb27f459e72b0d31d9ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTA2OQ==", "url": "https://github.com/Azure/azure-sdk-for-java/pull/9123#discussion_r394029069", "body": "Doesnt matter too much but the wording here is a little weird \"that is it is\", should there be a comma somewhere or something? ", "bodyText": "Doesnt matter too much but the wording here is a little weird \"that is it is\", should there be a comma somewhere or something?", "bodyHTML": "<p dir=\"auto\">Doesnt matter too much but the wording here is a little weird \"that is it is\", should there be a comma somewhere or something?</p>", "author": "gapra-msft", "createdAt": "2020-03-17T23:32:25Z", "path": "sdk/storage/azure-storage-blob/src/main/java/com/azure/storage/blob/implementation/util/ModelHelper.java", "diffHunk": "@@ -7,16 +7,27 @@\n import com.azure.storage.blob.models.ParallelTransferOptions;\n import com.azure.storage.blob.specialized.BlockBlobAsyncClient;\n \n-import java.util.regex.Pattern;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n \n /**\n  * This class provides helper methods for common model patterns.\n  *\n  * RESERVED FOR INTERNAL USE.\n  */\n public class ModelHelper {\n-    public static final Pattern IP_V4_URL_PATTERN = Pattern\n-        .compile(\"(?:\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3}\\\\.\\\\d{1,3})|(?:localhost)\");\n+\n+    /**\n+     * Determines whether or not the passed authority is IP style, that is it is of the format", "originalCommit": "1e71a00aee201839198eb27f459e72b0d31d9ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "27ef6bb7eeafd4e359758e52409e313a8366e7e3", "url": "https://github.com/Azure/azure-sdk-for-java/commit/27ef6bb7eeafd4e359758e52409e313a8366e7e3", "message": "PR feedback", "committedDate": "2020-03-18T19:03:39Z", "type": "commit"}]}