{"pr_number": 1044, "pr_title": "Resolves #1043: Support checking whether or not an index is being built", "pr_author": "nblintao", "pr_createdAt": "2020-10-15T03:33:58Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044", "timeline": [{"oid": "b3bc2ddf8597c705f6252ce4c8c495f26500d5b0", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/b3bc2ddf8597c705f6252ce4c8c495f26500d5b0", "message": "Resolves #1043: Support checking whether or not an index is being built", "committedDate": "2020-10-15T03:58:54Z", "type": "forcePushed"}, {"oid": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "message": "Resolves #1043: Support checking whether or not an index is being built", "committedDate": "2020-10-15T04:19:11Z", "type": "commit"}, {"oid": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "message": "Resolves #1043: Support checking whether or not an index is being built", "committedDate": "2020-10-15T04:19:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NjQ0MQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505666441", "body": "Bit of a nit, but something about \"any\" doesn't quite seem right here... Maybe `checkActive`? ", "bodyText": "Bit of a nit, but something about \"any\" doesn't quite seem right here... Maybe checkActive?", "bodyHTML": "<p dir=\"auto\">Bit of a nit, but something about \"any\" doesn't quite seem right here... Maybe <code>checkActive</code>?</p>", "author": "alecgrieser", "createdAt": "2020-10-15T16:09:58Z", "path": "fdb-extensions/src/main/java/com/apple/foundationdb/synchronizedsession/SynchronizedSession.java", "diffHunk": "@@ -216,15 +224,48 @@ public static void endAnySession(@Nonnull Transaction tr, @Nonnull Subspace lock\n         tr.clear(lockSubspace.range());\n     }\n \n-    private CompletableFuture<UUID> getLockSessionId(@Nonnull Transaction tr) {\n-        return tr.get(lockSessionIdSubspaceKey)\n+\n+    /**\n+     * Check if there is any active session on the given lock subspace, so that a new session would not able to be initialized.\n+     * @param tr transaction to use\n+     * @param lockSubspace the lock whose active session needs to be checked\n+     * @return {@code true} if there is any active session, otherwise {@code false}\n+     */\n+    public static CompletableFuture<Boolean> checkAnySession(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQzMDQwMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512430400", "bodyText": "Yeah, I called it checkAnySession because it's a \"parallel narrative\" of the endAnySession  methods above, but now I can see how this name can be misleading.\nHowever, checkActive also sound vague to me because it doesn't say it's about the current session or about all sessions of the lock. I would imagine SynchronizedSession could be refactored to two classes: SynchronizedSessionLock (defined by a lock subspace) and a SynchronizedSession (defined by a lock subspace and a session ID). After that, checkActive should be a good name on SynchronizedSessionLock.\nWhat about checkExistActiveSession?", "author": "nblintao", "createdAt": "2020-10-27T05:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NjQ0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0NDY4OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512944688", "bodyText": "Okay, I think that name makes sense. Just a grammar change suggested in a follow up review comment", "author": "alecgrieser", "createdAt": "2020-10-27T18:47:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2NjQ0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505668946", "body": "```suggestion\r\n     * Check if the index is being built by any other {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\r\n```\r\n\r\nI think it also might make sense to break the parenthetical into its own sentence--something like \"This requires that the synchronized session feature is enabled on all indexers.\" (Probably with an `@see` or `@link` to the `setUseSyncrhonizedSession` method on the `OnlineIndexer.Builder`.)", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n          \n          \n            \n                 * Check if the index is being built by any other {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n          \n      \n    \n    \n  \n\nI think it also might make sense to break the parenthetical into its own sentence--something like \"This requires that the synchronized session feature is enabled on all indexers.\" (Probably with an @see or @link to the setUseSyncrhonizedSession method on the OnlineIndexer.Builder.)", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Check</span> <span class=\"pl-k\">if</span> the index is being built by any <span class=\"x x-first x-last\">of the</span> {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">OnlineIndexer</span>}s (only <span class=\"pl-k\">if</span> they use {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">SynchronizedSession</span>}s)<span class=\"pl-c1\">.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Check</span> <span class=\"pl-k\">if</span> the index is being built by any <span class=\"x x-first x-last\">other</span> {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">OnlineIndexer</span>}s (only <span class=\"pl-k\">if</span> they use {<span class=\"pl-k\">@link</span> <span class=\"pl-smi\">SynchronizedSession</span>}s)<span class=\"pl-c1\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I think it also might make sense to break the parenthetical into its own sentence--something like \"This requires that the synchronized session feature is enabled on all indexers.\" (Probably with an <code>@see</code> or <code>@link</code> to the <code>setUseSyncrhonizedSession</code> method on the <code>OnlineIndexer.Builder</code>.)</p>", "author": "alecgrieser", "createdAt": "2020-10-15T16:13:38Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,31 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5NDkwNw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505694907", "bodyText": "I think I do mean any OnlineIndexers instead any other OnlineIndexers. Note that these methods are independent of specific OnlineIndexer objects. It returns true to onlineIndexer. checkAnyOngoingOnlineIndexBuildsAsync even if the index is being built by onlineIndexer it self.", "author": "nblintao", "createdAt": "2020-10-15T16:53:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY5ODMxMA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505698310", "bodyText": "Oh, interesting. I guess that's true. I guess it's just the \"the\" then that's extraneous, though it may be worth calling that out in the docs (that this \"self conflicts\")", "author": "alecgrieser", "createdAt": "2020-10-15T16:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyNDg0Ng==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512424846", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T05:27:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2ODk0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTE1OQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505669159", "body": "Same comments about the docs as on the other method", "bodyText": "Same comments about the docs as on the other method", "bodyHTML": "<p dir=\"auto\">Same comments about the docs as on the other method</p>", "author": "alecgrieser", "createdAt": "2020-10-15T16:13:56Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,31 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync() {\n+        return runner.runAsync(context -> openRecordStore(context).thenCompose(recordStore ->\n+                checkAnyOngoingOnlineIndexBuildsAsync(recordStore, index)));\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyNTgxNQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512425815", "bodyText": "Removed the, but I don't I should call out \"self conflict\" here because this is a static method.", "author": "nblintao", "createdAt": "2020-10-27T05:30:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTM5OA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r505669398", "body": "```suggestion\r\n     * @param index the index to check for ongoing index builds\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param index the index whose builds need to be stopped\n          \n          \n            \n                 * @param index the index to check for ongoing index builds", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@param</span> index the index <span class=\"x x-first x-last\">whose builds need to be stopped</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@param</span> index the index <span class=\"x x-first\">to check </span><span class=\"pl-k x\">for</span><span class=\"x x-last\"> ongoing index builds</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecgrieser", "createdAt": "2020-10-15T16:14:19Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,31 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync() {\n+        return runner.runAsync(context -> openRecordStore(context).thenCompose(recordStore ->\n+                checkAnyOngoingOnlineIndexBuildsAsync(recordStore, index)));\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @param recordStore record store whose index builds need to be checked\n+     * @param index the index whose builds need to be stopped", "originalCommit": "4db3b96f1f12cfcbfdf421aac4a6a79716cc3b7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQyNTEzOA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512425138", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T05:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTY2OTM5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzc1Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512943752", "body": "```suggestion\r\n    public static CompletableFuture<Boolean> checkActiveSessionExists(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static CompletableFuture<Boolean> checkExistActiveSession(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {\n          \n          \n            \n                public static CompletableFuture<Boolean> checkActiveSessionExists(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">CompletableFuture&lt;<span class=\"pl-smi\">Boolean</span>&gt;</span> <span class=\"x x-first x-last\">checkExistActiveSession</span>(<span class=\"pl-k\">@Nonnull</span> <span class=\"pl-smi\">Transaction</span> tr, <span class=\"pl-k\">@Nonnull</span> <span class=\"pl-smi\">Subspace</span> lockSubspace) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">CompletableFuture&lt;<span class=\"pl-smi\">Boolean</span>&gt;</span> <span class=\"x x-first x-last\">checkActiveSessionExists</span>(<span class=\"pl-k\">@Nonnull</span> <span class=\"pl-smi\">Transaction</span> tr, <span class=\"pl-k\">@Nonnull</span> <span class=\"pl-smi\">Subspace</span> lockSubspace) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecgrieser", "createdAt": "2020-10-27T18:46:31Z", "path": "fdb-extensions/src/main/java/com/apple/foundationdb/synchronizedsession/SynchronizedSession.java", "diffHunk": "@@ -216,15 +224,48 @@ public static void endAnySession(@Nonnull Transaction tr, @Nonnull Subspace lock\n         tr.clear(lockSubspace.range());\n     }\n \n-    private CompletableFuture<UUID> getLockSessionId(@Nonnull Transaction tr) {\n-        return tr.get(lockSessionIdSubspaceKey)\n+\n+    /**\n+     * Check if there is any active session on the given lock subspace, so that a new session would not able to be initialized.\n+     * @param tr transaction to use\n+     * @param lockSubspace the lock whose active session needs to be checked\n+     * @return {@code true} if there is any active session, otherwise {@code false}\n+     */\n+    public static CompletableFuture<Boolean> checkExistActiveSession(@Nonnull Transaction tr, @Nonnull Subspace lockSubspace) {", "originalCommit": "60899100c9830e70399fa45b3406a57578c0ce47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3Mzk3NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r513073975", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T22:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzc1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzg1NA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r512943854", "body": "```suggestion\r\n        return SynchronizedSession.checkActiveSessionExists(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return SynchronizedSession.checkExistActiveSession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n          \n          \n            \n                    return SynchronizedSession.checkActiveSessionExists(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> <span class=\"pl-smi\">SynchronizedSession</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">checkExistActiveSession</span>(recordStore<span class=\"pl-k\">.</span>ensureContextActive(), indexBuildLockSubspace(recordStore, index));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> <span class=\"pl-smi\">SynchronizedSession</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">checkActiveSessionExists</span>(recordStore<span class=\"pl-k\">.</span>ensureContextActive(), indexBuildLockSubspace(recordStore, index));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecgrieser", "createdAt": "2020-10-27T18:46:42Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/OnlineIndexer.java", "diffHunk": "@@ -1119,15 +1119,32 @@ public static void stopOngoingOnlineIndexBuilds(@Nonnull FDBRecordStore recordSt\n         SynchronizedSession.endAnySession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));\n     }\n \n-    @VisibleForTesting\n-    CompletableFuture<Void> checkNoOngoingOnlineIndexBuildsAsync() {\n-        return runner\n-                .runAsync(context -> openRecordStore(context).thenApply(store -> indexBuildLockSubspace(store, index)))\n-                .thenCompose(lockSubspace ->\n-                        // It will throw {@link com.apple.foundationdb.synchronizedsession.SynchronizedSessionLockedException}\n-                        // if there are ongoing online index builds.\n-                        runner.startSynchronizedSessionAsync(lockSubspace, leaseLengthMills))\n-                .thenCompose(SynchronizedSessionRunner::endSessionAsync);\n+    /**\n+     * Synchronous/blocking version of {@link #checkAnyOngoingOnlineIndexBuildsAsync()}.\n+     * @return <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public boolean checkAnyOngoingOnlineIndexBuilds() {\n+        return runner.asyncToSync(FDBStoreTimer.Waits.WAIT_CHECK_ONGOING_ONLINE_INDEX_BUILD, checkAnyOngoingOnlineIndexBuildsAsync());\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of the {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s),\n+     * including <i>this</i> {@link OnlineIndexer}.\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync() {\n+        return runner.runAsync(context -> openRecordStore(context).thenCompose(recordStore ->\n+                checkAnyOngoingOnlineIndexBuildsAsync(recordStore, index)));\n+    }\n+\n+    /**\n+     * Check if the index is being built by any of {@link OnlineIndexer}s (only if they use {@link SynchronizedSession}s).\n+     * @param recordStore record store whose index builds need to be checked\n+     * @param index the index to check for ongoing index builds\n+     * @return a future that will complete to <code>true</code> if the index is being built and <code>false</code> otherwise\n+     */\n+    public static CompletableFuture<Boolean> checkAnyOngoingOnlineIndexBuildsAsync(@Nonnull FDBRecordStore recordStore, @Nonnull Index index) {\n+        return SynchronizedSession.checkExistActiveSession(recordStore.ensureContextActive(), indexBuildLockSubspace(recordStore, index));", "originalCommit": "60899100c9830e70399fa45b3406a57578c0ce47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzA3NDAwMQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/1044#discussion_r513074001", "bodyText": "Done.", "author": "nblintao", "createdAt": "2020-10-27T22:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk0Mzg1NA=="}], "type": "inlineReview"}, {"oid": "71edb374b7597951f96c600c94b3226afeab44cf", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/71edb374b7597951f96c600c94b3226afeab44cf", "message": "Fix API name and JavaDoc in SynchronizedSession", "committedDate": "2020-10-27T22:37:42Z", "type": "commit"}, {"oid": "71edb374b7597951f96c600c94b3226afeab44cf", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/71edb374b7597951f96c600c94b3226afeab44cf", "message": "Fix API name and JavaDoc in SynchronizedSession", "committedDate": "2020-10-27T22:37:42Z", "type": "forcePushed"}]}