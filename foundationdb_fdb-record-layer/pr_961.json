{"pr_number": 961, "pr_title": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "pr_author": "jleach4", "pr_createdAt": "2020-06-11T21:21:50Z", "pr_url": "https://github.com/FoundationDB/fdb-record-layer/pull/961", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwMzIzNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439103234", "body": "This method is only called if one wants to add a conflict range over all records, so it should essentially never be called. I'm surprised it's showing up in your profiling. Maybe it doesn't hurt to also optimize it in this way.", "bodyText": "This method is only called if one wants to add a conflict range over all records, so it should essentially never be called. I'm surprised it's showing up in your profiling. Maybe it doesn't hurt to also optimize it in this way.", "bodyHTML": "<p dir=\"auto\">This method is only called if one wants to add a conflict range over all records, so it should essentially never be called. I'm surprised it's showing up in your profiling. Maybe it doesn't hurt to also optimize it in this way.</p>", "author": "alecgrieser", "createdAt": "2020-06-11T22:21:31Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2771,6 +2781,10 @@ public Range getUnbuiltRange() {\n      * Add a read conflict key for all records.\n      */\n     private void addRecordsReadConflict() {\n+        if (recordsReadConflict) {\n+            return;\n+        }\n+        recordsReadConflict = true;", "originalCommit": "40e40a9966f8b9e8fad2d79749a3cb51dca32c3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDQxNA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439104414", "body": "Should this be using a `ConcurrentHashMap`? I think multiple threads can access it at once. Because it's safe to set this multiple times for the same index, having this throw away the full hash map in certain race conditions seems fine, but I'm still worried about messing up internal state in the hash map if there are multiple accessors.", "bodyText": "Should this be using a ConcurrentHashMap? I think multiple threads can access it at once. Because it's safe to set this multiple times for the same index, having this throw away the full hash map in certain race conditions seems fine, but I'm still worried about messing up internal state in the hash map if there are multiple accessors.", "bodyHTML": "<p dir=\"auto\">Should this be using a <code>ConcurrentHashMap</code>? I think multiple threads can access it at once. Because it's safe to set this multiple times for the same index, having this throw away the full hash map in certain race conditions seems fine, but I'm still worried about messing up internal state in the hash map if there are multiple accessors.</p>", "author": "alecgrieser", "createdAt": "2020-06-11T22:25:04Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = new HashSet<>(8);", "originalCommit": "40e40a9966f8b9e8fad2d79749a3cb51dca32c3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNzc1Mg==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439107752", "bodyText": "Yeah, I debated.  I will modify.", "author": "jleach4", "createdAt": "2020-06-11T22:34:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEwNDQxNA=="}], "type": "inlineReview"}, {"oid": "d5f592ec0bd25aadb02fd712ab7f7faad544b66f", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/d5f592ec0bd25aadb02fd712ab7f7faad544b66f", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T22:51:29Z", "type": "forcePushed"}, {"oid": "fe1bb2230563c0e386b78790542fb6548b3f5b4f", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/fe1bb2230563c0e386b78790542fb6548b3f5b4f", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T22:58:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTk3Nw==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439115977", "body": "Is there a reason this doesn't just set it to a `ConcurrentHashMap` in the constructor? We'll need to access this whenever we access an index, which will be essentially most things that interact with the store, so it seems like just initializing this in the constructor would be simpler and not much more expensive?", "bodyText": "Is there a reason this doesn't just set it to a ConcurrentHashMap in the constructor? We'll need to access this whenever we access an index, which will be essentially most things that interact with the store, so it seems like just initializing this in the constructor would be simpler and not much more expensive?", "bodyHTML": "<p dir=\"auto\">Is there a reason this doesn't just set it to a <code>ConcurrentHashMap</code> in the constructor? We'll need to access this whenever we access an index, which will be essentially most things that interact with the store, so it seems like just initializing this in the constructor would be simpler and not much more expensive?</p>", "author": "alecgrieser", "createdAt": "2020-06-11T23:00:11Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -2784,6 +2798,14 @@ private void addIndexStateReadConflict(@Nonnull String indexName) {\n         if (!getRecordMetaData().hasIndex(indexName)) {\n             throw new MetaDataException(\"Index \" + indexName + \" does not exist in meta-data.\");\n         }\n+        if (indexStateReadConflicts == null) {\n+            indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "originalCommit": "fe1bb2230563c0e386b78790542fb6548b3f5b4f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNjQ1NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439116455", "bodyText": "Sure, let me fix.", "author": "jleach4", "createdAt": "2020-06-11T23:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExNTk3Nw=="}], "type": "inlineReview"}, {"oid": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/4ff53285192f0c6d24dcd1d15a379129e3345f2b", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:02:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODA1MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118050", "body": "```suggestion\r\n    @Nonnull\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable\n          \n          \n            \n                @Nonnull", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@<span class=\"x x-first x-last\">Nullable</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@<span class=\"x x-first x-last\">Nonnull</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecgrieser", "createdAt": "2020-06-11T23:06:49Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull\n+    private boolean storeStateReadConflict;\n+\n+    @Nullable", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODE3NQ==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118175", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nonnull", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">    </span><span class=\"pl-k x x-last\">@Nonnull</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecgrieser", "createdAt": "2020-06-11T23:07:13Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODIxOA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118218", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nonnull", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">    </span><span class=\"pl-k x x-last\">@Nonnull</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecgrieser", "createdAt": "2020-06-11T23:07:20Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTExODI2MA==", "url": "https://github.com/FoundationDB/fdb-record-layer/pull/961#discussion_r439118260", "body": "```suggestion\r\n    private final Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);\n          \n          \n            \n                private final Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">Set&lt;<span class=\"pl-smi\">String</span>&gt;</span> indexStateReadConflicts <span class=\"pl-k\">=</span> <span class=\"pl-smi\">ConcurrentHashMap</span><span class=\"pl-k\">.</span>newKeySet(<span class=\"pl-c1\">8</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-k\">Set&lt;<span class=\"pl-smi\">String</span>&gt;</span> indexStateReadConflicts <span class=\"pl-k\">=</span> <span class=\"pl-smi\">ConcurrentHashMap</span><span class=\"pl-k\">.</span>newKeySet(<span class=\"pl-c1\">8</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecgrieser", "createdAt": "2020-06-11T23:07:29Z", "path": "fdb-record-layer-core/src/main/java/com/apple/foundationdb/record/provider/foundationdb/FDBRecordStore.java", "diffHunk": "@@ -250,6 +251,15 @@\n     @Nonnull\n     private final Cache<Tuple, FDBRawRecord> preloadCache;\n \n+    @Nonnull\n+    private boolean recordsReadConflict;\n+\n+    @Nonnull\n+    private boolean storeStateReadConflict;\n+\n+    @Nullable\n+    private Set<String> indexStateReadConflicts = ConcurrentHashMap.newKeySet(8);", "originalCommit": "4ff53285192f0c6d24dcd1d15a379129e3345f2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "20d78bdc5bf61dd0c849efd0fe6d7fb3fa387c4c", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/20d78bdc5bf61dd0c849efd0fe6d7fb3fa387c4c", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:31:26Z", "type": "forcePushed"}, {"oid": "5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:32:21Z", "type": "commit"}, {"oid": "5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "url": "https://github.com/FoundationDB/fdb-record-layer/commit/5231ac92a01ecfbcb17e8bcb57a4572d73b9d083", "message": "Fixes #960 Meta Conflict Range Additions hotspot during large operations.", "committedDate": "2020-06-11T23:32:21Z", "type": "forcePushed"}]}