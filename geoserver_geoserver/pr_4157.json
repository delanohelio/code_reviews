{"pr_number": 4157, "pr_title": "GSIP-188: Add extension point for ResourcePool to convert coverage in\u2026", "pr_author": "joshfix", "pr_createdAt": "2020-04-03T17:49:12Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4157", "timeline": [{"oid": "8b22eb1e1cd99c8fd5c5850a675d79736e8be1d9", "url": "https://github.com/geoserver/geoserver/commit/8b22eb1e1cd99c8fd5c5850a675d79736e8be1d9", "message": "GSIP-188: Add extension point for ResourcePool to convert coverage input objects", "committedDate": "2020-04-03T17:02:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MjMwOQ==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404062309", "body": "New files just need  ``(c) 2020 Open Source Geospatial Foundation - all rights reserved``\r\nThere is no need to add the OpenPlans bit. Same for other files.", "bodyText": "New files just need  (c) 2020 Open Source Geospatial Foundation - all rights reserved\nThere is no need to add the OpenPlans bit. Same for other files.", "bodyHTML": "<p dir=\"auto\">New files just need  <code>(c) 2020 Open Source Geospatial Foundation - all rights reserved</code><br>\nThere is no need to add the OpenPlans bit. Same for other files.</p>", "author": "aaime", "createdAt": "2020-04-06T12:46:32Z", "path": "src/main/src/main/java/org/geoserver/catalog/CoverageReaderFileConverter.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/* (c) 2014 - 2020 Open Source Geospatial Foundation - all rights reserved", "originalCommit": "8b22eb1e1cd99c8fd5c5850a675d79736e8be1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NjA1Mw==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404066053", "bodyText": "Do you want the unnecessary openplans lines removed?", "author": "joshfix", "createdAt": "2020-04-06T12:52:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MjMwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4NjUxOA==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404786518", "bodyText": "@jodygarnett do we have to remove them?", "author": "aaime", "createdAt": "2020-04-07T12:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MjMwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0ODAyMw==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404948023", "bodyText": "For new files, yes because they had nothing to do with OpenPlans (it would just make things more complicated to have them there).", "author": "jodygarnett", "createdAt": "2020-04-07T16:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2MjMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2Mzg4Mg==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404063882", "body": "No requirement to update the dates anymore, we have determined it has no legal value.", "bodyText": "No requirement to update the dates anymore, we have determined it has no legal value.", "bodyHTML": "<p dir=\"auto\">No requirement to update the dates anymore, we have determined it has no legal value.</p>", "author": "aaime", "createdAt": "2020-04-06T12:49:17Z", "path": "src/main/src/main/java/org/geoserver/catalog/ResourcePool.java", "diffHunk": "@@ -1,4 +1,4 @@\n-/* (c) 2014 - 2017 Open Source Geospatial Foundation - all rights reserved\n+/* (c) 2014 - 2020 Open Source Geospatial Foundation - all rights reserved", "originalCommit": "8b22eb1e1cd99c8fd5c5850a675d79736e8be1d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2NjE3NA==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404066174", "bodyText": "Should I revert the dates?", "author": "joshfix", "createdAt": "2020-04-06T12:53:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2Mzg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4NjY3NA==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404786674", "bodyText": "@jodygarnett do we have to revert the dates?", "author": "aaime", "createdAt": "2020-04-07T12:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2Mzg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk0ODcwOQ==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r404948709", "bodyText": "No value to update the dates (no harm in it either) --> no need to revert.\naside: We do ask that a date be added when a new file is created.", "author": "jodygarnett", "createdAt": "2020-04-07T16:31:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA2Mzg4Mg=="}], "type": "inlineReview"}, {"oid": "3ddd3ba0a24a7bcc12fa4dd672e6737b18d13a8d", "url": "https://github.com/geoserver/geoserver/commit/3ddd3ba0a24a7bcc12fa4dd672e6737b18d13a8d", "message": "[GSIP-188] Removed OpenPlans copyright headers", "committedDate": "2020-04-29T12:23:31Z", "type": "commit"}, {"oid": "69442b99faf4e048eb398f2c914487aa8d26a7af", "url": "https://github.com/geoserver/geoserver/commit/69442b99faf4e048eb398f2c914487aa8d26a7af", "message": "[GSIP-188] Fixed formatting issues", "committedDate": "2020-04-29T15:41:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NjE2MQ==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r420796161", "body": "There is indeed a behavioral change, the previous code was trying to lookup the files using the resource loader even if the string representation had no scheme, this one does not. The following change fixes the specific build failure.\r\n\r\n```suggestion\r\n            return uri.getScheme() == null || \"file\".equalsIgnoreCase(uri.getScheme());\r\n```\r\n\r\nI've verified this change makes for a successful build (with all extensions included, -Prelease):\r\n\r\n```\r\n[INFO] ------------------------------------------------------------------------\r\n[INFO] BUILD SUCCESS\r\n[INFO] ------------------------------------------------------------------------\r\n[INFO] Total time:  06:12 min (Wall Clock)\r\n[INFO] Finished at: 2020-05-06T15:36:28+02:00\r\n[INFO] ------------------------------------------------------------------------\r\n```", "bodyText": "There is indeed a behavioral change, the previous code was trying to lookup the files using the resource loader even if the string representation had no scheme, this one does not. The following change fixes the specific build failure.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return uri.getScheme() != null && \"file\".equalsIgnoreCase(uri.getScheme());\n          \n          \n            \n                        return uri.getScheme() == null || \"file\".equalsIgnoreCase(uri.getScheme());\n          \n      \n    \n    \n  \n\nI've verified this change makes for a successful build (with all extensions included, -Prelease):\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  06:12 min (Wall Clock)\n[INFO] Finished at: 2020-05-06T15:36:28+02:00\n[INFO] ------------------------------------------------------------------------", "bodyHTML": "<p dir=\"auto\">There is indeed a behavioral change, the previous code was trying to lookup the files using the resource loader even if the string representation had no scheme, this one does not. The following change fixes the specific build failure.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">return</span> uri<span class=\"pl-k\">.</span>getScheme() <span class=\"pl-k x x-first x-last\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k x x-first x-last\">&amp;&amp;</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>file<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">.</span>equalsIgnoreCase(uri<span class=\"pl-k\">.</span>getScheme());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">return</span> uri<span class=\"pl-k\">.</span>getScheme() <span class=\"pl-k x x-first x-last\">==</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k x x-first x-last\">||</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>file<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">.</span>equalsIgnoreCase(uri<span class=\"pl-k\">.</span>getScheme());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I've verified this change makes for a successful build (with all extensions included, -Prelease):</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  06:12 min (Wall Clock)\n[INFO] Finished at: 2020-05-06T15:36:28+02:00\n[INFO] ------------------------------------------------------------------------\"><pre><code>[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  06:12 min (Wall Clock)\n[INFO] Finished at: 2020-05-06T15:36:28+02:00\n[INFO] ------------------------------------------------------------------------\n</code></pre></div>", "author": "aaime", "createdAt": "2020-05-06T13:37:22Z", "path": "src/main/src/main/java/org/geoserver/catalog/CoverageReaderFileConverter.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/* (c) 2014 - 2020 Open Source Geospatial Foundation - all rights reserved\n+ * This code is licensed under the GPL 2.0 license, available at the root\n+ * application directory.\n+ */\n+package org.geoserver.catalog;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+import org.geoserver.platform.resource.Files;\n+import org.geoserver.platform.resource.Resource;\n+import org.geoserver.platform.resource.Resources;\n+import org.geotools.util.factory.Hints;\n+import org.opengis.coverage.grid.GridCoverageReader;\n+\n+/**\n+ * Attempts to convert the source input object for a {@link GridCoverageReader} to {@link File}.\n+ *\n+ * @author joshfix Created on 2/25/20\n+ */\n+public class CoverageReaderFileConverter implements CoverageReaderInputObjectConverter<File> {\n+\n+    private final Catalog catalog;\n+\n+    public CoverageReaderFileConverter(Catalog catalog) {\n+        this.catalog = catalog;\n+    }\n+\n+    /**\n+     * Performs the conversion of the input object to a file object. If this converter is not able\n+     * to convert the input to a File, an empty {@link Optional} will be returned.\n+     *\n+     * @param input The input object.\n+     * @param coverageInfo The grid coverage metadata, may be <code>null</code>.\n+     * @param hints Hints to use when loading the coverage, may be <code>null</code>.\n+     * @return\n+     */\n+    @Override\n+    public Optional<File> convert(\n+            Object input, @Nullable CoverageInfo coverageInfo, @Nullable Hints hints) {\n+        if (!(input instanceof String)) {\n+            return Optional.empty();\n+        }\n+        String urlString = (String) input;\n+        return canConvert(urlString) ? convertFile(urlString) : Optional.empty();\n+    }\n+\n+    /**\n+     * Checks to see if the input string is a file URI.\n+     *\n+     * @param input The input string.\n+     * @return Value representing whether or not this converter is able to convert the provided\n+     *     input to File.\n+     */\n+    protected boolean canConvert(String input) {\n+        // Check to see if our \"url\" points to a file or not, otherwise we use the string itself for\n+        // reading\n+        try {\n+            URI uri = new URI(input);\n+            return uri.getScheme() != null && \"file\".equalsIgnoreCase(uri.getScheme());", "originalCommit": "69442b99faf4e048eb398f2c914487aa8d26a7af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDI5MTYzNw==", "url": "https://github.com/geoserver/geoserver/pull/4157#discussion_r424291637", "bodyText": "@joshfix are you still working on this one?", "author": "aaime", "createdAt": "2020-05-13T09:14:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NjE2MQ=="}], "type": "inlineReview"}, {"oid": "fb6a7d3b944f754dc9a109aa824d966e7a03e1ff", "url": "https://github.com/geoserver/geoserver/commit/fb6a7d3b944f754dc9a109aa824d966e7a03e1ff", "message": "[GSIP-188] fix issue using resource loader input with no scheme", "committedDate": "2020-05-18T18:41:49Z", "type": "commit"}]}