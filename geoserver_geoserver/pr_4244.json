{"pr_number": 4244, "pr_title": "[GEOS-9621] Wps download raster preserve native resolution when repro\u2026", "pr_author": "taba90", "pr_createdAt": "2020-05-15T10:16:29Z", "pr_url": "https://github.com/geoserver/geoserver/pull/4244", "merge_commit": "0982dcd1a4b2e9daff3d7c463356141b31039599", "timeline": [{"oid": "da53c6df269ac4d02a430ce8d4f4859d37537a3a", "url": "https://github.com/geoserver/geoserver/commit/da53c6df269ac4d02a430ce8d4f4859d37537a3a", "message": "[GEOS-9621] Wps download raster preserve native resolution when reprojection is requested with no target size", "committedDate": "2020-05-15T10:22:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMjgyMw==", "url": "https://github.com/geoserver/geoserver/pull/4244#discussion_r425712823", "body": "Be careful.\r\nThis query will return ALL the granules from the DB. They might be thousands/millions for a whole country.\r\nI think that we should refine the query using a bbox or the ROI or something similar as we did in other methods around.", "bodyText": "Be careful.\nThis query will return ALL the granules from the DB. They might be thousands/millions for a whole country.\nI think that we should refine the query using a bbox or the ROI or something similar as we did in other methods around.", "bodyHTML": "<p dir=\"auto\">Be careful.<br>\nThis query will return ALL the granules from the DB. They might be thousands/millions for a whole country.<br>\nI think that we should refine the query using a bbox or the ROI or something similar as we did in other methods around.</p>", "author": "dromagnoli", "createdAt": "2020-05-15T10:31:33Z", "path": "src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java", "diffHunk": "@@ -264,6 +265,44 @@ private void transformResolution(\n                 resolution[1] = transformedDY;\n             }\n         }\n+\n+        /** Gets granules' resolution if it is equal for all the granules, otherwise returns null */\n+        public double[] getGranulesNativeResolutionIfSame(GranuleSource granuleSource)\n+                throws IOException {\n+            Map<String, DimensionDescriptor> descriptors = crsRequestHandler.getDescriptors();\n+            DimensionDescriptor resDescriptor = descriptors.get(DimensionDescriptor.RESOLUTION);\n+            DimensionDescriptor resXDescriptor = descriptors.get(DimensionDescriptor.RESOLUTION_X);\n+            DimensionDescriptor resYDescriptor = descriptors.get(DimensionDescriptor.RESOLUTION_Y);\n+            final String resXAttribute =\n+                    hasBothResolutions\n+                            ? resXDescriptor.getStartAttribute()\n+                            : resDescriptor.getStartAttribute();\n+            final String resYAttribute =\n+                    hasBothResolutions\n+                            ? resYDescriptor.getStartAttribute()\n+                            : resDescriptor.getStartAttribute();\n+\n+            SimpleFeatureCollection granules = granuleSource.getGranules(Query.ALL);", "originalCommit": "da53c6df269ac4d02a430ce8d4f4859d37537a3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "35608aaca81aa8325fca20d39a85b52b5150a79c", "changed_code": [{"header": "diff --git a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\nindex ce810cc82d..975422dc53 100644\n--- a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\n+++ b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\n", "chunk": "@@ -281,18 +294,17 @@ public double[] getGranulesNativeResolutionIfSame(GranuleSource granuleSource)\n                     hasBothResolutions\n                             ? resYDescriptor.getStartAttribute()\n                             : resDescriptor.getStartAttribute();\n-\n-            SimpleFeatureCollection granules = granuleSource.getGranules(Query.ALL);\n-            SimpleFeatureIterator iterator = granules.features();\n-            TreeSet<Double> resolutionsX = new TreeSet<>();\n-            TreeSet<Double> resolutionsY = new TreeSet<>();\n+            GeneralEnvelope envelope = null;\n             while (iterator.hasNext()) {\n                 SimpleFeature feature = iterator.next();\n                 resolutionsX.add((Double) feature.getAttribute(resXAttribute));\n                 resolutionsY.add((Double) feature.getAttribute(resYAttribute));\n             }\n-            if (resolutionsX.size() > 1 || resolutionsY.size() > 1) return null;\n-            return new double[] {resolutionsX.first(), resolutionsY.first()};\n+            if (resolutionsX.size() > 1 || resolutionsY.size() > 1) {\n+                return null;\n+            } else {\n+                return new double[] {resolutionsX.first(), resolutionsY.first()};\n+            }\n         }\n \n         public double[] getResolution(GridCoverage2D coverage2D) {\n", "next_change": {"commit": "349cdbe248a51b15ad2f02b0652a4f823ec090d5", "changed_code": [{"header": "diff --git a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\nindex 975422dc53..0ed090a9e1 100644\n--- a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\n+++ b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\n", "chunk": "@@ -294,17 +282,18 @@ public double[] getGranulesNativeResolutionIfSame(SimpleFeatureCollection granul\n                     hasBothResolutions\n                             ? resYDescriptor.getStartAttribute()\n                             : resDescriptor.getStartAttribute();\n-            GeneralEnvelope envelope = null;\n+\n+            SimpleFeatureCollection granules = granuleSource.getGranules(Query.ALL);\n+            SimpleFeatureIterator iterator = granules.features();\n+            TreeSet<Double> resolutionsX = new TreeSet<>();\n+            TreeSet<Double> resolutionsY = new TreeSet<>();\n             while (iterator.hasNext()) {\n                 SimpleFeature feature = iterator.next();\n                 resolutionsX.add((Double) feature.getAttribute(resXAttribute));\n                 resolutionsY.add((Double) feature.getAttribute(resYAttribute));\n             }\n-            if (resolutionsX.size() > 1 || resolutionsY.size() > 1) {\n-                return null;\n-            } else {\n-                return new double[] {resolutionsX.first(), resolutionsY.first()};\n-            }\n+            if (resolutionsX.size() > 1 || resolutionsY.size() > 1) return null;\n+            return new double[] {resolutionsX.first(), resolutionsY.first()};\n         }\n \n         public double[] getResolution(GridCoverage2D coverage2D) {\n", "next_change": {"commit": "7a691673de9e129d48354ba7e552c242504644e1", "changed_code": [{"header": "diff --git a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\nindex 0ed090a9e1..46499011f2 100644\n--- a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\n+++ b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/GridGeometryProvider.java\n", "chunk": "@@ -282,18 +295,16 @@ public double[] getGranulesNativeResolutionIfSame(GranuleSource granuleSource)\n                     hasBothResolutions\n                             ? resYDescriptor.getStartAttribute()\n                             : resDescriptor.getStartAttribute();\n-\n-            SimpleFeatureCollection granules = granuleSource.getGranules(Query.ALL);\n-            SimpleFeatureIterator iterator = granules.features();\n-            TreeSet<Double> resolutionsX = new TreeSet<>();\n-            TreeSet<Double> resolutionsY = new TreeSet<>();\n             while (iterator.hasNext()) {\n                 SimpleFeature feature = iterator.next();\n                 resolutionsX.add((Double) feature.getAttribute(resXAttribute));\n                 resolutionsY.add((Double) feature.getAttribute(resYAttribute));\n             }\n-            if (resolutionsX.size() > 1 || resolutionsY.size() > 1) return null;\n-            return new double[] {resolutionsX.first(), resolutionsY.first()};\n+            if (resolutionsX.size() > 1 || resolutionsY.size() > 1) {\n+                return null;\n+            } else {\n+                return new double[] {resolutionsX.first(), resolutionsY.first()};\n+            }\n         }\n \n         public double[] getResolution(GridCoverage2D coverage2D) {\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcxMzc0Mw==", "url": "https://github.com/geoserver/geoserver/pull/4244#discussion_r425713743", "body": "I think that this path should be executed only if resolutionDifferenceTolerance is not zero since it's an optional parameter/for optional behavior. Does it make sense?\r\n", "bodyText": "I think that this path should be executed only if resolutionDifferenceTolerance is not zero since it's an optional parameter/for optional behavior. Does it make sense?", "bodyHTML": "<p dir=\"auto\">I think that this path should be executed only if resolutionDifferenceTolerance is not zero since it's an optional parameter/for optional behavior. Does it make sense?</p>", "author": "dromagnoli", "createdAt": "2020-05-15T10:33:30Z", "path": "src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java", "diffHunk": "@@ -510,14 +506,34 @@ private GridCoverage2D readAndReproject(\n                     LOGGER.log(Level.FINE, \"Reprojecting the coverage\");\n                 }\n                 disposableSources.add(gridCoverage);\n-                gridCoverage =\n+                GridCoverage2D testCoverage =\n                         (GridCoverage2D)\n                                 Operations.DEFAULT.resample(\n                                         gridCoverage,\n                                         targetCRS,\n                                         null,\n                                         interpolation,\n                                         backgroundValues);\n+                GridGeometryProvider gridGeometryProvider =", "originalCommit": "da53c6df269ac4d02a430ce8d4f4859d37537a3a", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "35608aaca81aa8325fca20d39a85b52b5150a79c", "changed_code": [{"header": "diff --git a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\nindex c689fd5ea0..87a688d922 100644\n--- a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\n+++ b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\n", "chunk": "@@ -514,11 +519,15 @@ private GridCoverage2D readAndReproject(\n                                         null,\n                                         interpolation,\n                                         backgroundValues);\n+                // check for native resolution to be applied only if tolerance is not 0\n+                if (!forceNativeRes) {\n+                    return testCoverage;\n+                }\n                 GridGeometryProvider gridGeometryProvider =\n                         new GridGeometryProvider(crsRequestHandler);\n                 GridGeometry2D gg2D =\n-                        gridGeometryProvider.getReprojectedGridGeometryWithNativeResolution(\n-                                gridCoverage, testCoverage, resolutionsDifferenceTolerance);\n+                        gridGeometryProvider.getGridGeometryWithNativeResolution(\n+                                gridCoverage, testCoverage);\n                 if (gg2D != null) {\n                     if (LOGGER.isLoggable(Level.FINE)) {\n                         LOGGER.log(Level.FINE, \"Forcing native resolution on reprojected coverage\");\n", "next_change": {"commit": "349cdbe248a51b15ad2f02b0652a4f823ec090d5", "changed_code": [{"header": "diff --git a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\nindex 87a688d922..c689fd5ea0 100644\n--- a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\n+++ b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\n", "chunk": "@@ -519,15 +514,11 @@ private GridCoverage2D readAndReproject(\n                                         null,\n                                         interpolation,\n                                         backgroundValues);\n-                // check for native resolution to be applied only if tolerance is not 0\n-                if (!forceNativeRes) {\n-                    return testCoverage;\n-                }\n                 GridGeometryProvider gridGeometryProvider =\n                         new GridGeometryProvider(crsRequestHandler);\n                 GridGeometry2D gg2D =\n-                        gridGeometryProvider.getGridGeometryWithNativeResolution(\n-                                gridCoverage, testCoverage);\n+                        gridGeometryProvider.getReprojectedGridGeometryWithNativeResolution(\n+                                gridCoverage, testCoverage, resolutionsDifferenceTolerance);\n                 if (gg2D != null) {\n                     if (LOGGER.isLoggable(Level.FINE)) {\n                         LOGGER.log(Level.FINE, \"Forcing native resolution on reprojected coverage\");\n", "next_change": {"commit": "7a691673de9e129d48354ba7e552c242504644e1", "changed_code": [{"header": "diff --git a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\nindex c689fd5ea0..87a688d922 100644\n--- a/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\n+++ b/src/community/wps-download/src/main/java/org/geoserver/wps/gs/download/RasterDownload.java\n", "chunk": "@@ -514,11 +519,15 @@ private GridCoverage2D readAndReproject(\n                                         null,\n                                         interpolation,\n                                         backgroundValues);\n+                // check for native resolution to be applied only if tolerance is not 0\n+                if (!forceNativeRes) {\n+                    return testCoverage;\n+                }\n                 GridGeometryProvider gridGeometryProvider =\n                         new GridGeometryProvider(crsRequestHandler);\n                 GridGeometry2D gg2D =\n-                        gridGeometryProvider.getReprojectedGridGeometryWithNativeResolution(\n-                                gridCoverage, testCoverage, resolutionsDifferenceTolerance);\n+                        gridGeometryProvider.getGridGeometryWithNativeResolution(\n+                                gridCoverage, testCoverage);\n                 if (gg2D != null) {\n                     if (LOGGER.isLoggable(Level.FINE)) {\n                         LOGGER.log(Level.FINE, \"Forcing native resolution on reprojected coverage\");\n", "next_change": null}]}}]}}]}}, {"oid": "35608aaca81aa8325fca20d39a85b52b5150a79c", "url": "https://github.com/geoserver/geoserver/commit/35608aaca81aa8325fca20d39a85b52b5150a79c", "message": "try to force native resolution also when no reprojection is happening", "committedDate": "2020-05-21T07:04:59Z", "type": "forcePushed"}, {"oid": "349cdbe248a51b15ad2f02b0652a4f823ec090d5", "url": "https://github.com/geoserver/geoserver/commit/349cdbe248a51b15ad2f02b0652a4f823ec090d5", "message": "[GEOS-9621] Wps download raster preserve native resolution when reprojection is requested with no target size", "committedDate": "2020-05-28T15:58:15Z", "type": "commit"}, {"oid": "07ca6fe04e1b7a7caa4fd1004c82f4e76f24e545", "url": "https://github.com/geoserver/geoserver/commit/07ca6fe04e1b7a7caa4fd1004c82f4e76f24e545", "message": "reviewer's suggestions applied", "committedDate": "2020-05-28T15:58:16Z", "type": "commit"}, {"oid": "7a691673de9e129d48354ba7e552c242504644e1", "url": "https://github.com/geoserver/geoserver/commit/7a691673de9e129d48354ba7e552c242504644e1", "message": "try to force native resolution also when no reprojection is happening", "committedDate": "2020-05-28T17:04:54Z", "type": "forcePushed"}, {"oid": "7a9c605f37fd556e8e7f1e65de3df346b24d5feb", "url": "https://github.com/geoserver/geoserver/commit/7a9c605f37fd556e8e7f1e65de3df346b24d5feb", "message": "try to force native resolution also when no reprojection is happening", "committedDate": "2020-05-29T12:56:29Z", "type": "commit"}, {"oid": "7a9c605f37fd556e8e7f1e65de3df346b24d5feb", "url": "https://github.com/geoserver/geoserver/commit/7a9c605f37fd556e8e7f1e65de3df346b24d5feb", "message": "try to force native resolution also when no reprojection is happening", "committedDate": "2020-05-29T12:56:29Z", "type": "forcePushed"}]}