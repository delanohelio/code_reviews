{"pr_number": 9631, "pr_title": "chore: fix flaky tests that depends on mock count", "pr_author": "haijian-vaadin", "pr_createdAt": "2020-12-10T21:55:14Z", "pr_url": "https://github.com/vaadin/flow/pull/9631", "timeline": [{"oid": "a465c1a00f2d65af64b8845a5eb3672dbc21e1fd", "url": "https://github.com/vaadin/flow/commit/a465c1a00f2d65af64b8845a5eb3672dbc21e1fd", "message": "chore: fix flaky tests that depends on mock count", "committedDate": "2020-12-10T21:53:37Z", "type": "commit"}, {"oid": "e137f3c3564cdf7af53fcde30fb464bbebb401a7", "url": "https://github.com/vaadin/flow/commit/e137f3c3564cdf7af53fcde30fb464bbebb401a7", "message": "apply code review suggestions", "committedDate": "2020-12-13T19:16:06Z", "type": "commit"}, {"oid": "f354e3909685c798fe7230f85988a38dc7eda508", "url": "https://github.com/vaadin/flow/commit/f354e3909685c798fe7230f85988a38dc7eda508", "message": "apply code review suggestions", "committedDate": "2020-12-13T20:57:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjAxODczMQ==", "url": "https://github.com/vaadin/flow/pull/9631#discussion_r542018731", "body": "![MAJOR](https://sonarsource.github.io/sonar-github/severity-major.png 'Severity: MAJOR') Remove this use of \"Thread.sleep()\". [![rule](https://sonarsource.github.io/sonar-github/rule.png)](https://sonar.projects.vaadin.com/coding_rules#rule_key=squid%3AS2925)\n", "bodyText": "Remove this use of \"Thread.sleep()\".", "bodyHTML": "<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer\" href=\"https://camo.githubusercontent.com/89049b9c46c662e8fa6d1566cd43762c4f8bd19db7eab2c95254508f0f6f31eb/68747470733a2f2f736f6e6172736f757263652e6769746875622e696f2f736f6e61722d6769746875622f73657665726974792d6d616a6f722e706e67\"><img src=\"https://camo.githubusercontent.com/89049b9c46c662e8fa6d1566cd43762c4f8bd19db7eab2c95254508f0f6f31eb/68747470733a2f2f736f6e6172736f757263652e6769746875622e696f2f736f6e61722d6769746875622f73657665726974792d6d616a6f722e706e67\" alt=\"MAJOR\" title=\"Severity: MAJOR\" data-canonical-src=\"https://sonarsource.github.io/sonar-github/severity-major.png\" style=\"max-width: 100%;\"></a> Remove this use of \"Thread.sleep()\". <a href=\"https://sonar.projects.vaadin.com/coding_rules#rule_key=squid%3AS2925\" rel=\"nofollow\"><img src=\"https://camo.githubusercontent.com/90a66c56e56d5e4647676830313fa0693466067889c4c7dc2d7519da5a924230/68747470733a2f2f736f6e6172736f757263652e6769746875622e696f2f736f6e61722d6769746875622f72756c652e706e67\" alt=\"rule\" data-canonical-src=\"https://sonarsource.github.io/sonar-github/rule.png\" style=\"max-width: 100%;\"></a></p>", "author": "vaadin-bot", "createdAt": "2020-12-13T22:21:10Z", "path": "fusion-endpoint/src/test/java/com/vaadin/flow/server/startup/fusion/DevModeInitializerEndpointTest.java", "diffHunk": "@@ -128,63 +128,105 @@ public void teardown() throws Exception, SecurityException {\n     @Test\n     public void should_generateOpenApi_when_EndpointPresents()\n             throws Exception {\n-\n-        // Configure a folder that has .java classes with valid endpoints\n-        // Not using `src/test/java` because there are invalid endpoint names\n-        // in some tests\n-        File src = new File(\n-                getClass().getClassLoader().getResource(\"java\").getFile());\n-        System.setProperty(\"vaadin.\" + CONNECT_JAVA_SOURCE_FOLDER_TOKEN,\n-                src.getAbsolutePath());\n-\n+        String originalJavaSourceFolder = null;\n         File generatedOpenApiJson = Paths\n-                .get(baseDir, DEFAULT_CONNECT_OPENAPI_JSON_FILE).toFile();\n-\n-        Assert.assertFalse(generatedOpenApiJson.exists());\n-        DevModeInitializer devModeInitializer = new DevModeInitializer();\n-        devModeInitializer.onStartup(classes, servletContext);\n-        waitForDevModeServer();\n-        Thread.sleep(200);\n-        Assert.assertTrue(\"Should generate OpenAPI spec if Endpoint is used.\",\n-                generatedOpenApiJson.exists());\n+                    .get(baseDir, DEFAULT_CONNECT_OPENAPI_JSON_FILE).toFile();\n+        try {\n+            originalJavaSourceFolder = System.getProperty(\"vaadin.\" \n+                + CONNECT_JAVA_SOURCE_FOLDER_TOKEN);\n+            // Configure a folder that has .java classes with valid endpoints\n+            // Not using `src/test/java` because there are invalid endpoint names\n+            // in some tests\n+            File src = new File(\n+                    getClass().getClassLoader().getResource(\"java\").getFile());\n+            System.setProperty(\"vaadin.\" + CONNECT_JAVA_SOURCE_FOLDER_TOKEN,\n+                    src.getAbsolutePath());\n+\n+            Assert.assertFalse(generatedOpenApiJson.exists());\n+            DevModeInitializer devModeInitializer = new DevModeInitializer();\n+            devModeInitializer.onStartup(classes, servletContext);\n+            waitForDevModeServer();\n+            Thread.sleep(200);", "originalCommit": "f354e3909685c798fe7230f85988a38dc7eda508", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}