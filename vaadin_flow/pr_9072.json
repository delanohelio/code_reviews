{"pr_number": 9072, "pr_title": "fix: fail access check when no csrf token in session", "pr_author": "haijian-vaadin", "pr_createdAt": "2020-09-28T23:05:15Z", "pr_url": "https://github.com/vaadin/flow/pull/9072", "timeline": [{"oid": "3e972df0feeb89a18314333384ec54807352d244", "url": "https://github.com/vaadin/flow/commit/3e972df0feeb89a18314333384ec54807352d244", "message": "fix: fail access check when no csrf token in session", "committedDate": "2020-09-28T23:04:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ==", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r496689451", "body": "This fails requests with a token header when there is no session. Any reasons behind it?\r\n\r\nIMO it would read more logical if in case of empty session we return early before checking the header:\r\n\r\n```java\r\nHttpSession session = request.getSession(false);\r\nif (session == null) {\r\n  return false;\r\n}\r\n\r\nString csrfToken = (String) request.getSession();\r\nreturn csrfToken == null || !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));\r\n```", "bodyText": "This fails requests with a token header when there is no session. Any reasons behind it?\nIMO it would read more logical if in case of empty session we return early before checking the header:\nHttpSession session = request.getSession(false);\nif (session == null) {\n  return false;\n}\n\nString csrfToken = (String) request.getSession();\nreturn csrfToken == null || !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));", "bodyHTML": "<p dir=\"auto\">This fails requests with a token header when there is no session. Any reasons behind it?</p>\n<p dir=\"auto\">IMO it would read more logical if in case of empty session we return early before checking the header:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"HttpSession session = request.getSession(false);\nif (session == null) {\n  return false;\n}\n\nString csrfToken = (String) request.getSession();\nreturn csrfToken == null || !csrfToken.equals(request.getHeader(&quot;X-CSRF-Token&quot;));\"><pre><span class=\"pl-smi\">HttpSession</span> session <span class=\"pl-k\">=</span> request<span class=\"pl-k\">.</span>getSession(<span class=\"pl-c1\">false</span>);\n<span class=\"pl-k\">if</span> (session <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span>) {\n  <span class=\"pl-k\">return</span> <span class=\"pl-c1\">false</span>;\n}\n\n<span class=\"pl-smi\">String</span> csrfToken <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">String</span>) request<span class=\"pl-k\">.</span>getSession();\n<span class=\"pl-k\">return</span> csrfToken <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">||</span> <span class=\"pl-k\">!</span>csrfToken<span class=\"pl-k\">.</span>equals(request<span class=\"pl-k\">.</span>getHeader(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>X-CSRF-Token<span class=\"pl-pds\">\"</span></span>));</pre></div>", "author": "platosha", "createdAt": "2020-09-29T12:50:16Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/auth/VaadinConnectAccessChecker.java", "diffHunk": "@@ -138,9 +139,14 @@ private boolean requestForbidden(HttpServletRequest request) {\n         if (!xsrfProtectionEnabled) {\n             return false;\n         }\n-        String csrfToken = (String) request.getSession()\n-                .getAttribute(VaadinService.getCsrfTokenAttributeName());\n-        return csrfToken != null && !csrfToken.equals(request.getHeader(\"X-CSRF-Token\"));\n+        HttpSession session = request.getSession(false);\n+        String csrfTokenInHeader = request.getHeader(\"X-CSRF-Token\");\n+        if (session == null) {\n+            return csrfTokenInHeader != null;", "originalCommit": "3e972df0feeb89a18314333384ec54807352d244", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY5NjIxNw==", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r496696217", "bodyText": "This fails requests with a token header when there is no session. Any reasons behind it?\n\nIsn't this exactly the case that the session has expired, and a cached request is being submitted (with an outdated csrf token)?\nit could be fine when there is no csrf token in the request header, e.g. using curl.", "author": "haijian-vaadin", "createdAt": "2020-09-29T13:00:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI4ODYyMQ==", "url": "https://github.com/vaadin/flow/pull/9072#discussion_r497288621", "bodyText": "If the session has expired, it should fail elsewhere in isLoggedIn kind of check.", "author": "platosha", "createdAt": "2020-09-30T07:11:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY4OTQ1MQ=="}], "type": "inlineReview"}, {"oid": "6ea0699ddfba2f08b1a15690a516546c5c0cf2a0", "url": "https://github.com/vaadin/flow/commit/6ea0699ddfba2f08b1a15690a516546c5c0cf2a0", "message": "apply code review suggestion", "committedDate": "2020-09-30T11:51:11Z", "type": "commit"}]}