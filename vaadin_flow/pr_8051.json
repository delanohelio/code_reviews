{"pr_number": 8051, "pr_title": "inherit the default behaviour of spring for internal object mapper", "pr_author": "haijian-vaadin", "pr_createdAt": "2020-04-14T12:31:09Z", "pr_url": "https://github.com/vaadin/flow/pull/8051", "timeline": [{"oid": "ce754cfd414a9297eb35b1977abdc43379d95ec9", "url": "https://github.com/vaadin/flow/commit/ce754cfd414a9297eb35b1977abdc43379d95ec9", "message": "inherit the default behaviour of spring for internal object mapper", "committedDate": "2020-04-14T10:58:22Z", "type": "commit"}, {"oid": "970c9d9add64de948a0922501851dfbb645406c1", "url": "https://github.com/vaadin/flow/commit/970c9d9add64de948a0922501851dfbb645406c1", "message": "fix test", "committedDate": "2020-04-14T13:09:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE3OTAyOQ==", "url": "https://github.com/vaadin/flow/pull/8051#discussion_r408179029", "body": "```suggestion\r\n    private ObjectMapper createVaadinConnectObjectMapper(ApplicationContext context) {\r\n```\r\n* I would rename the get to create, because we create a new instance\r\n* I would rename the method to show that we create the default ObjectMapper for VaadinConnect, not the default ObjectMapper", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private ObjectMapper getDefaultObjectMapper(ApplicationContext context) {\n          \n          \n            \n                private ObjectMapper createVaadinConnectObjectMapper(ApplicationContext context) {\n          \n      \n    \n    \n  \n\n\nI would rename the get to create, because we create a new instance\nI would rename the method to show that we create the default ObjectMapper for VaadinConnect, not the default ObjectMapper", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">ObjectMapper</span> <span class=\"x x-first x-last\">getDefaultObjectMapper</span>(<span class=\"pl-smi\">ApplicationContext</span> context) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">ObjectMapper</span> <span class=\"x x-first x-last\">createVaadinConnectObjectMapper</span>(<span class=\"pl-smi\">ApplicationContext</span> context) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<ul dir=\"auto\">\n<li>I would rename the get to create, because we create a new instance</li>\n<li>I would rename the method to show that we create the default ObjectMapper for VaadinConnect, not the default ObjectMapper</li>\n</ul>", "author": "knoobie", "createdAt": "2020-04-14T14:26:12Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectController.java", "diffHunk": "@@ -153,6 +161,17 @@ public VaadinConnectController(\n         }\n     }\n \n+    private ObjectMapper getDefaultObjectMapper(ApplicationContext context) {", "originalCommit": "970c9d9add64de948a0922501851dfbb645406c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE4MTQ5NQ==", "url": "https://github.com/vaadin/flow/pull/8051#discussion_r408181495", "body": "Edit: This could be all wrong - let me check it.. just saw that it is a static method call. \r\n\r\nEdit2: It is working like this (it inherits in my test spring's config) - this is surprising.. but I it feels wrong. I would still be in favor of`context.getBean(Jackson2ObjectMapperBuilder.class)` - just in case. \r\n\r\n~~This won't work Because you create a completely new instance again (this time from the Jackson2ObjectMapperBuilder) - so all spring related defaults are gone again.~~\r\n\r\n~~This can be fixed in two ways:~~\r\n* ~~add Jackson2ObjectMapperBuilder to the constructor of the class and in this method as argument~~\r\n* ~~`context.getBean(Jackson2ObjectMapperBuilder.class)` could be used to get the current impl of spring.~~ \r\n\r\n~~See here for more information what is configured: https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jackson/JacksonAutoConfiguration.java#L172~~", "bodyText": "Edit: This could be all wrong - let me check it.. just saw that it is a static method call.\nEdit2: It is working like this (it inherits in my test spring's config) - this is surprising.. but I it feels wrong. I would still be in favor ofcontext.getBean(Jackson2ObjectMapperBuilder.class) - just in case.\nThis won't work Because you create a completely new instance again (this time from the Jackson2ObjectMapperBuilder) - so all spring related defaults are gone again.\nThis can be fixed in two ways:\n\nadd Jackson2ObjectMapperBuilder to the constructor of the class and in this method as argument\ncontext.getBean(Jackson2ObjectMapperBuilder.class) could be used to get the current impl of spring.\n\nSee here for more information what is configured: https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jackson/JacksonAutoConfiguration.java#L172", "bodyHTML": "<p dir=\"auto\">Edit: This could be all wrong - let me check it.. just saw that it is a static method call.</p>\n<p dir=\"auto\">Edit2: It is working like this (it inherits in my test spring's config) - this is surprising.. but I it feels wrong. I would still be in favor of<code>context.getBean(Jackson2ObjectMapperBuilder.class)</code> - just in case.</p>\n<p dir=\"auto\"><del>This won't work Because you create a completely new instance again (this time from the Jackson2ObjectMapperBuilder) - so all spring related defaults are gone again.</del></p>\n<p dir=\"auto\"><del>This can be fixed in two ways:</del></p>\n<ul dir=\"auto\">\n<li><del>add Jackson2ObjectMapperBuilder to the constructor of the class and in this method as argument</del></li>\n<li><del><code>context.getBean(Jackson2ObjectMapperBuilder.class)</code> could be used to get the current impl of spring.</del></li>\n</ul>\n<p dir=\"auto\"><del>See here for more information what is configured: <a href=\"https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jackson/JacksonAutoConfiguration.java#L172\">https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jackson/JacksonAutoConfiguration.java#L172</a></del></p>", "author": "knoobie", "createdAt": "2020-04-14T14:29:17Z", "path": "flow-server/src/main/java/com/vaadin/flow/server/connect/VaadinConnectController.java", "diffHunk": "@@ -153,6 +161,17 @@ public VaadinConnectController(\n         }\n     }\n \n+    private ObjectMapper getDefaultObjectMapper(ApplicationContext context) {\n+        ObjectMapper objectMapper = Jackson2ObjectMapperBuilder.json().build();", "originalCommit": "970c9d9add64de948a0922501851dfbb645406c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE4NTUyOA==", "url": "https://github.com/vaadin/flow/pull/8051#discussion_r408185528", "body": "Not blocking, just my personal opinion: I feel this needs a lot more tests. \r\n\r\n* no mocking - a real test with Spring / Spring Boot's Applicationcontext to verify that multiple instances are created with different qualifier (default and vaadin) - example:  Can be done with [ApplicationContextRunner](https://www.baeldung.com/spring-boot-context-runner)\r\n* a test that verifies that the bug described by the user is fixed \r\n* my comment in the last PR: https://github.com/vaadin/flow/pull/8016#discussion_r405137705\r\n", "bodyText": "Not blocking, just my personal opinion: I feel this needs a lot more tests.\n\nno mocking - a real test with Spring / Spring Boot's Applicationcontext to verify that multiple instances are created with different qualifier (default and vaadin) - example:  Can be done with ApplicationContextRunner\na test that verifies that the bug described by the user is fixed\nmy comment in the last PR: #8016 (comment)", "bodyHTML": "<p dir=\"auto\">Not blocking, just my personal opinion: I feel this needs a lot more tests.</p>\n<ul dir=\"auto\">\n<li>no mocking - a real test with Spring / Spring Boot's Applicationcontext to verify that multiple instances are created with different qualifier (default and vaadin) - example:  Can be done with <a href=\"https://www.baeldung.com/spring-boot-context-runner\" rel=\"nofollow\">ApplicationContextRunner</a></li>\n<li>a test that verifies that the bug described by the user is fixed</li>\n<li>my comment in the last PR: <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"595897751\" data-permission-text=\"Title is private\" data-url=\"https://github.com/vaadin/flow/issues/8016\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/vaadin/flow/pull/8016/hovercard?comment_id=405137705&amp;comment_type=review_comment\" href=\"https://github.com/vaadin/flow/pull/8016#discussion_r405137705\">#8016 (comment)</a></li>\n</ul>", "author": "knoobie", "createdAt": "2020-04-14T14:34:31Z", "path": "flow-server/src/test/java/com/vaadin/flow/server/connect/VaadinConnectControllerTest.java", "diffHunk": "@@ -813,9 +813,34 @@ public void should_Never_UseSpringObjectMapper() {\n                 mock(ServletContext.class));\n \n         verify(contextMock, never()).getBean(ObjectMapper.class);\n+        verify(contextMock, times(1)).getBean(JacksonProperties.class);\n         verify(mockSpringObjectMapper, never()).setVisibility(\n                 PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);\n-        verify(contextMock, never()).getBean(JacksonProperties.class);\n+    }\n+\n+    @Test\n+    public void should_NotOverrideVisibility_When_JacksonPropertiesProvideVisibility() {", "originalCommit": "970c9d9add64de948a0922501851dfbb645406c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13e95bb21fdc87abeff05e31228a31e718e787b4", "url": "https://github.com/vaadin/flow/commit/13e95bb21fdc87abeff05e31228a31e718e787b4", "message": "add tests", "committedDate": "2020-04-15T19:24:15Z", "type": "commit"}, {"oid": "556b1f8cda07697f0ec9213a763081ecdc0b0754", "url": "https://github.com/vaadin/flow/commit/556b1f8cda07697f0ec9213a763081ecdc0b0754", "message": "rest endpoint test refactor", "committedDate": "2020-04-16T06:27:55Z", "type": "commit"}, {"oid": "5e02739be33ed15bb698f2650349012ff0e472fc", "url": "https://github.com/vaadin/flow/commit/5e02739be33ed15bb698f2650349012ff0e472fc", "message": "revert VaadinConnectTypeConversionEndpoints.java", "committedDate": "2020-04-16T06:32:50Z", "type": "commit"}, {"oid": "91a618362ae2684fbad454ddcc67066fec330782", "url": "https://github.com/vaadin/flow/commit/91a618362ae2684fbad454ddcc67066fec330782", "message": "Remove the IT suffix from the test", "committedDate": "2020-04-16T07:31:21Z", "type": "commit"}, {"oid": "6ef06f07362dbb3742717045d05ccf68963e20ec", "url": "https://github.com/vaadin/flow/commit/6ef06f07362dbb3742717045d05ccf68963e20ec", "message": "method renaming", "committedDate": "2020-04-16T08:00:04Z", "type": "commit"}, {"oid": "b8a0fae8962ac8e7672464e7c55107fe8b081f72", "url": "https://github.com/vaadin/flow/commit/b8a0fae8962ac8e7672464e7c55107fe8b081f72", "message": "remove leftover code", "committedDate": "2020-04-16T09:21:46Z", "type": "commit"}, {"oid": "513e5c30cdd72f852e518c69272b66e01f1386e4", "url": "https://github.com/vaadin/flow/commit/513e5c30cdd72f852e518c69272b66e01f1386e4", "message": "code formatting", "committedDate": "2020-04-16T10:01:42Z", "type": "commit"}, {"oid": "eef328a67a8fea4a0cec5822b09d5403aedb8463", "url": "https://github.com/vaadin/flow/commit/eef328a67a8fea4a0cec5822b09d5403aedb8463", "message": "code format", "committedDate": "2020-04-16T10:18:01Z", "type": "commit"}, {"oid": "721ccba8f1d1858170055bd748119f5002ec1b04", "url": "https://github.com/vaadin/flow/commit/721ccba8f1d1858170055bd748119f5002ec1b04", "message": "code formatting", "committedDate": "2020-04-16T11:40:11Z", "type": "commit"}]}