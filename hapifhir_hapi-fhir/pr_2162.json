{"pr_number": 2162, "pr_title": "Improve ValueSet filtering", "pr_author": "jamesagnew", "pr_createdAt": "2020-11-09T01:18:01Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/2162", "timeline": [{"oid": "04e127a9850e8fc5dc05b1ba6f1b02915a208b6e", "url": "https://github.com/hapifhir/hapi-fhir/commit/04e127a9850e8fc5dc05b1ba6f1b02915a208b6e", "message": "Improve filter search", "committedDate": "2020-11-04T21:37:44Z", "type": "commit"}, {"oid": "ad0d9ac9ad77c66a371f5f80d2d98ec941ccb45d", "url": "https://github.com/hapifhir/hapi-fhir/commit/ad0d9ac9ad77c66a371f5f80d2d98ec941ccb45d", "message": "Merge branch 'master' into ja_20201104_improve_filter", "committedDate": "2020-11-06T10:24:48Z", "type": "commit"}, {"oid": "dbb601fdb446669ce4c8dfa194942721bf56c7f0", "url": "https://github.com/hapifhir/hapi-fhir/commit/dbb601fdb446669ce4c8dfa194942721bf56c7f0", "message": "Merge branch 'master' into ja_20201104_improve_filter", "committedDate": "2020-11-06T14:11:17Z", "type": "commit"}, {"oid": "aea435fd7f7bf3473047ee59ec65da22cce06517", "url": "https://github.com/hapifhir/hapi-fhir/commit/aea435fd7f7bf3473047ee59ec65da22cce06517", "message": "Filter improvements", "committedDate": "2020-11-06T15:17:08Z", "type": "commit"}, {"oid": "4dba54bcecf64b8edeca9f26db8f132dedea6397", "url": "https://github.com/hapifhir/hapi-fhir/commit/4dba54bcecf64b8edeca9f26db8f132dedea6397", "message": "Tests passing", "committedDate": "2020-11-06T19:25:37Z", "type": "commit"}, {"oid": "67a1c7cad3dadb678d58a5d11c9605a58ca22b7f", "url": "https://github.com/hapifhir/hapi-fhir/commit/67a1c7cad3dadb678d58a5d11c9605a58ca22b7f", "message": "Test fixes", "committedDate": "2020-11-06T20:15:34Z", "type": "commit"}, {"oid": "61c62a0ce762927d737944debf448cebd92adb79", "url": "https://github.com/hapifhir/hapi-fhir/commit/61c62a0ce762927d737944debf448cebd92adb79", "message": "Fix transaction filter", "committedDate": "2020-11-09T01:17:23Z", "type": "commit"}, {"oid": "6d8bd1b573189525457ea784761134c5301a9321", "url": "https://github.com/hapifhir/hapi-fhir/commit/6d8bd1b573189525457ea784761134c5301a9321", "message": "Add changelog", "committedDate": "2020-11-09T01:20:02Z", "type": "commit"}, {"oid": "5514ebe4d191a0683729a4d9cd2ebed81befe42a", "url": "https://github.com/hapifhir/hapi-fhir/commit/5514ebe4d191a0683729a4d9cd2ebed81befe42a", "message": "Test fix", "committedDate": "2020-11-09T13:58:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5OTA0Mg==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2162#discussion_r519899042", "body": "FIXME", "bodyText": "FIXME", "bodyHTML": "<p dir=\"auto\">FIXME</p>", "author": "dmuylwyk", "createdAt": "2020-11-09T15:28:31Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/dao/r4/FhirResourceDaoR4TerminologyTest.java", "diffHunk": "@@ -1015,9 +1015,11 @@ public void testSearchCodeBelowBuiltInCodesystemUnqualified() {\n \t\tmyAllergyIntoleranceDao.create(ai3, mySrd).getId().toUnqualifiedVersionless().getValue();\n \n \t\tSearchParameterMap params;\n-\t\tparams = new SearchParameterMap();\n-\t\tparams.add(AllergyIntolerance.SP_CLINICAL_STATUS, new TokenParam(null, \"active\"));\n-\t\tassertThat(toUnqualifiedVersionlessIdValues(myAllergyIntoleranceDao.search(params)), containsInAnyOrder(id1));\n+\n+\t\t// FIXME: restore", "originalCommit": "5514ebe4d191a0683729a4d9cd2ebed81befe42a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3NjEzMw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2162#discussion_r520176133", "bodyText": "Oops! Fixed.", "author": "jamesagnew", "createdAt": "2020-11-09T23:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5OTA0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkyODMwNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2162#discussion_r519928307", "body": "Typo.\r\n\r\n```suggestion\r\n\t\t\tfail(\"Expanded to \" + expansion.getExpansion().getContains().size() + \" but max was \" + myDaoConfig.getMaximumExpansionSize());\r\n```", "bodyText": "Typo.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\tfail(\"Expanded to \" + expansion.getExpansion().getContains().size() + \" but mas was \" + myDaoConfig.getMaximumExpansionSize());\n          \n          \n            \n            \t\t\tfail(\"Expanded to \" + expansion.getExpansion().getContains().size() + \" but max was \" + myDaoConfig.getMaximumExpansionSize());", "bodyHTML": "<p dir=\"auto\">Typo.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t\tfail(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Expanded to <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> expansion<span class=\"pl-k\">.</span>getExpansion()<span class=\"pl-k\">.</span>getContains()<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span> but <span class=\"x x-first x-last\">mas</span> was <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> myDaoConfig<span class=\"pl-k\">.</span>getMaximumExpansionSize());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t\tfail(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Expanded to <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> expansion<span class=\"pl-k\">.</span>getExpansion()<span class=\"pl-k\">.</span>getContains()<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span> but <span class=\"x x-first x-last\">max</span> was <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> myDaoConfig<span class=\"pl-k\">.</span>getMaximumExpansionSize());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "dmuylwyk", "createdAt": "2020-11-09T16:06:41Z", "path": "hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/term/ValueSetExpansionR4Test.java", "diffHunk": "@@ -877,8 +1129,8 @@ public void testExpandValueSetInMemoryRespectsMaxSize() {\n \t\tValueSet.ConceptSetComponent include = vs.getCompose().addInclude();\n \t\tinclude.setSystem(CS_URL);\n \t\ttry {\n-\t\t\tmyTermSvc.expandValueSet(null, vs);\n-\t\t\tfail();\n+\t\t\tValueSet expansion = myTermSvc.expandValueSet(null, vs);\n+\t\t\tfail(\"Expanded to \" + expansion.getExpansion().getContains().size() + \" but mas was \" + myDaoConfig.getMaximumExpansionSize());", "originalCommit": "5514ebe4d191a0683729a4d9cd2ebed81befe42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTkzMjk3NQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/2162#discussion_r519932975", "body": "Typo.\r\n\r\n```suggestion\r\n\t * Execute in a new transaction only if we aren't already in one. We do this because in some cases\r\n```", "bodyText": "Typo.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Execute in a new transasction only if we aren't already in one. We do this because in some cases\n          \n          \n            \n            \t * Execute in a new transaction only if we aren't already in one. We do this because in some cases", "bodyHTML": "<p dir=\"auto\">Typo.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Execute</span> in a <span class=\"pl-k\">new</span> <span class=\"x x-first x-last\">transasction</span> only if we aren't already in one. We do this because in some cases</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Execute</span> in a <span class=\"pl-k\">new</span> <span class=\"x x-first x-last\">transaction</span> only if we aren't already in one. We do this because in some cases</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "dmuylwyk", "createdAt": "2020-11-09T16:13:03Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java", "diffHunk": "@@ -603,47 +670,49 @@ private void expandValueSet(ValueSetExpansionOptions theExpansionOptions, ValueS\n \t\tourLog.debug(\"Done working with {} in {}ms\", valueSetInfo, sw.getMillis());\n \t}\n \n+\t/**\n+\t * Execute in a new transasction only if we aren't already in one. We do this because in some cases", "originalCommit": "5514ebe4d191a0683729a4d9cd2ebed81befe42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "16f5cedcd6bcfb8fc21aec166b62e357f4071cfe", "url": "https://github.com/hapifhir/hapi-fhir/commit/16f5cedcd6bcfb8fc21aec166b62e357f4071cfe", "message": "Update hapi-fhir-base/src/main/resources/ca/uhn/fhir/i18n/hapi-messages.properties\n\nCo-authored-by: Diederik Muylwyk <diederik.muylwyk@gmail.com>", "committedDate": "2020-11-09T22:59:33Z", "type": "commit"}, {"oid": "53c35fd8fe5d3401a0711148a504d7137bb20843", "url": "https://github.com/hapifhir/hapi-fhir/commit/53c35fd8fe5d3401a0711148a504d7137bb20843", "message": "Update hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/term/BaseTermReadSvcImpl.java\n\nCo-authored-by: Diederik Muylwyk <diederik.muylwyk@gmail.com>", "committedDate": "2020-11-09T22:59:42Z", "type": "commit"}, {"oid": "bd4fef466651526a196973f736ca12484fa71f92", "url": "https://github.com/hapifhir/hapi-fhir/commit/bd4fef466651526a196973f736ca12484fa71f92", "message": "Resolve FIXME", "committedDate": "2020-11-09T23:00:51Z", "type": "commit"}, {"oid": "8d8ffd451f46a7c1fd6e28a68ce676d0d0e55a06", "url": "https://github.com/hapifhir/hapi-fhir/commit/8d8ffd451f46a7c1fd6e28a68ce676d0d0e55a06", "message": "Test fix", "committedDate": "2020-11-10T13:31:40Z", "type": "commit"}, {"oid": "6ca9c752a32dfccf78bc5f85c89ca41ff25af882", "url": "https://github.com/hapifhir/hapi-fhir/commit/6ca9c752a32dfccf78bc5f85c89ca41ff25af882", "message": "Update hapi-fhir-jpaserver-base/src/test/java/ca/uhn/fhir/jpa/term/ValueSetExpansionR4Test.java\n\nCo-authored-by: Diederik Muylwyk <diederik.muylwyk@gmail.com>", "committedDate": "2020-11-10T14:33:24Z", "type": "commit"}]}