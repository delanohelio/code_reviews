{"pr_number": 1863, "pr_title": "Im 20200520 cascade delete", "pr_author": "IanMMarshall", "pr_createdAt": "2020-05-22T17:43:04Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1863", "timeline": [{"oid": "a60e5809b2fa45e71e5c2723662f436564c5a442", "url": "https://github.com/hapifhir/hapi-fhir/commit/a60e5809b2fa45e71e5c2723662f436564c5a442", "message": "Changes to enable adjusting limits on delete conflict handling through configuration.", "committedDate": "2020-05-22T14:15:04Z", "type": "commit"}, {"oid": "b501a601b73f1f54e9cfc07054638d6bd605b1d1", "url": "https://github.com/hapifhir/hapi-fhir/commit/b501a601b73f1f54e9cfc07054638d6bd605b1d1", "message": "Some final cleanup minor updates.", "committedDate": "2020-05-22T17:36:08Z", "type": "commit"}, {"oid": "6a5c23c36b486ed0ad155e7ad28ae365549e8948", "url": "https://github.com/hapifhir/hapi-fhir/commit/6a5c23c36b486ed0ad155e7ad28ae365549e8948", "message": "Adding a proposed change log.", "committedDate": "2020-05-22T17:45:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzM0MQ==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377341", "body": "```suggestion\r\n\t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with {@literal ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor}.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor.\n          \n          \n            \n            \t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with {@literal ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor}.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Invoked</span> when a resource delete operation is about to fail due to referential integrity checks. <span class=\"pl-smi\">Intended</span> <span class=\"pl-k\">for</span> use with <span class=\"pl-smi\">ca.uhn.fhir.jpa.interceptor<span class=\"pl-k\">.</span>CascadingDeleteInterceptor</span>.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Invoked</span> when a resource delete operation is about to fail due to referential integrity checks. <span class=\"pl-smi\">Intended</span> <span class=\"pl-k\">for</span> use with <span class=\"x x-first\">{</span><span class=\"pl-k x\">@literal</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">ca.uhn.fhir.jpa.interceptor<span class=\"pl-k\">.</span>CascadingDeleteInterceptor</span><span class=\"x x-first x-last\">}</span><span class=\"pl-c1\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesagnew", "createdAt": "2020-05-22T17:45:38Z", "path": "hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java", "diffHunk": "@@ -1282,7 +1282,7 @@\n \n \t/**\n \t * <b>Storage Hook:</b>\n-\t * Invoked when a resource delete operation is about to fail due to referential integrity hcts.\n+\t * Invoked when a resource delete operation is about to fail due to referential integrity checks. Intended for use with ca.uhn.fhir.jpa.interceptor.CascadingDeleteInterceptor.", "originalCommit": "b501a601b73f1f54e9cfc07054638d6bd605b1d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzUxNw==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377517", "body": "```suggestion\r\n\t * @since 5.1.0\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 4.1.0\n          \n          \n            \n            \t * @since 5.1.0", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\"><span class=\"x x-first x-last\">4</span>.1</span><span class=\"pl-k\">.</span><span class=\"pl-c1\">0</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\"><span class=\"x x-first x-last\">5</span>.1</span><span class=\"pl-k\">.</span><span class=\"pl-c1\">0</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesagnew", "createdAt": "2020-05-22T17:45:59Z", "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "diffHunk": "@@ -2021,4 +2026,33 @@ public boolean isStoreRequestId() {\n \t\t */\n \t\tANY\n \t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0", "originalCommit": "b501a601b73f1f54e9cfc07054638d6bd605b1d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM3NzU2OA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429377568", "body": "```suggestion\r\n\t * @since 5.1.0\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 4.1.0\n          \n          \n            \n            \t * @since 5.1.0", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\"><span class=\"x x-first x-last\">4</span>.1</span><span class=\"pl-k\">.</span><span class=\"pl-c1\">0</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\"><span class=\"x x-first x-last\">5</span>.1</span><span class=\"pl-k\">.</span><span class=\"pl-c1\">0</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesagnew", "createdAt": "2020-05-22T17:46:07Z", "path": "hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java", "diffHunk": "@@ -2021,4 +2026,33 @@ public boolean isStoreRequestId() {\n \t\t */\n \t\tANY\n \t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0\n+\t */\n+\tpublic Integer getMaximumDeleteConflictQueryCount() {\n+\t\treturn myMaximumDeleteConflictQueryCount;\n+\t}\n+\n+\t/**\n+\t * <p>\n+\t * This determines the maximum number of conflicts that should be fetched and handled while retrying a delete of a resource.\n+\t * </p>\n+\t * <p>\n+\t * The default value for this setting is {@code 60}.\n+\t * </p>\n+\t *\n+\t * @since 4.1.0", "originalCommit": "b501a601b73f1f54e9cfc07054638d6bd605b1d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "44869856da2fc01da253281bffd46a27753ad544", "url": "https://github.com/hapifhir/hapi-fhir/commit/44869856da2fc01da253281bffd46a27753ad544", "message": "Update hapi-fhir-base/src/main/java/ca/uhn/fhir/interceptor/api/Pointcut.java\n\nCo-authored-by: James Agnew <jamesagnew@gmail.com>", "committedDate": "2020-05-22T17:50:24Z", "type": "commit"}, {"oid": "51604dab2ce5ffa67bcf26cd44743cc822f5af07", "url": "https://github.com/hapifhir/hapi-fhir/commit/51604dab2ce5ffa67bcf26cd44743cc822f5af07", "message": "Update hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java\n\nCo-authored-by: James Agnew <jamesagnew@gmail.com>", "committedDate": "2020-05-22T17:50:35Z", "type": "commit"}, {"oid": "612fb215d6b5396f89844c5ac549079be8f9e3d5", "url": "https://github.com/hapifhir/hapi-fhir/commit/612fb215d6b5396f89844c5ac549079be8f9e3d5", "message": "Update hapi-fhir-jpaserver-api/src/main/java/ca/uhn/fhir/jpa/api/config/DaoConfig.java\n\nCo-authored-by: James Agnew <jamesagnew@gmail.com>", "committedDate": "2020-05-22T17:50:42Z", "type": "commit"}, {"oid": "a1a3d9de38591dcb999cd9154bd181e5098236c4", "url": "https://github.com/hapifhir/hapi-fhir/commit/a1a3d9de38591dcb999cd9154bd181e5098236c4", "message": "Merge branch 'master' into im_20200520_cascade_delete", "committedDate": "2020-05-22T20:11:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3MTQ2MA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429971460", "body": "shouldn't this use the new config param?", "bodyText": "shouldn't this use the new config param?", "bodyHTML": "<p dir=\"auto\">shouldn't this use the new config param?</p>", "author": "fil512", "createdAt": "2020-05-25T14:44:19Z", "path": "hapi-fhir-jpaserver-base/src/main/java/ca/uhn/fhir/jpa/delete/DeleteConflictService.java", "diffHunk": "@@ -81,11 +81,16 @@ public int validateOkToDelete(DeleteConflictList theDeleteConflicts, ResourceTab\n \t\twhile (outcome != null) {\n \t\t\tint shouldRetryCount = Math.min(outcome.getShouldRetryCount(), MAX_RETRY_ATTEMPTS);\n \t\t\tif (!(retryCount < shouldRetryCount)) break;\n-\t\t\tnewConflicts = new DeleteConflictList();\n-\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, RETRY_QUERY_RESULT_COUNT, theTransactionDetails);\n+\t\t\tnewConflicts = new DeleteConflictList(newConflicts);\n+\t\t\toutcome = findAndHandleConflicts(theRequest, newConflicts, theEntity, theForValidate, myDaoConfig.getMaximumDeleteConflictQueryCount(), theTransactionDetails);\n \t\t\t++retryCount;\n \t\t}\n \t\ttheDeleteConflicts.addAll(newConflicts);\n+\t\tif(retryCount >= MAX_RETRY_ATTEMPTS && !theDeleteConflicts.isEmpty()) {", "originalCommit": "a1a3d9de38591dcb999cd9154bd181e5098236c4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3NzcxOA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1863#discussion_r429977718", "bodyText": "No. Only the RETRY_QUERY_RESULT_COUNT was made configurable and the RETRY_QUERY_RESULT_COUNT parameter was only being used to determine the number of delete conflicts to process during each retry. This condition is determining essentially whether the previous loop exhausted all of the available retries, the number of which is determined by the static MAX_RETRY_ATTEMPTS parameter.", "author": "IanMMarshall", "createdAt": "2020-05-25T14:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk3MTQ2MA=="}], "type": "inlineReview"}]}