{"pr_number": 1831, "pr_title": "Allow disabling text modifier indexing", "pr_author": "jamesagnew", "pr_createdAt": "2020-05-05T13:41:41Z", "pr_url": "https://github.com/hapifhir/hapi-fhir/pull/1831", "timeline": [{"oid": "10522363f16ef8404daa42bdff9ff77e89d8b2f0", "url": "https://github.com/hapifhir/hapi-fhir/commit/10522363f16ef8404daa42bdff9ff77e89d8b2f0", "message": "Allow disabling text modifier indexing", "committedDate": "2020-05-05T13:41:17Z", "type": "commit"}, {"oid": "190cac2b1c3971c7c9f0259f7a99b808a8d7fee4", "url": "https://github.com/hapifhir/hapi-fhir/commit/190cac2b1c3971c7c9f0259f7a99b808a8d7fee4", "message": "Add changelog", "committedDate": "2020-05-05T13:43:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE3NDA2OA==", "url": "https://github.com/hapifhir/hapi-fhir/pull/1831#discussion_r420174068", "body": "Heya james, I took a whack at refactoring this, since i didn't like how we were relying on nullity of a Boolean. How does this look? Is this the logic you were encapsulating? Tests seem to pass against it\r\n\r\n```java\r\n\tpublic static boolean tokenTextIndexingEnabledForSearchParam(ModelConfig theModelConfig, RuntimeSearchParam theSearchParam) {\r\n\t\tOptional<Boolean> oSuppressForSearchParam = theSearchParam.getExtensions(JpaConstants.EXT_SEARCHPARAM_TOKEN_SUPPRESS_TEXT_INDEXING).stream()\r\n\t\t\t.map(IBaseExtension::getValue)\r\n\t\t\t.map(val -> (IPrimitiveType<?>) val)\r\n\t\t\t.map(IPrimitiveType::getValueAsString)\r\n\t\t\t.map(Boolean::parseBoolean)\r\n\t\t\t.findFirst();\r\n\r\n\t\t//if the SP doesn't care, use the system default.\r\n\t\tif (!oSuppressForSearchParam.isPresent()) {\r\n\t\t\treturn !theModelConfig.isSuppressStringIndexingInTokens();\r\n\t\t//If the SP does care, use its value.\r\n\t\t} else {\r\n\t\t\tboolean suppressForSearchParam = oSuppressForSearchParam.get();\r\n\t\tourLog.trace(\"{} text indexing for SearchParameter {}\", suppressForSearchParam? \"Suppressing\": \"Not Suppressing\", theSearchParam.getName());\r\n\t\treturn !suppressForSearchParam;\r\n\t\t}\r\n\t}\r\n```", "bodyText": "Heya james, I took a whack at refactoring this, since i didn't like how we were relying on nullity of a Boolean. How does this look? Is this the logic you were encapsulating? Tests seem to pass against it\n\tpublic static boolean tokenTextIndexingEnabledForSearchParam(ModelConfig theModelConfig, RuntimeSearchParam theSearchParam) {\n\t\tOptional<Boolean> oSuppressForSearchParam = theSearchParam.getExtensions(JpaConstants.EXT_SEARCHPARAM_TOKEN_SUPPRESS_TEXT_INDEXING).stream()\n\t\t\t.map(IBaseExtension::getValue)\n\t\t\t.map(val -> (IPrimitiveType<?>) val)\n\t\t\t.map(IPrimitiveType::getValueAsString)\n\t\t\t.map(Boolean::parseBoolean)\n\t\t\t.findFirst();\n\n\t\t//if the SP doesn't care, use the system default.\n\t\tif (!oSuppressForSearchParam.isPresent()) {\n\t\t\treturn !theModelConfig.isSuppressStringIndexingInTokens();\n\t\t//If the SP does care, use its value.\n\t\t} else {\n\t\t\tboolean suppressForSearchParam = oSuppressForSearchParam.get();\n\t\tourLog.trace(\"{} text indexing for SearchParameter {}\", suppressForSearchParam? \"Suppressing\": \"Not Suppressing\", theSearchParam.getName());\n\t\treturn !suppressForSearchParam;\n\t\t}\n\t}", "bodyHTML": "<p dir=\"auto\">Heya james, I took a whack at refactoring this, since i didn't like how we were relying on nullity of a Boolean. How does this look? Is this the logic you were encapsulating? Tests seem to pass against it</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"\tpublic static boolean tokenTextIndexingEnabledForSearchParam(ModelConfig theModelConfig, RuntimeSearchParam theSearchParam) {\n\t\tOptional&lt;Boolean&gt; oSuppressForSearchParam = theSearchParam.getExtensions(JpaConstants.EXT_SEARCHPARAM_TOKEN_SUPPRESS_TEXT_INDEXING).stream()\n\t\t\t.map(IBaseExtension::getValue)\n\t\t\t.map(val -&gt; (IPrimitiveType&lt;?&gt;) val)\n\t\t\t.map(IPrimitiveType::getValueAsString)\n\t\t\t.map(Boolean::parseBoolean)\n\t\t\t.findFirst();\n\n\t\t//if the SP doesn't care, use the system default.\n\t\tif (!oSuppressForSearchParam.isPresent()) {\n\t\t\treturn !theModelConfig.isSuppressStringIndexingInTokens();\n\t\t//If the SP does care, use its value.\n\t\t} else {\n\t\t\tboolean suppressForSearchParam = oSuppressForSearchParam.get();\n\t\tourLog.trace(&quot;{} text indexing for SearchParameter {}&quot;, suppressForSearchParam? &quot;Suppressing&quot;: &quot;Not Suppressing&quot;, theSearchParam.getName());\n\t\treturn !suppressForSearchParam;\n\t\t}\n\t}\"><pre>\t<span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">boolean</span> tokenTextIndexingEnabledForSearchParam(<span class=\"pl-smi\">ModelConfig</span> theModelConfig, <span class=\"pl-smi\">RuntimeSearchParam</span> theSearchParam) {\n\t\t<span class=\"pl-k\">Optional&lt;<span class=\"pl-smi\">Boolean</span>&gt;</span> oSuppressForSearchParam <span class=\"pl-k\">=</span> theSearchParam<span class=\"pl-k\">.</span>getExtensions(<span class=\"pl-smi\">JpaConstants</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>EXT_SEARCHPARAM_TOKEN_SUPPRESS_TEXT_INDEXING</span>)<span class=\"pl-k\">.</span>stream()\n\t\t\t.map(<span class=\"pl-smi\">IBaseExtension</span><span class=\"pl-k\">::</span>getValue)\n\t\t\t.map(val <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> (<span class=\"pl-k\">IPrimitiveType&lt;?&gt;</span>) val)\n\t\t\t.map(<span class=\"pl-smi\">IPrimitiveType</span><span class=\"pl-k\">::</span>getValueAsString)\n\t\t\t.map(<span class=\"pl-smi\">Boolean</span><span class=\"pl-k\">::</span>parseBoolean)\n\t\t\t.findFirst();\n\n\t\t<span class=\"pl-c\"><span class=\"pl-c\">//</span>if the SP doesn't care, use the system default.</span>\n\t\t<span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>oSuppressForSearchParam<span class=\"pl-k\">.</span>isPresent()) {\n\t\t\t<span class=\"pl-k\">return</span> <span class=\"pl-k\">!</span>theModelConfig<span class=\"pl-k\">.</span>isSuppressStringIndexingInTokens();\n\t\t<span class=\"pl-c\"><span class=\"pl-c\">//</span>If the SP does care, use its value.</span>\n\t\t} <span class=\"pl-k\">else</span> {\n\t\t\t<span class=\"pl-k\">boolean</span> suppressForSearchParam <span class=\"pl-k\">=</span> oSuppressForSearchParam<span class=\"pl-k\">.</span>get();\n\t\tourLog<span class=\"pl-k\">.</span>trace(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{} text indexing for SearchParameter {}<span class=\"pl-pds\">\"</span></span>, suppressForSearchParam<span class=\"pl-k\">?</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Suppressing<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">:</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Not Suppressing<span class=\"pl-pds\">\"</span></span>, theSearchParam<span class=\"pl-k\">.</span>getName());\n\t\t<span class=\"pl-k\">return</span> <span class=\"pl-k\">!</span>suppressForSearchParam;\n\t\t}\n\t}</pre></div>", "author": "tadgh", "createdAt": "2020-05-05T14:55:12Z", "path": "hapi-fhir-jpaserver-searchparam/src/main/java/ca/uhn/fhir/jpa/searchparam/extractor/BaseSearchParamExtractor.java", "diffHunk": "@@ -1112,6 +1128,32 @@ public void extract(SearchParamSet<BaseResourceIndexedSearchParam> params, Runti\n \t\t}\n \t}\n \n+\tpublic static boolean tokenTextIndexingEnabledForSearchParam(ModelConfig theModelConfig, RuntimeSearchParam theSearchParam) {\n+\t\tBoolean suppressViaSearchParam = null;\n+\t\tList<IBaseExtension<?, ?>> suppressExt = theSearchParam.getExtensions(JpaConstants.EXT_SEARCHPARAM_TOKEN_SUPPRESS_TEXT_INDEXING);\n+\t\tif (suppressExt.size() > 0) {\n+\t\t\tIPrimitiveType<?> value = (IPrimitiveType<?>) suppressExt.get(0).getValue();\n+\t\t\tif (\"true\".equals(value.getValueAsString())) {\n+\t\t\t\tourLog.trace(\"Suppressing text indexing for SearchParameter {}\", theSearchParam.getName());\n+\t\t\t\tsuppressViaSearchParam = true;\n+\t\t\t} else if (\"false\".equals(value.getValueAsString())) {\n+\t\t\t\tourLog.trace(\"Not suppressing text indexing for SearchParameter {}\", theSearchParam.getName());\n+\t\t\t\tsuppressViaSearchParam = false;\n+\t\t\t}\n+\t\t}\n+\n+\t\tif (theModelConfig.isSuppressStringIndexingInTokens()) {\n+\t\t\tif (!Boolean.FALSE.equals(suppressViaSearchParam))\n+\t\t\t\treturn false;\n+\t\t}", "originalCommit": "190cac2b1c3971c7c9f0259f7a99b808a8d7fee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "717cc92603bccb7b71d8139a133a9d4e25a4c3fc", "url": "https://github.com/hapifhir/hapi-fhir/commit/717cc92603bccb7b71d8139a133a9d4e25a4c3fc", "message": "Address review comment", "committedDate": "2020-05-05T15:15:20Z", "type": "commit"}, {"oid": "a265691afb7d2b6dc8de30f6df645a11e440978f", "url": "https://github.com/hapifhir/hapi-fhir/commit/a265691afb7d2b6dc8de30f6df645a11e440978f", "message": "Merge branch 'master' into ja_20200505_disable_text_modifier", "committedDate": "2020-05-05T15:18:04Z", "type": "commit"}, {"oid": "4e004834c63094baa5844ce36b513471253d9db3", "url": "https://github.com/hapifhir/hapi-fhir/commit/4e004834c63094baa5844ce36b513471253d9db3", "message": "Resolve merge conflicts", "committedDate": "2020-05-05T15:29:24Z", "type": "commit"}]}