{"pr_number": 6930, "pr_title": "Support for custom user data", "pr_author": "rorbech", "pr_createdAt": "2020-06-08T10:17:36Z", "pr_url": "https://github.com/realm/realm-java/pull/6930", "timeline": [{"oid": "5245f4f1c095b11176f8a7e9e5c5ade3c3dd911f", "url": "https://github.com/realm/realm-java/commit/5245f4f1c095b11176f8a7e9e5c5ade3c3dd911f", "message": "Support for custom user data", "committedDate": "2020-06-08T10:14:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxMjUyMg==", "url": "https://github.com/realm/realm-java/pull/6930#discussion_r436612522", "body": "Looks like we also need to expose `refreshCustomData()`:  https://github.com/realm/realm-object-store/blob/v10/src/sync/app.hpp#L238 ... and since that is a network request, it should probably be:\r\n\r\n```\r\npublic Document getCustomData()\r\npublic Document refreshCustomData()\r\npublic RealmAsyncTask refreshCustomData(Result<Document> callback)\r\n```", "bodyText": "Looks like we also need to expose refreshCustomData():  https://github.com/realm/realm-object-store/blob/v10/src/sync/app.hpp#L238 ... and since that is a network request, it should probably be:\npublic Document getCustomData()\npublic Document refreshCustomData()\npublic RealmAsyncTask refreshCustomData(Result<Document> callback)", "bodyHTML": "<p dir=\"auto\">Looks like we also need to expose <code>refreshCustomData()</code>:  <a href=\"https://github.com/realm/realm-object-store/blob/v10/src/sync/app.hpp#L238\">https://github.com/realm/realm-object-store/blob/v10/src/sync/app.hpp#L238</a> ... and since that is a network request, it should probably be:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"public Document getCustomData()\npublic Document refreshCustomData()\npublic RealmAsyncTask refreshCustomData(Result&lt;Document&gt; callback)\n\"><pre><code>public Document getCustomData()\npublic Document refreshCustomData()\npublic RealmAsyncTask refreshCustomData(Result&lt;Document&gt; callback)\n</code></pre></div>", "author": "cmelchior", "createdAt": "2020-06-08T10:55:33Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/User.java", "diffHunk": "@@ -280,6 +282,18 @@ public State getState() {\n         throw new IllegalStateException(\"Unknown state: \" + nativeState);\n     }\n \n+    /**\n+     * Return the custom user data associated with the user in the Realm App.\n+     * <p>\n+     * The data is only refreshed when the user's access token is refreshed.\n+     *\n+     * @return The custom user data associated with the user.\n+     */\n+    public Document getCustomData() {", "originalCommit": "5245f4f1c095b11176f8a7e9e5c5ade3c3dd911f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYyODM5MA==", "url": "https://github.com/realm/realm-java/pull/6930#discussion_r436628390", "bodyText": "Will do. Should the native part of all these methods actually be on OsUser instead and what are the rationale for doing one over the other?", "author": "rorbech", "createdAt": "2020-06-08T11:30:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxMjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzMDI0OA==", "url": "https://github.com/realm/realm-java/pull/6930#discussion_r436630248", "bodyText": "So far we are using OsUser for all API's found on sync_user.hpp in ObjectStore.  refresh_custom_data is there as well, so should probably be there.\nThe primary reason for the split is that the Os<X> normally implements the NativeObject interface which we don't want in the public API, but it also allows us greater design flexibility in terms of how we expose the OS API.\nIt does have the downside there many methods are just \"pass-through\" though.", "author": "cmelchior", "createdAt": "2020-06-08T11:35:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxMjUyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcwNzMwMA==", "url": "https://github.com/realm/realm-java/pull/6930#discussion_r438707300", "bodyText": "Moved direct OS wrappers to OsSyncUser and kept the additional logic (returning user custom data after actual refresh) in User.", "author": "rorbech", "createdAt": "2020-06-11T11:04:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxMjUyMg=="}], "type": "inlineReview"}, {"oid": "5da855052377e5a13575b98535b8018283a677a7", "url": "https://github.com/realm/realm-java/commit/5da855052377e5a13575b98535b8018283a677a7", "message": "Support for custom user data refresh", "committedDate": "2020-06-09T08:50:46Z", "type": "commit"}, {"oid": "0f4bb64f980e2990b7046eb8023b4b869576673b", "url": "https://github.com/realm/realm-java/commit/0f4bb64f980e2990b7046eb8023b4b869576673b", "message": "Trying to rework import to avoid stale service references", "committedDate": "2020-06-09T09:07:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEwMDU3MQ==", "url": "https://github.com/realm/realm-java/pull/6930#discussion_r438100571", "body": "```suggestion\r\n     * calling {@link #refreshCustomData()}.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * {@link #refreshCustomData() refreshed}.\n          \n          \n            \n                 * calling {@link #refreshCustomData()}.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> {<span class=\"pl-k\">@link</span> #refreshCustomData()<span class=\"x x-first x-last\"> refreshed</span>}<span class=\"pl-c1\">.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"x x-first x-last\">calling </span>{<span class=\"pl-k\">@link</span> #refreshCustomData()}<span class=\"pl-c1\">.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cmelchior", "createdAt": "2020-06-10T12:58:02Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/User.java", "diffHunk": "@@ -280,6 +282,51 @@ public State getState() {\n         throw new IllegalStateException(\"Unknown state: \" + nativeState);\n     }\n \n+    /**\n+     * Return the custom user data associated with the user in the Realm App.\n+     * <p>\n+     * The data is only refreshed when the user's access token is refreshed or when explicitly\n+     * {@link #refreshCustomData() refreshed}.", "originalCommit": "0f4bb64f980e2990b7046eb8023b4b869576673b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEwMDc4Mg==", "url": "https://github.com/realm/realm-java/pull/6930#discussion_r438100782", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">     </span><span class=\"pl-k x x-last\">*</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cmelchior", "createdAt": "2020-06-10T12:58:21Z", "path": "realm/realm-library/src/objectServer/java/io/realm/mongodb/User.java", "diffHunk": "@@ -280,6 +282,51 @@ public State getState() {\n         throw new IllegalStateException(\"Unknown state: \" + nativeState);\n     }\n \n+    /**\n+     * Return the custom user data associated with the user in the Realm App.\n+     * <p>\n+     * The data is only refreshed when the user's access token is refreshed or when explicitly\n+     * {@link #refreshCustomData() refreshed}.\n+     *\n+     * @return The custom user data associated with the user.\n+     */\n+    public Document getCustomData() {\n+        return osUser.getCustomData();\n+    }\n+\n+    /**\n+     * Re-fetch custom user data from the Realm App.\n+     *\n+     * @return The updated custom user data associated with the user.\n+     *", "originalCommit": "0f4bb64f980e2990b7046eb8023b4b869576673b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "65c102a46ead0c54b03387032964c2fee312dc29", "url": "https://github.com/realm/realm-java/commit/65c102a46ead0c54b03387032964c2fee312dc29", "message": "Revert \"Trying to rework import to avoid stale service references\"\n\nThis reverts commit 0f4bb64f980e2990b7046eb8023b4b869576673b.", "committedDate": "2020-06-11T09:27:42Z", "type": "commit"}, {"oid": "ed4e1ddffc04a2395e6ef9e8da117db4c31bd2f8", "url": "https://github.com/realm/realm-java/commit/ed4e1ddffc04a2395e6ef9e8da117db4c31bd2f8", "message": "Merge branch 'v10' into cr/custom-user-data", "committedDate": "2020-06-11T09:29:45Z", "type": "commit"}, {"oid": "f034892edeb3c486ff800a4d42ff9ab3c7e8d39b", "url": "https://github.com/realm/realm-java/commit/f034892edeb3c486ff800a4d42ff9ab3c7e8d39b", "message": "Updates according to code review", "committedDate": "2020-06-11T09:30:10Z", "type": "commit"}, {"oid": "24f5abaa9b86ef1b399ac19de6dfb57bc61d0163", "url": "https://github.com/realm/realm-java/commit/24f5abaa9b86ef1b399ac19de6dfb57bc61d0163", "message": "Ignore tests that was not possible to automate", "committedDate": "2020-06-11T09:38:01Z", "type": "commit"}, {"oid": "59d840ebfac3782f3318cb2e7b002373120694d9", "url": "https://github.com/realm/realm-java/commit/59d840ebfac3782f3318cb2e7b002373120694d9", "message": "Apply suggestions from code review\n\nCo-authored-by: Christian Melchior <christian@ilios.dk>", "committedDate": "2020-06-11T10:03:12Z", "type": "commit"}, {"oid": "f54fb26535b047eea031ac388304f4c990c3071f", "url": "https://github.com/realm/realm-java/commit/f54fb26535b047eea031ac388304f4c990c3071f", "message": "Apply comments from code review", "committedDate": "2020-06-11T10:26:23Z", "type": "commit"}]}