{"pr_number": 404, "pr_title": "XRDDEV-900 API for uploading backup files", "pr_author": "petkivim", "pr_createdAt": "2020-03-05T10:47:26Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/404", "timeline": [{"oid": "d2a29599e847b6c5b2de2f17a7768ef22454b657", "url": "https://github.com/nordic-institute/X-Road/commit/d2a29599e847b6c5b2de2f17a7768ef22454b657", "message": "XRDDEV-900 API for uploading backup files\n\n- Implement API for uploading backup files.\n- Update API design.\n- Add unit tests.", "committedDate": "2020-03-05T10:46:09Z", "type": "commit"}, {"oid": "3b732ced32cf4b153d55b54e990bb5ed70cf7555", "url": "https://github.com/nordic-institute/X-Road/commit/3b732ced32cf4b153d55b54e990bb5ed70cf7555", "message": "XRDDEV-900 Updates based on SonarQube findings", "committedDate": "2020-03-05T11:47:04Z", "type": "commit"}, {"oid": "b495cb73ed75a03068b41f62dcd77a156513e6d2", "url": "https://github.com/nordic-institute/X-Road/commit/b495cb73ed75a03068b41f62dcd77a156513e6d2", "message": "XRDDEV-900 Updates based on SonarQube findings", "committedDate": "2020-03-05T13:02:32Z", "type": "commit"}, {"oid": "01301c0391dff8ee074f49dcb4e2644af08702c1", "url": "https://github.com/nordic-institute/X-Road/commit/01301c0391dff8ee074f49dcb4e2644af08702c1", "message": "XRDDEV-900 Update error handling when backup file already exists\n\n- Refactor implementation to use existing warnings mechanism.\n- Update unit tests.", "committedDate": "2020-03-07T06:42:54Z", "type": "commit"}, {"oid": "d8df001249c7e51d2e090cfcf6f8990ebdfba994", "url": "https://github.com/nordic-institute/X-Road/commit/d8df001249c7e51d2e090cfcf6f8990ebdfba994", "message": "Merge branch 'develop' into XRDDEV-900", "committedDate": "2020-03-12T03:29:22Z", "type": "commit"}, {"oid": "ad516931b117411202ee569441477df7dce6ed4b", "url": "https://github.com/nordic-institute/X-Road/commit/ad516931b117411202ee569441477df7dce6ed4b", "message": "Merge branch 'develop' into XRDDEV-900", "committedDate": "2020-03-13T05:38:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI1NDQwNA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396254404", "body": "`InvalidFilenameException` and `InvalidBackupFileException` seem to have their metadata fields populated in the service layer ([here](https://github.com/nordic-institute/X-Road/pull/404/files#diff-6b4897243505098cf700077dcb2237b6R175) and [here](https://github.com/nordic-institute/X-Road/pull/404/files#diff-6b4897243505098cf700077dcb2237b6R185)) but they are overridden in the controller method by setting a new `ErrorDeviation` without metadata. The `ErrorDeviation` (errorCode) will actually already be set to the response without passing it to the `BadRequestException` separately. Meaning that all of these catch clauses could be collapsed into a single block:\r\n```java\r\n} catch (InvalidFilenameException | UnhandledWarningsException | InvalidBackupFileException e) {\r\n    throw new BadRequestException(e);\r\n}\r\n```\r\n\r\nThe metadata shown to the end user in this case is a string `\"uploading backup file failed because of invalid filename (\"+ filename + \")\"`. Is this metadata supposed to be shown to the end user or is it only meant for logging purposes? If it is only meant for logging purposes then [this constructor](https://github.com/nordic-institute/X-Road/pull/404/files#diff-e06b4c0b1e20a5eedd3a9c4011395c18R33) should be changed to \r\n```java\r\nsuper(msg, new ErrorDeviation(ERROR_INVALID_FILENAME));\r\n```\r\nand same for the `InvalidBackupFileException` constructor also", "bodyText": "InvalidFilenameException and InvalidBackupFileException seem to have their metadata fields populated in the service layer (here and here) but they are overridden in the controller method by setting a new ErrorDeviation without metadata. The ErrorDeviation (errorCode) will actually already be set to the response without passing it to the BadRequestException separately. Meaning that all of these catch clauses could be collapsed into a single block:\n} catch (InvalidFilenameException | UnhandledWarningsException | InvalidBackupFileException e) {\n    throw new BadRequestException(e);\n}\nThe metadata shown to the end user in this case is a string \"uploading backup file failed because of invalid filename (\"+ filename + \")\". Is this metadata supposed to be shown to the end user or is it only meant for logging purposes? If it is only meant for logging purposes then this constructor should be changed to\nsuper(msg, new ErrorDeviation(ERROR_INVALID_FILENAME));\nand same for the InvalidBackupFileException constructor also", "bodyHTML": "<p dir=\"auto\"><code>InvalidFilenameException</code> and <code>InvalidBackupFileException</code> seem to have their metadata fields populated in the service layer (<a href=\"https://github.com/nordic-institute/X-Road/pull/404/files#diff-6b4897243505098cf700077dcb2237b6R175\">here</a> and <a href=\"https://github.com/nordic-institute/X-Road/pull/404/files#diff-6b4897243505098cf700077dcb2237b6R185\">here</a>) but they are overridden in the controller method by setting a new <code>ErrorDeviation</code> without metadata. The <code>ErrorDeviation</code> (errorCode) will actually already be set to the response without passing it to the <code>BadRequestException</code> separately. Meaning that all of these catch clauses could be collapsed into a single block:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"} catch (InvalidFilenameException | UnhandledWarningsException | InvalidBackupFileException e) {\n    throw new BadRequestException(e);\n}\"><pre>} <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">InvalidFilenameException</span> <span class=\"pl-k\">|</span> <span class=\"pl-smi\">UnhandledWarningsException</span> <span class=\"pl-k\">|</span> <span class=\"pl-smi\">InvalidBackupFileException</span> e) {\n    <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">BadRequestException</span>(e);\n}</pre></div>\n<p dir=\"auto\">The metadata shown to the end user in this case is a string <code>\"uploading backup file failed because of invalid filename (\"+ filename + \")\"</code>. Is this metadata supposed to be shown to the end user or is it only meant for logging purposes? If it is only meant for logging purposes then <a href=\"https://github.com/nordic-institute/X-Road/pull/404/files#diff-e06b4c0b1e20a5eedd3a9c4011395c18R33\">this constructor</a> should be changed to</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"super(msg, new ErrorDeviation(ERROR_INVALID_FILENAME));\"><pre><span class=\"pl-c1\">super</span>(msg, <span class=\"pl-k\">new</span> <span class=\"pl-smi\">ErrorDeviation</span>(<span class=\"pl-c1\">ERROR_INVALID_FILENAME</span>));</pre></div>\n<p dir=\"auto\">and same for the <code>InvalidBackupFileException</code> constructor also</p>", "author": "carohauta", "createdAt": "2020-03-23T07:33:26Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/BackupsApiController.java", "diffHunk": "@@ -103,4 +108,19 @@ public BackupsApiController(BackupService backupService, BackupConverter backupC\n             throw new InternalServerErrorException(new ErrorDeviation(GENERATE_BACKUP_INTERRUPTED));\n         }\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('BACKUP_CONFIGURATION')\")\n+    public ResponseEntity<Backup> uploadBackup(Boolean ignoreWarnings, MultipartFile file) {\n+        try {\n+            BackupFile backupFile = backupService.uploadBackup(ignoreWarnings, file);\n+            return new ResponseEntity<>(backupConverter.convert(backupFile), HttpStatus.CREATED);\n+        } catch (InvalidFilenameException e) {\n+            throw new BadRequestException(e, new ErrorDeviation(ERROR_INVALID_FILENAME));\n+        } catch (UnhandledWarningsException e) {\n+            throw new BadRequestException(e);\n+        } catch (InvalidBackupFileException e) {\n+            throw new BadRequestException(e, new ErrorDeviation(ERROR_INVALID_BACKUP_FILE));", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MTYzOA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396581638", "bodyText": "The metadata is meant for logging purposes only. Updated the exceptions according to the suggestions.", "author": "petkivim", "createdAt": "2020-03-23T16:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI1NDQwNA=="}], "type": "inlineReview", "revised_code": {"commit": "9080061c793c99bb3372d6eaea237f2300a9a32c", "changed_code": [{"header": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/BackupsApiController.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/BackupsApiController.java\nindex aac9da0a9..dcaee6f07 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/BackupsApiController.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/BackupsApiController.java\n", "chunk": "@@ -113,14 +112,13 @@ public class BackupsApiController implements BackupsApi {\n     @PreAuthorize(\"hasAuthority('BACKUP_CONFIGURATION')\")\n     public ResponseEntity<Backup> uploadBackup(Boolean ignoreWarnings, MultipartFile file) {\n         try {\n-            BackupFile backupFile = backupService.uploadBackup(ignoreWarnings, file);\n+            BackupFile backupFile = backupService.uploadBackup(ignoreWarnings, file.getOriginalFilename(),\n+                    file.getBytes());\n             return new ResponseEntity<>(backupConverter.convert(backupFile), HttpStatus.CREATED);\n-        } catch (InvalidFilenameException e) {\n-            throw new BadRequestException(e, new ErrorDeviation(ERROR_INVALID_FILENAME));\n-        } catch (UnhandledWarningsException e) {\n+        } catch (InvalidFilenameException | UnhandledWarningsException | InvalidBackupFileException e) {\n             throw new BadRequestException(e);\n-        } catch (InvalidBackupFileException e) {\n-            throw new BadRequestException(e, new ErrorDeviation(ERROR_INVALID_BACKUP_FILE));\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n         }\n     }\n }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396265531", "body": "I'm not sure if this sort of validation should actually exist in the repository layer which should be all about transactions and CRUD operations (also documented [here](https://confluence.niis.org/display/XRDDEV/API+backend+implementation)). The `isFilenameValid` method would probably be a better fit in an already existing utility class such as `FormatUtils` or in the `BackupService` class.", "bodyText": "I'm not sure if this sort of validation should actually exist in the repository layer which should be all about transactions and CRUD operations (also documented here). The isFilenameValid method would probably be a better fit in an already existing utility class such as FormatUtils or in the BackupService class.", "bodyHTML": "<p dir=\"auto\">I'm not sure if this sort of validation should actually exist in the repository layer which should be all about transactions and CRUD operations (also documented <a href=\"https://confluence.niis.org/display/XRDDEV/API+backend+implementation\" rel=\"nofollow\">here</a>). The <code>isFilenameValid</code> method would probably be a better fit in an already existing utility class such as <code>FormatUtils</code> or in the <code>BackupService</code> class.</p>", "author": "carohauta", "createdAt": "2020-03-23T08:01:08Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java", "diffHunk": "@@ -51,7 +51,7 @@\n \n     private static final String CONFIGURATION_BACKUP_PATH = SystemProperties.getConfBackupPath();\n     // Criteria for valid backup file names:\n-    // 1) cannot start with \".\", 2) must contain one or more word characters ([a-zA-Z_0-9]), 3) must end with \".tar\"\n+    // 1) cannot start with \".\", 2) must contain one or more word characters ([a-zA-Z_0-9.-]), 3) must end with \".tar\"\n     private static final String BACKUP_FILENAME_PATTERN = \"^(?!\\\\.)[\\\\w\\\\.\\\\-]+\\\\.tar$\";", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4NjAxNw==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396586017", "bodyText": "I would leave the validation in the repository layer for security reasons. In case the repository layer is accessed from multiple classes, each class must implement its own validation. When the validation is implemented on the repository layer, the validation is always guaranteed and it's done using the same rules. Since the filename comes from the client, it's extremely important that it's validated properly before it's used.", "author": "petkivim", "createdAt": "2020-03-23T16:30:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkyNzUzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396927531", "bodyText": "Happened to see this in the github stream and got curious, so had a look. My two cents:\n\nvalidation should in general follow the layer design @carohauta linked - one reason is, that we should follow principle of least astonishment and not confuse maintainers.\nif there is a special case, where we are concerned of security, and are afraid that someone will add a service method that forgets the validation, I think that is a valid reason to have the validation also on repository layer. But I think it should not be missing from service layer. I was happy to see it is not!\nOf course, if we are scared of someone adding a new service method and forgetting validation, we should be scared of someone adding a new repository method and forgetting validation, too. Putting the validation on repository layer is not bulletproof (but maybe it is safer than service layer since repository layer has less modifications typically)\nI like @carohauta 's suggestion of putting the validation logic into somewhere else than the repository. I would still keep both validation checks (service and repository), just move the actual logic elsewhere. It would make the repository class a bit more consistent with other repository classes in what kind of logic it contains.\nrepository level validation (if there is any, we should try to keep it limited) should be considered as a safety net like a database constraint is. Failing validation should be comparable to a programming error and can just throw some dirty RuntimeException, result in http 500, not care about nice error messages etc.", "author": "jansu76", "createdAt": "2020-03-24T06:34:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk1OTYwOQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396959609", "bodyText": "Based on the comments, the validation logic is now moved to FormatUtils class, and both BackupRepository and BackupService use it from there. In addition, filename validation was added to all the methods in the repository class that read, create or delete backup files.", "author": "petkivim", "createdAt": "2020-03-24T07:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI2NTUzMQ=="}], "type": "inlineReview", "revised_code": {"commit": "9c8f0dc17338e50e1c52e289a80fbf26f002f9e6", "changed_code": [{"header": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\nindex 546e02ac3..383b7a321 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\n", "chunk": "@@ -50,9 +50,6 @@ import java.util.stream.Stream;\n public class BackupRepository {\n \n     private static final String CONFIGURATION_BACKUP_PATH = SystemProperties.getConfBackupPath();\n-    // Criteria for valid backup file names:\n-    // 1) cannot start with \".\", 2) must contain one or more word characters ([a-zA-Z_0-9.-]), 3) must end with \".tar\"\n-    private static final String BACKUP_FILENAME_PATTERN = \"^(?!\\\\.)[\\\\w\\\\.\\\\-]+\\\\.tar$\";\n     // Set maximum number of levels of directories to visit, subdirectories are excluded\n     private static final int DIR_MAX_DEPTH = 1;\n \n", "next_change": {"commit": "2e7b3a9a7464b48075739c04312c9f3c5eb3b4f4", "changed_code": [{"header": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\nindex 383b7a321..aa15679dd 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\n", "chunk": "@@ -52,6 +52,7 @@ public class BackupRepository {\n     private static final String CONFIGURATION_BACKUP_PATH = SystemProperties.getConfBackupPath();\n     // Set maximum number of levels of directories to visit, subdirectories are excluded\n     private static final int DIR_MAX_DEPTH = 1;\n+    private static final String INVALID_BACKUP_FILENAME = \"invalid backup filename\";\n \n     /**\n      * Read backup files from configuration backup path\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5ODQ1OA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396298458", "body": "This method could take `String fileName` and `byte[] fileBytes` as parameters instead of a `MultipartFile`. I think that would create better separation between the controller and service layer and make this method more universal. What do you think?", "bodyText": "This method could take String fileName and byte[] fileBytes as parameters instead of a MultipartFile. I think that would create better separation between the controller and service layer and make this method more universal. What do you think?", "bodyHTML": "<p dir=\"auto\">This method could take <code>String fileName</code> and <code>byte[] fileBytes</code> as parameters instead of a <code>MultipartFile</code>. I think that would create better separation between the controller and service layer and make this method more universal. What do you think?</p>", "author": "carohauta", "createdAt": "2020-03-23T09:03:42Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java", "diffHunk": "@@ -147,6 +155,44 @@ public BackupFile generateBackup() throws InterruptedException {\n         return backupFile.get();\n     }\n \n+    /**\n+     * Write uploaded backup file to disk. If ignoreWarnings=false, an exception is thrown when a file with\n+     * the same name already exists. If ignoreWarnings=true, the existing file is overwritten.\n+     * @param ignoreWarnings\n+     * @param file\n+     * @return\n+     * @throws InvalidFilenameException if backup file's name is invalid and does not pass validation\n+     * @throws UnhandledWarningsException if backup file with the same name already exists\n+     * and ignoreWarnings is false\n+     * @throws InvalidBackupFileException if backup file is not a valid tar file or the first entry of the tar file\n+     * does not match to the first entry if the Security Server generated backup tar files\n+     */\n+    public BackupFile uploadBackup(Boolean ignoreWarnings, MultipartFile file)", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MjUxNw==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396582517", "bodyText": "Passing String fileName and byte[] fileBytes as parameters instead of MultipartFile is a good idea. Updated the implementation.", "author": "petkivim", "createdAt": "2020-03-23T16:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5ODQ1OA=="}], "type": "inlineReview", "revised_code": {"commit": "9080061c793c99bb3372d6eaea237f2300a9a32c", "changed_code": [{"header": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\nindex 9977087a0..857f11fa0 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\n", "chunk": "@@ -159,7 +158,8 @@ public class BackupService {\n      * Write uploaded backup file to disk. If ignoreWarnings=false, an exception is thrown when a file with\n      * the same name already exists. If ignoreWarnings=true, the existing file is overwritten.\n      * @param ignoreWarnings\n-     * @param file\n+     * @param filename\n+     * @param fileBytes\n      * @return\n      * @throws InvalidFilenameException if backup file's name is invalid and does not pass validation\n      * @throws UnhandledWarningsException if backup file with the same name already exists\n", "next_change": null}, {"header": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\nindex 9977087a0..857f11fa0 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\n", "chunk": "@@ -167,10 +167,8 @@ public class BackupService {\n      * @throws InvalidBackupFileException if backup file is not a valid tar file or the first entry of the tar file\n      * does not match to the first entry if the Security Server generated backup tar files\n      */\n-    public BackupFile uploadBackup(Boolean ignoreWarnings, MultipartFile file)\n+    public BackupFile uploadBackup(Boolean ignoreWarnings, String filename, byte[] fileBytes)\n             throws InvalidFilenameException, UnhandledWarningsException, InvalidBackupFileException {\n-        String filename = file.getOriginalFilename();\n-\n         if (!backupRepository.isFilenameValid(filename)) {\n             throw new InvalidFilenameException(\"uploading backup file failed because of invalid filename (\"\n                     + filename + \")\");\n", "next_change": {"commit": "9c8f0dc17338e50e1c52e289a80fbf26f002f9e6", "changed_code": [{"header": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\nindex 857f11fa0..e634d3e39 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/BackupService.java\n", "chunk": "@@ -169,7 +170,7 @@ public class BackupService {\n      */\n     public BackupFile uploadBackup(Boolean ignoreWarnings, String filename, byte[] fileBytes)\n             throws InvalidFilenameException, UnhandledWarningsException, InvalidBackupFileException {\n-        if (!backupRepository.isFilenameValid(filename)) {\n+        if (!FormatUtils.isValidBackupFilename(filename)) {\n             throw new InvalidFilenameException(\"uploading backup file failed because of invalid filename (\"\n                     + filename + \")\");\n         }\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwMTc4NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396301785", "body": "Could also assert the warning here", "bodyText": "Could also assert the warning here", "bodyHTML": "<p dir=\"auto\">Could also assert the warning here</p>", "author": "carohauta", "createdAt": "2020-03-23T09:09:48Z", "path": "src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/BackupServiceTest.java", "diffHunk": "@@ -180,4 +190,84 @@ public void addBackupFails() throws ProcessNotExecutableException, ProcessFailed\n             // success\n         }\n     }\n+\n+    @Test\n+    public void uploadBackup() throws UnhandledWarningsException, InvalidBackupFileException, IOException,\n+            InvalidFilenameException {\n+        MultipartFile multipartFile = createMultipartFileWithTar(BACKUP_FILE_1_NAME, VALID_TAR_LABEL);\n+\n+        when(backupRepository.isFilenameValid(BACKUP_FILE_1_NAME)).thenReturn(true);\n+        when(backupRepository.fileExists(BACKUP_FILE_1_NAME)).thenReturn(false);\n+        when(backupRepository.writeBackupFile(BACKUP_FILE_1_NAME, multipartFile.getBytes())).thenReturn(\n+                new Date(BACKUP_FILE_1_CREATED_AT_MILLIS).toInstant().atOffset(ZoneOffset.UTC));\n+\n+        BackupFile backupFile = backupService.uploadBackup(true, multipartFile);\n+\n+        assertEquals(BACKUP_FILE_1_NAME, backupFile.getFilename());\n+        assertEquals(BACKUP_FILE_1_CREATED_AT, backupFile.getCreatedAt().toString());\n+    }\n+\n+    @Test\n+    public void uploadBackupInvalidTarLabel() throws UnhandledWarningsException, IOException,\n+            InvalidFilenameException {\n+        MultipartFile multipartFile = createMultipartFileWithTar(BACKUP_FILE_1_NAME, \"invalid_label\");\n+\n+        when(backupRepository.isFilenameValid(BACKUP_FILE_1_NAME)).thenReturn(true);\n+        when(backupRepository.fileExists(BACKUP_FILE_1_NAME)).thenReturn(false);\n+\n+        try {\n+            backupService.uploadBackup(true, multipartFile);\n+            fail(\"should throw InvalidBackupFileException\");\n+        } catch (InvalidBackupFileException expected) {\n+            // success\n+        }\n+    }\n+\n+    @Test\n+    public void uploadBackupWithInvalidFilename() throws UnhandledWarningsException, InvalidBackupFileException {\n+        try {\n+            backupService.uploadBackup(true, mockMultipartFile);\n+            fail(\"should throw InvalidFilenameException\");\n+        } catch (InvalidFilenameException expected) {\n+            // success\n+        }\n+    }\n+\n+    @Test\n+    public void uploadBackupFileAlreadyExistsNoOverwrite() throws InvalidFilenameException,\n+            InvalidBackupFileException {\n+        when(backupRepository.isFilenameValid(any(String.class))).thenReturn(true);\n+        when(backupRepository.fileExists(any(String.class))).thenReturn(true);\n+        try {\n+            backupService.uploadBackup(false, mockMultipartFile);\n+            fail(\"should throw UnhandledWarningsException\");\n+        } catch (UnhandledWarningsException expected) {\n+            // success", "originalCommit": "ad516931b117411202ee569441477df7dce6ed4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU4MjgwNQ==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r396582805", "bodyText": "Fixed.", "author": "petkivim", "createdAt": "2020-03-23T16:26:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMwMTc4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "9080061c793c99bb3372d6eaea237f2300a9a32c", "changed_code": [{"header": "diff --git a/src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/BackupServiceTest.java b/src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/BackupServiceTest.java\nindex a04a3de5a..ce6631516 100644\n--- a/src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/BackupServiceTest.java\n+++ b/src/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/BackupServiceTest.java\n", "chunk": "@@ -216,52 +223,57 @@ public class BackupServiceTest {\n         when(backupRepository.fileExists(BACKUP_FILE_1_NAME)).thenReturn(false);\n \n         try {\n-            backupService.uploadBackup(true, multipartFile);\n+            backupService.uploadBackup(true, multipartFile.getOriginalFilename(),\n+                    multipartFile.getBytes());\n             fail(\"should throw InvalidBackupFileException\");\n         } catch (InvalidBackupFileException expected) {\n-            // success\n+            assertEquals(ERROR_INVALID_BACKUP_FILE, expected.getErrorDeviation().getCode());\n         }\n     }\n \n     @Test\n-    public void uploadBackupWithInvalidFilename() throws UnhandledWarningsException, InvalidBackupFileException {\n+    public void uploadBackupWithInvalidFilename() throws UnhandledWarningsException, InvalidBackupFileException,\n+            IOException {\n         try {\n-            backupService.uploadBackup(true, mockMultipartFile);\n+            backupService.uploadBackup(true, mockMultipartFile.getOriginalFilename(),\n+                    mockMultipartFile.getBytes());\n             fail(\"should throw InvalidFilenameException\");\n         } catch (InvalidFilenameException expected) {\n-            // success\n+            assertEquals(ERROR_INVALID_FILENAME, expected.getErrorDeviation().getCode());\n         }\n     }\n \n     @Test\n     public void uploadBackupFileAlreadyExistsNoOverwrite() throws InvalidFilenameException,\n-            InvalidBackupFileException {\n+            InvalidBackupFileException, IOException {\n         when(backupRepository.isFilenameValid(any(String.class))).thenReturn(true);\n         when(backupRepository.fileExists(any(String.class))).thenReturn(true);\n         try {\n-            backupService.uploadBackup(false, mockMultipartFile);\n+            backupService.uploadBackup(false, mockMultipartFile.getOriginalFilename(),\n+                    mockMultipartFile.getBytes());\n             fail(\"should throw UnhandledWarningsException\");\n         } catch (UnhandledWarningsException expected) {\n-            // success\n+            assertEquals(WARNING_FILE_ALREADY_EXISTS, expected.getWarningDeviations().iterator().next().getCode());\n         }\n     }\n \n     @Test\n     public void uploadBackupFileInvalidBackupFileOverwriteExisting() throws InvalidFilenameException,\n-            UnhandledWarningsException {\n+            UnhandledWarningsException, IOException {\n         when(backupRepository.isFilenameValid(any(String.class))).thenReturn(true);\n         when(backupRepository.fileExists(any(String.class))).thenReturn(true);\n         try {\n-            backupService.uploadBackup(true, mockMultipartFile);\n+            backupService.uploadBackup(true, mockMultipartFile.getOriginalFilename(),\n+                    mockMultipartFile.getBytes());\n             fail(\"should throw InvalidBackupFileException\");\n         } catch (InvalidBackupFileException expected) {\n-            // success\n+            assertEquals(ERROR_INVALID_BACKUP_FILE, expected.getErrorDeviation().getCode());\n         }\n     }\n \n     private MultipartFile createMultipartFileWithTar(String filename, String tarLabel) throws IOException {\n         try (ByteArrayOutputStream baos = new ByteArrayOutputStream();\n-            TarArchiveOutputStream taos = new TarArchiveOutputStream(baos)) {\n+                TarArchiveOutputStream taos = new TarArchiveOutputStream(baos)) {\n             TarArchiveEntry tarEntry = new TarArchiveEntry(tarLabel);\n \n             taos.putArchiveEntry(tarEntry);\n", "next_change": null}]}}, {"oid": "9080061c793c99bb3372d6eaea237f2300a9a32c", "url": "https://github.com/nordic-institute/X-Road/commit/9080061c793c99bb3372d6eaea237f2300a9a32c", "message": "XRDDEV-900 Minor changes based on review comments", "committedDate": "2020-03-23T15:51:22Z", "type": "commit"}, {"oid": "3d637b707b5790111a490508b8f33d16e805953a", "url": "https://github.com/nordic-institute/X-Road/commit/3d637b707b5790111a490508b8f33d16e805953a", "message": "Merge branch 'develop' into XRDDEV-900", "committedDate": "2020-03-23T16:23:13Z", "type": "commit"}, {"oid": "9c8f0dc17338e50e1c52e289a80fbf26f002f9e6", "url": "https://github.com/nordic-institute/X-Road/commit/9c8f0dc17338e50e1c52e289a80fbf26f002f9e6", "message": "XRDDEV-900 Refactor backup filename validation\n\n- Move filename validation logic from repository class to utils class.\n- Add filename validation to all repository methods that read, create or delete backup files.", "committedDate": "2020-03-24T07:55:42Z", "type": "commit"}, {"oid": "d64827bc42009a906ffdea588cb02bff31eed9e5", "url": "https://github.com/nordic-institute/X-Road/commit/d64827bc42009a906ffdea588cb02bff31eed9e5", "message": "XRDDEV-900 Remove unused lines from unit tests", "committedDate": "2020-03-24T08:11:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwODE1Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r397008152", "body": "SonarQube requires `\"invalid backup filename\"` to be in a constant because it occurs at least 3 times in this class.", "bodyText": "SonarQube requires \"invalid backup filename\" to be in a constant because it occurs at least 3 times in this class.", "bodyHTML": "<p dir=\"auto\">SonarQube requires <code>\"invalid backup filename\"</code> to be in a constant because it occurs at least 3 times in this class.</p>", "author": "carohauta", "createdAt": "2020-03-24T09:24:37Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java", "diffHunk": "@@ -90,6 +87,9 @@ public OffsetDateTime getCreatedAt(String filename) {\n      * @param filename\n      */\n     public void deleteBackupFile(String filename) {\n+        if (!FormatUtils.isValidBackupFilename(filename)) {\n+            throw new RuntimeException(\"invalid backup filename\");", "originalCommit": "d64827bc42009a906ffdea588cb02bff31eed9e5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAxMjY2MA==", "url": "https://github.com/nordic-institute/X-Road/pull/404#discussion_r397012660", "bodyText": "Fixed", "author": "petkivim", "createdAt": "2020-03-24T09:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwODE1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "2e7b3a9a7464b48075739c04312c9f3c5eb3b4f4", "changed_code": [{"header": "diff --git a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\nindex 383b7a321..aa15679dd 100644\n--- a/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\n+++ b/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/repository/BackupRepository.java\n", "chunk": "@@ -88,7 +89,7 @@ public class BackupRepository {\n      */\n     public void deleteBackupFile(String filename) {\n         if (!FormatUtils.isValidBackupFilename(filename)) {\n-            throw new RuntimeException(\"invalid backup filename\");\n+            throw new RuntimeException(INVALID_BACKUP_FILENAME);\n         }\n         Path path = getFilePath(filename);\n         try {\n", "next_change": null}]}}, {"oid": "2e7b3a9a7464b48075739c04312c9f3c5eb3b4f4", "url": "https://github.com/nordic-institute/X-Road/commit/2e7b3a9a7464b48075739c04312c9f3c5eb3b4f4", "message": "XRDDEV-900 Fix critical SonarQube issues", "committedDate": "2020-03-24T09:28:52Z", "type": "commit"}]}