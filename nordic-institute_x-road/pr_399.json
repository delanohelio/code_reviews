{"pr_number": 399, "pr_title": "XRDDEV-861 Register client", "pr_author": "carohauta", "pr_createdAt": "2020-03-02T14:20:16Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/399", "timeline": [{"oid": "5af9b47978b6e96f4a49760b7f49d7ab9f69bb8a", "url": "https://github.com/nordic-institute/X-Road/commit/5af9b47978b6e96f4a49760b7f49d7ab9f69bb8a", "message": "XRDDEV-861 Register client\n\n* controller and service layer done\n* exception refactoring - sorry about the noise!\n* WIP: tests", "committedDate": "2020-03-02T12:27:35Z", "type": "commit"}, {"oid": "014268241df54b1b5c8177bf7a775842da3a671d", "url": "https://github.com/nordic-institute/X-Road/commit/014268241df54b1b5c8177bf7a775842da3a671d", "message": "XRDDEV-861 Register client // tests", "committedDate": "2020-03-02T13:49:04Z", "type": "commit"}, {"oid": "73d193e39fa81e1892b7507333987709eb24a1d4", "url": "https://github.com/nordic-institute/X-Road/commit/73d193e39fa81e1892b7507333987709eb24a1d4", "message": "XRDDEV-861 Register client // javadov update", "committedDate": "2020-03-02T14:26:40Z", "type": "commit"}, {"oid": "395fe1492a818aa1f1e7489544bf311553c3999c", "url": "https://github.com/nordic-institute/X-Road/commit/395fe1492a818aa1f1e7489544bf311553c3999c", "message": "Merge branch 'develop' into XRDDEV-861-register-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/service/ClientServiceIntegrationTest.java", "committedDate": "2020-03-04T13:52:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyOTc2MA==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390129760", "body": "javadoc is not in sync with current interface", "bodyText": "javadoc is not in sync with current interface", "bodyHTML": "<p dir=\"auto\">javadoc is not in sync with current interface</p>", "author": "jansu76", "createdAt": "2020-03-10T07:21:34Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ManagementRequestSenderService.java", "diffHunk": "@@ -99,27 +101,32 @@ public Integer sendAuthCertDeletionRequest(byte[] authCert) throws\n         }\n     }\n \n+    /**\n+     * Sends a client register request as a normal X-Road message\n+     * @param securityServer the security server id", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3Mjk4Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390372983", "bodyText": "Fixed", "author": "carohauta", "createdAt": "2020-03-10T14:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEyOTc2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMTY5NQ==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390131695", "body": "This should probably verify that client can be registered, and ultimately result in http 409 if not?\r\n\r\nIt looks like client can be registered only if status = SAVED. Old implementation either\r\n\r\n- registers right after client has been added, and hence has status SAVED https://github.com/nordic-institute/X-Road/blob/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c/src/proxy-ui/public/javascripts/clients.js#L146-L187 or\r\n- shows \"register\" button only if status is SAVED https://github.com/nordic-institute/X-Road/blob/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c/src/proxy-ui/app/controllers/clients_controller.rb#L476-L477\r\n\r\nThere is no check in Ruby controllers, but adding this check to service layer would be consistent with how e.g. token register is now implemented. ", "bodyText": "This should probably verify that client can be registered, and ultimately result in http 409 if not?\nIt looks like client can be registered only if status = SAVED. Old implementation either\n\nregisters right after client has been added, and hence has status SAVED \n  \n    \n      X-Road/src/proxy-ui/public/javascripts/clients.js\n    \n    \n        Lines 146 to 187\n      in\n      1957846\n    \n    \n    \n    \n\n        \n          \n           $.post(action(\"client_add\"), params, function(response) { \n        \n\n        \n          \n               oClients.fnReplaceData(response.data.clients); \n        \n\n        \n          \n            \n        \n\n        \n          \n               $(dialog).dialog(\"close\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n               var regParams = { \n        \n\n        \n          \n                   member_class: params.add_member_class, \n        \n\n        \n          \n                   member_code: params.add_member_code, \n        \n\n        \n          \n                   subsystem_code: params.add_subsystem_code \n        \n\n        \n          \n               }; \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (response.data.registered) { \n        \n\n        \n          \n                   return; \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               var new_subsystem_warning = \"\"; \n        \n\n        \n          \n               if (!response.data.subsystem_registered) { \n        \n\n        \n          \n                   if(regParams.subsystem_code) { \n        \n\n        \n          \n                       new_subsystem_warning = _(\"clients.client_add_dialog.new_subsystem\", { \n        \n\n        \n          \n                           member_name: response.data.member_name || \"\", \n        \n\n        \n          \n                           member_class: regParams.member_class, \n        \n\n        \n          \n                           member_code: regParams.member_code, \n        \n\n        \n          \n                           subsystem_code: regParams.subsystem_code \n        \n\n        \n          \n                       }); \n        \n\n        \n          \n                   } else { \n        \n\n        \n          \n                       new_subsystem_warning = _(\"clients.client_add_dialog.new_member\", { \n        \n\n        \n          \n                           member_name: response.data.member_name || \"\", \n        \n\n        \n          \n                           member_class: regParams.member_class, \n        \n\n        \n          \n                           member_code: regParams.member_code \n        \n\n        \n          \n                       }); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               var confirmParams = { \n        \n\n        \n          \n                   new_subsystem_warning: new_subsystem_warning \n        \n\n        \n          \n               }; \n        \n\n        \n          \n            \n        \n\n        \n          \n               confirm(\"clients.client_add_dialog.send_regreq\", confirmParams, function() { \n        \n\n        \n          \n                   $.post(action(\"client_regreq\"), regParams, function() { \n        \n\n        \n          \n                       refreshClients(); \n        \n\n        \n          \n                   }, \"json\"); \n        \n\n        \n          \n               }); \n        \n    \n  \n\n or\nshows \"register\" button only if status is SAVED \n  \n    \n      X-Road/src/proxy-ui/app/controllers/clients_controller.rb\n    \n    \n        Lines 476 to 477\n      in\n      1957846\n    \n    \n    \n    \n\n        \n          \n           :register_enabled => \n        \n\n        \n          \n             [ClientType::STATUS_SAVED].include?(client.clientStatus), \n        \n    \n  \n\n\n\nThere is no check in Ruby controllers, but adding this check to service layer would be consistent with how e.g. token register is now implemented.", "bodyHTML": "<p dir=\"auto\">This should probably verify that client can be registered, and ultimately result in http 409 if not?</p>\n<p dir=\"auto\">It looks like client can be registered only if status = SAVED. Old implementation either</p>\n<ul dir=\"auto\">\n<li>registers right after client has been added, and hence has status SAVED <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/nordic-institute/X-Road/blob/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c/src/proxy-ui/public/javascripts/clients.js#L146-L187\">X-Road/src/proxy-ui/public/javascripts/clients.js</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 146 to 187\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/nordic-institute/X-Road/commit/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c\">1957846</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L146\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"146\"></td>\n          <td id=\"LC146\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-s1\">$</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">post</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">action</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"client_add\"</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">params</span><span class=\"pl-kos\">,</span> <span class=\"pl-k\">function</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">response</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L147\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"147\"></td>\n          <td id=\"LC147\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-s1\">oClients</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">fnReplaceData</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">response</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">data</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">clients</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L148\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"148\"></td>\n          <td id=\"LC148\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L149\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"149\"></td>\n          <td id=\"LC149\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-s1\">$</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">dialog</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">dialog</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"close\"</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L150\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"150\"></td>\n          <td id=\"LC150\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L151\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"151\"></td>\n          <td id=\"LC151\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">var</span> <span class=\"pl-s1\">regParams</span> <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L152\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"152\"></td>\n          <td id=\"LC152\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-c1\">member_class</span>: <span class=\"pl-s1\">params</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">add_member_class</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L153\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"153\"></td>\n          <td id=\"LC153\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-c1\">member_code</span>: <span class=\"pl-s1\">params</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">add_member_code</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L154\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"154\"></td>\n          <td id=\"LC154\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-c1\">subsystem_code</span>: <span class=\"pl-s1\">params</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">add_subsystem_code</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L155\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"155\"></td>\n          <td id=\"LC155\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-kos\">}</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L156\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"156\"></td>\n          <td id=\"LC156\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L157\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"157\"></td>\n          <td id=\"LC157\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">if</span> <span class=\"pl-kos\">(</span><span class=\"pl-s1\">response</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">data</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">registered</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L158\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"158\"></td>\n          <td id=\"LC158\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">return</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L159\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"159\"></td>\n          <td id=\"LC159\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-kos\">}</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L160\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"160\"></td>\n          <td id=\"LC160\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L161\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"161\"></td>\n          <td id=\"LC161\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">var</span> <span class=\"pl-s1\">new_subsystem_warning</span> <span class=\"pl-c1\">=</span> <span class=\"pl-s\">\"\"</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L162\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"162\"></td>\n          <td id=\"LC162\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">if</span> <span class=\"pl-kos\">(</span><span class=\"pl-c1\">!</span><span class=\"pl-s1\">response</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">data</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">subsystem_registered</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L163\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"163\"></td>\n          <td id=\"LC163\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-k\">if</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">regParams</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">subsystem_code</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L164\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"164\"></td>\n          <td id=\"LC164\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-s1\">new_subsystem_warning</span> <span class=\"pl-c1\">=</span> <span class=\"pl-en\">_</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"clients.client_add_dialog.new_subsystem\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L165\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"165\"></td>\n          <td id=\"LC165\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                 <span class=\"pl-c1\">member_name</span>: <span class=\"pl-s1\">response</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">data</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">member_name</span> <span class=\"pl-c1\">||</span> <span class=\"pl-s\">\"\"</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L166\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"166\"></td>\n          <td id=\"LC166\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                 <span class=\"pl-c1\">member_class</span>: <span class=\"pl-s1\">regParams</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">member_class</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L167\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"167\"></td>\n          <td id=\"LC167\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                 <span class=\"pl-c1\">member_code</span>: <span class=\"pl-s1\">regParams</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">member_code</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L168\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"168\"></td>\n          <td id=\"LC168\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                 <span class=\"pl-c1\">subsystem_code</span>: <span class=\"pl-s1\">regParams</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">subsystem_code</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L169\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"169\"></td>\n          <td id=\"LC169\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L170\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"170\"></td>\n          <td id=\"LC170\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-kos\">}</span> <span class=\"pl-k\">else</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L171\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"171\"></td>\n          <td id=\"LC171\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-s1\">new_subsystem_warning</span> <span class=\"pl-c1\">=</span> <span class=\"pl-en\">_</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"clients.client_add_dialog.new_member\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L172\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"172\"></td>\n          <td id=\"LC172\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                 <span class=\"pl-c1\">member_name</span>: <span class=\"pl-s1\">response</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">data</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">member_name</span> <span class=\"pl-c1\">||</span> <span class=\"pl-s\">\"\"</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L173\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"173\"></td>\n          <td id=\"LC173\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                 <span class=\"pl-c1\">member_class</span>: <span class=\"pl-s1\">regParams</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">member_class</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L174\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"174\"></td>\n          <td id=\"LC174\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">                 <span class=\"pl-c1\">member_code</span>: <span class=\"pl-s1\">regParams</span><span class=\"pl-kos\">.</span><span class=\"pl-c1\">member_code</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L175\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"175\"></td>\n          <td id=\"LC175\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L176\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"176\"></td>\n          <td id=\"LC176\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-kos\">}</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L177\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"177\"></td>\n          <td id=\"LC177\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-kos\">}</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L178\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"178\"></td>\n          <td id=\"LC178\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L179\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"179\"></td>\n          <td id=\"LC179\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">var</span> <span class=\"pl-s1\">confirmParams</span> <span class=\"pl-c1\">=</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L180\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"180\"></td>\n          <td id=\"LC180\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-c1\">new_subsystem_warning</span>: <span class=\"pl-s1\">new_subsystem_warning</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L181\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"181\"></td>\n          <td id=\"LC181\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-kos\">}</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L182\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"182\"></td>\n          <td id=\"LC182\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L183\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"183\"></td>\n          <td id=\"LC183\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-en\">confirm</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"clients.client_add_dialog.send_regreq\"</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">confirmParams</span><span class=\"pl-kos\">,</span> <span class=\"pl-k\">function</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L184\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"184\"></td>\n          <td id=\"LC184\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-s1\">$</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">post</span><span class=\"pl-kos\">(</span><span class=\"pl-en\">action</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">\"client_regreq\"</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> <span class=\"pl-s1\">regParams</span><span class=\"pl-kos\">,</span> <span class=\"pl-k\">function</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">)</span> <span class=\"pl-kos\">{</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L185\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"185\"></td>\n          <td id=\"LC185\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-en\">refreshClients</span><span class=\"pl-kos\">(</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L186\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"186\"></td>\n          <td id=\"LC186\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         <span class=\"pl-kos\">}</span><span class=\"pl-kos\">,</span> <span class=\"pl-s\">\"json\"</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L187\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"187\"></td>\n          <td id=\"LC187\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-kos\">}</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">;</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n or</li>\n<li>shows \"register\" button only if status is SAVED <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/nordic-institute/X-Road/blob/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c/src/proxy-ui/app/controllers/clients_controller.rb#L476-L477\">X-Road/src/proxy-ui/app/controllers/clients_controller.rb</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 476 to 477\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/nordic-institute/X-Road/commit/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c\">1957846</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L476\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"476\"></td>\n          <td id=\"LC476\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-pds\">:register_enabled</span> <span class=\"pl-c1\">=&gt;</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L477\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"477\"></td>\n          <td id=\"LC477\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-kos\">[</span><span class=\"pl-v\">ClientType</span>::<span class=\"pl-c1\">STATUS_SAVED</span><span class=\"pl-kos\">]</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">include?</span><span class=\"pl-kos\">(</span><span class=\"pl-s1\">client</span><span class=\"pl-kos\">.</span><span class=\"pl-en\">clientStatus</span><span class=\"pl-kos\">)</span><span class=\"pl-kos\">,</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</li>\n</ul>\n<p dir=\"auto\">There is no check in Ruby controllers, but adding this check to service layer would be consistent with how e.g. token register is now implemented.</p>", "author": "jansu76", "createdAt": "2020-03-10T07:28:10Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -418,6 +416,23 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n         return mergeClientListsDistinctively(globalClients, localClients);\n     }\n \n+    /**\n+     * Registers a client\n+     * @param clientId client to register\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     */\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId); // throws if client doesn't exist\n+        try {\n+            managementRequestSenderService.sendClientRegisterRequest(clientId);\n+            client.setClientStatus(ClientType.STATUS_REGINPROG);", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3MzEwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390373107", "bodyText": "Added a check for this", "author": "carohauta", "createdAt": "2020-03-10T14:52:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMTY5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMjQwOA==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390132408", "body": "Old implementation also has \"cannot register owner\" check that we are missing at the moment: https://github.com/nordic-institute/X-Road/blob/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c/src/proxy-ui/app/controllers/clients_controller.rb#L234-L236\r\n\r\nShould we have that? Or was it intentionally left out (for init, maybe?). \r\n\r\nI do not yet have clear vision of how init will eventually work, maybe one option would be to include \"cannot register owner\" check now, and revise that later if needed, when we implement init?", "bodyText": "Old implementation also has \"cannot register owner\" check that we are missing at the moment: \n  \n    \n      X-Road/src/proxy-ui/app/controllers/clients_controller.rb\n    \n    \n        Lines 234 to 236\n      in\n      1957846\n    \n    \n    \n    \n\n        \n          \n           if client_id == owner_identifier \n        \n\n        \n          \n             raise t('clients.cannot_register_owner') \n        \n\n        \n          \n           end \n        \n    \n  \n\n\nShould we have that? Or was it intentionally left out (for init, maybe?).\nI do not yet have clear vision of how init will eventually work, maybe one option would be to include \"cannot register owner\" check now, and revise that later if needed, when we implement init?", "bodyHTML": "<p dir=\"auto\">Old implementation also has \"cannot register owner\" check that we are missing at the moment: <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/nordic-institute/X-Road/blob/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c/src/proxy-ui/app/controllers/clients_controller.rb#L234-L236\">X-Road/src/proxy-ui/app/controllers/clients_controller.rb</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 234 to 236\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/nordic-institute/X-Road/commit/19578462600ce3ec1832e3af5ff2b0f1b1cfe01c\">1957846</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L234\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"234\"></td>\n          <td id=\"LC234\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> <span class=\"pl-s1\">client_id</span> == <span class=\"pl-en\">owner_identifier</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L235\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"235\"></td>\n          <td id=\"LC235\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   <span class=\"pl-en\">raise</span> <span class=\"pl-en\">t</span><span class=\"pl-kos\">(</span><span class=\"pl-s\">'clients.cannot_register_owner'</span><span class=\"pl-kos\">)</span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L236\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"236\"></td>\n          <td id=\"LC236\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">end</span> </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">Should we have that? Or was it intentionally left out (for init, maybe?).</p>\n<p dir=\"auto\">I do not yet have clear vision of how init will eventually work, maybe one option would be to include \"cannot register owner\" check now, and revise that later if needed, when we implement init?</p>", "author": "jansu76", "createdAt": "2020-03-10T07:30:34Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java", "diffHunk": "@@ -418,6 +416,23 @@ public ClientType deleteTlsCertificate(ClientId id, String certificateHash)\n         return mergeClientListsDistinctively(globalClients, localClients);\n     }\n \n+    /**\n+     * Registers a client\n+     * @param clientId client to register\n+     * @throws GlobalConfOutdatedException\n+     * @throws ClientNotFoundException\n+     */\n+    public void registerClient(ClientId clientId) throws GlobalConfOutdatedException, ClientNotFoundException {\n+        ClientType client = getLocalClientOrThrowNotFound(clientId); // throws if client doesn't exist\n+        try {\n+            managementRequestSenderService.sendClientRegisterRequest(clientId);\n+            client.setClientStatus(ClientType.STATUS_REGINPROG);\n+            clientRepository.saveOrUpdate(client);", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3Mzg3Mw==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390373873", "bodyText": "I added a check for this. It should be changed when implementing the init functionality \u2013 if needed.", "author": "carohauta", "createdAt": "2020-03-10T14:53:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEzMjQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0MTA3Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390141072", "body": "According to Sonar this method is not tested. Most of ClientsApiController other methods are tested.\r\n\r\nBut this controller method does not contain anything nontrivial, it is probably correct to not test it. So just a FYI comment. ", "bodyText": "According to Sonar this method is not tested. Most of ClientsApiController other methods are tested.\nBut this controller method does not contain anything nontrivial, it is probably correct to not test it. So just a FYI comment.", "bodyHTML": "<p dir=\"auto\">According to Sonar this method is not tested. Most of ClientsApiController other methods are tested.</p>\n<p dir=\"auto\">But this controller method does not contain anything nontrivial, it is probably correct to not test it. So just a FYI comment.</p>", "author": "jansu76", "createdAt": "2020-03-10T07:55:01Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java", "diffHunk": "@@ -435,4 +432,18 @@ private ClientType getClientType(String encodedId) {\n         Client result = clientConverter.convert(added);\n         return createCreatedResponse(\"/api/clients/{id}\", result, result.getId());\n     }\n+\n+    @Override\n+    @PreAuthorize(\"hasAuthority('SEND_CLIENT_REG_REQ')\")", "originalCommit": "395fe1492a818aa1f1e7489544bf311553c3999c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM3NDE2Mg==", "url": "https://github.com/nordic-institute/X-Road/pull/399#discussion_r390374162", "bodyText": "Added controller tests", "author": "carohauta", "createdAt": "2020-03-10T14:53:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE0MTA3Mg=="}], "type": "inlineReview"}, {"oid": "412132cd91ee5028c178a0fd5b94c0bde24c502e", "url": "https://github.com/nordic-institute/X-Road/commit/412132cd91ee5028c178a0fd5b94c0bde24c502e", "message": "XRDDEV-861 Register client // PR comment fixes 1\n\n* refactor SecurityServerOwner -> CurrentSecurityServerId\n* add verifications to whether or not client can be registered\n* test coverage for controller", "committedDate": "2020-03-10T14:40:48Z", "type": "commit"}, {"oid": "b358e0f30d09a6d2e85b9dfbce484126bc3167af", "url": "https://github.com/nordic-institute/X-Road/commit/b358e0f30d09a6d2e85b9dfbce484126bc3167af", "message": "Merge branch 'develop' into XRDDEV-861-register-client", "committedDate": "2020-03-11T10:07:10Z", "type": "commit"}, {"oid": "550f0fcfbccf2163c5fe092c8a5628865b03d1e4", "url": "https://github.com/nordic-institute/X-Road/commit/550f0fcfbccf2163c5fe092c8a5628865b03d1e4", "message": "Merge branch 'develop' into XRDDEV-861-register-client\n\n# Conflicts:\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/ClientsApiController.java\n#\tsrc/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ClientService.java\n#\tsrc/proxy-ui-api/src/test/java/org/niis/xroad/restapi/openapi/ClientsApiControllerIntegrationTest.java", "committedDate": "2020-03-11T11:28:30Z", "type": "commit"}]}