{"pr_number": 594, "pr_title": "XRDDEV-1190", "pr_author": "petkivim", "pr_createdAt": "2020-07-14T07:55:35Z", "pr_url": "https://github.com/nordic-institute/X-Road/pull/594", "timeline": [{"oid": "aed91935a9294e1957bf3455863e37efd2ec1c11", "url": "https://github.com/nordic-institute/X-Road/commit/aed91935a9294e1957bf3455863e37efd2ec1c11", "message": "XRDDEV-1190 Fix error code 500 when REST endpoint is updated\n\n- Return error code 409 with metadata when updating endpoint fails because of another endpoint with the same signature already exists.\n- Catch DataIntegrityViolationException on controller layer because the exception is thrown when the transaction commits and therefore, it must be catched outside of the transaction's scope.", "committedDate": "2020-07-14T07:43:27Z", "type": "commit"}, {"oid": "de04bd54e5eda9e12c8380bf78d085eae257f8dc", "url": "https://github.com/nordic-institute/X-Road/commit/de04bd54e5eda9e12c8380bf78d085eae257f8dc", "message": "XRDDEV-1190 Remove a duplicate, unsused file", "committedDate": "2020-07-14T07:50:57Z", "type": "commit"}, {"oid": "327b78b1c181e275488d7af6291339d487df9d41", "url": "https://github.com/nordic-institute/X-Road/commit/327b78b1c181e275488d7af6291339d487df9d41", "message": "XRDDEV-1190 Return status code 400 instead of 409", "committedDate": "2020-07-14T09:03:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgzNDIwNw==", "url": "https://github.com/nordic-institute/X-Road/pull/594#discussion_r454834207", "body": "Should this maybe be a ConflictException instead of bad request?\r\n\r\nIn any case I think controller should not catch DataIntegrityViolationException here\r\n\r\n- DataIntegrityViolationException is a low level data access layer concept and _ideally_ controller layer should not be aware of such things https://confluence.niis.org/display/XRDDEV/API+backend+implementation#APIbackendimplementation-Layering\r\n- DataIntegrityViolationException is generic in principle, so we do not know for sure that it was caused by this specific problem \"Endpoint with equivalent service code, ...\". OK, now it is probably 99% sure, but this is a relevant issue when you factor in future changes and nontrivial DB constraints\r\n- it deviates from the conventions used in other controllers - they mostly catch service layer exceptions and map those to controller layer / openapi exceptions. ServicesApiController.addEndpoint handles this by\r\n\r\n```\r\n        } catch (EndpointAlreadyExistsException e) {\r\n            throw new ConflictException(e);\r\n```\r\n\r\nBut, handling this on service layer is probably not as easy as catch DataIntegrityViolationException -> throw EndpointAlreadyExistsException. I believe constraints only kick in when transaction commits, and this only happens when service call ends, so we can't catch DataIntegrityViolationException in the service method? I believe the constraint needs to be validated in a similar way as in addEndpoint https://github.com/nordic-institute/X-Road/blob/df9eef12face9053deef7ed5f836f707ef34a6ff/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceService.java#L227-L230\r\n\r\nIt has to take into account endpoint ID probably, to distinguish between updated endpoint from the rest of them.\r\n\r\nThis adds some extra work to implement the constraints, which is unfortunate. If the service layer checks were too difficult to implement then some compromises or some generic handlers could be made. But I think in this case it should not be too costly to implement the check and be more consistent with the rest of the app.", "bodyText": "Should this maybe be a ConflictException instead of bad request?\nIn any case I think controller should not catch DataIntegrityViolationException here\n\nDataIntegrityViolationException is a low level data access layer concept and ideally controller layer should not be aware of such things https://confluence.niis.org/display/XRDDEV/API+backend+implementation#APIbackendimplementation-Layering\nDataIntegrityViolationException is generic in principle, so we do not know for sure that it was caused by this specific problem \"Endpoint with equivalent service code, ...\". OK, now it is probably 99% sure, but this is a relevant issue when you factor in future changes and nontrivial DB constraints\nit deviates from the conventions used in other controllers - they mostly catch service layer exceptions and map those to controller layer / openapi exceptions. ServicesApiController.addEndpoint handles this by\n\n        } catch (EndpointAlreadyExistsException e) {\n            throw new ConflictException(e);\n\nBut, handling this on service layer is probably not as easy as catch DataIntegrityViolationException -> throw EndpointAlreadyExistsException. I believe constraints only kick in when transaction commits, and this only happens when service call ends, so we can't catch DataIntegrityViolationException in the service method? I believe the constraint needs to be validated in a similar way as in addEndpoint \n  \n    \n      X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceService.java\n    \n    \n        Lines 227 to 230\n      in\n      df9eef1\n    \n    \n    \n    \n\n        \n          \n           if (client.getEndpoint().stream().anyMatch(existingEp -> existingEp.isEquivalent(endpointType))) { \n        \n\n        \n          \n               throw new EndpointAlreadyExistsException(\"Endpoint with equivalent service code, method and path already \" \n        \n\n        \n          \n                       + \"exists for this client\"); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nIt has to take into account endpoint ID probably, to distinguish between updated endpoint from the rest of them.\nThis adds some extra work to implement the constraints, which is unfortunate. If the service layer checks were too difficult to implement then some compromises or some generic handlers could be made. But I think in this case it should not be too costly to implement the check and be more consistent with the rest of the app.", "bodyHTML": "<p dir=\"auto\">Should this maybe be a ConflictException instead of bad request?</p>\n<p dir=\"auto\">In any case I think controller should not catch DataIntegrityViolationException here</p>\n<ul dir=\"auto\">\n<li>DataIntegrityViolationException is a low level data access layer concept and <em>ideally</em> controller layer should not be aware of such things <a href=\"https://confluence.niis.org/display/XRDDEV/API+backend+implementation#APIbackendimplementation-Layering\" rel=\"nofollow\">https://confluence.niis.org/display/XRDDEV/API+backend+implementation#APIbackendimplementation-Layering</a></li>\n<li>DataIntegrityViolationException is generic in principle, so we do not know for sure that it was caused by this specific problem \"Endpoint with equivalent service code, ...\". OK, now it is probably 99% sure, but this is a relevant issue when you factor in future changes and nontrivial DB constraints</li>\n<li>it deviates from the conventions used in other controllers - they mostly catch service layer exceptions and map those to controller layer / openapi exceptions. ServicesApiController.addEndpoint handles this by</li>\n</ul>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"        } catch (EndpointAlreadyExistsException e) {\n            throw new ConflictException(e);\"><pre><code>        } catch (EndpointAlreadyExistsException e) {\n            throw new ConflictException(e);\n</code></pre></div>\n<p dir=\"auto\">But, handling this on service layer is probably not as easy as catch DataIntegrityViolationException -&gt; throw EndpointAlreadyExistsException. I believe constraints only kick in when transaction commits, and this only happens when service call ends, so we can't catch DataIntegrityViolationException in the service method? I believe the constraint needs to be validated in a similar way as in addEndpoint <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/nordic-institute/X-Road/blob/df9eef12face9053deef7ed5f836f707ef34a6ff/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceService.java#L227-L230\">X-Road/src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/service/ServiceService.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 227 to 230\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/nordic-institute/X-Road/commit/df9eef12face9053deef7ed5f836f707ef34a6ff\">df9eef1</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L227\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"227\"></td>\n          <td id=\"LC227\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (client<span class=\"pl-k\">.</span>getEndpoint()<span class=\"pl-k\">.</span>stream()<span class=\"pl-k\">.</span>anyMatch(existingEp <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> existingEp<span class=\"pl-k\">.</span>isEquivalent(endpointType))) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L228\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"228\"></td>\n          <td id=\"LC228\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">EndpointAlreadyExistsException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Endpoint with equivalent service code, method and path already <span class=\"pl-pds\">\"</span></span> </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L229\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"229\"></td>\n          <td id=\"LC229\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">             <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>exists for this client<span class=\"pl-pds\">\"</span></span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L230\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"230\"></td>\n          <td id=\"LC230\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">It has to take into account endpoint ID probably, to distinguish between updated endpoint from the rest of them.</p>\n<p dir=\"auto\">This adds some extra work to implement the constraints, which is unfortunate. If the service layer checks were too difficult to implement then some compromises or some generic handlers could be made. But I think in this case it should not be too costly to implement the check and be more consistent with the rest of the app.</p>", "author": "jansu76", "createdAt": "2020-07-15T07:00:01Z", "path": "src/proxy-ui-api/src/main/java/org/niis/xroad/restapi/openapi/EndpointsApiController.java", "diffHunk": "@@ -137,6 +139,10 @@ public EndpointsApiController(\n             throw new ResourceNotFoundException(NOT_FOUND_ERROR_MSG + \" \" + id);\n         } catch (EndpointService.IllegalGeneratedEndpointUpdateException e) {\n             throw new BadRequestException(\"Updating is not allowed for generated endpoint \" + id);\n+        } catch (DataIntegrityViolationException e) {", "originalCommit": "327b78b1c181e275488d7af6291339d487df9d41", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk1MDkzMQ==", "url": "https://github.com/nordic-institute/X-Road/pull/594#discussion_r454950931", "bodyText": "Refactored the PR based on the comments. ConflictException is now thrown instead of BadRequest.", "author": "petkivim", "createdAt": "2020-07-15T10:27:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgzNDIwNw=="}], "type": "inlineReview"}, {"oid": "cb95e94beb26db2d48641de628ca9f889442c0cc", "url": "https://github.com/nordic-institute/X-Road/commit/cb95e94beb26db2d48641de628ca9f889442c0cc", "message": "XRDDEV-1190 Refactor based on review comments", "committedDate": "2020-07-15T10:23:22Z", "type": "commit"}]}