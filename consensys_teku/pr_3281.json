{"pr_number": 3281, "pr_title": "verify the unsigned data returned for signing is for the expected slot", "pr_author": "rolfyone", "pr_createdAt": "2020-11-23T04:39:28Z", "pr_url": "https://github.com/ConsenSys/teku/pull/3281", "timeline": [{"oid": "34bc930fd2ac01b97d8e6f841a01b1cd5d430ee2", "url": "https://github.com/ConsenSys/teku/commit/34bc930fd2ac01b97d8e6f841a01b1cd5d430ee2", "message": "verify the unsigned data returned for signing is for the expected slot\n\npartially addresses #3154\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-23T04:38:41Z", "type": "commit"}, {"oid": "e89a6d1ff3540d2022f29f8df0edcb47cb8a67f0", "url": "https://github.com/ConsenSys/teku/commit/e89a6d1ff3540d2022f29f8df0edcb47cb8a67f0", "message": "Merge remote-tracking branch 'upstream/master' into 3154", "committedDate": "2020-11-23T04:39:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ2OTE5NA==", "url": "https://github.com/ConsenSys/teku/pull/3281#discussion_r528469194", "body": "nit:\r\n```suggestion\r\n    checkArgument(\r\n        attestationData.getSlot().equals(slot),\r\n        \"Unsigned attestation slot (%s) does not match expected slot %s\",\r\n         attestationData.getSlot(),\r\n         slot);\r\n```", "bodyText": "nit:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                checkArgument(\n          \n          \n            \n                    attestationData.getSlot().equals(slot),\n          \n          \n            \n                    \"Unsigned attestation slot ( \"\n          \n          \n            \n                        + attestationData.getSlot()\n          \n          \n            \n                        + \") does not match expected slot \"\n          \n          \n            \n                        + slot);\n          \n          \n            \n                checkArgument(\n          \n          \n            \n                    attestationData.getSlot().equals(slot),\n          \n          \n            \n                    \"Unsigned attestation slot (%s) does not match expected slot %s\",\n          \n          \n            \n                     attestationData.getSlot(),\n          \n          \n            \n                     slot);", "bodyHTML": "<p dir=\"auto\">nit:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    checkArgument(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        attestationData<span class=\"pl-k\">.</span>getSlot()<span class=\"pl-k\">.</span>equals(slot),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Unsigned attestation slot ( <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">+</span> attestationData<span class=\"pl-k\">.</span>getSlot()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>) does not match expected slot <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">+</span> slot);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    checkArgument(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        attestationData<span class=\"pl-k\">.</span>getSlot()<span class=\"pl-k\">.</span>equals(slot),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Unsigned attestation slot (%s) does not match expected slot %s<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">         attestationData<span class=\"pl-k\">.</span>getSlot(),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">         slot);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ajsutton", "createdAt": "2020-11-23T04:41:41Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/duties/AttestationProductionDuty.java", "diffHunk": "@@ -140,6 +141,12 @@ public String getProducedType() {\n       final ForkInfo forkInfo,\n       final AttestationData attestationData,\n       final ValidatorWithCommitteePositionAndIndex validator) {\n+    checkArgument(\n+        attestationData.getSlot().equals(slot),\n+        \"Unsigned attestation slot ( \"\n+            + attestationData.getSlot()\n+            + \") does not match expected slot \"\n+            + slot);", "originalCommit": "e89a6d1ff3540d2022f29f8df0edcb47cb8a67f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ2OTQ3NA==", "url": "https://github.com/ConsenSys/teku/pull/3281#discussion_r528469474", "body": "Can use same %s format trick as above to avoid creating the string until its actually needed.\r\n\r\nI'd probably extract the `unsignedBlock.orElseThrow` below to a variable and then you can just use it directly here as well rather than needing an `ifPresent` block.", "bodyText": "Can use same %s format trick as above to avoid creating the string until its actually needed.\nI'd probably extract the unsignedBlock.orElseThrow below to a variable and then you can just use it directly here as well rather than needing an ifPresent block.", "bodyHTML": "<p dir=\"auto\">Can use same %s format trick as above to avoid creating the string until its actually needed.</p>\n<p dir=\"auto\">I'd probably extract the <code>unsignedBlock.orElseThrow</code> below to a variable and then you can just use it directly here as well rather than needing an <code>ifPresent</code> block.</p>", "author": "ajsutton", "createdAt": "2020-11-23T04:43:07Z", "path": "validator/client/src/main/java/tech/pegasys/teku/validator/client/duties/BlockProductionDuty.java", "diffHunk": "@@ -96,6 +97,14 @@ public String getProducedType() {\n \n   public SafeFuture<SignedBeaconBlock> signBlock(\n       final ForkInfo forkInfo, final Optional<BeaconBlock> unsignedBlock) {\n+    unsignedBlock.ifPresent(\n+        beaconBlock ->\n+            checkArgument(\n+                beaconBlock.getSlot().equals(slot),\n+                \"Unsigned block slot ( \"\n+                    + beaconBlock.getSlot()\n+                    + \") does not match expected slot \"\n+                    + slot));", "originalCommit": "e89a6d1ff3540d2022f29f8df0edcb47cb8a67f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4f3727b2a7057a9d5da70a423f315e49eafbf079", "url": "https://github.com/ConsenSys/teku/commit/4f3727b2a7057a9d5da70a423f315e49eafbf079", "message": "review comments\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-11-23T05:16:31Z", "type": "commit"}, {"oid": "c257c6f219de7018583f4150f3d63e8997a73dd4", "url": "https://github.com/ConsenSys/teku/commit/c257c6f219de7018583f4150f3d63e8997a73dd4", "message": "Merge remote-tracking branch 'upstream/master' into 3154", "committedDate": "2020-11-23T05:20:13Z", "type": "commit"}]}