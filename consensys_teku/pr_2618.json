{"pr_number": 2618, "pr_title": "[Issue 2600] find a common ancestor slot to sync from", "pr_author": "rolfyone", "pr_createdAt": "2020-08-19T03:25:10Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2618", "timeline": [{"oid": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9", "url": "https://github.com/ConsenSys/teku/commit/80804f421c9b90ff7c27c88d5a791b40f8ed84c9", "message": "[Issue 2600] find a common ancestor slot to sync from\n\n - If there are at least 10_000 slots after the local finalized slot, interrogate a set of slots in the range of 3000-2000 behind our head slot, and see if there are any in common with the peer. If that finds a match, use that as the first slot to sync from. Otherwise, sync from the finalized checkpoint as previously.\n\n fixes #2600\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-19T03:24:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0MzMzMw==", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472643333", "body": "10,000 slots seems like it's too many.  I wonder if we should just make this the same as optimistic history length. We only make one extra request if we trigger this logic so it's very cheap compared to downloading all the blocks since finalisation.", "bodyText": "10,000 slots seems like it's too many.  I wonder if we should just make this the same as optimistic history length. We only make one extra request if we trigger this logic so it's very cheap compared to downloading all the blocks since finalisation.", "bodyHTML": "<p dir=\"auto\">10,000 slots seems like it's too many.  I wonder if we should just make this the same as optimistic history length. We only make one extra request if we trigger this logic so it's very cheap compared to downloading all the blocks since finalisation.</p>", "author": "ajsutton", "createdAt": "2020-08-19T03:32:45Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;", "originalCommit": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0Njc0OA==", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472646748", "body": "I think we want `localHead.min(status.getHeadSlot())` because in rare cases it's possible that the peer has a lower head slot but a higher finalised epoch which would cause us to sync to it.  This would be the case if 2/3rds of the Medalla validators all attested that there had been no blocks since finalisation stopped - head block would be back in epoch 2289 but the finalised epoch would be 3287.", "bodyText": "I think we want localHead.min(status.getHeadSlot()) because in rare cases it's possible that the peer has a lower head slot but a higher finalised epoch which would cause us to sync to it.  This would be the case if 2/3rds of the Medalla validators all attested that there had been no blocks since finalisation stopped - head block would be back in epoch 2289 but the finalised epoch would be 3287.", "bodyHTML": "<p dir=\"auto\">I think we want <code>localHead.min(status.getHeadSlot())</code> because in rare cases it's possible that the peer has a lower head slot but a higher finalised epoch which would cause us to sync to it.  This would be the case if 2/3rds of the Medalla validators all attested that there had been no blocks since finalisation stopped - head block would be back in epoch 2289 but the finalised epoch would be 3287.</p>", "author": "ajsutton", "createdAt": "2020-08-19T03:38:47Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();", "originalCommit": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0Nzc3Ng==", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472647776", "body": "```suggestion\r\n    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\r\n        && status.getHeadSlot().isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))) {\r\n```\r\nfor consistency", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n          \n          \n            \n                    && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {\n          \n          \n            \n                if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n          \n          \n            \n                    && status.getHeadSlot().isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))) {\n          \n      \n    \n    \n  \n\nfor consistency", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">if</span> (localHead<span class=\"pl-k\">.</span>isGreaterThanOrEqualTo(firstNonFinalSlot<span class=\"pl-k\">.</span>plus(<span class=\"pl-c1\">MINIMUM_VIABLE_SLOTS</span>))</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first\">firstNonFinalSlot</span><span class=\"pl-k x\">.</span><span class=\"x\">plus(</span><span class=\"pl-c1 x\">MINIMUM_VIABLE_SLOTS</span><span class=\"x\">)</span><span class=\"pl-k x\">.</span><span class=\"x\">isLessThan(status</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getHeadSlot(</span>))) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (localHead<span class=\"pl-k\">.</span>isGreaterThanOrEqualTo(firstNonFinalSlot<span class=\"pl-k\">.</span>plus(<span class=\"pl-c1\">MINIMUM_VIABLE_SLOTS</span>))</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first\">status</span><span class=\"pl-k x\">.</span><span class=\"x\">getHeadSlot()</span><span class=\"pl-k x\">.</span><span class=\"x\">isGreaterThanOrEqualTo(firstNonFinalSlot</span><span class=\"pl-k x\">.</span><span class=\"x\">plus(</span><span class=\"pl-c1 x x-last\">MINIMUM_VIABLE_SLOTS</span>))) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">for consistency</p>", "author": "ajsutton", "createdAt": "2020-08-19T03:40:27Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();\n+    // more than 10000 blocks behind, try to find a better starting slot if we have non finalized\n+    // data\n+    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n+        && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {", "originalCommit": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2MTU4MQ==", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472661581", "bodyText": "And probably invert the if condition so that we return early instead of having the whole method inside the if.", "author": "ajsutton", "createdAt": "2020-08-19T04:02:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0Nzc3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1OTIxOA==", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472659218", "body": "Probably make these constants and show the calculation - ie that it's important they total just 1000 slots, and with a comment about Prysm's limitations.", "bodyText": "Probably make these constants and show the calculation - ie that it's important they total just 1000 slots, and with a comment about Prysm's limitations.", "bodyHTML": "<p dir=\"auto\">Probably make these constants and show the calculation - ie that it's important they total just 1000 slots, and with a comment about Prysm's limitations.</p>", "author": "ajsutton", "createdAt": "2020-08-19T03:59:09Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();\n+    // more than 10000 blocks behind, try to find a better starting slot if we have non finalized\n+    // data\n+    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n+        && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {\n+      final UInt64 localNonFinalisedSlotCount = localHead.minus(firstNonFinalSlot);\n+      final UInt64 count = UInt64.valueOf(20);\n+      final UInt64 freq = UInt64.valueOf(50);", "originalCommit": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2MDk3NQ==", "url": "https://github.com/ConsenSys/teku/pull/2618#discussion_r472660975", "body": "nit: Make `MINIMUM_VIABLE_SLOTS` a `UInt` in the constant to make this more readable.", "bodyText": "nit: Make MINIMUM_VIABLE_SLOTS a UInt in the constant to make this more readable.", "bodyHTML": "<p dir=\"auto\">nit: Make <code>MINIMUM_VIABLE_SLOTS</code> a <code>UInt</code> in the constant to make this more readable.</p>", "author": "ajsutton", "createdAt": "2020-08-19T04:01:53Z", "path": "sync/src/main/java/tech/pegasys/teku/sync/CommonAncestor.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.sync;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.infrastructure.async.SafeFuture;\n+import tech.pegasys.teku.infrastructure.unsigned.UInt64;\n+import tech.pegasys.teku.networking.eth2.peers.Eth2Peer;\n+import tech.pegasys.teku.networking.eth2.peers.PeerStatus;\n+import tech.pegasys.teku.networking.eth2.rpc.core.ResponseStreamListener;\n+import tech.pegasys.teku.storage.client.RecentChainData;\n+\n+public class CommonAncestor {\n+  private static final Logger LOG = LogManager.getLogger();\n+  private static final int MINIMUM_VIABLE_SLOTS = 10000;\n+  private static final int OPTIMISTIC_HISTORY_LENGTH = 3000;\n+  private final RecentChainData storageClient;\n+\n+  public CommonAncestor(final RecentChainData storageClient) {\n+    this.storageClient = storageClient;\n+  }\n+\n+  public SafeFuture<UInt64> getCommonAncestor(\n+      final Eth2Peer peer, final PeerStatus status, final UInt64 firstNonFinalSlot) {\n+    final UInt64 localHead = storageClient.getHeadSlot();\n+    // more than 10000 blocks behind, try to find a better starting slot if we have non finalized\n+    // data\n+    if (localHead.isGreaterThanOrEqualTo(firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS))\n+        && firstNonFinalSlot.plus(MINIMUM_VIABLE_SLOTS).isLessThan(status.getHeadSlot())) {\n+      final UInt64 localNonFinalisedSlotCount = localHead.minus(firstNonFinalSlot);\n+      final UInt64 count = UInt64.valueOf(20);\n+      final UInt64 freq = UInt64.valueOf(50);\n+      final UInt64 firstRequestedSlot =\n+          localNonFinalisedSlotCount.isGreaterThanOrEqualTo(UInt64.valueOf(MINIMUM_VIABLE_SLOTS))", "originalCommit": "80804f421c9b90ff7c27c88d5a791b40f8ed84c9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "04318b62f285824876fe0e0a89fb2a9e51aa5bc8", "url": "https://github.com/ConsenSys/teku/commit/04318b62f285824876fe0e0a89fb2a9e51aa5bc8", "message": "review feedback.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-19T05:26:53Z", "type": "commit"}, {"oid": "3a084b0228d6951670d0a7cfbcd8dfe6f029e29a", "url": "https://github.com/ConsenSys/teku/commit/3a084b0228d6951670d0a7cfbcd8dfe6f029e29a", "message": "Merge remote-tracking branch 'upstream/master' into optimistic-sync", "committedDate": "2020-08-19T05:36:15Z", "type": "commit"}]}