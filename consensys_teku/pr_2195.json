{"pr_number": 2195, "pr_title": "Added version 4 database schema", "pr_author": "rolfyone", "pr_createdAt": "2020-06-22T23:27:40Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2195", "timeline": [{"oid": "8c1bbaa2c769c1d95d4d8b3e34b4188cb72e6345", "url": "https://github.com/ConsenSys/teku/commit/8c1bbaa2c769c1d95d4d8b3e34b4188cb72e6345", "message": "Added version 4 database schema\n\n - created a hot and finalized schema, and associated databases.\n\n - created an archive folder for the new finalized database.\n\n - added tests to show that you can create a v4 or v3 Database.\n\n - changed the hidden command line arg to accept a string, as v3 is \"3.0\"\n\n - discussed v.4 version number with Adrian, decided to use \"4\" instead of \"4.0\"\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-22T23:25:58Z", "type": "commit"}, {"oid": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "url": "https://github.com/ConsenSys/teku/commit/0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "message": "Merge remote-tracking branch 'upstream/master' into 2181", "committedDate": "2020-06-22T23:28:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4MjI4NA==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443882284", "body": "nit: I'd inline `versionOptional` and just do this on one line.", "bodyText": "nit: I'd inline versionOptional and just do this on one line.", "bodyHTML": "<p dir=\"auto\">nit: I'd inline <code>versionOptional</code> and just do this on one line.</p>", "author": "ajsutton", "createdAt": "2020-06-22T23:41:24Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -30,23 +32,38 @@\n   private static final Logger LOG = LogManager.getLogger();\n \n   @VisibleForTesting static final String DB_PATH = \"db\";\n+  @VisibleForTesting static final String ARCHIVE_PATH = \"archive\";\n   @VisibleForTesting static final String DB_VERSION_PATH = \"db.version\";\n \n   private final MetricsSystem metricsSystem;\n   private final File dataDirectory;\n   private final File dbDirectory;\n+  private final File archiveDirectory;\n   private final File dbVersionFile;\n   private final StateStorageMode stateStorageMode;\n+  private final DatabaseVersion createDatabaseVersion;\n \n   public VersionedDatabaseFactory(\n       final MetricsSystem metricsSystem,\n       final String dataPath,\n       final StateStorageMode dataStorageMode) {\n+    this(metricsSystem, dataPath, dataStorageMode, \"3.0\");\n+  }\n+\n+  public VersionedDatabaseFactory(\n+      final MetricsSystem metricsSystem,\n+      final String dataPath,\n+      final StateStorageMode dataStorageMode,\n+      final String createDatabaseVersion) {\n     this.metricsSystem = metricsSystem;\n     this.dataDirectory = Paths.get(dataPath).toFile();\n     this.dbDirectory = this.dataDirectory.toPath().resolve(DB_PATH).toFile();\n+    this.archiveDirectory = this.dataDirectory.toPath().resolve(ARCHIVE_PATH).toFile();\n     this.dbVersionFile = this.dataDirectory.toPath().resolve(DB_VERSION_PATH).toFile();\n     this.stateStorageMode = dataStorageMode;\n+\n+    Optional<DatabaseVersion> versionOptional = DatabaseVersion.fromString(createDatabaseVersion);", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4Mjc4NQ==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443882785", "body": "Probably something to follow up on later but we probably want to reduce the cache capacity and potentially other settings for the archive db since it gets used less often.", "bodyText": "Probably something to follow up on later but we probably want to reduce the cache capacity and potentially other settings for the archive db since it gets used less often.", "bodyHTML": "<p dir=\"auto\">Probably something to follow up on later but we probably want to reduce the cache capacity and potentially other settings for the archive db since it gets used less often.</p>", "author": "ajsutton", "createdAt": "2020-06-22T23:43:05Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -75,6 +104,14 @@ private Database createV3Database() {\n     return RocksDbDatabase.createV3(metricsSystem, rocksDbConfiguration, stateStorageMode);\n   }\n \n+  private Database createV4Database() {\n+    return RocksDbDatabase.createV4(\n+        metricsSystem,\n+        RocksDbConfiguration.withDataDirectory(dbDirectory.toPath()),\n+        RocksDbConfiguration.withDataDirectory(archiveDirectory.toPath()),", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzOTU1MA==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443939550", "bodyText": "#2196", "author": "rolfyone", "createdAt": "2020-06-23T03:23:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4Mjc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4MzcyOQ==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443883729", "body": "hmm, this (and the one above) should actually be:\r\n```suggestion\r\n    if (!archiveDirectory.mkdirs() && !archiveDirectory.isDirectory()) {\r\n```\r\n\r\nie try to make it and be happy as long as we wind up with a directory.  It's unlikely to matter but this way handles weird corner cases and race conditions better - plus gives a useful error message if it happens to exist as a file instead of a directory.", "bodyText": "hmm, this (and the one above) should actually be:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!archiveDirectory.exists() && !archiveDirectory.mkdirs()) {\n          \n          \n            \n                if (!archiveDirectory.mkdirs() && !archiveDirectory.isDirectory()) {\n          \n      \n    \n    \n  \n\nie try to make it and be happy as long as we wind up with a directory.  It's unlikely to matter but this way handles weird corner cases and race conditions better - plus gives a useful error message if it happens to exist as a file instead of a directory.", "bodyHTML": "<p dir=\"auto\">hmm, this (and the one above) should actually be:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>archiveDirectory<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">exists</span>() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>archiveDirectory<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">mkdirs</span>()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>archiveDirectory<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">mkdirs</span>() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>archiveDirectory<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">isDirectory</span>()) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">ie try to make it and be happy as long as we wind up with a directory.  It's unlikely to matter but this way handles weird corner cases and race conditions better - plus gives a useful error message if it happens to exist as a file instead of a directory.</p>", "author": "ajsutton", "createdAt": "2020-06-22T23:46:24Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -91,9 +128,16 @@ private void createDirectories() {\n               \"Unable to create the path to store database files at %s\",\n               dbDirectory.getAbsolutePath()));\n     }\n+    if (!archiveDirectory.exists() && !archiveDirectory.mkdirs()) {", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NDY5Nw==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443884697", "body": "Probably shouldn't be hard coding `3.0` here - `DatabaseVersion.DEFAULT_VERSION.getValue()` would work I think.", "bodyText": "Probably shouldn't be hard coding 3.0 here - DatabaseVersion.DEFAULT_VERSION.getValue() would work I think.", "bodyHTML": "<p dir=\"auto\">Probably shouldn't be hard coding <code>3.0</code> here - <code>DatabaseVersion.DEFAULT_VERSION.getValue()</code> would work I think.</p>", "author": "ajsutton", "createdAt": "2020-06-22T23:49:38Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -30,23 +32,38 @@\n   private static final Logger LOG = LogManager.getLogger();\n \n   @VisibleForTesting static final String DB_PATH = \"db\";\n+  @VisibleForTesting static final String ARCHIVE_PATH = \"archive\";\n   @VisibleForTesting static final String DB_VERSION_PATH = \"db.version\";\n \n   private final MetricsSystem metricsSystem;\n   private final File dataDirectory;\n   private final File dbDirectory;\n+  private final File archiveDirectory;\n   private final File dbVersionFile;\n   private final StateStorageMode stateStorageMode;\n+  private final DatabaseVersion createDatabaseVersion;\n \n   public VersionedDatabaseFactory(\n       final MetricsSystem metricsSystem,\n       final String dataPath,\n       final StateStorageMode dataStorageMode) {\n+    this(metricsSystem, dataPath, dataStorageMode, \"3.0\");", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NTcwNg==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443885706", "body": "```suggestion\r\n  private String createDbVersion = DatabaseVersion.DEFAULT_VERSION.getValue();\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private String createDbVersion = \"3.0\";\n          \n          \n            \n              private String createDbVersion = DatabaseVersion.DEFAULT_VERSION.getValue();", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">String</span> createDbVersion <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds x x-first\">\"</span><span class=\"x\">3.0</span><span class=\"pl-pds x x-last\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-smi\">String</span> createDbVersion <span class=\"pl-k\">=</span> <span class=\"pl-smi x x-first\">DatabaseVersion</span><span class=\"pl-c1\"><span class=\"pl-k x\">.</span><span class=\"x\">DEFAULT_VERSION</span></span><span class=\"pl-k x\">.</span><span class=\"x x-last\">getValue()</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ajsutton", "createdAt": "2020-06-22T23:53:14Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/DataOptions.java", "diffHunk": "@@ -48,9 +48,9 @@\n       paramLabel = \"<VERSION>\",\n       description = \"Database version to create (3 or 4)\",\n       arity = \"1\",\n-      defaultValue = \"3\",\n+      defaultValue = \"3.0\",\n       hidden = true)\n-  private int createDbVersion = 3;\n+  private String createDbVersion = \"3.0\";", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NTc5MA==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443885790", "body": "omit the defaultValue here - the default is taken from the assigned value.", "bodyText": "omit the defaultValue here - the default is taken from the assigned value.", "bodyHTML": "<p dir=\"auto\">omit the defaultValue here - the default is taken from the assigned value.</p>", "author": "ajsutton", "createdAt": "2020-06-22T23:53:32Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/DataOptions.java", "diffHunk": "@@ -48,9 +48,9 @@\n       paramLabel = \"<VERSION>\",\n       description = \"Database version to create (3 or 4)\",\n       arity = \"1\",\n-      defaultValue = \"3\",\n+      defaultValue = \"3.0\",", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NjI3Mg==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443886272", "body": "```suggestion\r\n      description = \"Database version to create (3.0 or 4)\",\r\n```\r\n\r\nAlthough potentially we should just make this a `DatabaseVersion` type?  Having to specify `V3` or `V4` isn't ideal but for a hidden option it would be fine and makes sure we always have a valid value.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  description = \"Database version to create (3 or 4)\",\n          \n          \n            \n                  description = \"Database version to create (3.0 or 4)\",\n          \n      \n    \n    \n  \n\nAlthough potentially we should just make this a DatabaseVersion type?  Having to specify V3 or V4 isn't ideal but for a hidden option it would be fine and makes sure we always have a valid value.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      description <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Database version to create (3 or 4)<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      description <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Database version to create (3<span class=\"x x-first x-last\">.0</span> or 4)<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Although potentially we should just make this a <code>DatabaseVersion</code> type?  Having to specify <code>V3</code> or <code>V4</code> isn't ideal but for a hidden option it would be fine and makes sure we always have a valid value.</p>", "author": "ajsutton", "createdAt": "2020-06-22T23:55:23Z", "path": "teku/src/main/java/tech/pegasys/teku/cli/options/DataOptions.java", "diffHunk": "@@ -48,9 +48,9 @@\n       paramLabel = \"<VERSION>\",\n       description = \"Database version to create (3 or 4)\",", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4NjYyNg==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443886626", "body": "`this.createDatabaseVersion` is always set to something non-null in the constructor so don't need the fallback to default here.", "bodyText": "this.createDatabaseVersion is always set to something non-null in the constructor so don't need the fallback to default here.", "bodyHTML": "<p dir=\"auto\"><code>this.createDatabaseVersion</code> is always set to something non-null in the constructor so don't need the fallback to default here.</p>", "author": "ajsutton", "createdAt": "2020-06-22T23:56:37Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/VersionedDatabaseFactory.java", "diffHunk": "@@ -107,9 +151,8 @@ private DatabaseVersion getDatabaseVersion() {\n                 \"Unable to read database version from file %s\", dbVersionFile.getAbsolutePath()),\n             e);\n       }\n-    } else {\n-      return DatabaseVersion.DEFAULT_VERSION;\n     }\n+    return Objects.requireNonNullElse(this.createDatabaseVersion, DatabaseVersion.DEFAULT_VERSION);", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4ODA0MA==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443888040", "body": "Probably not for this PR, but I wonder if when storage mode is `PRUNE` we should skip loading or creating the archive db entirely and just pass in a `StubRocksDbAccessor` here.  Then it would automatically discard archive state and we avoid the overhead of opening a second RocksDB instance that we never actually use.", "bodyText": "Probably not for this PR, but I wonder if when storage mode is PRUNE we should skip loading or creating the archive db entirely and just pass in a StubRocksDbAccessor here.  Then it would automatically discard archive state and we avoid the overhead of opening a second RocksDB instance that we never actually use.", "bodyHTML": "<p dir=\"auto\">Probably not for this PR, but I wonder if when storage mode is <code>PRUNE</code> we should skip loading or creating the archive db entirely and just pass in a <code>StubRocksDbAccessor</code> here.  Then it would automatically discard archive state and we avoid the overhead of opening a second RocksDB instance that we never actually use.</p>", "author": "ajsutton", "createdAt": "2020-06-23T00:01:27Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/RocksDbDatabase.java", "diffHunk": "@@ -65,6 +69,18 @@ public static Database createV3(\n     return createV3(metricsSystem, db, stateStorageMode);\n   }\n \n+  public static Database createV4(\n+      final MetricsSystem metricsSystem,\n+      final RocksDbConfiguration hotConfiguration,\n+      final RocksDbConfiguration finalizedConfiguration,\n+      final StateStorageMode stateStorageMode) {\n+    final RocksDbAccessor hotDb =\n+        RocksDbInstanceFactory.create(hotConfiguration, V4SchemaHot.class);\n+    final RocksDbAccessor finalizedDb =\n+        RocksDbInstanceFactory.create(finalizedConfiguration, V4SchemaFinalized.class);", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkzOTQ5Mw==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443939493", "bodyText": "#2197", "author": "rolfyone", "createdAt": "2020-06-23T03:23:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4ODA0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4ODI5NQ==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443888295", "body": "nit: this comment is redundant here.", "bodyText": "nit: this comment is redundant here.", "bodyHTML": "<p dir=\"auto\">nit: this comment is redundant here.</p>", "author": "ajsutton", "createdAt": "2020-06-23T00:02:17Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V4FinalizedRocksDbDao.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.storage.server.rocksdb.dataaccess;\n+\n+import com.google.common.primitives.UnsignedLong;\n+import java.util.Optional;\n+import org.apache.tuweni.bytes.Bytes32;\n+import tech.pegasys.teku.datastructures.blocks.SignedBeaconBlock;\n+import tech.pegasys.teku.datastructures.state.BeaconState;\n+import tech.pegasys.teku.storage.server.rocksdb.core.ColumnEntry;\n+import tech.pegasys.teku.storage.server.rocksdb.core.RocksDbAccessor;\n+import tech.pegasys.teku.storage.server.rocksdb.schema.V4SchemaFinalized;\n+\n+public class V4FinalizedRocksDbDao implements RocksDbFinalizedDao {\n+  // Persistent data", "originalCommit": "0c2a9f9eec6ee5e8981f35994853b8bd464f0e99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzkwOTY3NQ==", "url": "https://github.com/ConsenSys/teku/pull/2195#discussion_r443909675", "bodyText": "copied from V3, probably redundant there too i guess :)", "author": "rolfyone", "createdAt": "2020-06-23T01:24:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4ODI5NQ=="}], "type": "inlineReview"}, {"oid": "e680cd0dcde45898e28dda52ae48918d7a926993", "url": "https://github.com/ConsenSys/teku/commit/e680cd0dcde45898e28dda52ae48918d7a926993", "message": " - change default to v4 database\n\n - add regression tests for the new schema\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-23T01:11:25Z", "type": "commit"}, {"oid": "19ea8f289f39ffd27f1140fcb836b9a20587eb28", "url": "https://github.com/ConsenSys/teku/commit/19ea8f289f39ffd27f1140fcb836b9a20587eb28", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-23T03:15:40Z", "type": "commit"}, {"oid": "3fb2ac55dc06bd55b02b174540e3709f0a4a42cd", "url": "https://github.com/ConsenSys/teku/commit/3fb2ac55dc06bd55b02b174540e3709f0a4a42cd", "message": "review feedback\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-06-23T03:36:31Z", "type": "commit"}]}