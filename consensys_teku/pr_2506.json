{"pr_number": 2506, "pr_title": "add a network.yml file to store fork and contract address", "pr_author": "rolfyone", "pr_createdAt": "2020-08-05T02:32:32Z", "pr_url": "https://github.com/ConsenSys/teku/pull/2506", "timeline": [{"oid": "9053f4dd353e882295c40d068d8c2e9731154763", "url": "https://github.com/ConsenSys/teku/commit/9053f4dd353e882295c40d068d8c2e9731154763", "message": "add a network.yml file to store fork and contract address\n\n - on startup, if a pre-existing file exists, it is validated against the context of the current runtime\n\n - mis-matching fork or eth1 deposit contract will terminate startup.\n\n fixes #2493\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-08-05T02:31:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ0NTI1MA==", "url": "https://github.com/ConsenSys/teku/pull/2506#discussion_r465445250", "body": "nit: I'd flip this equals the other way around. We know for certain that `forkVersionString` isn't `null` but `databaseNetwork` just came from an external file.  We'll fail to start either way but it will be much more neat if we avoid `NullPointerException`.\r\n```suggestion\r\n      if (!forkVersionString.equals(databaseNetwork.forkVersion)) {\r\n```", "bodyText": "nit: I'd flip this equals the other way around. We know for certain that forkVersionString isn't null but databaseNetwork just came from an external file.  We'll fail to start either way but it will be much more neat if we avoid NullPointerException.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (!databaseNetwork.forkVersion.equals(forkVersionString)) {\n          \n          \n            \n                  if (!forkVersionString.equals(databaseNetwork.forkVersion)) {", "bodyHTML": "<p dir=\"auto\">nit: I'd flip this equals the other way around. We know for certain that <code>forkVersionString</code> isn't <code>null</code> but <code>databaseNetwork</code> just came from an external file.  We'll fail to start either way but it will be much more neat if we avoid <code>NullPointerException</code>.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span><span class=\"x x-first\">databaseNetwork</span><span class=\"pl-k x\">.</span><span class=\"x\">forkVersion</span><span class=\"pl-k x x-last\">.</span>equals(<span class=\"x x-first x-last\">forkVersionString</span>)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span><span class=\"x x-first\">forkVersionString</span><span class=\"pl-k x x-last\">.</span>equals(<span class=\"x x-first\">databaseNetwork</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">forkVersion</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ajsutton", "createdAt": "2020-08-05T03:08:43Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/network/DatabaseNetwork.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package tech.pegasys.teku.storage.server.network;\n+\n+import static com.fasterxml.jackson.dataformat.yaml.YAMLGenerator.Feature.WRITE_DOC_START_MARKER;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;\n+import com.google.common.annotations.VisibleForTesting;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Objects;\n+import tech.pegasys.teku.ssz.SSZTypes.Bytes4;\n+import tech.pegasys.teku.storage.server.DatabaseStorageException;\n+import tech.pegasys.teku.util.config.Eth1Address;\n+\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class DatabaseNetwork {\n+  @JsonProperty(\"fork_version\")\n+  @VisibleForTesting\n+  final String forkVersion;\n+\n+  @JsonProperty(\"deposit_contract\")\n+  @VisibleForTesting\n+  final String depositContract;\n+\n+  @JsonCreator\n+  DatabaseNetwork(\n+      @JsonProperty(\"fork_version\") final String forkVersion,\n+      @JsonProperty(\"deposit_contract\") final String depositContract) {\n+    this.forkVersion = forkVersion;\n+    this.depositContract = depositContract;\n+  }\n+\n+  public static DatabaseNetwork init(\n+      final File source, Bytes4 forkVersion, Eth1Address depositContract) throws IOException {\n+    final String forkVersionString = forkVersion.toHexString().toLowerCase();\n+    final String depositContractString =\n+        depositContract == null ? \"\" : depositContract.toHexString().toLowerCase();\n+    final ObjectMapper objectMapper =\n+        new ObjectMapper(new YAMLFactory().disable(WRITE_DOC_START_MARKER));\n+    if (source.exists()) {\n+      final DatabaseNetwork databaseNetwork =\n+          objectMapper.readerFor(DatabaseNetwork.class).readValue(source);\n+\n+      if (!databaseNetwork.forkVersion.equals(forkVersionString)) {", "originalCommit": "9053f4dd353e882295c40d068d8c2e9731154763", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1289a6068e12b1a6950cdf497ccd6bed727d5612", "url": "https://github.com/ConsenSys/teku/commit/1289a6068e12b1a6950cdf497ccd6bed727d5612", "message": "Update storage/src/main/java/tech/pegasys/teku/storage/server/network/DatabaseNetwork.java\n\nCo-authored-by: Adrian Sutton <adrian@symphonious.net>", "committedDate": "2020-08-05T04:00:14Z", "type": "commit"}, {"oid": "f9248ffdbd1677f5c158f36cfb6ae6f958842475", "url": "https://github.com/ConsenSys/teku/commit/f9248ffdbd1677f5c158f36cfb6ae6f958842475", "message": "Merge remote-tracking branch 'upstream/master' into 2493", "committedDate": "2020-08-05T04:00:44Z", "type": "commit"}]}