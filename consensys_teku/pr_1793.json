{"pr_number": 1793, "pr_title": "Initialize hotRootsBySlotCache on startup", "pr_author": "cemozerr", "pr_createdAt": "2020-05-15T19:14:48Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1793", "timeline": [{"oid": "91beed8e4a7768994fe458bb9f4c98705a772260", "url": "https://github.com/ConsenSys/teku/commit/91beed8e4a7768994fe458bb9f4c98705a772260", "message": "Initialize hotRootsBySlotCache on startup", "committedDate": "2020-05-15T19:02:11Z", "type": "commit"}, {"oid": "6df092128dded96890614f9f672ac4268cbfadfd", "url": "https://github.com/ConsenSys/teku/commit/6df092128dded96890614f9f672ac4268cbfadfd", "message": "Merge branch 'master' into fixDBHotRootsBySlotCacheInitialization", "committedDate": "2020-05-15T20:40:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mjc3NA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426082774", "body": "```suggestion\r\n  public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\n          \n          \n            \n              public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive</span>(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive</span>(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mbaxter", "createdAt": "2020-05-15T23:06:55Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(", "originalCommit": "6df092128dded96890614f9f672ac4268cbfadfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTI0OQ==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111249", "bodyText": "done.", "author": "cemozerr", "createdAt": "2020-05-16T03:00:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mjc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4MjgxNA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426082814", "body": "```suggestion\r\n  public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(\n          \n          \n            \n              public void shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune</span>(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">public</span> <span class=\"pl-k\">void</span> <span class=\"x x-first x-last\">shouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune</span>(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mbaxter", "createdAt": "2020-05-15T23:07:05Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -51,6 +55,18 @@ public void shouldHandleRestartWithUnrecoverableForkBlocks_prune(@TempDir final\n     testShouldHandleRestartWithUnrecoverableForkBlocks(tempDir, StateStorageMode.PRUNE);\n   }\n \n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__archive(\n+      @TempDir final Path tempDir) throws Exception {\n+    testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(tempDir, StateStorageMode.ARCHIVE);\n+  }\n+\n+  @Test\n+  public void ShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart__prune(", "originalCommit": "6df092128dded96890614f9f672ac4268cbfadfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTI4MA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111280", "bodyText": "done.", "author": "cemozerr", "createdAt": "2020-05-16T03:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4MjgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mzc4NQ==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426083785", "body": "This doesn't take a lot of time, so I don't think it's really worth logging the start / end of the cache initialization.", "bodyText": "This doesn't take a lot of time, so I don't think it's really worth logging the start / end of the cache initialization.", "bodyHTML": "<p dir=\"auto\">This doesn't take a lot of time, so I don't think it's really worth logging the start / end of the cache initialization.</p>", "author": "mbaxter", "createdAt": "2020-05-15T23:11:54Z", "path": "storage/src/main/java/tech/pegasys/teku/storage/server/rocksdb/dataaccess/V3RocksDbDao.java", "diffHunk": "@@ -173,11 +174,33 @@ private void initialize() {\n     }\n \n     LOG.info(\"Initializing hot states from hot blocks\");\n-    initializeHotStates(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n+    final Map<Bytes32, SignedBeaconBlock> prunedHotBlocks =\n+        initializeHotStatesAndBlocks(finalizedRoot.get(), finalizedState.get(), hotBlocksByRoot);\n     LOG.info(\"Finished initializing hot states from hot blocks\");\n+\n+    LOG.info(\"Adding hot roots to cache ordered by slots\");", "originalCommit": "6df092128dded96890614f9f672ac4268cbfadfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTI5NA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111294", "bodyText": "makes sense.", "author": "cemozerr", "createdAt": "2020-05-16T03:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4Mzc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDIzMg==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084232", "body": "Stale comment\r\n```suggestion\r\n```", "bodyText": "Stale comment\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Primary chain's next block is at 7", "bodyHTML": "<p dir=\"auto\">Stale comment</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">    </span><span class=\"pl-c\"><span class=\"pl-c x\">//</span><span class=\"x x-last\"> Primary chain's next block is at 7</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mbaxter", "createdAt": "2020-05-15T23:13:57Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7", "originalCommit": "6df092128dded96890614f9f672ac4268cbfadfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTM3MA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111370", "bodyText": "Thanks good spot.", "author": "cemozerr", "createdAt": "2020-05-16T03:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDIzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDM1MQ==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084351", "body": "Stale comment\r\n```suggestion\r\n```", "bodyText": "Stale comment\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Finalize at slot 15, so all the blocks before 15 would need to be pruned.", "bodyHTML": "<p dir=\"auto\">Stale comment</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">    </span><span class=\"pl-c\"><span class=\"pl-c x\">//</span><span class=\"x x-last\"> Finalize at slot 15, so all the blocks before 15 would need to be pruned.</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mbaxter", "createdAt": "2020-05-15T23:14:34Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.", "originalCommit": "6df092128dded96890614f9f672ac4268cbfadfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTYwNA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111604", "bodyText": "removed.", "author": "cemozerr", "createdAt": "2020-05-16T03:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDc4MA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426084780", "body": "Stale comment\r\n```suggestion\r\n```", "bodyText": "Stale comment\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Old states should be unavailable", "bodyHTML": "<p dir=\"auto\">Stale comment</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">    </span><span class=\"pl-c\"><span class=\"pl-c x\">//</span><span class=\"x x-last\"> Old states should be unavailable</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mbaxter", "createdAt": "2020-05-15T23:16:32Z", "path": "storage/src/test/java/tech/pegasys/teku/storage/server/rocksdb/V3RocksDbDatabaseTest.java", "diffHunk": "@@ -98,4 +114,53 @@ private void testShouldHandleRestartWithUnrecoverableForkBlocks(\n     assertStatesUnavailable(unavailableBlockRoots);\n     assertBlocksUnavailable(unavailableBlockRoots);\n   }\n+\n+  private void testShouldPruneHotBlocksOlderThanFinalizedSlotAfterRestart(\n+      @TempDir final Path tempDir, final StateStorageMode storageMode) throws Exception {\n+    // Setup chains\n+    final ChainBuilder chain = ChainBuilder.create(VALIDATOR_KEYS);\n+    final SignedBlockAndState genesis = chain.generateGenesis();\n+    // Primary chain's next block is at 7\n+    chain.generateBlocksUpToSlot(10);\n+\n+    // Setup database\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+    store = Store.getForkChoiceStore(genesis.getState());\n+    database.storeGenesis(store);\n+\n+    // Finalize at slot 15, so all the blocks before 15 would need to be pruned.\n+    add(chain.streamBlocksAndStates().collect(Collectors.toSet()));\n+\n+    // Close database and rebuild from disk\n+    database.close();\n+    database = setupDatabase(tempDir.toFile(), storageMode);\n+\n+    final Checkpoint finalizedCheckpoint = getCheckpointForBlock(chain.getBlockAtSlot(7));\n+    finalizeCheckpoint(finalizedCheckpoint);\n+\n+    // We should be able to access hot blocks and state\n+    final List<SignedBlockAndState> expectedHotBlocksAndStates =\n+        chain.streamBlocksAndStates(7, 10).collect(toList());\n+    assertHotBlocksAndStatesInclude(expectedHotBlocksAndStates);\n+\n+    // Old states should be unavailable", "originalCommit": "6df092128dded96890614f9f672ac4268cbfadfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjExMTYxMA==", "url": "https://github.com/ConsenSys/teku/pull/1793#discussion_r426111610", "bodyText": "removed.", "author": "cemozerr", "createdAt": "2020-05-16T03:05:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA4NDc4MA=="}], "type": "inlineReview"}, {"oid": "f4ef6d33bb12af282d52967f4a34388f55b71d34", "url": "https://github.com/ConsenSys/teku/commit/f4ef6d33bb12af282d52967f4a34388f55b71d34", "message": "Rename test methods & remove stale comments", "committedDate": "2020-05-16T03:04:51Z", "type": "commit"}, {"oid": "a7f6df7173907145564f57fb476238d8f04b94d0", "url": "https://github.com/ConsenSys/teku/commit/a7f6df7173907145564f57fb476238d8f04b94d0", "message": "Merge branch 'master' into fixDBHotRootsBySlotCacheInitialization", "committedDate": "2020-05-16T03:18:48Z", "type": "commit"}]}