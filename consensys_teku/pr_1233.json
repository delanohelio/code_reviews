{"pr_number": 1233, "pr_title": "Provide a configuration option for dataPath", "pr_author": "rolfyone", "pr_createdAt": "2020-02-26T21:12:36Z", "pr_url": "https://github.com/ConsenSys/teku/pull/1233", "timeline": [{"oid": "0f840c267b89703e279aef3e4b105942ad448d2a", "url": "https://github.com/ConsenSys/teku/commit/0f840c267b89703e279aef3e4b105942ad448d2a", "message": "Provide a configuration option for dataPath\n\nDatabase files are stored under dataPath/db\n\nAdded a version file to the database path, containing a database version number and initialised it to 1.0\n\nAbort startup if the database path cannot be created, or if there is a version mis-match of database version.\n\nAddresses\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>\n#1216", "committedDate": "2020-02-26T20:34:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MDA5Mg==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384790092", "body": "```suggestion\r\n    File databaseStoragePath = new File(config.getDataPath() + \"/db\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                File databaseStorage = new File(config.getDataPath() + \"/db\");\n          \n          \n            \n                File databaseStoragePath = new File(config.getDataPath() + \"/db\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-smi\">File</span> <span class=\"x x-first x-last\">databaseStorage</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">File</span>(config<span class=\"pl-k\">.</span>getDataPath() <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/db<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-smi\">File</span> <span class=\"x x-first x-last\">databaseStoragePath</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">File</span>(config<span class=\"pl-k\">.</span>getDataPath() <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/db<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "macfarla", "createdAt": "2020-02-26T21:54:01Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -36,8 +36,9 @@\n   private final EventBus eventBus;\n \n   public ChainStorageServer(EventBus eventBus, ArtemisConfiguration config) {\n+    File databaseStorage = new File(config.getDataPath() + \"/db\");", "originalCommit": "0f840c267b89703e279aef3e4b105942ad448d2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MDQyMg==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384790422", "body": "```suggestion\r\n                  \"The database version found (%s) does not match the expected version(%s).\\n\"\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                              \"The database version found (%s) does not meet the expected version(%s).\\n\"\n          \n          \n            \n                              \"The database version found (%s) does not match the expected version(%s).\\n\"", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The database version found (%s) does not <span class=\"x x-first x-last\">meet</span> the expected version(%s).<span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The database version found (%s) does not <span class=\"x x-first x-last\">match</span> the expected version(%s).<span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "macfarla", "createdAt": "2020-02-26T21:54:46Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"", "originalCommit": "0f840c267b89703e279aef3e4b105942ad448d2a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MTEyMw==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384791123", "body": "should we test a different value to \".\"", "bodyText": "should we test a different value to \".\"", "bodyHTML": "<p dir=\"auto\">should we test a different value to \".\"</p>", "author": "macfarla", "createdAt": "2020-02-26T21:56:09Z", "path": "util/src/test/java/tech/pegasys/artemis/util/config/ArtemisConfigurationTest.java", "diffHunk": "@@ -74,4 +74,16 @@ void invalidMainnetArtemisConfig() {\n     ArtemisConfiguration config = ArtemisConfiguration.fromString(\"deposit.numValidators=31\");\n     assertThrows(IllegalArgumentException.class, () -> config.validateConfig());\n   }\n+\n+  @Test\n+  void dataPathCanBeSet() {\n+    final ArtemisConfiguration config = ArtemisConfiguration.fromString(\"output.dataPath=\\\".\\\"\");\n+    assertThat(config.getDataPath()).isEqualTo(\".\");", "originalCommit": "0f840c267b89703e279aef3e4b105942ad448d2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5OTQ2NQ==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384799465", "bodyText": "apparently its all changing, so i just copied the pattern... there'd be value if we were reading a file, but this test is a bit naff, i nearly didn't bother.", "author": "rolfyone", "createdAt": "2020-02-26T22:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc5MTEyMw=="}], "type": "inlineReview"}, {"oid": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "url": "https://github.com/ConsenSys/teku/commit/4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "message": "Update storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-26T22:17:37Z", "type": "commit"}, {"oid": "1fcaa011057d35abcac60c750e075c2ae6f9ee25", "url": "https://github.com/ConsenSys/teku/commit/1fcaa011057d35abcac60c750e075c2ae6f9ee25", "message": "Merge remote-tracking branch 'upstream/master' into 1216-configurable-data-directory", "committedDate": "2020-02-26T22:18:07Z", "type": "commit"}, {"oid": "8f58ea9b073921b27568e73838d7d8ad1bdcdc2e", "url": "https://github.com/ConsenSys/teku/commit/8f58ea9b073921b27568e73838d7d8ad1bdcdc2e", "message": "Merge branch '1216-configurable-data-directory' of https://github.com/rolfyone/artemis into 1216-configurable-data-directory", "committedDate": "2020-02-26T22:19:03Z", "type": "commit"}, {"oid": "fad2064622287ee364c499ea90118f8a83728afc", "url": "https://github.com/ConsenSys/teku/commit/fad2064622287ee364c499ea90118f8a83728afc", "message": "Update storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java\n\nCo-Authored-By: Sally MacFarlane <sally.macfarlane@consensys.net>", "committedDate": "2020-02-26T22:19:44Z", "type": "commit"}, {"oid": "58a65f30ef5120770cbf4c5a2595cee45363c8cc", "url": "https://github.com/ConsenSys/teku/commit/58a65f30ef5120770cbf4c5a2595cee45363c8cc", "message": "fix rename that was done in github\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-02-26T22:20:43Z", "type": "commit"}, {"oid": "9760c7d001734c5b5ec3d6f596af56edf693a328", "url": "https://github.com/ConsenSys/teku/commit/9760c7d001734c5b5ec3d6f596af56edf693a328", "message": "Merge remote-tracking branch 'origin/1216-configurable-data-directory' into 1216-configurable-data-directory", "committedDate": "2020-02-26T22:20:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMjI5NQ==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384802295", "body": "This should just return 1 not call `System.exit`.  PicoCLI treats the returned value as the exit code.\r\n\r\nBut I'm somewhat afraid you're going to tell me it doesn't actually exit...", "bodyText": "This should just return 1 not call System.exit.  PicoCLI treats the returned value as the exit code.\nBut I'm somewhat afraid you're going to tell me it doesn't actually exit...", "bodyHTML": "<p dir=\"auto\">This should just return 1 not call <code>System.exit</code>.  PicoCLI treats the returned value as the exit code.</p>\n<p dir=\"auto\">But I'm somewhat afraid you're going to tell me it doesn't actually exit...</p>", "author": "ajsutton", "createdAt": "2020-02-26T22:19:23Z", "path": "artemis/src/main/java/tech/pegasys/artemis/BeaconNodeCommand.java", "diffHunk": "@@ -78,10 +79,14 @@ public Integer call() {\n                     node.stop();\n                   }));\n       return 0;\n+    } catch (DatabaseStorageException ex) {\n+      System.err.println(ex.getMessage());\n+      System.exit(1);", "originalCommit": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNjY3NQ==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384806675", "bodyText": "return 1 hangs and doesnt exit :)", "author": "rolfyone", "createdAt": "2020-02-26T22:28:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMjI5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzEzMw==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384803133", "body": "I was expecting that the version number would be in dataPath and then MapDB's stuff would be under `/db`. I guess that means `ChainStorageServer` would be responsible for checking the version rather than `MapDbDatabase`.  That would also fit with the idea that we might migrate from MapDb to some other storage system in the future.", "bodyText": "I was expecting that the version number would be in dataPath and then MapDB's stuff would be under /db. I guess that means ChainStorageServer would be responsible for checking the version rather than MapDbDatabase.  That would also fit with the idea that we might migrate from MapDb to some other storage system in the future.", "bodyHTML": "<p dir=\"auto\">I was expecting that the version number would be in dataPath and then MapDB's stuff would be under <code>/db</code>. I guess that means <code>ChainStorageServer</code> would be responsible for checking the version rather than <code>MapDbDatabase</code>.  That would also fit with the idea that we might migrate from MapDb to some other storage system in the future.</p>", "author": "ajsutton", "createdAt": "2020-02-26T22:21:18Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/ChainStorageServer.java", "diffHunk": "@@ -36,8 +36,9 @@\n   private final EventBus eventBus;\n \n   public ChainStorageServer(EventBus eventBus, ArtemisConfiguration config) {\n+    File databaseStoragePath = new File(config.getDataPath() + \"/db\");", "originalCommit": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1NjY0OA==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384856648", "bodyText": "will be committing this shortly, after our discussion i think this bit is resolved.", "author": "rolfyone", "createdAt": "2020-02-27T00:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwMzQ4Ng==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384803486", "body": "Seems weird to explicitly check for empty.  If this is just avoiding nulls you could just use `!VERSION.equals(ver)`.", "bodyText": "Seems weird to explicitly check for empty.  If this is just avoiding nulls you could just use !VERSION.equals(ver).", "bodyHTML": "<p dir=\"auto\">Seems weird to explicitly check for empty.  If this is just avoiding nulls you could just use <code>!VERSION.equals(ver)</code>.</p>", "author": "ajsutton", "createdAt": "2020-02-26T22:22:05Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {", "originalCommit": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDE0NQ==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804145", "body": "Would `Files.readString(databaseVersionFile.toPath()).trim()` be simpler?  Would also be slightly stricter by requiring no other content in the file rather than accepting anything that happens to have 1 on the first line.", "bodyText": "Would Files.readString(databaseVersionFile.toPath()).trim() be simpler?  Would also be slightly stricter by requiring no other content in the file rather than accepting anything that happens to have 1 on the first line.", "bodyHTML": "<p dir=\"auto\">Would <code>Files.readString(databaseVersionFile.toPath()).trim()</code> be simpler?  Would also be slightly stricter by requiring no other content in the file rather than accepting anything that happens to have 1 on the first line.</p>", "author": "ajsutton", "createdAt": "2020-02-26T22:23:21Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();", "originalCommit": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwOTg5OQ==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384809899", "bodyText": "sounds good.", "author": "rolfyone", "createdAt": "2020-02-26T22:36:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDE0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDY5MA==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804690", "body": "`Files.writeString` would be better here.  Otherwise you need to ensure the `close` is done in a finally block or use try-with-resources to ensure it gets closed even if an exception is thrown.", "bodyText": "Files.writeString would be better here.  Otherwise you need to ensure the close is done in a finally block or use try-with-resources to ensure it gets closed even if an exception is thrown.", "bodyHTML": "<p dir=\"auto\"><code>Files.writeString</code> would be better here.  Otherwise you need to ensure the <code>close</code> is done in a finally block or use try-with-resources to ensure it gets closed even if an exception is thrown.</p>", "author": "ajsutton", "createdAt": "2020-02-26T22:24:35Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"\n+                      + \"Aborting startup to prevent corruption of the database.\\n\",\n+                  ver, VERSION));\n+        }\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"The existing database is version %s, from file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+      } else {\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"Recording database version %s to file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+        FileWriter fileWriter = new FileWriter(databaseVersionFile.getPath(), UTF_8);\n+        fileWriter.write(VERSION);\n+        fileWriter.close();", "originalCommit": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDkyMw==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384804923", "body": "We should indicate which file is not found in the error message.", "bodyText": "We should indicate which file is not found in the error message.", "bodyHTML": "<p dir=\"auto\">We should indicate which file is not found in the error message.</p>", "author": "ajsutton", "createdAt": "2020-02-26T22:25:05Z", "path": "storage/src/main/java/tech/pegasys/artemis/storage/MapDbDatabase.java", "diffHunk": "@@ -67,15 +73,58 @@\n   private final ConcurrentNavigableMap<UnsignedLong, Set<Bytes32>> hotRootsBySlotCache =\n       new ConcurrentSkipListMap<>();\n \n+  private static void validateDatabaseVersion(File databaseVersionFile) {\n+    try {\n+      if (databaseVersionFile.exists()) {\n+        Scanner contents = new Scanner(databaseVersionFile, UTF_8.name());\n+        String ver = contents.nextLine();\n+        if (StringUtils.isEmpty(ver) || !ver.equals(VERSION)) {\n+          throw new DatabaseStorageException(\n+              String.format(\n+                  \"The database version found (%s) does not meet the expected version(%s).\\n\"\n+                      + \"Aborting startup to prevent corruption of the database.\\n\",\n+                  ver, VERSION));\n+        }\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"The existing database is version %s, from file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+      } else {\n+        STDOUT.log(\n+            Level.INFO,\n+            String.format(\n+                \"Recording database version %s to file: %s\",\n+                VERSION, databaseVersionFile.getAbsolutePath()));\n+        FileWriter fileWriter = new FileWriter(databaseVersionFile.getPath(), UTF_8);\n+        fileWriter.write(VERSION);\n+        fileWriter.close();\n+      }\n+    } catch (FileNotFoundException ex) {\n+      STDOUT.log(Level.ERROR, \"File not found\", ex);", "originalCommit": "4ba4f33e18ee6cef96660d045be6ce17a9b65b09", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNzc2Ng==", "url": "https://github.com/ConsenSys/teku/pull/1233#discussion_r384807766", "bodyText": "we check it exists first, it shouldn't even be possible but the code required catching the exception :/", "author": "rolfyone", "createdAt": "2020-02-26T22:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgwNDkyMw=="}], "type": "inlineReview"}, {"oid": "e945767761c5e6bc1068de5922158788cde9b9b2", "url": "https://github.com/ConsenSys/teku/commit/e945767761c5e6bc1068de5922158788cde9b9b2", "message": "changes per review comments, and break out functionality of ChainStorageServer constructor into a start function.\n\nSigned-off-by: Paul Harris <paul.harris@consensys.net>", "committedDate": "2020-02-27T01:12:58Z", "type": "commit"}, {"oid": "aaa02f0d41b3605ebe615a7ca79adef695d1395e", "url": "https://github.com/ConsenSys/teku/commit/aaa02f0d41b3605ebe615a7ca79adef695d1395e", "message": "Merge remote-tracking branch 'upstream/master' into 1216-configurable-data-directory", "committedDate": "2020-02-27T01:13:22Z", "type": "commit"}]}