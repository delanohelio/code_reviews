{"pr_number": 1381, "pr_title": "Add validation for schedule", "pr_author": "naritta", "pr_createdAt": "2020-03-24T11:40:19Z", "pr_url": "https://github.com/treasure-data/digdag/pull/1381", "timeline": [{"oid": "74c31e6b05415b969931f25aa75e297b850572a2", "url": "https://github.com/treasure-data/digdag/commit/74c31e6b05415b969931f25aa75e297b850572a2", "message": "Add validation for schedule", "committedDate": "2020-03-24T16:48:56Z", "type": "forcePushed"}, {"oid": "8114aced152532f1d521f8da30e7b578bee942b8", "url": "https://github.com/treasure-data/digdag/commit/8114aced152532f1d521f8da30e7b578bee942b8", "message": "Add validation for schedule", "committedDate": "2020-03-24T18:17:32Z", "type": "forcePushed"}, {"oid": "0aec42e2814341a110d3d2e0a7e30ad51fa60e88", "url": "https://github.com/treasure-data/digdag/commit/0aec42e2814341a110d3d2e0a7e30ad51fa60e88", "message": "Add validation for schedule", "committedDate": "2020-03-25T01:40:25Z", "type": "forcePushed"}, {"oid": "01fad80a078f12b011729622391cfbf14ec0b682", "url": "https://github.com/treasure-data/digdag/commit/01fad80a078f12b011729622391cfbf14ec0b682", "message": "Add validation for schedule", "committedDate": "2020-04-01T08:02:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzNzU5OQ==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401837599", "body": "You don't need these `if` statements. You can use following instead:\r\n```suggestion\r\n            usedKeys.add(param);\r\n```\r\n", "bodyText": "You don't need these if statements. You can use following instead:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (param.equals(\"skip_on_overtime\"))\n          \n          \n            \n                        usedKeys.add(param);", "bodyHTML": "<p dir=\"auto\">You don't need these <code>if</code> statements. You can use following instead:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k x x-first\">if</span><span class=\"x\"> (param</span><span class=\"pl-k x\">.</span><span class=\"x\">equals(</span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">skip_on_overtime</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">))</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first\">usedKeys</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">add(param);</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "frsyuki", "createdAt": "2020-04-01T18:54:25Z", "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))", "originalCommit": "01fad80a078f12b011729622391cfbf14ec0b682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3MzE1NQ==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r402473155", "bodyText": "Thanks, I fixed to use that.\ne974010", "author": "naritta", "createdAt": "2020-04-02T17:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzNzU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401841032", "body": "Throwing exception here is dangerous because:\r\n\r\n* Schedules already saved in DB might already have unused keys. Those schedules are currently running in production.\r\n* If here throws an exception, such schedules will stop working (ScheduleExecutor.runSchedule is calling SchedulerManager.getScheduler).\r\n* From user's point of view, they can't notice that their schedules have stopped (because there are no notifications). It's unexpected from the users.\r\n* From our point of view, ScheduleExecutor.runSchedule starts logging exceptions. It's not UncaughtException, but almost.\r\n\r\nSo, unused keys checking must be done only when a new workflow is uploaded. And that's good enough.\r\n", "bodyText": "Throwing exception here is dangerous because:\n\nSchedules already saved in DB might already have unused keys. Those schedules are currently running in production.\nIf here throws an exception, such schedules will stop working (ScheduleExecutor.runSchedule is calling SchedulerManager.getScheduler).\nFrom user's point of view, they can't notice that their schedules have stopped (because there are no notifications). It's unexpected from the users.\nFrom our point of view, ScheduleExecutor.runSchedule starts logging exceptions. It's not UncaughtException, but almost.\n\nSo, unused keys checking must be done only when a new workflow is uploaded. And that's good enough.", "bodyHTML": "<p dir=\"auto\">Throwing exception here is dangerous because:</p>\n<ul dir=\"auto\">\n<li>Schedules already saved in DB might already have unused keys. Those schedules are currently running in production.</li>\n<li>If here throws an exception, such schedules will stop working (ScheduleExecutor.runSchedule is calling SchedulerManager.getScheduler).</li>\n<li>From user's point of view, they can't notice that their schedules have stopped (because there are no notifications). It's unexpected from the users.</li>\n<li>From our point of view, ScheduleExecutor.runSchedule starts logging exceptions. It's not UncaughtException, but almost.</li>\n</ul>\n<p dir=\"auto\">So, unused keys checking must be done only when a new workflow is uploaded. And that's good enough.</p>", "author": "frsyuki", "createdAt": "2020-04-01T19:00:12Z", "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +94,47 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            if (param.equals(\"skip_on_overtime\"))\n+                c.get(\"skip_on_overtime\", boolean.class, false);\n+            else if (param.equals(\"skip_delayed_by\"))\n+                c.getOptional(\"skip_delayed_by\", DurationParam.class);\n+        }\n+\n         SchedulerFactory factory = types.get(type);\n         if (factory == null) {\n             throw new ConfigException(\"Unknown scheduler type: \" + type);\n         }\n+\n+        if (!usedKeys.isAllUsed()) {\n+            shouldBeUsedKeys.removeAll(usedKeys);\n+            if (!shouldBeUsedKeys.isEmpty()) {\n+                warnUnusedKeys(shouldBeUsedKeys, usedKeys);\n+            }\n+        }\n+\n         return factory.newScheduler(c, workflowTimeZone);\n     }\n+\n+    private void warnUnusedKeys(Set<String> shouldBeUsedButNotUsedKeys, Collection<String> candidateKeys)\n+    {\n+        // throw for only first unused key\n+        for (String key : shouldBeUsedButNotUsedKeys) {\n+            StringBuilder buf = new StringBuilder();\n+            buf.append(\"Parameter '\");\n+            buf.append(key);\n+            buf.append(\"' is not used at schedule. \");\n+\n+            List<String> suggestions = EditDistance.suggest(key, candidateKeys, 0.50);\n+            if (suggestions.isEmpty()) {\n+                throw new ConfigException(buf.toString());\n+            }\n+            else {\n+                buf.append(\"> Did you mean '\");\n+                buf.append(suggestions);\n+                buf.append(\"'\");\n+                throw new ConfigException(buf.toString());", "originalCommit": "01fad80a078f12b011729622391cfbf14ec0b682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MzM3Nw==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401843377", "bodyText": "To make it possible, unused keys checking in this getScheduler method needs to be optional.\nA possible way is adding boolean checkUnusedKeys argument to this getScheduler method. Alternative way is adding Optional<Consumer<Map<String, List<String>>>> unusedKeysCallback argument to this getScheduler method (do the unused keys checking if unusedKeysCallback.isPresent()).\nEither way works. boolean checkUnusedKeys is simple but can't tell whether a ConfigException is thrown due to unused keys or due to other reasons. Optional<Consumer<...>> can distinguish them but more complicated.", "author": "frsyuki", "createdAt": "2020-04-01T19:04:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0NDkyMw==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401844923", "bodyText": "Another way I came up right now is adding a class like UnusedConfigExceptions extends ConfigException.\n...either way works.", "author": "frsyuki", "createdAt": "2020-04-01T19:07:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3Mjg3Ng==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r402472876", "bodyText": "I fixed to use unusedKeysCallback and UnusedConfigExceptions, but it seems like same as boolean checkUnusedKeys, so sorry if I'm misunderstanding your intension.\ndb6f943", "author": "naritta", "createdAt": "2020-04-02T17:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0MTAzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODM3Nw==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401848377", "body": "can you add some more tests?:\r\n* A test that verifies REST API response code. I think API response code should be 400 (same with ModelValidationException and IllegalArgumentException) or 422. It's very bad if it's 5xx. If API response code is unexpected, additional code will be necessary around ProjectResource.validateWorkflowAndSchedule.\r\n* what if unknown scheduler type is set (like `no_such_scheduler>: abc`)\r\n", "bodyText": "can you add some more tests?:\n\nA test that verifies REST API response code. I think API response code should be 400 (same with ModelValidationException and IllegalArgumentException) or 422. It's very bad if it's 5xx. If API response code is unexpected, additional code will be necessary around ProjectResource.validateWorkflowAndSchedule.\nwhat if unknown scheduler type is set (like no_such_scheduler>: abc)", "bodyHTML": "<p dir=\"auto\">can you add some more tests?:</p>\n<ul dir=\"auto\">\n<li>A test that verifies REST API response code. I think API response code should be 400 (same with ModelValidationException and IllegalArgumentException) or 422. It's very bad if it's 5xx. If API response code is unexpected, additional code will be necessary around ProjectResource.validateWorkflowAndSchedule.</li>\n<li>what if unknown scheduler type is set (like <code>no_such_scheduler&gt;: abc</code>)</li>\n</ul>", "author": "frsyuki", "createdAt": "2020-04-01T19:13:23Z", "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +44,30 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'skip_on_over_time' is not used at schedule. > Did you mean '[skip_on_overtime]'\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testInvalidOpScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid_op.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'wrong>' is not used at schedule.\"));\n+        }\n+    }", "originalCommit": "01fad80a078f12b011729622391cfbf14ec0b682", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTE0Nw==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r401851147", "bodyText": "you can copy testing mechanism from ServerErrorStatusCodeIT to this SchedulerIT.", "author": "frsyuki", "createdAt": "2020-04-01T19:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODM3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwMjEyMA==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404202120", "bodyText": "I added tests for them here.\ncca6e1f", "author": "naritta", "createdAt": "2020-04-06T15:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0ODM3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgyNTkzMw==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r402825933", "body": "if we throw UnusedConfigException, this doesn't have to be a callback. A boolean flag is good enough.\r\nCallback is useful if ProjectResource.putProject creates a callback object because ProjectResource.putProject can decide the type of the exception class to throw.\r\nI think boolean flag is good enough.", "bodyText": "if we throw UnusedConfigException, this doesn't have to be a callback. A boolean flag is good enough.\nCallback is useful if ProjectResource.putProject creates a callback object because ProjectResource.putProject can decide the type of the exception class to throw.\nI think boolean flag is good enough.", "bodyHTML": "<p dir=\"auto\">if we throw UnusedConfigException, this doesn't have to be a callback. A boolean flag is good enough.<br>\nCallback is useful if ProjectResource.putProject creates a callback object because ProjectResource.putProject can decide the type of the exception class to throw.<br>\nI think boolean flag is good enough.</p>", "author": "frsyuki", "createdAt": "2020-04-03T08:23:21Z", "path": "digdag-core/src/main/java/io/digdag/core/repository/ProjectControl.java", "diffHunk": "@@ -101,7 +103,7 @@ private void updateSchedules(\n     {\n         ImmutableList.Builder<ScheduleWithScheduler> schedules = ImmutableList.builder();\n         for (StoredWorkflowDefinition def : defs) {\n-            Optional<Scheduler> sr = srm.tryGetScheduler(revision, def);\n+            Optional<Scheduler> sr = srm.tryGetScheduler(revision, def, Optional.of(getUnusedKeysCallback()));", "originalCommit": "db6f9434eea7980ff8fafdc3da1f04ac5359ab3b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIwMjczOQ==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404202739", "bodyText": "I see, thanks, then I fixed to use boolean for that.\n74d9f4e", "author": "naritta", "createdAt": "2020-04-06T15:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjgyNTkzMw=="}], "type": "inlineReview"}, {"oid": "74d9f4e42d7cbbcf8f163dce4edb3d361bd68a5b", "url": "https://github.com/treasure-data/digdag/commit/74d9f4e42d7cbbcf8f163dce4edb3d361bd68a5b", "message": "Fix to use boolean to decide if it throw or not", "committedDate": "2020-04-06T06:31:39Z", "type": "forcePushed"}, {"oid": "cca6e1f7ee3f7507b0948448ae5212676acf0e19", "url": "https://github.com/treasure-data/digdag/commit/cca6e1f7ee3f7507b0948448ae5212676acf0e19", "message": "Add tests for checking response code and unknow scheduler type", "committedDate": "2020-04-06T15:54:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzNTg0Ng==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404335846", "body": "```suggestion\r\n        }\r\n        catch (Throwable ie) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Throwable ie) {\n          \n          \n            \n                    }\n          \n          \n            \n                    catch (Throwable ie) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }<span class=\"x x-first\"> </span><span class=\"pl-k x\">catch</span><span class=\"x\"> (</span><span class=\"pl-smi x\">Throwable</span><span class=\"x x-last\"> ie) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">Throwable</span> ie) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "frsyuki", "createdAt": "2020-04-06T19:29:52Z", "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +54,71 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {", "originalCommit": "cca6e1f7ee3f7507b0948448ae5212676acf0e19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzNTkyMQ==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404335921", "body": "```suggestion\r\n        }\r\n        catch (Throwable ie) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Throwable ie) {\n          \n          \n            \n                    }\n          \n          \n            \n                    catch (Throwable ie) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }<span class=\"x x-first\"> </span><span class=\"pl-k x\">catch</span><span class=\"x\"> (</span><span class=\"pl-smi x\">Throwable</span><span class=\"x x-last\"> ie) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">Throwable</span> ie) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "frsyuki", "createdAt": "2020-04-06T19:30:00Z", "path": "digdag-tests/src/test/java/acceptance/SchedulerIT.java", "diffHunk": "@@ -42,4 +54,71 @@ public void testScheduler()\n         }\n         assertTrue(false);\n     }\n+\n+    @Test\n+    public void testInvalidScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {\n+            assertThat(ie.getCause().getCause().toString(), Matchers.containsString(\"Parameter 'skip_on_over_time' is not used at schedule. > Did you mean '[skip_on_overtime]'\"));\n+        }\n+    }\n+\n+    @Test\n+    public void testInvalidOpScheduler()\n+            throws Exception\n+    {\n+        try {\n+            copyResource(\"acceptance/scheduler/invalid_op.dig\", root().resolve(\"test.dig\"));\n+            main(\"scheduler\", \"--project\", root().toString());\n+            fail();\n+        } catch (Throwable ie) {", "originalCommit": "cca6e1f7ee3f7507b0948448ae5212676acf0e19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzODA4NQ==", "url": "https://github.com/treasure-data/digdag/pull/1381#discussion_r404338085", "body": "Showing logging in this loop is good (it's consistent with OperatorManager) but throwing exception has a downside. Because throwing an exception will leave from this loop, users can know only one unused key at a time.\r\nHow about moving `throw` before the loop if `throwUnusedKeys` is set? We can concatenate messages of `getWarnUnusedKey` with `\\n` as the message of UnusedConfigException.", "bodyText": "Showing logging in this loop is good (it's consistent with OperatorManager) but throwing exception has a downside. Because throwing an exception will leave from this loop, users can know only one unused key at a time.\nHow about moving throw before the loop if throwUnusedKeys is set? We can concatenate messages of getWarnUnusedKey with \\n as the message of UnusedConfigException.", "bodyHTML": "<p dir=\"auto\">Showing logging in this loop is good (it's consistent with OperatorManager) but throwing exception has a downside. Because throwing an exception will leave from this loop, users can know only one unused key at a time.<br>\nHow about moving <code>throw</code> before the loop if <code>throwUnusedKeys</code> is set? We can concatenate messages of <code>getWarnUnusedKey</code> with <code>\\n</code> as the message of UnusedConfigException.</p>", "author": "frsyuki", "createdAt": "2020-04-06T19:33:50Z", "path": "digdag-core/src/main/java/io/digdag/core/schedule/SchedulerManager.java", "diffHunk": "@@ -82,10 +114,44 @@ private Scheduler getScheduler(Config schedulerConfig, ZoneId workflowTimeZone)\n             c.set(\"_command\", command);\n         }\n \n+        for(String param : BUILT_IN_SCHEDULE_PARAMS){\n+            usedKeys.add(param);\n+        }\n+\n         SchedulerFactory factory = types.get(type);\n         if (factory == null) {\n             throw new ConfigException(\"Unknown scheduler type: \" + type);\n         }\n+\n+        if (!usedKeys.isAllUsed()) {\n+            shouldBeUsedKeys.removeAll(usedKeys);\n+            if (!shouldBeUsedKeys.isEmpty()) {\n+                for (String key: shouldBeUsedKeys) {\n+                    if (throwUnusedKeys)\n+                        throw new UnusedConfigException(getWarnUnusedKey(key, usedKeys));", "originalCommit": "cca6e1f7ee3f7507b0948448ae5212676acf0e19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2093a76bd8c3cc6fec4e56ee1629eba822dba1e3", "url": "https://github.com/treasure-data/digdag/commit/2093a76bd8c3cc6fec4e56ee1629eba822dba1e3", "message": "Add validation for schedule", "committedDate": "2020-04-07T03:30:09Z", "type": "commit"}, {"oid": "2093a76bd8c3cc6fec4e56ee1629eba822dba1e3", "url": "https://github.com/treasure-data/digdag/commit/2093a76bd8c3cc6fec4e56ee1629eba822dba1e3", "message": "Add validation for schedule", "committedDate": "2020-04-07T03:30:09Z", "type": "forcePushed"}]}