{"pr_number": 116, "pr_title": "Deployment integ tests", "pr_author": "abanthiy", "pr_createdAt": "2020-03-16T20:51:01Z", "pr_url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNTcwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393305703", "body": "Can you adjust your copyright to remove the extra `*`?", "bodyText": "Can you adjust your copyright to remove the extra *?", "bodyHTML": "<p dir=\"auto\">Can you adjust your copyright to remove the extra <code>*</code>?</p>", "author": "MikeDombo", "createdAt": "2020-03-16T20:56:27Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  * SPDX-License-Identifier: Apache-2.0", "originalCommit": "b665837ba0c3e73c80741a6d352083e66ae8a6a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM4MDA4NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393380085", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-17T00:20:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNTcwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNjI5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393306295", "body": "Let's no do this. @JamesGosling  just added a log watcher replacement into the SDK, so use that instead of reading from the log file.", "bodyText": "Let's no do this. @JamesGosling  just added a log watcher replacement into the SDK, so use that instead of reading from the log file.", "bodyHTML": "<p dir=\"auto\">Let's no do this. <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/JamesGosling/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/JamesGosling\">@JamesGosling</a>  just added a log watcher replacement into the SDK, so use that instead of reading from the log file.</p>", "author": "MikeDombo", "createdAt": "2020-03-16T20:57:33Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    static ObjectMapper OBJECT_MAPPER = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    static Logger logger;\n+    static final String LogFileName = \"deploymentIntegTest.log\";\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    DeploymentDocument sampleDeploymentDocument;\n+    Kernel kernel;\n+\n+    @BeforeAll\n+    static void setupLogFile() {\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        System.setProperty(\"log.storeName\", LogFileName);\n+        System.setProperty(\"log.store\", \"FILE\");\n+        System.setProperty(\"log.level\", \"INFO\");\n+        try {\n+            Files.deleteIfExists(Paths.get(LogFileName));", "originalCommit": "b665837ba0c3e73c80741a6d352083e66ae8a6a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM4MDA2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393380068", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-17T00:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNjI5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNjQ0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393306448", "body": "Don't catch and then fail, just let the method throw.", "bodyText": "Don't catch and then fail, just let the method throw.", "bodyHTML": "<p dir=\"auto\">Don't catch and then fail, just let the method throw.</p>", "author": "MikeDombo", "createdAt": "2020-03-16T20:57:51Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    static ObjectMapper OBJECT_MAPPER = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    static Logger logger;\n+    static final String LogFileName = \"deploymentIntegTest.log\";\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    DeploymentDocument sampleDeploymentDocument;\n+    Kernel kernel;\n+\n+    @BeforeAll\n+    static void setupLogFile() {\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        System.setProperty(\"log.storeName\", LogFileName);\n+        System.setProperty(\"log.store\", \"FILE\");\n+        System.setProperty(\"log.level\", \"INFO\");\n+        try {\n+            Files.deleteIfExists(Paths.get(LogFileName));\n+            Files.createFile(Paths.get(LogFileName));\n+            logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+        } catch (IOException e) {\n+            fail(\"Failed to create log file\", e);\n+        }\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        try {\n+            Files.deleteIfExists(Paths.get(LogFileName));\n+        } catch (IOException e) {\n+            fail(\"Failed to delete log file\", e);\n+        }\n+    }\n+\n+    @BeforeEach\n+    public void setupKernelAndLogFile() {\n+\n+        try {\n+            String tdir = System.getProperty(\"user.home\");\n+            kernel = new Kernel();\n+            kernel.parseArgs(\"-r\", tdir, \"-log\", \"stdout\", \"-i\",\n+                    DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+            kernel.launch();\n+            dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+            packageCache = new PackageCache();\n+            kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+\n+            File fileToWatch = new File(LogFileName);\n+            while (!fileToWatch.exists()) {\n+                Thread.sleep(1000);\n+            }\n+        } catch(Exception e) {\n+            fail(\"Caught exception while setting up test\");", "originalCommit": "b665837ba0c3e73c80741a6d352083e66ae8a6a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM4MDQ3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393380475", "bodyText": "Removed the file handling code", "author": "abanthiy", "createdAt": "2020-03-17T00:21:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNjQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNjc3Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393306772", "body": "Update this to use `@TempDir` instead of user.home and remove the `-log stdout` since that doesn't apply anymore.", "bodyText": "Update this to use @TempDir instead of user.home and remove the -log stdout since that doesn't apply anymore.", "bodyHTML": "<p dir=\"auto\">Update this to use <code>@TempDir</code> instead of user.home and remove the <code>-log stdout</code> since that doesn't apply anymore.</p>", "author": "MikeDombo", "createdAt": "2020-03-16T20:58:26Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    static ObjectMapper OBJECT_MAPPER = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    static Logger logger;\n+    static final String LogFileName = \"deploymentIntegTest.log\";\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    DeploymentDocument sampleDeploymentDocument;\n+    Kernel kernel;\n+\n+    @BeforeAll\n+    static void setupLogFile() {\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        System.setProperty(\"log.storeName\", LogFileName);\n+        System.setProperty(\"log.store\", \"FILE\");\n+        System.setProperty(\"log.level\", \"INFO\");\n+        try {\n+            Files.deleteIfExists(Paths.get(LogFileName));\n+            Files.createFile(Paths.get(LogFileName));\n+            logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+        } catch (IOException e) {\n+            fail(\"Failed to create log file\", e);\n+        }\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        try {\n+            Files.deleteIfExists(Paths.get(LogFileName));\n+        } catch (IOException e) {\n+            fail(\"Failed to delete log file\", e);\n+        }\n+    }\n+\n+    @BeforeEach\n+    public void setupKernelAndLogFile() {\n+\n+        try {\n+            String tdir = System.getProperty(\"user.home\");\n+            kernel = new Kernel();\n+            kernel.parseArgs(\"-r\", tdir, \"-log\", \"stdout\", \"-i\",", "originalCommit": "b665837ba0c3e73c80741a6d352083e66ae8a6a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzkzNjIxNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393936217", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-17T20:02:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNjc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNzQwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393307400", "body": "Can we put in the order now? The ordering should be accurate, though if you're looking at the command outputs, they may not be ordered. What is guaranteed is the state transition order, not necessarily the command execution order.", "bodyText": "Can we put in the order now? The ordering should be accurate, though if you're looking at the command outputs, they may not be ordered. What is guaranteed is the state transition order, not necessarily the command execution order.", "bodyHTML": "<p dir=\"auto\">Can we put in the order now? The ordering should be accurate, though if you're looking at the command outputs, they may not be ordered. What is guaranteed is the state transition order, not necessarily the command execution order.</p>", "author": "MikeDombo", "createdAt": "2020-03-16T20:59:38Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *  * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    static ObjectMapper OBJECT_MAPPER = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    static Logger logger;\n+    static final String LogFileName = \"deploymentIntegTest.log\";\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    DeploymentDocument sampleDeploymentDocument;\n+    Kernel kernel;\n+\n+    @BeforeAll\n+    static void setupLogFile() {\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        System.setProperty(\"log.storeName\", LogFileName);\n+        System.setProperty(\"log.store\", \"FILE\");\n+        System.setProperty(\"log.level\", \"INFO\");\n+        try {\n+            Files.deleteIfExists(Paths.get(LogFileName));\n+            Files.createFile(Paths.get(LogFileName));\n+            logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+        } catch (IOException e) {\n+            fail(\"Failed to create log file\", e);\n+        }\n+    }\n+\n+    @AfterAll\n+    static void cleanup() {\n+        try {\n+            Files.deleteIfExists(Paths.get(LogFileName));\n+        } catch (IOException e) {\n+            fail(\"Failed to delete log file\", e);\n+        }\n+    }\n+\n+    @BeforeEach\n+    public void setupKernelAndLogFile() {\n+\n+        try {\n+            String tdir = System.getProperty(\"user.home\");\n+            kernel = new Kernel();\n+            kernel.parseArgs(\"-r\", tdir, \"-log\", \"stdout\", \"-i\",\n+                    DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+            kernel.launch();\n+            dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+            packageCache = new PackageCache();\n+            kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+\n+            File fileToWatch = new File(LogFileName);\n+            while (!fileToWatch.exists()) {\n+                Thread.sleep(1000);\n+            }\n+        } catch(Exception e) {\n+            fail(\"Caught exception while setting up test\");\n+        }\n+    }\n+\n+    @Test\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI());\n+\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the deployment task\", e.getCause());\n+        }\n+        String logLines = new String(Files.readAllBytes(Paths.get(LogFileName)));\n+        int tickTokLogStringIndex = logLines.indexOf(TEST_TICK_TOCK_STRING);\n+        int mosquittoLogStringIndex = logLines.indexOf(TEST_MOSQUITTO_STRING);\n+        int customerAppLogStringIndex = logLines.indexOf(TEST_CUSTOMER_APP_STRING);\n+        assertTrue(tickTokLogStringIndex != -1);\n+        assertTrue(mosquittoLogStringIndex != -1);\n+        assertTrue(customerAppLogStringIndex != -1);\n+        //TODO: Check the order of indexes as per dependency", "originalCommit": "b665837ba0c3e73c80741a6d352083e66ae8a6a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMxNjQ3Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393316476", "bodyText": "As a customer I don't want to go into finding the internal kernel logs. I should be testing only using what I expect from my applications. After adding listeners, I am not using timestamps in logs to verify this.", "author": "abanthiy", "createdAt": "2020-03-16T21:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNzQwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM4MjMwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393382309", "bodyText": "My point was that I know you removed order checking because it was failing. I believe this may have occurred because of what I describe here, but that's only a guess since I don't know what you implemented or what errors you were seeing.", "author": "MikeDombo", "createdAt": "2020-03-17T00:29:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwNzQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwODgzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393308839", "body": "handling? If we're not handling it we should be rethrowing it.", "bodyText": "handling? If we're not handling it we should be rethrowing it.", "bodyHTML": "<p dir=\"auto\">handling? If we're not handling it we should be rethrowing it.</p>", "author": "MikeDombo", "createdAt": "2020-03-16T21:02:51Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageCache.java", "diffHunk": "@@ -1,31 +1,55 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.aws.iot.evergreen.packagemanager.exceptions.PackagingException;\n import com.aws.iot.evergreen.packagemanager.models.Package;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n \n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.Future;\n \n public class PackageCache {\n \n+    private static final Path LOCAL_CACHE_PATH =\n+            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n     /**\n      * Make sure all the specified packages exist in the package cache. Download them from remote repository if\n      * they don't exist.\n+     *\n      * @param pkgs a list of packages.\n      * @return a future to notify once this is finished.\n      */\n+    @SuppressFBWarnings(value = \"NP_NONNULL_PARAM_VIOLATION\", justification = \"Waiting for package cache \"\n+            + \"implementation to be completed\")\n     public Future<Void> preparePackages(List<PackageIdentifier> pkgs) {\n         // TODO: to be implemented.\n-        return null;\n+        CompletableFuture<Void> completableFuture = new CompletableFuture<>();\n+        completableFuture.complete(null);\n+        return completableFuture;\n     }\n \n     /**\n      * Retrieve the recipe of a package.\n+     *\n      * @param pkg package identifier\n      * @return package recipe\n      */\n     public Package getRecipe(PackageIdentifier pkg) {\n         // TODO: to be implemented.\n+        LocalPackageStore localPackageStore = new LocalPackageStore(LOCAL_CACHE_PATH);\n+        try {\n+            return localPackageStore.getPackage(pkg.getName(), pkg.getVersion()).get();\n+        } catch (PackagingException e) {\n+            e.printStackTrace();", "originalCommit": "b665837ba0c3e73c80741a6d352083e66ae8a6a3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMxNDEwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393314105", "bodyText": "This should be redone as part of package cache implementation.", "author": "abanthiy", "createdAt": "2020-03-16T21:14:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMwODgzOQ=="}], "type": "inlineReview"}, {"oid": "6090b0462f67f02d924cd23861ae0107feb89104", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/6090b0462f67f02d924cd23861ae0107feb89104", "message": "Addressing review comments. Adding listener to logger in integration tests", "committedDate": "2020-03-17T06:19:54Z", "type": "forcePushed"}, {"oid": "2e7b577c640ae179f5e82d1e37adda7921863c0b", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/2e7b577c640ae179f5e82d1e37adda7921863c0b", "message": "Fixing Mosquitto recipe for ubuntu", "committedDate": "2020-03-17T20:46:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDcwMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394004700", "body": "use hamcrest contain here to get a better error.", "bodyText": "use hamcrest contain here to get a better error.", "bodyHTML": "<p dir=\"auto\">use hamcrest contain here to get a better error.</p>", "author": "MikeDombo", "createdAt": "2020-03-17T22:23:14Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.Log4jLoggerAdapter;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() throws InterruptedException {\n+        //Cannot use @TempDir since it does not work with static variables\n+        String tempRootDir = \"~/deploymentIntegTest\";\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir, \"-i\",\n+                DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+        kernel.launch();\n+        dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+        packageCache = new PackageCache();\n+        kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+    }\n+\n+    @AfterAll\n+    public static void tearDown() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        final List<String> listOfExpectedMessages = Arrays.asList(TEST_TICK_TOCK_STRING, TEST_MOSQUITTO_STRING,\n+                TEST_CUSTOMER_APP_STRING);\n+        countDownLatch = new CountDownLatch(3);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && listOfExpectedMessages.contains(messageOnStdout)) {\n+                if(!outputMessagesToTimestamp.containsKey(messageOnStdout)) {\n+                    outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                    countDownLatch.countDown();\n+                }\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI());\n+\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the deployment task\", e.getCause());\n+        }\n+\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        Set<String> listOfStdoutMessagesTapped = outputMessagesToTimestamp.keySet();\n+        assertTrue(listOfStdoutMessagesTapped.containsAll(listOfExpectedMessages));", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDkyMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394004921", "body": "there ought to be a hamcrest matcher for less than also, again for better error messages.", "bodyText": "there ought to be a hamcrest matcher for less than also, again for better error messages.", "bodyHTML": "<p dir=\"auto\">there ought to be a hamcrest matcher for less than also, again for better error messages.</p>", "author": "MikeDombo", "createdAt": "2020-03-17T22:23:42Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.Log4jLoggerAdapter;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() throws InterruptedException {\n+        //Cannot use @TempDir since it does not work with static variables\n+        String tempRootDir = \"~/deploymentIntegTest\";\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir, \"-i\",\n+                DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+        kernel.launch();\n+        dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+        packageCache = new PackageCache();\n+        kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+    }\n+\n+    @AfterAll\n+    public static void tearDown() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        final List<String> listOfExpectedMessages = Arrays.asList(TEST_TICK_TOCK_STRING, TEST_MOSQUITTO_STRING,\n+                TEST_CUSTOMER_APP_STRING);\n+        countDownLatch = new CountDownLatch(3);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && listOfExpectedMessages.contains(messageOnStdout)) {\n+                if(!outputMessagesToTimestamp.containsKey(messageOnStdout)) {\n+                    outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                    countDownLatch.countDown();\n+                }\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI());\n+\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the deployment task\", e.getCause());\n+        }\n+\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        Set<String> listOfStdoutMessagesTapped = outputMessagesToTimestamp.keySet();\n+        assertTrue(listOfStdoutMessagesTapped.containsAll(listOfExpectedMessages));\n+        assertTrue(outputMessagesToTimestamp.get(TEST_TICK_TOCK_STRING) <", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NDMwNA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394054304", "bodyText": "The timestamp of the logs are not a consistent way of ensuring the order so I am removing this check for now.", "author": "abanthiy", "createdAt": "2020-03-18T01:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNDkyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5NTU5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393995592", "body": "I don't get this one. Doesn't this work?\r\n```\r\n@TempDir\r\nstatic Path sharedTempDir;\r\n```", "bodyText": "I don't get this one. Doesn't this work?\n@TempDir\nstatic Path sharedTempDir;", "bodyHTML": "<p dir=\"auto\">I don't get this one. Doesn't this work?</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"@TempDir\nstatic Path sharedTempDir;\n\"><pre><code>@TempDir\nstatic Path sharedTempDir;\n</code></pre></div>", "author": "fengwang666", "createdAt": "2020-03-17T22:00:33Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.Log4jLoggerAdapter;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() throws InterruptedException {\n+        //Cannot use @TempDir since it does not work with static variables", "originalCommit": "2e7b577c640ae179f5e82d1e37adda7921863c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAxMzk3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394013973", "bodyText": "I misunderstood the error. This works.", "author": "abanthiy", "createdAt": "2020-03-17T22:45:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5NTU5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNzM1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394027351", "bodyText": "This will work, but we can let it go for now. My blocked PR will take care of it!", "author": "leaf94", "createdAt": "2020-03-17T23:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5NTU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5OTY1Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r393999657", "body": "This doesn't look like a real end-to-end test? Why not use `DeploymentService`?", "bodyText": "This doesn't look like a real end-to-end test? Why not use DeploymentService?", "bodyHTML": "<p dir=\"auto\">This doesn't look like a real end-to-end test? Why not use <code>DeploymentService</code>?</p>", "author": "fengwang666", "createdAt": "2020-03-17T22:10:33Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.Log4jLoggerAdapter;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() throws InterruptedException {\n+        //Cannot use @TempDir since it does not work with static variables\n+        String tempRootDir = \"~/deploymentIntegTest\";\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir, \"-i\",\n+                DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+        kernel.launch();\n+        dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+        packageCache = new PackageCache();\n+        kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+    }\n+\n+    @AfterAll\n+    public static void tearDown() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        final List<String> listOfExpectedMessages = Arrays.asList(TEST_TICK_TOCK_STRING, TEST_MOSQUITTO_STRING,\n+                TEST_CUSTOMER_APP_STRING);\n+        countDownLatch = new CountDownLatch(3);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && listOfExpectedMessages.contains(messageOnStdout)) {\n+                if(!outputMessagesToTimestamp.containsKey(messageOnStdout)) {\n+                    outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                    countDownLatch.countDown();\n+                }\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI());\n+\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the deployment task\", e.getCause());\n+        }\n+\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        Set<String> listOfStdoutMessagesTapped = outputMessagesToTimestamp.keySet();\n+        assertTrue(listOfStdoutMessagesTapped.containsAll(listOfExpectedMessages));\n+        assertTrue(outputMessagesToTimestamp.get(TEST_TICK_TOCK_STRING) <\n+                outputMessagesToTimestamp.get(TEST_MOSQUITTO_STRING));\n+        assertTrue(outputMessagesToTimestamp.get(TEST_MOSQUITTO_STRING) <\n+                outputMessagesToTimestamp.get(TEST_CUSTOMER_APP_STRING));\n+        Log4jLogEventBuilder.removeGlobalListener(listener);\n+    }\n+\n+    @Test\n+    @Order(2)\n+    public void GIVEN_services_running_WHEN_updated_params_THEN_services_start_with_updated_params_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        countDownLatch = new CountDownLatch(1);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && messageOnStdout.equals(TEST_CUSTOMER_APP_STRING_UPDATED)) {\n+                outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                countDownLatch.countDown();\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument_updated.json\").toURI());\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the updated deployment task\", e.getCause());\n+        }\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        assertTrue(outputMessagesToTimestamp.containsKey(TEST_CUSTOMER_APP_STRING_UPDATED));\n+        Log4jLogEventBuilder.removeGlobalListener(listener);\n+    }\n+\n+    private Future<?> submitSampleJobDocument(URI uri) {\n+\n+        try {\n+            sampleDeploymentDocument = OBJECT_MAPPER.readValue(new File(uri), DeploymentDocument.class);\n+        } catch (Exception e) {\n+            fail(\"Failed to create Deployment document object from sample job document\", e.getCause());\n+        }\n+        sampleDeploymentDocument.setTimestamp(System.currentTimeMillis());\n+        DeploymentTask deploymentTask = new DeploymentTask(dependencyResolver, packageCache, kernelConfigResolver,", "originalCommit": "2e7b577c640ae179f5e82d1e37adda7921863c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyMjQ4Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394022486", "bodyText": "This is not end to end. It is integration test which is operating on component level testing. Deployment service calls the deployment task in an async notification handler. Invoking that handler will require mocking. And I was trying to avoid mocking in these tests. Writing end to end is a separate task and calling Deployment Servic should be covered there.", "author": "abanthiy", "createdAt": "2020-03-17T23:10:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk5OTY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMTIwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394001208", "body": "Why log twice? Also usually we don't log and throw to prevent duplicate messages. If the code already throws, we can assume the caller will handle it properly (which might include logging).", "bodyText": "Why log twice? Also usually we don't log and throw to prevent duplicate messages. If the code already throws, we can assume the caller will handle it properly (which might include logging).", "bodyHTML": "<p dir=\"auto\">Why log twice? Also usually we don't log and throw to prevent duplicate messages. If the code already throws, we can assume the caller will handle it properly (which might include logging).</p>", "author": "fengwang666", "createdAt": "2020-03-17T22:14:30Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", e.getMessage());\n+                updateJobAsFailed(currentJobId, statusDetails);\n+            }\n         }\n \n     };\n \n-    private void updateJobAsSucceded(String jobId, DeploymentContext currentDeploymentContext)\n-            throws ExecutionException, InterruptedException {\n+    private DeploymentTask createDeploymentTask(HashMap<String, Object> jobDocument) throws InvalidRequestException {\n+\n+        DeploymentDocument deploymentDocument = parseAndValidateJobDocument(jobDocument);\n+        return new DeploymentTask(dependencyResolver, packageCache, kernelConfigResolver, kernel, logger,\n+                deploymentDocument);\n+    }\n+\n+    private DeploymentDocument parseAndValidateJobDocument(HashMap<String, Object> jobDocument)\n+            throws InvalidRequestException {\n+        if (jobDocument == null) {\n+            String errorMessage = \"Job document cannot be empty\";\n+            throw new InvalidRequestException(errorMessage);\n+        }\n+        DeploymentDocument deploymentDocument = null;\n+        try {\n+            String jobDocumentString = OBJECT_MAPPER.writeValueAsString(jobDocument);\n+            deploymentDocument = OBJECT_MAPPER.readValue(jobDocumentString, DeploymentDocument.class);\n+            return deploymentDocument;\n+        } catch (JsonProcessingException e) {\n+            String errorMessage = \"Unable to parse the job document\";\n+            logger.error(errorMessage, e);\n+            logger.error(e.getMessage());\n+            throw new InvalidRequestException(errorMessage, e);", "originalCommit": "2e7b577c640ae179f5e82d1e37adda7921863c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNDk0MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394024940", "bodyText": "Yes I agree. Removed it from here", "author": "abanthiy", "createdAt": "2020-03-17T23:18:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMTIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzQ4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394003480", "body": "Add a log here", "bodyText": "Add a log here", "bodyHTML": "<p dir=\"auto\">Add a log here</p>", "author": "fengwang666", "createdAt": "2020-03-17T22:20:12Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details", "originalCommit": "2e7b577c640ae179f5e82d1e37adda7921863c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODk1MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394058950", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-18T01:29:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwMzQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNjkxMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394006913", "body": "I guess cancellation is not handled here if there is a new deployment come in. Fine with it for now as long as we are aware of it.", "bodyText": "I guess cancellation is not handled here if there is a new deployment come in. Fine with it for now as long as we are aware of it.", "bodyHTML": "<p dir=\"auto\">I guess cancellation is not handled here if there is a new deployment come in. Fine with it for now as long as we are aware of it.</p>", "author": "fengwang666", "createdAt": "2020-03-17T22:28:39Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -210,14 +258,10 @@ public void startup() {\n             try {\n                 if (currentProcessStatus != null) {\n                     logger.info(\"Getting the status of the current process\");\n-                    Boolean deploymentStatus = currentProcessStatus.get();\n-                    if (deploymentStatus) {\n-                        updateJobAsSucceded(currentJobId, currentDeploymentContext);\n-                    } else {\n-                        updateJobAsFailed(currentJobId, currentDeploymentContext);\n-                    }\n+\n+                    currentProcessStatus.get();", "originalCommit": "2e7b577c640ae179f5e82d1e37adda7921863c0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyNTIwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394025208", "bodyText": "Right, cancellation needs to be handled and it will be done as part of future tasks. It is captured in backlog", "author": "abanthiy", "createdAt": "2020-03-17T23:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAwNjkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTEwMw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394029103", "body": "Better to only try the `createDeploymentTask` line since only this throws InvalidRequestException.\r\n```suggestion\r\n            try {\r\n                deploymentTask = createDeploymentTask(response.execution.jobDocument);\r\n            } catch (InvalidRequestException e) {\r\n                //TODO: Add status details\r\n                Map<String, String> statusDetails = new HashMap<>();\r\n                statusDetails.put(\"error\", e.getMessage());\r\n                updateJobAsFailed(currentJobId, statusDetails);\r\n            }\r\n            \r\n           currentProcessStatus = executorService.submit(deploymentTask);\r\n           logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\r\n```", "bodyText": "Better to only try the createDeploymentTask line since only this throws InvalidRequestException.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        try {\n          \n          \n            \n                            deploymentTask = createDeploymentTask(response.execution.jobDocument);\n          \n          \n            \n                            currentProcessStatus = executorService.submit(deploymentTask);\n          \n          \n            \n                            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n          \n          \n            \n                        } catch (InvalidRequestException e) {\n          \n          \n            \n                            //TODO: Add status details\n          \n          \n            \n                            HashMap<String, String> statusDetails = new HashMap<>();\n          \n          \n            \n                            statusDetails.put(\"error\", e.getMessage());\n          \n          \n            \n                            updateJobAsFailed(currentJobId, statusDetails);\n          \n          \n            \n                        }\n          \n          \n            \n                        try {\n          \n          \n            \n                            deploymentTask = createDeploymentTask(response.execution.jobDocument);\n          \n          \n            \n                        } catch (InvalidRequestException e) {\n          \n          \n            \n                            //TODO: Add status details\n          \n          \n            \n                            Map<String, String> statusDetails = new HashMap<>();\n          \n          \n            \n                            statusDetails.put(\"error\", e.getMessage());\n          \n          \n            \n                            updateJobAsFailed(currentJobId, statusDetails);\n          \n          \n            \n                        }\n          \n          \n            \n                        \n          \n          \n            \n                       currentProcessStatus = executorService.submit(deploymentTask);\n          \n          \n            \n                       logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);", "bodyHTML": "<p dir=\"auto\">Better to only try the <code>createDeploymentTask</code> line since only this throws InvalidRequestException.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"160\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"161\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                deploymentTask <span class=\"pl-k\">=</span> createDeploymentTask(response<span class=\"pl-k\">.</span>execution<span class=\"pl-k\">.</span>jobDocument);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"162\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                currentProcessStatus <span class=\"pl-k\">=</span> executorService<span class=\"pl-k\">.</span>submit(deploymentTask);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"163\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                logger<span class=\"pl-k\">.</span>atInfo()<span class=\"pl-k\">.</span>log(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Submitted the job with jobId {}<span class=\"pl-pds\">\"</span></span>, jobExecutionData<span class=\"pl-k\">.</span>jobId);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"164\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">InvalidRequestException</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"165\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-c\"><span class=\"pl-c\">//</span>TODO: Add status details</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"166\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">HashMap&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">String</span>&gt;</span> statusDetails <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashMap&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"167\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                statusDetails<span class=\"pl-k\">.</span>put(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>error<span class=\"pl-pds\">\"</span></span>, e<span class=\"pl-k\">.</span>getMessage());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"168\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                updateJobAsFailed(currentJobId, statusDetails);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"169\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"160\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">try</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"161\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                deploymentTask <span class=\"pl-k\">=</span> createDeploymentTask(response<span class=\"pl-k\">.</span>execution<span class=\"pl-k\">.</span>jobDocument);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"162\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">InvalidRequestException</span> e) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"163\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-c\"><span class=\"pl-c\">//</span>TODO: Add status details</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"164\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">String</span>&gt;</span> statusDetails <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashMap&lt;&gt;</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"165\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                statusDetails<span class=\"pl-k\">.</span>put(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>error<span class=\"pl-pds\">\"</span></span>, e<span class=\"pl-k\">.</span>getMessage());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"166\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                updateJobAsFailed(currentJobId, statusDetails);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"167\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"168\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"169\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">           currentProcessStatus <span class=\"pl-k\">=</span> executorService<span class=\"pl-k\">.</span>submit(deploymentTask);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"170\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">           logger<span class=\"pl-k\">.</span>atInfo()<span class=\"pl-k\">.</span>log(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Submitted the job with jobId {}<span class=\"pl-pds\">\"</span></span>, jobExecutionData<span class=\"pl-k\">.</span>jobId);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "leaf94", "createdAt": "2020-03-17T23:32:34Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", e.getMessage());\n+                updateJobAsFailed(currentJobId, statusDetails);\n+            }", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MDI1NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394060254", "bodyText": "I agree that trys should cover minimum statements. But in this case the suggested change won't work. I want to submit the deploymentTask only when it did not get exception. I don't like adding another null check.", "author": "abanthiy", "createdAt": "2020-03-18T01:35:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTEwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUyNTM3NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394525374", "bodyText": "True. But I guess we can return after catching the exception, so that the happy path code only run without exception?", "author": "leaf94", "createdAt": "2020-03-18T17:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTEwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUyOTY4Nw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394529687", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-18T17:44:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTEwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTIxMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394029210", "body": "`Map` interface should be fine", "bodyText": "Map interface should be fine", "bodyHTML": "<p dir=\"auto\"><code>Map</code> interface should be fine</p>", "author": "leaf94", "createdAt": "2020-03-17T23:32:56Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", e.getMessage());\n+                updateJobAsFailed(currentJobId, statusDetails);\n+            }\n         }\n \n     };\n \n-    private void updateJobAsSucceded(String jobId, DeploymentContext currentDeploymentContext)\n-            throws ExecutionException, InterruptedException {\n+    private DeploymentTask createDeploymentTask(HashMap<String, Object> jobDocument) throws InvalidRequestException {", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MTU0OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394061548", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-18T01:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAyOTIxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMzI2Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394033263", "body": "same here for `Map`", "bodyText": "same here for Map", "bodyHTML": "<p dir=\"auto\">same here for <code>Map</code></p>", "author": "leaf94", "createdAt": "2020-03-17T23:44:31Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", e.getMessage());\n+                updateJobAsFailed(currentJobId, statusDetails);\n+            }\n         }\n \n     };\n \n-    private void updateJobAsSucceded(String jobId, DeploymentContext currentDeploymentContext)\n-            throws ExecutionException, InterruptedException {\n+    private DeploymentTask createDeploymentTask(HashMap<String, Object> jobDocument) throws InvalidRequestException {\n+\n+        DeploymentDocument deploymentDocument = parseAndValidateJobDocument(jobDocument);\n+        return new DeploymentTask(dependencyResolver, packageCache, kernelConfigResolver, kernel, logger,\n+                deploymentDocument);\n+    }\n+\n+    private DeploymentDocument parseAndValidateJobDocument(HashMap<String, Object> jobDocument)", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MTY1Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394061652", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-18T01:40:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzMzI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzNTMwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394035308", "body": "What's error if using `@Inject`?\r\n\r\nIs it because that it doesn't work for `LocalPacakgeStore(String path)` since our DI right now only injects on type but not name? So String won't work... But `Kernel` for example works. I think `PackageCache` and `KernelConfigResolver` should work with `@Inject`, with my limited knowledge on this...", "bodyText": "What's error if using @Inject?\nIs it because that it doesn't work for LocalPacakgeStore(String path) since our DI right now only injects on type but not name? So String won't work... But Kernel for example works. I think PackageCache and KernelConfigResolver should work with @Inject, with my limited knowledge on this...", "bodyHTML": "<p dir=\"auto\">What's error if using <code>@Inject</code>?</p>\n<p dir=\"auto\">Is it because that it doesn't work for <code>LocalPacakgeStore(String path)</code> since our DI right now only injects on type but not name? So String won't work... But <code>Kernel</code> for example works. I think <code>PackageCache</code> and <code>KernelConfigResolver</code> should work with <code>@Inject</code>, with my limited knowledge on this...</p>", "author": "leaf94", "createdAt": "2020-03-17T23:51:58Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -241,6 +289,19 @@ public void shutdown() {\n         }\n     }\n \n+    private void initialize() {\n+        //Cannot do this in constructor because of how dependency injection works\n+        if (dependencyResolver == null) {\n+            this.dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), context);", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NzIwOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394047209", "bodyText": "Injecting these dependencies should remove a lot of boilerplate code, and besides there already is a constructor for DeploymentService that takes in these objects, why do we need these null checks and initialization code here still?", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:38:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzNTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2NzAxMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394067011", "bodyText": "@leaf94 Injected dependencies are initialized after the constructor of the class is called. I need the injected dependencies for initializing these classes and so it needs to happen after the DeploymentService instance is initialized.\n@shaguptashaikh Injecting these dependencies means creating these objects in Kernel. I do not prefer that. In addition to above, the constructor you are referring to is not used by Kernel to initialize the service. So this needs to be done explicitly.\nI am not super happy with this and willing to revisit how DI works.", "author": "abanthiy", "createdAt": "2020-03-18T02:02:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzNTMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUyNjk2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394526964", "bodyText": "I guess I'm still wondering what's the difference between KernelConfigResolver vs Kernel from the DI perspective.\nBut I do agree that we can revisit it later.", "author": "leaf94", "createdAt": "2020-03-18T17:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDAzNTMwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MjM4OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394042389", "body": "try catch not needed here", "bodyText": "try catch not needed here", "bodyHTML": "<p dir=\"auto\">try catch not needed here</p>", "author": "ShirleyZheng92", "createdAt": "2020-03-18T00:19:16Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.Log4jLoggerAdapter;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() throws InterruptedException {\n+        //Cannot use @TempDir since it does not work with static variables\n+        String tempRootDir = \"~/deploymentIntegTest\";\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir, \"-i\",\n+                DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+        kernel.launch();\n+        dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+        packageCache = new PackageCache();\n+        kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+    }\n+\n+    @AfterAll\n+    public static void tearDown() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        final List<String> listOfExpectedMessages = Arrays.asList(TEST_TICK_TOCK_STRING, TEST_MOSQUITTO_STRING,\n+                TEST_CUSTOMER_APP_STRING);\n+        countDownLatch = new CountDownLatch(3);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && listOfExpectedMessages.contains(messageOnStdout)) {\n+                if(!outputMessagesToTimestamp.containsKey(messageOnStdout)) {\n+                    outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                    countDownLatch.countDown();\n+                }\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI());\n+\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the deployment task\", e.getCause());\n+        }", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NzM2OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394057368", "bodyText": "I prefer explicitly capturing what does not need to happen.", "author": "abanthiy", "createdAt": "2020-03-18T01:22:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MjM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxMTg0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394511841", "bodyText": "as Mike commented: Don't catch and then fail, just let the method throw.", "author": "ShirleyZheng92", "createdAt": "2020-03-18T17:16:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MjM4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUyMjU5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394522598", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-18T17:32:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MjM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MzQ5NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394043495", "body": "seems same as PackageManager. LOCAL_PACKAGE_SOURCE?", "bodyText": "seems same as PackageManager. LOCAL_PACKAGE_SOURCE?", "bodyHTML": "<p dir=\"auto\">seems same as PackageManager. LOCAL_PACKAGE_SOURCE?</p>", "author": "ShirleyZheng92", "createdAt": "2020-03-18T00:23:33Z", "path": "src/main/java/com/aws/iot/evergreen/packagemanager/PackageCache.java", "diffHunk": "@@ -1,31 +1,55 @@\n package com.aws.iot.evergreen.packagemanager;\n \n+import com.aws.iot.evergreen.packagemanager.exceptions.PackagingException;\n import com.aws.iot.evergreen.packagemanager.models.Package;\n import com.aws.iot.evergreen.packagemanager.models.PackageIdentifier;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n \n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n import java.util.concurrent.Future;\n \n public class PackageCache {\n \n+    private static final Path LOCAL_CACHE_PATH =\n+            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA3MDg3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394070875", "bodyText": "Yes. This PR is not intended to address how package cache is going to be used/implemented. So you can consider this as a temporary workaround. Package cache work will be done in this sprint and will have a separate PR for it.", "author": "abanthiy", "createdAt": "2020-03-18T02:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MzQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxMjc0MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394512741", "bodyText": "in this case, can we reach agreement on where to put this const string? If it belongs to package cache maybe move to PackageCache class", "author": "ShirleyZheng92", "createdAt": "2020-03-18T17:17:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MzQ5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxODQwMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394518401", "bodyText": "This is PackageCache class. PackageManager class is no longer being used. Right now DeploymentService is initializing this path as well. At this point I do not know whether there will be a PackageCache or not so I do not want to make these decisions right now as they should be made as part of separate task.", "author": "abanthiy", "createdAt": "2020-03-18T17:26:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MzQ5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NDU2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394044562", "body": "seems same as PackageManager. LOCAL_PACKAGE_SOURCE?", "bodyText": "seems same as PackageManager. LOCAL_PACKAGE_SOURCE?", "bodyHTML": "<p dir=\"auto\">seems same as PackageManager. LOCAL_PACKAGE_SOURCE?</p>", "author": "ShirleyZheng92", "createdAt": "2020-03-18T00:27:52Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -46,6 +55,9 @@\n             new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE, false)\n                     .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n     private static final long DEPLOYMENT_POLLING_FREQUENCY = Duration.ofSeconds(30).toMillis();\n+    //TODO: Change this to be taken from config or user input. Maybe as part of deployment document\n+    private static final Path LOCAL_CACHE_PATH =\n+            Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODkyMA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394058920", "bodyText": "Correct. From what I see, PackageManager class is no longer being used now. DeploymentService is currently initializing all the classes so this is needed.  PackageManager should be removed eventually", "author": "abanthiy", "createdAt": "2020-03-18T01:29:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NDU2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NTI0OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394045249", "body": "typo: succeeded", "bodyText": "typo: succeeded", "bodyHTML": "<p dir=\"auto\">typo: succeeded</p>", "author": "ShirleyZheng92", "createdAt": "2020-03-18T00:30:37Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -210,14 +258,10 @@ public void startup() {\n             try {\n                 if (currentProcessStatus != null) {\n                     logger.info(\"Getting the status of the current process\");\n-                    Boolean deploymentStatus = currentProcessStatus.get();\n-                    if (deploymentStatus) {\n-                        updateJobAsSucceded(currentJobId, currentDeploymentContext);\n-                    } else {\n-                        updateJobAsFailed(currentJobId, currentDeploymentContext);\n-                    }\n+\n+                    currentProcessStatus.get();\n+                    updateJobAsSucceded(currentJobId, null);", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MjQzNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394042435", "body": "Should this also take the timestamp? If we're going to have an integration test to ensure the same job document when submitted twice is treated as a no-op but the deployment succeeds, it'll have the same timestamp both the times", "bodyText": "Should this also take the timestamp? If we're going to have an integration test to ensure the same job document when submitted twice is treated as a no-op but the deployment succeeds, it'll have the same timestamp both the times", "bodyHTML": "<p dir=\"auto\">Should this also take the timestamp? If we're going to have an integration test to ensure the same job document when submitted twice is treated as a no-op but the deployment succeeds, it'll have the same timestamp both the times</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:19:28Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.Log4jLoggerAdapter;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() throws InterruptedException {\n+        //Cannot use @TempDir since it does not work with static variables\n+        String tempRootDir = \"~/deploymentIntegTest\";\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir, \"-i\",\n+                DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+        kernel.launch();\n+        dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+        packageCache = new PackageCache();\n+        kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+    }\n+\n+    @AfterAll\n+    public static void tearDown() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        final List<String> listOfExpectedMessages = Arrays.asList(TEST_TICK_TOCK_STRING, TEST_MOSQUITTO_STRING,\n+                TEST_CUSTOMER_APP_STRING);\n+        countDownLatch = new CountDownLatch(3);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && listOfExpectedMessages.contains(messageOnStdout)) {\n+                if(!outputMessagesToTimestamp.containsKey(messageOnStdout)) {\n+                    outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                    countDownLatch.countDown();\n+                }\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI());\n+\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the deployment task\", e.getCause());\n+        }\n+\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        Set<String> listOfStdoutMessagesTapped = outputMessagesToTimestamp.keySet();\n+        assertTrue(listOfStdoutMessagesTapped.containsAll(listOfExpectedMessages));\n+        assertTrue(outputMessagesToTimestamp.get(TEST_TICK_TOCK_STRING) <\n+                outputMessagesToTimestamp.get(TEST_MOSQUITTO_STRING));\n+        assertTrue(outputMessagesToTimestamp.get(TEST_MOSQUITTO_STRING) <\n+                outputMessagesToTimestamp.get(TEST_CUSTOMER_APP_STRING));\n+        Log4jLogEventBuilder.removeGlobalListener(listener);\n+    }\n+\n+    @Test\n+    @Order(2)\n+    public void GIVEN_services_running_WHEN_updated_params_THEN_services_start_with_updated_params_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        countDownLatch = new CountDownLatch(1);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && messageOnStdout.equals(TEST_CUSTOMER_APP_STRING_UPDATED)) {\n+                outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                countDownLatch.countDown();\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument_updated.json\").toURI());\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the updated deployment task\", e.getCause());\n+        }\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        assertTrue(outputMessagesToTimestamp.containsKey(TEST_CUSTOMER_APP_STRING_UPDATED));\n+        Log4jLogEventBuilder.removeGlobalListener(listener);\n+    }\n+\n+    private Future<?> submitSampleJobDocument(URI uri) {", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1Nzc5MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394057790", "bodyText": "Yes it can be modified to take the timestamp.", "author": "abanthiy", "createdAt": "2020-03-18T01:24:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0MjQzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Mjg4MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394042881", "body": "This parsing logic already exists in the DA, that should also be covered by the integ tests, right?", "bodyText": "This parsing logic already exists in the DA, that should also be covered by the integ tests, right?", "bodyHTML": "<p dir=\"auto\">This parsing logic already exists in the DA, that should also be covered by the integ tests, right?</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:21:10Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.Log4jLoggerAdapter;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"No tick-tocking with period: 2\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() throws InterruptedException {\n+        //Cannot use @TempDir since it does not work with static variables\n+        String tempRootDir = \"~/deploymentIntegTest\";\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", tempRootDir, \"-i\",\n+                DeploymentServiceIntegrationTest.class.getResource(\"deploymentDemo.yaml\").toString());\n+        kernel.launch();\n+        dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel.context);\n+        packageCache = new PackageCache();\n+        kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+    }\n+\n+    @AfterAll\n+    public static void tearDown() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        final List<String> listOfExpectedMessages = Arrays.asList(TEST_TICK_TOCK_STRING, TEST_MOSQUITTO_STRING,\n+                TEST_CUSTOMER_APP_STRING);\n+        countDownLatch = new CountDownLatch(3);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && listOfExpectedMessages.contains(messageOnStdout)) {\n+                if(!outputMessagesToTimestamp.containsKey(messageOnStdout)) {\n+                    outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                    countDownLatch.countDown();\n+                }\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI());\n+\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the deployment task\", e.getCause());\n+        }\n+\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        Set<String> listOfStdoutMessagesTapped = outputMessagesToTimestamp.keySet();\n+        assertTrue(listOfStdoutMessagesTapped.containsAll(listOfExpectedMessages));\n+        assertTrue(outputMessagesToTimestamp.get(TEST_TICK_TOCK_STRING) <\n+                outputMessagesToTimestamp.get(TEST_MOSQUITTO_STRING));\n+        assertTrue(outputMessagesToTimestamp.get(TEST_MOSQUITTO_STRING) <\n+                outputMessagesToTimestamp.get(TEST_CUSTOMER_APP_STRING));\n+        Log4jLogEventBuilder.removeGlobalListener(listener);\n+    }\n+\n+    @Test\n+    @Order(2)\n+    public void GIVEN_services_running_WHEN_updated_params_THEN_services_start_with_updated_params_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        countDownLatch = new CountDownLatch(1);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && messageOnStdout.equals(TEST_CUSTOMER_APP_STRING_UPDATED)) {\n+                outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                countDownLatch.countDown();\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument_updated.json\").toURI());\n+        try {\n+            result.get();\n+        } catch (ExecutionException e) {\n+            fail(\"Failed executing the updated deployment task\", e.getCause());\n+        }\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        assertTrue(outputMessagesToTimestamp.containsKey(TEST_CUSTOMER_APP_STRING_UPDATED));\n+        Log4jLogEventBuilder.removeGlobalListener(listener);\n+    }\n+\n+    private Future<?> submitSampleJobDocument(URI uri) {\n+\n+        try {\n+            sampleDeploymentDocument = OBJECT_MAPPER.readValue(new File(uri), DeploymentDocument.class);", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1ODE5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394058196", "bodyText": "The point from which this integration tests start the testing the DA code is after the parsing is done, thats why need to do it here. End to end should cover the parsing happening in service", "author": "abanthiy", "createdAt": "2020-03-18T01:26:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Mjg4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NDk3NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394044975", "body": "Redundant error logs?", "bodyText": "Redundant error logs?", "bodyHTML": "<p dir=\"auto\">Redundant error logs?</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:29:25Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", e.getMessage());\n+                updateJobAsFailed(currentJobId, statusDetails);\n+            }\n         }\n \n     };\n \n-    private void updateJobAsSucceded(String jobId, DeploymentContext currentDeploymentContext)\n-            throws ExecutionException, InterruptedException {\n+    private DeploymentTask createDeploymentTask(HashMap<String, Object> jobDocument) throws InvalidRequestException {\n+\n+        DeploymentDocument deploymentDocument = parseAndValidateJobDocument(jobDocument);\n+        return new DeploymentTask(dependencyResolver, packageCache, kernelConfigResolver, kernel, logger,\n+                deploymentDocument);\n+    }\n+\n+    private DeploymentDocument parseAndValidateJobDocument(HashMap<String, Object> jobDocument)\n+            throws InvalidRequestException {\n+        if (jobDocument == null) {\n+            String errorMessage = \"Job document cannot be empty\";\n+            throw new InvalidRequestException(errorMessage);\n+        }\n+        DeploymentDocument deploymentDocument = null;\n+        try {\n+            String jobDocumentString = OBJECT_MAPPER.writeValueAsString(jobDocument);\n+            deploymentDocument = OBJECT_MAPPER.readValue(jobDocumentString, DeploymentDocument.class);\n+            return deploymentDocument;\n+        } catch (JsonProcessingException e) {\n+            String errorMessage = \"Unable to parse the job document\";\n+            logger.error(errorMessage, e);\n+            logger.error(e.getMessage());", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MTcyNg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394061726", "bodyText": "Fixed", "author": "abanthiy", "createdAt": "2020-03-18T01:40:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NDk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NjI3OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394046278", "body": "Not sure what value these two methods which are pretty much the same are adding, they could just be replaced by one method if you take the status as a parameter. Also, when you call these you're always passing null for statusDetails, why is that?", "bodyText": "Not sure what value these two methods which are pretty much the same are adding, they could just be replaced by one method if you take the status as a parameter. Also, when you call these you're always passing null for statusDetails, why is that?", "bodyHTML": "<p dir=\"auto\">Not sure what value these two methods which are pretty much the same are adding, they could just be replaced by one method if you take the status as a parameter. Also, when you call these you're always passing null for statusDetails, why is that?</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:35:05Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", e.getMessage());\n+                updateJobAsFailed(currentJobId, statusDetails);\n+            }\n         }\n \n     };\n \n-    private void updateJobAsSucceded(String jobId, DeploymentContext currentDeploymentContext)\n-            throws ExecutionException, InterruptedException {\n+    private DeploymentTask createDeploymentTask(HashMap<String, Object> jobDocument) throws InvalidRequestException {\n+\n+        DeploymentDocument deploymentDocument = parseAndValidateJobDocument(jobDocument);\n+        return new DeploymentTask(dependencyResolver, packageCache, kernelConfigResolver, kernel, logger,\n+                deploymentDocument);\n+    }\n+\n+    private DeploymentDocument parseAndValidateJobDocument(HashMap<String, Object> jobDocument)\n+            throws InvalidRequestException {\n+        if (jobDocument == null) {\n+            String errorMessage = \"Job document cannot be empty\";\n+            throw new InvalidRequestException(errorMessage);\n+        }\n+        DeploymentDocument deploymentDocument = null;\n+        try {\n+            String jobDocumentString = OBJECT_MAPPER.writeValueAsString(jobDocument);\n+            deploymentDocument = OBJECT_MAPPER.readValue(jobDocumentString, DeploymentDocument.class);\n+            return deploymentDocument;\n+        } catch (JsonProcessingException e) {\n+            String errorMessage = \"Unable to parse the job document\";\n+            logger.error(errorMessage, e);\n+            logger.error(e.getMessage());\n+            throw new InvalidRequestException(errorMessage, e);\n+        }\n+    }\n+\n+    private void updateJobAsSucceded(String jobId, HashMap<String, String> statusDetails) {\n         //TODO: Fill in status details from the deployment packet\n-        iotJobsHelper.updateJobStatus(jobId, JobStatus.SUCCEEDED, null);\n+        iotJobsHelper.updateJobStatus(jobId, JobStatus.SUCCEEDED, statusDetails);\n         logger.addDefaultKeyValue(\"JobId\", \"\");\n     }\n \n-    private void updateJobAsFailed(String jobId, DeploymentContext deploymentContext)\n-            throws ExecutionException, InterruptedException {\n+    private void updateJobAsFailed(String jobId, HashMap<String, String> statusDetails) {\n         //TODO: Fill in status details from the deployment packet\n-        iotJobsHelper.updateJobStatus(jobId, JobStatus.FAILED, null);\n+        iotJobsHelper.updateJobStatus(jobId, JobStatus.FAILED, statusDetails);\n         logger.addDefaultKeyValue(\"JobId\", \"\");\n     }", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MzE1MQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394063151", "bodyText": "When I wrote them, I imagined the status details will be constructed in these methods. Even though now I am passing the status details map but the resetting of jobId is specific to these two states, it should not happen for IN_PROGRESS update. At this point I would like to keep them separate and I am open to refactor them later. I am currently passing status details as null for success update because there are no additional status details. Passing null at another failure point because we have not decided what needs to be sent in status details. It should be covered in future PRs.", "author": "abanthiy", "createdAt": "2020-03-18T01:46:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0NjI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Nzc2Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394047762", "body": "Why is a default key value par for JobId being cleared while trying to update the job? should it be updated right after pulling the job from cloud and cleaned up when you're done processing the deployment?", "bodyText": "Why is a default key value par for JobId being cleared while trying to update the job? should it be updated right after pulling the job from cloud and cleaned up when you're done processing the deployment?", "bodyHTML": "<p dir=\"auto\">Why is a default key value par for JobId being cleared while trying to update the job? should it be updated right after pulling the job from cloud and cleaned up when you're done processing the deployment?</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:41:19Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +141,58 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n             //Starting the job processing in another thread\n-            currentProcessStatus = executorService\n-                    .submit(new DeploymentProcess(currentDeploymentContext, OBJECT_MAPPER, kernel,\n-                            context.get(PackageManager.class), logger));\n-            logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+                currentProcessStatus = executorService.submit(deploymentTask);\n+                logger.atInfo().log(\"Submitted the job with jobId {}\", jobExecutionData.jobId);\n+            } catch (InvalidRequestException e) {\n+                //TODO: Add status details\n+                HashMap<String, String> statusDetails = new HashMap<>();\n+                statusDetails.put(\"error\", e.getMessage());\n+                updateJobAsFailed(currentJobId, statusDetails);\n+            }\n         }\n \n     };\n \n-    private void updateJobAsSucceded(String jobId, DeploymentContext currentDeploymentContext)\n-            throws ExecutionException, InterruptedException {\n+    private DeploymentTask createDeploymentTask(HashMap<String, Object> jobDocument) throws InvalidRequestException {\n+\n+        DeploymentDocument deploymentDocument = parseAndValidateJobDocument(jobDocument);\n+        return new DeploymentTask(dependencyResolver, packageCache, kernelConfigResolver, kernel, logger,\n+                deploymentDocument);\n+    }\n+\n+    private DeploymentDocument parseAndValidateJobDocument(HashMap<String, Object> jobDocument)\n+            throws InvalidRequestException {\n+        if (jobDocument == null) {\n+            String errorMessage = \"Job document cannot be empty\";\n+            throw new InvalidRequestException(errorMessage);\n+        }\n+        DeploymentDocument deploymentDocument = null;\n+        try {\n+            String jobDocumentString = OBJECT_MAPPER.writeValueAsString(jobDocument);\n+            deploymentDocument = OBJECT_MAPPER.readValue(jobDocumentString, DeploymentDocument.class);\n+            return deploymentDocument;\n+        } catch (JsonProcessingException e) {\n+            String errorMessage = \"Unable to parse the job document\";\n+            logger.error(errorMessage, e);\n+            logger.error(e.getMessage());\n+            throw new InvalidRequestException(errorMessage, e);\n+        }\n+    }\n+\n+    private void updateJobAsSucceded(String jobId, HashMap<String, String> statusDetails) {\n         //TODO: Fill in status details from the deployment packet\n-        iotJobsHelper.updateJobStatus(jobId, JobStatus.SUCCEEDED, null);\n+        iotJobsHelper.updateJobStatus(jobId, JobStatus.SUCCEEDED, statusDetails);\n         logger.addDefaultKeyValue(\"JobId\", \"\");", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MjMyOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394062329", "bodyText": "This is a final update for the job, so it works equally well. If any other logs show up after this job completion, and before the next job comes, the jobId will linger on.", "author": "abanthiy", "createdAt": "2020-03-18T01:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Nzc2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Nzk5OA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394047998", "body": "Nit - why concatenate two string literals in the log here?", "bodyText": "Nit - why concatenate two string literals in the log here?", "bodyHTML": "<p dir=\"auto\">Nit - why concatenate two string literals in the log here?</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:42:19Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentTask.java", "diffHunk": "@@ -46,12 +49,14 @@ public Void call() throws NonRetryableDeploymentTaskFailureException, RetryableD\n             Map<Object, Object> newConfig = kernelConfigResolver.resolve(desiredPackages, document, new HashSet<>());\n             // Block this without timeout because it can take a long time for the device to update the config\n             // (if it's not in a safe window).\n+            logger.atInfo().addKeyValue(\"Config\", newConfig.toString())\n+                    .log(\"Submitting the config to merge with \" + \"kernel\");", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2NzYwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394067605", "bodyText": "Was a debug log I was using for demo. Removed it. Long Line characters must have added the +", "author": "abanthiy", "createdAt": "2020-03-18T02:05:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0Nzk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0ODY2NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394048664", "body": "Now that you're adding a Setter on this to be able to change this from the tests, I noticed that all of these members are default, could you make them private?", "bodyText": "Now that you're adding a Setter on this to be able to change this from the tests, I noticed that all of these members are default, could you make them private?", "bodyHTML": "<p dir=\"auto\">Now that you're adding a Setter on this to be able to change this from the tests, I noticed that all of these members are default, could you make them private?</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:45:10Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -32,6 +37,8 @@\n     @JsonProperty(\"GroupName\")\n     String groupName;\n \n+    @Setter", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0OTAwNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394049005", "body": "There are constructors and a builder and a setter for the timestamp member, some of them have to be redundant", "bodyText": "There are constructors and a builder and a setter for the timestamp member, some of them have to be redundant", "bodyHTML": "<p dir=\"auto\">There are constructors and a builder and a setter for the timestamp member, some of them have to be redundant</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:46:29Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentDocument.java", "diffHunk": "@@ -17,6 +20,8 @@\n @JsonInclude(JsonInclude.Include.NON_NULL)\n @Getter\n @Builder\n+@NoArgsConstructor\n+@AllArgsConstructor", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2ODczMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394068732", "bodyText": "NoArgs is required by ObjectMapper. With builder if you want to use NoArgs then you have to add AllArgs. Issue is explained at - https://groups.google.com/forum/#!topic/project-lombok/xPgFBhWqhNA\nI need setter only to set the timestamp after the Document is Deserialized in the test.", "author": "abanthiy", "createdAt": "2020-03-18T02:09:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0OTAwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0OTI5Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394049293", "body": "We could also make these private", "bodyText": "We could also make these private", "bodyHTML": "<p dir=\"auto\">We could also make these private</p>", "author": "shaguptashaikh", "createdAt": "2020-03-18T00:47:42Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/model/DeploymentPackageConfiguration.java", "diffHunk": "@@ -20,6 +23,7 @@\n @JsonInclude(JsonInclude.Include.NON_NULL)\n @Getter\n @AllArgsConstructor\n+@NoArgsConstructor\n public class DeploymentPackageConfiguration {\n \n     @JsonProperty(\"Name\")", "originalCommit": "5e99486bd0ae7d15839d7698ae3b52a34f71f7d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUxMTc5Ng==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394511796", "bodyText": "Done", "author": "abanthiy", "createdAt": "2020-03-18T17:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0OTI5Mw=="}], "type": "inlineReview"}, {"oid": "eb826d109da8b1fa02bda51577d77324dcec3a96", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/eb826d109da8b1fa02bda51577d77324dcec3a96", "message": "Addressing review comments. Changing test package from TickTock to GreenSignal. Fixing skipif handling", "committedDate": "2020-03-18T02:37:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNzExNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394707115", "body": "Minor. This could even be removed if you use `@InjectMocks` in the unit test.", "bodyText": "Minor. This could even be removed if you use @InjectMocks in the unit test.", "bodyHTML": "<p dir=\"auto\">Minor. This could even be removed if you use <code>@InjectMocks</code> in the unit test.</p>", "author": "leaf94", "createdAt": "2020-03-19T00:02:22Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -161,26 +209,33 @@ public DeploymentService(Topics topics) {\n     }\n \n     /**\n-     * Constructor.\n+     * Constructor fo unit testing.\n      *\n      * @param topics               The configuration coming from  kernel\n      * @param iotJobsHelperFactory Factory object for creating IotJobHelper\n      * @param executorService      Executor service coming from kernel\n      * @param kernel               The evergreen kernel\n+     * @param dependencyResolver   {@link DependencyResolver}\n+     * @param packageCache         {@link PackageCache}\n+     * @param kernelConfigResolver {@link KernelConfigResolver}\n      */\n     public DeploymentService(Topics topics, IotJobsHelperFactory iotJobsHelperFactory, ExecutorService executorService,\n-                             Kernel kernel) {\n+                             Kernel kernel, DependencyResolver dependencyResolver, PackageCache packageCache,\n+                             KernelConfigResolver kernelConfigResolver) {\n         super(topics);\n         this.iotJobsHelperFactory = iotJobsHelperFactory;\n         this.executorService = executorService;\n         this.kernel = kernel;\n+        this.dependencyResolver = dependencyResolver;\n+        this.packageCache = packageCache;\n+        this.kernelConfigResolver = kernelConfigResolver;", "originalCommit": "f1673eddedc01c0523e62d36f42efd29e494bb40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyMjg1OQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394722859", "bodyText": "As discussed separately, EvergreenService tries to use the mocked Topics during the initialization. InjectMocks does not work well in this flow.", "author": "abanthiy", "createdAt": "2020-03-19T00:35:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNzI4NA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394707284", "body": "`@InjectMocks`  will do the work", "bodyText": "@InjectMocks  will do the work", "bodyHTML": "<p dir=\"auto\"><code>@InjectMocks</code>  will do the work</p>", "author": "leaf94", "createdAt": "2020-03-19T00:02:54Z", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -72,14 +79,23 @@\n     @Mock\n     ExecutorService mockExecutorService;\n \n+    @Mock\n+    private DependencyResolver dependencyResolver;\n+\n+    @Mock\n+    private PackageCache packageCache;\n+\n+    @Mock\n+    private KernelConfigResolver kernelConfigResolver;\n+\n     @Captor\n     ArgumentCaptor<Consumer<JobExecutionsChangedEvent>> jobEventConsumerCaptor;\n \n     @Captor\n     ArgumentCaptor<Consumer<DescribeJobExecutionResponse>> describeJobConsumerCaptor;\n \n     DeploymentService deploymentService;", "originalCommit": "f1673eddedc01c0523e62d36f42efd29e494bb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNzYwOA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394707608", "body": "If `InjectMocks` works, then this could be removed, along with the constructor in the source code :)", "bodyText": "If InjectMocks works, then this could be removed, along with the constructor in the source code :)", "bodyHTML": "<p dir=\"auto\">If <code>InjectMocks</code> works, then this could be removed, along with the constructor in the source code :)</p>", "author": "leaf94", "createdAt": "2020-03-19T00:03:58Z", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -121,17 +137,17 @@ public void setup() {\n                     .thenReturn(mockIotJobsHelper);\n \n             //Creating the class to be tested\n-            doneSignal = new CountDownLatch(1);\n             deploymentService =\n-                    new DeploymentService(config, mockIotJobsHelperFactory, mockExecutorService, mockKernel);\n+                    new DeploymentService(config, mockIotJobsHelperFactory, mockExecutorService, mockKernel,\n+                            dependencyResolver, packageCache, kernelConfigResolver);\n         }", "originalCommit": "f1673eddedc01c0523e62d36f42efd29e494bb40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNDc4MA==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394704780", "body": "not needed IMO, correct ordering of dependency should be tested in kernel integ test. ", "bodyText": "not needed IMO, correct ordering of dependency should be tested in kernel integ test.", "bodyHTML": "<p dir=\"auto\">not needed IMO, correct ordering of dependency should be tested in kernel integ test.</p>", "author": "ShirleyZheng92", "createdAt": "2020-03-18T23:54:24Z", "path": "src/integrationtests/java/com/aws/iot/evergreen/integrationtests/deployment/DeploymentServiceIntegrationTest.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.aws.iot.evergreen.integrationtests.deployment;\n+\n+import com.aws.iot.evergreen.deployment.DeploymentTask;\n+import com.aws.iot.evergreen.deployment.model.DeploymentDocument;\n+import com.aws.iot.evergreen.kernel.Kernel;\n+import com.aws.iot.evergreen.logging.api.Logger;\n+import com.aws.iot.evergreen.logging.impl.EvergreenStructuredLogMessage;\n+import com.aws.iot.evergreen.logging.impl.Log4jLogEventBuilder;\n+import com.aws.iot.evergreen.logging.impl.LogManager;\n+import com.aws.iot.evergreen.packagemanager.DependencyResolver;\n+import com.aws.iot.evergreen.packagemanager.KernelConfigResolver;\n+import com.aws.iot.evergreen.packagemanager.PackageCache;\n+import com.aws.iot.evergreen.packagemanager.plugins.LocalPackageStore;\n+import com.aws.iot.evergreen.testcommons.extensions.PerformanceReporting;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.hamcrest.Matchers;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.MethodOrderer;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestMethodOrder;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import java.io.File;\n+import java.net.URI;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Consumer;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+@ExtendWith(PerformanceReporting.class)\n+@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\n+public class DeploymentServiceIntegrationTest {\n+\n+    private static final String TEST_CUSTOMER_APP_STRING = \"Hello evergreen. This is a test\";\n+\n+    //Based on the recipe files of the packages in sample job document\n+    private static final String TEST_CUSTOMER_APP_STRING_UPDATED = \"Hello evergreen. This is a new value\";\n+    private static final String TEST_MOSQUITTO_STRING = \"Hello this is mosquitto getting started\";\n+    private static final String TEST_TICK_TOCK_STRING = \"Go ahead with 2 approvals\";\n+    private static final Path LOCAL_CACHE_PATH = Paths.get(System.getProperty(\"user.dir\")).resolve(\"local_artifact_source\");\n+\n+    private static ObjectMapper OBJECT_MAPPER =\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_INVALID_SUBTYPE,\n+            false)\n+            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+\n+    private static Logger logger;\n+\n+    private static DependencyResolver dependencyResolver;\n+    private static PackageCache packageCache;\n+    private static KernelConfigResolver kernelConfigResolver;\n+\n+    private DeploymentDocument sampleDeploymentDocument;\n+    private static Kernel kernel;\n+\n+    private static Map<String, Long> outputMessagesToTimestamp;\n+    private CountDownLatch countDownLatch;\n+\n+    @TempDir\n+    static Path sharedDir;\n+\n+    @BeforeAll\n+    static void setupLogger() {\n+        System.setProperty(\"log.level\", \"INFO\");\n+        System.setProperty(\"log.fmt\", \"JSON\");\n+        System.setProperty(\"log.store\", \"CONSOLE\");\n+        outputMessagesToTimestamp = new HashMap<>();\n+        logger = LogManager.getLogger(DeploymentServiceIntegrationTest.class);\n+    }\n+\n+    @BeforeAll\n+    public static void setupKernel() {\n+        kernel = new Kernel();\n+        kernel.parseArgs(\"-r\", sharedDir.toString(), \"-i\",\n+                DeploymentServiceIntegrationTest.class.getResource(\"onlyMain.yaml\").toString());\n+        kernel.launch();\n+        dependencyResolver = new DependencyResolver(new LocalPackageStore(LOCAL_CACHE_PATH), kernel);\n+        packageCache = new PackageCache();\n+        kernelConfigResolver = new KernelConfigResolver(packageCache, kernel);\n+    }\n+\n+    @AfterAll\n+    public static void tearDown() {\n+        kernel.shutdown();\n+    }\n+\n+    @Test\n+    @Order(1)\n+    public void GIVEN_sample_deployment_doc_WHEN_submitted_to_deployment_task_THEN_services_start_in_kernel()\n+            throws Exception {\n+        outputMessagesToTimestamp.clear();\n+        final List<String> listOfExpectedMessages = Arrays.asList(TEST_TICK_TOCK_STRING, TEST_MOSQUITTO_STRING,\n+                TEST_CUSTOMER_APP_STRING);\n+        countDownLatch = new CountDownLatch(3);\n+        Consumer<EvergreenStructuredLogMessage> listener = m->{\n+            Map<String, String> contexts = m.getContexts();\n+            String messageOnStdout = contexts.get(\"stdout\");\n+            if(messageOnStdout != null && listOfExpectedMessages.contains(messageOnStdout)) {\n+                //TODO: Deduping is needed, as currently kernel is running the GreenSignal and Mosquitto dependencies\n+                // multiple times before the CustomerApp runs. This should not be the expected behavior. Sim to\n+                // capture this https://sim.amazon.com/issues/P34042537\n+                if(!outputMessagesToTimestamp.containsKey(messageOnStdout)) {\n+                    outputMessagesToTimestamp.put(messageOnStdout, m.getTimestamp());\n+                    countDownLatch.countDown();\n+                }\n+            }\n+        };\n+        Log4jLogEventBuilder.addGlobalListener(listener);\n+        Future<?> result = submitSampleJobDocument(DeploymentServiceIntegrationTest.class.getResource(\n+                \"SampleJobDocument.json\").toURI(), System.currentTimeMillis());\n+\n+        result.get();\n+\n+        countDownLatch.await(60, TimeUnit.SECONDS);\n+        Set<String> listOfStdoutMessagesTapped = outputMessagesToTimestamp.keySet();\n+        assertThat(listOfStdoutMessagesTapped, Matchers.containsInAnyOrder(Matchers.equalTo(TEST_CUSTOMER_APP_STRING)\n+                , Matchers.equalTo(TEST_MOSQUITTO_STRING), Matchers.equalTo(TEST_TICK_TOCK_STRING)));\n+        //TODO: Check the correct ordering of dependencies\n+        // Logs are not guaranteed to be in the order of dependencies", "originalCommit": "f1673eddedc01c0523e62d36f42efd29e494bb40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyNDYzMQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394724631", "bodyText": "I can get rid of this. Anyways with these recipe files we cannot check this. But my understanding was that in order to test a feature completely it should be triggered by submitting a document. So these sample documents need to be updated continually as we develop more features.", "author": "abanthiy", "createdAt": "2020-03-19T00:41:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNDc4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMjQzOQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r395212439", "bodyText": "Sure. I'm fine with the current code here", "author": "ShirleyZheng92", "createdAt": "2020-03-19T17:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNDc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTgyNQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394705825", "body": "Are these Rahul's change? Could you do a rebase?", "bodyText": "Are these Rahul's change? Could you do a rebase?", "bodyHTML": "<p dir=\"auto\">Are these Rahul's change? Could you do a rebase?</p>", "author": "ShirleyZheng92", "createdAt": "2020-03-18T23:57:50Z", "path": "src/main/java/com/aws/iot/evergreen/kernel/GenericExternalService.java", "diffHunk": "@@ -24,7 +24,8 @@\n                     \"SIGSEGV\", \"SIGUSR2\", \"SIGPIPE\", \"SIGALRM\", \"SIGTERM\", \"SIGSTKFLT\", \"SIGCHLD\", \"SIGCONT\", \"SIGSTOP\",\n                     \"SIGTSTP\", \"SIGTTIN\", \"SIGTTOU\", \"SIGURG\", \"SIGXCPU\", \"SIGXFSZ\", \"SIGVTALRM\", \"SIGPROF\", \"SIGWINCH\",\n                     \"SIGIO\", \"SIGPWR\", \"SIGSYS\",};\n-    private static final Pattern skipcmd = Pattern.compile(\"(exists|onpath) +(.+)\");\n+    private static final String SKIP_COMMAND_REGEX = \"(exists|onpath) +(.+)\";\n+    private static final Pattern skipcmd = Pattern.compile(SKIP_COMMAND_REGEX);", "originalCommit": "f1673eddedc01c0523e62d36f42efd29e494bb40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcyMzQyMg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r394723422", "bodyText": "I made these changes after talking to Rahul. Skip if should not be mandatory.", "author": "abanthiy", "createdAt": "2020-03-19T00:37:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNTgyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwNzA4Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r395207083", "body": "Why are you getting the cause of the `InvalidRequestException`?\r\n\r\nAlso, nitpick, combine these strings since they're on the same line anyway.", "bodyText": "Why are you getting the cause of the InvalidRequestException?\nAlso, nitpick, combine these strings since they're on the same line anyway.", "bodyHTML": "<p dir=\"auto\">Why are you getting the cause of the <code>InvalidRequestException</code>?</p>\n<p dir=\"auto\">Also, nitpick, combine these strings since they're on the same line anyway.</p>", "author": "MikeDombo", "createdAt": "2020-03-19T17:41:29Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +145,57 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n+\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+            } catch (InvalidRequestException e) {\n+                logger.atError().setCause(e.getCause())\n+                        .log(\"Caught InvalidRequestException while processing a \" + \"deployment\");", "originalCommit": "1c0054228ec5caedbe0e26c9970c1ed86ff0ce8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMzM1NQ==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r395213355", "bodyText": "Because IRE can be encapsulating another Throwable as well. I have also added a message as a key value.", "author": "abanthiy", "createdAt": "2020-03-19T17:51:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwNzA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxNDU5Mg==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r395214592", "bodyText": "I understand that, but that's why you should just do setCause(e). When saving the log it will give you the full cause-chain.", "author": "MikeDombo", "createdAt": "2020-03-19T17:53:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwNzA4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwODg3Mw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r395208873", "body": "[nit]\r\n\r\n`for`", "bodyText": "[nit]\nfor", "bodyHTML": "<p dir=\"auto\">[nit]</p>\n<p dir=\"auto\"><code>for</code></p>", "author": "MikeDombo", "createdAt": "2020-03-19T17:44:11Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -161,26 +209,33 @@ public DeploymentService(Topics topics) {\n     }\n \n     /**\n-     * Constructor.\n+     * Constructor fo unit testing.", "originalCommit": "1c0054228ec5caedbe0e26c9970c1ed86ff0ce8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxMjgyNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r395212827", "body": "Looks unused.", "bodyText": "Looks unused.", "bodyHTML": "<p dir=\"auto\">Looks unused.</p>", "author": "MikeDombo", "createdAt": "2020-03-19T17:50:42Z", "path": "src/test/java/com/aws/iot/evergreen/deployment/DeploymentServiceTest.java", "diffHunk": "@@ -16,6 +20,7 @@\n import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.ArgumentCaptor;\n import org.mockito.Captor;\n+import org.mockito.InjectMocks;", "originalCommit": "1c0054228ec5caedbe0e26c9970c1ed86ff0ce8f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "52e96a762f98bb726c0f00f139dbd9574e678551", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/52e96a762f98bb726c0f00f139dbd9574e678551", "message": "Adding integration test for submitting a sample job document and starting the services", "committedDate": "2020-03-19T18:06:54Z", "type": "commit"}, {"oid": "8a06c434d321d108e79383a4765fbf2dbed2a3d5", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8a06c434d321d108e79383a4765fbf2dbed2a3d5", "message": "Addressing review comments", "committedDate": "2020-03-19T18:06:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyMzIwNw==", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/pull/116#discussion_r395223207", "body": "adding the \"message\" isn't really needed since it prints the message when it prints the cause.", "bodyText": "adding the \"message\" isn't really needed since it prints the message when it prints the cause.", "bodyHTML": "<p dir=\"auto\">adding the \"message\" isn't really needed since it prints the message when it prints the cause.</p>", "author": "MikeDombo", "createdAt": "2020-03-19T18:07:50Z", "path": "src/main/java/com/aws/iot/evergreen/deployment/DeploymentService.java", "diffHunk": "@@ -125,29 +145,57 @@ public void onConnectionResumed(boolean sessionPresent) {\n             iotJobsHelper.updateJobStatus(currentJobId, JobStatus.IN_PROGRESS, null);\n \n             logger.info(\"Updated the status of JobsId {} to {}\", currentJobId, JobStatus.IN_PROGRESS);\n-            currentDeploymentContext = DeploymentContext.builder().jobDocument(response.execution.jobDocument)\n-                    .proposedPackagesFromDeployment(new HashSet<>()).resolvedPackagesToDeploy(new HashSet<>())\n-                    .removedTopLevelPackageNames(new HashSet<>()).build();\n+\n+\n+            DeploymentTask deploymentTask;\n+            try {\n+                deploymentTask = createDeploymentTask(response.execution.jobDocument);\n+            } catch (InvalidRequestException e) {\n+                logger.atError().setCause(e).addKeyValue(\"message\", e.getMessage())", "originalCommit": "e70c7c9102d2c137ad44b2383e4fd772c70dea47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e5c5db0bd5c72c916eb28bdc5fb7d5111d052c37", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/e5c5db0bd5c72c916eb28bdc5fb7d5111d052c37", "message": "Refactor dependency resolution for packages", "committedDate": "2020-03-19T18:09:30Z", "type": "commit"}, {"oid": "338c8db97bbf3f437a1812349ec7bafdd5e4ae65", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/338c8db97bbf3f437a1812349ec7bafdd5e4ae65", "message": "Integrating deployment service with new code workflow in Da, package manager and kernel. Adding integration tests. Removing old workflow code", "committedDate": "2020-03-19T18:09:30Z", "type": "commit"}, {"oid": "8b0a71427e764d9bed75e697f8d01cd9e9209239", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b0a71427e764d9bed75e697f8d01cd9e9209239", "message": "Addressing review comments. Adding listener to logger in integration tests", "committedDate": "2020-03-19T18:09:30Z", "type": "commit"}, {"oid": "df0a2aadae668fbb1f2acfbcd8f662e72419009e", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/df0a2aadae668fbb1f2acfbcd8f662e72419009e", "message": "Adding countdown latch to wait till log listener captures the message", "committedDate": "2020-03-19T18:09:30Z", "type": "commit"}, {"oid": "5a60b3d2f794aa058ac7e07330dca185469465f1", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/5a60b3d2f794aa058ac7e07330dca185469465f1", "message": "Changing the integ tests to run kernel only once, before starting any tests", "committedDate": "2020-03-19T18:09:30Z", "type": "commit"}, {"oid": "fc408040807b71e46f46fe870d10d95f16b41c45", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/fc408040807b71e46f46fe870d10d95f16b41c45", "message": "Changing Mosquitto recipe file to include echo for ubuntu platform as well", "committedDate": "2020-03-19T18:09:30Z", "type": "commit"}, {"oid": "4ac52d84ac1f1b97d7933b883bac83b953973a88", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/4ac52d84ac1f1b97d7933b883bac83b953973a88", "message": "Fixing Mosquitto recipe for ubuntu", "committedDate": "2020-03-19T18:09:31Z", "type": "commit"}, {"oid": "1321ec4729e20a2c36d19c19f4988b6a81da4579", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/1321ec4729e20a2c36d19c19f4988b6a81da4579", "message": "Adding skipif to install section of mosquitto recipe", "committedDate": "2020-03-19T18:09:31Z", "type": "commit"}, {"oid": "936225feca859e340eb401b947b9d974c1ff7923", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/936225feca859e340eb401b947b9d974c1ff7923", "message": "Fixing typo in recipe", "committedDate": "2020-03-19T18:09:31Z", "type": "commit"}, {"oid": "0f100eb5a66dfde73e4231943aeac09426af2d52", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0f100eb5a66dfde73e4231943aeac09426af2d52", "message": "Addressing review comments. Changing test package from TickTock to GreenSignal. Fixing skipif handling", "committedDate": "2020-03-19T18:09:31Z", "type": "commit"}, {"oid": "8b9e47d1efec65038ba577c63fc7abb5c24a2659", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/8b9e47d1efec65038ba577c63fc7abb5c24a2659", "message": "Changing the dependency injection in DeploymentService", "committedDate": "2020-03-19T18:09:31Z", "type": "commit"}, {"oid": "a05acd3b8da48ef007268ee520807a36d1d96590", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/a05acd3b8da48ef007268ee520807a36d1d96590", "message": "Addressing review comments", "committedDate": "2020-03-19T18:09:31Z", "type": "commit"}, {"oid": "688459147e63263b019f98dcd3c6bae10b2c5afc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/688459147e63263b019f98dcd3c6bae10b2c5afc", "message": "Addressing more review comments", "committedDate": "2020-03-19T18:09:31Z", "type": "commit"}, {"oid": "688459147e63263b019f98dcd3c6bae10b2c5afc", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/688459147e63263b019f98dcd3c6bae10b2c5afc", "message": "Addressing more review comments", "committedDate": "2020-03-19T18:09:31Z", "type": "forcePushed"}, {"oid": "0473aac4edef52fdc72b7d646b9806bee732b52c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0473aac4edef52fdc72b7d646b9806bee732b52c", "message": "Attempting to fix transient error in ServiceConfigMerge", "committedDate": "2020-03-19T21:38:15Z", "type": "commit"}, {"oid": "0f765f93f96e5b2aaff7eae24b23a13d2ce7654c", "url": "https://github.com/aws-greengrass/aws-greengrass-nucleus/commit/0f765f93f96e5b2aaff7eae24b23a13d2ce7654c", "message": "Setting up the rootPath in BeforeEach for ServiceConfigMerge", "committedDate": "2020-03-19T21:48:03Z", "type": "commit"}]}