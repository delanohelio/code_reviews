{"pr_number": 769, "pr_title": "[IOTDB-452] Do all aggregations of one series at one pass in GroupBy", "pr_author": "samperson1997", "pr_createdAt": "2020-02-05T06:28:24Z", "pr_url": "https://github.com/apache/iotdb/pull/769", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MTY0OQ==", "url": "https://github.com/apache/iotdb/pull/769#discussion_r375091649", "body": "```suggestion\r\n  private Map<Path, List<Integer>> pathToAggrIndexes;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<Path, List<Integer>> seriesReaders;\n          \n          \n            \n              private Map<Path, List<Integer>> pathToAggrIndexes;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">Path</span>, <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">Integer</span>&gt;</span>&gt;</span> <span class=\"x x-first x-last\">seriesReaders</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">Path</span>, <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">Integer</span>&gt;</span>&gt;</span> <span class=\"x x-first x-last\">pathToAggrIndexes</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-05T07:19:00Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/groupby/GroupByWithoutValueFilterDataSet.java", "diffHunk": "@@ -43,7 +46,17 @@\n \n public class GroupByWithoutValueFilterDataSet extends GroupByEngineDataSet {\n \n-  private List<IAggregateReader> seriesReaders;\n+  /**\n+   * Merges same series to one map. For example: Given: paths: s1, s2, s3, s1 and aggregations:\n+   * count, sum, count, sum seriesMap: s1 -> 0, 3; s2 -> 2; s3 -> 3\n+   */\n+  private Map<Path, List<Integer>> seriesReaders;", "originalCommit": "f20f9ce5e8502b9b81949009eb63ad92588f2de5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTEzNTI1Ng==", "url": "https://github.com/apache/iotdb/pull/769#discussion_r375135256", "bodyText": "Done.", "author": "samperson1997", "createdAt": "2020-02-05T09:13:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA5MTY0OQ=="}], "type": "inlineReview"}, {"oid": "c311b36e5ddde3734e2d7bf18347ba56fa457483", "url": "https://github.com/apache/iotdb/commit/c311b36e5ddde3734e2d7bf18347ba56fa457483", "message": "Merge new_series_reader and solve conflicts", "committedDate": "2020-02-05T08:34:34Z", "type": "commit"}, {"oid": "e291c91c5c6bd557b101678611b80776da452b78", "url": "https://github.com/apache/iotdb/commit/e291c91c5c6bd557b101678611b80776da452b78", "message": "Rename", "committedDate": "2020-02-05T08:43:50Z", "type": "commit"}, {"oid": "e291c91c5c6bd557b101678611b80776da452b78", "url": "https://github.com/apache/iotdb/commit/e291c91c5c6bd557b101678611b80776da452b78", "message": "Rename", "committedDate": "2020-02-05T08:43:50Z", "type": "forcePushed"}, {"oid": "132fe564c906fedd0b8bd5b18e9ada6f2bb8ce36", "url": "https://github.com/apache/iotdb/commit/132fe564c906fedd0b8bd5b18e9ada6f2bb8ce36", "message": "Merge remote-tracking branch 'upstream/new_series_reader' into new_series_reader\n\n# Conflicts:\n#\tserver/src/main/java/org/apache/iotdb/db/query/dataset/groupby/GroupByWithoutValueFilterDataSet.java\n#\tserver/src/main/java/org/apache/iotdb/db/query/executor/AggregationExecutor.java", "committedDate": "2020-02-05T08:49:51Z", "type": "commit"}, {"oid": "7715c3b9afc793c3374adf88033815472f081ab8", "url": "https://github.com/apache/iotdb/commit/7715c3b9afc793c3374adf88033815472f081ab8", "message": "Solve conflicts", "committedDate": "2020-02-05T08:51:50Z", "type": "commit"}, {"oid": "03e18f74b7c4b635af56f68c6372ea1566055ea4", "url": "https://github.com/apache/iotdb/commit/03e18f74b7c4b635af56f68c6372ea1566055ea4", "message": "Add tests", "committedDate": "2020-02-05T15:00:36Z", "type": "commit"}, {"oid": "5a06b8d762fc77925a27082b3bfa098e1742e10a", "url": "https://github.com/apache/iotdb/commit/5a06b8d762fc77925a27082b3bfa098e1742e10a", "message": "Add test", "committedDate": "2020-02-06T00:25:27Z", "type": "commit"}, {"oid": "3b06b1ff789eb660964ffe39f39015193b45453a", "url": "https://github.com/apache/iotdb/commit/3b06b1ff789eb660964ffe39f39015193b45453a", "message": "Extract series test util", "committedDate": "2020-02-06T02:42:23Z", "type": "commit"}, {"oid": "d7e4a549afc4e53d0999ae404544cc3ca69c7841", "url": "https://github.com/apache/iotdb/commit/d7e4a549afc4e53d0999ae404544cc3ca69c7841", "message": "Merge remote-tracking branch 'upstream/new_series_reader' into new_series_reader", "committedDate": "2020-02-06T02:45:38Z", "type": "commit"}, {"oid": "5570ec2b4ad9b6b9f18dc359667c2b534ea164ef", "url": "https://github.com/apache/iotdb/commit/5570ec2b4ad9b6b9f18dc359667c2b534ea164ef", "message": "Add license", "committedDate": "2020-02-06T04:16:07Z", "type": "commit"}, {"oid": "4e998ab35ad9a2294d81af6ba70c4867b2f257fb", "url": "https://github.com/apache/iotdb/commit/4e998ab35ad9a2294d81af6ba70c4867b2f257fb", "message": "Merge remote-tracking branch 'upstream/new_series_reader' into new_series_reader", "committedDate": "2020-02-06T09:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc0MTQwNw==", "url": "https://github.com/apache/iotdb/pull/769#discussion_r375741407", "body": "```suggestion\r\npublic class SeriesReaderTestUtil {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class SeriesTestUtil {\n          \n          \n            \n            public class SeriesReaderTestUtil {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">SeriesTestUtil</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">public</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">SeriesReaderTestUtil</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-06T10:03:30Z", "path": "server/src/test/java/org/apache/iotdb/db/query/reader/series/SeriesTestUtil.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.iotdb.db.query.reader.series;\n+\n+import static org.apache.iotdb.db.conf.IoTDBConstant.PATH_SEPARATOR;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.List;\n+import org.apache.iotdb.db.conf.IoTDBConstant;\n+import org.apache.iotdb.db.constant.TestConstant;\n+import org.apache.iotdb.db.engine.cache.DeviceMetaDataCache;\n+import org.apache.iotdb.db.engine.cache.TsFileMetaDataCache;\n+import org.apache.iotdb.db.engine.merge.manage.MergeManager;\n+import org.apache.iotdb.db.engine.storagegroup.TsFileResource;\n+import org.apache.iotdb.db.exception.metadata.MetadataException;\n+import org.apache.iotdb.db.exception.path.PathException;\n+import org.apache.iotdb.db.metadata.MManager;\n+import org.apache.iotdb.db.query.control.FileReaderManager;\n+import org.apache.iotdb.db.utils.EnvironmentUtils;\n+import org.apache.iotdb.tsfile.exception.write.WriteProcessException;\n+import org.apache.iotdb.tsfile.file.metadata.enums.CompressionType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSEncoding;\n+import org.apache.iotdb.tsfile.write.TsFileWriter;\n+import org.apache.iotdb.tsfile.write.record.TSRecord;\n+import org.apache.iotdb.tsfile.write.record.datapoint.DataPoint;\n+import org.apache.iotdb.tsfile.write.schema.MeasurementSchema;\n+\n+public class SeriesTestUtil {", "originalCommit": "5570ec2b4ad9b6b9f18dc359667c2b534ea164ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "88f5a669a26f1abab44416cfdc4b3630d6738bdc", "url": "https://github.com/apache/iotdb/commit/88f5a669a26f1abab44416cfdc4b3630d6738bdc", "message": "Enhance IT test for aggregation query with more than one functions on one series", "committedDate": "2020-02-06T10:21:23Z", "type": "commit"}, {"oid": "838953099a39cec502bf2708e5eeb6d5f34e859e", "url": "https://github.com/apache/iotdb/commit/838953099a39cec502bf2708e5eeb6d5f34e859e", "message": "Rename", "committedDate": "2020-02-06T10:37:06Z", "type": "commit"}]}