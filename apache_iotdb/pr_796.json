{"pr_number": 796, "pr_title": "[IoTDB-468] Restructure QueryPlan", "pr_author": "Alima777", "pr_createdAt": "2020-02-12T06:37:28Z", "pr_url": "https://github.com/apache/iotdb/pull/796", "timeline": [{"oid": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "url": "https://github.com/apache/iotdb/commit/d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "message": "Restructure QueryPlan", "committedDate": "2020-02-12T06:31:52Z", "type": "commit"}, {"oid": "d54050b5f747913df6e59ac713499b284cb708b0", "url": "https://github.com/apache/iotdb/commit/d54050b5f747913df6e59ac713499b284cb708b0", "message": "Modify isGroupByDevice to isAlignByDevice", "committedDate": "2020-02-12T08:24:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3Nzk2Nw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378077967", "body": "```suggestion\r\n  private List<String> measurements; // e.g. temperature\r\n```\r\n\r\ngive a more complex example, such as m1, m2, m3", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private List<String> measurements; // for group by device sql, e.g. temperature\n          \n          \n            \n              private List<String> measurements; // e.g. temperature\n          \n      \n    \n    \n  \n\ngive a more complex example, such as m1, m2, m3", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">String</span>&gt;</span> measurements; <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">for group by device sql, </span>e.g. temperature</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">String</span>&gt;</span> measurements; <span class=\"pl-c\"><span class=\"pl-c\">//</span> e.g. temperature</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">give a more complex example, such as m1, m2, m3</p>", "author": "qiaojialin", "createdAt": "2020-02-12T07:29:10Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA4Nzg0Nw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378087847", "bodyText": "What's the difference between this measurements with the paths in QueryPlan?\nRefactor the organization or rename this field", "author": "qiaojialin", "createdAt": "2020-02-12T07:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3Nzk2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0MzMxNA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378143314", "bodyText": "Actually, the paths in QueryPlan are paths of all devices. It's for verification and complete DataTypeMap to execute the datatypes for the execution paths this time in DataSet.", "author": "Alima777", "createdAt": "2020-02-12T09:52:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3Nzk2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 310dd1a37..7cc690ce1 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -29,15 +29,25 @@ import org.apache.iotdb.tsfile.read.expression.IExpression;\n \n public class AlignByDevicePlan extends QueryPlan {\n \n-  private List<String> measurements; // for group by device sql, e.g. temperature\n-  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n-  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n-  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+  private List<String> measurements; // e.g. temperature, status, speed\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // e.g. root.ln.d1 -> temperature\n+  // to check data type consistency for the same name sensor of different devices\n+  private Map<String, TSDataType> dataTypeConsistencyChecker;\n+  private Map<String, IExpression> deviceToFilterMap;\n \n   private GroupByPlan groupByPlan;\n   private FillQueryPlan fillQueryPlan;\n   private AggregationPlan aggregationPlan;\n \n+  // the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>();\n+  // the measurements that have quotation mark. e.g. \"abc\",\n+  // '11', the data type is considered as String and the value is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>();\n+\n   public AlignByDevicePlan() {\n     super();\n   }\n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 7cc690ce1..b482e854c 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -52,10 +52,6 @@ public class AlignByDevicePlan extends QueryPlan {\n     super();\n   }\n \n-  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n-    super(isQuery, operatorType);\n-  }\n-\n   public void setMeasurements(List<String> measurements) {\n     this.measurements = measurements;\n   }\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODA3OQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378078079", "body": "the same as above", "bodyText": "the same as above", "bodyHTML": "<p dir=\"auto\">the same as above</p>", "author": "qiaojialin", "createdAt": "2020-02-12T07:29:27Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0MzQ5Nw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378143497", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T09:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODA3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 310dd1a37..7cc690ce1 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -29,15 +29,25 @@ import org.apache.iotdb.tsfile.read.expression.IExpression;\n \n public class AlignByDevicePlan extends QueryPlan {\n \n-  private List<String> measurements; // for group by device sql, e.g. temperature\n-  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n-  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n-  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+  private List<String> measurements; // e.g. temperature, status, speed\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // e.g. root.ln.d1 -> temperature\n+  // to check data type consistency for the same name sensor of different devices\n+  private Map<String, TSDataType> dataTypeConsistencyChecker;\n+  private Map<String, IExpression> deviceToFilterMap;\n \n   private GroupByPlan groupByPlan;\n   private FillQueryPlan fillQueryPlan;\n   private AggregationPlan aggregationPlan;\n \n+  // the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>();\n+  // the measurements that have quotation mark. e.g. \"abc\",\n+  // '11', the data type is considered as String and the value is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>();\n+\n   public AlignByDevicePlan() {\n     super();\n   }\n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 7cc690ce1..b482e854c 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -52,10 +52,6 @@ public class AlignByDevicePlan extends QueryPlan {\n     super();\n   }\n \n-  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n-    super(isQuery, operatorType);\n-  }\n-\n   public void setMeasurements(List<String> measurements) {\n     this.measurements = measurements;\n   }\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODcyNw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378078727", "body": "```suggestion\r\n  private Map<String, TSDataType> seriesTypeMap; // e.g. root.ln.d1.temperature -> Float\r\n```\r\n\r\nmake the field name clear", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n          \n          \n            \n              private Map<String, TSDataType> seriesTypeMap; // e.g. root.ln.d1.temperature -> Float\n          \n      \n    \n    \n  \n\nmake the field name clear", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">TSDataType</span>&gt;</span> <span class=\"x x-first x-last\">dataTypeConsistencyChecker</span>; <span class=\"pl-c\"><span class=\"pl-c\">//</span><span class=\"x x-first x-last\"> for group by device sql,</span> e.g. root.ln.d1.temperature -&gt; Float</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">TSDataType</span>&gt;</span> <span class=\"x x-first x-last\">seriesTypeMap</span>; <span class=\"pl-c\"><span class=\"pl-c\">//</span> e.g. root.ln.d1.temperature -&gt; Float</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">make the field name clear</p>", "author": "qiaojialin", "createdAt": "2020-02-12T07:31:26Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0NTEzMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378145132", "bodyText": "Add a comment to explain it.", "author": "Alima777", "createdAt": "2020-02-12T09:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODcyNw=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 310dd1a37..7cc690ce1 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -29,15 +29,25 @@ import org.apache.iotdb.tsfile.read.expression.IExpression;\n \n public class AlignByDevicePlan extends QueryPlan {\n \n-  private List<String> measurements; // for group by device sql, e.g. temperature\n-  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n-  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n-  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+  private List<String> measurements; // e.g. temperature, status, speed\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // e.g. root.ln.d1 -> temperature\n+  // to check data type consistency for the same name sensor of different devices\n+  private Map<String, TSDataType> dataTypeConsistencyChecker;\n+  private Map<String, IExpression> deviceToFilterMap;\n \n   private GroupByPlan groupByPlan;\n   private FillQueryPlan fillQueryPlan;\n   private AggregationPlan aggregationPlan;\n \n+  // the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>();\n+  // the measurements that have quotation mark. e.g. \"abc\",\n+  // '11', the data type is considered as String and the value is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>();\n+\n   public AlignByDevicePlan() {\n     super();\n   }\n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 7cc690ce1..b482e854c 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -52,10 +52,6 @@ public class AlignByDevicePlan extends QueryPlan {\n     super();\n   }\n \n-  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n-    super(isQuery, operatorType);\n-  }\n-\n   public void setMeasurements(List<String> measurements) {\n     this.measurements = measurements;\n   }\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODk4NA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378078984", "body": "why there isn't a RawDataQueryPan", "bodyText": "why there isn't a RawDataQueryPan", "bodyHTML": "<p dir=\"auto\">why there isn't a RawDataQueryPan</p>", "author": "qiaojialin", "createdAt": "2020-02-12T07:32:14Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0NTUwNw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378145507", "bodyText": "Of course there isn't a RawDataQueryPan. We don't need parameters in it.", "author": "Alima777", "createdAt": "2020-02-12T09:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIyNzQxNg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378227416", "bodyText": "but you need to do a RawData query for each device a", "author": "qiaojialin", "createdAt": "2020-02-12T12:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODk4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMzMDc5Nw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378330797", "bodyText": "I have added a RawDataQueryPlan in AlignByDeviceDataSet.", "author": "Alima777", "createdAt": "2020-02-12T15:38:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3ODk4NA=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 310dd1a37..7cc690ce1 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -29,15 +29,25 @@ import org.apache.iotdb.tsfile.read.expression.IExpression;\n \n public class AlignByDevicePlan extends QueryPlan {\n \n-  private List<String> measurements; // for group by device sql, e.g. temperature\n-  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n-  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n-  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+  private List<String> measurements; // e.g. temperature, status, speed\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // e.g. root.ln.d1 -> temperature\n+  // to check data type consistency for the same name sensor of different devices\n+  private Map<String, TSDataType> dataTypeConsistencyChecker;\n+  private Map<String, IExpression> deviceToFilterMap;\n \n   private GroupByPlan groupByPlan;\n   private FillQueryPlan fillQueryPlan;\n   private AggregationPlan aggregationPlan;\n \n+  // the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>();\n+  // the measurements that have quotation mark. e.g. \"abc\",\n+  // '11', the data type is considered as String and the value is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>();\n+\n   public AlignByDevicePlan() {\n     super();\n   }\n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 7cc690ce1..b482e854c 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -52,10 +52,6 @@ public class AlignByDevicePlan extends QueryPlan {\n     super();\n   }\n \n-  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n-    super(isQuery, operatorType);\n-  }\n-\n   public void setMeasurements(List<String> measurements) {\n     this.measurements = measurements;\n   }\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3OTE4Ng==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378079186", "body": "put fields in the front of the class", "bodyText": "put fields in the front of the class", "bodyHTML": "<p dir=\"auto\">put fields in the front of the class</p>", "author": "qiaojialin", "createdAt": "2020-02-12T07:32:48Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n+    super(isQuery, operatorType);\n+  }\n+\n+  public void setMeasurements(List<String> measurements) {\n+    this.measurements = measurements;\n+  }\n+\n+  public List<String> getMeasurements() {\n+    return measurements;\n+  }\n+\n+  public void setMeasurementsGroupByDevice(\n+      Map<String, Set<String>> deviceToMeasurementsMap) {\n+    this.deviceToMeasurementsMap = deviceToMeasurementsMap;\n+  }\n+\n+  public Map<String, Set<String>> getDeviceToMeasurementsMap() {\n+    return deviceToMeasurementsMap;\n+  }\n+\n+  public void setDataTypeConsistencyChecker(\n+      Map<String, TSDataType> dataTypeConsistencyChecker) {\n+    this.dataTypeConsistencyChecker = dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, TSDataType> getDataTypeConsistencyChecker() {\n+    return dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, IExpression> getDeviceToFilterMap() {\n+    return deviceToFilterMap;\n+  }\n+\n+  public void setDeviceToFilterMap(Map<String, IExpression> deviceToFilterMap) {\n+    this.deviceToFilterMap = deviceToFilterMap;\n+  }\n+\n+  public GroupByPlan getGroupByPlan() {\n+    return groupByPlan;\n+  }\n+\n+  public void setGroupByPlan(GroupByPlan groupByPlan) {\n+    this.groupByPlan = groupByPlan;\n+    this.setOperatorType(OperatorType.GROUPBY);\n+  }\n+\n+  public FillQueryPlan getFillQueryPlan() {\n+    return fillQueryPlan;\n+  }\n+\n+  public void setFillQueryPlan(FillQueryPlan fillQueryPlan) {\n+    this.fillQueryPlan = fillQueryPlan;\n+    this.setOperatorType(OperatorType.FILL);\n+  }\n+\n+  public AggregationPlan getAggregationPlan() {\n+    return aggregationPlan;\n+  }\n+\n+  public void setAggregationPlan(AggregationPlan aggregationPlan) {\n+    this.aggregationPlan = aggregationPlan;\n+    this.setOperatorType(Operator.OperatorType.AGGREGATION);\n+  }\n+\n+  //the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  ; // for group by device sql\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>(); // for group by device sql\n+  //the measurements that have quotation mark. e.g., \"abc\",\n+  // '11', the data type is considered as String and the value  is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>(); // for group by device sql\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>(); // for group by device sql", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0NTY2Mw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378145663", "bodyText": "OK.", "author": "Alima777", "createdAt": "2020-02-12T09:56:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3OTE4Ng=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 310dd1a37..7cc690ce1 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -107,16 +117,6 @@ public class AlignByDevicePlan extends QueryPlan {\n     this.setOperatorType(Operator.OperatorType.AGGREGATION);\n   }\n \n-  //the measurements that do not exist in any device,\n-  // data type is considered as Boolean. The value is considered as null\n-  private List<String> notExistMeasurements = new ArrayList<>();\n-  ; // for group by device sql\n-  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>(); // for group by device sql\n-  //the measurements that have quotation mark. e.g., \"abc\",\n-  // '11', the data type is considered as String and the value  is considered is the same with measurement name\n-  private List<String> constMeasurements = new ArrayList<>(); // for group by device sql\n-  private List<Integer> positionOfConstMeasurements = new ArrayList<>(); // for group by device sql\n-\n   //we use the following algorithm to reproduce the order of measurements that user writes.\n   //suppose user writes SELECT 'c1',a1,b1,b2,'c2',a2,a3,'c3',b3,a4,a5 FROM ... where for each a_i\n   // column there is at least one device having it, and for each b_i column there is no device\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3OTYwMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378079602", "body": "remove this ", "bodyText": "remove this", "bodyHTML": "<p dir=\"auto\">remove this</p>", "author": "qiaojialin", "createdAt": "2020-02-12T07:34:07Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n+    super(isQuery, operatorType);\n+  }\n+\n+  public void setMeasurements(List<String> measurements) {\n+    this.measurements = measurements;\n+  }\n+\n+  public List<String> getMeasurements() {\n+    return measurements;\n+  }\n+\n+  public void setMeasurementsGroupByDevice(\n+      Map<String, Set<String>> deviceToMeasurementsMap) {\n+    this.deviceToMeasurementsMap = deviceToMeasurementsMap;\n+  }\n+\n+  public Map<String, Set<String>> getDeviceToMeasurementsMap() {\n+    return deviceToMeasurementsMap;\n+  }\n+\n+  public void setDataTypeConsistencyChecker(\n+      Map<String, TSDataType> dataTypeConsistencyChecker) {\n+    this.dataTypeConsistencyChecker = dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, TSDataType> getDataTypeConsistencyChecker() {\n+    return dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, IExpression> getDeviceToFilterMap() {\n+    return deviceToFilterMap;\n+  }\n+\n+  public void setDeviceToFilterMap(Map<String, IExpression> deviceToFilterMap) {\n+    this.deviceToFilterMap = deviceToFilterMap;\n+  }\n+\n+  public GroupByPlan getGroupByPlan() {\n+    return groupByPlan;\n+  }\n+\n+  public void setGroupByPlan(GroupByPlan groupByPlan) {\n+    this.groupByPlan = groupByPlan;\n+    this.setOperatorType(OperatorType.GROUPBY);\n+  }\n+\n+  public FillQueryPlan getFillQueryPlan() {\n+    return fillQueryPlan;\n+  }\n+\n+  public void setFillQueryPlan(FillQueryPlan fillQueryPlan) {\n+    this.fillQueryPlan = fillQueryPlan;\n+    this.setOperatorType(OperatorType.FILL);\n+  }\n+\n+  public AggregationPlan getAggregationPlan() {\n+    return aggregationPlan;\n+  }\n+\n+  public void setAggregationPlan(AggregationPlan aggregationPlan) {\n+    this.aggregationPlan = aggregationPlan;\n+    this.setOperatorType(Operator.OperatorType.AGGREGATION);\n+  }\n+\n+  //the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  ; // for group by device sql", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0NjQ4Ng==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378146486", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T09:58:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3OTYwMg=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 310dd1a37..7cc690ce1 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -107,16 +117,6 @@ public class AlignByDevicePlan extends QueryPlan {\n     this.setOperatorType(Operator.OperatorType.AGGREGATION);\n   }\n \n-  //the measurements that do not exist in any device,\n-  // data type is considered as Boolean. The value is considered as null\n-  private List<String> notExistMeasurements = new ArrayList<>();\n-  ; // for group by device sql\n-  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>(); // for group by device sql\n-  //the measurements that have quotation mark. e.g., \"abc\",\n-  // '11', the data type is considered as String and the value  is considered is the same with measurement name\n-  private List<String> constMeasurements = new ArrayList<>(); // for group by device sql\n-  private List<Integer> positionOfConstMeasurements = new ArrayList<>(); // for group by device sql\n-\n   //we use the following algorithm to reproduce the order of measurements that user writes.\n   //suppose user writes SELECT 'c1',a1,b1,b2,'c2',a2,a3,'c3',b3,a4,a5 FROM ... where for each a_i\n   // column there is at least one device having it, and for each b_i column there is no device\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA4MjczNQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378082735", "body": "min what?", "bodyText": "min what?", "bodyHTML": "<p dir=\"auto\">min what?</p>", "author": "qiaojialin", "createdAt": "2020-02-12T07:43:20Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // for group by device sql, e.g. temperature\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // for group by device sql, e.g. root.ln.d1 -> temperature\n+  private Map<String, TSDataType> dataTypeConsistencyChecker; // for group by device sql, e.g. root.ln.d1.temperature -> Float\n+  private Map<String, IExpression> deviceToFilterMap; // for group by device sql\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n+    super(isQuery, operatorType);\n+  }\n+\n+  public void setMeasurements(List<String> measurements) {\n+    this.measurements = measurements;\n+  }\n+\n+  public List<String> getMeasurements() {\n+    return measurements;\n+  }\n+\n+  public void setMeasurementsGroupByDevice(\n+      Map<String, Set<String>> deviceToMeasurementsMap) {\n+    this.deviceToMeasurementsMap = deviceToMeasurementsMap;\n+  }\n+\n+  public Map<String, Set<String>> getDeviceToMeasurementsMap() {\n+    return deviceToMeasurementsMap;\n+  }\n+\n+  public void setDataTypeConsistencyChecker(\n+      Map<String, TSDataType> dataTypeConsistencyChecker) {\n+    this.dataTypeConsistencyChecker = dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, TSDataType> getDataTypeConsistencyChecker() {\n+    return dataTypeConsistencyChecker;\n+  }\n+\n+  public Map<String, IExpression> getDeviceToFilterMap() {\n+    return deviceToFilterMap;\n+  }\n+\n+  public void setDeviceToFilterMap(Map<String, IExpression> deviceToFilterMap) {\n+    this.deviceToFilterMap = deviceToFilterMap;\n+  }\n+\n+  public GroupByPlan getGroupByPlan() {\n+    return groupByPlan;\n+  }\n+\n+  public void setGroupByPlan(GroupByPlan groupByPlan) {\n+    this.groupByPlan = groupByPlan;\n+    this.setOperatorType(OperatorType.GROUPBY);\n+  }\n+\n+  public FillQueryPlan getFillQueryPlan() {\n+    return fillQueryPlan;\n+  }\n+\n+  public void setFillQueryPlan(FillQueryPlan fillQueryPlan) {\n+    this.fillQueryPlan = fillQueryPlan;\n+    this.setOperatorType(OperatorType.FILL);\n+  }\n+\n+  public AggregationPlan getAggregationPlan() {\n+    return aggregationPlan;\n+  }\n+\n+  public void setAggregationPlan(AggregationPlan aggregationPlan) {\n+    this.aggregationPlan = aggregationPlan;\n+    this.setOperatorType(Operator.OperatorType.AGGREGATION);\n+  }\n+\n+  //the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  ; // for group by device sql\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>(); // for group by device sql\n+  //the measurements that have quotation mark. e.g., \"abc\",\n+  // '11', the data type is considered as String and the value  is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>(); // for group by device sql\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>(); // for group by device sql\n+\n+  //we use the following algorithm to reproduce the order of measurements that user writes.\n+  //suppose user writes SELECT 'c1',a1,b1,b2,'c2',a2,a3,'c3',b3,a4,a5 FROM ... where for each a_i\n+  // column there is at least one device having it, and for each b_i column there is no device\n+  // having it, and 'c_i' is a const column.\n+  // Then, measurements = {a1, a2, a3, a4, a5};\n+  // notExistMeasurements = {b1, b2, b3}, and positionOfNotExistMeasurements = {2, 3, 8};\n+  // constMeasurements = {'c1', 'c2', 'c3'}, and positionOfConstMeasurements = {0, 4, 7}.\n+  // When to reproduce the order of measurements. The pseudocode is:\n+  //<pre>\n+  // current = 0;\n+  // if (min(notExist, const) <= current) {", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0ODI4Mg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378148282", "bodyText": "I don't understand it too. Let's call that guy writing this comment to modify.", "author": "Alima777", "createdAt": "2020-02-12T10:01:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA4MjczNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI0ODMwOA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378248308", "bodyText": "Hi, I am the author :-D\nNotice that:\npositionOfNotExistMeasurements = {2, 3, 8} \npositionOfConstMeasurements = {0, 4, 7}\n\nThen\nif (min(notExist, const) <= current)\n\nmeans if min(positionOfNotExistMeasurements[i], positionOfConstMeasurements[j]) < current", "author": "jixuan1989", "createdAt": "2020-02-12T13:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA4MjczNQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MDI3Mg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378090272", "body": "```suggestion\r\n    if (queryOperator.isAlignByDevice()) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (queryOperator.isGroupByDevice()) {\n          \n          \n            \n                if (queryOperator.isAlignByDevice()) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">if</span> (queryOperator<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">isGroupByDevice</span>()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">if</span> (queryOperator<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">isAlignByDevice</span>()) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-12T08:04:51Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -242,16 +244,26 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n       ((AggregationPlan) queryPlan)\n           .setAggregations(queryOperator.getSelectOperator().getAggregations());\n     } else {\n-      queryPlan = new QueryPlan();\n+      queryPlan = new RawDataQueryPlan();\n     }\n     if (queryOperator.isGroupByDevice()) {", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MDYzMw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378090633", "bodyText": "Futher, should the QueryOperator be separate to different type?", "author": "qiaojialin", "createdAt": "2020-02-12T08:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MDI3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0ODcyOQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378148729", "bodyText": "I think it's nice now.", "author": "Alima777", "createdAt": "2020-02-12T10:02:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MDI3Mg=="}], "type": "inlineReview", "revised_code": {"commit": "d54050b5f747913df6e59ac713499b284cb708b0", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java b/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\nindex 376030a3c..e9e360f36 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\n", "chunk": "@@ -246,7 +246,7 @@ public class PhysicalGenerator {\n     } else {\n       queryPlan = new RawDataQueryPlan();\n     }\n-    if (queryOperator.isGroupByDevice()) {\n+    if (queryOperator.isAlignByDevice()) {\n       // below is the core realization of ALIGN_BY_DEVICE sql logic\n       AlignByDevicePlan alignByDevicePlan = new AlignByDevicePlan();\n       if (queryPlan instanceof GroupByPlan) {\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MTkxMw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378091913", "body": "```suggestion\r\n      ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(seriesTypeMap);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(dataTypeConsistencyChecker);\n          \n          \n            \n                  ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(seriesTypeMap);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      ((<span class=\"pl-smi\">AlignByDevicePlan</span>) queryPlan)<span class=\"pl-k\">.</span>setDataTypeConsistencyChecker(<span class=\"x x-first x-last\">dataTypeConsistencyChecker</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      ((<span class=\"pl-smi\">AlignByDevicePlan</span>) queryPlan)<span class=\"pl-k\">.</span>setDataTypeConsistencyChecker(<span class=\"x x-first x-last\">seriesTypeMap</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-12T08:09:29Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -373,17 +386,17 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n       }\n \n       // assigns to queryPlan\n-      queryPlan.setGroupByDevice(true);\n-      queryPlan.setMeasurements(measurements);\n-      queryPlan.setMeasurementsGroupByDevice(measurementsGroupByDevice);\n-      queryPlan.setDataTypeConsistencyChecker(dataTypeConsistencyChecker);\n+      ((AlignByDevicePlan) queryPlan).setMeasurements(measurements);\n+      ((AlignByDevicePlan) queryPlan).setMeasurementsGroupByDevice(deviceToMeasurementsMap);\n+      ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(dataTypeConsistencyChecker);", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE0ODg0Nw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378148847", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MTkxMw=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java b/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\nindex 376030a3c..60ab8a5a7 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\n", "chunk": "@@ -385,21 +384,22 @@ public class PhysicalGenerator {\n         measurements = slimitTrimColumn(measurements, seriesSlimit, seriesOffset);\n       }\n \n-      // assigns to queryPlan\n-      ((AlignByDevicePlan) queryPlan).setMeasurements(measurements);\n-      ((AlignByDevicePlan) queryPlan).setMeasurementsGroupByDevice(deviceToMeasurementsMap);\n-      ((AlignByDevicePlan) queryPlan).setDataTypeConsistencyChecker(dataTypeConsistencyChecker);\n-      queryPlan.setPaths(paths);\n+      // assigns to alignByDevicePlan\n+      alignByDevicePlan.setMeasurements(measurements);\n+      alignByDevicePlan.setMeasurementsGroupByDevice(deviceToMeasurementsMap);\n+      alignByDevicePlan.setDataTypeConsistencyChecker(dataTypeConsistencyChecker);\n+      alignByDevicePlan.setPaths(paths);\n \n       // get device to filter map\n       FilterOperator filterOperator = queryOperator.getFilterOperator();\n \n       if (filterOperator != null) {\n-        ((AlignByDevicePlan) queryPlan)\n-            .setDeviceToFilterMap(concatFilterByDivice(prefixPaths, filterOperator));\n+        alignByDevicePlan.setDeviceToFilterMap(concatFilterByDevice(prefixPaths, filterOperator));\n       }\n+\n+      queryPlan = alignByDevicePlan;\n     } else {\n-      queryPlan.setAlignByTime(queryOperator.isAlign());\n+      queryPlan.setAlignByTime(queryOperator.isAlignByTime());\n       List<Path> paths = queryOperator.getSelectedPaths();\n       queryPlan.setPaths(paths);\n \n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MzA2Nw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378093067", "body": "This line could be put in the last, then you do not need to convert query plan to an AlignByDevicePlan each time", "bodyText": "This line could be put in the last, then you do not need to convert query plan to an AlignByDevicePlan each time", "bodyHTML": "<p dir=\"auto\">This line could be put in the last, then you do not need to convert query plan to an AlignByDevicePlan each time</p>", "author": "qiaojialin", "createdAt": "2020-02-12T08:12:32Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -242,16 +244,26 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n       ((AggregationPlan) queryPlan)\n           .setAggregations(queryOperator.getSelectOperator().getAggregations());\n     } else {\n-      queryPlan = new QueryPlan();\n+      queryPlan = new RawDataQueryPlan();\n     }\n     if (queryOperator.isGroupByDevice()) {\n-      // below is the core realization of GROUP_BY_DEVICE sql logic\n+      // below is the core realization of ALIGN_BY_DEVICE sql logic\n+      AlignByDevicePlan alignByDevicePlan = new AlignByDevicePlan();\n+      if (queryPlan instanceof GroupByPlan) {\n+        alignByDevicePlan.setGroupByPlan((GroupByPlan) queryPlan);\n+      } else if (queryPlan instanceof FillQueryPlan) {\n+        alignByDevicePlan.setFillQueryPlan((FillQueryPlan) queryPlan);\n+      } else if (queryPlan instanceof AggregationPlan) {\n+        alignByDevicePlan.setAggregationPlan((AggregationPlan) queryPlan);\n+      }\n+\n+      queryPlan = alignByDevicePlan;", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1NzAzMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378157032", "bodyText": "Thank you for advice! Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MzA2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java b/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\nindex 376030a3c..60ab8a5a7 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java\n", "chunk": "@@ -257,7 +257,6 @@ public class PhysicalGenerator {\n         alignByDevicePlan.setAggregationPlan((AggregationPlan) queryPlan);\n       }\n \n-      queryPlan = alignByDevicePlan;\n       List<Path> prefixPaths = queryOperator.getFromOperator().getPrefixPaths();\n       List<Path> suffixPaths = queryOperator.getSelectOperator().getSuffixPaths();\n       List<String> originAggregations = queryOperator.getSelectOperator().getAggregations();\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MzU1NQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378093555", "body": "There is a typo in line 426, divice", "bodyText": "There is a typo in line 426, divice", "bodyHTML": "<p dir=\"auto\">There is a typo in line 426, divice</p>", "author": "qiaojialin", "createdAt": "2020-02-12T08:13:51Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/strategy/PhysicalGenerator.java", "diffHunk": "@@ -395,7 +408,7 @@ private PhysicalPlan transformQuery(QueryOperator queryOperator)\n \n       if (filterOperator != null) {\n         IExpression expression = filterOperator.transformToExpression();\n-        queryPlan.setExpression(expression);\n+        ((RawDataQueryPlan) queryPlan).setExpression(expression);\n       }\n     }\n     generateDataTypes(queryPlan);", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1NzQ5NA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378157494", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5MzU1NQ=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5NDk3Ng==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378094976", "body": "remove the for group by device comment", "bodyText": "remove the for group by device comment", "bodyHTML": "<p dir=\"auto\">remove the for group by device comment</p>", "author": "qiaojialin", "createdAt": "2020-02-12T08:17:16Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1NzkwMA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378157900", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5NDk3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nindex 83d5aacb6..df16e9c05 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n", "chunk": "@@ -55,27 +54,21 @@ public class DeviceIterateDataSet extends QueryDataSet {\n   private IExpression expression;\n \n   private List<String> deduplicatedMeasurementColumns;\n-  private Map<String, Set<String>> measurementColumnsGroupByDevice;\n+  private Map<String, Set<String>> deviceToMeasurementsMap;\n   private Map<String, IExpression> deviceToFilterMap;\n \n-  //the measurements that do not exist in any device,\n+  // the measurements that do not exist in any device,\n   // data type is considered as Boolean. The value is considered as null\n-  private List<String> notExistMeasurements; // for group by device sql\n-  private List<Integer> positionOfNotExistMeasurements; // for group by device sql\n-  //the measurements that have quotation mark. e.g., \"abc\",\n-  // '11', the data type is considered as String and the value  is considered is the same with measurement name\n-  private List<String> constMeasurements; // for group by device sql\n-  private List<Integer> positionOfConstMeasurements; // for group by device sql\n+  private List<String> notExistMeasurements;\n+  private List<Integer> positionOfNotExistMeasurements;\n+  // the measurements that have quotation mark. e.g. \"abc\",\n+  // '11', the data type is considered as String and the value is considered is the same with measurement name\n+  private List<String> constMeasurements;\n+  private List<Integer> positionOfConstMeasurements;\n \n-  // group-by-time parameters\n-  private long unit;\n-  private long slidingStep;\n-  private long startTime;\n-  private long endTime;\n-\n-  // fill parameters\n-  private long queryTime;\n-  private Map<TSDataType, IFill> fillType;\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n \n   private boolean curDataSetInitialized;\n   private Iterator<String> deviceIterator;\n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -69,6 +69,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n   private GroupByPlan groupByPlan;\n   private FillQueryPlan fillQueryPlan;\n   private AggregationPlan aggregationPlan;\n+  private RawDataQueryPlan rawDataQueryPlan;\n \n   private boolean curDataSetInitialized;\n   private Iterator<String> deviceIterator;\n", "next_change": null}, {"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -77,7 +78,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n+  public AlignByDeviceDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n     super(null, alignByDevicePlan.getDataTypes());\n \n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTE5OA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378099198", "body": "remove this comment", "bodyText": "remove this comment", "bodyHTML": "<p dir=\"auto\">remove this comment</p>", "author": "qiaojialin", "createdAt": "2020-02-12T08:26:52Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {\n       this.dataSetType = DataSetType.GROUPBY;\n       // assign parameters", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NzA2MQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378167061", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTE5OA=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nindex 83d5aacb6..df16e9c05 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n", "chunk": "@@ -93,36 +86,32 @@ public class DeviceIterateDataSet extends QueryDataSet {\n     this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToMeasurementsMap = alignByDevicePlan.getDeviceToMeasurementsMap();\n     this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n     this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n     this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n     this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n     this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n-    //BuildOutDataTypes();\n-\n-    if (alignByDevicePlan.getGroupByPlan() != null) {\n-      this.dataSetType = DataSetType.GROUPBY;\n-      // assign parameters\n-      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();\n-      this.slidingStep = alignByDevicePlan.getGroupByPlan().getSlidingStep();\n-      this.startTime = alignByDevicePlan.getGroupByPlan().getStartTime();\n-      this.endTime = alignByDevicePlan.getGroupByPlan().getEndTime();\n \n-    } else if (alignByDevicePlan.getAggregationPlan() != null) {\n-      this.dataSetType = DataSetType.AGGREGATE;\n-\n-    } else if (alignByDevicePlan.getFillQueryPlan() != null) {\n-      this.dataSetType = DataSetType.FILL;\n-      // assign parameters\n-      this.queryTime = alignByDevicePlan.getFillQueryPlan().getQueryTime();\n-      this.fillType = alignByDevicePlan.getFillQueryPlan().getFillType();\n-    } else {\n-      this.dataSetType = DataSetType.QUERY;\n+    switch (alignByDevicePlan.getOperatorType()){\n+      case GROUPBY:\n+        this.dataSetType = DataSetType.GROUPBY;\n+        this.groupByPlan = alignByDevicePlan.getGroupByPlan();\n+        break;\n+      case AGGREGATION:\n+        this.dataSetType = DataSetType.AGGREGATE;\n+        this.aggregationPlan = alignByDevicePlan.getAggregationPlan();\n+        break;\n+      case FILL:\n+        this.dataSetType = DataSetType.FILL;\n+        this.fillQueryPlan = alignByDevicePlan.getFillQueryPlan();\n+        break;\n+      default:\n+        this.dataSetType = DataSetType.QUERY;\n     }\n \n     this.curDataSetInitialized = false;\n-    this.deviceIterator = measurementColumnsGroupByDevice.keySet().iterator();\n+    this.deviceIterator = deviceToMeasurementsMap.keySet().iterator();\n     this.currentColumnMapRelation = new int[deduplicatedMeasurementColumns.size()];\n   }\n \n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -108,6 +109,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n         break;\n       default:\n         this.dataSetType = DataSetType.QUERY;\n+        this.rawDataQueryPlan = new RawDataQueryPlan();\n     }\n \n     this.curDataSetInitialized = false;\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTM5MA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378099390", "body": "remove this", "bodyText": "remove this", "bodyHTML": "<p dir=\"auto\">remove this</p>", "author": "qiaojialin", "createdAt": "2020-02-12T08:27:19Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NzA0MQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378167041", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:35:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTM5MA=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nindex 83d5aacb6..df16e9c05 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n", "chunk": "@@ -93,36 +86,32 @@ public class DeviceIterateDataSet extends QueryDataSet {\n     this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToMeasurementsMap = alignByDevicePlan.getDeviceToMeasurementsMap();\n     this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n     this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n     this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n     this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n     this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n-    //BuildOutDataTypes();\n-\n-    if (alignByDevicePlan.getGroupByPlan() != null) {\n-      this.dataSetType = DataSetType.GROUPBY;\n-      // assign parameters\n-      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();\n-      this.slidingStep = alignByDevicePlan.getGroupByPlan().getSlidingStep();\n-      this.startTime = alignByDevicePlan.getGroupByPlan().getStartTime();\n-      this.endTime = alignByDevicePlan.getGroupByPlan().getEndTime();\n \n-    } else if (alignByDevicePlan.getAggregationPlan() != null) {\n-      this.dataSetType = DataSetType.AGGREGATE;\n-\n-    } else if (alignByDevicePlan.getFillQueryPlan() != null) {\n-      this.dataSetType = DataSetType.FILL;\n-      // assign parameters\n-      this.queryTime = alignByDevicePlan.getFillQueryPlan().getQueryTime();\n-      this.fillType = alignByDevicePlan.getFillQueryPlan().getFillType();\n-    } else {\n-      this.dataSetType = DataSetType.QUERY;\n+    switch (alignByDevicePlan.getOperatorType()){\n+      case GROUPBY:\n+        this.dataSetType = DataSetType.GROUPBY;\n+        this.groupByPlan = alignByDevicePlan.getGroupByPlan();\n+        break;\n+      case AGGREGATION:\n+        this.dataSetType = DataSetType.AGGREGATE;\n+        this.aggregationPlan = alignByDevicePlan.getAggregationPlan();\n+        break;\n+      case FILL:\n+        this.dataSetType = DataSetType.FILL;\n+        this.fillQueryPlan = alignByDevicePlan.getFillQueryPlan();\n+        break;\n+      default:\n+        this.dataSetType = DataSetType.QUERY;\n     }\n \n     this.curDataSetInitialized = false;\n-    this.deviceIterator = measurementColumnsGroupByDevice.keySet().iterator();\n+    this.deviceIterator = deviceToMeasurementsMap.keySet().iterator();\n     this.currentColumnMapRelation = new int[deduplicatedMeasurementColumns.size()];\n   }\n \n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -108,6 +109,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n         break;\n       default:\n         this.dataSetType = DataSetType.QUERY;\n+        this.rawDataQueryPlan = new RawDataQueryPlan();\n     }\n \n     this.curDataSetInitialized = false;\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTQ5MQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378099491", "body": "remove this", "bodyText": "remove this", "bodyHTML": "<p dir=\"auto\">remove this</p>", "author": "qiaojialin", "createdAt": "2020-02-12T08:27:33Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {\n       this.dataSetType = DataSetType.GROUPBY;\n       // assign parameters\n-      this.unit = ((GroupByPlan) queryPlan).getInterval();\n-      this.slidingStep = ((GroupByPlan) queryPlan).getSlidingStep();\n-      this.startTime = ((GroupByPlan) queryPlan).getStartTime();\n-      this.endTime = ((GroupByPlan) queryPlan).getEndTime();\n+      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();\n+      this.slidingStep = alignByDevicePlan.getGroupByPlan().getSlidingStep();\n+      this.startTime = alignByDevicePlan.getGroupByPlan().getStartTime();\n+      this.endTime = alignByDevicePlan.getGroupByPlan().getEndTime();\n \n-    } else if (queryPlan instanceof AggregationPlan) {\n+    } else if (alignByDevicePlan.getAggregationPlan() != null) {\n       this.dataSetType = DataSetType.AGGREGATE;\n \n-    } else if (queryPlan instanceof FillQueryPlan) {\n+    } else if (alignByDevicePlan.getFillQueryPlan() != null) {\n       this.dataSetType = DataSetType.FILL;\n       // assign parameters", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1OTA0NQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378159045", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:20:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA5OTQ5MQ=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nindex 83d5aacb6..df16e9c05 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n", "chunk": "@@ -93,36 +86,32 @@ public class DeviceIterateDataSet extends QueryDataSet {\n     this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToMeasurementsMap = alignByDevicePlan.getDeviceToMeasurementsMap();\n     this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n     this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n     this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n     this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n     this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n-    //BuildOutDataTypes();\n-\n-    if (alignByDevicePlan.getGroupByPlan() != null) {\n-      this.dataSetType = DataSetType.GROUPBY;\n-      // assign parameters\n-      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();\n-      this.slidingStep = alignByDevicePlan.getGroupByPlan().getSlidingStep();\n-      this.startTime = alignByDevicePlan.getGroupByPlan().getStartTime();\n-      this.endTime = alignByDevicePlan.getGroupByPlan().getEndTime();\n \n-    } else if (alignByDevicePlan.getAggregationPlan() != null) {\n-      this.dataSetType = DataSetType.AGGREGATE;\n-\n-    } else if (alignByDevicePlan.getFillQueryPlan() != null) {\n-      this.dataSetType = DataSetType.FILL;\n-      // assign parameters\n-      this.queryTime = alignByDevicePlan.getFillQueryPlan().getQueryTime();\n-      this.fillType = alignByDevicePlan.getFillQueryPlan().getFillType();\n-    } else {\n-      this.dataSetType = DataSetType.QUERY;\n+    switch (alignByDevicePlan.getOperatorType()){\n+      case GROUPBY:\n+        this.dataSetType = DataSetType.GROUPBY;\n+        this.groupByPlan = alignByDevicePlan.getGroupByPlan();\n+        break;\n+      case AGGREGATION:\n+        this.dataSetType = DataSetType.AGGREGATE;\n+        this.aggregationPlan = alignByDevicePlan.getAggregationPlan();\n+        break;\n+      case FILL:\n+        this.dataSetType = DataSetType.FILL;\n+        this.fillQueryPlan = alignByDevicePlan.getFillQueryPlan();\n+        break;\n+      default:\n+        this.dataSetType = DataSetType.QUERY;\n     }\n \n     this.curDataSetInitialized = false;\n-    this.deviceIterator = measurementColumnsGroupByDevice.keySet().iterator();\n+    this.deviceIterator = deviceToMeasurementsMap.keySet().iterator();\n     this.currentColumnMapRelation = new int[deduplicatedMeasurementColumns.size()];\n   }\n \n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -108,6 +109,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n         break;\n       default:\n         this.dataSetType = DataSetType.QUERY;\n+        this.rawDataQueryPlan = new RawDataQueryPlan();\n     }\n \n     this.curDataSetInitialized = false;\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyNjE3Ng==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378126176", "body": "We could add a queryType in AlignByDevicePlan, and use switch here", "bodyText": "We could add a queryType in AlignByDevicePlan, and use switch here", "bodyHTML": "<p dir=\"auto\">We could add a queryType in AlignByDevicePlan, and use switch here</p>", "author": "qiaojialin", "createdAt": "2020-02-12T09:22:19Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MjkxNQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378162915", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:27:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyNjE3Ng=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nindex 83d5aacb6..df16e9c05 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n", "chunk": "@@ -93,36 +86,32 @@ public class DeviceIterateDataSet extends QueryDataSet {\n     this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToMeasurementsMap = alignByDevicePlan.getDeviceToMeasurementsMap();\n     this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n     this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n     this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n     this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n     this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n-    //BuildOutDataTypes();\n-\n-    if (alignByDevicePlan.getGroupByPlan() != null) {\n-      this.dataSetType = DataSetType.GROUPBY;\n-      // assign parameters\n-      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();\n-      this.slidingStep = alignByDevicePlan.getGroupByPlan().getSlidingStep();\n-      this.startTime = alignByDevicePlan.getGroupByPlan().getStartTime();\n-      this.endTime = alignByDevicePlan.getGroupByPlan().getEndTime();\n \n-    } else if (alignByDevicePlan.getAggregationPlan() != null) {\n-      this.dataSetType = DataSetType.AGGREGATE;\n-\n-    } else if (alignByDevicePlan.getFillQueryPlan() != null) {\n-      this.dataSetType = DataSetType.FILL;\n-      // assign parameters\n-      this.queryTime = alignByDevicePlan.getFillQueryPlan().getQueryTime();\n-      this.fillType = alignByDevicePlan.getFillQueryPlan().getFillType();\n-    } else {\n-      this.dataSetType = DataSetType.QUERY;\n+    switch (alignByDevicePlan.getOperatorType()){\n+      case GROUPBY:\n+        this.dataSetType = DataSetType.GROUPBY;\n+        this.groupByPlan = alignByDevicePlan.getGroupByPlan();\n+        break;\n+      case AGGREGATION:\n+        this.dataSetType = DataSetType.AGGREGATE;\n+        this.aggregationPlan = alignByDevicePlan.getAggregationPlan();\n+        break;\n+      case FILL:\n+        this.dataSetType = DataSetType.FILL;\n+        this.fillQueryPlan = alignByDevicePlan.getFillQueryPlan();\n+        break;\n+      default:\n+        this.dataSetType = DataSetType.QUERY;\n     }\n \n     this.curDataSetInitialized = false;\n-    this.deviceIterator = measurementColumnsGroupByDevice.keySet().iterator();\n+    this.deviceIterator = deviceToMeasurementsMap.keySet().iterator();\n     this.currentColumnMapRelation = new int[deduplicatedMeasurementColumns.size()];\n   }\n \n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -108,6 +109,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n         break;\n       default:\n         this.dataSetType = DataSetType.QUERY;\n+        this.rawDataQueryPlan = new RawDataQueryPlan();\n     }\n \n     this.curDataSetInitialized = false;\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyNzkxNg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378127916", "body": "Don't you save three plans in AlignByDevicePlan? They could be reused", "bodyText": "Don't you save three plans in AlignByDevicePlan? They could be reused", "bodyHTML": "<p dir=\"auto\">Don't you save three plans in AlignByDevicePlan? They could be reused</p>", "author": "qiaojialin", "createdAt": "2020-02-12T09:25:32Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -207,7 +211,7 @@ protected boolean hasNextWithoutConstraint() throws IOException {\n             currentDataSet = queryRouter.fill(fillQueryPlan, context);\n             break;\n           case QUERY:\n-            QueryPlan queryPlan = new QueryPlan();\n+            RawDataQueryPlan queryPlan = new RawDataQueryPlan();", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2Njk4Nw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378166987", "bodyText": "Good Idea. Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:35:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyNzkxNg=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nindex 83d5aacb6..df16e9c05 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n", "chunk": "@@ -203,9 +186,6 @@ public class DeviceIterateDataSet extends QueryDataSet {\n             currentDataSet = queryRouter.aggregate(aggregationPlan, context);\n             break;\n           case FILL:\n-            FillQueryPlan fillQueryPlan = new FillQueryPlan();\n-            fillQueryPlan.setFillType(fillType);\n-            fillQueryPlan.setQueryTime(queryTime);\n             fillQueryPlan.setDeduplicatedDataTypes(tsDataTypes);\n             fillQueryPlan.setDeduplicatedPaths(executePaths);\n             currentDataSet = queryRouter.fill(fillQueryPlan, context);\n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -191,11 +193,10 @@ public class DeviceIterateDataSet extends QueryDataSet {\n             currentDataSet = queryRouter.fill(fillQueryPlan, context);\n             break;\n           case QUERY:\n-            RawDataQueryPlan queryPlan = new RawDataQueryPlan();\n-            queryPlan.setDeduplicatedPaths(executePaths);\n-            queryPlan.setDeduplicatedDataTypes(tsDataTypes);\n-            queryPlan.setExpression(expression);\n-            currentDataSet = queryRouter.rawDataQuery(queryPlan, context);\n+            rawDataQueryPlan.setDeduplicatedPaths(executePaths);\n+            rawDataQueryPlan.setDeduplicatedDataTypes(tsDataTypes);\n+            rawDataQueryPlan.setExpression(expression);\n+            currentDataSet = queryRouter.rawDataQuery(rawDataQueryPlan, context);\n             break;\n           default:\n             throw new IOException(\"unsupported DataSetType\");\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyODIyMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378128222", "body": "Reuse the query plan in AlignByDevicePlan, no need to set the parameters again and again", "bodyText": "Reuse the query plan in AlignByDevicePlan, no need to set the parameters again and again", "bodyHTML": "<p dir=\"auto\">Reuse the query plan in AlignByDevicePlan, no need to set the parameters again and again</p>", "author": "qiaojialin", "createdAt": "2020-02-12T09:26:03Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,39 +84,39 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n+    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n     //BuildOutDataTypes();\n \n-    if (queryPlan instanceof GroupByPlan) {\n+    if (alignByDevicePlan.getGroupByPlan() != null) {\n       this.dataSetType = DataSetType.GROUPBY;\n       // assign parameters\n-      this.unit = ((GroupByPlan) queryPlan).getInterval();\n-      this.slidingStep = ((GroupByPlan) queryPlan).getSlidingStep();\n-      this.startTime = ((GroupByPlan) queryPlan).getStartTime();\n-      this.endTime = ((GroupByPlan) queryPlan).getEndTime();\n+      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();", "originalCommit": "d84de4d5565de3134d0eb9a8b9436fe9eab1f0be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NjkxNg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378166916", "bodyText": "Good Idea. Fixed.", "author": "Alima777", "createdAt": "2020-02-12T10:35:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODEyODIyMg=="}], "type": "inlineReview", "revised_code": {"commit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nindex 83d5aacb6..df16e9c05 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n", "chunk": "@@ -93,36 +86,32 @@ public class DeviceIterateDataSet extends QueryDataSet {\n     this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToMeasurementsMap = alignByDevicePlan.getDeviceToMeasurementsMap();\n     this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n     this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n     this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n     this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n     this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n-    //BuildOutDataTypes();\n-\n-    if (alignByDevicePlan.getGroupByPlan() != null) {\n-      this.dataSetType = DataSetType.GROUPBY;\n-      // assign parameters\n-      this.unit = alignByDevicePlan.getGroupByPlan().getInterval();\n-      this.slidingStep = alignByDevicePlan.getGroupByPlan().getSlidingStep();\n-      this.startTime = alignByDevicePlan.getGroupByPlan().getStartTime();\n-      this.endTime = alignByDevicePlan.getGroupByPlan().getEndTime();\n \n-    } else if (alignByDevicePlan.getAggregationPlan() != null) {\n-      this.dataSetType = DataSetType.AGGREGATE;\n-\n-    } else if (alignByDevicePlan.getFillQueryPlan() != null) {\n-      this.dataSetType = DataSetType.FILL;\n-      // assign parameters\n-      this.queryTime = alignByDevicePlan.getFillQueryPlan().getQueryTime();\n-      this.fillType = alignByDevicePlan.getFillQueryPlan().getFillType();\n-    } else {\n-      this.dataSetType = DataSetType.QUERY;\n+    switch (alignByDevicePlan.getOperatorType()){\n+      case GROUPBY:\n+        this.dataSetType = DataSetType.GROUPBY;\n+        this.groupByPlan = alignByDevicePlan.getGroupByPlan();\n+        break;\n+      case AGGREGATION:\n+        this.dataSetType = DataSetType.AGGREGATE;\n+        this.aggregationPlan = alignByDevicePlan.getAggregationPlan();\n+        break;\n+      case FILL:\n+        this.dataSetType = DataSetType.FILL;\n+        this.fillQueryPlan = alignByDevicePlan.getFillQueryPlan();\n+        break;\n+      default:\n+        this.dataSetType = DataSetType.QUERY;\n     }\n \n     this.curDataSetInitialized = false;\n-    this.deviceIterator = measurementColumnsGroupByDevice.keySet().iterator();\n+    this.deviceIterator = deviceToMeasurementsMap.keySet().iterator();\n     this.currentColumnMapRelation = new int[deduplicatedMeasurementColumns.size()];\n   }\n \n", "next_change": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -108,6 +109,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n         break;\n       default:\n         this.dataSetType = DataSetType.QUERY;\n+        this.rawDataQueryPlan = new RawDataQueryPlan();\n     }\n \n     this.curDataSetInitialized = false;\n", "next_change": null}]}}]}}, {"oid": "85fe556e2fc701f6816d39262bbdc367778c4c06", "url": "https://github.com/apache/iotdb/commit/85fe556e2fc701f6816d39262bbdc367778c4c06", "message": "Fix bugs", "committedDate": "2020-02-12T11:00:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMDkwNw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378230907", "body": "remove this unused ", "bodyText": "remove this unused", "bodyHTML": "<p dir=\"auto\">remove this unused</p>", "author": "qiaojialin", "createdAt": "2020-02-12T12:51:57Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.iotdb.db.qp.physical.crud;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import org.apache.iotdb.db.qp.logical.Operator;\n+import org.apache.iotdb.db.qp.logical.Operator.OperatorType;\n+import org.apache.iotdb.tsfile.file.metadata.enums.TSDataType;\n+import org.apache.iotdb.tsfile.read.expression.IExpression;\n+\n+public class AlignByDevicePlan extends QueryPlan {\n+\n+  private List<String> measurements; // e.g. temperature, status, speed\n+  private Map<String, Set<String>> deviceToMeasurementsMap; // e.g. root.ln.d1 -> temperature\n+  // to check data type consistency for the same name sensor of different devices\n+  private Map<String, TSDataType> dataTypeConsistencyChecker;\n+  private Map<String, IExpression> deviceToFilterMap;\n+\n+  private GroupByPlan groupByPlan;\n+  private FillQueryPlan fillQueryPlan;\n+  private AggregationPlan aggregationPlan;\n+\n+  // the measurements that do not exist in any device,\n+  // data type is considered as Boolean. The value is considered as null\n+  private List<String> notExistMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfNotExistMeasurements = new ArrayList<>();\n+  // the measurements that have quotation mark. e.g. \"abc\",\n+  // '11', the data type is considered as String and the value is considered is the same with measurement name\n+  private List<String> constMeasurements = new ArrayList<>();\n+  private List<Integer> positionOfConstMeasurements = new ArrayList<>();\n+\n+  public AlignByDevicePlan() {\n+    super();\n+  }\n+\n+  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {", "originalCommit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNDI1OQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378324259", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T15:28:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMDkwNw=="}], "type": "inlineReview", "revised_code": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\nindex 7cc690ce1..b482e854c 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/AlignByDevicePlan.java\n", "chunk": "@@ -52,10 +52,6 @@ public class AlignByDevicePlan extends QueryPlan {\n     super();\n   }\n \n-  public AlignByDevicePlan(boolean isQuery, Operator.OperatorType operatorType) {\n-    super(isQuery, operatorType);\n-  }\n-\n   public void setMeasurements(List<String> measurements) {\n     this.measurements = measurements;\n   }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMjQxMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378232412", "body": "ha?", "bodyText": "ha?", "bodyHTML": "<p dir=\"auto\">ha?</p>", "author": "qiaojialin", "createdAt": "2020-02-12T12:55:12Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java", "diffHunk": "@@ -20,7 +20,8 @@\n \n import org.apache.iotdb.db.qp.logical.Operator;\n \n-public class GroupByPlan extends AggregationPlan {\n+public class\n+GroupByPlan extends AggregationPlan {", "originalCommit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNDMzNA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378324334", "bodyText": "...Fixed.", "author": "Alima777", "createdAt": "2020-02-12T15:28:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMjQxMg=="}], "type": "inlineReview", "revised_code": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java\nindex 9e9c270e8..f2690ace9 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java\n", "chunk": "@@ -20,8 +20,7 @@ package org.apache.iotdb.db.qp.physical.crud;\n \n import org.apache.iotdb.db.qp.logical.Operator;\n \n-public class\n-GroupByPlan extends AggregationPlan {\n+public class GroupByPlan extends AggregationPlan {\n \n   // [startTime, endTime)\n   private long startTime;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMjc2OQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378232769", "body": "```suggestion\r\nGroupByTimePlan extends AggregationPlan {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            GroupByPlan extends AggregationPlan {\n          \n          \n            \n            GroupByTimePlan extends AggregationPlan {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-smi x x-first x-last\">GroupByPlan</span> extends <span class=\"pl-smi\">AggregationPlan</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-smi x x-first x-last\">GroupByTimePlan</span> extends <span class=\"pl-smi\">AggregationPlan</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-12T12:55:55Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java", "diffHunk": "@@ -20,7 +20,8 @@\n \n import org.apache.iotdb.db.qp.logical.Operator;\n \n-public class GroupByPlan extends AggregationPlan {\n+public class\n+GroupByPlan extends AggregationPlan {", "originalCommit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNTA0OQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378325049", "bodyText": "Just keep it.", "author": "Alima777", "createdAt": "2020-02-12T15:29:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMjc2OQ=="}], "type": "inlineReview", "revised_code": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java\nindex 9e9c270e8..f2690ace9 100644\n--- a/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java\n+++ b/server/src/main/java/org/apache/iotdb/db/qp/physical/crud/GroupByPlan.java\n", "chunk": "@@ -20,8 +20,7 @@ package org.apache.iotdb.db.qp.physical.crud;\n \n import org.apache.iotdb.db.qp.logical.Operator;\n \n-public class\n-GroupByPlan extends AggregationPlan {\n+public class GroupByPlan extends AggregationPlan {\n \n   // [startTime, endTime)\n   private long startTime;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMzExMw==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378233113", "body": "```suggestion\r\n  private boolean alignByDevice = false;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean isAlignByDevice = false;\n          \n          \n            \n              private boolean alignByDevice = false;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"48\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">isAlignByDevice</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">false</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"48\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">alignByDevice</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">false</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-12T12:56:29Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/logical/crud/QueryOperator.java", "diffHunk": "@@ -45,8 +45,8 @@\n   private int seriesLimit = 0;\n   private int seriesOffset = 0;\n \n-  private boolean isGroupByDevice = false;\n-  private boolean isAlign = true;\n+  private boolean isAlignByDevice = false;", "originalCommit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyOTY0MA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378329640", "bodyText": "Just keep it.", "author": "Alima777", "createdAt": "2020-02-12T15:36:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMzExMw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMzIwMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378233202", "body": "```suggestion\r\n  private boolean alignByTime = true;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private boolean isAlignByTime = true;\n          \n          \n            \n              private boolean alignByTime = true;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"49\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">isAlignByTime</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"49\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">boolean</span> <span class=\"x x-first x-last\">alignByTime</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-12T12:56:39Z", "path": "server/src/main/java/org/apache/iotdb/db/qp/logical/crud/QueryOperator.java", "diffHunk": "@@ -45,8 +45,8 @@\n   private int seriesLimit = 0;\n   private int seriesOffset = 0;\n \n-  private boolean isGroupByDevice = false;\n-  private boolean isAlign = true;\n+  private boolean isAlignByDevice = false;\n+  private boolean isAlignByTime = true;", "originalCommit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyOTc2OA==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378329768", "bodyText": "Just keep it please.", "author": "Alima777", "createdAt": "2020-02-12T15:36:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzMzIwMg=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNTAxOQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378235019", "body": "```suggestion\r\n * This QueryDataSet is used for align by device query result.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * This QueryDataSet is used for GROUP_BY_DEVICE query result.\n          \n          \n            \n             * This QueryDataSet is used for align by device query result.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">This</span> <span class=\"pl-smi\">QueryDataSet</span> is used <span class=\"pl-k\">for</span> <span class=\"pl-c1 x x-first x-last\">GROUP_BY_DEVICE</span> query result.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-smi\">This</span> <span class=\"pl-smi\">QueryDataSet</span> is used <span class=\"pl-k\">for</span> <span class=\"x x-first x-last\">align by device</span> query result.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "qiaojialin", "createdAt": "2020-02-12T13:00:43Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -36,9 +42,6 @@\n import org.apache.iotdb.tsfile.read.query.dataset.QueryDataSet;\n import org.apache.iotdb.tsfile.utils.Binary;\n \n-import java.io.IOException;\n-import java.util.*;\n-\n \n /**\n  * This QueryDataSet is used for GROUP_BY_DEVICE query result.", "originalCommit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyNTg4Ng==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378325886", "bodyText": "Fixed.", "author": "Alima777", "createdAt": "2020-02-12T15:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNTAxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -44,9 +44,9 @@ import org.apache.iotdb.tsfile.utils.Binary;\n \n \n /**\n- * This QueryDataSet is used for GROUP_BY_DEVICE query result.\n+ * This QueryDataSet is used for ALIGN_BY_DEVICE query result.\n  */\n-public class DeviceIterateDataSet extends QueryDataSet {\n+public class AlignByDeviceDataSet extends QueryDataSet {\n \n   private DataSetType dataSetType;\n   private IQueryRouter queryRouter;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNTMyNQ==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378235325", "body": "how about renaming this class to AlignByDeviceDataset", "bodyText": "how about renaming this class to AlignByDeviceDataset", "bodyHTML": "<p dir=\"auto\">how about renaming this class to AlignByDeviceDataset</p>", "author": "qiaojialin", "createdAt": "2020-02-12T13:01:22Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java", "diffHunk": "@@ -80,45 +77,41 @@\n   private int[] currentColumnMapRelation;", "originalCommit": "85fe556e2fc701f6816d39262bbdc367778c4c06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODMyODcxMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378328712", "bodyText": "It's nice. I will rename it.", "author": "Alima777", "createdAt": "2020-02-12T15:34:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIzNTMyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "changed_code": [{"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -69,6 +69,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n   private GroupByPlan groupByPlan;\n   private FillQueryPlan fillQueryPlan;\n   private AggregationPlan aggregationPlan;\n+  private RawDataQueryPlan rawDataQueryPlan;\n \n   private boolean curDataSetInitialized;\n   private Iterator<String> deviceIterator;\n", "next_change": null}, {"header": "diff --git a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nsimilarity index 95%\nrename from server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\nrename to server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\nindex df16e9c05..e9befa7a3 100644\n--- a/server/src/main/java/org/apache/iotdb/db/query/dataset/DeviceIterateDataSet.java\n+++ b/server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java\n", "chunk": "@@ -77,7 +78,7 @@ public class DeviceIterateDataSet extends QueryDataSet {\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n+  public AlignByDeviceDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n     super(null, alignByDevicePlan.getDataTypes());\n \n", "next_change": null}]}}, {"oid": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "url": "https://github.com/apache/iotdb/commit/c991383bb5e55b2f3f2ba75072cd214207d8034d", "message": "always endeavoring to do still better", "committedDate": "2020-02-12T15:41:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwNDAyMg==", "url": "https://github.com/apache/iotdb/pull/796#discussion_r378604022", "body": "This logic is a little strange", "bodyText": "This logic is a little strange", "bodyHTML": "<p dir=\"auto\">This logic is a little strange</p>", "author": "qiaojialin", "createdAt": "2020-02-13T01:18:46Z", "path": "server/src/main/java/org/apache/iotdb/db/query/dataset/AlignByDeviceDataSet.java", "diffHunk": "@@ -80,45 +78,42 @@\n   private int[] currentColumnMapRelation;\n   private Map<Path, TSDataType> tsDataTypeMap;\n \n-  public DeviceIterateDataSet(QueryPlan queryPlan, QueryContext context,\n+  public AlignByDeviceDataSet(AlignByDevicePlan alignByDevicePlan, QueryContext context,\n       IQueryRouter queryRouter) {\n-    super(null, queryPlan.getDataTypes());\n+    super(null, alignByDevicePlan.getDataTypes());\n \n     // get deduplicated measurement columns (already deduplicated in TSServiceImpl.executeDataQuery)\n-    this.deduplicatedMeasurementColumns = queryPlan.getMeasurements();\n-    this.tsDataTypeMap = queryPlan.getDataTypeMapping();\n+    this.deduplicatedMeasurementColumns = alignByDevicePlan.getMeasurements();\n+    this.tsDataTypeMap = alignByDevicePlan.getDataTypeMapping();\n     this.queryRouter = queryRouter;\n     this.context = context;\n-    this.measurementColumnsGroupByDevice = queryPlan.getMeasurementsGroupByDevice();\n-    this.deviceToFilterMap = queryPlan.getDeviceToFilterMap();\n-    this.notExistMeasurements = queryPlan.getNotExistMeasurements();\n-    this.constMeasurements = queryPlan.getConstMeasurements();\n-    this.positionOfNotExistMeasurements = queryPlan.getPositionOfNotExistMeasurements();\n-    this.positionOfConstMeasurements = queryPlan.getPositionOfConstMeasurements();\n-    //BuildOutDataTypes();\n+    this.deviceToMeasurementsMap = alignByDevicePlan.getDeviceToMeasurementsMap();\n+    this.deviceToFilterMap = alignByDevicePlan.getDeviceToFilterMap();\n+    this.notExistMeasurements = alignByDevicePlan.getNotExistMeasurements();\n+    this.constMeasurements = alignByDevicePlan.getConstMeasurements();\n+    this.positionOfNotExistMeasurements = alignByDevicePlan.getPositionOfNotExistMeasurements();\n+    this.positionOfConstMeasurements = alignByDevicePlan.getPositionOfConstMeasurements();\n \n-    if (queryPlan instanceof GroupByPlan) {\n-      this.dataSetType = DataSetType.GROUPBY;\n-      // assign parameters\n-      this.unit = ((GroupByPlan) queryPlan).getInterval();\n-      this.slidingStep = ((GroupByPlan) queryPlan).getSlidingStep();\n-      this.startTime = ((GroupByPlan) queryPlan).getStartTime();\n-      this.endTime = ((GroupByPlan) queryPlan).getEndTime();\n-\n-    } else if (queryPlan instanceof AggregationPlan) {\n-      this.dataSetType = DataSetType.AGGREGATE;\n-\n-    } else if (queryPlan instanceof FillQueryPlan) {\n-      this.dataSetType = DataSetType.FILL;\n-      // assign parameters\n-      this.queryTime = ((FillQueryPlan) queryPlan).getQueryTime();\n-      this.fillType = ((FillQueryPlan) queryPlan).getFillType();\n-    } else {\n-      this.dataSetType = DataSetType.QUERY;\n+    switch (alignByDevicePlan.getOperatorType()){\n+      case GROUPBY:\n+        this.dataSetType = DataSetType.GROUPBY;\n+        this.groupByPlan = alignByDevicePlan.getGroupByPlan();\n+        break;\n+      case AGGREGATION:\n+        this.dataSetType = DataSetType.AGGREGATE;\n+        this.aggregationPlan = alignByDevicePlan.getAggregationPlan();\n+        break;\n+      case FILL:\n+        this.dataSetType = DataSetType.FILL;\n+        this.fillQueryPlan = alignByDevicePlan.getFillQueryPlan();\n+        break;\n+      default:\n+        this.dataSetType = DataSetType.QUERY;\n+        this.rawDataQueryPlan = new RawDataQueryPlan();", "originalCommit": "c991383bb5e55b2f3f2ba75072cd214207d8034d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": null}, {"oid": "749fb8f6105f369d81a6c22960ebefcc3584d2c0", "url": "https://github.com/apache/iotdb/commit/749fb8f6105f369d81a6c22960ebefcc3584d2c0", "message": "Fix a comment", "committedDate": "2020-02-13T03:54:43Z", "type": "commit"}, {"oid": "66b118723808602c8fb149e3deacb689f857c2f9", "url": "https://github.com/apache/iotdb/commit/66b118723808602c8fb149e3deacb689f857c2f9", "message": "Fix a comment", "committedDate": "2020-02-13T03:55:49Z", "type": "commit"}]}