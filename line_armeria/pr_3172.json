{"pr_number": 3172, "pr_title": "Provide a way to allow bad HTTP2 cipher suites for client", "pr_author": "ikhoon", "pr_createdAt": "2020-11-11T13:01:12Z", "pr_url": "https://github.com/line/armeria/pull/3172", "timeline": [{"oid": "ac9d75b8fd1c057df744413b11c241d28d0d73d1", "url": "https://github.com/line/armeria/commit/ac9d75b8fd1c057df744413b11c241d28d0d73d1", "message": "Provide a way to allow blocklisted HTTP2 ciphers for client\n\nMotivation:\n\nA client fails to connect to a server using HTTPS if the server does not support modern cipher suites.\nBecause Armeria does not allow to use HTTP/2 cipher suite blacklist if a protocol is not `H1`.\nhttps://github.com/line/armeria/blob/9e0a4c02fdeeb276602c05992396605848d8f843/core/src/main/java/com/linecorp/armeria/internal/common/util/SslContextUtil.java#L133-L135\n\nModifications:\n\n- Add `tlsAllowUnsafeCiphers` options to ClientFactoryBuilder and Flags\n  for disabling the cipher suites validation.\n\nResult:\n\n- You can now use [https://tools.ietf.org/html/rfc7540#appendix-A](TLS 1.2 Cipher Suite Block List) for TLS Handshake.\n- Fixes #3157", "committedDate": "2020-11-11T12:57:27Z", "type": "commit"}, {"oid": "513776d4487520f9d0c1de0c31f66c774671201b", "url": "https://github.com/line/armeria/commit/513776d4487520f9d0c1de0c31f66c774671201b", "message": "Fix Javadoc", "committedDate": "2020-11-11T13:00:16Z", "type": "commit"}, {"oid": "0dab4caf5006121dbae952ad9f33a362de76b589", "url": "https://github.com/line/armeria/commit/0dab4caf5006121dbae952ad9f33a362de76b589", "message": "Javadoc", "committedDate": "2020-11-11T13:08:51Z", "type": "commit"}, {"oid": "13fb73cd33292db951376d456e5bfef6f0c80f73", "url": "https://github.com/line/armeria/commit/13fb73cd33292db951376d456e5bfef6f0c80f73", "message": "Checkstyle", "committedDate": "2020-11-11T13:39:56Z", "type": "commit"}, {"oid": "fb505cc9b55f3b693d9a44cc5425a2bf675ab7c6", "url": "https://github.com/line/armeria/commit/fb505cc9b55f3b693d9a44cc5425a2bf675ab7c6", "message": "Fix leak", "committedDate": "2020-11-11T15:22:48Z", "type": "commit"}, {"oid": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc", "url": "https://github.com/line/armeria/commit/47016ac9ed6fdd9fc679763014b5e02a1b3de4fc", "message": "close client factory", "committedDate": "2020-11-12T02:17:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNDg0OA==", "url": "https://github.com/line/armeria/pull/3172#discussion_r524004848", "body": "`BAD_HTTP2_CIPHERS`", "bodyText": "BAD_HTTP2_CIPHERS", "bodyHTML": "<p dir=\"auto\"><code>BAD_HTTP2_CIPHERS</code></p>", "author": "trustin", "createdAt": "2020-11-16T09:13:57Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/util/SslContextUtil.java", "diffHunk": "@@ -184,7 +187,8 @@ private static void validateHttp2Ciphers(Set<String> ciphers) {\n     }\n \n     // https://httpwg.org/specs/rfc7540.html#BadCipherSuites\n-    private static final Set<String> HTTP2_BLACKLISTED_CIPHERS =\n+    @VisibleForTesting\n+    static final Set<String> HTTP2_BLACKLISTED_CIPHERS =", "originalCommit": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNTQ2OQ==", "url": "https://github.com/line/armeria/pull/3172#discussion_r524005469", "body": "`getBadCipher()`?", "bodyText": "getBadCipher()?", "bodyHTML": "<p dir=\"auto\"><code>getBadCipher()</code>?</p>", "author": "trustin", "createdAt": "2020-11-16T09:14:32Z", "path": "core/src/test/java/com/linecorp/armeria/internal/common/util/SslContextUtilTest.java", "diffHunk": "@@ -48,4 +59,51 @@ void jdkSsl() {\n             assertThat(supportedProtocols).contains(\"TLSv1.2\");\n         }\n     }\n+\n+    @Test\n+    void unsafeTlsCiphers() {\n+        final String cipher = getBlackListedCipher();\n+        assumeThat(cipher).isNotNull();\n+\n+        assertThatThrownBy(() -> {\n+            final ClientFactory factory =\n+                    ClientFactory.builder()\n+                                 .tlsCustomizer(builder -> builder.ciphers(ImmutableList.of(cipher)))\n+                                 .build();\n+            factory.closeAsync();\n+        }).isInstanceOf(IllegalStateException.class)\n+          .hasMessageContaining(\"Attempting to configure a server or HTTP/2 client without\");\n+\n+        final ClientFactory factory =\n+                ClientFactory.builder()\n+                             .tlsAllowUnsafeCiphers(true)\n+                             .tlsCustomizer(builder -> builder.ciphers(ImmutableList.of(cipher)))\n+                             .build();\n+        factory.closeAsync();\n+    }\n+\n+    @Nullable\n+    private static String getBlackListedCipher() {", "originalCommit": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "774cbbd5a9b720e75af4e2f0fa69bde8f551e1c6", "url": "https://github.com/line/armeria/commit/774cbbd5a9b720e75af4e2f0fa69bde8f551e1c6", "message": "Address comments by @trustin", "committedDate": "2020-11-16T11:47:05Z", "type": "commit"}, {"oid": "aa044b583bd59467d0e244ce99354cd9a0eed2f4", "url": "https://github.com/line/armeria/commit/aa044b583bd59467d0e244ce99354cd9a0eed2f4", "message": "Merge branch 'master' into unsafe-tls1.2", "committedDate": "2020-11-16T13:09:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyMDgyMQ==", "url": "https://github.com/line/armeria/pull/3172#discussion_r524920821", "body": "Could you use disallowed instead of block?", "bodyText": "Could you use disallowed instead of block?", "bodyHTML": "<p dir=\"auto\">Could you use disallowed instead of block?</p>", "author": "minwoox", "createdAt": "2020-11-17T06:56:25Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -300,6 +300,20 @@ public ClientFactoryBuilder tlsCustomizer(Consumer<? super SslContextBuilder> tl\n         return this;\n     }\n \n+    /**\n+     * Sets whether to allow\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">TLS 1.2 Cipher Suite Block List</a>", "originalCommit": "aa044b583bd59467d0e244ce99354cd9a0eed2f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyMTU0OQ==", "url": "https://github.com/line/armeria/pull/3172#discussion_r524921549", "bodyText": "Sets whether to allow the bad cipher suites listed in <a href=\"...\">RFC7540</a>. ?", "author": "trustin", "createdAt": "2020-11-17T06:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyMDgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyNTIyMw==", "url": "https://github.com/line/armeria/pull/3172#discussion_r524925223", "bodyText": "Ah that's better \ud83d\ude04", "author": "minwoox", "createdAt": "2020-11-17T07:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyMDgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyNjE4Mg==", "url": "https://github.com/line/armeria/pull/3172#discussion_r524926182", "bodyText": "Maybe just Allows the bad cipher ...", "author": "trustin", "createdAt": "2020-11-17T07:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyMDgyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyNjMwNw==", "url": "https://github.com/line/armeria/pull/3172#discussion_r524926307", "bodyText": "(and some warning message if we didn't add one yet)", "author": "trustin", "createdAt": "2020-11-17T07:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyMDgyMQ=="}], "type": "inlineReview"}, {"oid": "baef82b176915cc8e6d2a0489c6b4b93a8cde108", "url": "https://github.com/line/armeria/commit/baef82b176915cc8e6d2a0489c6b4b93a8cde108", "message": "Javadoc", "committedDate": "2020-11-17T16:50:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNDI2NQ==", "url": "https://github.com/line/armeria/pull/3172#discussion_r526634265", "body": "```suggestion\r\n     * Allows the bad cipher suites listed in\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Allow the bad cipher suites listed in\n          \n          \n            \n                 * Allows the bad cipher suites listed in", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi x x-first x-last\">Allow</span> the bad cipher suites listed in</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi x x-first x-last\">Allows</span> the bad cipher suites listed in</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "trustin", "createdAt": "2020-11-19T07:01:29Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -300,6 +300,19 @@ public ClientFactoryBuilder tlsCustomizer(Consumer<? super SslContextBuilder> tl\n         return this;\n     }\n \n+    /**\n+     * Allow the bad cipher suites listed in", "originalCommit": "baef82b176915cc8e6d2a0489c6b4b93a8cde108", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjEyOQ==", "url": "https://github.com/line/armeria/pull/3172#discussion_r526636129", "body": "I'm not sure what 'meet minimum security requirements' means clearly. We should convey the message that explicitly discourages its use.\r\n\r\nHow about:\r\n\r\n    <p>Note that enabling this option increases the security risk of your connection.\r\n    Use it only when you must communicate with a legacy system that does not support\r\n    secure cipher suites. See ... for more information\r\n", "bodyText": "I'm not sure what 'meet minimum security requirements' means clearly. We should convey the message that explicitly discourages its use.\nHow about:\n<p>Note that enabling this option increases the security risk of your connection.\nUse it only when you must communicate with a legacy system that does not support\nsecure cipher suites. See ... for more information", "bodyHTML": "<p dir=\"auto\">I'm not sure what 'meet minimum security requirements' means clearly. We should convey the message that explicitly discourages its use.</p>\n<p dir=\"auto\">How about:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"&lt;p&gt;Note that enabling this option increases the security risk of your connection.\nUse it only when you must communicate with a legacy system that does not support\nsecure cipher suites. See ... for more information\"><pre><code>&lt;p&gt;Note that enabling this option increases the security risk of your connection.\nUse it only when you must communicate with a legacy system that does not support\nsecure cipher suites. See ... for more information\n</code></pre></div>", "author": "trustin", "createdAt": "2020-11-19T07:06:34Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -300,6 +300,19 @@ public ClientFactoryBuilder tlsCustomizer(Consumer<? super SslContextBuilder> tl\n         return this;\n     }\n \n+    /**\n+     * Allow the bad cipher suites listed in\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">RFC7540</a> for TLS handshake.\n+     *\n+     * <p>Note that the bad cipher suites do not meet minimum security requirements.", "originalCommit": "baef82b176915cc8e6d2a0489c6b4b93a8cde108", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjQ5Nw==", "url": "https://github.com/line/armeria/pull/3172#discussion_r526636497", "body": "Ditto", "bodyText": "Ditto", "bodyHTML": "<p dir=\"auto\">Ditto</p>", "author": "trustin", "createdAt": "2020-11-19T07:07:18Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -78,6 +78,17 @@\n     public static final ClientFactoryOption<Consumer<? super SslContextBuilder>> TLS_CUSTOMIZER =\n             ClientFactoryOption.define(\"TLS_CUSTOMIZER\", b -> { /* no-op */ });\n \n+    /**\n+     * Whether to allow the bad cipher suites listed in\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">RFC7540</a> for TLS handshake.\n+     *\n+     * <p>Note that the blocked cipher suites do not meet minimum security requirements.", "originalCommit": "baef82b176915cc8e6d2a0489c6b4b93a8cde108", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjU1NA==", "url": "https://github.com/line/armeria/pull/3172#discussion_r526636554", "body": "Ditto", "bodyText": "Ditto", "bodyHTML": "<p dir=\"auto\">Ditto</p>", "author": "trustin", "createdAt": "2020-11-19T07:07:28Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -446,4 +457,16 @@ public MeterRegistry meterRegistry() {\n     public ProxyConfigSelector proxyConfigSelector() {\n         return get(PROXY_CONFIG_SELECTOR);\n     }\n+\n+    /**\n+     * Returns whether to allow the bad cipher suites listed in\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">RFC7540</a> for TLS handshake.\n+     *\n+     * <p>Note that the bad cipher suites do not meet minimum security requirements.", "originalCommit": "baef82b176915cc8e6d2a0489c6b4b93a8cde108", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ad3570e57be6e82401b1a310478a00578adb9887", "url": "https://github.com/line/armeria/commit/ad3570e57be6e82401b1a310478a00578adb9887", "message": "Address comments @trustin / Update Javadoc", "committedDate": "2020-11-19T07:52:49Z", "type": "commit"}, {"oid": "ad3570e57be6e82401b1a310478a00578adb9887", "url": "https://github.com/line/armeria/commit/ad3570e57be6e82401b1a310478a00578adb9887", "message": "Address comments @trustin / Update Javadoc", "committedDate": "2020-11-19T07:52:49Z", "type": "forcePushed"}]}