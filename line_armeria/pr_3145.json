{"pr_number": 3145, "pr_title": "Mapping retry config by context/request parameters", "pr_author": "haithamgabr", "pr_createdAt": "2020-10-29T23:16:40Z", "pr_url": "https://github.com/line/armeria/pull/3145", "timeline": [{"oid": "537950597bfe63fbbb8f47d0c96b5c51a246e7f8", "url": "https://github.com/line/armeria/commit/537950597bfe63fbbb8f47d0c96b5c51a246e7f8", "message": "Mapping retry config by context/request parameeters", "committedDate": "2020-10-29T23:13:03Z", "type": "commit"}, {"oid": "00b813ec663921a6627b9ac3cd3812031f34a3c8", "url": "https://github.com/line/armeria/commit/00b813ec663921a6627b9ac3cd3812031f34a3c8", "message": "Adding a test for RetryingRpcClient", "committedDate": "2020-10-30T03:00:40Z", "type": "commit"}, {"oid": "f7b510b96921980e7c18b032267dd6f31a1a8f84", "url": "https://github.com/line/armeria/commit/f7b510b96921980e7c18b032267dd6f31a1a8f84", "message": "Adding RetryRule to RetryConfig, so it's part of RetryConfigMapping", "committedDate": "2020-11-04T02:55:31Z", "type": "commit"}, {"oid": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "url": "https://github.com/line/armeria/commit/30d5049b2ae589b96e9bbd356e342a51a27cf298", "message": "Removing dead code", "committedDate": "2020-11-04T03:46:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNTU0MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517835541", "body": "Could you revert these changes? \ud83d\ude05 We conventionally use `I` and `O` in other classes. ", "bodyText": "Could you revert these changes? \ud83d\ude05 We conventionally use I and O in other classes.", "bodyHTML": "<p dir=\"auto\">Could you revert these changes? <g-emoji class=\"g-emoji\" alias=\"sweat_smile\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f605.png\">\ud83d\ude05</g-emoji> We conventionally use <code>I</code> and <code>O</code> in other classes.</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:18:18Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -52,11 +51,11 @@\n /**\n  * A {@link Client} decorator that handles failures of remote invocation and retries requests.\n  *\n- * @param <I> the {@link Request} type\n- * @param <O> the {@link Response} type\n+ * @param <REQ_T> the {@link Request} type\n+ * @param <RES_T> the {@link Response} type\n  */\n-public abstract class AbstractRetryingClient<I extends Request, O extends Response>\n-        extends SimpleDecoratingClient<I, O> {\n+public abstract class AbstractRetryingClient<REQ_T extends Request, RES_T extends Response>\n+        extends SimpleDecoratingClient<REQ_T, RES_T> {", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MTc3Mw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518441773", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNTU0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzE1Mw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517837153", "body": "Armeria follows [semantic versioning](https://semver.org/). Unfortunately, we can't remove these `protected` methods in 1.x.", "bodyText": "Armeria follows semantic versioning. Unfortunately, we can't remove these protected methods in 1.x.", "bodyHTML": "<p dir=\"auto\">Armeria follows <a href=\"https://semver.org/\" rel=\"nofollow\">semantic versioning</a>. Unfortunately, we can't remove these <code>protected</code> methods in 1.x.</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:22:05Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -145,31 +106,6 @@ protected static void onRetryingComplete(ClientRequestContext ctx) {\n         ctx.logBuilder().endResponseWithLastChild();\n     }\n \n-    /**\n-     * Returns the {@link RetryRule}.\n-     *\n-     * @throws IllegalStateException if the {@link RetryRule} is not set\n-     */\n-    protected final RetryRule retryRule() {\n-        checkState(retryRule != null, \"retryRule is not set.\");\n-        return retryRule;\n-    }\n-\n-    /**\n-     * Returns the {@link RetryRuleWithContent}.\n-     *\n-     * @throws IllegalStateException if the {@link RetryRuleWithContent} is not set\n-     */\n-    protected final RetryRuleWithContent<O> retryRuleWithContent() {\n-        checkState(retryRuleWithContent != null, \"retryRuleWithContent is not set.\");\n-        return retryRuleWithContent;\n-    }", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjE3MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442170", "bodyText": "Makes sense. I adjusted the code to make the client retain retryConfig if it was set directly (instead of mapping), and used it for these getters.", "author": "haithamgabr", "createdAt": "2020-11-05T23:57:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzE1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzUzOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517837539", "body": "Sorry, please revert this. \ud83d\ude4f", "bodyText": "Sorry, please revert this. \ud83d\ude4f", "bodyHTML": "<p dir=\"auto\">Sorry, please revert this. <g-emoji class=\"g-emoji\" alias=\"pray\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f64f.png\">\ud83d\ude4f</g-emoji></p>", "author": "ikhoon", "createdAt": "2020-11-05T07:23:01Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -34,47 +34,49 @@\n /**\n  * Builds a new {@link AbstractRetryingClient} or its decorator function.\n  *\n- * @param <O> the type of incoming {@link Response} of the {@link Client}\n+ * @param <T> the type of incoming {@link Response} of the {@link Client}", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjIxMg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442212", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:57:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzg2NQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517837865", "body": "nit: Join two lines?", "bodyText": "nit: Join two lines?", "bodyHTML": "<p dir=\"auto\">nit: Join two lines?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:23:48Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -83,17 +85,17 @@ final RetryRule retryRule() {\n      *\n      * @return {@code this} to support method chaining.\n      */\n-    public AbstractRetryingClientBuilder<O> maxTotalAttempts(int maxTotalAttempts) {\n+    public AbstractRetryingClientBuilder<T> maxTotalAttempts(int maxTotalAttempts) {\n+        checkState(\n+                retryConfig != null,", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjU2Ng==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442566", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzg2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzk4Mw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517837983", "body": "nit: Join two lines?", "bodyText": "nit: Join two lines?", "bodyHTML": "<p dir=\"auto\">nit: Join two lines?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:24:05Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -105,19 +107,19 @@ final int maxTotalAttempts() {\n      *\n      * @see <a href=\"https://armeria.dev/docs/client-retry#per-attempt-timeout\">Per-attempt timeout</a>\n      */\n-    public AbstractRetryingClientBuilder<O> responseTimeoutMillisForEachAttempt(\n+    public AbstractRetryingClientBuilder<T> responseTimeoutMillisForEachAttempt(\n             long responseTimeoutMillisForEachAttempt) {\n+        checkState(\n+                retryConfig != null,", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjI0OA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442248", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:57:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzNzk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzOTEwNw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517839107", "body": "nit: Join two lines?", "bodyText": "nit: Join two lines?", "bodyHTML": "<p dir=\"auto\">nit: Join two lines?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:26:51Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/KeyedRetryConfigMapping.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.function.BiFunction;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+\n+final class KeyedRetryConfigMapping<T extends Response> implements RetryConfigMapping<T> {\n+    private final BiFunction<ClientRequestContext, Request, RetryConfig<T>> retryConfigFactory;\n+    private final BiFunction<ClientRequestContext, Request, String> keyFactory;\n+    private final ConcurrentMap<String, RetryConfig<T>>  mapping = new ConcurrentHashMap<>();\n+\n+    KeyedRetryConfigMapping(\n+            BiFunction<ClientRequestContext, Request, String> keyFactory,\n+            BiFunction<ClientRequestContext, Request, RetryConfig<T>> retryConfigFactory\n+    ) {", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjMwNQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442305", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:57:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzgzOTEwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDUzOA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517840538", "body": "Could you add a new line at the end of `@Nullable`?\r\n```suggestion\r\n    @Nullable\r\n    public RetryRule retryRule() {\r\n```\r\n", "bodyText": "Could you add a new line at the end of @Nullable?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable public RetryRule retryRule() {\n          \n          \n            \n                @Nullable\n          \n          \n            \n                public RetryRule retryRule() {", "bodyHTML": "<p dir=\"auto\">Could you add a new line at the end of <code>@Nullable</code>?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@Nullable</span><span class=\"x x-first\"> </span><span class=\"pl-k x\">public</span><span class=\"x\"> </span><span class=\"pl-smi x\">RetryRule</span><span class=\"x x-last\"> retryRule() {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@Nullable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">RetryRule</span> retryRule() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ikhoon", "createdAt": "2020-11-05T07:30:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns config's retryRule, could be null.\n+     */\n+    @Nullable public RetryRule retryRule() {", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjM4NQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442385", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDYxNg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517840616", "body": "Ditto.", "bodyText": "Ditto.", "bodyHTML": "<p dir=\"auto\">Ditto.</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:30:33Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns config's retryRule, could be null.\n+     */\n+    @Nullable public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns config's retryRuleWithContent, could be null.\n+     */\n+    @Nullable public RetryRuleWithContent<T> retryRuleWithContent() {", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjYxMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442613", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:58:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDY1Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517840657", "body": "Ditto.", "bodyText": "Ditto.", "bodyHTML": "<p dir=\"auto\">Ditto.</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:30:39Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns config's retryRule, could be null.\n+     */\n+    @Nullable public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns config's retryRuleWithContent, could be null.\n+     */\n+    @Nullable public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's retry rule that is converted from retryRuleWithContent, could be null.\n+     */\n+    @Nullable public RetryRule fromRetryRuleWithContent() {", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjQ0Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442447", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MDY1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MTU5OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517841599", "body": "Use JDK's `requireNonNull`?\r\nPlease refer to https://armeria.dev/community/developer-guide#check-null . ", "bodyText": "Use JDK's requireNonNull?\nPlease refer to https://armeria.dev/community/developer-guide#check-null .", "bodyHTML": "<p dir=\"auto\">Use JDK's <code>requireNonNull</code>?<br>\nPlease refer to <a href=\"https://armeria.dev/community/developer-guide#check-null\" rel=\"nofollow\">https://armeria.dev/community/developer-guide#check-null</a> .</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:33:02Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns config's retryRule, could be null.\n+     */\n+    @Nullable public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns config's retryRuleWithContent, could be null.\n+     */\n+    @Nullable public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's retry rule that is converted from retryRuleWithContent, could be null.\n+     */\n+    @Nullable public RetryRule fromRetryRuleWithContent() {\n+        return fromRetryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's maxContentLength, which is non-zero only if a {@link RetryRuleWithContent} is used.\n+     */\n+    public int maxContentLength() {\n+        return maxContentLength;\n+    }\n+\n+    /**\n+     * Returns whether a {@link RetryRuleWithContent} is being used.\n+     */\n+    public boolean needsContentInRule() {\n+        return needsContentInRule;\n+    }\n+\n+    /**\n+     * Returns whether the associated requires response trailers.\n+     */\n+    public boolean requiresResponseTrailers() {\n+        return needsContentInRule() ?\n+               retryRuleWithContent().requiresResponseTrailers() : retryRule().requiresResponseTrailers();\n+    }\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = checkNotNull(retryRule);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = false;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.maxContentLength = maxContentLength;\n+        this.retryRuleWithContent = checkNotNull(retryRuleWithContent);", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjcwOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442709", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:58:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MTU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0Mjc0Ng==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442746", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:58:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MTU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MjQyMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517842420", "body": "This class already has package-private constructors. Can't we remove this?", "bodyText": "This class already has package-private constructors. Can't we remove this?", "bodyHTML": "<p dir=\"auto\">This class already has package-private constructors. Can't we remove this?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:34:58Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,163 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns config's retryRule, could be null.\n+     */\n+    @Nullable public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns config's retryRuleWithContent, could be null.\n+     */\n+    @Nullable public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's retry rule that is converted from retryRuleWithContent, could be null.\n+     */\n+    @Nullable public RetryRule fromRetryRuleWithContent() {\n+        return fromRetryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's maxContentLength, which is non-zero only if a {@link RetryRuleWithContent} is used.\n+     */\n+    public int maxContentLength() {\n+        return maxContentLength;\n+    }\n+\n+    /**\n+     * Returns whether a {@link RetryRuleWithContent} is being used.\n+     */\n+    public boolean needsContentInRule() {\n+        return needsContentInRule;\n+    }\n+\n+    /**\n+     * Returns whether the associated requires response trailers.\n+     */\n+    public boolean requiresResponseTrailers() {\n+        return needsContentInRule() ?\n+               retryRuleWithContent().requiresResponseTrailers() : retryRule().requiresResponseTrailers();\n+    }\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = checkNotNull(retryRule);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = false;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.maxContentLength = maxContentLength;\n+        this.retryRuleWithContent = checkNotNull(retryRuleWithContent);\n+        fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = true;\n+        retryRule = null;\n+    }\n+\n+    private RetryConfig() {\n+        throw new IllegalStateException(\"RetryConfig must have a rule.\");\n+    }", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjgwMQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442801", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:58:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MjQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MzI0MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517843241", "body": "Make these `private`?", "bodyText": "Make these private?", "bodyHTML": "<p dir=\"auto\">Make these <code>private</code>?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:36:48Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable final RetryRule retryRule;\n+    @Nullable final RetryRuleWithContent<T> retryRuleWithContent;\n+    final int maxContentLength;", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0Mjg2Ng==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442866", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:59:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MzI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MzYwNw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517843607", "body": "Remove `public`?", "bodyText": "Remove public?", "bodyHTML": "<p dir=\"auto\">Remove <code>public</code>?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:37:46Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable final RetryRule retryRule;\n+    @Nullable final RetryRuleWithContent<T> retryRuleWithContent;\n+    final int maxContentLength;\n+\n+    private RetryConfigBuilder() {\n+        throw new IllegalStateException(\"RetryConfigBuilder must have a rule.\");\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRule}.\n+     */\n+    public RetryConfigBuilder(RetryRule retryRule) {", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MjkzMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442933", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:59:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MzYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MzcyOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517843729", "body": "I think we can remove this.", "bodyText": "I think we can remove this.", "bodyHTML": "<p dir=\"auto\">I think we can remove this.</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:38:09Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable final RetryRule retryRule;\n+    @Nullable final RetryRuleWithContent<T> retryRuleWithContent;\n+    final int maxContentLength;\n+\n+    private RetryConfigBuilder() {\n+        throw new IllegalStateException(\"RetryConfigBuilder must have a rule.\");\n+    }", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0Mjk3NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518442974", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0MzcyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0Mzk2MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517843960", "body": "Global comments: Please use `requireNonNull` where `checkNotNull` is used.\r\n```suggestion\r\n        this.retryRule = requireNonNull(retryRule, \"retryRule\");\r\n```", "bodyText": "Global comments: Please use requireNonNull where checkNotNull is used.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.retryRule = checkNotNull(retryRule);\n          \n          \n            \n                    this.retryRule = requireNonNull(retryRule, \"retryRule\");", "bodyHTML": "<p dir=\"auto\">Global comments: Please use <code>requireNonNull</code> where <code>checkNotNull</code> is used.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>retryRule <span class=\"pl-k\">=</span> <span class=\"x x-first x-last\">checkNotNull</span>(retryRule);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>retryRule <span class=\"pl-k\">=</span> <span class=\"x x-first x-last\">requireNonNull</span>(retryRule<span class=\"x x-first\">, </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">retryRule</span><span class=\"pl-pds x x-last\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "ikhoon", "createdAt": "2020-11-05T07:38:42Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable final RetryRule retryRule;\n+    @Nullable final RetryRuleWithContent<T> retryRuleWithContent;\n+    final int maxContentLength;\n+\n+    private RetryConfigBuilder() {\n+        throw new IllegalStateException(\"RetryConfigBuilder must have a rule.\");\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRule}.\n+     */\n+    public RetryConfigBuilder(RetryRule retryRule) {\n+        this.retryRule = checkNotNull(retryRule);", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NDcxMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517844713", "body": "Add `requireNonNull`?", "bodyText": "Add requireNonNull?", "bodyHTML": "<p dir=\"auto\">Add <code>requireNonNull</code>?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:40:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable final RetryRule retryRule;\n+    @Nullable final RetryRuleWithContent<T> retryRuleWithContent;\n+    final int maxContentLength;\n+\n+    private RetryConfigBuilder() {\n+        throw new IllegalStateException(\"RetryConfigBuilder must have a rule.\");\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRule}.\n+     */\n+    public RetryConfigBuilder(RetryRule retryRule) {\n+        this.retryRule = checkNotNull(retryRule);\n+        retryRuleWithContent = null;\n+        maxContentLength = 0;\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRuleWithContent}.\n+     */\n+    public RetryConfigBuilder(RetryRuleWithContent<T> retryRuleWithContent) {\n+        this(retryRuleWithContent, Integer.MAX_VALUE);\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRuleWithContent} and maxContentLength.\n+     */\n+    public RetryConfigBuilder(RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        retryRule = null;\n+        this.retryRuleWithContent = checkNotNull(retryRuleWithContent);\n+        checkArgument(maxContentLength > 0,\n+                      \"maxContentLength: %s (expected: > 0)\", maxContentLength);\n+        this.maxContentLength = maxContentLength;\n+    }\n+\n+    /**\n+     * Sets maxTotalAttempts.\n+     */\n+    public RetryConfigBuilder<T> maxTotalAttempts(int maxTotalAttempts) {\n+        checkArgument(\n+                maxTotalAttempts > 0,\n+                \"maxTotalAttempts: %s (expected: > 0)\",\n+                maxTotalAttempts);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets responseTimeoutMillisForEachAttempt.\n+     */\n+    public RetryConfigBuilder<T> responseTimeoutMillisForEachAttempt(long responseTimeoutMillisForEachAttempt) {\n+        checkArgument(\n+                responseTimeoutMillisForEachAttempt >= 0,\n+                \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n+                responseTimeoutMillisForEachAttempt);\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets responseTimeoutMillisForEachAttempt by converting responseTimeoutForEachAttempt to millis.\n+     */\n+    public RetryConfigBuilder<T> responseTimeoutForEachAttempt(Duration responseTimeoutMillisForEachAttempt) {\n+        final long millis = responseTimeoutMillisForEachAttempt.toMillis();", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MzA3MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518443071", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:59:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NDcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NDkyMg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517844922", "body": "Remove `public`?", "bodyText": "Remove public?", "bodyHTML": "<p dir=\"auto\">Remove <code>public</code>?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:40:53Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable final RetryRule retryRule;\n+    @Nullable final RetryRuleWithContent<T> retryRuleWithContent;\n+    final int maxContentLength;\n+\n+    private RetryConfigBuilder() {\n+        throw new IllegalStateException(\"RetryConfigBuilder must have a rule.\");\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRule}.\n+     */\n+    public RetryConfigBuilder(RetryRule retryRule) {\n+        this.retryRule = checkNotNull(retryRule);\n+        retryRuleWithContent = null;\n+        maxContentLength = 0;\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRuleWithContent}.\n+     */\n+    public RetryConfigBuilder(RetryRuleWithContent<T> retryRuleWithContent) {", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MzExOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518443119", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:59:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NDkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NTI1Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517845257", "body": "Remove this `else` block? I think we can reach this condition.", "bodyText": "Remove this else block? I think we can reach this condition.", "bodyHTML": "<p dir=\"auto\">Remove this <code>else</code> block? I think we can reach this condition.</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:41:39Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable final RetryRule retryRule;\n+    @Nullable final RetryRuleWithContent<T> retryRuleWithContent;\n+    final int maxContentLength;\n+\n+    private RetryConfigBuilder() {\n+        throw new IllegalStateException(\"RetryConfigBuilder must have a rule.\");\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRule}.\n+     */\n+    public RetryConfigBuilder(RetryRule retryRule) {\n+        this.retryRule = checkNotNull(retryRule);\n+        retryRuleWithContent = null;\n+        maxContentLength = 0;\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRuleWithContent}.\n+     */\n+    public RetryConfigBuilder(RetryRuleWithContent<T> retryRuleWithContent) {\n+        this(retryRuleWithContent, Integer.MAX_VALUE);\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRuleWithContent} and maxContentLength.\n+     */\n+    public RetryConfigBuilder(RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        retryRule = null;\n+        this.retryRuleWithContent = checkNotNull(retryRuleWithContent);\n+        checkArgument(maxContentLength > 0,\n+                      \"maxContentLength: %s (expected: > 0)\", maxContentLength);\n+        this.maxContentLength = maxContentLength;\n+    }\n+\n+    /**\n+     * Sets maxTotalAttempts.\n+     */\n+    public RetryConfigBuilder<T> maxTotalAttempts(int maxTotalAttempts) {\n+        checkArgument(\n+                maxTotalAttempts > 0,\n+                \"maxTotalAttempts: %s (expected: > 0)\",\n+                maxTotalAttempts);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets responseTimeoutMillisForEachAttempt.\n+     */\n+    public RetryConfigBuilder<T> responseTimeoutMillisForEachAttempt(long responseTimeoutMillisForEachAttempt) {\n+        checkArgument(\n+                responseTimeoutMillisForEachAttempt >= 0,\n+                \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n+                responseTimeoutMillisForEachAttempt);\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets responseTimeoutMillisForEachAttempt by converting responseTimeoutForEachAttempt to millis.\n+     */\n+    public RetryConfigBuilder<T> responseTimeoutForEachAttempt(Duration responseTimeoutMillisForEachAttempt) {\n+        final long millis = responseTimeoutMillisForEachAttempt.toMillis();\n+        checkArgument(\n+                millis >= 0,\n+                \"responseTimeoutForEachAttempt.toMillis(): %s (expected: >= 0)\",\n+                millis);\n+        this.responseTimeoutMillisForEachAttempt = millis;\n+        return this;\n+    }\n+\n+    /**\n+     * Builds a {@link RetryConfig} from this builder's values and returns it.\n+     */\n+    public RetryConfig<T> build() {\n+        if (retryRule != null) {\n+            return new RetryConfig<>(retryRule, maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        } else if (retryRuleWithContent != null) {\n+            return new RetryConfig<>(\n+                    retryRuleWithContent,\n+                    maxContentLength,\n+                    maxTotalAttempts,\n+                    responseTimeoutMillisForEachAttempt);\n+        } else {\n+            throw new IllegalStateException(\"RetryConfigBuilder must have a rule.\");", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0MzE5NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518443194", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-05T23:59:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0NTI1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0ODMyNw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517848327", "body": "`RetryingRpcClient` only use `retryRuleWithContent` because there is no performance degression  using `RetryRuleWithContent`.\r\n\r\nCould add a validation code to `builder(RetryConfigMapping<RpcResponse> mapping)` whether `retryRuleWithContent` is configured?", "bodyText": "RetryingRpcClient only use retryRuleWithContent because there is no performance degression  using RetryRuleWithContent.\nCould add a validation code to builder(RetryConfigMapping<RpcResponse> mapping) whether retryRuleWithContent is configured?", "bodyHTML": "<p dir=\"auto\"><code>RetryingRpcClient</code> only use <code>retryRuleWithContent</code> because there is no performance degression  using <code>RetryRuleWithContent</code>.</p>\n<p dir=\"auto\">Could add a validation code to <code>builder(RetryConfigMapping&lt;RpcResponse&gt; mapping)</code> whether <code>retryRuleWithContent</code> is configured?</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:48:27Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingRpcClient.java", "diffHunk": "@@ -124,9 +141,13 @@ private void doExecute0(ClientRequestContext ctx, RpcRequest req,\n         final RpcResponse res = executeWithFallback(unwrap(), derivedCtx,\n                                                     (context, cause) -> RpcResponse.ofFailure(cause));\n \n+        final RetryConfig<RpcResponse> retryConfig = mapping().get(ctx, req);\n+        final RetryRuleWithContent<RpcResponse> retryRule =\n+                retryConfig.needsContentInRule() ?\n+                retryConfig.retryRuleWithContent() : RetryRuleUtil.fromRetryRule(retryConfig.retryRule());", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0NDUwOA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518444508", "bodyText": "It's impossible to validate if mapping would map to a RetryRule in one of the cases. RetryConfigMapping lets the use implement a factory that returns a RetryConfig for a given context. The RetryConfig could either have a RetryRule or a RetryRuleWithContent, and there is no way to check ahead of time if the user-defined factory would never produce a config with a RetryRuleWithContent for any given context.\nThe current implementation allows the mapping to have a RetryRule even if it's used in RpcClient, and it effectively turns it into RetryRuleWithContent with no problem.", "author": "haithamgabr", "createdAt": "2020-11-06T00:03:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg0ODMyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg1MDA5MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r517850091", "body": "Hmm, This seems an API level breaking changes.", "bodyText": "Hmm, This seems an API level breaking changes.", "bodyHTML": "<p dir=\"auto\">Hmm, This seems an API level breaking changes.</p>", "author": "ikhoon", "createdAt": "2020-11-05T07:52:19Z", "path": "grpc/src/test/java/com/linecorp/armeria/internal/client/grpc/GrpcClientUnwrapTest.java", "diffHunk": "@@ -37,8 +38,8 @@ void test() {\n         final TestServiceBlockingStub client =\n                 Clients.builder(\"gproto+http://127.0.0.1:1/\")\n                        .decorator(LoggingClient.newDecorator())\n-                       .decorator(RetryingClient.newDecorator(\n-                               (ctx, cause) -> CompletableFuture.completedFuture(RetryDecision.noRetry())))\n+                       .decorator(RetryingClient.newDecorator(RetryRule.of(\n+                               (ctx, cause) -> CompletableFuture.completedFuture(RetryDecision.noRetry()))))", "originalCommit": "30d5049b2ae589b96e9bbd356e342a51a27cf298", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ0NjExNA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518446114", "bodyText": "Yeah my bad.\nI did this to disambiguate between the old newDecorator call that takes RetryRule, and the new one that takes RetryConfigMapping. Problem is, both are functional interfaces with two arguments. Unfortunately Java fails to infer the overload based on the type of the returned value of the lambda. The only way to keep the new overload is for callers to disambiguate by explicitly typing the lambda args, but as you said this would break existing user code.\nThe solution I went with is to avoid overloading for the new versions of builder() and newDecorator() that take a mapping. Instead, the new versions I added now have a different names: builderWithMapping() and newDecoratorWithMapping().", "author": "haithamgabr", "createdAt": "2020-11-06T00:08:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg1MDA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQ3OTYyMQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r518479621", "bodyText": "the new versions I added now have a different names: builderWithMapping() and newDecoratorWithMapping().\n\nThat sounds good to me. \ud83d\udc4d It is the most important thing that avoids breaking changes.", "author": "ikhoon", "createdAt": "2020-11-06T02:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg1MDA5MQ=="}], "type": "inlineReview"}, {"oid": "020667f5d127d69d364d4af1ae9746f1f39c3a15", "url": "https://github.com/line/armeria/commit/020667f5d127d69d364d4af1ae9746f1f39c3a15", "message": "Renaming newDecorator mapping overload, maintaining protected getters, addressing comments", "committedDate": "2020-11-05T23:55:14Z", "type": "commit"}, {"oid": "d2c218a994f788e889e816486ba132f876a000c1", "url": "https://github.com/line/armeria/commit/d2c218a994f788e889e816486ba132f876a000c1", "message": "Replacing checkNotNull with requireNonNull", "committedDate": "2020-11-06T00:11:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNjgyNw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519536827", "body": "Revert?", "bodyText": "Revert?", "bodyHTML": "<p dir=\"auto\">Revert?</p>", "author": "trustin", "createdAt": "2020-11-09T03:39:53Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -52,11 +51,11 @@\n /**\n  * A {@link Client} decorator that handles failures of remote invocation and retries requests.\n  *\n- * @param <I> the {@link Request} type\n+ * @param <T> the {@link Request} type", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MDgyMg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520180822", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:13:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNjgyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzA5NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519537094", "body": "Missing Javadoc", "bodyText": "Missing Javadoc", "bodyHTML": "<p dir=\"auto\">Missing Javadoc</p>", "author": "trustin", "createdAt": "2020-11-09T03:41:10Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -69,74 +68,39 @@\n     private static final AttributeKey<State> STATE =\n             AttributeKey.valueOf(AbstractRetryingClient.class, \"STATE\");\n \n-    @Nullable\n-    private final RetryRule retryRule;\n-\n-    @Nullable\n-    private final RetryRule fromRetryRuleWithContent;\n-\n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private final int maxTotalAttempts;\n-    private final long responseTimeoutMillisForEachAttempt;\n+    private final RetryConfigMapping<O> mapping;\n+    private final RetryConfig retryConfig;\n \n     /**\n      * Creates a new instance that decorates the specified {@link Client}.\n      */\n-    AbstractRetryingClient(Client<I, O> delegate, RetryRule retryRule,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, requireNonNull(retryRule, \"retryRule\"), null,\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    AbstractRetryingClient(Client<I, O> delegate,\n-                           RetryRuleWithContent<O> retryRuleWithContent,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"),\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    private AbstractRetryingClient(Client<I, O> delegate, @Nullable RetryRule retryRule,\n-                                   @Nullable RetryRuleWithContent<O> retryRuleWithContent,\n-                                   int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+    AbstractRetryingClient(\n+            Client<T, O> delegate, RetryConfigMapping<O> mapping, @Nullable RetryConfig<O> retryConfig) {\n         super(delegate);\n-        this.retryRule = retryRule;\n-        this.retryRuleWithContent = retryRuleWithContent;\n-        if (retryRuleWithContent != null) {\n-            fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n-        } else {\n-            fromRetryRuleWithContent = null;\n-        }\n-\n-        checkArgument(maxTotalAttempts > 0, \"maxTotalAttempts: %s (expected: > 0)\", maxTotalAttempts);\n-        this.maxTotalAttempts = maxTotalAttempts;\n-\n-        checkArgument(responseTimeoutMillisForEachAttempt >= 0,\n-                      \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n-                      responseTimeoutMillisForEachAttempt);\n-        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        this.mapping = requireNonNull(mapping);\n+        this.retryConfig = retryConfig;\n     }\n \n     @Override\n-    public final O execute(ClientRequestContext ctx, I req) throws Exception {\n-        final State state =\n-                new State(maxTotalAttempts, responseTimeoutMillisForEachAttempt, ctx.responseTimeoutMillis());\n+    public final O execute(ClientRequestContext ctx, T req) throws Exception {\n+        final RetryConfig<O> config = mapping.get(ctx, req);\n+        final State state = new State(\n+                config.maxTotalAttempts(),\n+                config.responseTimeoutMillisForEachAttempt(),\n+                ctx.responseTimeoutMillis());\n         ctx.setAttr(STATE, state);\n         return doExecute(ctx, req);\n     }\n \n+    protected RetryConfigMapping<O> mapping() {", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4Mjk2Ng==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520182966", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:18:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzA5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzI0MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519537240", "body": "are -> Are", "bodyText": "are -> Are", "bodyHTML": "<p dir=\"auto\">are -&gt; Are</p>", "author": "trustin", "createdAt": "2020-11-09T03:41:56Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -151,8 +115,9 @@ protected static void onRetryingComplete(ClientRequestContext ctx) {\n      * @throws IllegalStateException if the {@link RetryRule} is not set\n      */\n     protected final RetryRule retryRule() {\n-        checkState(retryRule != null, \"retryRule is not set.\");\n-        return retryRule;\n+        checkState(retryConfig != null, \"No retryRule set. are you using RetryConfigMapping?\");", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MzA0Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520183047", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzMzMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519537333", "body": "are -> Are", "bodyText": "are -> Are", "bodyHTML": "<p dir=\"auto\">are -&gt; Are</p>", "author": "trustin", "createdAt": "2020-11-09T03:42:18Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -161,13 +126,9 @@ protected final RetryRule retryRule() {\n      * @throws IllegalStateException if the {@link RetryRuleWithContent} is not set\n      */\n     protected final RetryRuleWithContent<O> retryRuleWithContent() {\n-        checkState(retryRuleWithContent != null, \"retryRuleWithContent is not set.\");\n-        return retryRuleWithContent;\n-    }\n-\n-    final RetryRule fromRetryRuleWithContent() {\n-        checkState(retryRuleWithContent != null, \"retryRuleWithContent is not set.\");\n-        return fromRetryRuleWithContent;\n+        checkState(retryConfig != null, \"No retryRuleWithContent set. are you using RetryConfigMapping?\");", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MzA3OA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520183078", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:19:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzMzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzQzMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519537433", "body": "Could be `final`?", "bodyText": "Could be final?", "bodyHTML": "<p dir=\"auto\">Could be <code>final</code>?</p>", "author": "trustin", "createdAt": "2020-11-09T03:42:57Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -38,43 +37,53 @@\n  */\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n-    @Nullable\n-    private final RetryRule retryRule;\n+    @Nullable private final RetryConfigBuilder<O> retryConfig;\n \n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private RetryConfigMapping<O> mapping;", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MzM2MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520183360", "bodyText": "Made it final and removed places where it is re-assigned.", "author": "haithamgabr", "createdAt": "2020-11-09T23:19:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzNzQzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzODM3NQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519538375", "body": "- Remove the extra asterisk\r\n- Use `{@code ...}` for `maxTotalAttempts` and `responseTimeoutMillisForEachAttempt`", "bodyText": "Remove the extra asterisk\nUse {@code ...} for maxTotalAttempts and responseTimeoutMillisForEachAttempt", "bodyHTML": "<ul dir=\"auto\">\n<li>Remove the extra asterisk</li>\n<li>Use <code>{@code ...}</code> for <code>maxTotalAttempts</code> and <code>responseTimeoutMillisForEachAttempt</code></li>\n</ul>", "author": "trustin", "createdAt": "2020-11-09T03:47:31Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MzQ0Ng==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520183446", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:20:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTUzODM3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0NzY0OA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519547648", "body": "```suggestion\r\n        this.mapping = requireNonNull(mapping, \"mapping\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.mapping = requireNonNull(mapping);\n          \n          \n            \n                    this.mapping = requireNonNull(mapping, \"mapping\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>mapping <span class=\"pl-k\">=</span> requireNonNull(mapping);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>mapping <span class=\"pl-k\">=</span> requireNonNull(mapping<span class=\"x x-first\">, </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">mapping</span><span class=\"pl-pds x x-last\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "trustin", "createdAt": "2020-11-09T04:33:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -38,43 +37,53 @@\n  */\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n-    @Nullable\n-    private final RetryRule retryRule;\n+    @Nullable private final RetryConfigBuilder<O> retryConfig;\n \n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private RetryConfigMapping<O> mapping;\n \n     /**\n      * Creates a new builder with the specified {@link RetryRule}.\n      */\n     AbstractRetryingClientBuilder(RetryRule retryRule) {\n-        this(requireNonNull(retryRule, \"retryRule\"), null);\n+        retryConfig = RetryConfig.builder(requireNonNull(retryRule, \"retryRule\"));\n+        mapping = (ctx, req) -> retryConfig.build();\n     }\n \n     /**\n      * Creates a new builder with the specified {@link RetryRuleWithContent}.\n      */\n     AbstractRetryingClientBuilder(RetryRuleWithContent<O> retryRuleWithContent) {\n-        this(null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"));\n+        retryConfig = RetryConfig.builder(requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"));\n+        mapping = (ctx, req) -> retryConfig.build();\n+    }\n+\n+    /**\n+     * Creates a new builder with the specified {@link RetryRuleWithContent}.\n+     */\n+    AbstractRetryingClientBuilder(RetryRuleWithContent<O> retryRuleWithContent, int maxContentLength) {\n+        retryConfig = RetryConfig.builder(\n+                requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"),\n+                maxContentLength);\n+        mapping = (ctx, req) -> retryConfig.build();\n     }\n \n-    private AbstractRetryingClientBuilder(@Nullable RetryRule retryRule,\n-                                          @Nullable RetryRuleWithContent<O> retryRuleWithContent) {\n-        this.retryRule = retryRule;\n-        this.retryRuleWithContent = retryRuleWithContent;\n+    /**\n+     * Creates a new builder with the specified {@link RetryConfigMapping}.\n+     */\n+    AbstractRetryingClientBuilder(RetryConfigMapping<O> mapping) {\n+        this.mapping = requireNonNull(mapping);", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4MzUwMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520183500", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:20:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0NzY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0ODMxNw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519548317", "body": "We should not call `.build()` on each request. Could we build it only once?", "bodyText": "We should not call .build() on each request. Could we build it only once?", "bodyHTML": "<p dir=\"auto\">We should not call <code>.build()</code> on each request. Could we build it only once?</p>", "author": "trustin", "createdAt": "2020-11-09T04:36:34Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -38,43 +37,53 @@\n  */\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n-    @Nullable\n-    private final RetryRule retryRule;\n+    @Nullable private final RetryConfigBuilder<O> retryConfig;\n \n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private RetryConfigMapping<O> mapping;\n \n     /**\n      * Creates a new builder with the specified {@link RetryRule}.\n      */\n     AbstractRetryingClientBuilder(RetryRule retryRule) {\n-        this(requireNonNull(retryRule, \"retryRule\"), null);\n+        retryConfig = RetryConfig.builder(requireNonNull(retryRule, \"retryRule\"));\n+        mapping = (ctx, req) -> retryConfig.build();", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NDEyMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520184120", "bodyText": "I made mapping nullable and changed its getter to call retryConfig() if it's null, so that we keep the assumption that mapping() always returns a mapping (not null). If a fixed config was set, the mapping always returns this config.", "author": "haithamgabr", "createdAt": "2020-11-09T23:22:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0ODMxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0ODU1Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519548557", "body": "How about removing this constructor as well as `RetryConfig.builder()` that requires `maxContentLength`? We could instead add a setter to the builders?", "bodyText": "How about removing this constructor as well as RetryConfig.builder() that requires maxContentLength? We could instead add a setter to the builders?", "bodyHTML": "<p dir=\"auto\">How about removing this constructor as well as <code>RetryConfig.builder()</code> that requires <code>maxContentLength</code>? We could instead add a setter to the builders?</p>", "author": "trustin", "createdAt": "2020-11-09T04:37:47Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -38,43 +37,53 @@\n  */\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n-    @Nullable\n-    private final RetryRule retryRule;\n+    @Nullable private final RetryConfigBuilder<O> retryConfig;\n \n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private RetryConfigMapping<O> mapping;\n \n     /**\n      * Creates a new builder with the specified {@link RetryRule}.\n      */\n     AbstractRetryingClientBuilder(RetryRule retryRule) {\n-        this(requireNonNull(retryRule, \"retryRule\"), null);\n+        retryConfig = RetryConfig.builder(requireNonNull(retryRule, \"retryRule\"));\n+        mapping = (ctx, req) -> retryConfig.build();\n     }\n \n     /**\n      * Creates a new builder with the specified {@link RetryRuleWithContent}.\n      */\n     AbstractRetryingClientBuilder(RetryRuleWithContent<O> retryRuleWithContent) {\n-        this(null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"));\n+        retryConfig = RetryConfig.builder(requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"));\n+        mapping = (ctx, req) -> retryConfig.build();\n+    }\n+\n+    /**\n+     * Creates a new builder with the specified {@link RetryRuleWithContent}.\n+     */\n+    AbstractRetryingClientBuilder(RetryRuleWithContent<O> retryRuleWithContent, int maxContentLength) {\n+        retryConfig = RetryConfig.builder(\n+                requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"),\n+                maxContentLength);", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NDE5OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520184199", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:22:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0ODU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0ODk2NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519548964", "body": "This will make a debugger see an exception instead of a string. Could we make this fall back to the old version when `retryConfig` is null?", "bodyText": "This will make a debugger see an exception instead of a string. Could we make this fall back to the old version when retryConfig is null?", "bodyHTML": "<p dir=\"auto\">This will make a debugger see an exception instead of a string. Could we make this fall back to the old version when <code>retryConfig</code> is null?</p>", "author": "trustin", "createdAt": "2020-11-09T04:39:45Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -140,10 +149,9 @@ public String toString() {\n     }\n \n     final ToStringHelper toStringHelper() {\n-        return MoreObjects.toStringHelper(this).omitNullValues()\n-                          .add(\"retryRule\", retryRule)\n-                          .add(\"retryRuleWithContent\", retryRuleWithContent)\n-                          .add(\"maxTotalAttempts\", maxTotalAttempts)\n-                          .add(\"responseTimeoutMillisForEachAttempt\", responseTimeoutMillisForEachAttempt);\n+        checkState(\n+                retryConfig != null,\n+                \"You are using a RetryConfigMapping, so you cannot get a string representation.\");\n+        return retryConfig.toStringHelper();", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NDQwOA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520184408", "bodyText": "Changed it so when a mapping is used instead of retryConfig, the mapping is printed.", "author": "haithamgabr", "createdAt": "2020-11-09T23:22:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0ODk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTUyMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519549523", "body": "Could maxContentLength be unlimited by default and be overridden by using a setter in `RetryConfigBuilder`?", "bodyText": "Could maxContentLength be unlimited by default and be overridden by using a setter in RetryConfigBuilder?", "bodyHTML": "<p dir=\"auto\">Could maxContentLength be unlimited by default and be overridden by using a setter in <code>RetryConfigBuilder</code>?</p>", "author": "trustin", "createdAt": "2020-11-09T04:42:16Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NDYyMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520184620", "bodyText": "Done through RetryConfigBuilder constructor.", "author": "haithamgabr", "createdAt": "2020-11-09T23:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTU4OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519549589", "body": "Please move all static factory methods before the member fields.", "bodyText": "Please move all static factory methods before the member fields.", "bodyHTML": "<p dir=\"auto\">Please move all static factory methods before the member fields.</p>", "author": "trustin", "createdAt": "2020-11-09T04:42:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NDY4Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520184687", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTU4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTk0MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519549940", "body": "Could we explain what this property does rather than just repeating what the method name implies? e.g. `Returns the maximum number of request attempts made by a {@link RetryingClient}.`", "bodyText": "Could we explain what this property does rather than just repeating what the method name implies? e.g. Returns the maximum number of request attempts made by a {@link RetryingClient}.", "bodyHTML": "<p dir=\"auto\">Could we explain what this property does rather than just repeating what the method name implies? e.g. <code>Returns the maximum number of request attempts made by a {@link RetryingClient}.</code></p>", "author": "trustin", "createdAt": "2020-11-09T04:44:14Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NDczMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520184730", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU0OTk0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDA1MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519550050", "body": "Ditto - please update the Javadoc of all properties for better user experience.", "bodyText": "Ditto - please update the Javadoc of all properties for better user experience.", "bodyHTML": "<p dir=\"auto\">Ditto - please update the Javadoc of all properties for better user experience.</p>", "author": "trustin", "createdAt": "2020-11-09T04:44:45Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4MTQ3MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519581470", "bodyText": "You could copy some of them from the parameter descriptions in RetryingClient's factory method Javadoc.", "author": "trustin", "createdAt": "2020-11-09T06:47:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDA1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NDc2OA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520184768", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:23:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDY1MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519550650", "body": "How about merging this method into `retryRule()`?", "bodyText": "How about merging this method into retryRule()?", "bodyHTML": "<p dir=\"auto\">How about merging this method into <code>retryRule()</code>?</p>", "author": "trustin", "createdAt": "2020-11-09T04:47:28Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns config's retryRule, could be null.\n+     */\n+    @Nullable\n+    public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns config's retryRuleWithContent, could be null.\n+     */\n+    @Nullable\n+    public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's retry rule that is converted from retryRuleWithContent, could be null.\n+     */\n+    @Nullable\n+    public RetryRule fromRetryRuleWithContent() {\n+        return fromRetryRuleWithContent;\n+    }", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NTQ2Mw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520185463", "bodyText": "The distinction between the regular retryRule and the one converted from retryRuleWithContent is important for calling sites. It is important that retryRule be null when it is not set, and not resemble one converted from the one with content.", "author": "haithamgabr", "createdAt": "2020-11-09T23:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDY1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDc2OA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519550768", "body": "Please moves these after the member fields, so that the initialization code comes before other member methods.", "bodyText": "Please moves these after the member fields, so that the initialization code comes before other member methods.", "bodyHTML": "<p dir=\"auto\">Please moves these after the member fields, so that the initialization code comes before other member methods.</p>", "author": "trustin", "createdAt": "2020-11-09T04:48:12Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ *  * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfig<T extends Response> {\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    @Nullable private final RetryRule retryRule;\n+    @Nullable private final RetryRuleWithContent<T> retryRuleWithContent;\n+    @Nullable private final RetryRule fromRetryRuleWithContent;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses {@link RetryRuleWithContent} with specified maxContentLength.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent, maxContentLength);\n+    }\n+\n+    /**\n+     * Returns config's maxTotalAttempt.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns config's responseTimeoutMillisForEachAttempt.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns config's retryRule, could be null.\n+     */\n+    @Nullable\n+    public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns config's retryRuleWithContent, could be null.\n+     */\n+    @Nullable\n+    public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's retry rule that is converted from retryRuleWithContent, could be null.\n+     */\n+    @Nullable\n+    public RetryRule fromRetryRuleWithContent() {\n+        return fromRetryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's maxContentLength, which is non-zero only if a {@link RetryRuleWithContent} is used.\n+     */\n+    public int maxContentLength() {\n+        return maxContentLength;\n+    }\n+\n+    /**\n+     * Returns whether a {@link RetryRuleWithContent} is being used.\n+     */\n+    public boolean needsContentInRule() {\n+        return needsContentInRule;\n+    }\n+\n+    /**\n+     * Returns whether the associated requires response trailers.\n+     */\n+    public boolean requiresResponseTrailers() {\n+        return needsContentInRule() ?\n+               retryRuleWithContent().requiresResponseTrailers() : retryRule().requiresResponseTrailers();\n+    }\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = requireNonNull(retryRule);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = false;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.maxContentLength = maxContentLength;\n+        this.retryRuleWithContent = requireNonNull(retryRuleWithContent);\n+        fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = true;\n+        retryRule = null;\n+    }\n+\n+    private static void checkArguments(int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArgument(\n+                maxTotalAttempts > 0,\n+                \"maxTotalAttempts: %s (expected: > 0)\",\n+                maxTotalAttempts);\n+        checkArgument(\n+                responseTimeoutMillisForEachAttempt >= 0,\n+                \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n+                responseTimeoutMillisForEachAttempt);\n+    }\n+}", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NTQ5OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520185499", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:25:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MDc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTE2MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519551160", "body": "- `BiFunction<? super ClientRequestContext, ? super Request, String>`\r\n- `BiFunction<? super ClientRequestContext, ? super Request, RetryConfig<T>>`\r\n", "bodyText": "BiFunction<? super ClientRequestContext, ? super Request, String>\nBiFunction<? super ClientRequestContext, ? super Request, RetryConfig<T>>", "bodyHTML": "<ul dir=\"auto\">\n<li><code>BiFunction&lt;? super ClientRequestContext, ? super Request, String&gt;</code></li>\n<li><code>BiFunction&lt;? super ClientRequestContext, ? super Request, RetryConfig&lt;T&gt;&gt;</code></li>\n</ul>", "author": "trustin", "createdAt": "2020-11-09T04:49:55Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigMapping.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import java.util.function.BiFunction;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Returns a {@link RetryConfig} given the request context.\n+ */\n+@FunctionalInterface\n+public interface RetryConfigMapping<T extends Response> {\n+    /**\n+     * Creates a {@link KeyedRetryConfigMapping} that maps keys created by keyFactory to  {@link RetryConfig}s\n+     * created by retryConfigFactory.\n+     */\n+    static <T extends Response> RetryConfigMapping<T> of(\n+            BiFunction<ClientRequestContext, Request, String> keyFactory,\n+            BiFunction<ClientRequestContext, Request, RetryConfig<T>> retryConfigFactory) {", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NTU5MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520185590", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-09T23:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTMxNQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r519551315", "body": "`builder()` or `builderWithMapping()`?", "bodyText": "builder() or builderWithMapping()?", "bodyHTML": "<p dir=\"auto\"><code>builder()</code> or <code>builderWithMapping()</code>?</p>", "author": "trustin", "createdAt": "2020-11-09T04:50:26Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -85,6 +87,13 @@ public static RetryingClientBuilder builder(RetryRuleWithContent<HttpResponse> r\n         return new RetryingClientBuilder(retryRuleWithContent, maxContentLength);\n     }\n \n+    /**\n+     * Returns a new {@link RetryingClientBuilder} with the specified {@link RetryConfigMapping}.\n+     */\n+    public static RetryingClientBuilder builderWithMapping(RetryConfigMapping<HttpResponse> mapping) {", "originalCommit": "d2c218a994f788e889e816486ba132f876a000c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE4NjI4Mg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r520186282", "bodyText": "builderWithMapping() name is used instead of a normal overload for builder(), because the overload is ambiguous with an existing signature builder(RetryRule). Java does not understand that lambdas following the functional interface for RetryRule and RetryConfigMapping are of different types, since both have two arguments, although the arguments are of different types.", "author": "haithamgabr", "createdAt": "2020-11-09T23:27:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU1MTMxNQ=="}], "type": "inlineReview"}, {"oid": "ecc904516a17c9505eec0b358e5bcd9807de52bb", "url": "https://github.com/line/armeria/commit/ecc904516a17c9505eec0b358e5bcd9807de52bb", "message": "Refactoring, Documenting, and addressing comments", "committedDate": "2020-11-09T23:12:41Z", "type": "commit"}, {"oid": "d1f00aaf3edbf0d3d789c4b7841b532f0b4dc2b9", "url": "https://github.com/line/armeria/commit/d1f00aaf3edbf0d3d789c4b7841b532f0b4dc2b9", "message": "Refactoring, Documenting, and addressing comments", "committedDate": "2020-11-09T23:16:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4NjQ3OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r521786479", "body": "Global comment:\r\nCould you add the message?\r\n`requireNonNull(mapping, \"mapping\");`", "bodyText": "Global comment:\nCould you add the message?\nrequireNonNull(mapping, \"mapping\");", "bodyHTML": "<p dir=\"auto\">Global comment:<br>\nCould you add the message?<br>\n<code>requireNonNull(mapping, \"mapping\");</code></p>", "author": "minwoox", "createdAt": "2020-11-12T02:58:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -69,69 +68,37 @@\n     private static final AttributeKey<State> STATE =\n             AttributeKey.valueOf(AbstractRetryingClient.class, \"STATE\");\n \n-    @Nullable\n-    private final RetryRule retryRule;\n-\n-    @Nullable\n-    private final RetryRule fromRetryRuleWithContent;\n-\n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private final int maxTotalAttempts;\n-    private final long responseTimeoutMillisForEachAttempt;\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    AbstractRetryingClient(Client<I, O> delegate, RetryRule retryRule,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, requireNonNull(retryRule, \"retryRule\"), null,\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n+    private final RetryConfigMapping<O> mapping;\n+    private final RetryConfig retryConfig;\n \n     /**\n      * Creates a new instance that decorates the specified {@link Client}.\n      */\n-    AbstractRetryingClient(Client<I, O> delegate,\n-                           RetryRuleWithContent<O> retryRuleWithContent,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"),\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    private AbstractRetryingClient(Client<I, O> delegate, @Nullable RetryRule retryRule,\n-                                   @Nullable RetryRuleWithContent<O> retryRuleWithContent,\n-                                   int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+    AbstractRetryingClient(\n+            Client<I, O> delegate, RetryConfigMapping<O> mapping, @Nullable RetryConfig<O> retryConfig) {\n         super(delegate);\n-        this.retryRule = retryRule;\n-        this.retryRuleWithContent = retryRuleWithContent;\n-        if (retryRuleWithContent != null) {\n-            fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n-        } else {\n-            fromRetryRuleWithContent = null;\n-        }\n-\n-        checkArgument(maxTotalAttempts > 0, \"maxTotalAttempts: %s (expected: > 0)\", maxTotalAttempts);\n-        this.maxTotalAttempts = maxTotalAttempts;\n-\n-        checkArgument(responseTimeoutMillisForEachAttempt >= 0,\n-                      \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n-                      responseTimeoutMillisForEachAttempt);\n-        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        this.mapping = requireNonNull(mapping);", "originalCommit": "d1f00aaf3edbf0d3d789c4b7841b532f0b4dc2b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3NzY3NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522377674", "bodyText": "Done everywhere", "author": "haithamgabr", "createdAt": "2020-11-12T19:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc4NjQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgxMzEwNQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r521813105", "body": "Fortunately, these constructors are package-private so we can change them:\r\nHow about making the constructor takes just `RetryConfigBuilder`, then we will have two constructors:\r\n```java\r\nAbstractRetryingClientBuilder(RetryConfigBuilder retryConfigBuilder) {...}\r\nAbstractRetryingClientBuilder(RetryConfigMapping<O> mapping) {...}\r\n```", "bodyText": "Fortunately, these constructors are package-private so we can change them:\nHow about making the constructor takes just RetryConfigBuilder, then we will have two constructors:\nAbstractRetryingClientBuilder(RetryConfigBuilder retryConfigBuilder) {...}\nAbstractRetryingClientBuilder(RetryConfigMapping<O> mapping) {...}", "bodyHTML": "<p dir=\"auto\">Fortunately, these constructors are package-private so we can change them:<br>\nHow about making the constructor takes just <code>RetryConfigBuilder</code>, then we will have two constructors:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"AbstractRetryingClientBuilder(RetryConfigBuilder retryConfigBuilder) {...}\nAbstractRetryingClientBuilder(RetryConfigMapping&lt;O&gt; mapping) {...}\n\"><pre>AbstractRetryingClientBuilder(<span class=\"pl-smi\">RetryConfigBuilder</span> retryConfigBuilder) {<span class=\"pl-c1\">...</span>}\nAbstractRetryingClientBuilder(<span class=\"pl-k\">RetryConfigMapping&lt;<span class=\"pl-smi\">O</span>&gt;</span> mapping) {<span class=\"pl-c1\">...</span>}</pre></div>", "author": "minwoox", "createdAt": "2020-11-12T03:48:17Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -38,43 +38,47 @@\n  */\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n-    @Nullable\n-    private final RetryRule retryRule;\n+    @Nullable private final RetryConfigBuilder<O> retryConfig;\n \n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    @Nullable private final RetryConfigMapping<O> mapping;\n \n     /**\n      * Creates a new builder with the specified {@link RetryRule}.\n      */\n     AbstractRetryingClientBuilder(RetryRule retryRule) {", "originalCommit": "d1f00aaf3edbf0d3d789c4b7841b532f0b4dc2b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3ODI4NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522378284", "bodyText": "Removed them, and added a constructor that takes a RetryConfig, and converts it to builder using toBuilder()", "author": "haithamgabr", "createdAt": "2020-11-12T19:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgxMzEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgxNjU4NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r521816584", "body": "How about deprecating these methods for `maxTotalAttempts`, `responseTimeout` and `maxContentLength` because `RetryConfig` is responsible for those parameters now?\r\nWe might recommend to use `RetryingClient.builder(RetryConfig)`\r\n\r\nAlso, we need `RetryConfig.toBuilder` ~so that we don't have to raise an exception~.", "bodyText": "How about deprecating these methods for maxTotalAttempts, responseTimeout and maxContentLength because RetryConfig is responsible for those parameters now?\nWe might recommend to use RetryingClient.builder(RetryConfig)\nAlso, we need RetryConfig.toBuilder so that we don't have to raise an exception.", "bodyHTML": "<p dir=\"auto\">How about deprecating these methods for <code>maxTotalAttempts</code>, <code>responseTimeout</code> and <code>maxContentLength</code> because <code>RetryConfig</code> is responsible for those parameters now?<br>\nWe might recommend to use <code>RetryingClient.builder(RetryConfig)</code></p>\n<p dir=\"auto\">Also, we need <code>RetryConfig.toBuilder</code> <del>so that we don't have to raise an exception</del>.</p>", "author": "minwoox", "createdAt": "2020-11-12T03:53:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -84,16 +88,13 @@ final RetryRule retryRule() {\n      * @return {@code this} to support method chaining.\n      */\n     public AbstractRetryingClientBuilder<O> maxTotalAttempts(int maxTotalAttempts) {", "originalCommit": "d1f00aaf3edbf0d3d789c4b7841b532f0b4dc2b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3OTYwNw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522379607", "bodyText": "Added the missing builder(RetryConfig) and newDecorator(RetryConfig) methods in RetryingClient and RetryingRpcClient, deprecated these setters, and deprecated the builder() and newDecorator() methods that take maxTotalAttempts and responseTimeoutPerAttempt.", "author": "haithamgabr", "createdAt": "2020-11-12T19:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgxNjU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgxOTk5OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r521819999", "body": "How about just accepting `Client<I, O> delegate, RetryConfigMapping<O> mapping`?\r\nI think we can set the config to the `ctx` as an attribute and retrieve it in\r\n`retryRule()` and `retryRuleWithContent()` using `ClientRequestContext.current()`.", "bodyText": "How about just accepting Client<I, O> delegate, RetryConfigMapping<O> mapping?\nI think we can set the config to the ctx as an attribute and retrieve it in\nretryRule() and retryRuleWithContent() using ClientRequestContext.current().", "bodyHTML": "<p dir=\"auto\">How about just accepting <code>Client&lt;I, O&gt; delegate, RetryConfigMapping&lt;O&gt; mapping</code>?<br>\nI think we can set the config to the <code>ctx</code> as an attribute and retrieve it in<br>\n<code>retryRule()</code> and <code>retryRuleWithContent()</code> using <code>ClientRequestContext.current()</code>.</p>", "author": "minwoox", "createdAt": "2020-11-12T03:58:38Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -69,69 +68,37 @@\n     private static final AttributeKey<State> STATE =\n             AttributeKey.valueOf(AbstractRetryingClient.class, \"STATE\");\n \n-    @Nullable\n-    private final RetryRule retryRule;\n-\n-    @Nullable\n-    private final RetryRule fromRetryRuleWithContent;\n-\n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private final int maxTotalAttempts;\n-    private final long responseTimeoutMillisForEachAttempt;\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    AbstractRetryingClient(Client<I, O> delegate, RetryRule retryRule,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, requireNonNull(retryRule, \"retryRule\"), null,\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n+    private final RetryConfigMapping<O> mapping;\n+    private final RetryConfig retryConfig;\n \n     /**\n      * Creates a new instance that decorates the specified {@link Client}.\n      */\n-    AbstractRetryingClient(Client<I, O> delegate,\n-                           RetryRuleWithContent<O> retryRuleWithContent,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"),\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    private AbstractRetryingClient(Client<I, O> delegate, @Nullable RetryRule retryRule,\n-                                   @Nullable RetryRuleWithContent<O> retryRuleWithContent,\n-                                   int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+    AbstractRetryingClient(\n+            Client<I, O> delegate, RetryConfigMapping<O> mapping, @Nullable RetryConfig<O> retryConfig) {", "originalCommit": "d1f00aaf3edbf0d3d789c4b7841b532f0b4dc2b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjI3OTk2MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522279961", "bodyText": "There are protected getters in this class: retryRule() and retryRuleWithContent(), which need the retryConfig to pull the rule from.\nmapping is never null. Even if it wasn't explicitly set and a single retryConfig was set instead, mapping is set as a function that always returns that config. mapping is used everywhere to get rule and config. However, the getters mentioned above can still be useful for people not setting a mapping, and they need to know for sure whether a retryConfig was explicitly set.", "author": "haithamgabr", "createdAt": "2020-11-12T17:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgxOTk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2NzI2Mg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522567262", "bodyText": "the getters mentioned above can still be useful for people not setting a mapping, and they need to know for sure whether a retryConfig was explicitly set.\n\nI was sort of thinking to store the retryConfig to ClientRequestContext in the execute() method so that we can call ClientReqesutContext.current() and retrieve the retryConfig in retryRule() method.\nBut, I'm also fine as it is now. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-11-13T02:12:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgxOTk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgyMDcyNA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r521820724", "body": "Global comment:\r\nCould you use auto formatting?\r\nif so this will be:\r\n```java\r\n@Nullable\r\nprivate final RetryConfigBuilder<O> retryConfig;\r\n```", "bodyText": "Global comment:\nCould you use auto formatting?\nif so this will be:\n@Nullable\nprivate final RetryConfigBuilder<O> retryConfig;", "bodyHTML": "<p dir=\"auto\">Global comment:<br>\nCould you use auto formatting?<br>\nif so this will be:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"@Nullable\nprivate final RetryConfigBuilder&lt;O&gt; retryConfig;\"><pre><span class=\"pl-k\">@Nullable</span>\n<span class=\"pl-k\">private</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">RetryConfigBuilder&lt;<span class=\"pl-smi\">O</span>&gt;</span> retryConfig;</pre></div>", "author": "minwoox", "createdAt": "2020-11-12T03:59:40Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -38,43 +38,47 @@\n  */\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n-    @Nullable\n-    private final RetryRule retryRule;\n+    @Nullable private final RetryConfigBuilder<O> retryConfig;", "originalCommit": "d1f00aaf3edbf0d3d789c4b7841b532f0b4dc2b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3OTcxMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522379710", "bodyText": "Done everywhere", "author": "haithamgabr", "createdAt": "2020-11-12T19:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgyMDcyNA=="}], "type": "inlineReview"}, {"oid": "2229baf2fe4c74f19e9138da343165587eba6554", "url": "https://github.com/line/armeria/commit/2229baf2fe4c74f19e9138da343165587eba6554", "message": "Refactoring, deprecating, and addressing comments", "committedDate": "2020-11-12T19:23:09Z", "type": "commit"}, {"oid": "44d952ff1eba0879bb966991990adc6077baf07f", "url": "https://github.com/line/armeria/commit/44d952ff1eba0879bb966991990adc6077baf07f", "message": "Refactoring, deprecating, and addressing comments", "committedDate": "2020-11-12T19:40:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2NzY4NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522567684", "body": "How about just `retryConfigBuilder` for the field name?", "bodyText": "How about just retryConfigBuilder for the field name?", "bodyHTML": "<p dir=\"auto\">How about just <code>retryConfigBuilder</code> for the field name?</p>", "author": "minwoox", "createdAt": "2020-11-13T02:14:06Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -39,61 +39,60 @@\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n     @Nullable\n-    private final RetryRule retryRule;\n+    private final RetryConfigBuilder<O> retryConfig;\n \n     @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private final RetryConfigMapping<O> mapping;\n \n     /**\n-     * Creates a new builder with the specified {@link RetryRule}.\n+     * Creates a new builder with the specified {@link RetryConfig}.\n      */\n-    AbstractRetryingClientBuilder(RetryRule retryRule) {\n-        this(requireNonNull(retryRule, \"retryRule\"), null);\n+    AbstractRetryingClientBuilder(RetryConfig<O> retryConfig) {\n+        this.retryConfig = requireNonNull(retryConfig, \"retryConfig\").toBuilder();", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTA3Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611077", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:23:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2NzY4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODQxNg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522568416", "body": "Could you add `assert config != null;` so that IDE does not complain?", "bodyText": "Could you add assert config != null; so that IDE does not complain?", "bodyHTML": "<p dir=\"auto\">Could you add <code>assert config != null;</code> so that IDE does not complain?</p>", "author": "minwoox", "createdAt": "2020-11-13T02:16:35Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -39,61 +39,60 @@\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n     @Nullable\n-    private final RetryRule retryRule;\n+    private final RetryConfigBuilder<O> retryConfig;\n \n     @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private final RetryConfigMapping<O> mapping;\n \n     /**\n-     * Creates a new builder with the specified {@link RetryRule}.\n+     * Creates a new builder with the specified {@link RetryConfig}.\n      */\n-    AbstractRetryingClientBuilder(RetryRule retryRule) {\n-        this(requireNonNull(retryRule, \"retryRule\"), null);\n+    AbstractRetryingClientBuilder(RetryConfig<O> retryConfig) {\n+        this.retryConfig = requireNonNull(retryConfig, \"retryConfig\").toBuilder();\n+        mapping = null;\n     }\n \n     /**\n-     * Creates a new builder with the specified {@link RetryRuleWithContent}.\n+     * Creates a new builder with the specified {@link RetryConfigMapping}.\n      */\n-    AbstractRetryingClientBuilder(RetryRuleWithContent<O> retryRuleWithContent) {\n-        this(null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"));\n-    }\n-\n-    private AbstractRetryingClientBuilder(@Nullable RetryRule retryRule,\n-                                          @Nullable RetryRuleWithContent<O> retryRuleWithContent) {\n-        this.retryRule = retryRule;\n-        this.retryRuleWithContent = retryRuleWithContent;\n+    AbstractRetryingClientBuilder(RetryConfigMapping<O> mapping) {\n+        this.mapping = requireNonNull(mapping, \"mapping\");\n+        retryConfig = null;\n     }\n \n-    final RetryRule retryRule() {\n-        checkState(retryRule != null, \"retryRule is not set.\");\n-        return retryRule;\n+    final RetryConfigMapping<O> mapping() {\n+        if (mapping == null) {\n+            final RetryConfig<O> config = retryConfig();\n+            return (ctx, req) -> config;", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTE1NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611154", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODQxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODU2MA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522568560", "body": "We can do `@deprecated Use {@link RetryConfigBuilder#maxTotalAttempts(int)}.` \ud83d\ude04 ", "bodyText": "We can do @deprecated Use {@link RetryConfigBuilder#maxTotalAttempts(int)}. \ud83d\ude04", "bodyHTML": "<p dir=\"auto\">We can do <code>@deprecated Use {@link RetryConfigBuilder#maxTotalAttempts(int)}.</code> <g-emoji class=\"g-emoji\" alias=\"smile\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f604.png\">\ud83d\ude04</g-emoji></p>", "author": "minwoox", "createdAt": "2020-11-13T02:17:02Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -39,61 +39,60 @@\n public abstract class AbstractRetryingClientBuilder<O extends Response> {\n \n     @Nullable\n-    private final RetryRule retryRule;\n+    private final RetryConfigBuilder<O> retryConfig;\n \n     @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n-    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private final RetryConfigMapping<O> mapping;\n \n     /**\n-     * Creates a new builder with the specified {@link RetryRule}.\n+     * Creates a new builder with the specified {@link RetryConfig}.\n      */\n-    AbstractRetryingClientBuilder(RetryRule retryRule) {\n-        this(requireNonNull(retryRule, \"retryRule\"), null);\n+    AbstractRetryingClientBuilder(RetryConfig<O> retryConfig) {\n+        this.retryConfig = requireNonNull(retryConfig, \"retryConfig\").toBuilder();\n+        mapping = null;\n     }\n \n     /**\n-     * Creates a new builder with the specified {@link RetryRuleWithContent}.\n+     * Creates a new builder with the specified {@link RetryConfigMapping}.\n      */\n-    AbstractRetryingClientBuilder(RetryRuleWithContent<O> retryRuleWithContent) {\n-        this(null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"));\n-    }\n-\n-    private AbstractRetryingClientBuilder(@Nullable RetryRule retryRule,\n-                                          @Nullable RetryRuleWithContent<O> retryRuleWithContent) {\n-        this.retryRule = retryRule;\n-        this.retryRuleWithContent = retryRuleWithContent;\n+    AbstractRetryingClientBuilder(RetryConfigMapping<O> mapping) {\n+        this.mapping = requireNonNull(mapping, \"mapping\");\n+        retryConfig = null;\n     }\n \n-    final RetryRule retryRule() {\n-        checkState(retryRule != null, \"retryRule is not set.\");\n-        return retryRule;\n+    final RetryConfigMapping<O> mapping() {\n+        if (mapping == null) {\n+            final RetryConfig<O> config = retryConfig();\n+            return (ctx, req) -> config;\n+        }\n+        return mapping;\n     }\n \n-    final RetryRuleWithContent<O> retryRuleWithContent() {\n-        checkState(retryRuleWithContent != null, \"retryRuleWithContent is not set.\");\n-        return retryRuleWithContent;\n+    @Nullable\n+    final RetryConfig<O> retryConfig() {\n+        if (retryConfig == null) {\n+            return null;\n+        }\n+        return retryConfig.build();\n     }\n \n     /**\n      * Sets the maximum allowed number of total attempts. If unspecified, the value from\n      * {@link Flags#defaultMaxTotalAttempts()} will be used.\n      *\n      * @return {@code this} to support method chaining.\n+     *\n+     * @deprecated Use {@link RetryConfigBuilder}::maxTotalAttempts() instead.", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTIzOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611239", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODY3Mg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522568672", "body": "ditto", "bodyText": "ditto", "bodyHTML": "<p dir=\"auto\">ditto</p>", "author": "minwoox", "createdAt": "2020-11-13T02:17:28Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -104,30 +103,37 @@ final int maxTotalAttempts() {\n      * @return {@code this} to support method chaining.\n      *\n      * @see <a href=\"https://armeria.dev/docs/client-retry#per-attempt-timeout\">Per-attempt timeout</a>\n+     *\n+     * @deprecated Use {@link RetryConfigBuilder}::responseTimeoutMillisForEachAttempt() instead.", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTMxNA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611314", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODg4Mw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522568883", "body": "ditto.", "bodyText": "ditto.", "bodyHTML": "<p dir=\"auto\">ditto.</p>", "author": "minwoox", "createdAt": "2020-11-13T02:18:12Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -104,30 +103,37 @@ final int maxTotalAttempts() {\n      * @return {@code this} to support method chaining.\n      *\n      * @see <a href=\"https://armeria.dev/docs/client-retry#per-attempt-timeout\">Per-attempt timeout</a>\n+     *\n+     * @deprecated Use {@link RetryConfigBuilder}::responseTimeoutMillisForEachAttempt() instead.\n      */\n+    @Deprecated\n     public AbstractRetryingClientBuilder<O> responseTimeoutMillisForEachAttempt(\n             long responseTimeoutMillisForEachAttempt) {\n+        checkState(retryConfig != null,\n+                   \"You are using a RetryConfigMapping. You cannot set responseTimeoutMillisForEachAttempt.\");\n         checkArgument(responseTimeoutMillisForEachAttempt >= 0,\n                       \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n                       responseTimeoutMillisForEachAttempt);\n-        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        retryConfig.responseTimeoutMillisForEachAttempt(responseTimeoutMillisForEachAttempt);\n         return this;\n     }\n \n-    final long responseTimeoutMillisForEachAttempt() {\n-        return responseTimeoutMillisForEachAttempt;\n-    }\n-\n     /**\n      * Sets the response timeout for each attempt. When requests in {@link AbstractRetryingClient} are made,\n      * corresponding responses are timed out by this value. {@code 0} disables the timeout.\n      *\n      * @return {@code this} to support method chaining.\n      *\n      * @see <a href=\"https://armeria.dev/docs/client-retry#per-attempt-timeout\">Per-attempt timeout</a>\n+     *\n+     * @deprecated Use {@link RetryConfigBuilder}::responseTimeoutForEachAttempt() instead.", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTM4NQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611385", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2ODg4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2OTg1OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522569859", "body": "nit: two spaces before `mapping`", "bodyText": "nit: two spaces before mapping", "bodyHTML": "<p dir=\"auto\">nit: two spaces before <code>mapping</code></p>", "author": "minwoox", "createdAt": "2020-11-13T02:21:22Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/KeyedRetryConfigMapping.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.function.BiFunction;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+\n+final class KeyedRetryConfigMapping<T extends Response> implements RetryConfigMapping<T> {\n+    private final BiFunction<? super ClientRequestContext, Request, RetryConfig<T>> retryConfigFactory;\n+    private final BiFunction<? super ClientRequestContext, Request, String> keyFactory;\n+    private final ConcurrentMap<String, RetryConfig<T>>  mapping = new ConcurrentHashMap<>();", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMjEyMg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522612122", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2OTg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MDg1Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522570857", "body": "Can we just call `computeIfAbsent`?", "bodyText": "Can we just call computeIfAbsent?", "bodyHTML": "<p dir=\"auto\">Can we just call <code>computeIfAbsent</code>?</p>", "author": "minwoox", "createdAt": "2020-11-13T02:24:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/KeyedRetryConfigMapping.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+import java.util.function.BiFunction;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+\n+final class KeyedRetryConfigMapping<T extends Response> implements RetryConfigMapping<T> {\n+    private final BiFunction<? super ClientRequestContext, Request, RetryConfig<T>> retryConfigFactory;\n+    private final BiFunction<? super ClientRequestContext, Request, String> keyFactory;\n+    private final ConcurrentMap<String, RetryConfig<T>>  mapping = new ConcurrentHashMap<>();\n+\n+    KeyedRetryConfigMapping(\n+            BiFunction<? super ClientRequestContext, Request, String> keyFactory,\n+            BiFunction<? super ClientRequestContext, Request, RetryConfig<T>> retryConfigFactory) {\n+        this.keyFactory = requireNonNull(keyFactory, \"keyFactory\");\n+        this.retryConfigFactory = requireNonNull(retryConfigFactory, \"retryConfigFactory\");\n+    }\n+\n+    @Override\n+    public RetryConfig<T> get(ClientRequestContext ctx, Request req) {\n+        final String key = keyFactory.apply(ctx, req);\n+        final RetryConfig<T> config = mapping.get(key);", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMjIwMQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522612201", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:25:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MDg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MzE3NQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522573175", "body": "How about raising an exception if `retryRule != null`? or\r\nWe can add this parameter to the constructor that takes `RetryRuleWithContent`. ", "bodyText": "How about raising an exception if retryRule != null? or\nWe can add this parameter to the constructor that takes RetryRuleWithContent.", "bodyHTML": "<p dir=\"auto\">How about raising an exception if <code>retryRule != null</code>? or<br>\nWe can add this parameter to the constructor that takes <code>RetryRuleWithContent</code>.</p>", "author": "minwoox", "createdAt": "2020-11-13T02:32:33Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private int maxContentLength;\n+\n+    @Nullable\n+    private final RetryRule retryRule;\n+\n+    @Nullable\n+    private final RetryRuleWithContent<T> retryRuleWithContent;\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRule}.\n+     */\n+    RetryConfigBuilder(RetryRule retryRule) {\n+        this.retryRule = requireNonNull(retryRule, \"retryRule\");\n+        retryRuleWithContent = null;\n+        maxContentLength = 0;\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRuleWithContent}.\n+     */\n+    RetryConfigBuilder(RetryRuleWithContent<T> retryRuleWithContent) {\n+        retryRule = null;\n+        this.retryRuleWithContent = requireNonNull(retryRuleWithContent, \"retryRuleWithContent\");\n+        maxContentLength = Integer.MAX_VALUE;\n+    }\n+\n+    /**\n+     * Sets the maxContentLength to be used with a {@link RetryRuleWithContent}.\n+     */\n+    public RetryConfigBuilder<T> maxContentLength(int maxContentLength) {\n+        checkArgument(maxContentLength > 0,", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMzE2MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522613161", "bodyText": "I had it in the constructor at the beginning and moved it to a setter based on an earlier comment.\nAdded requireNonNull for retryRuleWithContent.", "author": "haithamgabr", "createdAt": "2020-11-13T04:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MzE3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjY3MjM3OA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522672378", "bodyText": "Ah, I missed that. \ud83d\ude05", "author": "minwoox", "createdAt": "2020-11-13T06:03:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MzE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MzQ0Mg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522573442", "body": "How about just adding `assert retryRuleWithContent != null` and remove if condition?", "bodyText": "How about just adding assert retryRuleWithContent != null and remove if condition?", "bodyHTML": "<p dir=\"auto\">How about just adding <code>assert retryRuleWithContent != null</code> and remove if condition?</p>", "author": "minwoox", "createdAt": "2020-11-13T02:33:39Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigBuilder.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.MoreObjects.ToStringHelper;\n+\n+import com.linecorp.armeria.common.Flags;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Builds a {@link RetryConfig}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, maxTotalAttempts,\n+ * and responseTimeoutMillisForEachAttempt.\n+ */\n+public final class RetryConfigBuilder<T extends Response> {\n+    private int maxTotalAttempts = Flags.defaultMaxTotalAttempts();\n+    private long responseTimeoutMillisForEachAttempt = Flags.defaultResponseTimeoutMillis();\n+    private int maxContentLength;\n+\n+    @Nullable\n+    private final RetryRule retryRule;\n+\n+    @Nullable\n+    private final RetryRuleWithContent<T> retryRuleWithContent;\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRule}.\n+     */\n+    RetryConfigBuilder(RetryRule retryRule) {\n+        this.retryRule = requireNonNull(retryRule, \"retryRule\");\n+        retryRuleWithContent = null;\n+        maxContentLength = 0;\n+    }\n+\n+    /**\n+     * Returns a {@link RetryConfigBuilder} with this {@link RetryRuleWithContent}.\n+     */\n+    RetryConfigBuilder(RetryRuleWithContent<T> retryRuleWithContent) {\n+        retryRule = null;\n+        this.retryRuleWithContent = requireNonNull(retryRuleWithContent, \"retryRuleWithContent\");\n+        maxContentLength = Integer.MAX_VALUE;\n+    }\n+\n+    /**\n+     * Sets the maxContentLength to be used with a {@link RetryRuleWithContent}.\n+     */\n+    public RetryConfigBuilder<T> maxContentLength(int maxContentLength) {\n+        checkArgument(maxContentLength > 0,\n+                      \"maxContentLength: %s (expected: > 0)\", maxContentLength);\n+        this.maxContentLength = maxContentLength;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets maxTotalAttempts.\n+     */\n+    public RetryConfigBuilder<T> maxTotalAttempts(int maxTotalAttempts) {\n+        checkArgument(\n+                maxTotalAttempts > 0,\n+                \"maxTotalAttempts: %s (expected: > 0)\",\n+                maxTotalAttempts);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets responseTimeoutMillisForEachAttempt.\n+     */\n+    public RetryConfigBuilder<T> responseTimeoutMillisForEachAttempt(long responseTimeoutMillisForEachAttempt) {\n+        checkArgument(\n+                responseTimeoutMillisForEachAttempt >= 0,\n+                \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n+                responseTimeoutMillisForEachAttempt);\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets responseTimeoutMillisForEachAttempt by converting responseTimeoutForEachAttempt to millis.\n+     */\n+    public RetryConfigBuilder<T> responseTimeoutForEachAttempt(Duration responseTimeoutMillisForEachAttempt) {\n+        final long millis =\n+                requireNonNull(responseTimeoutMillisForEachAttempt, \"responseTimeoutMillisForEachAttempt\")\n+                        .toMillis();\n+        checkArgument(\n+                millis >= 0,\n+                \"responseTimeoutForEachAttempt.toMillis(): %s (expected: >= 0)\",\n+                millis);\n+        this.responseTimeoutMillisForEachAttempt = millis;\n+        return this;\n+    }\n+\n+    /**\n+     * Builds a {@link RetryConfig} from this builder's values and returns it.\n+     */\n+    public RetryConfig<T> build() {\n+        if (retryRule != null) {\n+            return new RetryConfig<>(retryRule, maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        }\n+        if (retryRuleWithContent != null) {", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTQ4Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611487", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MzQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MzU1Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522573557", "body": "nit: tha -> the", "bodyText": "nit: tha -> the", "bodyHTML": "<p dir=\"auto\">nit: tha -&gt; the</p>", "author": "minwoox", "createdAt": "2020-11-13T02:34:08Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigMapping.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import java.util.function.BiFunction;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Returns a {@link RetryConfig} given the request context.\n+ */\n+@FunctionalInterface\n+public interface RetryConfigMapping<T extends Response> {\n+    /**\n+     * Creates a {@link KeyedRetryConfigMapping} that maps keys created by keyFactory to  {@link RetryConfig}s\n+     * created by retryConfigFactory.\n+     */\n+    static <T extends Response> RetryConfigMapping<T> of(\n+            BiFunction<? super ClientRequestContext, Request, String> keyFactory,\n+            BiFunction<? super ClientRequestContext, Request, RetryConfig<T>> retryConfigFactory) {\n+        return new KeyedRetryConfigMapping<>(keyFactory, retryConfigFactory);\n+    }\n+\n+    /**\n+     * Returns tha {@link RetryConfig} that maps to the given context/request.", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTU4NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611584", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3MzU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3NDE4Mg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522574182", "body": "`@deprecated Use {@link #newDecorator(RetryConfig)}.`", "bodyText": "@deprecated Use {@link #newDecorator(RetryConfig)}.", "bodyHTML": "<p dir=\"auto\"><code>@deprecated Use {@link #newDecorator(RetryConfig)}.</code></p>", "author": "minwoox", "createdAt": "2020-11-13T02:36:19Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -112,7 +131,10 @@ public static RetryingClientBuilder builder(RetryRuleWithContent<HttpResponse> r\n      *\n      * @param retryRule the retry rule\n      * @param maxTotalAttempts the maximum allowed number of total attempts\n+     *\n+     * @deprecated Use newDecorator(RetryConfig) instead.", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTY0Ng==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611646", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3NDE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3NTM4OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522575389", "body": "ditto", "bodyText": "ditto", "bodyHTML": "<p dir=\"auto\">ditto</p>", "author": "minwoox", "createdAt": "2020-11-13T02:40:46Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingRpcClient.java", "diffHunk": "@@ -51,7 +51,10 @@\n      *\n      * @param retryRuleWithContent the retry rule\n      * @param maxTotalAttempts the maximum number of total attempts\n+     *\n+     * @deprecated Use newDecorator(RetryConfig) instead.", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTcxMg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611712", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3NTM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3NTgxMg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522575812", "body": "Should we leave a warning log if this is not `true`?", "bodyText": "Should we leave a warning log if this is not true?", "bodyHTML": "<p dir=\"auto\">Should we leave a warning log if this is not <code>true</code>?</p>", "author": "minwoox", "createdAt": "2020-11-13T02:42:27Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingRpcClient.java", "diffHunk": "@@ -124,9 +167,13 @@ private void doExecute0(ClientRequestContext ctx, RpcRequest req,\n         final RpcResponse res = executeWithFallback(unwrap(), derivedCtx,\n                                                     (context, cause) -> RpcResponse.ofFailure(cause));\n \n+        final RetryConfig<RpcResponse> retryConfig = mapping().get(ctx, req);\n+        final RetryRuleWithContent<RpcResponse> retryRule =\n+                retryConfig.needsContentInRule() ?", "originalCommit": "44d952ff1eba0879bb966991990adc6077baf07f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjYxMTc3NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522611774", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T04:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU3NTgxMg=="}], "type": "inlineReview"}, {"oid": "948e99c513d6170bb3f59ac980860a27b0dc230b", "url": "https://github.com/line/armeria/commit/948e99c513d6170bb3f59ac980860a27b0dc230b", "message": "Minor adjustments, addressing comments", "committedDate": "2020-11-13T04:22:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc5NDM4Ng==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522794386", "body": "Could remove `public`? I think the method is an internal implementation.", "bodyText": "Could remove public? I think the method is an internal implementation.", "bodyHTML": "<p dir=\"auto\">Could remove <code>public</code>? I think the method is an internal implementation.</p>", "author": "ikhoon", "createdAt": "2020-11-13T08:31:30Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRule}.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@link RetryRuleWithContent} with unlimited content length.\n+     */\n+    public static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    @Nullable\n+    private final RetryRule retryRule;\n+\n+    @Nullable\n+    private final RetryRuleWithContent<T> retryRuleWithContent;\n+\n+    @Nullable\n+    private final RetryRule fromRetryRuleWithContent;\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = requireNonNull(retryRule, \"retryRule\");\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = false;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.maxContentLength = maxContentLength;\n+        this.retryRuleWithContent = requireNonNull(retryRuleWithContent, \"retryRuleWithContent\");\n+        fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = true;\n+        retryRule = null;\n+    }\n+\n+    private static void checkArguments(int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArgument(\n+                maxTotalAttempts > 0,\n+                \"maxTotalAttempts: %s (expected: > 0)\",\n+                maxTotalAttempts);\n+        checkArgument(\n+                responseTimeoutMillisForEachAttempt >= 0,\n+                \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n+                responseTimeoutMillisForEachAttempt);\n+    }\n+\n+    /**\n+     * Converts this {@link RetryConfig} to a mutable {@link RetryConfigBuilder}.\n+     */\n+    public RetryConfigBuilder<T> toBuilder() {\n+        final RetryConfigBuilder<T> builder =\n+                needsContentInRule ?\n+                builder(retryRuleWithContent).maxContentLength(maxContentLength) : builder(retryRule);\n+        return builder\n+                .maxTotalAttempts(maxTotalAttempts)\n+                .responseTimeoutMillisForEachAttempt(responseTimeoutMillisForEachAttempt);\n+    }\n+\n+    /**\n+     * Returns the maximum allowed number of total attempts made by a {@link RetryingClient}.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns the response timeout for each attempt in milliseconds.\n+     * When requests in {@link RetryingClient} are made,\n+     * corresponding responses are timed out by this value.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRule} used by {@link RetryingClient} using this config, could be null.\n+     */\n+    @Nullable\n+    public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRuleWithContent} used by {@link RetryingClient} using this config, could be null.\n+     */\n+    @Nullable\n+    public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRuleWithContent} converted from the {@link RetryRule} of this config,\n+     * could be null.\n+     */\n+    @Nullable\n+    public RetryRule fromRetryRuleWithContent() {\n+        return fromRetryRuleWithContent;\n+    }", "originalCommit": "948e99c513d6170bb3f59ac980860a27b0dc230b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEzMjA0MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r523132041", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-13T18:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjc5NDM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMDgwMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r522820803", "body": "This API is flexible but not user-friendly a bit. How about providing `RetryConfigMappingBuilder` for building `RetryConfigMapping` fluently. \r\nFor example:\r\n```java\r\nRetryConfigMapping.builder()\r\n                  .host(\"foo.com\", retryConfigForFoo)\r\n                  .path(\"/my/path1\", retryConfigForPath1)\r\n                  .path(\"/my/path2\", retryConfigForPath2)\r\n                  .mapping((ctx, req) =>{\r\n                      if(req.headers().get(\"SOME_HEADER\").equals(\"SOME_VALUE\")) {\r\n                          return someRetryConfigForFoo;\r\n                      }\r\n                      return null;\r\n                   })\r\n                   .build(fallbackRetryConfig);\r\n```\r\n\r\nI don't think we need to cache `RetryConfig` by mapping the key. `RetryConfig` does not require to manage its status like a circuit breaker. Let users decide whether to reuse it or create a new one if they want to dynamically change the retry configuration.\r\n\r\nWhat do you think? @haithamgabr ", "bodyText": "This API is flexible but not user-friendly a bit. How about providing RetryConfigMappingBuilder for building RetryConfigMapping fluently.\nFor example:\nRetryConfigMapping.builder()\n                  .host(\"foo.com\", retryConfigForFoo)\n                  .path(\"/my/path1\", retryConfigForPath1)\n                  .path(\"/my/path2\", retryConfigForPath2)\n                  .mapping((ctx, req) =>{\n                      if(req.headers().get(\"SOME_HEADER\").equals(\"SOME_VALUE\")) {\n                          return someRetryConfigForFoo;\n                      }\n                      return null;\n                   })\n                   .build(fallbackRetryConfig);\nI don't think we need to cache RetryConfig by mapping the key. RetryConfig does not require to manage its status like a circuit breaker. Let users decide whether to reuse it or create a new one if they want to dynamically change the retry configuration.\nWhat do you think? @haithamgabr", "bodyHTML": "<p dir=\"auto\">This API is flexible but not user-friendly a bit. How about providing <code>RetryConfigMappingBuilder</code> for building <code>RetryConfigMapping</code> fluently.<br>\nFor example:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"RetryConfigMapping.builder()\n                  .host(&quot;foo.com&quot;, retryConfigForFoo)\n                  .path(&quot;/my/path1&quot;, retryConfigForPath1)\n                  .path(&quot;/my/path2&quot;, retryConfigForPath2)\n                  .mapping((ctx, req) =&gt;{\n                      if(req.headers().get(&quot;SOME_HEADER&quot;).equals(&quot;SOME_VALUE&quot;)) {\n                          return someRetryConfigForFoo;\n                      }\n                      return null;\n                   })\n                   .build(fallbackRetryConfig);\"><pre><span class=\"pl-smi\">RetryConfigMapping</span><span class=\"pl-k\">.</span>builder()\n                  .host(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>foo.com<span class=\"pl-pds\">\"</span></span>, retryConfigForFoo)\n                  .path(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/my/path1<span class=\"pl-pds\">\"</span></span>, retryConfigForPath1)\n                  .path(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/my/path2<span class=\"pl-pds\">\"</span></span>, retryConfigForPath2)\n                  .mapping((ctx, req) <span class=\"pl-k\">=</span><span class=\"pl-k\">&gt;</span>{\n                      <span class=\"pl-k\">if</span>(req<span class=\"pl-k\">.</span>headers()<span class=\"pl-k\">.</span>get(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>SOME_HEADER<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>equals(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>SOME_VALUE<span class=\"pl-pds\">\"</span></span>)) {\n                          <span class=\"pl-k\">return</span> someRetryConfigForFoo;\n                      }\n                      <span class=\"pl-k\">return</span> <span class=\"pl-c1\">null</span>;\n                   })\n                   .build(fallbackRetryConfig);</pre></div>\n<p dir=\"auto\">I don't think we need to cache <code>RetryConfig</code> by mapping the key. <code>RetryConfig</code> does not require to manage its status like a circuit breaker. Let users decide whether to reuse it or create a new one if they want to dynamically change the retry configuration.</p>\n<p dir=\"auto\">What do you think? <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/haithamgabr/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/haithamgabr\">@haithamgabr</a></p>", "author": "ikhoon", "createdAt": "2020-11-13T09:14:13Z", "path": "core/src/test/java/com/linecorp/armeria/client/circuitbreaker/KeyedRetryConfigMappingTest.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.circuitbreaker;\n+\n+import static java.util.concurrent.CompletableFuture.completedFuture;\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.util.function.BiFunction;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.retry.RetryConfig;\n+import com.linecorp.armeria.client.retry.RetryConfigMapping;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryRuleWithContent;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+class KeyedRetryConfigMappingTest {\n+\n+    @Test\n+    void mapsCorrectly() throws Exception {\n+        final BiFunction<ClientRequestContext, Request, String> keyFactory =\n+                (ctx, req) -> ctx.endpoint().host() + '#' + ctx.path();\n+        final BiFunction<ClientRequestContext, Request, RetryConfig<RpcResponse>> configFactory =\n+                (ctx, req) -> {\n+            if (ctx.endpoint().host().equals(\"host1\")) {\n+                return RetryConfig.<RpcResponse>builder(RetryRule.onException())\n+                                  .maxTotalAttempts(1).responseTimeoutMillisForEachAttempt(1000).build();\n+            } else if (ctx.endpoint().host().equals(\"host2\")) {\n+                if (ctx.path().equals(\"/path2\")) {\n+                    return RetryConfig.<RpcResponse>builder(\n+                            RetryRuleWithContent.onResponse((c, r) -> completedFuture(true)))\n+                            .maxTotalAttempts(2).responseTimeoutMillisForEachAttempt(2000).build();\n+                } else {\n+                    return RetryConfig.<RpcResponse>builder(RetryRule.onException())\n+                                      .maxTotalAttempts(3).responseTimeoutMillisForEachAttempt(3000).build();\n+                }\n+            } else {\n+                return RetryConfig.<RpcResponse>builder(\n+                        RetryRuleWithContent.onResponse((c, r) -> completedFuture(false)))\n+                        .maxTotalAttempts(4).responseTimeoutMillisForEachAttempt(4000).build();\n+            }\n+        };", "originalCommit": "948e99c513d6170bb3f59ac980860a27b0dc230b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzE0MDM0OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r523140349", "bodyText": "I completely understand your concern. However, I spent a lot of time thinking about it from a user perspective, and I really think the current API is the best middle ground between flexibility and user-friendliness. The problem with an API like the one you suggested is that it will become super-confusing when multiple elements apply, like which config will be picked if the uri is foo.com/my/path1? both retryConfigForFoo and retryConfigForPath1 are eligible now. I really think going into this level of detailing will make for a very confusing API. I expanded the javadocs on RetryConfigMapping a lot to make it more detailed and provided an example. Notice that the example in this test case looks complicated because it's deliberately complicated (for rigorous testing). For the majority of users it will be much simpler, probably based only on one ctx element, but still users with more complicated needs have a way of filling them.\nRegarding RetryConfig caching, I think it's important to cache because RetryConfig is actually stateful. The mapping is used between retries to obtain the retry rule from the config (RetryingClient lines 287 & 341). The retry rule holds a Backoff object which is stateful; returning a new backoff each retry will break the expected behavior as the docs warn:\nhttps://armeria.dev/docs/client-retry#retryrule", "author": "haithamgabr", "createdAt": "2020-11-13T18:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAxOTg5OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r524019899", "bodyText": "I tend to agree with @haithamgabr. One nit from myself is we could introduce a method like builderForRpc() and get rid of the type parameter in the call site.", "author": "trustin", "createdAt": "2020-11-16T09:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4NTMwNA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r524785304", "bodyText": "I made the parameterized builder() methods package private (to be used in other parameterized classes like AbstractRetryingCLientBuilder) and added public builderForRpc() and builderForHttp()", "author": "haithamgabr", "createdAt": "2020-11-17T00:05:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkwMzgxMg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r524903812", "bodyText": "I spent a lot of time thinking about it from a user perspective, and I really think the current API is the best middle ground between flexibility and user-friendliness.\n\nI agree your opion and thoughts. \ud83d\udc4d Let's keep the current API design.\n\nThe retry rule holds a Backoff object which is stateful.\n\nJFYI, Backoff can be stateful. However, the default Backoffs offered by Armeria are not stateful. \ud83d\ude09 RetryClient saves the STATE to the attribute of a ClientRequestContext.", "author": "ikhoon", "createdAt": "2020-11-17T06:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgyMDgwMw=="}], "type": "inlineReview"}, {"oid": "f26b863955d83b01ce8773209a64c4822b4731df", "url": "https://github.com/line/armeria/commit/f26b863955d83b01ce8773209a64c4822b4731df", "message": "Expanding RetryConfigMapping docs", "committedDate": "2020-11-13T18:05:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAxMjc1Mw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r524012753", "body": "Missing `final`", "bodyText": "Missing final", "bodyHTML": "<p dir=\"auto\">Missing <code>final</code></p>", "author": "trustin", "createdAt": "2020-11-16T09:20:59Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -69,69 +68,37 @@\n     private static final AttributeKey<State> STATE =\n             AttributeKey.valueOf(AbstractRetryingClient.class, \"STATE\");\n \n-    @Nullable\n-    private final RetryRule retryRule;\n-\n-    @Nullable\n-    private final RetryRule fromRetryRuleWithContent;\n-\n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private final int maxTotalAttempts;\n-    private final long responseTimeoutMillisForEachAttempt;\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    AbstractRetryingClient(Client<I, O> delegate, RetryRule retryRule,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, requireNonNull(retryRule, \"retryRule\"), null,\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n+    private final RetryConfigMapping<O> mapping;\n+    private final RetryConfig retryConfig;\n \n     /**\n      * Creates a new instance that decorates the specified {@link Client}.\n      */\n-    AbstractRetryingClient(Client<I, O> delegate,\n-                           RetryRuleWithContent<O> retryRuleWithContent,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"),\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    private AbstractRetryingClient(Client<I, O> delegate, @Nullable RetryRule retryRule,\n-                                   @Nullable RetryRuleWithContent<O> retryRuleWithContent,\n-                                   int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+    AbstractRetryingClient(\n+            Client<I, O> delegate, RetryConfigMapping<O> mapping, @Nullable RetryConfig<O> retryConfig) {\n         super(delegate);\n-        this.retryRule = retryRule;\n-        this.retryRuleWithContent = retryRuleWithContent;\n-        if (retryRuleWithContent != null) {\n-            fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n-        } else {\n-            fromRetryRuleWithContent = null;\n-        }\n-\n-        checkArgument(maxTotalAttempts > 0, \"maxTotalAttempts: %s (expected: > 0)\", maxTotalAttempts);\n-        this.maxTotalAttempts = maxTotalAttempts;\n-\n-        checkArgument(responseTimeoutMillisForEachAttempt >= 0,\n-                      \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n-                      responseTimeoutMillisForEachAttempt);\n-        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        this.mapping = requireNonNull(mapping, \"mapping\");\n+        this.retryConfig = retryConfig;\n     }\n \n     @Override\n     public final O execute(ClientRequestContext ctx, I req) throws Exception {\n-        final State state =\n-                new State(maxTotalAttempts, responseTimeoutMillisForEachAttempt, ctx.responseTimeoutMillis());\n+        final RetryConfig<O> config = mapping.get(ctx, req);\n+        final State state = new State(\n+                config.maxTotalAttempts(),\n+                config.responseTimeoutMillisForEachAttempt(),\n+                ctx.responseTimeoutMillis());\n         ctx.setAttr(STATE, state);\n         return doExecute(ctx, req);\n     }\n \n+    /**\n+     * Returns the current {@link RetryConfigMapping} set for this client.\n+     */\n+    protected RetryConfigMapping<O> mapping() {", "originalCommit": "f26b863955d83b01ce8773209a64c4822b4731df", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4MzkyNQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r524783925", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-17T00:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAxMjc1Mw=="}], "type": "inlineReview"}, {"oid": "59c8e5df4dc5b2df779620d10666114914fbab92", "url": "https://github.com/line/armeria/commit/59c8e5df4dc5b2df779620d10666114914fbab92", "message": "De-parameterizing RetryConfig.builder()", "committedDate": "2020-11-17T00:03:41Z", "type": "commit"}, {"oid": "10504f64bfac6d6a02db53e7c4e6900559e3ae9f", "url": "https://github.com/line/armeria/commit/10504f64bfac6d6a02db53e7c4e6900559e3ae9f", "message": "fixing unit tests", "committedDate": "2020-11-17T01:49:47Z", "type": "commit"}, {"oid": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "url": "https://github.com/line/armeria/commit/0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "message": "fixing unit tests", "committedDate": "2020-11-17T01:52:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkxMjE5MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r524912191", "body": "We usually don't mention `http` in HTTP methods. How about renaming `builderForHttp` to `builder` and renaming the package-local `builder` to something like `builder0`? Could we also move `builderForHttp` before `builderForRpc`? I guess people will look for non-RPC retry handlers first.", "bodyText": "We usually don't mention http in HTTP methods. How about renaming builderForHttp to builder and renaming the package-local builder to something like builder0? Could we also move builderForHttp before builderForRpc? I guess people will look for non-RPC retry handlers first.", "bodyHTML": "<p dir=\"auto\">We usually don't mention <code>http</code> in HTTP methods. How about renaming <code>builderForHttp</code> to <code>builder</code> and renaming the package-local <code>builder</code> to something like <code>builder0</code>? Could we also move <code>builderForHttp</code> before <code>builderForRpc</code>? I guess people will look for non-RPC retry handlers first.</p>", "author": "trustin", "createdAt": "2020-11-17T06:31:56Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<RpcResponse>}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(\n+            RetryRuleWithContent<RpcResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<HttpResponse>}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(\n+            RetryRuleWithContent<HttpResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(RetryRule retryRule) {", "originalCommit": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwODM2NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525608364", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T00:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkxMjE5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2NDUzMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525264530", "body": "Add `@Nullable`?", "bodyText": "Add @Nullable?", "bodyHTML": "<p dir=\"auto\">Add <code>@Nullable</code>?</p>", "author": "ikhoon", "createdAt": "2020-11-17T15:43:42Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -69,69 +68,37 @@\n     private static final AttributeKey<State> STATE =\n             AttributeKey.valueOf(AbstractRetryingClient.class, \"STATE\");\n \n-    @Nullable\n-    private final RetryRule retryRule;\n-\n-    @Nullable\n-    private final RetryRule fromRetryRuleWithContent;\n-\n-    @Nullable\n-    private final RetryRuleWithContent<O> retryRuleWithContent;\n-\n-    private final int maxTotalAttempts;\n-    private final long responseTimeoutMillisForEachAttempt;\n-\n-    /**\n-     * Creates a new instance that decorates the specified {@link Client}.\n-     */\n-    AbstractRetryingClient(Client<I, O> delegate, RetryRule retryRule,\n-                           int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n-        this(delegate, requireNonNull(retryRule, \"retryRule\"), null,\n-             maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n-    }\n+    private final RetryConfigMapping<O> mapping;\n+    private final RetryConfig retryConfig;", "originalCommit": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwODUzOA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525608538", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T00:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI2NDUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Njg1OA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525276858", "body": "How about removing `needsContentInRule` and checking by `retryRuleWithContent !=  null` for simplicity.", "bodyText": "How about removing needsContentInRule and checking by retryRuleWithContent !=  null for simplicity.", "bodyHTML": "<p dir=\"auto\">How about removing <code>needsContentInRule</code> and checking by <code>retryRuleWithContent !=  null</code> for simplicity.</p>", "author": "ikhoon", "createdAt": "2020-11-17T15:58:42Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<RpcResponse>}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(\n+            RetryRuleWithContent<RpcResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<HttpResponse>}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(\n+            RetryRuleWithContent<HttpResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;", "originalCommit": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwODU5Mg==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525608592", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T00:09:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3Njg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3ODE5OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525278199", "body": "Could be `retryRuleWithContent != null`?", "bodyText": "Could be retryRuleWithContent != null?", "bodyHTML": "<p dir=\"auto\">Could be <code>retryRuleWithContent != null</code>?</p>", "author": "ikhoon", "createdAt": "2020-11-17T16:00:14Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<RpcResponse>}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(\n+            RetryRuleWithContent<RpcResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<HttpResponse>}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(\n+            RetryRuleWithContent<HttpResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    @Nullable\n+    private final RetryRule retryRule;\n+\n+    @Nullable\n+    private final RetryRuleWithContent<T> retryRuleWithContent;\n+\n+    @Nullable\n+    private final RetryRule fromRetryRuleWithContent;\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = requireNonNull(retryRule, \"retryRule\");\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = false;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.maxContentLength = maxContentLength;\n+        this.retryRuleWithContent = requireNonNull(retryRuleWithContent, \"retryRuleWithContent\");\n+        fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = true;\n+        retryRule = null;\n+    }\n+\n+    private static void checkArguments(int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArgument(\n+                maxTotalAttempts > 0,\n+                \"maxTotalAttempts: %s (expected: > 0)\",\n+                maxTotalAttempts);\n+        checkArgument(\n+                responseTimeoutMillisForEachAttempt >= 0,\n+                \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n+                responseTimeoutMillisForEachAttempt);\n+    }\n+\n+    /**\n+     * Converts this {@link RetryConfig} to a mutable {@link RetryConfigBuilder}.\n+     */\n+    public RetryConfigBuilder<T> toBuilder() {\n+        final RetryConfigBuilder<T> builder =\n+                needsContentInRule ?\n+                builder(retryRuleWithContent).maxContentLength(maxContentLength) : builder(retryRule);\n+        return builder\n+                .maxTotalAttempts(maxTotalAttempts)\n+                .responseTimeoutMillisForEachAttempt(responseTimeoutMillisForEachAttempt);\n+    }\n+\n+    /**\n+     * Returns the maximum allowed number of total attempts made by a {@link RetryingClient}.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns the response timeout for each attempt in milliseconds.\n+     * When requests in {@link RetryingClient} are made,\n+     * corresponding responses are timed out by this value.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRule} used by {@link RetryingClient} using this config, could be null.\n+     */\n+    @Nullable\n+    public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRuleWithContent} used by {@link RetryingClient} using this config, could be null.\n+     */\n+    @Nullable\n+    public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's {@code maxContentLength}, which is non-zero only if\n+     * a {@link RetryRuleWithContent} is used.\n+     */\n+    public int maxContentLength() {\n+        return maxContentLength;\n+    }\n+\n+    /**\n+     * Returns whether a {@link RetryRuleWithContent} is being used.\n+     */\n+    public boolean needsContentInRule() {\n+        return needsContentInRule;", "originalCommit": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwODY1OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525608659", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T00:10:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI3ODE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4MTUxMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525281513", "body": "```suggestion\r\n     * Creates a {@link RetryConfigMapping} that maps keys created by {@code keyFactory} to\r\n```\r\nBecause `KeyedRetryConfigMapping` is an internal class that is not exposed by Javadoc.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Creates a {@link KeyedRetryConfigMapping} that maps keys created by {@code keyFactory} to\n          \n          \n            \n                 * Creates a {@link RetryConfigMapping} that maps keys created by {@code keyFactory} to\n          \n      \n    \n    \n  \n\nBecause KeyedRetryConfigMapping is an internal class that is not exposed by Javadoc.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Creates</span> a {<span class=\"pl-k\">@link</span> <span class=\"pl-smi x x-first x-last\">KeyedRetryConfigMapping</span>} that maps keys created by {<span class=\"pl-k\">@code</span> keyFactory} to</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Creates</span> a {<span class=\"pl-k\">@link</span> <span class=\"pl-smi x x-first x-last\">RetryConfigMapping</span>} that maps keys created by {<span class=\"pl-k\">@code</span> keyFactory} to</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Because <code>KeyedRetryConfigMapping</code> is an internal class that is not exposed by Javadoc.</p>", "author": "ikhoon", "createdAt": "2020-11-17T16:04:31Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfigMapping.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import java.util.function.BiFunction;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+\n+/**\n+ * Returns a {@link RetryConfig} given the request context.\n+ * Allows users to change retry behavior according to any context element, like host, method, path ...etc.\n+ */\n+@FunctionalInterface\n+public interface RetryConfigMapping<T extends Response> {\n+    /**\n+     * Creates a {@link KeyedRetryConfigMapping} that maps keys created by {@code keyFactory} to", "originalCommit": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwODY5NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525608694", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T00:10:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI4MTUxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NDQ5OQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525294499", "body": "I think we don't need to keep `fromRetryRuleWithContent` as a member field. How about removing `fromRetryRuleWithContent` and making `retryRule` not null always? i.e.,\r\n```java\r\nretryRule = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\r\n```\r\n", "bodyText": "I think we don't need to keep fromRetryRuleWithContent as a member field. How about removing fromRetryRuleWithContent and making retryRule not null always? i.e.,\nretryRule = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);", "bodyHTML": "<p dir=\"auto\">I think we don't need to keep <code>fromRetryRuleWithContent</code> as a member field. How about removing <code>fromRetryRuleWithContent</code> and making <code>retryRule</code> not null always? i.e.,</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"retryRule = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n\"><pre>retryRule <span class=\"pl-k\">=</span> <span class=\"pl-smi\">RetryRuleUtil</span><span class=\"pl-k\">.</span>fromRetryRuleWithContent(retryRuleWithContent);</pre></div>", "author": "ikhoon", "createdAt": "2020-11-17T16:21:08Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<RpcResponse>}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(\n+            RetryRuleWithContent<RpcResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<HttpResponse>}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(\n+            RetryRuleWithContent<HttpResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builderForHttp(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    private final int maxContentLength;\n+    private final boolean needsContentInRule;\n+\n+    @Nullable\n+    private final RetryRule retryRule;\n+\n+    @Nullable\n+    private final RetryRuleWithContent<T> retryRuleWithContent;\n+\n+    @Nullable\n+    private final RetryRule fromRetryRuleWithContent;\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = requireNonNull(retryRule, \"retryRule\");\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        needsContentInRule = false;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.maxContentLength = maxContentLength;\n+        this.retryRuleWithContent = requireNonNull(retryRuleWithContent, \"retryRuleWithContent\");\n+        fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);", "originalCommit": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYxMDExMw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525610113", "bodyText": "I agree this would be simpler. The problem is, while fromRetryRuleWithContent() is internal, retryRule() is a public method, and it is very confusing for it to not return null when a retryRule is not set. So I think we can pay the price of slightly more complex internal implementation for the sake of a clearer API.", "author": "haithamgabr", "createdAt": "2020-11-18T00:14:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NDQ5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY0NTc0MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525645741", "bodyText": "Yeah. That is a good point. Let's keep the current API", "author": "ikhoon", "createdAt": "2020-11-18T02:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTI5NDQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMwOTI4MQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525309281", "body": "In my opinion\r\n* It would be noisy to leave a warn message every time.\r\n* It is not efficient to convert `RetryRule` to `RetryRuleWithContent` everytime.\r\n\r\nHow about adding a package-private method to `RetryConfig` such as \r\n```java\r\nclass RetryConfig {\r\n\tRetryRuleWithContent<T> fromRetryRule() {\r\n\t    if (fromRetryRule == null) {\r\n\t      logger.warn(\"...\")\r\n\t      fromRetryRule = RetryRuleUtil.fromRetryRule(retryConfig.retryRule());\r\n\t    }\r\n\t    return fromRetryRule;\r\n\t}\r\n}\r\n```", "bodyText": "In my opinion\n\nIt would be noisy to leave a warn message every time.\nIt is not efficient to convert RetryRule to RetryRuleWithContent everytime.\n\nHow about adding a package-private method to RetryConfig such as\nclass RetryConfig {\n\tRetryRuleWithContent<T> fromRetryRule() {\n\t    if (fromRetryRule == null) {\n\t      logger.warn(\"...\")\n\t      fromRetryRule = RetryRuleUtil.fromRetryRule(retryConfig.retryRule());\n\t    }\n\t    return fromRetryRule;\n\t}\n}", "bodyHTML": "<p dir=\"auto\">In my opinion</p>\n<ul dir=\"auto\">\n<li>It would be noisy to leave a warn message every time.</li>\n<li>It is not efficient to convert <code>RetryRule</code> to <code>RetryRuleWithContent</code> everytime.</li>\n</ul>\n<p dir=\"auto\">How about adding a package-private method to <code>RetryConfig</code> such as</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"class RetryConfig {\n\tRetryRuleWithContent&lt;T&gt; fromRetryRule() {\n\t    if (fromRetryRule == null) {\n\t      logger.warn(&quot;...&quot;)\n\t      fromRetryRule = RetryRuleUtil.fromRetryRule(retryConfig.retryRule());\n\t    }\n\t    return fromRetryRule;\n\t}\n}\"><pre><span class=\"pl-k\">class</span> <span class=\"pl-en\">RetryConfig</span> {\n\t<span class=\"pl-k\">RetryRuleWithContent&lt;<span class=\"pl-smi\">T</span>&gt;</span> <span class=\"pl-en\">fromRetryRule</span>() {\n\t    <span class=\"pl-k\">if</span> (fromRetryRule <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span>) {\n\t      logger<span class=\"pl-k\">.</span>warn(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>...<span class=\"pl-pds\">\"</span></span>)\n\t      fromRetryRule <span class=\"pl-k\">=</span> <span class=\"pl-smi\">RetryRuleUtil</span><span class=\"pl-k\">.</span>fromRetryRule(retryConfig<span class=\"pl-k\">.</span>retryRule());\n\t    }\n\t    <span class=\"pl-k\">return</span> fromRetryRule;\n\t}\n}</pre></div>", "author": "ikhoon", "createdAt": "2020-11-17T16:39:06Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingRpcClient.java", "diffHunk": "@@ -124,9 +172,16 @@ private void doExecute0(ClientRequestContext ctx, RpcRequest req,\n         final RpcResponse res = executeWithFallback(unwrap(), derivedCtx,\n                                                     (context, cause) -> RpcResponse.ofFailure(cause));\n \n+        final RetryConfig<RpcResponse> retryConfig = mapping().get(ctx, req);\n+        if (!retryConfig.needsContentInRule()) {\n+            logger.warn(\"RetryingRpcClient is being used with RetryRule (without content).\");\n+        }\n+        final RetryRuleWithContent<RpcResponse> retryRule =\n+                retryConfig.needsContentInRule() ?\n+                retryConfig.retryRuleWithContent() : RetryRuleUtil.fromRetryRule(retryConfig.retryRule());", "originalCommit": "0f5c83dce7129cca702626b0e3d7c30ba8f07c5c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYxMDQyOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525610429", "bodyText": "Good call! Done.", "author": "haithamgabr", "createdAt": "2020-11-18T00:15:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTMwOTI4MQ=="}], "type": "inlineReview"}, {"oid": "b3109b2f082ab7bded1467bdcd5763234b08aeeb", "url": "https://github.com/line/armeria/commit/b3109b2f082ab7bded1467bdcd5763234b08aeeb", "message": "Refactoring RetryConfig.fomRetryRule()", "committedDate": "2020-11-18T00:08:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjM0NA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525632344", "body": "nit: two spaces before instead", "bodyText": "nit: two spaces before instead", "bodyHTML": "<p dir=\"auto\">nit: two spaces before instead</p>", "author": "minwoox", "createdAt": "2020-11-18T01:19:26Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClientBuilder.java", "diffHunk": "@@ -104,30 +105,37 @@ final int maxTotalAttempts() {\n      * @return {@code this} to support method chaining.\n      *\n      * @see <a href=\"https://armeria.dev/docs/client-retry#per-attempt-timeout\">Per-attempt timeout</a>\n+     *\n+     * @deprecated Use {@link RetryConfigBuilder#responseTimeoutMillisForEachAttempt(long)}  instead.", "originalCommit": "b3109b2f082ab7bded1467bdcd5763234b08aeeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY4OTIwMA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525689200", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T02:55:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjM0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjkwOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525632909", "body": "nit: `{@link Flags}`\r\nOr I think we could just do:\r\n`Returns a new {@link RetryConfigBuilder} with the specified {@link RetryRule}.`", "bodyText": "nit: {@link Flags}\nOr I think we could just do:\nReturns a new {@link RetryConfigBuilder} with the specified {@link RetryRule}.", "bodyHTML": "<p dir=\"auto\">nit: <code>{@link Flags}</code><br>\nOr I think we could just do:<br>\n<code>Returns a new {@link RetryConfigBuilder} with the specified {@link RetryRule}.</code></p>", "author": "minwoox", "createdAt": "2020-11-18T01:21:00Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(RetryConfig.class);\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.", "originalCommit": "b3109b2f082ab7bded1467bdcd5763234b08aeeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY4OTEwNQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525689105", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T02:55:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzMjkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNjczNA==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525636734", "body": "How about making a private constructor and check it there?\r\n```java\r\nRetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\r\n    this(requireNonNull(retryRule, \"retryRule\"),\r\n         null, 0, maxTotalAttempts, responseTimeoutMillisForEachAttempt);\r\n}\r\n\r\nRetryConfig(RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength, int maxTotalAttempts,\r\n            long responseTimeoutMillisForEachAttempt) {\r\n    this(null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"), maxContentLength,\r\n         maxTotalAttempts, responseTimeoutMillisForEachAttempt);\r\n}\r\n\r\nprivate RetryConfig(@Nullable RetryRule retryRule, @Nullable RetryRuleWithContent<T> retryRuleWithContent,\r\n                    int maxContentLength, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\r\n    checkArgument(maxTotalAttempts > 0, \"maxTotalAttempts: %s (expected: > 0)\", maxTotalAttempts);\r\n    ...\r\n}\r\n```", "bodyText": "How about making a private constructor and check it there?\nRetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n    this(requireNonNull(retryRule, \"retryRule\"),\n         null, 0, maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n}\n\nRetryConfig(RetryRuleWithContent<T> retryRuleWithContent, int maxContentLength, int maxTotalAttempts,\n            long responseTimeoutMillisForEachAttempt) {\n    this(null, requireNonNull(retryRuleWithContent, \"retryRuleWithContent\"), maxContentLength,\n         maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n}\n\nprivate RetryConfig(@Nullable RetryRule retryRule, @Nullable RetryRuleWithContent<T> retryRuleWithContent,\n                    int maxContentLength, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n    checkArgument(maxTotalAttempts > 0, \"maxTotalAttempts: %s (expected: > 0)\", maxTotalAttempts);\n    ...\n}", "bodyHTML": "<p dir=\"auto\">How about making a private constructor and check it there?</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n    this(requireNonNull(retryRule, &quot;retryRule&quot;),\n         null, 0, maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n}\n\nRetryConfig(RetryRuleWithContent&lt;T&gt; retryRuleWithContent, int maxContentLength, int maxTotalAttempts,\n            long responseTimeoutMillisForEachAttempt) {\n    this(null, requireNonNull(retryRuleWithContent, &quot;retryRuleWithContent&quot;), maxContentLength,\n         maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n}\n\nprivate RetryConfig(@Nullable RetryRule retryRule, @Nullable RetryRuleWithContent&lt;T&gt; retryRuleWithContent,\n                    int maxContentLength, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n    checkArgument(maxTotalAttempts &gt; 0, &quot;maxTotalAttempts: %s (expected: &gt; 0)&quot;, maxTotalAttempts);\n    ...\n}\"><pre>RetryConfig(<span class=\"pl-smi\">RetryRule</span> retryRule, <span class=\"pl-k\">int</span> maxTotalAttempts, <span class=\"pl-k\">long</span> responseTimeoutMillisForEachAttempt) {\n    <span class=\"pl-c1\">this</span>(requireNonNull(retryRule, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>retryRule<span class=\"pl-pds\">\"</span></span>),\n         <span class=\"pl-c1\">null</span>, <span class=\"pl-c1\">0</span>, maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n}\n\nRetryConfig(<span class=\"pl-k\">RetryRuleWithContent&lt;<span class=\"pl-smi\">T</span>&gt;</span> retryRuleWithContent, <span class=\"pl-k\">int</span> maxContentLength, <span class=\"pl-k\">int</span> maxTotalAttempts,\n            <span class=\"pl-k\">long</span> responseTimeoutMillisForEachAttempt) {\n    <span class=\"pl-c1\">this</span>(<span class=\"pl-c1\">null</span>, requireNonNull(retryRuleWithContent, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>retryRuleWithContent<span class=\"pl-pds\">\"</span></span>), maxContentLength,\n         maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n}\n\n<span class=\"pl-k\">private</span> RetryConfig(<span class=\"pl-k\">@Nullable</span> <span class=\"pl-smi\">RetryRule</span> retryRule, <span class=\"pl-k\">@Nullable</span> <span class=\"pl-k\">RetryRuleWithContent&lt;<span class=\"pl-smi\">T</span>&gt;</span> retryRuleWithContent,\n                    <span class=\"pl-k\">int</span> maxContentLength, <span class=\"pl-k\">int</span> maxTotalAttempts, <span class=\"pl-k\">long</span> responseTimeoutMillisForEachAttempt) {\n    checkArgument(maxTotalAttempts <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>maxTotalAttempts: %s (expected: &gt; 0)<span class=\"pl-pds\">\"</span></span>, maxTotalAttempts);\n    <span class=\"pl-c1\">...</span>\n}</pre></div>", "author": "minwoox", "createdAt": "2020-11-18T01:32:46Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(RetryConfig.class);\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<HttpResponse>}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builder(\n+            RetryRuleWithContent<HttpResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<RpcResponse>}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(\n+            RetryRuleWithContent<RpcResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder0(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder0(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    private final int maxContentLength;\n+\n+    @Nullable\n+    private final RetryRule retryRule;\n+\n+    @Nullable\n+    private final RetryRuleWithContent<T> retryRuleWithContent;\n+\n+    @Nullable\n+    private final RetryRule fromRetryRuleWithContent;\n+\n+    @Nullable\n+    private RetryRuleWithContent<T> fromRetryRule;\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = requireNonNull(retryRule, \"retryRule\");\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);", "originalCommit": "b3109b2f082ab7bded1467bdcd5763234b08aeeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY4ODk3Nw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525688977", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T02:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNjczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNzMxOQ==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525637319", "body": "indentation?", "bodyText": "indentation?", "bodyHTML": "<p dir=\"auto\">indentation?</p>", "author": "minwoox", "createdAt": "2020-11-18T01:34:35Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryConfig.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.retry;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.RpcResponse;\n+\n+/**\n+ * Holds retry config used by a {@link RetryingClient}.\n+ * A {@link RetryConfig} instance encapsulates the used {@link RetryRule}, {@code maxTotalAttempts},\n+ * and {@code responseTimeoutMillisForEachAttempt}.\n+ */\n+public final class RetryConfig<T extends Response> {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(RetryConfig.class);\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builder(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<HttpResponse>}.\n+     */\n+    public static RetryConfigBuilder<HttpResponse> builder(\n+            RetryRuleWithContent<HttpResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRule}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    /**\n+     * Returns a new {@link RetryConfigBuilder} with the default values from Flags.\n+     * Uses a {@code RetryRuleWithContent<RpcResponse>}.\n+     */\n+    public static RetryConfigBuilder<RpcResponse> builderForRpc(\n+            RetryRuleWithContent<RpcResponse> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder0(RetryRule retryRule) {\n+        return new RetryConfigBuilder<>(retryRule);\n+    }\n+\n+    static <T extends Response> RetryConfigBuilder<T> builder0(\n+            RetryRuleWithContent<T> retryRuleWithContent) {\n+        return new RetryConfigBuilder<>(retryRuleWithContent);\n+    }\n+\n+    private final int maxTotalAttempts;\n+    private final long responseTimeoutMillisForEachAttempt;\n+    private final int maxContentLength;\n+\n+    @Nullable\n+    private final RetryRule retryRule;\n+\n+    @Nullable\n+    private final RetryRuleWithContent<T> retryRuleWithContent;\n+\n+    @Nullable\n+    private final RetryRule fromRetryRuleWithContent;\n+\n+    @Nullable\n+    private RetryRuleWithContent<T> fromRetryRule;\n+\n+    RetryConfig(RetryRule retryRule, int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.retryRule = requireNonNull(retryRule, \"retryRule\");\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        maxContentLength = 0;\n+        retryRuleWithContent = null;\n+        fromRetryRuleWithContent = null;\n+    }\n+\n+    RetryConfig(\n+            RetryRuleWithContent<T> retryRuleWithContent,\n+            int maxContentLength,\n+            int maxTotalAttempts,\n+            long responseTimeoutMillisForEachAttempt) {\n+        checkArguments(maxTotalAttempts, responseTimeoutMillisForEachAttempt);\n+        this.maxContentLength = maxContentLength;\n+        this.retryRuleWithContent = requireNonNull(retryRuleWithContent, \"retryRuleWithContent\");\n+        fromRetryRuleWithContent = RetryRuleUtil.fromRetryRuleWithContent(retryRuleWithContent);\n+        this.maxTotalAttempts = maxTotalAttempts;\n+        this.responseTimeoutMillisForEachAttempt = responseTimeoutMillisForEachAttempt;\n+        retryRule = null;\n+    }\n+\n+    private static void checkArguments(int maxTotalAttempts, long responseTimeoutMillisForEachAttempt) {\n+        checkArgument(\n+                maxTotalAttempts > 0,\n+                \"maxTotalAttempts: %s (expected: > 0)\",\n+                maxTotalAttempts);\n+        checkArgument(\n+                responseTimeoutMillisForEachAttempt >= 0,\n+                \"responseTimeoutMillisForEachAttempt: %s (expected: >= 0)\",\n+                responseTimeoutMillisForEachAttempt);\n+    }\n+\n+    /**\n+     * Converts this {@link RetryConfig} to a mutable {@link RetryConfigBuilder}.\n+     */\n+    public RetryConfigBuilder<T> toBuilder() {\n+        final RetryConfigBuilder<T> builder =\n+                retryRuleWithContent != null ?\n+                builder0(retryRuleWithContent).maxContentLength(maxContentLength) : builder0(retryRule);\n+        return builder\n+                .maxTotalAttempts(maxTotalAttempts)\n+                .responseTimeoutMillisForEachAttempt(responseTimeoutMillisForEachAttempt);\n+    }\n+\n+    /**\n+     * Returns the maximum allowed number of total attempts made by a {@link RetryingClient}.\n+     */\n+    public int maxTotalAttempts() {\n+        return maxTotalAttempts;\n+    }\n+\n+    /**\n+     * Returns the response timeout for each attempt in milliseconds.\n+     * When requests in {@link RetryingClient} are made,\n+     * corresponding responses are timed out by this value.\n+     */\n+    public long responseTimeoutMillisForEachAttempt() {\n+        return responseTimeoutMillisForEachAttempt;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRule} used by {@link RetryingClient} using this config, could be null.\n+     */\n+    @Nullable\n+    public RetryRule retryRule() {\n+        return retryRule;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRuleWithContent} used by {@link RetryingClient} using this config, could be null.\n+     */\n+    @Nullable\n+    public RetryRuleWithContent<T> retryRuleWithContent() {\n+        return retryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns config's {@code maxContentLength}, which is non-zero only if\n+     * a {@link RetryRuleWithContent} is used.\n+     */\n+    public int maxContentLength() {\n+        return maxContentLength;\n+    }\n+\n+    /**\n+     * Returns whether a {@link RetryRuleWithContent} is being used.\n+     */\n+    public boolean needsContentInRule() {\n+        return retryRuleWithContent != null;\n+    }\n+\n+    /**\n+     * Returns whether the associated {@link RetryRule} or {@link RetryRuleWithContent} requires\n+     * response trailers.\n+     */\n+    public boolean requiresResponseTrailers() {\n+        return needsContentInRule() ?\n+               retryRuleWithContent().requiresResponseTrailers() : retryRule().requiresResponseTrailers();\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRuleWithContent} converted from the {@link RetryRule} of this config.\n+     */\n+    RetryRule fromRetryRuleWithContent() {\n+        requireNonNull(retryRuleWithContent, \"retryRuleWithContent\");\n+        requireNonNull(fromRetryRuleWithContent, \"fromRetryRuleWithContent\");\n+        return fromRetryRuleWithContent;\n+    }\n+\n+    /**\n+     * Returns the {@link RetryRule} converted from the {@link RetryRuleWithContent} of this config.\n+     */\n+    RetryRuleWithContent<T> fromRetryRule() {\n+        requireNonNull(retryRule, \"retryRule\");\n+        if (fromRetryRule == null) {\n+            logger.warn(\"A RetryRuleWithContent is being generated from a RetryRule. \" +\n+                    \"You are probably using a RetryRule with a RetryingRpcClient. \" +", "originalCommit": "b3109b2f082ab7bded1467bdcd5763234b08aeeb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY4ODc0Mw==", "url": "https://github.com/line/armeria/pull/3145#discussion_r525688743", "bodyText": "Done", "author": "haithamgabr", "createdAt": "2020-11-18T02:55:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNzMxOQ=="}], "type": "inlineReview"}, {"oid": "5cdcd345179dcfcab334b0f77c5846fd2fc8681b", "url": "https://github.com/line/armeria/commit/5cdcd345179dcfcab334b0f77c5846fd2fc8681b", "message": "Minor refactorings", "committedDate": "2020-11-18T02:53:59Z", "type": "commit"}]}