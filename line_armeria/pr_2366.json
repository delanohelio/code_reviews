{"pr_number": 2366, "pr_title": "Warn when pushing a wrong context using ContextFuture", "pr_author": "minwoox", "pr_createdAt": "2020-01-03T09:50:20Z", "pr_url": "https://github.com/line/armeria/pull/2366", "timeline": [{"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a", "url": "https://github.com/line/armeria/commit/6c938d304f6db92b2d85712ecd61682ef3876e1a", "message": "Warn when pushing a wrong context using RequestContextAwareCompletableFuture\nMotivation:\nRelated #2173\n\nIn that case, which is trying to push a wrong context when the current thread had an unrelated context already, the `RequestContextAwareCompletableFuture` just swallows the exception and a user has no way what is going wrong.\n\nModification:\n- Leave a warning log every time a wrong context is pushed to let the user something is going wrong.\n\nResult:\n- You can now easily get noticed when pushing a wrong context.\n- Close #2173", "committedDate": "2020-01-03T09:49:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MzQ5NA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r362753494", "body": "This is not called because in `exceptionally`, pushing with a wrong context happens as well.\r\nI'm wondering we should mitigate this by not pushing the context in `exceptionally`. \ud83e\udd14 ", "bodyText": "This is not called because in exceptionally, pushing with a wrong context happens as well.\nI'm wondering we should mitigate this by not pushing the context in exceptionally. \ud83e\udd14", "bodyHTML": "<p dir=\"auto\">This is not called because in <code>exceptionally</code>, pushing with a wrong context happens as well.<br>\nI'm wondering we should mitigate this by not pushing the context in <code>exceptionally</code>. <g-emoji class=\"g-emoji\" alias=\"thinking\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f914.png\">\ud83e\udd14</g-emoji></p>", "author": "minwoox", "createdAt": "2020-01-03T09:52:47Z", "path": "core/src/test/java/com/linecorp/armeria/internal/ContextFutureCallbackArgumentsProvider.java", "diffHunk": "@@ -0,0 +1,263 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.BiConsumer;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.ArgumentsProvider;\n+\n+import com.google.common.util.concurrent.MoreExecutors;\n+\n+public class ContextFutureCallbackArgumentsProvider implements ArgumentsProvider {\n+\n+    @Override\n+    public Stream<? extends Arguments> provideArguments(ExtensionContext context) throws Exception {\n+        final Arguments thenApply = Arguments.of(\n+                (BiConsumer<CompletableFuture<?>, AtomicBoolean>) (future, called) -> {\n+                    future.thenApply(res -> {\n+                        called.set(true);\n+                        return null;\n+                    }).exceptionally(cause -> {\n+                        called.set(true);", "originalCommit": "6c938d304f6db92b2d85712ecd61682ef3876e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1ODA5MA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r362758090", "bodyText": "That's a good question. \ud83e\udd14\nIt is also possible that a user tries to handle an exception using handle or whenComplete, so I think it's not a good idea to handle exceptionally exceptionally. (pun intended \ud83d\ude06) i.e. I can't think of a good solution other than just logging.", "author": "trustin", "createdAt": "2020-01-03T10:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MzQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc2MTY3Ng==", "url": "https://github.com/line/armeria/pull/2366#discussion_r362761676", "bodyText": "\ud83d\ude06", "author": "minwoox", "createdAt": "2020-01-03T10:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MzQ5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjI1NA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r362756254", "body": "Could we make it much shorter? It will increase the amount of our logs by large margin.", "bodyText": "Could we make it much shorter? It will increase the amount of our logs by large margin.", "bodyHTML": "<p dir=\"auto\">Could we make it much shorter? It will increase the amount of our logs by large margin.</p>", "author": "trustin", "createdAt": "2020-01-03T10:02:38Z", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -545,7 +545,10 @@ public String toString() {\n             return strVal;\n         }\n \n-        final StringBuilder buf = new StringBuilder(96);\n+        final StringBuilder buf = new StringBuilder(117);\n+        buf.append('[')\n+           .append(ClientRequestContext.class.getSimpleName())\n+           .append(']');", "originalCommit": "6c938d304f6db92b2d85712ecd61682ef3876e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NzY1Nw==", "url": "https://github.com/line/armeria/pull/2366#discussion_r362757657", "bodyText": "Then how about [ClientCtx]? or [Client]? I really wish to know whether the context is ClientRequestContext or ServiceRequestContext from the logs. \ud83e\udd14", "author": "minwoox", "createdAt": "2020-01-03T10:07:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjI1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAyNjMwMQ==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363026301", "bodyText": "Changed to [ClientCtx] and [ServiceCtx]", "author": "minwoox", "createdAt": "2020-01-04T09:49:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjI1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE0Mzk4Mg==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363143982", "bodyText": "How about shortening even more, like [C] and [S]?", "author": "trustin", "createdAt": "2020-01-06T03:03:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjI1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE0NjIwMg==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363146202", "bodyText": "It's fine for me. Let me change that. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-01-06T03:20:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjI1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjQ3Mg==", "url": "https://github.com/line/armeria/pull/2366#discussion_r362756472", "body": "Could extract into a new method and deduplicate", "bodyText": "Could extract into a new method and deduplicate", "bodyHTML": "<p dir=\"auto\">Could extract into a new method and deduplicate</p>", "author": "trustin", "createdAt": "2020-01-03T10:03:27Z", "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.BiConsumer;\n+import java.util.function.BiFunction;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * A base class for {@link CompletableFuture} which pushing {@link RequestContext} into the thread-local\n+ * when executes callbacks.\n+ */\n+public abstract class AbstractRequestContextAwareCompletableFuture<T> extends CompletableFuture<T> {\n+\n+    private static final Logger logger =\n+            LoggerFactory.getLogger(AbstractRequestContextAwareCompletableFuture.class);\n+\n+    private final RequestContext ctx;\n+\n+    protected AbstractRequestContextAwareCompletableFuture(RequestContext ctx) {\n+        this.ctx = ctx;\n+    }\n+\n+    protected RequestContext ctx() {\n+        return ctx;\n+    }\n+\n+    protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n+        requireNonNull(runnable, \"runnable\");\n+        return () -> {\n+            try (SafeCloseable ignored = ctx.push()) {\n+                runnable.run();\n+            } catch (Throwable th) {\n+                logger.warn(\"An error occurred when pushing a context\", th);\n+                throw th;", "originalCommit": "6c938d304f6db92b2d85712ecd61682ef3876e1a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzAyNjI5Mw==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363026293", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-01-04T09:49:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjQ3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjY3Nw==", "url": "https://github.com/line/armeria/pull/2366#discussion_r362756677", "body": "Ditto", "bodyText": "Ditto", "bodyHTML": "<p dir=\"auto\">Ditto</p>", "author": "trustin", "createdAt": "2020-01-03T10:04:10Z", "path": "core/src/main/java/com/linecorp/armeria/server/DefaultServiceRequestContext.java", "diffHunk": "@@ -584,7 +584,10 @@ public String toString() {\n             return strVal;\n         }\n \n-        final StringBuilder buf = new StringBuilder(96);\n+        final StringBuilder buf = new StringBuilder(119);\n+        buf.append('[')\n+           .append(ServiceRequestContext.class.getSimpleName())\n+           .append(']');", "originalCommit": "6c938d304f6db92b2d85712ecd61682ef3876e1a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ef3ee2105f2fa1e7a9b4ad9425e41ef6fe75114e", "url": "https://github.com/line/armeria/commit/ef3ee2105f2fa1e7a9b4ad9425e41ef6fe75114e", "message": "Address comments by @trustin`", "committedDate": "2020-01-03T16:36:54Z", "type": "commit"}, {"oid": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332", "url": "https://github.com/line/armeria/commit/3780cf8cca46aa8bec4df98ed17ec5efe05e6332", "message": "Fix", "committedDate": "2020-01-04T09:47:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MDgwMA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363070800", "body": "Ah here's where I first saw the pattern - see my comment here https://github.com/line/armeria/pull/2371#discussion_r363069843\r\n\r\nUsing `return` instead of `throw` doesn't seem to improve verbosity but makes the code much less readable.", "bodyText": "Ah here's where I first saw the pattern - see my comment here #2371 (comment)\nUsing return instead of throw doesn't seem to improve verbosity but makes the code much less readable.", "bodyHTML": "<p dir=\"auto\">Ah here's where I first saw the pattern - see my comment here <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"545301946\" data-permission-text=\"Title is private\" data-url=\"https://github.com/line/armeria/issues/2371\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/line/armeria/pull/2371/hovercard?comment_id=363069843&amp;comment_type=review_comment\" href=\"https://github.com/line/armeria/pull/2371#discussion_r363069843\">#2371 (comment)</a></p>\n<p dir=\"auto\">Using <code>return</code> instead of <code>throw</code> doesn't seem to improve verbosity but makes the code much less readable.</p>", "author": "anuraaga", "createdAt": "2020-01-05T05:37:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContext.java", "diffHunk": "@@ -351,10 +352,7 @@ default SafeCloseable push(boolean runCallbacks) {\n \n         // Put the oldCtx back before throwing an exception.\n         RequestContextThreadLocal.set(oldCtx);\n-        throw new IllegalStateException(\n-                \"Trying to call object wrapped with context \" + this + \", but context is currently \" +\n-                \"set to \" + oldCtx + \". This means the callback was called from \" +\n-                \"unexpected thread or forgetting to close previous context.\");\n+        return throwIllegalContextPushing(this, oldCtx);", "originalCommit": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzNDk3OQ==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363134979", "bodyText": "Yes, it's now much readable. Thanks!", "author": "minwoox", "createdAt": "2020-01-06T01:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MDgwMA=="}], "type": "inlineReview"}, {"oid": "edf840debf98c182523d5450b00c01db1a9231ed", "url": "https://github.com/line/armeria/commit/edf840debf98c182523d5450b00c01db1a9231ed", "message": "Address the comment by @anuraaga", "committedDate": "2020-01-06T01:48:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzMzg0OA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363133848", "body": "I'm not an expert here. So...\r\n\r\nQuestion: Is there any chance the `runnable` throws an exception?\r\nIf throws, I think we need to update the message like:\r\n`An error occurred when pushing a context and executing the 'Runnable'`\r\nOr should we catch only the `throwIllegalContextPushing`?", "bodyText": "I'm not an expert here. So...\nQuestion: Is there any chance the runnable throws an exception?\nIf throws, I think we need to update the message like:\nAn error occurred when pushing a context and executing the 'Runnable'\nOr should we catch only the throwIllegalContextPushing?", "bodyHTML": "<p dir=\"auto\">I'm not an expert here. So...</p>\n<p dir=\"auto\">Question: Is there any chance the <code>runnable</code> throws an exception?<br>\nIf throws, I think we need to update the message like:<br>\n<code>An error occurred when pushing a context and executing the 'Runnable'</code><br>\nOr should we catch only the <code>throwIllegalContextPushing</code>?</p>", "author": "ikhoon", "createdAt": "2020-01-06T01:37:38Z", "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.BiConsumer;\n+import java.util.function.BiFunction;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * A base class for {@link CompletableFuture} which pushing {@link RequestContext} into the thread-local\n+ * when executes callbacks.\n+ */\n+public abstract class AbstractRequestContextAwareCompletableFuture<T> extends CompletableFuture<T> {\n+\n+    private static final Logger logger =\n+            LoggerFactory.getLogger(AbstractRequestContextAwareCompletableFuture.class);\n+\n+    private final RequestContext ctx;\n+\n+    protected AbstractRequestContextAwareCompletableFuture(RequestContext ctx) {\n+        this.ctx = ctx;\n+    }\n+\n+    protected RequestContext ctx() {\n+        return ctx;\n+    }\n+\n+    protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n+        requireNonNull(runnable, \"runnable\");\n+        return () -> {\n+            makeContextAwareLoggingException0(runnable);\n+        };\n+    }\n+\n+    protected <I> Consumer<I> makeContextAwareLoggingException(Consumer<I> action) {\n+        requireNonNull(action, \"action\");\n+        return t -> makeContextAwareLoggingException0(() -> action.accept(t));\n+    }\n+\n+    protected <I, U> BiConsumer<I, U> makeContextAwareLoggingException(BiConsumer<I, U> action) {\n+        requireNonNull(action, \"action\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> action.accept(t, u));\n+    }\n+\n+    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> action) {\n+        requireNonNull(action, \"action\");\n+        return () -> makeContextAwareLoggingException0(action);\n+    }\n+\n+    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> function) {\n+        requireNonNull(function, \"function\");\n+        return t -> makeContextAwareLoggingException0(() -> function.apply(t));\n+    }\n+\n+    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> function) {\n+        requireNonNull(function, \"function\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> function.apply(t, u));\n+    }\n+\n+    private void makeContextAwareLoggingException0(Runnable runnable) {\n+        try (SafeCloseable ignored = ctx.push()) {\n+            runnable.run();\n+        } catch (Throwable th) {\n+            logger.warn(\"An error occurred when pushing a context\", th);", "originalCommit": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzOTc1MQ==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363139751", "bodyText": "That's a good point. Let me update the message. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-01-06T02:30:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzMzg0OA=="}], "type": "inlineReview"}, {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c", "url": "https://github.com/line/armeria/commit/35bbeb553d5156519b9b2c0db0fc284b0295668c", "message": "Address comments by @trustin and @ikhoon", "committedDate": "2020-01-06T03:37:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDE5Nw==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154197", "body": "We should not log exceptions raised by `.run()`\r\n\r\n```java\r\nfinal SafeCloseable handle;\r\ntry {\r\n    handle = ctx.push();\r\n} catch (Throwable t) {\r\n    logger.warn(...);\r\n    Exceptions.throwUnsafely(t);\r\n    return;\r\n}\r\n\r\ntry {\r\n    action.run();\r\n} finally {\r\n    handle.close();\r\n}\r\n```", "bodyText": "We should not log exceptions raised by .run()\nfinal SafeCloseable handle;\ntry {\n    handle = ctx.push();\n} catch (Throwable t) {\n    logger.warn(...);\n    Exceptions.throwUnsafely(t);\n    return;\n}\n\ntry {\n    action.run();\n} finally {\n    handle.close();\n}", "bodyHTML": "<p dir=\"auto\">We should not log exceptions raised by <code>.run()</code></p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"final SafeCloseable handle;\ntry {\n    handle = ctx.push();\n} catch (Throwable t) {\n    logger.warn(...);\n    Exceptions.throwUnsafely(t);\n    return;\n}\n\ntry {\n    action.run();\n} finally {\n    handle.close();\n}\"><pre><span class=\"pl-k\">final</span> <span class=\"pl-smi\">SafeCloseable</span> handle;\n<span class=\"pl-k\">try</span> {\n    handle <span class=\"pl-k\">=</span> ctx<span class=\"pl-k\">.</span>push();\n} <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">Throwable</span> t) {\n    logger<span class=\"pl-k\">.</span>warn(<span class=\"pl-c1\">...</span>);\n    <span class=\"pl-smi\">Exceptions</span><span class=\"pl-k\">.</span>throwUnsafely(t);\n    <span class=\"pl-k\">return</span>;\n}\n\n<span class=\"pl-k\">try</span> {\n    action<span class=\"pl-k\">.</span>run();\n} <span class=\"pl-k\">finally</span> {\n    handle<span class=\"pl-k\">.</span>close();\n}</pre></div>", "author": "trustin", "createdAt": "2020-01-06T04:22:02Z", "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -67,35 +67,35 @@ protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n         return (t, u) -> makeContextAwareLoggingException0(() -> action.accept(t, u));\n     }\n \n-    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> action) {\n-        requireNonNull(action, \"action\");\n-        return () -> makeContextAwareLoggingException0(action);\n+    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> supplier) {\n+        requireNonNull(supplier, \"supplier\");\n+        return () -> makeContextAwareLoggingException0(supplier);\n     }\n \n-    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> function) {\n-        requireNonNull(function, \"function\");\n-        return t -> makeContextAwareLoggingException0(() -> function.apply(t));\n+    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return t -> makeContextAwareLoggingException0(() -> fn.apply(t));\n     }\n \n-    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> function) {\n-        requireNonNull(function, \"function\");\n-        return (t, u) -> makeContextAwareLoggingException0(() -> function.apply(t, u));\n+    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> fn.apply(t, u));\n     }\n \n-    private void makeContextAwareLoggingException0(Runnable runnable) {\n+    private void makeContextAwareLoggingException0(Runnable action) {\n         try (SafeCloseable ignored = ctx.push()) {\n-            runnable.run();\n+            action.run();\n         } catch (Throwable th) {\n-            logger.warn(\"An error occurred when pushing a context\", th);\n+            logger.warn(\"An error occurred when pushing a context and executing the action\", th);\n             throw th;\n         }", "originalCommit": "35bbeb553d5156519b9b2c0db0fc284b0295668c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDIzMA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154230", "body": "Ditto", "bodyText": "Ditto", "bodyHTML": "<p dir=\"auto\">Ditto</p>", "author": "trustin", "createdAt": "2020-01-06T04:22:20Z", "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -67,35 +67,35 @@ protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n         return (t, u) -> makeContextAwareLoggingException0(() -> action.accept(t, u));\n     }\n \n-    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> action) {\n-        requireNonNull(action, \"action\");\n-        return () -> makeContextAwareLoggingException0(action);\n+    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> supplier) {\n+        requireNonNull(supplier, \"supplier\");\n+        return () -> makeContextAwareLoggingException0(supplier);\n     }\n \n-    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> function) {\n-        requireNonNull(function, \"function\");\n-        return t -> makeContextAwareLoggingException0(() -> function.apply(t));\n+    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return t -> makeContextAwareLoggingException0(() -> fn.apply(t));\n     }\n \n-    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> function) {\n-        requireNonNull(function, \"function\");\n-        return (t, u) -> makeContextAwareLoggingException0(() -> function.apply(t, u));\n+    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> fn.apply(t, u));\n     }\n \n-    private void makeContextAwareLoggingException0(Runnable runnable) {\n+    private void makeContextAwareLoggingException0(Runnable action) {\n         try (SafeCloseable ignored = ctx.push()) {\n-            runnable.run();\n+            action.run();\n         } catch (Throwable th) {\n-            logger.warn(\"An error occurred when pushing a context\", th);\n+            logger.warn(\"An error occurred when pushing a context and executing the action\", th);\n             throw th;\n         }\n     }\n \n-    private <V> V makeContextAwareLoggingException0(Supplier<? extends V> action) {\n+    private <V> V makeContextAwareLoggingException0(Supplier<? extends V> fn) {\n         try (SafeCloseable ignored = ctx.push()) {\n-            return action.get();\n+            return fn.get();\n         } catch (Throwable th) {\n-            logger.warn(\"An error occurred when pushing a context\", th);\n+            logger.warn(\"An error occurred when pushing a context and executing the fn\", th);\n             throw th;\n         }", "originalCommit": "35bbeb553d5156519b9b2c0db0fc284b0295668c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDM3Mw==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154373", "body": "Could you make it a top-level class and make it part of `common` package?", "bodyText": "Could you make it a top-level class and make it part of common package?", "bodyHTML": "<p dir=\"auto\">Could you make it a top-level class and make it part of <code>common</code> package?</p>", "author": "trustin", "createdAt": "2020-01-06T04:23:34Z", "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,20 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * An {@link IllegalStateException} which is raised when pushing a context from the unexpected thread\n+     * or forgetting to close the previous context.\n+     */\n+    public static final class IllegalContextPushingException extends IllegalStateException {", "originalCommit": "35bbeb553d5156519b9b2c0db0fc284b0295668c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4MzI4Mg==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363183282", "bodyText": "So If I change just to return the IllegalStateException from the previous method, I don't have to declare this new exception type. And I think we don't have to have this another exception, especially for this case. (Sorry I made this class because I misunderstood the comment. \ud83d\ude4f) Do you think we still need this?", "author": "minwoox", "createdAt": "2020-01-06T07:28:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDM3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI5MTkxOQ==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363291919", "bodyText": "Nope. Let's continue using IllegalStateException.", "author": "trustin", "createdAt": "2020-01-06T13:27:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDM3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDY0MA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154640", "body": "Now that we have a dedicated exception type, we could add getters for the two contexts? We could also simplify the exception message and add more details to the class Javadoc.", "bodyText": "Now that we have a dedicated exception type, we could add getters for the two contexts? We could also simplify the exception message and add more details to the class Javadoc.", "bodyHTML": "<p dir=\"auto\">Now that we have a dedicated exception type, we could add getters for the two contexts? We could also simplify the exception message and add more details to the class Javadoc.</p>", "author": "trustin", "createdAt": "2020-01-06T04:25:59Z", "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,20 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * An {@link IllegalStateException} which is raised when pushing a context from the unexpected thread\n+     * or forgetting to close the previous context.\n+     */\n+    public static final class IllegalContextPushingException extends IllegalStateException {\n+\n+        private static final long serialVersionUID = 5431942355463120798L;\n+\n+        public IllegalContextPushingException(RequestContext newCtx, RequestContext oldCtx) {\n+            super(\"Trying to call object wrapped with context \" + newCtx + \", but context is currently \" +\n+                  \"set to \" + oldCtx + \". This means the callback was called from \" +\n+                  \"unexpected thread or forgetting to close previous context.\");", "originalCommit": "35bbeb553d5156519b9b2c0db0fc284b0295668c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1ODU0MQ==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363158541", "body": "This type looks good but just to clarify, I was just expecting the old factory method to return `IllegalStateException` instead of throwing it ;)", "bodyText": "This type looks good but just to clarify, I was just expecting the old factory method to return IllegalStateException instead of throwing it ;)", "bodyHTML": "<p dir=\"auto\">This type looks good but just to clarify, I was just expecting the old factory method to return <code>IllegalStateException</code> instead of throwing it ;)</p>", "author": "anuraaga", "createdAt": "2020-01-06T04:58:13Z", "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,20 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * An {@link IllegalStateException} which is raised when pushing a context from the unexpected thread\n+     * or forgetting to close the previous context.\n+     */\n+    public static final class IllegalContextPushingException extends IllegalStateException {\n+\n+        private static final long serialVersionUID = 5431942355463120798L;\n+\n+        public IllegalContextPushingException(RequestContext newCtx, RequestContext oldCtx) {", "originalCommit": "35bbeb553d5156519b9b2c0db0fc284b0295668c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4MjgxMA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363182810", "bodyText": "Ah, I misunderstood. \ud83d\ude05", "author": "minwoox", "createdAt": "2020-01-06T07:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1ODU0MQ=="}], "type": "inlineReview"}, {"oid": "20a07aead0331a839ada3a569770f9c535b3f9f0", "url": "https://github.com/line/armeria/commit/20a07aead0331a839ada3a569770f9c535b3f9f0", "message": "Address comment by @anuraaga and @trustin", "committedDate": "2020-01-06T08:06:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE5MjYzOA==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363192638", "body": "```suggestion\r\n        return new IllegalStateException(\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new IllegalStateException(\n          \n          \n            \n                    return new IllegalStateException(", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k x x-first x-last\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalStateException</span>(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k x x-first x-last\">return</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalStateException</span>(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "anuraaga", "createdAt": "2020-01-06T08:11:23Z", "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,19 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * Returns an {@link IllegalStateException} which is raised when pushing a context from\n+     * the unexpected thread or forgetting to close the previous context.\n+     */\n+    public static IllegalStateException newIllegalContextPushingException(\n+            RequestContext newCtx, RequestContext oldCtx) {\n+        requireNonNull(newCtx, \"newCtx\");\n+        requireNonNull(oldCtx, \"oldCtx\");\n+        throw new IllegalStateException(", "originalCommit": "20a07aead0331a839ada3a569770f9c535b3f9f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE5MzA2OQ==", "url": "https://github.com/line/armeria/pull/2366#discussion_r363193069", "bodyText": "Oops forgot to change that.", "author": "minwoox", "createdAt": "2020-01-06T08:13:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE5MjYzOA=="}], "type": "inlineReview"}, {"oid": "5eab119f51ec149538d52e2b596e04eb0a61dda6", "url": "https://github.com/line/armeria/commit/5eab119f51ec149538d52e2b596e04eb0a61dda6", "message": "Fix to return", "committedDate": "2020-01-06T08:13:47Z", "type": "commit"}, {"oid": "114d89c400dd7efe9cbf2efa1b75d3998c15e214", "url": "https://github.com/line/armeria/commit/114d89c400dd7efe9cbf2efa1b75d3998c15e214", "message": "Merge branch 'master' into context_aware_mismatch", "committedDate": "2020-01-06T13:26:44Z", "type": "commit"}, {"oid": "1bf10791c050d37316994f83d58dbf20d4532a3a", "url": "https://github.com/line/armeria/commit/1bf10791c050d37316994f83d58dbf20d4532a3a", "message": "Fix check style", "committedDate": "2020-01-06T13:55:36Z", "type": "commit"}]}