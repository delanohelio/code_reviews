{"pr_number": 2898, "pr_title": "Decorate all services with MetricCollectingService when integrates with Spring Boot", "pr_author": "imasahiro", "pr_createdAt": "2020-07-15T02:58:46Z", "pr_url": "https://github.com/line/armeria/pull/2898", "timeline": [{"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "url": "https://github.com/line/armeria/commit/6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "message": "Attach missing MetricCollectingService decorator globally if ArmeriaSettings.enableMetrics is true", "committedDate": "2020-07-15T03:33:20Z", "type": "commit"}, {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "url": "https://github.com/line/armeria/commit/6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "message": "Attach missing MetricCollectingService decorator globally if ArmeriaSettings.enableMetrics is true", "committedDate": "2020-07-15T03:33:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw==", "url": "https://github.com/line/armeria/pull/2898#discussion_r454799747", "body": "You don't need to set `service` tag. :-)\r\nhttps://github.com/line/armeria/blob/7f3295f32ac263ef83d96e6c763c1395431681b9/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java#L108-L111", "bodyText": "You don't need to set service tag. :-)\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java\n    \n    \n        Lines 108 to 111\n      in\n      7f3295f\n    \n    \n    \n    \n\n        \n          \n           final String serviceName = log.serviceName(); \n        \n\n        \n          \n           if (serviceName != null) { \n        \n\n        \n          \n               tagListBuilder.add(Tag.of(\"service\", serviceName)); \n        \n\n        \n          \n           }", "bodyHTML": "<p dir=\"auto\">You don't need to set <code>service</code> tag. :-)<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/line/armeria/blob/7f3295f32ac263ef83d96e6c763c1395431681b9/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java#L108-L111\">armeria/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 108 to 111\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/line/armeria/commit/7f3295f32ac263ef83d96e6c763c1395431681b9\">7f3295f</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L108\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"108\"></td>\n          <td id=\"LC108\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> serviceName <span class=\"pl-k\">=</span> log<span class=\"pl-k\">.</span>serviceName(); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L109\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"109\"></td>\n          <td id=\"LC109\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (serviceName <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L110\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"110\"></td>\n          <td id=\"LC110\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     tagListBuilder<span class=\"pl-k\">.</span>add(<span class=\"pl-smi\">Tag</span><span class=\"pl-k\">.</span>of(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>service<span class=\"pl-pds\">\"</span></span>, serviceName)); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L111\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"111\"></td>\n          <td id=\"LC111\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "ikhoon", "createdAt": "2020-07-15T05:25:13Z", "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -147,6 +148,11 @@ public static void configureServerWithArmeriaSettings(ServerBuilder server, Arme\n                     DropwizardSupport.addExposition(settings, server, meterRegistry);\n                 }\n             }\n+\n+            server.decorator(MetricCollectingService.newDecorator(\n+                    MeterIdPrefixFunction.ofDefault(\"armeria.server\")\n+                                         .andThen((registry, log, meterIdPrefix) -> meterIdPrefix.withTags(\n+                                                 \"service\", log.serviceName()))));", "originalCommit": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgwMzEyOA==", "url": "https://github.com/line/armeria/pull/2898#discussion_r454803128", "bodyText": "I think we should remove the following method to avoid duplicate collecting.\n\n  \n    \n      armeria/spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java\n    \n    \n        Lines 339 to 349\n      in\n      8c9c81f\n    \n    \n    \n    \n\n        \n          \n           private static HttpService setupMetricCollectingService( \n        \n\n        \n          \n                   HttpService service, AbstractServiceRegistrationBean<?, ?, ?, ?> bean, \n        \n\n        \n          \n                   @Nullable MeterIdPrefixFunctionFactory meterIdPrefixFunctionFactory) { \n        \n\n        \n          \n               requireNonNull(service, \"service\"); \n        \n\n        \n          \n               requireNonNull(bean, \"bean\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (meterIdPrefixFunctionFactory == null) { \n        \n\n        \n          \n                   return service; \n        \n\n        \n          \n               } \n        \n\n        \n          \n               return service.decorate(metricCollectingServiceDecorator(bean, meterIdPrefixFunctionFactory)); \n        \n\n        \n          \n           }", "author": "ikhoon", "createdAt": "2020-07-15T05:36:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4NDY3Ng==", "url": "https://github.com/line/armeria/pull/2898#discussion_r454884676", "bodyText": "Oops, I missed this comment. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-15T08:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw=="}], "type": "inlineReview"}, {"oid": "503584210c8534bf614e7ab41c33c7eb167e8107", "url": "https://github.com/line/armeria/commit/503584210c8534bf614e7ab41c33c7eb167e8107", "message": "Remove `service` tag", "committedDate": "2020-07-15T06:08:41Z", "type": "commit"}, {"oid": "14eaf4e977bf9e22e5b20deb8ed6e954f5191b59", "url": "https://github.com/line/armeria/commit/14eaf4e977bf9e22e5b20deb8ed6e954f5191b59", "message": "Remove setupMetricCollectingService", "committedDate": "2020-07-16T12:01:06Z", "type": "commit"}, {"oid": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "url": "https://github.com/line/armeria/commit/4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "message": "Remove MeterIdPrefixFUnctionFactory from Server bean dependency graph", "committedDate": "2020-07-20T09:40:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyOTIwMw==", "url": "https://github.com/line/armeria/pull/2898#discussion_r457229203", "body": "Could you remove this method?", "bodyText": "Could you remove this method?", "bodyHTML": "<p dir=\"auto\">Could you remove this method?</p>", "author": "minwoox", "createdAt": "2020-07-20T09:43:12Z", "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -336,18 +328,6 @@ public static void configureAnnotatedServices(\n         }\n     }\n \n-    private static HttpService setupMetricCollectingService(\n-            HttpService service, AbstractServiceRegistrationBean<?, ?, ?, ?> bean,\n-            @Nullable MeterIdPrefixFunctionFactory meterIdPrefixFunctionFactory) {\n-        requireNonNull(service, \"service\");\n-        requireNonNull(bean, \"bean\");\n-\n-        if (meterIdPrefixFunctionFactory == null) {\n-            return service;\n-        }\n-        return service.decorate(metricCollectingServiceDecorator(bean, meterIdPrefixFunctionFactory));\n-    }\n-\n     private static Function<? super HttpService, MetricCollectingService> metricCollectingServiceDecorator(", "originalCommit": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fff23a0caaf80ef658ebb132b24e6731e4034cd", "url": "https://github.com/line/armeria/commit/9fff23a0caaf80ef658ebb132b24e6731e4034cd", "message": "more cleanup", "committedDate": "2020-07-20T09:45:01Z", "type": "commit"}, {"oid": "0cd224f83eb27cfdd323934619e22e2e98bbc03b", "url": "https://github.com/line/armeria/commit/0cd224f83eb27cfdd323934619e22e2e98bbc03b", "message": "cleanup", "committedDate": "2020-07-21T00:22:16Z", "type": "commit"}]}