{"pr_number": 730, "pr_title": "fix[aws-datastore] selection set for nested custom types", "pr_author": "saltonmassally", "pr_createdAt": "2020-08-16T12:15:04Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/730", "timeline": [{"oid": "f128062c2ab5211f8629776dc9bd9ae60b654b1d", "url": "https://github.com/aws-amplify/amplify-android/commit/f128062c2ab5211f8629776dc9bd9ae60b654b1d", "message": "fix[aws-datastore] selection set for nested custom types\n\nThis PR fixes a bug in the selection set invovling fields of custom types.\n\nResolves: https://github.com/aws-amplify/amplify-android/issues/702", "committedDate": "2020-08-16T12:05:59Z", "type": "commit"}, {"oid": "818b8c9a72ecce0a156b45a32b7b5815816f64b0", "url": "https://github.com/aws-amplify/amplify-android/commit/818b8c9a72ecce0a156b45a32b7b5815816f64b0", "message": "add further test cases", "committedDate": "2020-08-19T08:08:25Z", "type": "commit"}, {"oid": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "url": "https://github.com/aws-amplify/amplify-android/commit/c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "message": "check for custom type checks against the generic type if collection", "committedDate": "2020-08-19T10:06:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4OTYwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r473589602", "body": "If possible, please avoid single letter variable names. They're hard to search for with tooling. For this one, maybe `fieldContainerClazz`?", "bodyText": "If possible, please avoid single letter variable names. They're hard to search for with tooling. For this one, maybe fieldContainerClazz?", "bodyHTML": "<p dir=\"auto\">If possible, please avoid single letter variable names. They're hard to search for with tooling. For this one, maybe <code>fieldContainerClazz</code>?</p>", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:00:06Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -246,5 +252,75 @@ private SelectionSet wrapPagination(SelectionSet node) {\n             }\n             return result;\n         }\n+\n+        /**\n+         * We handle customType fields differently as DEPTH does not apply here.\n+         * @param clazz class we wish to build selection set for\n+         * @return\n+         */\n+        private Set<SelectionSet> getNestedCustomTypeFields(Class<?> clazz) {\n+            Set<SelectionSet> result = new HashSet<>();\n+            for (Field field : findFieldsIn(clazz)) {\n+                String fieldName = field.getName();\n+                if (isCustomType(field)) {\n+                    result.add(new SelectionSet(fieldName, getNestedCustomTypeFields(getClassForField(field))));\n+                } else {\n+                    result.add(new SelectionSet(fieldName, null));\n+                }\n+            }\n+            return result;\n+        }\n+\n+        /**\n+         * Helper for finding fields in a class.\n+         * @param clazz class we wish to introspect\n+         * @return\n+         */\n+        private List<Field> findFieldsIn(@NonNull Class<?> clazz) {\n+            final List<Field> fields = new ArrayList<>();\n+            Class<?> c = clazz;", "originalCommit": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4OTc4Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r473589782", "body": "```suggestion\r\n        private static boolean isCustomType(@NonNull Field field) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    static boolean isCustomType(@NonNull Field field) {\n          \n          \n            \n                    private static boolean isCustomType(@NonNull Field field) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">static</span> <span class=\"pl-k\">boolean</span> isCustomType(<span class=\"pl-k\">@NonNull</span> <span class=\"pl-smi\">Field</span> field) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k x x-first\">private</span><span class=\"x x-last\"> </span><span class=\"pl-k\">static</span> <span class=\"pl-k\">boolean</span> isCustomType(<span class=\"pl-k\">@NonNull</span> <span class=\"pl-smi\">Field</span> field) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:00:30Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -246,5 +252,75 @@ private SelectionSet wrapPagination(SelectionSet node) {\n             }\n             return result;\n         }\n+\n+        /**\n+         * We handle customType fields differently as DEPTH does not apply here.\n+         * @param clazz class we wish to build selection set for\n+         * @return\n+         */\n+        private Set<SelectionSet> getNestedCustomTypeFields(Class<?> clazz) {\n+            Set<SelectionSet> result = new HashSet<>();\n+            for (Field field : findFieldsIn(clazz)) {\n+                String fieldName = field.getName();\n+                if (isCustomType(field)) {\n+                    result.add(new SelectionSet(fieldName, getNestedCustomTypeFields(getClassForField(field))));\n+                } else {\n+                    result.add(new SelectionSet(fieldName, null));\n+                }\n+            }\n+            return result;\n+        }\n+\n+        /**\n+         * Helper for finding fields in a class.\n+         * @param clazz class we wish to introspect\n+         * @return\n+         */\n+        private List<Field> findFieldsIn(@NonNull Class<?> clazz) {\n+            final List<Field> fields = new ArrayList<>();\n+            Class<?> c = clazz;\n+            while (c != null) {\n+                for (Field field : c.getDeclaredFields()) {\n+                    fields.add(field);\n+                }\n+                c = c.getSuperclass();\n+            }\n+            Collections.sort(fields, Comparator.comparing(Field::getName));\n+            return Immutable.of(fields);\n+        }\n+\n+        /**\n+         * Helper to determine if field is a custom type. If custom types we need to build nested selection set.\n+         * @param field field we wish to check\n+         * @return\n+         */\n+        static boolean isCustomType(@NonNull Field field) {", "originalCommit": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU5MDM1MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r473590350", "body": "There is a `FieldFinder` utility class which I believe is supposed do something like this? You could feel free to update/augment it, if it doesn't currently meet your needs.", "bodyText": "There is a FieldFinder utility class which I believe is supposed do something like this? You could feel free to update/augment it, if it doesn't currently meet your needs.", "bodyHTML": "<p dir=\"auto\">There is a <code>FieldFinder</code> utility class which I believe is supposed do something like this? You could feel free to update/augment it, if it doesn't currently meet your needs.</p>", "author": "jamesonwilliams", "createdAt": "2020-08-20T05:01:30Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java", "diffHunk": "@@ -246,5 +252,75 @@ private SelectionSet wrapPagination(SelectionSet node) {\n             }\n             return result;\n         }\n+\n+        /**\n+         * We handle customType fields differently as DEPTH does not apply here.\n+         * @param clazz class we wish to build selection set for\n+         * @return\n+         */\n+        private Set<SelectionSet> getNestedCustomTypeFields(Class<?> clazz) {\n+            Set<SelectionSet> result = new HashSet<>();\n+            for (Field field : findFieldsIn(clazz)) {\n+                String fieldName = field.getName();\n+                if (isCustomType(field)) {\n+                    result.add(new SelectionSet(fieldName, getNestedCustomTypeFields(getClassForField(field))));\n+                } else {\n+                    result.add(new SelectionSet(fieldName, null));\n+                }\n+            }\n+            return result;\n+        }\n+\n+        /**\n+         * Helper for finding fields in a class.\n+         * @param clazz class we wish to introspect\n+         * @return\n+         */\n+        private List<Field> findFieldsIn(@NonNull Class<?> clazz) {", "originalCommit": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMTM5OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r477611399", "body": ":-D ", "bodyText": ":-D", "bodyHTML": "<p dir=\"auto\">:-D</p>", "author": "jamesonwilliams", "createdAt": "2020-08-26T21:54:44Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -161,7 +214,7 @@ public void validateSubscriptionGenerationOnUpdatePost() throws DataStoreExcepti\n     }\n \n     /**\n-     * Validates generation of a GraphQL document which requests a subscription for updates\n+     * Validates generation of a GraphQL document which requests a subscription for deletes.", "originalCommit": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxMTQ3MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r477611471", "body": "```suggestion\r\n```", "bodyText": "Suggested change", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesonwilliams", "createdAt": "2020-08-26T21:54:53Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java", "diffHunk": "@@ -195,4 +248,49 @@ public void validateMutationGenerationOnCreateComment() throws DataStoreExceptio\n \n         );\n     }\n+\n+    /**\n+     * Validates creation of a \"create a model\" request for nested custom type.\n+     * @throws DataStoreException On failure to interrogate the model fields.\n+     * @throws JSONException from JSONAssert.assertEquals.\n+     */\n+    @Test\n+    public void validateMutationGenerationOnCreateNestedCustomType() throws DataStoreException, JSONException {\n+        JSONAssert.assertEquals(\n+                Resources.readAsString(\"create-parent-request.txt\"),\n+                AppSyncRequestFactory.buildCreationRequest(buildTestParentModel()).getContent(),\n+                true\n+", "originalCommit": "c4f10f8cf97206ac2b3750f8fab29447eebfa7a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c6634219252c9267623a3b44b1ff431a63fb0fc", "url": "https://github.com/aws-amplify/amplify-android/commit/5c6634219252c9267623a3b44b1ff431a63fb0fc", "message": "Update aws-api-appsync/src/main/java/com/amplifyframework/api/aws/SelectionSet.java\n\nCo-authored-by: Jameson Williams <jhwilliams@gmail.com>", "committedDate": "2020-08-29T04:34:42Z", "type": "commit"}, {"oid": "edaa92a54fcd45549e3f11f0a2c5332b07960f4e", "url": "https://github.com/aws-amplify/amplify-android/commit/edaa92a54fcd45549e3f11f0a2c5332b07960f4e", "message": "Update aws-datastore/src/test/java/com/amplifyframework/datastore/appsync/AppSyncRequestFactoryTest.java\n\nCo-authored-by: Jameson Williams <jhwilliams@gmail.com>", "committedDate": "2020-08-29T05:26:23Z", "type": "commit"}, {"oid": "d39e734912f0c346e7a33f2acb600632b7c2ea53", "url": "https://github.com/aws-amplify/amplify-android/commit/d39e734912f0c346e7a33f2acb600632b7c2ea53", "message": "move fieldFindIn to FieldFinder and some cosmetics", "committedDate": "2020-08-29T05:52:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY4MDExNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/730#discussion_r479680115", "body": "Oh, ha, it was _already_ a single letter variable. \ud83d\ude0a  Thanks for improving it.", "bodyText": "Oh, ha, it was already a single letter variable. \ud83d\ude0a  Thanks for improving it.", "bodyHTML": "<p dir=\"auto\">Oh, ha, it was <em>already</em> a single letter variable. <g-emoji class=\"g-emoji\" alias=\"blush\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f60a.png\">\ud83d\ude0a</g-emoji>  Thanks for improving it.</p>", "author": "jamesonwilliams", "createdAt": "2020-08-29T19:07:26Z", "path": "core/src/main/java/com/amplifyframework/util/FieldFinder.java", "diffHunk": "@@ -45,21 +46,40 @@ private FieldFinder() {\n      * @return set of fields\n      */\n     @NonNull\n-    public static List<Field> findFieldsIn(@NonNull Class<?> clazz) {\n+    public static List<Field> findModelFieldsIn(@NonNull Class<?> clazz) {\n         final List<Field> fields = new ArrayList<>();\n-        Class<?> c = clazz;", "originalCommit": "d39e734912f0c346e7a33f2acb600632b7c2ea53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}