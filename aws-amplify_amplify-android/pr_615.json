{"pr_number": 615, "pr_title": "Changes related to subscription connectivity problems", "pr_author": "rjuliano", "pr_createdAt": "2020-06-29T04:04:04Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/615", "timeline": [{"oid": "29b6272cc1b41c3319e7acd14f17ff797a185d3c", "url": "https://github.com/aws-amplify/amplify-android/commit/29b6272cc1b41c3319e7acd14f17ff797a185d3c", "message": "Changes to the API module", "committedDate": "2020-06-29T13:32:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE4NjM5Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r447186397", "body": "```suggestion\r\n    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-api:websocket\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final Logger LOG = Amplify.Logging.forNamespace(\"aws-api:websocket\");\n          \n          \n            \n                private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-api:websocket\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">Logger</span> <span class=\"pl-c1\">LOG</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">Amplify</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Logging</span><span class=\"pl-k\">.</span>forNamespace(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>aws-api:websocket<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">Logger</span> <span class=\"pl-c1\">LOG</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">Amplify</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Logging</span><span class=\"pl-k\">.</span>forNamespace(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">amplify:</span>aws-api:websocket<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "richardmcclellan", "createdAt": "2020-06-29T18:58:49Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -53,6 +57,7 @@\n  * and multiple GraphQL subscriptions that work on top of it.\n  */\n final class SubscriptionEndpoint {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"aws-api:websocket\");", "originalCommit": "29b6272cc1b41c3319e7acd14f17ff797a185d3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzODQ2OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451838468", "bodyText": "fixed", "author": "rjuliano", "createdAt": "2020-07-08T21:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE4NjM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNDQxMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r447214412", "body": "Is there a reason you need to pass in `subscriptionId`?  It seems like that could be handled internally within `SubscriptionEndpoint`.  It doesn't appear that `subscriptionId` is actually used anywhere else in `SubscriptionOperation`, except for checking if it's null in `cancel()`, which doesn't seem like a necessary check anyway.", "bodyText": "Is there a reason you need to pass in subscriptionId?  It seems like that could be handled internally within SubscriptionEndpoint.  It doesn't appear that subscriptionId is actually used anywhere else in SubscriptionOperation, except for checking if it's null in cancel(), which doesn't seem like a necessary check anyway.", "bodyHTML": "<p dir=\"auto\">Is there a reason you need to pass in <code>subscriptionId</code>?  It seems like that could be handled internally within <code>SubscriptionEndpoint</code>.  It doesn't appear that <code>subscriptionId</code> is actually used anywhere else in <code>SubscriptionOperation</code>, except for checking if it's null in <code>cancel()</code>, which doesn't seem like a necessary check anyway.</p>", "author": "richardmcclellan", "createdAt": "2020-06-29T19:51:32Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -76,14 +79,12 @@ public synchronized void start() {\n             ));\n             return;\n         }\n-        executorService.submit(() -> {\n+        subscriptionFuture = executorService.submit(() -> {\n             LOG.debug(\"Requesting subscription: \" + getRequest().getContent());\n             subscriptionEndpoint.requestSubscription(\n+                subscriptionId,", "originalCommit": "29b6272cc1b41c3319e7acd14f17ff797a185d3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgzODYwMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451838600", "bodyText": "Nope...I reverted that change.", "author": "rjuliano", "createdAt": "2020-07-08T21:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNDQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNDg2MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r447214860", "body": "Possible NPE since subscriptionFuture could be null?", "bodyText": "Possible NPE since subscriptionFuture could be null?", "bodyHTML": "<p dir=\"auto\">Possible NPE since subscriptionFuture could be null?</p>", "author": "richardmcclellan", "createdAt": "2020-06-29T19:52:21Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -95,6 +96,9 @@ public synchronized void start() {\n     public synchronized void cancel() {\n         if (subscriptionId != null && !canceled) {\n             canceled = true;\n+            if (subscriptionFuture.cancel(true)) {", "originalCommit": "29b6272cc1b41c3319e7acd14f17ff797a185d3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDA5Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451840096", "bodyText": "Yup...accounting for that now.", "author": "rjuliano", "createdAt": "2020-07-08T21:38:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIxNDg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMTg5Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r448111893", "body": "Naming: `pendingSubscriptionIds`?", "bodyText": "Naming: pendingSubscriptionIds?", "bodyHTML": "<p dir=\"auto\">Naming: <code>pendingSubscriptionIds</code>?</p>", "author": "jamesonwilliams", "createdAt": "2020-07-01T04:43:32Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -62,67 +67,86 @@\n     private final GraphQLResponse.Factory responseFactory;\n     private final TimeoutWatchdog timeoutWatchdog;\n     private final CountDownLatch connectionResponse;\n+    private final Set<String> pendingSubscriptions;", "originalCommit": "29b6272cc1b41c3319e7acd14f17ff797a185d3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDE1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451840156", "bodyText": "Changed", "author": "rjuliano", "createdAt": "2020-07-08T21:38:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMTg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMjgzMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r448112832", "body": "Ahh. Nice catch.", "bodyText": "Ahh. Nice catch.", "bodyHTML": "<p dir=\"auto\">Ahh. Nice catch.</p>", "author": "jamesonwilliams", "createdAt": "2020-07-01T04:47:05Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -305,34 +335,42 @@ private void notifySubscriptionData(String subscriptionId, String data) throws A\n     }\n \n     synchronized void releaseSubscription(String subscriptionId) throws ApiException {\n-        final Subscription<?> subscription = subscriptions.get(subscriptionId);\n-        if (subscription == null) {\n+        // First thing we should do is remove it from the subscriptions collections so\n+        // the other methods can't grab a hold of the subscription.\n+        final Subscription<?> subscription = subscriptions.remove(subscriptionId);\n+        boolean wasSubscriptionPending = pendingSubscriptions.remove(subscriptionId);\n+        // If the subscription was not in the subscriptions collections AND was also\n+        // not in the pending collection.\n+        if (subscription == null && !wasSubscriptionPending) {\n             throw new ApiException(\n                 \"No existing subscription with the given id.\",\n                 AmplifyException.TODO_RECOVERY_SUGGESTION\n             );\n         }\n \n-        try {\n-            webSocket.send(new JSONObject()\n-                .put(\"type\", \"stop\")\n-                .put(\"id\", subscriptionId)\n-                .toString());\n-        } catch (JSONException jsonException) {\n-            throw new ApiException(\n-                \"Failed to construct subscription release message.\",\n-                jsonException,\n-                AmplifyException.TODO_RECOVERY_SUGGESTION\n-            );\n+        // Only do this if the subscription was NOT pending.\n+        // Otherwise it would probably fail since it was never established in the first place.\n+        if (!wasSubscriptionPending) {\n+            try {\n+                webSocket.send(new JSONObject()\n+                    .put(\"type\", \"stop\")\n+                    .put(\"id\", subscriptionId)\n+                    .toString());\n+            } catch (JSONException jsonException) {\n+                throw new ApiException(\n+                    \"Failed to construct subscription release message.\",\n+                    jsonException,\n+                    AmplifyException.TODO_RECOVERY_SUGGESTION\n+                );\n+            }\n+            subscription.awaitSubscriptionCompleted();\n         }\n \n-        subscription.awaitSubscriptionCompleted();\n-        subscriptions.remove(subscriptionId);\n-\n         // If we have zero subscriptions, close the WebSocket\n         if (subscriptions.size() == 0) {\n             timeoutWatchdog.stop();\n             webSocket.close(NORMAL_CLOSURE_STATUS, \"No active subscriptions\");\n+            webSocket = null; //force creation of a new websocket", "originalCommit": "29b6272cc1b41c3319e7acd14f17ff797a185d3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDM1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451840357", "bodyText": "It ended up looking a little different, but the spirit is the same. Basically need to force the creation of a new websocket.", "author": "rjuliano", "createdAt": "2020-07-08T21:39:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMjgzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMzAzMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r448113032", "body": "Can this be `final` now that you assign it in the operation constructor?", "bodyText": "Can this be final now that you assign it in the operation constructor?", "bodyHTML": "<p dir=\"auto\">Can this be <code>final</code> now that you assign it in the operation constructor?</p>", "author": "jamesonwilliams", "createdAt": "2020-07-01T04:47:52Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -41,6 +43,7 @@\n \n     private String subscriptionId;", "originalCommit": "29b6272cc1b41c3319e7acd14f17ff797a185d3c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg0MDYzNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451840635", "bodyText": "Unfortunately no because I can't assign it until the subscription actually starts.", "author": "rjuliano", "createdAt": "2020-07-08T21:39:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMzAzMg=="}], "type": "inlineReview"}, {"oid": "9684174634920d50a8ecf0141abb157b64611a32", "url": "https://github.com/aws-amplify/amplify-android/commit/9684174634920d50a8ecf0141abb157b64611a32", "message": "Merge branch 'rjuliano/bugfix_startcrash' into rjuliano/api_fix", "committedDate": "2020-07-01T20:39:36Z", "type": "commit"}, {"oid": "09739e83c6247088969b14833a4940fde19435c3", "url": "https://github.com/aws-amplify/amplify-android/commit/09739e83c6247088969b14833a4940fde19435c3", "message": "Fixing websocket connection issues", "committedDate": "2020-07-08T20:54:48Z", "type": "commit"}, {"oid": "ec7f19a2f1d002fd14b2f8bf16e2e7c2e0138570", "url": "https://github.com/aws-amplify/amplify-android/commit/ec7f19a2f1d002fd14b2f8bf16e2e7c2e0138570", "message": "Revert previous changes made to test", "committedDate": "2020-07-08T20:59:08Z", "type": "commit"}, {"oid": "e8de1b81a7277e94ecb7bed756fc39b35386f6ed", "url": "https://github.com/aws-amplify/amplify-android/commit/e8de1b81a7277e94ecb7bed756fc39b35386f6ed", "message": "Renamed variable", "committedDate": "2020-07-08T21:02:14Z", "type": "commit"}, {"oid": "175dc2398777ea748004e7c4d8934bd4bfa34295", "url": "https://github.com/aws-amplify/amplify-android/commit/175dc2398777ea748004e7c4d8934bd4bfa34295", "message": "cleaned up unused variable", "committedDate": "2020-07-08T23:02:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4NDY2Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451884662", "body": "```suggestion\r\nimport androidx.annotation.NonNull;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.jetbrains.annotations.NotNull;\n          \n          \n            \n            import androidx.annotation.NonNull;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"pl-k\">import</span> <span class=\"pl-smi x x-first x-last\">org.jetbrains.annotations.NotNull</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">import</span> <span class=\"pl-smi x x-first x-last\">androidx.annotation.NonNull</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesonwilliams", "createdAt": "2020-07-08T23:44:37Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -25,22 +25,28 @@\n import com.amplifyframework.api.graphql.GraphQLRequest;\n import com.amplifyframework.api.graphql.GraphQLResponse;\n import com.amplifyframework.core.Action;\n+import com.amplifyframework.core.Amplify;\n import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.logging.Logger;\n import com.amplifyframework.util.UserAgent;\n \n+import org.jetbrains.annotations.NotNull;", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NDk2NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452264964", "bodyText": "done", "author": "rjuliano", "createdAt": "2020-07-09T14:35:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4NDY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4NTIzOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451885239", "body": "```suggestion\r\n    private final OkHttpClient okHttpClient;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private OkHttpClient okHttpClient;\n          \n          \n            \n                private final OkHttpClient okHttpClient;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">OkHttpClient</span> okHttpClient;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">OkHttpClient</span> okHttpClient;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesonwilliams", "createdAt": "2020-07-08T23:46:37Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -61,21 +68,34 @@\n     private final Map<String, Subscription<?>> subscriptions;\n     private final GraphQLResponse.Factory responseFactory;\n     private final TimeoutWatchdog timeoutWatchdog;\n-    private final CountDownLatch connectionResponse;\n+    private final Set<String> pendingSubscriptionIds;\n+    private final Request websocketInitRequest;\n+    private final String subscriptionUrl;\n     private String connectionFailure;\n     private WebSocket webSocket;\n+    private AmplifyWebSocketListener webSocketListener;\n+    private OkHttpClient okHttpClient;", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NTI1MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452265251", "bodyText": "done", "author": "rjuliano", "createdAt": "2020-07-09T14:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4NTIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4NTQ1OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451885458", "body": "I don't think you need to store this on the class. You could just pass a `new ...Request()` at the call site. Isn't that so?", "bodyText": "I don't think you need to store this on the class. You could just pass a new ...Request() at the call site. Isn't that so?", "bodyHTML": "<p dir=\"auto\">I don't think you need to store this on the class. You could just pass a <code>new ...Request()</code> at the call site. Isn't that so?</p>", "author": "jamesonwilliams", "createdAt": "2020-07-08T23:47:25Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -61,21 +68,34 @@\n     private final Map<String, Subscription<?>> subscriptions;\n     private final GraphQLResponse.Factory responseFactory;\n     private final TimeoutWatchdog timeoutWatchdog;\n-    private final CountDownLatch connectionResponse;\n+    private final Set<String> pendingSubscriptionIds;\n+    private final Request websocketInitRequest;", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NDkwMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452264903", "bodyText": "done", "author": "rjuliano", "createdAt": "2020-07-09T14:35:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTg4NTQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzMjkyNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451932926", "body": "This is a topic I haven't closed in my own mind, yet:\r\n\r\nIf a cancellable object encounters an error, or terminates gracefully, is it canceled?\r\n - Yes! Of course, since it can't be useful anymore;\r\n - No; no-one asked for it to stop (cancellation), it just did.\r\n\r\n\ud83d\ude16 \r\n\r\n---------------------\r\n\r\nIf you do (1), though, should you also mark `canceld.set(true)` for the `onSubscriptionComplete` path?", "bodyText": "This is a topic I haven't closed in my own mind, yet:\nIf a cancellable object encounters an error, or terminates gracefully, is it canceled?\n\nYes! Of course, since it can't be useful anymore;\nNo; no-one asked for it to stop (cancellation), it just did.\n\n\ud83d\ude16\n\nIf you do (1), though, should you also mark canceld.set(true) for the onSubscriptionComplete path?", "bodyHTML": "<p dir=\"auto\">This is a topic I haven't closed in my own mind, yet:</p>\n<p dir=\"auto\">If a cancellable object encounters an error, or terminates gracefully, is it canceled?</p>\n<ul dir=\"auto\">\n<li>Yes! Of course, since it can't be useful anymore;</li>\n<li>No; no-one asked for it to stop (cancellation), it just did.</li>\n</ul>\n<p dir=\"auto\"><g-emoji class=\"g-emoji\" alias=\"confounded\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f616.png\">\ud83d\ude16</g-emoji></p>\n<hr>\n<p dir=\"auto\">If you do (1), though, should you also mark <code>canceld.set(true)</code> for the <code>onSubscriptionComplete</code> path?</p>", "author": "jamesonwilliams", "createdAt": "2020-07-09T02:46:57Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -85,21 +87,31 @@ public synchronized void start() {\n                     onSubscriptionStart.accept(subscriptionId);\n                 },\n                 onNextItem,\n-                onSubscriptionError,\n+                apiException -> {\n+                    // Guard against calling something that's been cancelled already.\n+                    if (!canceled.get()) {\n+                        canceled.set(true);\n+                        onSubscriptionError.accept(apiException);\n+                    }\n+                },\n                 onSubscriptionComplete", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI4NzU0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452287541", "bodyText": "Right...I feel like we're missing a representation of a state here. In my mind, we're missing a representation of the type of cancelation that took place: was it gracefully canceled, or was it a result of some error condition.\nI started doing some refactoring here, but ended up going down a rabbit hole so I shelved those changes for now. Probably something that needs to be looked at more broadly.", "author": "rjuliano", "createdAt": "2020-07-09T15:05:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzMjkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzMzA3NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451933074", "body": "```suggestion\r\n    private final AtomicBoolean canceled;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private AtomicBoolean canceled;\n          \n          \n            \n                private final AtomicBoolean canceled;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">AtomicBoolean</span> canceled;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k x x-first\">final</span><span class=\"x x-last\"> </span><span class=\"pl-smi\">AtomicBoolean</span> canceled;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jamesonwilliams", "createdAt": "2020-07-09T02:47:24Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -40,7 +42,8 @@\n     private final Action onSubscriptionComplete;\n \n     private String subscriptionId;\n-    private boolean canceled;\n+    private AtomicBoolean canceled;", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI4MzY1Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452283653", "bodyText": "done", "author": "rjuliano", "createdAt": "2020-07-09T15:00:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzMzA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNDAzNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451934037", "body": "If you don't need a reference to the `CountDownLatch` param, you could do:\r\n```java\r\nAmplifyWebSocketListener(CountDownLatch latch) {\r\n    this.latch = latch;\r\n}\r\n\r\nAmplifyWebSocketListener() {\r\n    this(new CountDownLatch(1));\r\n}\r\n```", "bodyText": "If you don't need a reference to the CountDownLatch param, you could do:\nAmplifyWebSocketListener(CountDownLatch latch) {\n    this.latch = latch;\n}\n\nAmplifyWebSocketListener() {\n    this(new CountDownLatch(1));\n}", "bodyHTML": "<p dir=\"auto\">If you don't need a reference to the <code>CountDownLatch</code> param, you could do:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"AmplifyWebSocketListener(CountDownLatch latch) {\n    this.latch = latch;\n}\n\nAmplifyWebSocketListener() {\n    this(new CountDownLatch(1));\n}\n\"><pre>AmplifyWebSocketListener(<span class=\"pl-smi\">CountDownLatch</span> latch) {\n    <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>latch <span class=\"pl-k\">=</span> latch;\n}\n\nAmplifyWebSocketListener() {\n    <span class=\"pl-c1\">this</span>(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">CountDownLatch</span>(<span class=\"pl-c1\">1</span>));\n}</pre></div>", "author": "jamesonwilliams", "createdAt": "2020-07-09T02:50:46Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -90,39 +110,25 @@\n         Objects.requireNonNull(onSubscriptionError);\n         Objects.requireNonNull(onSubscriptionComplete);\n \n-        if (webSocket == null) {\n-            try {\n-                connectionFailure = null;\n-                webSocket = createWebSocket();\n-            } catch (ApiException exception) {\n-                onSubscriptionError.accept(new ApiException(\n-                        \"Failed to create websocket for subscription\",\n-                        exception,\n-                        AmplifyException.TODO_RECOVERY_SUGGESTION\n-                ));\n-                return;\n-            }\n-\n-            try {\n-                connectionResponse.await(CONNECTION_ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS);\n-            } catch (InterruptedException interruptedException) {\n-                // Outcome is inspected below\n-            }\n-            if (connectionResponse.getCount() != 0) {\n-                onSubscriptionError.accept(new ApiException(\n-                    \"Subscription timed out waiting for acknowledgement\",\n-                    AmplifyException.TODO_RECOVERY_SUGGESTION\n-                ));\n-                return;\n-            } else if (connectionFailure != null) {\n-                onSubscriptionError.accept(new ApiException(\n-                    connectionFailure, \"Check if you are authorized to make this subscription\"\n-                ));\n+        // The first call to subscribe OR a disconnected websocket listener will\n+        // force a new connection to be created.\n+        if (webSocketListener == null || webSocketListener.isDisconnectedState()) {\n+            webSocketListener = new AmplifyWebSocketListener(new CountDownLatch(1));", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NjUwMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452266503", "bodyText": "Good call. Done.", "author": "rjuliano", "createdAt": "2020-07-09T14:37:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNDAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNTIyMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451935220", "body": "Could you have `waitForConnectionReady` return like a `Connection` object? It could have a status, and optionally, this failure detail. On L122, you could do like:\r\n```java\r\nConnection connection = webSocketListener.waitForConnection();\r\nif (connection.hasFailure()) {\r\n    ...\r\n```\r\nThen, here,\r\n```java\r\nnew ApiException(connection.getFailureDetail(), ...)\r\n```\r\nThe point of this would be so that you don't have to cache it inside of the listener.", "bodyText": "Could you have waitForConnectionReady return like a Connection object? It could have a status, and optionally, this failure detail. On L122, you could do like:\nConnection connection = webSocketListener.waitForConnection();\nif (connection.hasFailure()) {\n    ...\nThen, here,\nnew ApiException(connection.getFailureDetail(), ...)\nThe point of this would be so that you don't have to cache it inside of the listener.", "bodyHTML": "<p dir=\"auto\">Could you have <code>waitForConnectionReady</code> return like a <code>Connection</code> object? It could have a status, and optionally, this failure detail. On L122, you could do like:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Connection connection = webSocketListener.waitForConnection();\nif (connection.hasFailure()) {\n    ...\n\"><pre><span class=\"pl-smi\">Connection</span> connection <span class=\"pl-k\">=</span> webSocketListener<span class=\"pl-k\">.</span>waitForConnection();\n<span class=\"pl-k\">if</span> (connection<span class=\"pl-k\">.</span>hasFailure()) {\n    <span class=\"pl-c1\">...</span></pre></div>\n<p dir=\"auto\">Then, here,</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"new ApiException(connection.getFailureDetail(), ...)\n\"><pre><span class=\"pl-k\">new</span> <span class=\"pl-smi\">ApiException</span>(connection<span class=\"pl-k\">.</span>getFailureDetail(), <span class=\"pl-c1\">...</span>)</pre></div>\n<p dir=\"auto\">The point of this would be so that you don't have to cache it inside of the listener.</p>", "author": "jamesonwilliams", "createdAt": "2020-07-09T02:55:23Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -90,39 +110,25 @@\n         Objects.requireNonNull(onSubscriptionError);\n         Objects.requireNonNull(onSubscriptionComplete);\n \n-        if (webSocket == null) {\n-            try {\n-                connectionFailure = null;\n-                webSocket = createWebSocket();\n-            } catch (ApiException exception) {\n-                onSubscriptionError.accept(new ApiException(\n-                        \"Failed to create websocket for subscription\",\n-                        exception,\n-                        AmplifyException.TODO_RECOVERY_SUGGESTION\n-                ));\n-                return;\n-            }\n-\n-            try {\n-                connectionResponse.await(CONNECTION_ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS);\n-            } catch (InterruptedException interruptedException) {\n-                // Outcome is inspected below\n-            }\n-            if (connectionResponse.getCount() != 0) {\n-                onSubscriptionError.accept(new ApiException(\n-                    \"Subscription timed out waiting for acknowledgement\",\n-                    AmplifyException.TODO_RECOVERY_SUGGESTION\n-                ));\n-                return;\n-            } else if (connectionFailure != null) {\n-                onSubscriptionError.accept(new ApiException(\n-                    connectionFailure, \"Check if you are authorized to make this subscription\"\n-                ));\n+        // The first call to subscribe OR a disconnected websocket listener will\n+        // force a new connection to be created.\n+        if (webSocketListener == null || webSocketListener.isDisconnectedState()) {\n+            webSocketListener = new AmplifyWebSocketListener(new CountDownLatch(1));\n+            webSocket = okHttpClient.newWebSocket(websocketInitRequest, webSocketListener);\n+        }\n+        final String subscriptionId = UUID.randomUUID().toString();\n+        pendingSubscriptionIds.add(subscriptionId);\n+        // Every request waits here for the connection to be ready.\n+        if (!webSocketListener.waitForConnectionReady()) {\n+            // If the latch didn't count all the way down\n+            if (pendingSubscriptionIds.remove(subscriptionId)) {\n+                // The subscription was pending, so we need to emit an error.\n+                onSubscriptionError.accept(\n+                    new ApiException(webSocketListener.getFailureDetail(), AmplifyException.TODO_RECOVERY_SUGGESTION));", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NzU1OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452267559", "bodyText": "I like that. Adding it", "author": "rjuliano", "createdAt": "2020-07-09T14:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNTIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNTU4NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r451935584", "body": "When does this situation arise? And if the the subscription was _not_ still pending, but we're in this catch block, isn't there still some error case?\r\n", "bodyText": "When does this situation arise? And if the the subscription was not still pending, but we're in this catch block, isn't there still some error case?", "bodyHTML": "<p dir=\"auto\">When does this situation arise? And if the the subscription was <em>not</em> still pending, but we're in this catch block, isn't there still some error case?</p>", "author": "jamesonwilliams", "createdAt": "2020-07-09T02:56:54Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -134,11 +140,15 @@\n                 .toString()\n             );\n         } catch (JSONException | ApiException exception) {\n-            onSubscriptionError.accept(new ApiException(\n+            // If the subscriptionId was still pending, then we can call the onSubscriptionError", "originalCommit": "175dc2398777ea748004e7c4d8934bd4bfa34295", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI5Njg3MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/615#discussion_r452296871", "bodyText": "For us to get here, we know that the subscription was added to the pendingSubscriptionIds set and we have a good connection. These two exceptions can happen either because of some malformed value passed into the put calls, or if createHeadersForSubscription throws an ApiException.\nIf the subscription was not pending, it's likely because cancel() was invoked some time after the connection was successfully established, but before the subscription handshake completed.", "author": "rjuliano", "createdAt": "2020-07-09T15:18:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzNTU4NA=="}], "type": "inlineReview"}, {"oid": "2f7d6af468459c0ad448d6d6aefe7ef071c8fa43", "url": "https://github.com/aws-amplify/amplify-android/commit/2f7d6af468459c0ad448d6d6aefe7ef071c8fa43", "message": "Merge branch 'rjuliano/bugfix_startcrash' into rjuliano/api_fix", "committedDate": "2020-07-09T14:26:32Z", "type": "commit"}, {"oid": "5628513695b876bee5d36cdac34ce284f21ba5de", "url": "https://github.com/aws-amplify/amplify-android/commit/5628513695b876bee5d36cdac34ce284f21ba5de", "message": "PR feedback", "committedDate": "2020-07-09T15:09:43Z", "type": "commit"}, {"oid": "d2e4c4ae7cf804ed9808947a39c925e86965f0ae", "url": "https://github.com/aws-amplify/amplify-android/commit/d2e4c4ae7cf804ed9808947a39c925e86965f0ae", "message": "Merge branch 'rjuliano/bugfix_startcrash' into rjuliano/api_fix", "committedDate": "2020-07-15T12:45:37Z", "type": "commit"}]}