{"pr_number": 3188, "pr_title": "fix join hints not work when need table reorder", "pr_author": "yangzhg", "pr_createdAt": "2020-03-24T12:12:59Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3188", "timeline": [{"oid": "10c547fae17259be8391f11fa2f4401b5f6cf548", "url": "https://github.com/apache/incubator-doris/commit/10c547fae17259be8391f11fa2f4401b5f6cf548", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-24T12:15:56Z", "type": "forcePushed"}, {"oid": "5bd965b624f4d3902baa516c9868583040c61357", "url": "https://github.com/apache/incubator-doris/commit/5bd965b624f4d3902baa516c9868583040c61357", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-24T12:18:29Z", "type": "forcePushed"}, {"oid": "f81f486b000fd3ccab32e49c7104c802194bff1a", "url": "https://github.com/apache/incubator-doris/commit/f81f486b000fd3ccab32e49c7104c802194bff1a", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-25T05:48:35Z", "type": "forcePushed"}, {"oid": "4cd69aafc204672e5e9d6d73bdcef2663dce253e", "url": "https://github.com/apache/incubator-doris/commit/4cd69aafc204672e5e9d6d73bdcef2663dce253e", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-25T06:06:26Z", "type": "forcePushed"}, {"oid": "2bbcbb5f6ba9c9f210f1558208ed9afd02d886a6", "url": "https://github.com/apache/incubator-doris/commit/2bbcbb5f6ba9c9f210f1558208ed9afd02d886a6", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-25T06:53:17Z", "type": "forcePushed"}, {"oid": "f281c330cac5bd939381d2687133f149ad270853", "url": "https://github.com/apache/incubator-doris/commit/f281c330cac5bd939381d2687133f149ad270853", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-25T07:31:12Z", "type": "forcePushed"}, {"oid": "aa0a1f6155f9718758ea02d9a07963ad6a65f21c", "url": "https://github.com/apache/incubator-doris/commit/aa0a1f6155f9718758ea02d9a07963ad6a65f21c", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-25T07:34:19Z", "type": "forcePushed"}, {"oid": "c421a1dcc8d2781ec1ecae0d0fb84ab2b24a031f", "url": "https://github.com/apache/incubator-doris/commit/c421a1dcc8d2781ec1ecae0d0fb84ab2b24a031f", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-25T08:06:12Z", "type": "forcePushed"}, {"oid": "41c9337a8d84c9d0eb63d029125afdbb07859800", "url": "https://github.com/apache/incubator-doris/commit/41c9337a8d84c9d0eb63d029125afdbb07859800", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-25T09:21:58Z", "type": "forcePushed"}, {"oid": "fd0dd516dfd633d5a56689b9b4146941cfa11bfa", "url": "https://github.com/apache/incubator-doris/commit/fd0dd516dfd633d5a56689b9b4146941cfa11bfa", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-03-27T04:09:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI4OTMxOQ==", "url": "https://github.com/apache/incubator-doris/pull/3188#discussion_r398289319", "body": "```suggestion\r\n    // When a join statement with a join hint, the decorated part should be reordered as a whole,\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // When a join statement with a join hit, the decorated part should be reordered as a whole,\n          \n          \n            \n                // When a join statement with a join hint, the decorated part should be reordered as a whole,", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> When a join statement with a join <span class=\"x x-first x-last\">hit</span>, the decorated part should be reordered as a whole,</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> When a join statement with a join <span class=\"x x-first x-last\">hint</span>, the decorated part should be reordered as a whole,</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "morningman", "createdAt": "2020-03-26T02:54:47Z", "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -612,11 +611,14 @@ public void materializeRequiredSlots(Analyzer analyzer) throws AnalysisException\n         }\n     }\n \n+    // When a join statement with a join hit, the decorated part should be reordered as a whole,", "originalCommit": "41c9337a8d84c9d0eb63d029125afdbb07859800", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1NTk2OQ==", "url": "https://github.com/apache/incubator-doris/pull/3188#discussion_r400255969", "body": "```suggestion\r\n         LOG.debug(\"stats CrossJoin: cardinality= {}\", Long.toString(cardinality));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     LOG.debug(\"stats CrossJoin: cardinality=\" + Long.toString(cardinality));\n          \n          \n            \n                     LOG.debug(\"stats CrossJoin: cardinality= {}\", Long.toString(cardinality));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">         <span class=\"pl-c1\">LOG</span><span class=\"pl-k\">.</span>debug(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>stats CrossJoin: cardinality=<span class=\"pl-pds x x-first\">\"</span></span><span class=\"x\"> </span><span class=\"pl-k x x-last\">+</span> <span class=\"pl-smi\">Long</span><span class=\"pl-k\">.</span>toString(cardinality));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">         <span class=\"pl-c1\">LOG</span><span class=\"pl-k\">.</span>debug(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>stats CrossJoin: cardinality=<span class=\"x x-first\"> {}</span><span class=\"pl-pds x\">\"</span></span><span class=\"x x-last\">,</span> <span class=\"pl-smi\">Long</span><span class=\"pl-k\">.</span>toString(cardinality));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "morningman", "createdAt": "2020-03-30T14:53:24Z", "path": "fe/src/main/java/org/apache/doris/planner/CrossJoinNode.java", "diffHunk": "@@ -59,16 +59,16 @@ public TableRef getInnerRef() {\n \n     @Override\n     public void computeStats(Analyzer analyzer) {\n-        // super.computeStats(analyzer);\n-        // if (getChild(0).cardinality_ == -1 || getChild(1).cardinality_ == -1) {\n-        //   cardinality_ = -1;\n-        // } else {\n-        //   cardinality_ = getChild(0).cardinality_ * getChild(1).cardinality_;\n-        //   if (computeSelectivity() != -1) {\n-        //     cardinality_ = Math.round(((double) cardinality_) * computeSelectivity());\n-        //   }\n-        // }\n-        // LOG.debug(\"stats CrossJoin: cardinality=\" + Long.toString(cardinality_));\n+         super.computeStats(analyzer);\n+         if (getChild(0).cardinality == -1 || getChild(1).cardinality == -1) {\n+           cardinality = -1;\n+         } else {\n+           cardinality = getChild(0).cardinality * getChild(1).cardinality;\n+           if (computeSelectivity() != -1) {\n+             cardinality = Math.round(((double) cardinality) * computeSelectivity());\n+           }\n+         }\n+         LOG.debug(\"stats CrossJoin: cardinality=\" + Long.toString(cardinality));", "originalCommit": "fd0dd516dfd633d5a56689b9b4146941cfa11bfa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMyODE0OA==", "url": "https://github.com/apache/incubator-doris/pull/3188#discussion_r401328148", "body": "How about cross join?", "bodyText": "How about cross join?", "bodyHTML": "<p dir=\"auto\">How about cross join?</p>", "author": "wutiangan", "createdAt": "2020-04-01T02:57:21Z", "path": "fe/src/main/java/org/apache/doris/analysis/SelectStmt.java", "diffHunk": "@@ -612,11 +611,14 @@ public void materializeRequiredSlots(Analyzer analyzer) throws AnalysisException\n         }\n     }\n \n+    // When a join statement with a join hint, the decorated part should be reordered as a whole,\n+    // rather than individually.\n     protected void reorderTable(Analyzer analyzer) throws AnalysisException {\n-        List<Pair<TableRef, Long>> candidates = Lists.newArrayList();\n+        List<Pair<List<TableRef>, Long>> candidates = Lists.newArrayList();\n \n-        // New pair of table ref and row count\n-        for (TableRef tblRef : fromClause_) {\n+        for (int i = 0; i < fromClause_.size(); ++i) {\n+            List<TableRef> tableRefs = new ArrayList<>();\n+            TableRef tblRef = fromClause_.get(i);\n             if (tblRef.getJoinOp() != JoinOperator.INNER_JOIN) {\n                 // Unsupported reorder outer join", "originalCommit": "92c299f8f535df42bc3e2d425b83a64efd629898", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e2fa0391c0ae742945eecbdb4183536176fc1fa", "url": "https://github.com/apache/incubator-doris/commit/5e2fa0391c0ae742945eecbdb4183536176fc1fa", "message": "fix some typo", "committedDate": "2020-04-01T03:47:56Z", "type": "forcePushed"}, {"oid": "907d91b1d0814cccecc9cdd30412da8c5d249e5e", "url": "https://github.com/apache/incubator-doris/commit/907d91b1d0814cccecc9cdd30412da8c5d249e5e", "message": "fix join hints not work when need table reorder\nfix cross join numNodes not computed", "committedDate": "2020-04-02T07:43:54Z", "type": "commit"}, {"oid": "de68899b30e95ca32f7c0083f492078a32db13bd", "url": "https://github.com/apache/incubator-doris/commit/de68899b30e95ca32f7c0083f492078a32db13bd", "message": "fix some typo", "committedDate": "2020-04-02T07:43:54Z", "type": "commit"}, {"oid": "66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "url": "https://github.com/apache/incubator-doris/commit/66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "message": "disable table reorder when has join hints", "committedDate": "2020-04-02T07:48:21Z", "type": "commit"}, {"oid": "66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "url": "https://github.com/apache/incubator-doris/commit/66f8452c1eaabb4a3f2a435931d9f2b630e0af40", "message": "disable table reorder when has join hints", "committedDate": "2020-04-02T07:48:21Z", "type": "forcePushed"}]}