{"pr_number": 3806, "pr_title": "Remove order by for subquery in set opertion clause", "pr_author": "yangzhg", "pr_createdAt": "2020-06-09T07:26:38Z", "pr_url": "https://github.com/apache/incubator-doris/pull/3806", "timeline": [{"oid": "85bc7f77ce545d5eab06e9bf596334e58f7e00ca", "url": "https://github.com/apache/incubator-doris/commit/85bc7f77ce545d5eab06e9bf596334e58f7e00ca", "message": "xx", "committedDate": "2020-06-10T11:28:30Z", "type": "forcePushed"}, {"oid": "5377c24f3fff7c1f79fe56fd211e15cde59bb694", "url": "https://github.com/apache/incubator-doris/commit/5377c24f3fff7c1f79fe56fd211e15cde59bb694", "message": "xx", "committedDate": "2020-06-16T04:08:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwOTkyNg==", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r442209926", "body": "Update the document for this new variables.", "bodyText": "Update the document for this new variables.", "bodyHTML": "<p dir=\"auto\">Update the document for this new variables.</p>", "author": "morningman", "createdAt": "2020-06-18T13:04:55Z", "path": "fe/src/main/java/org/apache/doris/qe/SessionVariable.java", "diffHunk": "@@ -251,6 +253,9 @@\n     private int maxScanKeyNum = -1;\n     @VariableMgr.VarAttr(name = MAX_PUSHDOWN_CONDITIONS_PER_COLUMN)\n     private int maxPushdownConditionsPerColumn = -1;\n+    // TODO(Yangzhengguo) set this default value to true if we support spill data top disk\n+    @VariableMgr.VarAttr(name = ALLOW_IGNORE_ORDER_BY)\n+    private boolean allowIgnoreOrderBy = false;", "originalCommit": "5377c24f3fff7c1f79fe56fd211e15cde59bb694", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwOTkzNA==", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r442209934", "body": "This `strBuilder` seems useless.", "bodyText": "This strBuilder seems useless.", "bodyHTML": "<p dir=\"auto\">This <code>strBuilder</code> seems useless.</p>", "author": "morningman", "createdAt": "2020-06-18T13:04:56Z", "path": "fe/src/main/java/org/apache/doris/analysis/QueryStmt.java", "diffHunk": "@@ -285,27 +285,29 @@ protected void createSortInfo(Analyzer analyzer) throws AnalysisException {\n         }\n \n         sortInfo = new SortInfo(orderingExprs, isAscOrder, nullsFirstParams);\n-        // order by w/o limit and offset in inline views, union operands and insert statements\n+        // order by w/o limit and offset in inline views, set operands and insert statements\n         // are ignored.\n-        // TODO chenhao, open this when we don't limit rows subquery returns by SortNode.\n-        /*if (!hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n-         *   evaluateOrderBy = false;\n-         *   // Return a warning that the order by was ignored.\n-         *   StringBuilder strBuilder = new StringBuilder();\n-         *   strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n-         *   strBuilder.append(\"ORDER BY \");\n-         *   strBuilder.append(orderByElements.get(0).toSql());\n-         *   for (int i = 1; i < orderByElements.size(); ++i) {\n-         *       strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n-         *   }\n-         *   strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n-         *   strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n-         *   strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n-         *   strBuilder.append(\"with the ORDER BY.\");\n-         * } else {\n-         */\n-        evaluateOrderBy = true;\n-        //}\n+        boolean allowIgnore = false;\n+        if (ConnectContext.get() != null && ConnectContext.get().getSessionVariable().isAllowIgnoreOrderBy()) {\n+            allowIgnore = true;\n+        }\n+        if (allowIgnore && !hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n+            evaluateOrderBy = false;\n+            // Return a warning that the order by was ignored.\n+            StringBuilder strBuilder = new StringBuilder();\n+            strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n+            strBuilder.append(\"ORDER BY \");\n+            strBuilder.append(orderByElements.get(0).toSql());\n+            for (int i = 1; i < orderByElements.size(); ++i) {\n+                strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n+            }\n+            strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n+            strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n+            strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n+            strBuilder.append(\"with the ORDER BY.\");", "originalCommit": "5377c24f3fff7c1f79fe56fd211e15cde59bb694", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4OTM5MA==", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r442589390", "bodyText": "strBuilder is mainly used in the for loop, and this code is consistent with impala, in case there is a need for merge mpala code in the future, it is also more convenient", "author": "yangzhg", "createdAt": "2020-06-19T01:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwOTkzNA=="}], "type": "inlineReview"}, {"oid": "d0c6e9d79b2a59ac217e48ae3113672966e9ef0d", "url": "https://github.com/apache/incubator-doris/commit/d0c6e9d79b2a59ac217e48ae3113672966e9ef0d", "message": "add docs", "committedDate": "2020-06-22T05:40:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxMjg5MA==", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r444612890", "body": "```suggestion\r\n    // TODO set this default value to true if we support spill data top disk\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // TODO(Yangzhengguo) set this default value to true if we support spill data top disk\n          \n          \n            \n                // TODO set this default value to true if we support spill data top disk", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> TODO<span class=\"x x-first x-last\">(Yangzhengguo)</span> set this default value to true if we support spill data top disk</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">//</span> TODO set this default value to true if we support spill data top disk</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "wuyunfeng", "createdAt": "2020-06-24T02:41:28Z", "path": "fe/src/main/java/org/apache/doris/qe/SessionVariable.java", "diffHunk": "@@ -251,6 +253,9 @@\n     private int maxScanKeyNum = -1;\n     @VariableMgr.VarAttr(name = MAX_PUSHDOWN_CONDITIONS_PER_COLUMN)\n     private int maxPushdownConditionsPerColumn = -1;\n+    // TODO(Yangzhengguo) set this default value to true if we support spill data top disk", "originalCommit": "d0c6e9d79b2a59ac217e48ae3113672966e9ef0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY0Nzc4OA==", "url": "https://github.com/apache/incubator-doris/pull/3806#discussion_r444647788", "body": "```suggestion\r\n            strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, set operand, \");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n          \n          \n            \n                        strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, set operand, \");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"300\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            strBuilder<span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>.<span class=\"pl-cce\">\\n</span>An ORDER BY appearing in a view, subquery, <span class=\"x x-first x-last\">union</span> operand, <span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"300\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            strBuilder<span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>.<span class=\"pl-cce\">\\n</span>An ORDER BY appearing in a view, subquery, <span class=\"x x-first x-last\">set</span> operand, <span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "wutiangan", "createdAt": "2020-06-24T05:11:15Z", "path": "fe/src/main/java/org/apache/doris/analysis/QueryStmt.java", "diffHunk": "@@ -285,27 +285,25 @@ protected void createSortInfo(Analyzer analyzer) throws AnalysisException {\n         }\n \n         sortInfo = new SortInfo(orderingExprs, isAscOrder, nullsFirstParams);\n-        // order by w/o limit and offset in inline views, union operands and insert statements\n+        // order by w/o limit and offset in inline views, set operands and insert statements\n         // are ignored.\n-        // TODO chenhao, open this when we don't limit rows subquery returns by SortNode.\n-        /*if (!hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n-         *   evaluateOrderBy = false;\n-         *   // Return a warning that the order by was ignored.\n-         *   StringBuilder strBuilder = new StringBuilder();\n-         *   strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n-         *   strBuilder.append(\"ORDER BY \");\n-         *   strBuilder.append(orderByElements.get(0).toSql());\n-         *   for (int i = 1; i < orderByElements.size(); ++i) {\n-         *       strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n-         *   }\n-         *   strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");\n-         *   strBuilder.append(\"or an insert/ctas statement has no effect on the query result \");\n-         *   strBuilder.append(\"unless a LIMIT and/or OFFSET is used in conjunction \");\n-         *   strBuilder.append(\"with the ORDER BY.\");\n-         * } else {\n-         */\n-        evaluateOrderBy = true;\n-        //}\n+        if (!hasLimit() && !hasOffset() && !analyzer.isRootAnalyzer()) {\n+            evaluateOrderBy = false;\n+            // Return a warning that the order by was ignored.\n+            StringBuilder strBuilder = new StringBuilder();\n+            strBuilder.append(\"Ignoring ORDER BY clause without LIMIT or OFFSET: \");\n+            strBuilder.append(\"ORDER BY \");\n+            strBuilder.append(orderByElements.get(0).toSql());\n+            for (int i = 1; i < orderByElements.size(); ++i) {\n+                strBuilder.append(\", \").append(orderByElements.get(i).toSql());\n+            }\n+            strBuilder.append(\".\\nAn ORDER BY appearing in a view, subquery, union operand, \");", "originalCommit": "fc95e755302fbb06be38e53a20dd73ffb550f707", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2bd00de2a9b213502308286c1cd4d2638f4c0fc1", "url": "https://github.com/apache/incubator-doris/commit/2bd00de2a9b213502308286c1cd4d2638f4c0fc1", "message": "xx", "committedDate": "2020-06-28T07:39:25Z", "type": "forcePushed"}, {"oid": "e7d8c27f6c4c1d5056b96f7022948717a6017552", "url": "https://github.com/apache/incubator-doris/commit/e7d8c27f6c4c1d5056b96f7022948717a6017552", "message": "xx", "committedDate": "2020-06-29T06:36:18Z", "type": "forcePushed"}, {"oid": "ddf26f0ad196dbacda7b9806018953cb0ff37c93", "url": "https://github.com/apache/incubator-doris/commit/ddf26f0ad196dbacda7b9806018953cb0ff37c93", "message": "xx", "committedDate": "2020-06-30T01:56:31Z", "type": "forcePushed"}, {"oid": "6785d9a6ae0ab59d2bee64dae26bb509f32b705a", "url": "https://github.com/apache/incubator-doris/commit/6785d9a6ae0ab59d2bee64dae26bb509f32b705a", "message": "order by w/o limit and offset in inline views, set operands and insert statements", "committedDate": "2020-07-01T07:17:14Z", "type": "commit"}, {"oid": "62148664f85c77ff2d76546869d78d4ce2c533e3", "url": "https://github.com/apache/incubator-doris/commit/62148664f85c77ff2d76546869d78d4ce2c533e3", "message": "xx", "committedDate": "2020-07-01T07:17:14Z", "type": "commit"}, {"oid": "5b39c348e071035b4a9eacff6ad14c5ef60ec8c5", "url": "https://github.com/apache/incubator-doris/commit/5b39c348e071035b4a9eacff6ad14c5ef60ec8c5", "message": "add docs", "committedDate": "2020-07-01T07:17:14Z", "type": "commit"}, {"oid": "25cbe16f7a275234bd03caf26cdcce213f4a16da", "url": "https://github.com/apache/incubator-doris/commit/25cbe16f7a275234bd03caf26cdcce213f4a16da", "message": "remvoe session variable", "committedDate": "2020-07-01T07:17:14Z", "type": "commit"}, {"oid": "25cbe16f7a275234bd03caf26cdcce213f4a16da", "url": "https://github.com/apache/incubator-doris/commit/25cbe16f7a275234bd03caf26cdcce213f4a16da", "message": "remvoe session variable", "committedDate": "2020-07-01T07:17:14Z", "type": "forcePushed"}, {"oid": "f2a509a54bb0b437610bceb3965af0b5d961d55e", "url": "https://github.com/apache/incubator-doris/commit/f2a509a54bb0b437610bceb3965af0b5d961d55e", "message": "log warning", "committedDate": "2020-07-01T07:42:16Z", "type": "commit"}, {"oid": "4dc5db4b67bbfcd5aeba87b2b76c74b6f9bd8bdc", "url": "https://github.com/apache/incubator-doris/commit/4dc5db4b67bbfcd5aeba87b2b76c74b6f9bd8bdc", "message": "add_log", "committedDate": "2020-07-01T08:12:02Z", "type": "commit"}]}