{"pr_number": 4771, "pr_title": "[LoadBalance] make BeLoadRebalancer extends from base class Rebalancer", "pr_author": "vagetablechicken", "pr_createdAt": "2020-10-20T09:03:10Z", "pr_url": "https://github.com/apache/incubator-doris/pull/4771", "merge_commit": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "timeline": [{"oid": "dd1d78b1b18f8ee21b176d6e3c775c76cea5756d", "url": "https://github.com/apache/incubator-doris/commit/dd1d78b1b18f8ee21b176d6e3c775c76cea5756d", "message": "[] base rebalancer", "committedDate": "2020-10-20T08:49:12Z", "type": "commit"}, {"oid": "a91d931f6eae1873ed148c53411f6b867ae3421c", "url": "https://github.com/apache/incubator-doris/commit/a91d931f6eae1873ed148c53411f6b867ae3421c", "message": "[] fix", "committedDate": "2020-10-20T09:05:06Z", "type": "commit"}, {"oid": "8fe4ec93ace75e9b76fc9cdca9ddea2c95a4ec54", "url": "https://github.com/apache/incubator-doris/commit/8fe4ec93ace75e9b76fc9cdca9ddea2c95a4ec54", "message": "[] fix", "committedDate": "2020-10-20T09:46:45Z", "type": "commit"}, {"oid": "8c543d2d34f6ec07640114f3ada72d284e1e4f0c", "url": "https://github.com/apache/incubator-doris/commit/8c543d2d34f6ec07640114f3ada72d284e1e4f0c", "message": "[] fix", "committedDate": "2020-10-20T09:54:17Z", "type": "commit"}, {"oid": "49b06d572541359eb667dfb6e8eb4a116fa02075", "url": "https://github.com/apache/incubator-doris/commit/49b06d572541359eb667dfb6e8eb4a116fa02075", "message": "[] fix", "committedDate": "2020-10-20T10:43:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzODg0OA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r510138848", "body": "For current scheduler principal, a tablet can only have one task running or pending at most. So we should delete the cache as soon as possible. It is better to change this function to getAndDeleteCachedSrcBackendId. And call it after scheduler cancelled, task running cancelled, and deleteSrcReplicaOfLB.", "bodyText": "For current scheduler principal, a tablet can only have one task running or pending at most. So we should delete the cache as soon as possible. It is better to change this function to getAndDeleteCachedSrcBackendId. And call it after scheduler cancelled, task running cancelled, and deleteSrcReplicaOfLB.", "bodyHTML": "<p dir=\"auto\">For current scheduler principal, a tablet can only have one task running or pending at most. So we should delete the cache as soon as possible. It is better to change this function to getAndDeleteCachedSrcBackendId. And call it after scheduler cancelled, task running cancelled, and deleteSrcReplicaOfLB.</p>", "author": "gengjun-git", "createdAt": "2020-10-22T12:57:35Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                           AgentBatchTask batchTask) throws SchedException;\n+\n+    public Long getCachedSrcBackendId(Long tabletId) {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI1NDAyMA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r510254020", "bodyText": "I prefer that cache should be managed by Rebalancer, no need to make getCachedSrcBackendId to delete. You can do whatever you want, e.g. only clear cache when stats update.\nAbout cancellations(scheduler canceled, task running cancelled, etc.):\nBefore these cancellations, adding tablet to the scheduler may get failed. And after the clone task completed, the rest of a rebalance move may get failed too. So there're so many places that need to delete cache. I think we shouldn't 'delete the cache asap'. Maybe clearing cache when stats update is better.", "author": "vagetablechicken", "createdAt": "2020-10-22T15:27:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEzODg0OA=="}], "type": "inlineReview", "revised_code": {"commit": "4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 189caec695..8beb16352f 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -70,7 +70,7 @@ public abstract class Rebalancer {\n     public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n                                            AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getCachedSrcBackendId(Long tabletId) {\n+    public Long getSrcBackendId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 8beb16352f..c9f354a504 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -70,7 +70,7 @@ public abstract class Rebalancer {\n     public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n                                            AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getSrcBackendId(Long tabletId) {\n+    public Long getSrcReplicaId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "4ee5cd1d3f855707967a4dad5da544df0e133577", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex c9f354a504..c207cd9d9c 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -67,10 +68,23 @@ public abstract class Rebalancer {\n     protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n             String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n \n-    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n-                                           AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getSrcReplicaId(Long tabletId) {\n+    public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                  AgentBatchTask batchTask) throws SchedException {\n+        completePlan(tabletCtx, backendsWorkingSlots);\n+        batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n+    }\n+\n+    // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n+    // 1. If you generate {tabletId, srcReplica, destReplica} in selectAlternativeTablets(), it may be invalid at\n+    // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n+    // You should check the moves' validation.\n+    // 2. If you want to generate {srcReplica, destReplica} here, just do it.\n+    // 3. You should check the path slots of src & dest.\n+    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+            throws SchedException;\n+\n+    public Long getToDeleteReplicaId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "8bb3ce37b814a5f80141b4f5ab76127971cae20e", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex c207cd9d9c..e0bf5f7d14 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -65,23 +65,25 @@ public abstract class Rebalancer {\n         return alternativeTablets;\n     }\n \n+    // The return TabletSchedCtx should have the tablet id at least. {srcReplica, destBe} can be complete here or\n+    // later(when createBalanceTask called).\n     protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n             String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n \n \n     public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n                                   AgentBatchTask batchTask) throws SchedException {\n-        completePlan(tabletCtx, backendsWorkingSlots);\n+        completeSchedCtx(tabletCtx, backendsWorkingSlots);\n         batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n     }\n \n     // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n-    // 1. If you generate {tabletId, srcReplica, destReplica} in selectAlternativeTablets(), it may be invalid at\n+    // 1. If you generate {tabletId, srcReplica, destBe} in selectAlternativeTablets(), it may be invalid at\n     // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n     // You should check the moves' validation.\n-    // 2. If you want to generate {srcReplica, destReplica} here, just do it.\n+    // 2. If you want to generate {srcReplica, destBe} here, just do it.\n     // 3. You should check the path slots of src & dest.\n-    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+    protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n             throws SchedException;\n \n     public Long getToDeleteReplicaId(Long tabletId) {\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 189caec695..e0bf5f7d14 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -64,13 +65,28 @@ public abstract class Rebalancer {\n         return alternativeTablets;\n     }\n \n+    // The return TabletSchedCtx should have the tablet id at least. {srcReplica, destBe} can be complete here or\n+    // later(when createBalanceTask called).\n     protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n             String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n \n-    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n-                                           AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getCachedSrcBackendId(Long tabletId) {\n+    public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                  AgentBatchTask batchTask) throws SchedException {\n+        completeSchedCtx(tabletCtx, backendsWorkingSlots);\n+        batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n+    }\n+\n+    // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n+    // 1. If you generate {tabletId, srcReplica, destBe} in selectAlternativeTablets(), it may be invalid at\n+    // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n+    // You should check the moves' validation.\n+    // 2. If you want to generate {srcReplica, destBe} here, just do it.\n+    // 3. You should check the path slots of src & dest.\n+    protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+            throws SchedException;\n+\n+    public Long getToDeleteReplicaId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex e0bf5f7d14..f854ef0c23 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -86,7 +86,7 @@ public abstract class Rebalancer {\n     protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n             throws SchedException;\n \n-    public Long getToDeleteReplicaId(Long tabletId) {\n+    public Long getToDeleteReplicaId(TabletSchedCtx tabletCtx) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex f854ef0c23..1fca40652c 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -90,7 +90,7 @@ public abstract class Rebalancer {\n         return -1L;\n     }\n \n-    public void updateLoadStatistic(Map<String, ClusterLoadStatistic> statisticMap) {\n+    public void updateLoadStatistic(Table<String, Tag, ClusterLoadStatistic> statisticMap) {\n         this.statisticMap = statisticMap;\n     }\n }\n", "next_change": {"commit": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 1fca40652c..a7177c2f54 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -93,4 +101,21 @@ public abstract class Rebalancer {\n     public void updateLoadStatistic(Table<String, Tag, ClusterLoadStatistic> statisticMap) {\n         this.statisticMap = statisticMap;\n     }\n+\n+    public void addPrioBackends(List<Backend> backends, long timeoutS) {\n+        long currentTimeMillis = System.currentTimeMillis();\n+        for (Backend backend : backends) {\n+            prioBackends.put(backend.getId(), currentTimeMillis + timeoutS);\n+        }\n+    }\n+\n+    public void removePrioBackends(List<Backend> backends) {\n+        for (Backend backend : backends) {\n+            prioBackends.remove(backend.getId());\n+        }\n+    }\n+\n+    public boolean hasPrioBackends() {\n+        return !prioBackends.isEmpty();\n+    }\n }\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "message": "Merge commit", "committedDate": null}, {"oid": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "committedDate": "2020-12-31 09:41:38 +0800", "message": "[Rebalancer] support partition rebalancer (#5010)"}, {"oid": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "committedDate": "2021-09-04 10:59:35 +0800", "message": "[Feature][ResourceTag] Support Resource Tag (#6203)"}, {"oid": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "committedDate": "2022-03-28 10:03:21 +0800", "message": "[feature](balance) Support balance between disks on a single BE (#8553)"}, {"oid": "8a0097cfb932c0ff480ff1472009d597036a938b", "committedDate": "2022-05-12 20:14:38 +0800", "message": "[style](java) format fe code with some check rules (#9460)"}, {"oid": "b7b78ae7079a61eadab0e78d9e9c9792dd0af1b3", "committedDate": "2022-06-17 21:02:45 +0800", "message": "[style](fe)the last step of fe CheckStyle (#10134)"}, {"oid": "a7f3bfec89a8228d25590f2d4e5276e0a1ffbb20", "committedDate": "2023-05-21 09:00:35 +0800", "message": "[refactor](cluster)(step-2) remove cluster related to Backend  (#19842)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NDgwMw==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514074803", "body": "For a  general balance interface.  method name `getCachedSrcBackendId` is not very clear.   `delete the replica of a specified be` in  `getCachedSrcBackendId` is also strange.", "bodyText": "For a  general balance interface.  method name getCachedSrcBackendId is not very clear.   delete the replica of a specified be in  getCachedSrcBackendId is also strange.", "bodyHTML": "<p dir=\"auto\">For a  general balance interface.  method name <code>getCachedSrcBackendId</code> is not very clear.   <code>delete the replica of a specified be</code> in  <code>getCachedSrcBackendId</code> is also strange.</p>", "author": "kangkaisen", "createdAt": "2020-10-29T08:17:44Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                           AgentBatchTask batchTask) throws SchedException;\n+\n+    public Long getCachedSrcBackendId(Long tabletId) {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE0ODgzNA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514148834", "bodyText": "It does seem odd, I'll reconsider the naming.\nAnd it's better to use replicaId than use backendId. That'll be clear.", "author": "vagetablechicken", "createdAt": "2020-10-29T10:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NDgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyNzgyOQ==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514927829", "bodyText": "* 3. getSrcReplicaId: if the rebalance strategy wants to delete the src replica,\n * override this func.\n\nDo a delete operation in a get method, I still think which is confusing.", "author": "kangkaisen", "createdAt": "2020-10-30T08:06:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NDgwMw=="}], "type": "inlineReview", "revised_code": {"commit": "4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 189caec695..8beb16352f 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -70,7 +70,7 @@ public abstract class Rebalancer {\n     public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n                                            AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getCachedSrcBackendId(Long tabletId) {\n+    public Long getSrcBackendId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 8beb16352f..c9f354a504 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -70,7 +70,7 @@ public abstract class Rebalancer {\n     public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n                                            AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getSrcBackendId(Long tabletId) {\n+    public Long getSrcReplicaId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "4ee5cd1d3f855707967a4dad5da544df0e133577", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex c9f354a504..c207cd9d9c 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -67,10 +68,23 @@ public abstract class Rebalancer {\n     protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n             String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n \n-    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n-                                           AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getSrcReplicaId(Long tabletId) {\n+    public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                  AgentBatchTask batchTask) throws SchedException {\n+        completePlan(tabletCtx, backendsWorkingSlots);\n+        batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n+    }\n+\n+    // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n+    // 1. If you generate {tabletId, srcReplica, destReplica} in selectAlternativeTablets(), it may be invalid at\n+    // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n+    // You should check the moves' validation.\n+    // 2. If you want to generate {srcReplica, destReplica} here, just do it.\n+    // 3. You should check the path slots of src & dest.\n+    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+            throws SchedException;\n+\n+    public Long getToDeleteReplicaId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "8bb3ce37b814a5f80141b4f5ab76127971cae20e", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex c207cd9d9c..e0bf5f7d14 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -65,23 +65,25 @@ public abstract class Rebalancer {\n         return alternativeTablets;\n     }\n \n+    // The return TabletSchedCtx should have the tablet id at least. {srcReplica, destBe} can be complete here or\n+    // later(when createBalanceTask called).\n     protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n             String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n \n \n     public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n                                   AgentBatchTask batchTask) throws SchedException {\n-        completePlan(tabletCtx, backendsWorkingSlots);\n+        completeSchedCtx(tabletCtx, backendsWorkingSlots);\n         batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n     }\n \n     // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n-    // 1. If you generate {tabletId, srcReplica, destReplica} in selectAlternativeTablets(), it may be invalid at\n+    // 1. If you generate {tabletId, srcReplica, destBe} in selectAlternativeTablets(), it may be invalid at\n     // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n     // You should check the moves' validation.\n-    // 2. If you want to generate {srcReplica, destReplica} here, just do it.\n+    // 2. If you want to generate {srcReplica, destBe} here, just do it.\n     // 3. You should check the path slots of src & dest.\n-    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+    protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n             throws SchedException;\n \n     public Long getToDeleteReplicaId(Long tabletId) {\n", "next_change": null}]}}]}}]}}]}, "revised_code_in_main": {"commit": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 189caec695..e0bf5f7d14 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -64,13 +65,28 @@ public abstract class Rebalancer {\n         return alternativeTablets;\n     }\n \n+    // The return TabletSchedCtx should have the tablet id at least. {srcReplica, destBe} can be complete here or\n+    // later(when createBalanceTask called).\n     protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n             String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n \n-    public abstract void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n-                                           AgentBatchTask batchTask) throws SchedException;\n \n-    public Long getCachedSrcBackendId(Long tabletId) {\n+    public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                  AgentBatchTask batchTask) throws SchedException {\n+        completeSchedCtx(tabletCtx, backendsWorkingSlots);\n+        batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n+    }\n+\n+    // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n+    // 1. If you generate {tabletId, srcReplica, destBe} in selectAlternativeTablets(), it may be invalid at\n+    // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n+    // You should check the moves' validation.\n+    // 2. If you want to generate {srcReplica, destBe} here, just do it.\n+    // 3. You should check the path slots of src & dest.\n+    protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+            throws SchedException;\n+\n+    public Long getToDeleteReplicaId(Long tabletId) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex e0bf5f7d14..f854ef0c23 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -86,7 +86,7 @@ public abstract class Rebalancer {\n     protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n             throws SchedException;\n \n-    public Long getToDeleteReplicaId(Long tabletId) {\n+    public Long getToDeleteReplicaId(TabletSchedCtx tabletCtx) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex f854ef0c23..1fca40652c 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -90,7 +90,7 @@ public abstract class Rebalancer {\n         return -1L;\n     }\n \n-    public void updateLoadStatistic(Map<String, ClusterLoadStatistic> statisticMap) {\n+    public void updateLoadStatistic(Table<String, Tag, ClusterLoadStatistic> statisticMap) {\n         this.statisticMap = statisticMap;\n     }\n }\n", "next_change": {"commit": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 1fca40652c..a7177c2f54 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -93,4 +101,21 @@ public abstract class Rebalancer {\n     public void updateLoadStatistic(Table<String, Tag, ClusterLoadStatistic> statisticMap) {\n         this.statisticMap = statisticMap;\n     }\n+\n+    public void addPrioBackends(List<Backend> backends, long timeoutS) {\n+        long currentTimeMillis = System.currentTimeMillis();\n+        for (Backend backend : backends) {\n+            prioBackends.put(backend.getId(), currentTimeMillis + timeoutS);\n+        }\n+    }\n+\n+    public void removePrioBackends(List<Backend> backends) {\n+        for (Backend backend : backends) {\n+            prioBackends.remove(backend.getId());\n+        }\n+    }\n+\n+    public boolean hasPrioBackends() {\n+        return !prioBackends.isEmpty();\n+    }\n }\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "message": "Merge commit", "committedDate": null}, {"oid": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "committedDate": "2020-12-31 09:41:38 +0800", "message": "[Rebalancer] support partition rebalancer (#5010)"}, {"oid": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "committedDate": "2021-09-04 10:59:35 +0800", "message": "[Feature][ResourceTag] Support Resource Tag (#6203)"}, {"oid": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "committedDate": "2022-03-28 10:03:21 +0800", "message": "[feature](balance) Support balance between disks on a single BE (#8553)"}, {"oid": "8a0097cfb932c0ff480ff1472009d597036a938b", "committedDate": "2022-05-12 20:14:38 +0800", "message": "[style](java) format fe code with some check rules (#9460)"}, {"oid": "b7b78ae7079a61eadab0e78d9e9c9792dd0af1b3", "committedDate": "2022-06-17 21:02:45 +0800", "message": "[style](fe)the last step of fe CheckStyle (#10134)"}, {"oid": "a7f3bfec89a8228d25590f2d4e5276e0a1ffbb20", "committedDate": "2023-05-21 09:00:35 +0800", "message": "[refactor](cluster)(step-2) remove cluster related to Backend  (#19842)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514077422", "body": "For a balance, the core strategy is how to choose which tablet, choose src backend, choose dest backend. But I don't see the interface about how to choose dest backend.", "bodyText": "For a balance, the core strategy is how to choose which tablet, choose src backend, choose dest backend. But I don't see the interface about how to choose dest backend.", "bodyHTML": "<p dir=\"auto\">For a balance, the core strategy is how to choose which tablet, choose src backend, choose dest backend. But I don't see the interface about how to choose dest backend.</p>", "author": "kangkaisen", "createdAt": "2020-10-29T08:22:11Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * override this func.\n+ * NOTICE:\n+ * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n+ * invalid when we createBalanceTask(), you should check the moves' validation.\n+ */\n+public abstract class Rebalancer {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1MzM0Mw==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514153343", "bodyText": "Choosing dest be can be done before generating a clone task in createBalanceTask. The base class doesn't limit it.\nFor example:\nThe origin rebalance algo: selectAlternativeTablets just select a tablet, choose dest be in createBalanceTask\nThe algo which has a concrete move: selectAlternativeTablets will select a tablet and src be, dest be. In createBalanceTask, we should check the validation.", "author": "vagetablechicken", "createdAt": "2020-10-29T10:26:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyMjM2MQ==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514922361", "bodyText": "Choosing dest be can be done before generating a clone task in createBalanceTask. The base class doesn't limit it.\n\nHow to choose the dest be is core for balance strategy, if the base class doesn't limit it, what's the meaning of balance base class.", "author": "kangkaisen", "createdAt": "2020-10-30T07:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTUwOTA5NA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r515509094", "bodyText": "In origin LoadBalancer class, both \"Choose Source\" and \"Choose Destination\" are done in createBalanceTask.\n@kangkaisen  may think that as a base class, these two interfaces need to be explicitly provided. But I think this is just a design pattern consideration, for the actual code implementation, there is little difference between the two. One is to implement the interfaces separately, and the other is to implement them in one interface.\nThe former has a clearer interface meaning, while the latter currently has relatively fewer code changes.", "author": "morningman", "createdAt": "2020-10-31T15:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3NzQyMg=="}], "type": "inlineReview", "revised_code": {"commit": "4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 189caec695..8beb16352f 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -35,11 +35,11 @@ import java.util.Map;\n  * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n  * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n  * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n- * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * 3. getSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n  * override this func.\n  * NOTICE:\n  * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n- * invalid when we createBalanceTask(), you should check the moves' validation.\n+ * invalid when we generating a clone task in createBalanceTask(), you should check the moves' validation.\n  */\n public abstract class Rebalancer {\n     // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n", "next_change": {"commit": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 8beb16352f..c9f354a504 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -35,7 +35,7 @@ import java.util.Map;\n  * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n  * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n  * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n- * 3. getSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n+ * 3. getSrcReplicaId: if the rebalance strategy wants to delete the src replica,\n  * override this func.\n  * NOTICE:\n  * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n", "next_change": {"commit": "4ee5cd1d3f855707967a4dad5da544df0e133577", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex c9f354a504..c207cd9d9c 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -35,11 +35,12 @@ import java.util.Map;\n  * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n  * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n  * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n- * 3. getSrcReplicaId: if the rebalance strategy wants to delete the src replica,\n- * override this func.\n+ * 3. getToDeleteReplicaId: if the rebalance strategy wants to delete the specified replica,\n+ * override this func to let TabletScheduler know in handling redundant replica.\n  * NOTICE:\n- * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n- * invalid when we generating a clone task in createBalanceTask(), you should check the moves' validation.\n+ * 1. Adding the selected tablets by TabletScheduler may not succeed at all. And the move may be failed in some other places.\n+ * So the thing you need to know is, Rebalancer cannot know when the move is failed.\n+ * 2. If you want to make sure the move is succeed, you can assume that it's succeed when getToDeleteReplicaId called.\n  */\n public abstract class Rebalancer {\n     // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n", "next_change": null}]}}]}}]}, "revised_code_in_main": {"commit": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 189caec695..e0bf5f7d14 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -35,11 +35,12 @@ import java.util.Map;\n  * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n  * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n  * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n- * 3. getCachedSrcBackendId: if the rebalance strategy wants to delete the replica of a specified be,\n- * override this func.\n+ * 3. getToDeleteReplicaId: if the rebalance strategy wants to delete the specified replica,\n+ * override this func to let TabletScheduler know in handling redundant replica.\n  * NOTICE:\n- * It may have a long interval between selectAlternativeTablets() & createBalanceTask(). So the concrete moves may be\n- * invalid when we createBalanceTask(), you should check the moves' validation.\n+ * 1. Adding the selected tablets by TabletScheduler may not succeed at all. And the move may be failed in some other places.\n+ * So the thing you need to know is, Rebalancer cannot know when the move is failed.\n+ * 2. If you want to make sure the move is succeed, you can assume that it's succeed when getToDeleteReplicaId called.\n  */\n public abstract class Rebalancer {\n     // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n", "next_change": {"commit": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex e0bf5f7d14..1fca40652c 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -45,7 +47,7 @@ import java.util.Map;\n public abstract class Rebalancer {\n     // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n     // Only use updateLoadStatistic() to load stats.\n-    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected Table<String, Tag, ClusterLoadStatistic> statisticMap = HashBasedTable.create();\n     protected TabletInvertedIndex invertedIndex;\n     protected SystemInfoService infoService;\n \n", "next_change": {"commit": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 1fca40652c..a7177c2f54 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -50,6 +52,8 @@ public abstract class Rebalancer {\n     protected Table<String, Tag, ClusterLoadStatistic> statisticMap = HashBasedTable.create();\n     protected TabletInvertedIndex invertedIndex;\n     protected SystemInfoService infoService;\n+    // be id -> end time of prio\n+    protected Map<Long, Long> prioBackends = Maps.newConcurrentMap();\n \n     public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n         this.infoService = infoService;\n", "next_change": {"commit": "a7f3bfec89a8228d25590f2d4e5276e0a1ffbb20", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex a7177c2f54..4c3ef57546 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -42,14 +40,15 @@ import java.util.Map;\n  * 3. getToDeleteReplicaId: if the rebalance strategy wants to delete the specified replica,\n  * override this func to let TabletScheduler know in handling redundant replica.\n  * NOTICE:\n- * 1. Adding the selected tablets by TabletScheduler may not succeed at all. And the move may be failed in some other places.\n- * So the thing you need to know is, Rebalancer cannot know when the move is failed.\n+ * 1. Adding the selected tablets by TabletScheduler may not succeed at all.\n+ *  And the move may be failed in some other places. So the thing you need to know is,\n+ *  Rebalancer cannot know when the move is failed.\n  * 2. If you want to make sure the move is succeed, you can assume that it's succeed when getToDeleteReplicaId called.\n  */\n public abstract class Rebalancer {\n     // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n     // Only use updateLoadStatistic() to load stats.\n-    protected Table<String, Tag, ClusterLoadStatistic> statisticMap = HashBasedTable.create();\n+    protected Map<Tag, LoadStatisticForTag> statisticMap = Maps.newHashMap();\n     protected TabletInvertedIndex invertedIndex;\n     protected SystemInfoService infoService;\n     // be id -> end time of prio\n", "next_change": null}, {"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex a7177c2f54..4c3ef57546 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -62,7 +61,7 @@ public abstract class Rebalancer {\n \n     public List<TabletSchedCtx> selectAlternativeTablets() {\n         List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n-        for (Table.Cell<String, Tag, ClusterLoadStatistic> entry : statisticMap.cellSet()) {\n+        for (Map.Entry<Tag, LoadStatisticForTag> entry : statisticMap.entrySet()) {\n             for (TStorageMedium medium : TStorageMedium.values()) {\n                 alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getValue(), medium));\n             }\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "message": "Merge commit", "committedDate": null}, {"oid": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "committedDate": "2020-12-31 09:41:38 +0800", "message": "[Rebalancer] support partition rebalancer (#5010)"}, {"oid": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "committedDate": "2021-09-04 10:59:35 +0800", "message": "[Feature][ResourceTag] Support Resource Tag (#6203)"}, {"oid": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "committedDate": "2022-03-28 10:03:21 +0800", "message": "[feature](balance) Support balance between disks on a single BE (#8553)"}, {"oid": "8a0097cfb932c0ff480ff1472009d597036a938b", "committedDate": "2022-05-12 20:14:38 +0800", "message": "[style](java) format fe code with some check rules (#9460)"}, {"oid": "b7b78ae7079a61eadab0e78d9e9c9792dd0af1b3", "committedDate": "2022-06-17 21:02:45 +0800", "message": "[style](fe)the last step of fe CheckStyle (#10134)"}, {"oid": "a7f3bfec89a8228d25590f2d4e5276e0a1ffbb20", "committedDate": "2023-05-21 09:00:35 +0800", "message": "[refactor](cluster)(step-2) remove cluster related to Backend  (#19842)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3ODgwNA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514078804", "body": "What's the meaning of `LB` \uff1f", "bodyText": "What's the meaning of LB \uff1f", "bodyHTML": "<p dir=\"auto\">What's the meaning of <code>LB</code> \uff1f</p>", "author": "kangkaisen", "createdAt": "2020-10-29T08:24:37Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -826,12 +831,25 @@ private boolean deleteReplicaNotInCluster(TabletSchedCtx tabletCtx, boolean forc\n         return false;\n     }\n \n+    private boolean deleteSrcReplicaOfLB(TabletSchedCtx tabletCtx, boolean force) throws SchedException {", "originalCommit": "49b06d572541359eb667dfb6e8eb4a116fa02075", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE1Mzg0NA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514153844", "bodyText": "LoadBalance\uff0cI think the naming should be changed too.", "author": "vagetablechicken", "createdAt": "2020-10-29T10:27:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA3ODgwNA=="}], "type": "inlineReview", "revised_code": {"commit": "4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 21e492a9ee..70bdd0cc33 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -831,8 +832,8 @@ public class TabletScheduler extends MasterDaemon {\n         return false;\n     }\n \n-    private boolean deleteSrcReplicaOfLB(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getCachedSrcBackendId(tabletCtx.getTabletId());\n+    private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n+        Long id = rebalancer.getSrcBackendId(tabletCtx.getTabletId());\n         if (id == -1L) {\n             return false;\n         }\n", "next_change": {"commit": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 70bdd0cc33..63eea30460 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -833,11 +833,11 @@ public class TabletScheduler extends MasterDaemon {\n     }\n \n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getSrcBackendId(tabletCtx.getTabletId());\n+        Long id = rebalancer.getSrcReplicaId(tabletCtx.getTabletId());\n         if (id == -1L) {\n             return false;\n         }\n-        Replica chosenReplica = tabletCtx.getTablet().getReplicaByBackendId(id);\n+        Replica chosenReplica = tabletCtx.getTablet().getReplicaById(id);\n         if (chosenReplica != null) {\n             deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);\n             return true;\n", "next_change": {"commit": "4ee5cd1d3f855707967a4dad5da544df0e133577", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 63eea30460..25c3299f7a 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -833,7 +833,7 @@ public class TabletScheduler extends MasterDaemon {\n     }\n \n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getSrcReplicaId(tabletCtx.getTabletId());\n+        Long id = rebalancer.getToDeleteReplicaId(tabletCtx.getTabletId());\n         if (id == -1L) {\n             return false;\n         }\n", "next_change": null}]}}]}}]}, "revised_code_in_main": {"commit": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 21e492a9ee..9a2cfd6ad3 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -831,12 +851,12 @@ public class TabletScheduler extends MasterDaemon {\n         return false;\n     }\n \n-    private boolean deleteSrcReplicaOfLB(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getCachedSrcBackendId(tabletCtx.getTabletId());\n+    private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n+        Long id = rebalancer.getToDeleteReplicaId(tabletCtx.getTabletId());\n         if (id == -1L) {\n             return false;\n         }\n-        Replica chosenReplica = tabletCtx.getTablet().getReplicaByBackendId(id);\n+        Replica chosenReplica = tabletCtx.getTablet().getReplicaById(id);\n         if (chosenReplica != null) {\n             deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);\n             return true;\n", "next_change": {"commit": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 9a2cfd6ad3..349db1b994 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -852,7 +856,7 @@ public class TabletScheduler extends MasterDaemon {\n     }\n \n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getToDeleteReplicaId(tabletCtx.getTabletId());\n+        Long id = rebalancer.getToDeleteReplicaId(tabletCtx);\n         if (id == -1L) {\n             return false;\n         }\n", "next_change": {"commit": "d1a994eff9e826ad0ef9c5536d128166cb3a7006", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 349db1b994..c94181793e 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -855,6 +893,20 @@ public class TabletScheduler extends MasterDaemon {\n         return false;\n     }\n \n+    private boolean deleteReplicaNotInValidTag(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n+        Tablet tablet = tabletCtx.getTablet();\n+        List<Replica> replicas = tablet.getReplicas();\n+        Map<Tag, Short> allocMap = tabletCtx.getReplicaAlloc().getAllocMap();\n+        for (Replica replica : replicas) {\n+            Backend be = infoService.getBackend(replica.getBackendId());\n+            if (!allocMap.containsKey(be.getTag())) {\n+                deleteReplicaInternal(tabletCtx, replica, \"not in valid tag\", force);\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n         Long id = rebalancer.getToDeleteReplicaId(tabletCtx);\n         if (id == -1L) {\n", "next_change": {"commit": "344ca112af79a0d0fbc4ab8f48cb9104a15590c8", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex c94181793e..7578580563 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -913,16 +965,27 @@ public class TabletScheduler extends MasterDaemon {\n             return false;\n         }\n         Replica chosenReplica = tabletCtx.getTablet().getReplicaById(id);\n-        if (chosenReplica != null) {\n-            deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);\n-            return true;\n+        if (chosenReplica == null) {\n+            return false;\n         }\n-        return false;\n+        List<Replica> replicas = tabletCtx.getTablet().getReplicas();\n+        int eqOrNewVersionCount = 0;\n+        for (Replica replica : replicas) {\n+            if (replica.getVersion() >= chosenReplica.getVersion()) {\n+                eqOrNewVersionCount++;\n+            }\n+        }\n+        if (eqOrNewVersionCount == 1) {\n+            return false;\n+        }\n+        deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);\n+\n+        return true;\n     }\n \n     private boolean deleteReplicaOnHighLoadBackend(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n         Tag tag = chooseProperTag(tabletCtx, false);\n-        ClusterLoadStatistic statistic = statisticMap.get(tabletCtx.getCluster(), tag);\n+        LoadStatisticForTag statistic = statisticMap.get(tag);\n         if (statistic == null) {\n             return false;\n         }\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "message": "Merge commit", "committedDate": null}, {"oid": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "committedDate": "2020-12-31 09:41:38 +0800", "message": "[Rebalancer] support partition rebalancer (#5010)"}, {"oid": "f7730031b8eca90c150c400c8d67e008290a6f70", "committedDate": "2021-01-13 10:27:58 +0800", "message": "Support read and write lock in table level to reduce lock competition (#3775)"}, {"oid": "b6abcbdd35c4f2a223651601262490d639c24175", "committedDate": "2021-02-04 12:04:19 +0800", "message": "Fix 5243 Skip repair replica not in colocate group. (#5250)"}, {"oid": "abcd56c6c827dcbddf103870462e91c8497d51c6", "committedDate": "2021-06-22 09:19:12 +0800", "message": "[Enhance] Support show unrecoverable tablets (#6045)"}, {"oid": "df54b34f9843adf80d5fa753383797690e9458dd", "committedDate": "2021-09-03 13:34:49 +0800", "message": "[Catalog] Enforce null check at Catalog.getDb and Database.getTable (#6416)"}, {"oid": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "committedDate": "2021-09-04 10:59:35 +0800", "message": "[Feature][ResourceTag] Support Resource Tag (#6203)"}, {"oid": "b2f1e21a3bc1689fa144084de96a1ccb7de5484a", "committedDate": "2021-09-10 09:53:30 +0800", "message": "[Bugs] Fix some bugs (#6586)"}, {"oid": "fee8e6afc56709d1616e310fc9bb229e63439630", "committedDate": "2021-09-17 10:11:37 +0800", "message": "[Bug] Fix some bugs (#6665)"}, {"oid": "982b76c3c0d798d3ee4fd89def72db1acb20c71a", "committedDate": "2021-09-28 10:37:42 +0800", "message": "[Bug] Fix resource tag bug, add documents and some other bug fix (#6708)"}, {"oid": "2d298143ccb6876b1817f93b7ad7990fe75a2e4a", "committedDate": "2021-10-25 10:07:04 +0800", "message": "[Bug] Fix bug of decommission (#6826)"}, {"oid": "fbab8afe24385704ce91c7363be2770b42e138b5", "committedDate": "2021-11-30 22:08:32 +0800", "message": "[feature] Support disable query and load for backend to make Doris more robust and set default value to 1 for max_query_retry_time (#7155)"}, {"oid": "db57c42c8383a94205161a705184e157face93c9", "committedDate": "2021-12-09 22:34:57 +0800", "message": "[improvement](compaction)(tablet repair) Add missing rowsets in compaction status url and support force dropping redundant replica (#7283)"}, {"oid": "bf4a867e855c2cf717a3cbd9fb6115f97cead639", "committedDate": "2022-01-04 10:28:14 +0800", "message": "[improvement](tablet-repair) add a config repair_slow_replica (#7423)"}, {"oid": "e1374d8536a23daae99e5b2b11c93fa29bc40177", "committedDate": "2022-01-06 00:08:06 +0800", "message": "[fix](tablet-scheduler) Fix decommission backend bug (#7563)"}, {"oid": "d1a994eff9e826ad0ef9c5536d128166cb3a7006", "committedDate": "2022-01-13 23:11:37 +0800", "message": "[fix](cpu-resource)(resource-tag) Allow set cpu_resource_limit to -1 and fix resource tag bug(#6830)"}, {"oid": "3494c8973b91d725cff1c4c20e87bcb1e6f4f300", "committedDate": "2022-01-18 10:26:36 +0800", "message": "[improvement](colocation) Add a new config to delay the relocation of colocation group (#7656)"}, {"oid": "ecbd4bcae06c3c154139dce52995caab8c3a2ac7", "committedDate": "2022-02-08 10:01:52 +0800", "message": "[fix](catalog) Fix bug that The MetaObject lock design of fe would cause some problems with consistent meta when catalog do replay operation (#6650)"}, {"oid": "a6bf8c13eb2e2ba05b866db02f872df1ac775638", "committedDate": "2022-02-16 11:55:04 +0800", "message": "[Feature](Transaction) Support two phase commit (2PC) for stream load (#7473)"}, {"oid": "ddf08cc207dec9d46d2d1c084ae39d2c892a376f", "committedDate": "2022-02-25 11:08:29 +0800", "message": "[refactor](fe) Remove version hash on FE side (#8099)"}, {"oid": "c56a372e066c0c088c2aa86e984ba13a8f821d1a", "committedDate": "2022-03-03 22:30:35 +0800", "message": "[improvement][fix](grouping-set)(tablet-repair) optimize compaction too slow replica process, (#8123)"}, {"oid": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "committedDate": "2022-03-28 10:03:21 +0800", "message": "[feature](balance) Support balance between disks on a single BE (#8553)"}, {"oid": "8a0097cfb932c0ff480ff1472009d597036a938b", "committedDate": "2022-05-12 20:14:38 +0800", "message": "[style](java) format fe code with some check rules (#9460)"}, {"oid": "2ba81899d0d017a6599de48dc8620ecae366bd74", "committedDate": "2022-05-17 22:36:30 +0800", "message": "[fix] fix bug that replica can not be repaired duo to DECOMMISSION state (#9424)"}, {"oid": "e701c057dc675babe7a859e151287fea7cd5c850", "committedDate": "2022-05-26 16:56:20 +0800", "message": "[style](fe) wrap and whitespace rules (#9764)"}, {"oid": "c996334ad151eb8a2b21970d1a4c3505775021ae", "committedDate": "2022-06-03 15:47:40 +0800", "message": "[improvement] Optimize send fragment logic to reduce send fragment timeout error (#9720)"}, {"oid": "f4e2f78a1a911b907ba8e73156a67dadb9193acc", "committedDate": "2022-06-15 09:52:56 +0800", "message": "[fix] Fix the bug that data balance causes tablet loss (#9971)"}, {"oid": "b7b78ae7079a61eadab0e78d9e9c9792dd0af1b3", "committedDate": "2022-06-17 21:02:45 +0800", "message": "[style](fe)the last step of fe CheckStyle (#10134)"}, {"oid": "7fe4b20da3abe0110b9694aff9a9be3215fe775d", "committedDate": "2022-06-25 21:51:54 +0800", "message": "[feature-wip](multi-catalog) refactor catalog interface (#10320)"}, {"oid": "401203da6ad6b1427c1d82f5cb40601044e79a36", "committedDate": "2022-07-15 18:00:48 +0800", "message": "[feature](code-data) move cold data to object storage without losing any feature(FE) (#10693)"}, {"oid": "6751e5b23c8bee302a6802638bd78739128b4355", "committedDate": "2022-07-15 19:59:00 +0800", "message": "[fix](alter)(tablet-scheduler) fix unexpected exception with compaction_too_slow message when add rollup for olap table (#10827)"}, {"oid": "9adbd8abbd57934debd411cf46d095fa8af02f26", "committedDate": "2022-07-18 16:50:45 +0800", "message": "[feature](resource-tag) support multi tag for a single Backend (#10901)"}, {"oid": "09224d7c7410605dfdb0afccdc67065c713815c8", "committedDate": "2022-07-26 15:49:08 +0800", "message": "[refactor] Rename Catalog to Env (#10702)"}, {"oid": "adfef85c0ca0093927c9bf447a2f42e7fbabd08e", "committedDate": "2022-08-22 08:27:40 +0800", "message": "[improve](fe): use `Pair.of` to replace `new Pair<>()` (#11945)"}, {"oid": "c944496fb41046596bb6ea599f019c60a559eff2", "committedDate": "2022-09-02 20:46:39 +0800", "message": "[chore](log) add cluster and tag message to exception (#12287)"}, {"oid": "17ba40f947ee505677107fe776de75ff8555fcf8", "committedDate": "2022-10-25 21:44:33 +0800", "message": "[feature-wip](CN Node)Support compute node (#13231)"}, {"oid": "620a137bd77df22016805e060f9762d5d311ee5d", "committedDate": "2022-11-05 19:20:23 +0800", "message": "[enhancement](test) support tablet repair and balance process in ut (#13940)"}, {"oid": "91bd76a9028e0cc2d3eadf38165af740615899f3", "committedDate": "2022-11-21 15:40:43 +0800", "message": "[enhancement](FE) use forEach() to replace stream().forEach() (#14039)"}, {"oid": "1c6c28b8fb05bba6a0bcde65fa85a4d31d4c282b", "committedDate": "2023-02-19 21:30:18 +0800", "message": "[Enhance](ComputeNode) K8sDeployManager support domain (#16897)"}, {"oid": "b129c9901bf46cba0e4f69dc87213c4ea24171f8", "committedDate": "2023-05-11 00:44:48 +0800", "message": "[improvement](FQDN)Change the implementation of fqdn (#19123)"}, {"oid": "777bdce5a563b40bfa805386c88fae39e605fd1c", "committedDate": "2023-05-20 15:59:26 +0800", "message": "[minor](clone) add more debug log for tablet scheduler (#19892)"}, {"oid": "a7f3bfec89a8228d25590f2d4e5276e0a1ffbb20", "committedDate": "2023-05-21 09:00:35 +0800", "message": "[refactor](cluster)(step-2) remove cluster related to Backend  (#19842)"}, {"oid": "04415d0b357310927a4c3f0d006fc52ed4acc705", "committedDate": "2023-05-25 13:39:42 +0800", "message": "[opt](balance) add config balance_slot_num_per_path (#19869)"}, {"oid": "344ca112af79a0d0fbc4ab8f48cb9104a15590c8", "committedDate": "2023-05-29 09:00:51 +0800", "message": "[fix] (clone)  fix drop biggest version replica during reblance step (#20107)"}, {"oid": "13f1b90768a9523b88335b3b900f6b48e978545d", "committedDate": "2023-06-06 15:38:01 +0800", "message": "[Fix] (tablet) fix tablet queryable set (#20413) (#20414)"}]}, {"oid": "4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "url": "https://github.com/apache/incubator-doris/commit/4e16fbcf49cb24fcdc7d70f2f6d3e7e75b6a5abe", "message": "[] fix naming", "committedDate": "2020-10-29T10:35:33Z", "type": "commit"}, {"oid": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "url": "https://github.com/apache/incubator-doris/commit/3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "message": "[] fix", "committedDate": "2020-10-30T02:41:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyMjg3MA==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r514922870", "body": "I don't understand why we need to delete the src replica of rebalance?", "bodyText": "I don't understand why we need to delete the src replica of rebalance?", "bodyHTML": "<p dir=\"auto\">I don't understand why we need to delete the src replica of rebalance?</p>", "author": "kangkaisen", "createdAt": "2020-10-30T07:54:43Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java", "diffHunk": "@@ -826,12 +832,25 @@ private boolean deleteReplicaNotInCluster(TabletSchedCtx tabletCtx, boolean forc\n         return false;\n     }\n \n+    private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n+        Long id = rebalancer.getSrcReplicaId(tabletCtx.getTabletId());\n+        if (id == -1L) {\n+            return false;\n+        }\n+        Replica chosenReplica = tabletCtx.getTablet().getReplicaById(id);\n+        if (chosenReplica != null) {\n+            deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);", "originalCommit": "3731d4a2f80f6e67fcf1d97d7dc73488cff4fb6b", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "4ee5cd1d3f855707967a4dad5da544df0e133577", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 63eea30460..25c3299f7a 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -833,7 +833,7 @@ public class TabletScheduler extends MasterDaemon {\n     }\n \n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getSrcReplicaId(tabletCtx.getTabletId());\n+        Long id = rebalancer.getToDeleteReplicaId(tabletCtx.getTabletId());\n         if (id == -1L) {\n             return false;\n         }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 63eea30460..9a2cfd6ad3 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -833,7 +852,7 @@ public class TabletScheduler extends MasterDaemon {\n     }\n \n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getSrcReplicaId(tabletCtx.getTabletId());\n+        Long id = rebalancer.getToDeleteReplicaId(tabletCtx.getTabletId());\n         if (id == -1L) {\n             return false;\n         }\n", "next_change": {"commit": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 9a2cfd6ad3..349db1b994 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -852,7 +856,7 @@ public class TabletScheduler extends MasterDaemon {\n     }\n \n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n-        Long id = rebalancer.getToDeleteReplicaId(tabletCtx.getTabletId());\n+        Long id = rebalancer.getToDeleteReplicaId(tabletCtx);\n         if (id == -1L) {\n             return false;\n         }\n", "next_change": {"commit": "d1a994eff9e826ad0ef9c5536d128166cb3a7006", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex 349db1b994..c94181793e 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -855,6 +893,20 @@ public class TabletScheduler extends MasterDaemon {\n         return false;\n     }\n \n+    private boolean deleteReplicaNotInValidTag(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n+        Tablet tablet = tabletCtx.getTablet();\n+        List<Replica> replicas = tablet.getReplicas();\n+        Map<Tag, Short> allocMap = tabletCtx.getReplicaAlloc().getAllocMap();\n+        for (Replica replica : replicas) {\n+            Backend be = infoService.getBackend(replica.getBackendId());\n+            if (!allocMap.containsKey(be.getTag())) {\n+                deleteReplicaInternal(tabletCtx, replica, \"not in valid tag\", force);\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n     private boolean deleteReplicaChosenByRebalancer(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n         Long id = rebalancer.getToDeleteReplicaId(tabletCtx);\n         if (id == -1L) {\n", "next_change": {"commit": "344ca112af79a0d0fbc4ab8f48cb9104a15590c8", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\nindex c94181793e..7578580563 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/TabletScheduler.java\n", "chunk": "@@ -913,16 +965,27 @@ public class TabletScheduler extends MasterDaemon {\n             return false;\n         }\n         Replica chosenReplica = tabletCtx.getTablet().getReplicaById(id);\n-        if (chosenReplica != null) {\n-            deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);\n-            return true;\n+        if (chosenReplica == null) {\n+            return false;\n         }\n-        return false;\n+        List<Replica> replicas = tabletCtx.getTablet().getReplicas();\n+        int eqOrNewVersionCount = 0;\n+        for (Replica replica : replicas) {\n+            if (replica.getVersion() >= chosenReplica.getVersion()) {\n+                eqOrNewVersionCount++;\n+            }\n+        }\n+        if (eqOrNewVersionCount == 1) {\n+            return false;\n+        }\n+        deleteReplicaInternal(tabletCtx, chosenReplica, \"src replica of rebalance\", force);\n+\n+        return true;\n     }\n \n     private boolean deleteReplicaOnHighLoadBackend(TabletSchedCtx tabletCtx, boolean force) throws SchedException {\n         Tag tag = chooseProperTag(tabletCtx, false);\n-        ClusterLoadStatistic statistic = statisticMap.get(tabletCtx.getCluster(), tag);\n+        LoadStatisticForTag statistic = statisticMap.get(tag);\n         if (statistic == null) {\n             return false;\n         }\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "message": "Merge commit", "committedDate": null}, {"oid": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "committedDate": "2020-12-31 09:41:38 +0800", "message": "[Rebalancer] support partition rebalancer (#5010)"}, {"oid": "f7730031b8eca90c150c400c8d67e008290a6f70", "committedDate": "2021-01-13 10:27:58 +0800", "message": "Support read and write lock in table level to reduce lock competition (#3775)"}, {"oid": "b6abcbdd35c4f2a223651601262490d639c24175", "committedDate": "2021-02-04 12:04:19 +0800", "message": "Fix 5243 Skip repair replica not in colocate group. (#5250)"}, {"oid": "abcd56c6c827dcbddf103870462e91c8497d51c6", "committedDate": "2021-06-22 09:19:12 +0800", "message": "[Enhance] Support show unrecoverable tablets (#6045)"}, {"oid": "df54b34f9843adf80d5fa753383797690e9458dd", "committedDate": "2021-09-03 13:34:49 +0800", "message": "[Catalog] Enforce null check at Catalog.getDb and Database.getTable (#6416)"}, {"oid": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "committedDate": "2021-09-04 10:59:35 +0800", "message": "[Feature][ResourceTag] Support Resource Tag (#6203)"}, {"oid": "b2f1e21a3bc1689fa144084de96a1ccb7de5484a", "committedDate": "2021-09-10 09:53:30 +0800", "message": "[Bugs] Fix some bugs (#6586)"}, {"oid": "fee8e6afc56709d1616e310fc9bb229e63439630", "committedDate": "2021-09-17 10:11:37 +0800", "message": "[Bug] Fix some bugs (#6665)"}, {"oid": "982b76c3c0d798d3ee4fd89def72db1acb20c71a", "committedDate": "2021-09-28 10:37:42 +0800", "message": "[Bug] Fix resource tag bug, add documents and some other bug fix (#6708)"}, {"oid": "2d298143ccb6876b1817f93b7ad7990fe75a2e4a", "committedDate": "2021-10-25 10:07:04 +0800", "message": "[Bug] Fix bug of decommission (#6826)"}, {"oid": "fbab8afe24385704ce91c7363be2770b42e138b5", "committedDate": "2021-11-30 22:08:32 +0800", "message": "[feature] Support disable query and load for backend to make Doris more robust and set default value to 1 for max_query_retry_time (#7155)"}, {"oid": "db57c42c8383a94205161a705184e157face93c9", "committedDate": "2021-12-09 22:34:57 +0800", "message": "[improvement](compaction)(tablet repair) Add missing rowsets in compaction status url and support force dropping redundant replica (#7283)"}, {"oid": "bf4a867e855c2cf717a3cbd9fb6115f97cead639", "committedDate": "2022-01-04 10:28:14 +0800", "message": "[improvement](tablet-repair) add a config repair_slow_replica (#7423)"}, {"oid": "e1374d8536a23daae99e5b2b11c93fa29bc40177", "committedDate": "2022-01-06 00:08:06 +0800", "message": "[fix](tablet-scheduler) Fix decommission backend bug (#7563)"}, {"oid": "d1a994eff9e826ad0ef9c5536d128166cb3a7006", "committedDate": "2022-01-13 23:11:37 +0800", "message": "[fix](cpu-resource)(resource-tag) Allow set cpu_resource_limit to -1 and fix resource tag bug(#6830)"}, {"oid": "3494c8973b91d725cff1c4c20e87bcb1e6f4f300", "committedDate": "2022-01-18 10:26:36 +0800", "message": "[improvement](colocation) Add a new config to delay the relocation of colocation group (#7656)"}, {"oid": "ecbd4bcae06c3c154139dce52995caab8c3a2ac7", "committedDate": "2022-02-08 10:01:52 +0800", "message": "[fix](catalog) Fix bug that The MetaObject lock design of fe would cause some problems with consistent meta when catalog do replay operation (#6650)"}, {"oid": "a6bf8c13eb2e2ba05b866db02f872df1ac775638", "committedDate": "2022-02-16 11:55:04 +0800", "message": "[Feature](Transaction) Support two phase commit (2PC) for stream load (#7473)"}, {"oid": "ddf08cc207dec9d46d2d1c084ae39d2c892a376f", "committedDate": "2022-02-25 11:08:29 +0800", "message": "[refactor](fe) Remove version hash on FE side (#8099)"}, {"oid": "c56a372e066c0c088c2aa86e984ba13a8f821d1a", "committedDate": "2022-03-03 22:30:35 +0800", "message": "[improvement][fix](grouping-set)(tablet-repair) optimize compaction too slow replica process, (#8123)"}, {"oid": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "committedDate": "2022-03-28 10:03:21 +0800", "message": "[feature](balance) Support balance between disks on a single BE (#8553)"}, {"oid": "8a0097cfb932c0ff480ff1472009d597036a938b", "committedDate": "2022-05-12 20:14:38 +0800", "message": "[style](java) format fe code with some check rules (#9460)"}, {"oid": "2ba81899d0d017a6599de48dc8620ecae366bd74", "committedDate": "2022-05-17 22:36:30 +0800", "message": "[fix] fix bug that replica can not be repaired duo to DECOMMISSION state (#9424)"}, {"oid": "e701c057dc675babe7a859e151287fea7cd5c850", "committedDate": "2022-05-26 16:56:20 +0800", "message": "[style](fe) wrap and whitespace rules (#9764)"}, {"oid": "c996334ad151eb8a2b21970d1a4c3505775021ae", "committedDate": "2022-06-03 15:47:40 +0800", "message": "[improvement] Optimize send fragment logic to reduce send fragment timeout error (#9720)"}, {"oid": "f4e2f78a1a911b907ba8e73156a67dadb9193acc", "committedDate": "2022-06-15 09:52:56 +0800", "message": "[fix] Fix the bug that data balance causes tablet loss (#9971)"}, {"oid": "b7b78ae7079a61eadab0e78d9e9c9792dd0af1b3", "committedDate": "2022-06-17 21:02:45 +0800", "message": "[style](fe)the last step of fe CheckStyle (#10134)"}, {"oid": "7fe4b20da3abe0110b9694aff9a9be3215fe775d", "committedDate": "2022-06-25 21:51:54 +0800", "message": "[feature-wip](multi-catalog) refactor catalog interface (#10320)"}, {"oid": "401203da6ad6b1427c1d82f5cb40601044e79a36", "committedDate": "2022-07-15 18:00:48 +0800", "message": "[feature](code-data) move cold data to object storage without losing any feature(FE) (#10693)"}, {"oid": "6751e5b23c8bee302a6802638bd78739128b4355", "committedDate": "2022-07-15 19:59:00 +0800", "message": "[fix](alter)(tablet-scheduler) fix unexpected exception with compaction_too_slow message when add rollup for olap table (#10827)"}, {"oid": "9adbd8abbd57934debd411cf46d095fa8af02f26", "committedDate": "2022-07-18 16:50:45 +0800", "message": "[feature](resource-tag) support multi tag for a single Backend (#10901)"}, {"oid": "09224d7c7410605dfdb0afccdc67065c713815c8", "committedDate": "2022-07-26 15:49:08 +0800", "message": "[refactor] Rename Catalog to Env (#10702)"}, {"oid": "adfef85c0ca0093927c9bf447a2f42e7fbabd08e", "committedDate": "2022-08-22 08:27:40 +0800", "message": "[improve](fe): use `Pair.of` to replace `new Pair<>()` (#11945)"}, {"oid": "c944496fb41046596bb6ea599f019c60a559eff2", "committedDate": "2022-09-02 20:46:39 +0800", "message": "[chore](log) add cluster and tag message to exception (#12287)"}, {"oid": "17ba40f947ee505677107fe776de75ff8555fcf8", "committedDate": "2022-10-25 21:44:33 +0800", "message": "[feature-wip](CN Node)Support compute node (#13231)"}, {"oid": "620a137bd77df22016805e060f9762d5d311ee5d", "committedDate": "2022-11-05 19:20:23 +0800", "message": "[enhancement](test) support tablet repair and balance process in ut (#13940)"}, {"oid": "91bd76a9028e0cc2d3eadf38165af740615899f3", "committedDate": "2022-11-21 15:40:43 +0800", "message": "[enhancement](FE) use forEach() to replace stream().forEach() (#14039)"}, {"oid": "1c6c28b8fb05bba6a0bcde65fa85a4d31d4c282b", "committedDate": "2023-02-19 21:30:18 +0800", "message": "[Enhance](ComputeNode) K8sDeployManager support domain (#16897)"}, {"oid": "b129c9901bf46cba0e4f69dc87213c4ea24171f8", "committedDate": "2023-05-11 00:44:48 +0800", "message": "[improvement](FQDN)Change the implementation of fqdn (#19123)"}, {"oid": "777bdce5a563b40bfa805386c88fae39e605fd1c", "committedDate": "2023-05-20 15:59:26 +0800", "message": "[minor](clone) add more debug log for tablet scheduler (#19892)"}, {"oid": "a7f3bfec89a8228d25590f2d4e5276e0a1ffbb20", "committedDate": "2023-05-21 09:00:35 +0800", "message": "[refactor](cluster)(step-2) remove cluster related to Backend  (#19842)"}, {"oid": "04415d0b357310927a4c3f0d006fc52ed4acc705", "committedDate": "2023-05-25 13:39:42 +0800", "message": "[opt](balance) add config balance_slot_num_per_path (#19869)"}, {"oid": "344ca112af79a0d0fbc4ab8f48cb9104a15590c8", "committedDate": "2023-05-29 09:00:51 +0800", "message": "[fix] (clone)  fix drop biggest version replica during reblance step (#20107)"}, {"oid": "13f1b90768a9523b88335b3b900f6b48e978545d", "committedDate": "2023-06-06 15:38:01 +0800", "message": "[Fix] (tablet) fix tablet queryable set (#20413) (#20414)"}]}, {"oid": "4ee5cd1d3f855707967a4dad5da544df0e133577", "url": "https://github.com/apache/incubator-doris/commit/4ee5cd1d3f855707967a4dad5da544df0e133577", "message": "[] add completePlan & comments", "committedDate": "2020-11-02T03:50:45Z", "type": "commit"}, {"oid": "311204ccbfb6989c8626729d1ef157e5a6ddea94", "url": "https://github.com/apache/incubator-doris/commit/311204ccbfb6989c8626729d1ef157e5a6ddea94", "message": "[] comments", "committedDate": "2020-11-02T03:57:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc1NDIxMg==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r515754212", "body": "In the whole FE balance module, we don't use `Plan`. So I think we could rename it to `completeSchedCtx`?", "bodyText": "In the whole FE balance module, we don't use Plan. So I think we could rename it to completeSchedCtx?", "bodyHTML": "<p dir=\"auto\">In the whole FE balance module, we don't use <code>Plan</code>. So I think we could rename it to <code>completeSchedCtx</code>?</p>", "author": "kangkaisen", "createdAt": "2020-11-02T05:59:58Z", "path": "fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java", "diffHunk": "@@ -0,0 +1,96 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.doris.clone;\n+\n+import org.apache.doris.catalog.TabletInvertedIndex;\n+import org.apache.doris.clone.TabletScheduler.PathSlot;\n+import org.apache.doris.system.SystemInfoService;\n+import org.apache.doris.task.AgentBatchTask;\n+import org.apache.doris.thrift.TStorageMedium;\n+\n+import com.google.common.collect.Lists;\n+\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+/*\n+ * Rebalancer is responsible for\n+ * 1. selectAlternativeTablets: selecting alternative tablets by one rebalance strategy,\n+ * and return them to tablet scheduler(maybe contains the concrete moves, or maybe not).\n+ * 2. createBalanceTask: given a tablet, try to create a clone task for this tablet.\n+ * 3. getToDeleteReplicaId: if the rebalance strategy wants to delete the specified replica,\n+ * override this func to let TabletScheduler know in handling redundant replica.\n+ * NOTICE:\n+ * 1. Adding the selected tablets by TabletScheduler may not succeed at all. And the move may be failed in some other places.\n+ * So the thing you need to know is, Rebalancer cannot know when the move is failed.\n+ * 2. If you want to make sure the move is succeed, you can assume that it's succeed when getToDeleteReplicaId called.\n+ */\n+public abstract class Rebalancer {\n+    // When Rebalancer init, the statisticMap is usually empty. So it's no need to be an arg.\n+    // Only use updateLoadStatistic() to load stats.\n+    protected Map<String, ClusterLoadStatistic> statisticMap = new HashMap<>();\n+    protected TabletInvertedIndex invertedIndex;\n+    protected SystemInfoService infoService;\n+\n+    public Rebalancer(SystemInfoService infoService, TabletInvertedIndex invertedIndex) {\n+        this.infoService = infoService;\n+        this.invertedIndex = invertedIndex;\n+    }\n+\n+    public List<TabletSchedCtx> selectAlternativeTablets() {\n+        List<TabletSchedCtx> alternativeTablets = Lists.newArrayList();\n+        for (Map.Entry<String, ClusterLoadStatistic> entry : statisticMap.entrySet()) {\n+            for (TStorageMedium medium : TStorageMedium.values()) {\n+                alternativeTablets.addAll(selectAlternativeTabletsForCluster(entry.getKey(),\n+                        entry.getValue(), medium));\n+            }\n+        }\n+        return alternativeTablets;\n+    }\n+\n+    // The return TabletSchedCtx should have the tablet id at least. {srcReplica, destBe} can be complete here or\n+    // later(when createBalanceTask called).\n+    protected abstract List<TabletSchedCtx> selectAlternativeTabletsForCluster(\n+            String clusterName, ClusterLoadStatistic clusterStat, TStorageMedium medium);\n+\n+\n+    public void createBalanceTask(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots,\n+                                  AgentBatchTask batchTask) throws SchedException {\n+        completePlan(tabletCtx, backendsWorkingSlots);\n+        batchTask.addTask(tabletCtx.createCloneReplicaAndTask());\n+    }\n+\n+    // Before createCloneReplicaAndTask, we need to complete the TabletSchedCtx.\n+    // 1. If you generate {tabletId, srcReplica, destBe} in selectAlternativeTablets(), it may be invalid at\n+    // this point(it may have a long interval between selectAlternativeTablets & createBalanceTask).\n+    // You should check the moves' validation.\n+    // 2. If you want to generate {srcReplica, destBe} here, just do it.\n+    // 3. You should check the path slots of src & dest.\n+    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)", "originalCommit": "311204ccbfb6989c8626729d1ef157e5a6ddea94", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc2NjEwMQ==", "url": "https://github.com/apache/incubator-doris/pull/4771#discussion_r515766101", "bodyText": "\ud83d\udc4c", "author": "vagetablechicken", "createdAt": "2020-11-02T06:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc1NDIxMg=="}], "type": "inlineReview", "revised_code": {"commit": "8bb3ce37b814a5f80141b4f5ab76127971cae20e", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex fe143c476e..e0bf5f7d14 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -83,7 +83,7 @@ public abstract class Rebalancer {\n     // You should check the moves' validation.\n     // 2. If you want to generate {srcReplica, destBe} here, just do it.\n     // 3. You should check the path slots of src & dest.\n-    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+    protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n             throws SchedException;\n \n     public Long getToDeleteReplicaId(Long tabletId) {\n", "next_change": null}]}, "revised_code_in_main": {"commit": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex fe143c476e..e0bf5f7d14 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -83,7 +83,7 @@ public abstract class Rebalancer {\n     // You should check the moves' validation.\n     // 2. If you want to generate {srcReplica, destBe} here, just do it.\n     // 3. You should check the path slots of src & dest.\n-    protected abstract void completePlan(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n+    protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n             throws SchedException;\n \n     public Long getToDeleteReplicaId(Long tabletId) {\n", "next_change": {"commit": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex e0bf5f7d14..f854ef0c23 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -86,7 +86,7 @@ public abstract class Rebalancer {\n     protected abstract void completeSchedCtx(TabletSchedCtx tabletCtx, Map<Long, PathSlot> backendsWorkingSlots)\n             throws SchedException;\n \n-    public Long getToDeleteReplicaId(Long tabletId) {\n+    public Long getToDeleteReplicaId(TabletSchedCtx tabletCtx) {\n         return -1L;\n     }\n \n", "next_change": {"commit": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex f854ef0c23..1fca40652c 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -90,7 +90,7 @@ public abstract class Rebalancer {\n         return -1L;\n     }\n \n-    public void updateLoadStatistic(Map<String, ClusterLoadStatistic> statisticMap) {\n+    public void updateLoadStatistic(Table<String, Tag, ClusterLoadStatistic> statisticMap) {\n         this.statisticMap = statisticMap;\n     }\n }\n", "next_change": {"commit": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "changed_code": [{"header": "diff --git a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\nindex 1fca40652c..a7177c2f54 100644\n--- a/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n+++ b/fe/fe-core/src/main/java/org/apache/doris/clone/Rebalancer.java\n", "chunk": "@@ -93,4 +101,21 @@ public abstract class Rebalancer {\n     public void updateLoadStatistic(Table<String, Tag, ClusterLoadStatistic> statisticMap) {\n         this.statisticMap = statisticMap;\n     }\n+\n+    public void addPrioBackends(List<Backend> backends, long timeoutS) {\n+        long currentTimeMillis = System.currentTimeMillis();\n+        for (Backend backend : backends) {\n+            prioBackends.put(backend.getId(), currentTimeMillis + timeoutS);\n+        }\n+    }\n+\n+    public void removePrioBackends(List<Backend> backends) {\n+        for (Backend backend : backends) {\n+            prioBackends.remove(backend.getId());\n+        }\n+    }\n+\n+    public boolean hasPrioBackends() {\n+        return !prioBackends.isEmpty();\n+    }\n }\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "80d5f6e3d86364e81c0a5c2ffbc4549aacbd9d1d", "message": "Merge commit", "committedDate": null}, {"oid": "d7a584ac59481b9281b6bbab04d0fc27de6e9851", "committedDate": "2020-12-31 09:41:38 +0800", "message": "[Rebalancer] support partition rebalancer (#5010)"}, {"oid": "7db8841ae264012f37bb929b0f7ba6ffefe703c8", "committedDate": "2021-09-04 10:59:35 +0800", "message": "[Feature][ResourceTag] Support Resource Tag (#6203)"}, {"oid": "f96bc6257324ca329bf55907d36782c4a15aa7b3", "committedDate": "2022-03-28 10:03:21 +0800", "message": "[feature](balance) Support balance between disks on a single BE (#8553)"}, {"oid": "8a0097cfb932c0ff480ff1472009d597036a938b", "committedDate": "2022-05-12 20:14:38 +0800", "message": "[style](java) format fe code with some check rules (#9460)"}, {"oid": "b7b78ae7079a61eadab0e78d9e9c9792dd0af1b3", "committedDate": "2022-06-17 21:02:45 +0800", "message": "[style](fe)the last step of fe CheckStyle (#10134)"}, {"oid": "a7f3bfec89a8228d25590f2d4e5276e0a1ffbb20", "committedDate": "2023-05-21 09:00:35 +0800", "message": "[refactor](cluster)(step-2) remove cluster related to Backend  (#19842)"}]}, {"oid": "8bb3ce37b814a5f80141b4f5ab76127971cae20e", "url": "https://github.com/apache/incubator-doris/commit/8bb3ce37b814a5f80141b4f5ab76127971cae20e", "message": "[] fix naming", "committedDate": "2020-11-02T06:44:10Z", "type": "commit"}, {"oid": "7e3c9641954a26747d6140614f026dc808812dc6", "url": "https://github.com/apache/incubator-doris/commit/7e3c9641954a26747d6140614f026dc808812dc6", "message": "[] fix imports", "committedDate": "2020-11-02T08:52:08Z", "type": "commit"}]}