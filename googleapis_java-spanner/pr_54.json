{"pr_number": 54, "pr_title": "feat: instrument Spanner client with OpenCensus metrics", "pr_author": "mayurkale22", "pr_createdAt": "2020-01-31T19:22:05Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/54", "timeline": [{"oid": "e04d07360c9d60ba4fd66947914f3505b3982c5a", "url": "https://github.com/googleapis/java-spanner/commit/e04d07360c9d60ba4fd66947914f3505b3982c5a", "message": "minor patch", "committedDate": "2020-01-31T22:05:52Z", "type": "forcePushed"}, {"oid": "0f1ba031337fb82f80c6bc3ad670efee02b930dc", "url": "https://github.com/googleapis/java-spanner/commit/0f1ba031337fb82f80c6bc3ad670efee02b930dc", "message": "minor patch\n\nminor patch\n\nminor patch\n\nminor patch", "committedDate": "2020-01-31T22:06:38Z", "type": "forcePushed"}, {"oid": "93cbef07872e43e17756e9c37d7b135043812afd", "url": "https://github.com/googleapis/java-spanner/commit/93cbef07872e43e17756e9c37d7b135043812afd", "message": "Add session metrics\n\nminor patch\n\nminor patch\n\nminor patch\n\nminor patch\n\nminor patch\n\nminor patch", "committedDate": "2020-01-31T22:08:11Z", "type": "forcePushed"}, {"oid": "18897d8b2dfc8b96dbeb762dcae2fe80af71744e", "url": "https://github.com/googleapis/java-spanner/commit/18897d8b2dfc8b96dbeb762dcae2fe80af71744e", "message": "feat: add session metrics\nAdd active_sessions (The number of active sessions in use) and max_sessions (The number of max sessions configured the user) metrics", "committedDate": "2020-01-31T22:09:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczNjgzMw==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r373736833", "body": "I am not 100% sure on `numSessionsInUse`, may be we should use `maxSessionsInUse` to indicate active sessions in use. Please confirm.", "bodyText": "I am not 100% sure on numSessionsInUse, may be we should use maxSessionsInUse to indicate active sessions in use. Please confirm.", "bodyHTML": "<p dir=\"auto\">I am not 100% sure on <code>numSessionsInUse</code>, may be we should use <code>maxSessionsInUse</code> to indicate active sessions in use. Please confirm.</p>", "author": "mayurkale22", "createdAt": "2020-02-01T00:09:50Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1763,4 +1807,52 @@ public void onSessionCreateFailure(Throwable t, int createFailureForSessionCount\n       }\n     }\n   }\n+\n+  /**\n+   * Initializes and Creates Spanner session relevant metrics. When coupled with an exporter, it\n+   * allows users to monitor client behavior.\n+   */\n+  private void initMetricsCollection(MetricRegistry metricRegistry, List<LabelValue> labelValues) {\n+    DerivedLongGauge activeSessionsGauge =\n+        metricRegistry.addDerivedLongGauge(\n+            ACTIVE_SESSIONS,\n+            MetricOptions.builder()\n+                .setDescription(ACTIVE_SESSIONS_DESCRIPTION)\n+                .setUnit(COUNT)\n+                .setLabelKeys(SPANNER_LABEL_KEYS)\n+                .build());\n+\n+    DerivedLongGauge maxSessionsGauge =\n+        metricRegistry.addDerivedLongGauge(\n+            MAX_SESSIONS,\n+            MetricOptions.builder()\n+                .setDescription(MAX_SESSIONS_DESCRIPTION)\n+                .setUnit(COUNT)\n+                .setLabelKeys(SPANNER_LABEL_KEYS)\n+                .build());\n+\n+    // The value of a numSessionsInUse is observed from a callback function. This function is\n+    // invoked whenever metrics are collected.\n+    activeSessionsGauge.createTimeSeries(\n+        labelValues,\n+        this,\n+        new ToLongFunction<SessionPool>() {\n+          @Override\n+          public long applyAsLong(SessionPool sessionPool) {\n+            return sessionPool.numSessionsInUse;", "originalCommit": "18897d8b2dfc8b96dbeb762dcae2fe80af71744e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ0MzMyOQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374443329", "bodyText": "Agree, maxSessionInUse will be more useful. It resets every 10 minutes while the reporting interval is 1 minute. Even if it was reset every 1 minute it would not be aligned. So it needs to reset on read.", "author": "rghetia", "createdAt": "2020-02-04T02:17:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczNjgzMw=="}], "type": "inlineReview", "revised_code": {"commit": "129ceb1509c019afd66a6666cc4c48a26c7af9e6", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 738f6062..2aa53838 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1831,7 +1831,7 @@ final class SessionPool {\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n-    // The value of a numSessionsInUse is observed from a callback function. This function is\n+    // The value of a maxSessionsInUse is observed from a callback function. This function is\n     // invoked whenever metrics are collected.\n     activeSessionsGauge.createTimeSeries(\n         labelValues,\n", "next_change": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 2aa53838..c7d8d90c 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1831,7 +1834,7 @@ final class SessionPool {\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n-    // The value of a maxSessionsInUse is observed from a callback function. This function is\n+    // The value of a numSessionsInUse is observed from a callback function. This function is\n     // invoked whenever metrics are collected.\n     activeSessionsGauge.createTimeSeries(\n         labelValues,\n", "next_change": {"commit": "8bc6fc7ee2656340b4cad4bb99dfef34bceb96be", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex c7d8d90c..14fba48d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1834,7 +1834,7 @@ final class SessionPool {\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n-    // The value of a numSessionsInUse is observed from a callback function. This function is\n+    // The value of a maxSessionsInUse is observed from a callback function. This function is\n     // invoked whenever metrics are collected.\n     activeSessionsGauge.createTimeSeries(\n         labelValues,\n", "next_change": {"commit": "893b446e822464fa94f446d920416e127d3c5a84", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 14fba48d..bf22ba9d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1834,6 +1836,15 @@ final class SessionPool {\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n+    DerivedLongGauge sessionsInUseGauge =\n+        metricRegistry.addDerivedLongGauge(\n+            SESSIONS_IN_USE,\n+            MetricOptions.builder()\n+                .setDescription(SESSIONS_IN_USE_DESCRIPTION)\n+                .setUnit(COUNT)\n+                .setLabelKeys(SPANNER_LABEL_KEYS)\n+                .build());\n+\n     // The value of a maxSessionsInUse is observed from a callback function. This function is\n     // invoked whenever metrics are collected.\n     activeSessionsGauge.createTimeSeries(\n", "next_change": {"commit": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex bf22ba9d..8f047c72 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1818,36 +1818,36 @@ final class SessionPool {\n    * allows users to monitor client behavior.\n    */\n   private void initMetricsCollection(MetricRegistry metricRegistry, List<LabelValue> labelValues) {\n-    DerivedLongGauge activeSessionsGauge =\n+    DerivedLongGauge maxInUseSessionsMetric =\n         metricRegistry.addDerivedLongGauge(\n-            ACTIVE_SESSIONS,\n+            MAX_IN_USE_SESSIONS,\n             MetricOptions.builder()\n-                .setDescription(ACTIVE_SESSIONS_DESCRIPTION)\n+                .setDescription(MAX_IN_USE_SESSIONS_DESCRIPTION)\n                 .setUnit(COUNT)\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n-    DerivedLongGauge maxSessionsGauge =\n+    DerivedLongGauge maxAllowedSessionsMetric =\n         metricRegistry.addDerivedLongGauge(\n-            MAX_SESSIONS,\n+            MAX_ALLOWED_SESSIONS,\n             MetricOptions.builder()\n-                .setDescription(MAX_SESSIONS_DESCRIPTION)\n+                .setDescription(MAX_ALLOWED_SESSIONS_DESCRIPTION)\n                 .setUnit(COUNT)\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n-    DerivedLongGauge sessionsInUseGauge =\n+    DerivedLongGauge numInUseSessionsMetric =\n         metricRegistry.addDerivedLongGauge(\n-            SESSIONS_IN_USE,\n+            IN_USE_SESSIONS,\n             MetricOptions.builder()\n-                .setDescription(SESSIONS_IN_USE_DESCRIPTION)\n+                .setDescription(IN_USE_SESSIONS_DESCRIPTION)\n                 .setUnit(COUNT)\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n     // The value of a maxSessionsInUse is observed from a callback function. This function is\n     // invoked whenever metrics are collected.\n-    activeSessionsGauge.createTimeSeries(\n+    maxInUseSessionsMetric.createTimeSeries(\n         labelValues,\n         this,\n         new ToLongFunction<SessionPool>() {\n", "next_change": null}]}}]}}, {"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex c7d8d90c..14fba48d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1842,7 +1842,7 @@ final class SessionPool {\n         new ToLongFunction<SessionPool>() {\n           @Override\n           public long applyAsLong(SessionPool sessionPool) {\n-            return sessionPool.numSessionsInUse;\n+            return sessionPool.maxSessionsInUse;\n           }\n         });\n \n", "next_change": {"commit": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 14fba48d..8f047c72 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1848,7 +1859,7 @@ final class SessionPool {\n \n     // The value of a maxSessions is observed from a callback function. This function is invoked\n     // whenever metrics are collected.\n-    maxSessionsGauge.createTimeSeries(\n+    maxAllowedSessionsMetric.createTimeSeries(\n         labelValues,\n         options,\n         new ToLongFunction<SessionPoolOptions>() {\n", "next_change": null}]}}]}}, {"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 2aa53838..c7d8d90c 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1839,7 +1842,7 @@ final class SessionPool {\n         new ToLongFunction<SessionPool>() {\n           @Override\n           public long applyAsLong(SessionPool sessionPool) {\n-            return sessionPool.maxSessionsInUse;\n+            return sessionPool.numSessionsInUse;\n           }\n         });\n \n", "next_change": {"commit": "8bc6fc7ee2656340b4cad4bb99dfef34bceb96be", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex c7d8d90c..14fba48d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1842,7 +1842,7 @@ final class SessionPool {\n         new ToLongFunction<SessionPool>() {\n           @Override\n           public long applyAsLong(SessionPool sessionPool) {\n-            return sessionPool.numSessionsInUse;\n+            return sessionPool.maxSessionsInUse;\n           }\n         });\n \n", "next_change": {"commit": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 14fba48d..8f047c72 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1848,7 +1859,7 @@ final class SessionPool {\n \n     // The value of a maxSessions is observed from a callback function. This function is invoked\n     // whenever metrics are collected.\n-    maxSessionsGauge.createTimeSeries(\n+    maxAllowedSessionsMetric.createTimeSeries(\n         labelValues,\n         options,\n         new ToLongFunction<SessionPoolOptions>() {\n", "next_change": null}]}}]}}]}}, {"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 738f6062..2aa53838 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1839,7 +1839,7 @@ final class SessionPool {\n         new ToLongFunction<SessionPool>() {\n           @Override\n           public long applyAsLong(SessionPool sessionPool) {\n-            return sessionPool.numSessionsInUse;\n+            return sessionPool.maxSessionsInUse;\n           }\n         });\n \n", "next_change": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 2aa53838..c7d8d90c 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1839,7 +1842,7 @@ final class SessionPool {\n         new ToLongFunction<SessionPool>() {\n           @Override\n           public long applyAsLong(SessionPool sessionPool) {\n-            return sessionPool.maxSessionsInUse;\n+            return sessionPool.numSessionsInUse;\n           }\n         });\n \n", "next_change": {"commit": "8bc6fc7ee2656340b4cad4bb99dfef34bceb96be", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex c7d8d90c..14fba48d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1842,7 +1842,7 @@ final class SessionPool {\n         new ToLongFunction<SessionPool>() {\n           @Override\n           public long applyAsLong(SessionPool sessionPool) {\n-            return sessionPool.numSessionsInUse;\n+            return sessionPool.maxSessionsInUse;\n           }\n         });\n \n", "next_change": {"commit": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 14fba48d..8f047c72 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1848,7 +1859,7 @@ final class SessionPool {\n \n     // The value of a maxSessions is observed from a callback function. This function is invoked\n     // whenever metrics are collected.\n-    maxSessionsGauge.createTimeSeries(\n+    maxAllowedSessionsMetric.createTimeSeries(\n         labelValues,\n         options,\n         new ToLongFunction<SessionPoolOptions>() {\n", "next_change": null}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ0NDAzOQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374444039", "body": "may be \"The number of max session configured\"", "bodyText": "may be \"The number of max session configured\"", "bodyHTML": "<p dir=\"auto\">may be \"The number of max session configured\"</p>", "author": "rghetia", "createdAt": "2020-02-04T02:20:18Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner.v1.stub.metrics;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.metrics.LabelKey;\n+import io.opencensus.metrics.LabelValue;\n+\n+/** A helper class that holds OpenCensus's related constants. */\n+public class MetricRegistryConstants {\n+\n+  // The label keys are used to uniquely identify timeseries.\n+  private static final LabelKey DATABASE = LabelKey.create(\"database\", \"Target database\");\n+  private static final LabelKey INSTANCE_ID =\n+      LabelKey.create(\"instance_id\", \"Name of the instance\");\n+  private static final LabelKey LIBRARY_VERSION =\n+      LabelKey.create(\"library_version\", \"Library version\");\n+\n+  /** The label value is used to represent missing value. */\n+  private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n+\n+  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+      ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n+\n+  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+      ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n+\n+  /** Unit to represent counts. */\n+  public static final String COUNT = \"1\";\n+\n+  // The Metric name and description\n+  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n+  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";", "originalCommit": "18897d8b2dfc8b96dbeb762dcae2fe80af71744e", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "129ceb1509c019afd66a6666cc4c48a26c7af9e6", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 3c069c2e..44e2f912 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -45,5 +45,5 @@ public class MetricRegistryConstants {\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n   public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n }\n", "next_change": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 44e2f912..3c069c2e 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -45,5 +45,5 @@ public class MetricRegistryConstants {\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n   public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n }\n", "next_change": {"commit": "8bc6fc7ee2656340b4cad4bb99dfef34bceb96be", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 3c069c2e..44e2f912 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -45,5 +45,5 @@ public class MetricRegistryConstants {\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n   public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n }\n", "next_change": {"commit": "b3c56b50ce5d131d7a74305dcd7e1df493a24e18", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 44e2f912..6a0b813d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -44,6 +44,7 @@ public class MetricRegistryConstants {\n   // The Metric name and description\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n-  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION =\n+      \"Max number of sessions in use during the last 10 minutes\";\n   public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n }\n", "next_change": {"commit": "893b446e822464fa94f446d920416e127d3c5a84", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 6a0b813d..c1f6b859 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -44,7 +44,10 @@ public class MetricRegistryConstants {\n   // The Metric name and description\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String SESSIONS_IN_USE = \"cloud.google.com/java/spanner/sessions_in_use\";\n   public static final String ACTIVE_SESSIONS_DESCRIPTION =\n       \"Max number of sessions in use during the last 10 minutes\";\n   public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n+  public static final String SESSIONS_IN_USE_DESCRIPTION =\n+      \"The number of sessions checked out from the pool\";\n }\n", "next_change": {"commit": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nsimilarity index 62%\nrename from google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nrename to google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nindex c1f6b859..dad3cca2 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\n", "chunk": "@@ -32,22 +32,22 @@ public class MetricRegistryConstants {\n   /** The label value is used to represent missing value. */\n   private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n \n-  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n       ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n \n-  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n       ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n \n   /** Unit to represent counts. */\n-  public static final String COUNT = \"1\";\n+  static final String COUNT = \"1\";\n \n   // The Metric name and description\n-  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n-  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n-  public static final String SESSIONS_IN_USE = \"cloud.google.com/java/spanner/sessions_in_use\";\n-  public static final String ACTIVE_SESSIONS_DESCRIPTION =\n-      \"Max number of sessions in use during the last 10 minutes\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n-  public static final String SESSIONS_IN_USE_DESCRIPTION =\n-      \"The number of sessions checked out from the pool\";\n+  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n+  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n+  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n+      \"The max number of sessions in use during the last 10 minutes interval\";\n+  static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n+      \"The Maximum number of sessions allowed. Configurable by the user.\";\n+  static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use\";\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}}, {"oid": "129ceb1509c019afd66a6666cc4c48a26c7af9e6", "url": "https://github.com/googleapis/java-spanner/commit/129ceb1509c019afd66a6666cc4c48a26c7af9e6", "message": "fix: code reviews\n\nUse maxSessionsInUse instead of numSessionsInUse.\n\nfix: code reviews", "committedDate": "2020-02-04T04:03:49Z", "type": "forcePushed"}, {"oid": "01c202d50ff125c901988e862f4de5587dbc08cd", "url": "https://github.com/googleapis/java-spanner/commit/01c202d50ff125c901988e862f4de5587dbc08cd", "message": "fix: code reviews\n\nUse maxSessionsInUse instead of numSessionsInUse.\n\nfix: code reviews", "committedDate": "2020-02-04T04:12:54Z", "type": "forcePushed"}, {"oid": "88a54262eb662d6be1d7ad734959fcbebcd3445f", "url": "https://github.com/googleapis/java-spanner/commit/88a54262eb662d6be1d7ad734959fcbebcd3445f", "message": "fix: code reviews\n\nUse maxSessionsInUse instead of numSessionsInUse.", "committedDate": "2020-02-04T04:14:25Z", "type": "forcePushed"}, {"oid": "e0aebb612347aad1e5a5cd38dd3a76027ac5f505", "url": "https://github.com/googleapis/java-spanner/commit/e0aebb612347aad1e5a5cd38dd3a76027ac5f505", "message": "fix: code reviews\n\nUse maxSessionsInUse instead of numSessionsInUse and update the description.", "committedDate": "2020-02-04T04:17:53Z", "type": "forcePushed"}, {"oid": "8375592baefa5bcd8fa1370ae265a3b0f31da903", "url": "https://github.com/googleapis/java-spanner/commit/8375592baefa5bcd8fa1370ae265a3b0f31da903", "message": "Fix code reviews\n\nUse maxSessionsInUse instead of numSessionsInUse and update the description.", "committedDate": "2020-02-04T04:20:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNDIyNQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374814225", "body": "I think the description of this metric should be different, considering it is reading `maxSessionsInUse`. This value will only increase during a 10 minute interval, and then be reset to zero (and then start increasing again). Suggestion, something like:\r\n'Max number of sessions in use during the last 10 minutes'.\r\n\r\nI noticed the other discussion about whether to measure `numSessionsInUse` or `maxSessionsInUse`. I think both could be valuable for the user, and `numSessionsInUse` should have a description like 'The number of sessions currently in use'.", "bodyText": "I think the description of this metric should be different, considering it is reading maxSessionsInUse. This value will only increase during a 10 minute interval, and then be reset to zero (and then start increasing again). Suggestion, something like:\n'Max number of sessions in use during the last 10 minutes'.\nI noticed the other discussion about whether to measure numSessionsInUse or maxSessionsInUse. I think both could be valuable for the user, and numSessionsInUse should have a description like 'The number of sessions currently in use'.", "bodyHTML": "<p dir=\"auto\">I think the description of this metric should be different, considering it is reading <code>maxSessionsInUse</code>. This value will only increase during a 10 minute interval, and then be reset to zero (and then start increasing again). Suggestion, something like:<br>\n'Max number of sessions in use during the last 10 minutes'.</p>\n<p dir=\"auto\">I noticed the other discussion about whether to measure <code>numSessionsInUse</code> or <code>maxSessionsInUse</code>. I think both could be valuable for the user, and <code>numSessionsInUse</code> should have a description like 'The number of sessions currently in use'.</p>", "author": "olavloite", "createdAt": "2020-02-04T17:27:28Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner.v1.stub.metrics;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.metrics.LabelKey;\n+import io.opencensus.metrics.LabelValue;\n+\n+/** A helper class that holds OpenCensus's related constants. */\n+public class MetricRegistryConstants {\n+\n+  // The label keys are used to uniquely identify timeseries.\n+  private static final LabelKey DATABASE = LabelKey.create(\"database\", \"Target database\");\n+  private static final LabelKey INSTANCE_ID =\n+      LabelKey.create(\"instance_id\", \"Name of the instance\");\n+  private static final LabelKey LIBRARY_VERSION =\n+      LabelKey.create(\"library_version\", \"Library version\");\n+\n+  /** The label value is used to represent missing value. */\n+  private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n+\n+  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+      ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n+\n+  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+      ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n+\n+  /** Unit to represent counts. */\n+  public static final String COUNT = \"1\";\n+\n+  // The Metric name and description\n+  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n+  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";", "originalCommit": "8375592baefa5bcd8fa1370ae265a3b0f31da903", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyNTcxNw==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374825717", "bodyText": "Sure, will change the description for maxSessionsInUse. Could you please elaborate more on numSessionsInUse metric. How is it different from  maxSessionsInUse and how do you think it is useful for users in conjunction with maxSessionsInUse?\nJust so you know, we don't want to add too many metrics due to costs associated with exporting to backend (like stackdriver). Having said that, I am more than happy to include metrics which are meaningful (and useful) for the users to resolve/understand the production issues at some extend.", "author": "mayurkale22", "createdAt": "2020-02-04T17:50:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNDIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzOTA2OQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374839069", "bodyText": "numSessionsInUse reflects the number of sessions checked out from the pool at this very moment. Depending on probe intervals and average transaction duration, this number might often be measured to be zero for a system under low load. E.g. if the system executes 1 transaction per second, the average transaction duration is 300ms and the value is probed once every 10 seconds, the chances are big that you will often measure the value between two transactions and get a zero. On a system with higher load, measuring this value will give the user a better idea about how the distribution of the transactions are over time. If this value is relatively constant most of the time, but suddenly shows a spike that cannot be correlated with a similar sudden spike in user requests, it might be an indication of a concurrency problem somewhere (locks in the database, concurrency issues in the application itself etc.).\nmaxSessionsInUse reflects the maximum number of numSessionsInUse during the current maintenance window. A maintenance window is a hard-coded 10 minute interval. After a complete maintenance window has passed, the value is reset to 0. The value is updated every time a session is checked out of the pool by the simple calculation maxSessionsInUse = Math.max(numSessionsInUse, maxSessionsInUse).\n\nAs you can conclude from the above (and which I also just now realized ;-)), the maxSessionsInUse has a slight flaw: If no new session is checked out during a maintenance window, the value will remain zero during the entire window, even if there are sessions that are kept checked out during the entire window (i.e. the sessions were checked out during a previous maintenance window).", "author": "olavloite", "createdAt": "2020-02-04T18:16:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNDIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1NjIyOQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374856229", "bodyText": "Thanks for the explanation. I have added numSessionsInUse metric PTAL.", "author": "mayurkale22", "createdAt": "2020-02-04T18:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNDIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1NjU0NQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374856545", "bodyText": "I would like to get this PR merged before adding other metrics.", "author": "mayurkale22", "createdAt": "2020-02-04T18:50:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgxNDIyNQ=="}], "type": "inlineReview", "revised_code": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 44e2f912..3c069c2e 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -45,5 +45,5 @@ public class MetricRegistryConstants {\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n   public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n }\n", "next_change": {"commit": "8bc6fc7ee2656340b4cad4bb99dfef34bceb96be", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 3c069c2e..44e2f912 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -45,5 +45,5 @@ public class MetricRegistryConstants {\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n   public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n }\n", "next_change": {"commit": "b3c56b50ce5d131d7a74305dcd7e1df493a24e18", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 44e2f912..6a0b813d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -44,6 +44,7 @@ public class MetricRegistryConstants {\n   // The Metric name and description\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n-  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION =\n+      \"Max number of sessions in use during the last 10 minutes\";\n   public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n }\n", "next_change": {"commit": "893b446e822464fa94f446d920416e127d3c5a84", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 6a0b813d..c1f6b859 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -44,7 +44,10 @@ public class MetricRegistryConstants {\n   // The Metric name and description\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String SESSIONS_IN_USE = \"cloud.google.com/java/spanner/sessions_in_use\";\n   public static final String ACTIVE_SESSIONS_DESCRIPTION =\n       \"Max number of sessions in use during the last 10 minutes\";\n   public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n+  public static final String SESSIONS_IN_USE_DESCRIPTION =\n+      \"The number of sessions checked out from the pool\";\n }\n", "next_change": {"commit": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nsimilarity index 62%\nrename from google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nrename to google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nindex c1f6b859..dad3cca2 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\n", "chunk": "@@ -32,22 +32,22 @@ public class MetricRegistryConstants {\n   /** The label value is used to represent missing value. */\n   private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n \n-  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n       ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n \n-  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n       ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n \n   /** Unit to represent counts. */\n-  public static final String COUNT = \"1\";\n+  static final String COUNT = \"1\";\n \n   // The Metric name and description\n-  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n-  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n-  public static final String SESSIONS_IN_USE = \"cloud.google.com/java/spanner/sessions_in_use\";\n-  public static final String ACTIVE_SESSIONS_DESCRIPTION =\n-      \"Max number of sessions in use during the last 10 minutes\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n-  public static final String SESSIONS_IN_USE_DESCRIPTION =\n-      \"The number of sessions checked out from the pool\";\n+  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n+  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n+  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n+      \"The max number of sessions in use during the last 10 minutes interval\";\n+  static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n+      \"The Maximum number of sessions allowed. Configurable by the user.\";\n+  static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use\";\n }\n", "next_change": null}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2MzQ3OQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374863479", "body": "Sorry, I didn't notice this before now: Is there a specific reason that this file is placed in this package? The `com.google.cloud.spanner.v1` package and sub-packages only contain generated source files and shouldn't contain any other files. (I'm not 100% sure, but there is a good chance that re-generating the gapic client will also automatically delete all files in the package, which would mean that this file would also be deleted.)", "bodyText": "Sorry, I didn't notice this before now: Is there a specific reason that this file is placed in this package? The com.google.cloud.spanner.v1 package and sub-packages only contain generated source files and shouldn't contain any other files. (I'm not 100% sure, but there is a good chance that re-generating the gapic client will also automatically delete all files in the package, which would mean that this file would also be deleted.)", "bodyHTML": "<p dir=\"auto\">Sorry, I didn't notice this before now: Is there a specific reason that this file is placed in this package? The <code>com.google.cloud.spanner.v1</code> package and sub-packages only contain generated source files and shouldn't contain any other files. (I'm not 100% sure, but there is a good chance that re-generating the gapic client will also automatically delete all files in the package, which would mean that this file would also be deleted.)</p>", "author": "olavloite", "createdAt": "2020-02-04T19:03:25Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner.v1.stub.metrics;", "originalCommit": "4754cf586851d1aeb63ed15fe996f13a48f20cf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg4NjkxNQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374886915", "bodyText": "done in 8548f8a", "author": "mayurkale22", "createdAt": "2020-02-04T19:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2MzQ3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2ebcdf742cb5d99e150e58039e6b147815bae99", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nsimilarity index 97%\nrename from google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nrename to google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nindex c1f6b859..6fa58715 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\n", "chunk": "@@ -13,7 +13,7 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package com.google.cloud.spanner.v1.stub.metrics;\n+package com.google.cloud.spanner;\n \n import com.google.common.collect.ImmutableList;\n import io.opencensus.metrics.LabelKey;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2MzU3OQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374863579", "body": "Same as above regarding the package.", "bodyText": "Same as above regarding the package.", "bodyHTML": "<p dir=\"auto\">Same as above regarding the package.</p>", "author": "olavloite", "createdAt": "2020-02-04T19:03:40Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/v1/MetricRegistryTestUtils.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner.v1;", "originalCommit": "4754cf586851d1aeb63ed15fe996f13a48f20cf3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg4Njk5Mw==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r374886993", "bodyText": "done in 8548f8a", "author": "mayurkale22", "createdAt": "2020-02-04T19:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2MzU3OQ=="}], "type": "inlineReview", "revised_code": {"commit": "f2ebcdf742cb5d99e150e58039e6b147815bae99", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/v1/MetricRegistryTestUtils.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/MetricRegistryTestUtils.java\nsimilarity index 99%\nrename from google-cloud-spanner/src/test/java/com/google/cloud/spanner/v1/MetricRegistryTestUtils.java\nrename to google-cloud-spanner/src/test/java/com/google/cloud/spanner/MetricRegistryTestUtils.java\nindex 4114ee69..5d7e2307 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/v1/MetricRegistryTestUtils.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/MetricRegistryTestUtils.java\n", "chunk": "@@ -13,7 +13,7 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package com.google.cloud.spanner.v1;\n+package com.google.cloud.spanner;\n \n import com.google.common.collect.Maps;\n import io.opencensus.common.ToLongFunction;\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5NDcxMg==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375494712", "body": "names are confusing. I would suggest\r\n\r\n| old | new | Description |\r\n|----|------|------------|\r\n| active_sessions | max_in_use_session |  The max number of sessions concurrently in use during the current 10 minutes interval | \r\n| max sessions | max_allowed_sessions | The Maximum number of sessions allowed. Configurable by the user. |\r\n| sessions_in_use | in_use_sessions | The number of sessions currently in use | \r\n\r\nAlternatively, in_use can be replaced with 'active' in name and description.\r\nchecked out has different meaning than active/in_use. If that is appropriate, then it should be used in the name and the description.\r\n\r\n", "bodyText": "names are confusing. I would suggest\n\n\n\nold\nnew\nDescription\n\n\n\n\nactive_sessions\nmax_in_use_session\nThe max number of sessions concurrently in use during the current 10 minutes interval\n\n\nmax sessions\nmax_allowed_sessions\nThe Maximum number of sessions allowed. Configurable by the user.\n\n\nsessions_in_use\nin_use_sessions\nThe number of sessions currently in use\n\n\n\nAlternatively, in_use can be replaced with 'active' in name and description.\nchecked out has different meaning than active/in_use. If that is appropriate, then it should be used in the name and the description.", "bodyHTML": "<p dir=\"auto\">names are confusing. I would suggest</p>\n<table role=\"table\">\n<thead>\n<tr>\n<th>old</th>\n<th>new</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>active_sessions</td>\n<td>max_in_use_session</td>\n<td>The max number of sessions concurrently in use during the current 10 minutes interval</td>\n</tr>\n<tr>\n<td>max sessions</td>\n<td>max_allowed_sessions</td>\n<td>The Maximum number of sessions allowed. Configurable by the user.</td>\n</tr>\n<tr>\n<td>sessions_in_use</td>\n<td>in_use_sessions</td>\n<td>The number of sessions currently in use</td>\n</tr>\n</tbody>\n</table>\n<p dir=\"auto\">Alternatively, in_use can be replaced with 'active' in name and description.<br>\nchecked out has different meaning than active/in_use. If that is appropriate, then it should be used in the name and the description.</p>", "author": "rghetia", "createdAt": "2020-02-05T20:37:55Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.metrics.LabelKey;\n+import io.opencensus.metrics.LabelValue;\n+\n+/** A helper class that holds OpenCensus's related constants. */\n+public class MetricRegistryConstants {\n+\n+  // The label keys are used to uniquely identify timeseries.\n+  private static final LabelKey DATABASE = LabelKey.create(\"database\", \"Target database\");\n+  private static final LabelKey INSTANCE_ID =\n+      LabelKey.create(\"instance_id\", \"Name of the instance\");\n+  private static final LabelKey LIBRARY_VERSION =\n+      LabelKey.create(\"library_version\", \"Library version\");\n+\n+  /** The label value is used to represent missing value. */\n+  private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n+\n+  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+      ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n+\n+  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+      ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n+\n+  /** Unit to represent counts. */\n+  public static final String COUNT = \"1\";\n+\n+  // The Metric name and description\n+  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n+  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String SESSIONS_IN_USE = \"cloud.google.com/java/spanner/sessions_in_use\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION =\n+      \"Max number of sessions in use during the last 10 minutes\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n+  public static final String SESSIONS_IN_USE_DESCRIPTION =\n+      \"The number of sessions checked out from the pool\";", "originalCommit": "8548f8a3cff8fba7778805bdc6161454bbfdc305", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzNTM3MA==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375535370", "bodyText": "Done in e6938bc, decided to use in_use. PTAL", "author": "mayurkale22", "createdAt": "2020-02-05T22:07:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5NDcxMg=="}], "type": "inlineReview", "revised_code": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nsimilarity index 83%\nrename from google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nrename to google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex 6fa58715..3c069c2e 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -44,10 +44,6 @@ public class MetricRegistryConstants {\n   // The Metric name and description\n   public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n   public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n-  public static final String SESSIONS_IN_USE = \"cloud.google.com/java/spanner/sessions_in_use\";\n-  public static final String ACTIVE_SESSIONS_DESCRIPTION =\n-      \"Max number of sessions in use during the last 10 minutes\";\n-  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions configured\";\n-  public static final String SESSIONS_IN_USE_DESCRIPTION =\n-      \"The number of sessions checked out from the pool\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MDc2OA==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375640768", "body": "```suggestion\r\n      \"The maximum number of sessions allowed. Configurable by the user.\";\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"The Maximum number of sessions allowed. Configurable by the user.\";\n          \n          \n            \n                  \"The maximum number of sessions allowed. Configurable by the user.\";", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The <span class=\"x x-first x-last\">Maximum</span> number of sessions allowed. Configurable by the user.<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The <span class=\"x x-first x-last\">maximum</span> number of sessions allowed. Configurable by the user.<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "skuruppu", "createdAt": "2020-02-06T04:58:19Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.metrics.LabelKey;\n+import io.opencensus.metrics.LabelValue;\n+\n+/** A helper class that holds OpenCensus's related constants. */\n+class MetricRegistryConstants {\n+\n+  // The label keys are used to uniquely identify timeseries.\n+  private static final LabelKey DATABASE = LabelKey.create(\"database\", \"Target database\");\n+  private static final LabelKey INSTANCE_ID =\n+      LabelKey.create(\"instance_id\", \"Name of the instance\");\n+  private static final LabelKey LIBRARY_VERSION =\n+      LabelKey.create(\"library_version\", \"Library version\");\n+\n+  /** The label value is used to represent missing value. */\n+  private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n+\n+  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+      ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n+\n+  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+      ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n+\n+  /** Unit to represent counts. */\n+  static final String COUNT = \"1\";\n+\n+  // The Metric name and description\n+  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n+  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n+  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n+      \"The max number of sessions in use during the last 10 minutes interval\";\n+  static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n+      \"The Maximum number of sessions allowed. Configurable by the user.\";", "originalCommit": "e6938bc2f8507df551ef3ffea0e7651ca1330f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nsimilarity index 63%\nrename from google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nrename to google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex dad3cca2..3c069c2e 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -32,22 +32,18 @@ class MetricRegistryConstants {\n   /** The label value is used to represent missing value. */\n   private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n \n-  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n       ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n \n-  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n       ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n \n   /** Unit to represent counts. */\n-  static final String COUNT = \"1\";\n+  public static final String COUNT = \"1\";\n \n   // The Metric name and description\n-  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n-  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n-  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n-  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n-      \"The max number of sessions in use during the last 10 minutes interval\";\n-  static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n-      \"The Maximum number of sessions allowed. Configurable by the user.\";\n-  static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use\";\n+  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n+  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MDc4OA==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375640788", "body": "```suggestion\r\n      \"The maximum number of sessions in use during the last 10 minute interval.\";\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  \"The max number of sessions in use during the last 10 minutes interval\";\n          \n          \n            \n                  \"The maximum number of sessions in use during the last 10 minute interval.\";", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The <span class=\"x x-first x-last\">max</span> number of sessions in use during the last 10 <span class=\"x x-first x-last\">minutes</span> interval<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The <span class=\"x x-first x-last\">maximum</span> number of sessions in use during the last 10 <span class=\"x x-first x-last\">minute</span> interval<span class=\"x x-first x-last\">.</span><span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "skuruppu", "createdAt": "2020-02-06T04:58:27Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.metrics.LabelKey;\n+import io.opencensus.metrics.LabelValue;\n+\n+/** A helper class that holds OpenCensus's related constants. */\n+class MetricRegistryConstants {\n+\n+  // The label keys are used to uniquely identify timeseries.\n+  private static final LabelKey DATABASE = LabelKey.create(\"database\", \"Target database\");\n+  private static final LabelKey INSTANCE_ID =\n+      LabelKey.create(\"instance_id\", \"Name of the instance\");\n+  private static final LabelKey LIBRARY_VERSION =\n+      LabelKey.create(\"library_version\", \"Library version\");\n+\n+  /** The label value is used to represent missing value. */\n+  private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n+\n+  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+      ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n+\n+  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+      ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n+\n+  /** Unit to represent counts. */\n+  static final String COUNT = \"1\";\n+\n+  // The Metric name and description\n+  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n+  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n+  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n+      \"The max number of sessions in use during the last 10 minutes interval\";", "originalCommit": "e6938bc2f8507df551ef3ffea0e7651ca1330f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nsimilarity index 63%\nrename from google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nrename to google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex dad3cca2..3c069c2e 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -32,22 +32,18 @@ class MetricRegistryConstants {\n   /** The label value is used to represent missing value. */\n   private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n \n-  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n       ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n \n-  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n       ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n \n   /** Unit to represent counts. */\n-  static final String COUNT = \"1\";\n+  public static final String COUNT = \"1\";\n \n   // The Metric name and description\n-  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n-  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n-  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n-  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n-      \"The max number of sessions in use during the last 10 minutes interval\";\n-  static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n-      \"The Maximum number of sessions allowed. Configurable by the user.\";\n-  static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use\";\n+  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n+  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MDk1MQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375640951", "body": "```suggestion\r\n  static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use.\";\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use\";\n          \n          \n            \n              static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use.\";", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1\">IN_USE_SESSIONS_DESCRIPTION</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The number of sessions currently in use<span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1\">IN_USE_SESSIONS_DESCRIPTION</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The number of sessions currently in use<span class=\"x x-first x-last\">.</span><span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "skuruppu", "createdAt": "2020-02-06T04:59:10Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner;\n+\n+import com.google.common.collect.ImmutableList;\n+import io.opencensus.metrics.LabelKey;\n+import io.opencensus.metrics.LabelValue;\n+\n+/** A helper class that holds OpenCensus's related constants. */\n+class MetricRegistryConstants {\n+\n+  // The label keys are used to uniquely identify timeseries.\n+  private static final LabelKey DATABASE = LabelKey.create(\"database\", \"Target database\");\n+  private static final LabelKey INSTANCE_ID =\n+      LabelKey.create(\"instance_id\", \"Name of the instance\");\n+  private static final LabelKey LIBRARY_VERSION =\n+      LabelKey.create(\"library_version\", \"Library version\");\n+\n+  /** The label value is used to represent missing value. */\n+  private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n+\n+  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+      ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n+\n+  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+      ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n+\n+  /** Unit to represent counts. */\n+  static final String COUNT = \"1\";\n+\n+  // The Metric name and description\n+  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n+  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n+  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n+      \"The max number of sessions in use during the last 10 minutes interval\";\n+  static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n+      \"The Maximum number of sessions allowed. Configurable by the user.\";\n+  static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use\";", "originalCommit": "e6938bc2f8507df551ef3ffea0e7651ca1330f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nsimilarity index 63%\nrename from google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\nrename to google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\nindex dad3cca2..3c069c2e 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/v1/stub/metrics/MetricRegistryConstants.java\n", "chunk": "@@ -32,22 +32,18 @@ class MetricRegistryConstants {\n   /** The label value is used to represent missing value. */\n   private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n \n-  static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n+  public static final ImmutableList<LabelKey> SPANNER_LABEL_KEYS =\n       ImmutableList.of(DATABASE, INSTANCE_ID, LIBRARY_VERSION);\n \n-  static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n+  public static final ImmutableList<LabelValue> SPANNER_DEFAULT_LABEL_VALUES =\n       ImmutableList.of(UNSET_LABEL, UNSET_LABEL, UNSET_LABEL);\n \n   /** Unit to represent counts. */\n-  static final String COUNT = \"1\";\n+  public static final String COUNT = \"1\";\n \n   // The Metric name and description\n-  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n-  static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n-  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n-  static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n-      \"The max number of sessions in use during the last 10 minutes interval\";\n-  static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n-      \"The Maximum number of sessions allowed. Configurable by the user.\";\n-  static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use\";\n+  public static final String ACTIVE_SESSIONS = \"cloud.google.com/java/spanner/active_sessions\";\n+  public static final String MAX_SESSIONS = \"cloud.google.com/java/spanner/max_sessions\";\n+  public static final String ACTIVE_SESSIONS_DESCRIPTION = \"The number of active sessions\";\n+  public static final String MAX_SESSIONS_DESCRIPTION = \"The number of max sessions\";\n }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MTI2OQ==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375641269", "body": "```suggestion\r\n   * Initializes and creates Spanner session relevant metrics. When coupled with an exporter, it\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Initializes and Creates Spanner session relevant metrics. When coupled with an exporter, it\n          \n          \n            \n               * Initializes and creates Spanner session relevant metrics. When coupled with an exporter, it", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">   <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Initializes</span> and <span class=\"pl-smi x x-first x-last\">Creates</span> <span class=\"pl-smi\">Spanner</span> session relevant metrics. <span class=\"pl-smi\">When</span> coupled with an exporter, it</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">   <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Initializes</span> and <span class=\"x x-first x-last\">creates</span> <span class=\"pl-smi\">Spanner</span> session relevant metrics. <span class=\"pl-smi\">When</span> coupled with an exporter, it</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "skuruppu", "createdAt": "2020-02-06T05:00:55Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1763,4 +1809,73 @@ public void onSessionCreateFailure(Throwable t, int createFailureForSessionCount\n       }\n     }\n   }\n+\n+  /**\n+   * Initializes and Creates Spanner session relevant metrics. When coupled with an exporter, it", "originalCommit": "e6938bc2f8507df551ef3ffea0e7651ca1330f2d", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex 018ffd9a..c7d8d90c 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1815,48 +1816,39 @@ final class SessionPool {\n    * allows users to monitor client behavior.\n    */\n   private void initMetricsCollection(MetricRegistry metricRegistry, List<LabelValue> labelValues) {\n-    DerivedLongGauge maxInUseSessionsMetric =\n+    DerivedLongGauge activeSessionsGauge =\n         metricRegistry.addDerivedLongGauge(\n-            MAX_IN_USE_SESSIONS,\n+            ACTIVE_SESSIONS,\n             MetricOptions.builder()\n-                .setDescription(MAX_IN_USE_SESSIONS_DESCRIPTION)\n+                .setDescription(ACTIVE_SESSIONS_DESCRIPTION)\n                 .setUnit(COUNT)\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n-    DerivedLongGauge maxAllowedSessionsMetric =\n+    DerivedLongGauge maxSessionsGauge =\n         metricRegistry.addDerivedLongGauge(\n-            MAX_ALLOWED_SESSIONS,\n+            MAX_SESSIONS,\n             MetricOptions.builder()\n-                .setDescription(MAX_ALLOWED_SESSIONS_DESCRIPTION)\n+                .setDescription(MAX_SESSIONS_DESCRIPTION)\n                 .setUnit(COUNT)\n                 .setLabelKeys(SPANNER_LABEL_KEYS)\n                 .build());\n \n-    DerivedLongGauge numInUseSessionsMetric =\n-        metricRegistry.addDerivedLongGauge(\n-            IN_USE_SESSIONS,\n-            MetricOptions.builder()\n-                .setDescription(IN_USE_SESSIONS_DESCRIPTION)\n-                .setUnit(COUNT)\n-                .setLabelKeys(SPANNER_LABEL_KEYS)\n-                .build());\n-\n-    // The value of a maxSessionsInUse is observed from a callback function. This function is\n+    // The value of a numSessionsInUse is observed from a callback function. This function is\n     // invoked whenever metrics are collected.\n-    maxInUseSessionsMetric.createTimeSeries(\n+    activeSessionsGauge.createTimeSeries(\n         labelValues,\n         this,\n         new ToLongFunction<SessionPool>() {\n           @Override\n           public long applyAsLong(SessionPool sessionPool) {\n-            return sessionPool.maxSessionsInUse;\n+            return sessionPool.numSessionsInUse;\n           }\n         });\n \n     // The value of a maxSessions is observed from a callback function. This function is invoked\n     // whenever metrics are collected.\n-    maxAllowedSessionsMetric.createTimeSeries(\n+    maxSessionsGauge.createTimeSeries(\n         labelValues,\n         options,\n         new ToLongFunction<SessionPoolOptions>() {\n", "next_change": {"commit": "893b446e822464fa94f446d920416e127d3c5a84", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\nindex c7d8d90c..bf22ba9d 100644\n--- a/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n+++ b/google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java\n", "chunk": "@@ -1857,5 +1868,17 @@ final class SessionPool {\n             return options.getMaxSessions();\n           }\n         });\n+\n+    // The value of a numSessionsInUse is observed from a callback function. This function is\n+    // invoked whenever metrics are collected.\n+    sessionsInUseGauge.createTimeSeries(\n+        labelValues,\n+        this,\n+        new ToLongFunction<SessionPool>() {\n+          @Override\n+          public long applyAsLong(SessionPool sessionPool) {\n+            return sessionPool.numSessionsInUse;\n+          }\n+        });\n   }\n }\n", "next_change": null}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MjYxNw==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375642617", "body": "I'm not sure what's normal for OpenCensus metrics tests but I was wondering if it makes sense to do something with a session so that the above two metrics have non-zero values.", "bodyText": "I'm not sure what's normal for OpenCensus metrics tests but I was wondering if it makes sense to do something with a session so that the above two metrics have non-zero values.", "bodyHTML": "<p dir=\"auto\">I'm not sure what's normal for OpenCensus metrics tests but I was wondering if it makes sense to do something with a session so that the above two metrics have non-zero values.</p>", "author": "skuruppu", "createdAt": "2020-02-06T05:08:33Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java", "diffHunk": "@@ -1545,6 +1561,35 @@ public void run() {\n     assertThat(impl.executePartitionedUpdate(statement)).isEqualTo(1L);\n   }\n \n+  @Test\n+  public void testSessionMetrics() {\n+    options =\n+        SessionPoolOptions.newBuilder()\n+            .setMinSessions(1)\n+            .setMaxSessions(3)\n+            .setMaxIdleSessions(0)\n+            .build();\n+    FakeClock clock = new FakeClock();\n+    clock.currentTimeMillis = System.currentTimeMillis();\n+    FakeMetricRegistry metricRegistry = new FakeMetricRegistry();\n+    List<LabelValue> labelValues =\n+        Arrays.asList(\n+            LabelValue.create(\"database1\"),\n+            LabelValue.create(\"instance1\"),\n+            LabelValue.create(\"1.0.0\"));\n+\n+    pool = createPool(clock, metricRegistry, labelValues);\n+    runMaintainanceLoop(clock, pool, pool.poolMaintainer.numClosureCycles);\n+\n+    MetricsRecord record = metricRegistry.pollRecord();\n+    assertThat(record.metrics).containsEntry(MetricRegistryConstants.MAX_IN_USE_SESSIONS, 0L);\n+    assertThat(record.metrics).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 0L);", "originalCommit": "e6938bc2f8507df551ef3ffea0e7651ca1330f2d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3Mjk4Ng==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375672986", "bodyText": "Good point, I used setupMockSessionCreation and get/close session to get some metrics values. Done in 1525a7d PTAL", "author": "mayurkale22", "createdAt": "2020-02-06T07:22:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MjYxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTcwODEyMg==", "url": "https://github.com/googleapis/java-spanner/pull/54#discussion_r375708122", "bodyText": "LGTM thanks for updating the test.", "author": "skuruppu", "createdAt": "2020-02-06T08:57:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY0MjYxNw=="}], "type": "inlineReview", "revised_code": {"commit": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\nindex 9a9e1288..95b5aec8 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n", "chunk": "@@ -1582,11 +1582,10 @@ public class SessionPoolTest extends BaseSessionPoolTest {\n     runMaintainanceLoop(clock, pool, pool.poolMaintainer.numClosureCycles);\n \n     MetricsRecord record = metricRegistry.pollRecord();\n-    assertThat(record.metrics).containsEntry(MetricRegistryConstants.MAX_IN_USE_SESSIONS, 0L);\n-    assertThat(record.metrics).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 0L);\n+    assertThat(record.metrics).containsEntry(MetricRegistryConstants.ACTIVE_SESSIONS, 0L);\n     assertThat(record.metrics)\n         .containsEntry(\n-            MetricRegistryConstants.MAX_ALLOWED_SESSIONS, Long.valueOf(options.getMaxSessions()));\n+            MetricRegistryConstants.MAX_SESSIONS, Long.valueOf(options.getMaxSessions()));\n     assertThat(record.labels).containsEntry(SPANNER_LABEL_KEYS, labelValues);\n   }\n \n", "next_change": {"commit": "893b446e822464fa94f446d920416e127d3c5a84", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\nindex 95b5aec8..3a49df33 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n", "chunk": "@@ -1583,6 +1583,7 @@ public class SessionPoolTest extends BaseSessionPoolTest {\n \n     MetricsRecord record = metricRegistry.pollRecord();\n     assertThat(record.metrics).containsEntry(MetricRegistryConstants.ACTIVE_SESSIONS, 0L);\n+    assertThat(record.metrics).containsEntry(MetricRegistryConstants.SESSIONS_IN_USE, 0L);\n     assertThat(record.metrics)\n         .containsEntry(\n             MetricRegistryConstants.MAX_SESSIONS, Long.valueOf(options.getMaxSessions()));\n", "next_change": {"commit": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\nindex 3a49df33..c8c957aa 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n", "chunk": "@@ -1582,11 +1581,11 @@ public class SessionPoolTest extends BaseSessionPoolTest {\n     runMaintainanceLoop(clock, pool, pool.poolMaintainer.numClosureCycles);\n \n     MetricsRecord record = metricRegistry.pollRecord();\n-    assertThat(record.metrics).containsEntry(MetricRegistryConstants.ACTIVE_SESSIONS, 0L);\n-    assertThat(record.metrics).containsEntry(MetricRegistryConstants.SESSIONS_IN_USE, 0L);\n+    assertThat(record.metrics).containsEntry(MetricRegistryConstants.MAX_IN_USE_SESSIONS, 0L);\n+    assertThat(record.metrics).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 0L);\n     assertThat(record.metrics)\n         .containsEntry(\n-            MetricRegistryConstants.MAX_SESSIONS, Long.valueOf(options.getMaxSessions()));\n+            MetricRegistryConstants.MAX_ALLOWED_SESSIONS, Long.valueOf(options.getMaxSessions()));\n     assertThat(record.labels).containsEntry(SPANNER_LABEL_KEYS, labelValues);\n   }\n \n", "next_change": {"commit": "1525a7d9a1eff5b6d2c7a5573c0c597c7a201c2b", "changed_code": [{"header": "diff --git a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\nindex c8c957aa..507d94b1 100644\n--- a/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n+++ b/google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java\n", "chunk": "@@ -1577,16 +1577,24 @@ public class SessionPoolTest extends BaseSessionPoolTest {\n             LabelValue.create(\"instance1\"),\n             LabelValue.create(\"1.0.0\"));\n \n+    setupMockSessionCreation();\n     pool = createPool(clock, metricRegistry, labelValues);\n-    runMaintainanceLoop(clock, pool, pool.poolMaintainer.numClosureCycles);\n+    Session session1 = pool.getReadSession();\n+    Session session2 = pool.getReadSession();\n \n     MetricsRecord record = metricRegistry.pollRecord();\n-    assertThat(record.metrics).containsEntry(MetricRegistryConstants.MAX_IN_USE_SESSIONS, 0L);\n-    assertThat(record.metrics).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 0L);\n-    assertThat(record.metrics)\n+    assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 2L);\n+    assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.MAX_IN_USE_SESSIONS, 2L);\n+    assertThat(record.getMetrics())\n         .containsEntry(\n-            MetricRegistryConstants.MAX_ALLOWED_SESSIONS, Long.valueOf(options.getMaxSessions()));\n-    assertThat(record.labels).containsEntry(SPANNER_LABEL_KEYS, labelValues);\n+            MetricRegistryConstants.MAX_ALLOWED_SESSIONS, (long) options.getMaxSessions());\n+    assertThat(record.getLabels()).containsEntry(SPANNER_LABEL_KEYS, labelValues);\n+\n+    session2.close();\n+    session1.close();\n+\n+    assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 0L);\n+    assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.MAX_IN_USE_SESSIONS, 2L);\n   }\n \n   private void mockKeepAlive(Session session) {\n", "next_change": null}]}}]}}]}}]}}, {"oid": "5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "url": "https://github.com/googleapis/java-spanner/commit/5bf757ebdb78fb4c72e5278cbc7fb92cb7f85644", "message": "feat: add session metrics\nAdd active_sessions (The number of active sessions in use) and max_sessions (The number of max sessions configured the user) metrics", "committedDate": "2020-02-06T05:09:18Z", "type": "commit"}, {"oid": "8bc6fc7ee2656340b4cad4bb99dfef34bceb96be", "url": "https://github.com/googleapis/java-spanner/commit/8bc6fc7ee2656340b4cad4bb99dfef34bceb96be", "message": "Fix code reviews\n\nUse maxSessionsInUse instead of numSessionsInUse and update the description.", "committedDate": "2020-02-06T05:09:18Z", "type": "commit"}, {"oid": "b3c56b50ce5d131d7a74305dcd7e1df493a24e18", "url": "https://github.com/googleapis/java-spanner/commit/b3c56b50ce5d131d7a74305dcd7e1df493a24e18", "message": "Change active sessions description", "committedDate": "2020-02-06T05:09:18Z", "type": "commit"}, {"oid": "893b446e822464fa94f446d920416e127d3c5a84", "url": "https://github.com/googleapis/java-spanner/commit/893b446e822464fa94f446d920416e127d3c5a84", "message": "add numSessionsInUse metric", "committedDate": "2020-02-06T05:09:18Z", "type": "commit"}, {"oid": "f2ebcdf742cb5d99e150e58039e6b147815bae99", "url": "https://github.com/googleapis/java-spanner/commit/f2ebcdf742cb5d99e150e58039e6b147815bae99", "message": "Fix package structure", "committedDate": "2020-02-06T05:09:18Z", "type": "commit"}, {"oid": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "url": "https://github.com/googleapis/java-spanner/commit/6ce5aa60d43e28ca05109122c7565ca0a380b86a", "message": "rename metric name and description", "committedDate": "2020-02-06T05:09:19Z", "type": "commit"}, {"oid": "6ce5aa60d43e28ca05109122c7565ca0a380b86a", "url": "https://github.com/googleapis/java-spanner/commit/6ce5aa60d43e28ca05109122c7565ca0a380b86a", "message": "rename metric name and description", "committedDate": "2020-02-06T05:09:19Z", "type": "forcePushed"}, {"oid": "67c9690550a68ffe2b704b253710237d08b309ea", "url": "https://github.com/googleapis/java-spanner/commit/67c9690550a68ffe2b704b253710237d08b309ea", "message": "fix nits", "committedDate": "2020-02-06T05:19:51Z", "type": "commit"}, {"oid": "1525a7d9a1eff5b6d2c7a5573c0c597c7a201c2b", "url": "https://github.com/googleapis/java-spanner/commit/1525a7d9a1eff5b6d2c7a5573c0c597c7a201c2b", "message": "createMockSession for metrics validations", "committedDate": "2020-02-06T07:19:04Z", "type": "commit"}]}