{"pr_number": 8707, "pr_title": "Migrate dashboard and stream roles to grants", "pr_author": "mpfz0r", "pr_createdAt": "2020-08-05T17:20:29Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8707", "timeline": [{"oid": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "url": "https://github.com/Graylog2/graylog2-server/commit/888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "message": "Migrate streams and dashboards roles to grants\n\nThis migrates the currently UI configurable roles\nfor dashboards and streams into grants.\n\nIf the permissions of a role are empty after the migration, it gets removed\ncompletely.\n\nIf entities has permissions other than read and edit, we don't migrate\nit, so we don't end up having permissions on two different places for a\nsingle entity.", "committedDate": "2020-08-10T15:35:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ1MTU0Nw==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470451547", "body": "We can join the declaration and assignment of these two.", "bodyText": "We can join the declaration and assignment of these two.", "bodyHTML": "<p dir=\"auto\">We can join the declaration and assignment of these two.</p>", "author": "bernd", "createdAt": "2020-08-14T07:15:47Z", "path": "graylog2-server/src/main/java/org/graylog2/system/stats/ClusterStatsService.java", "diffHunk": "@@ -115,10 +114,8 @@ public MongoStats mongoStats() {\n     public LdapStats ldapStats() {\n         int numberOfRoles = 0;\n         LdapSettings ldapSettings = null;\n-        try {\n-            numberOfRoles = roleService.loadAll().size();\n-            ldapSettings = ldapSettingsService.load();\n-        } catch (NotFoundException ignored) {}\n+        numberOfRoles = roleService.loadAll().size();\n+        ldapSettings = ldapSettingsService.load();", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyMzU0Mg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470523542", "body": "Not really an issue, more like a FYI: you can reduce the setup and save some lines when using JUnit 5 tests with the new extensions:\r\n\r\n```diff\r\ndiff --git graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\r\nindex 20bfb6ee20..fca0388ac0 100644\r\n--- graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\r\n+++ graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\r\n@@ -16,7 +16,6 @@\r\n  */\r\n package org.graylog2.migrations;\r\n \r\n-import com.fasterxml.jackson.databind.ObjectMapper;\r\n import com.google.common.collect.ImmutableSet;\r\n import com.google.common.collect.Iterables;\r\n import com.google.common.collect.Sets;\r\n@@ -31,8 +30,11 @@ import org.graylog.security.Capability;\r\n import org.graylog.security.DBGrantService;\r\n import org.graylog.security.GrantDTO;\r\n import org.graylog.security.permissions.GRNPermission;\r\n+import org.graylog.testing.GRNExtension;\r\n+import org.graylog.testing.mongodb.MongoDBExtension;\r\n import org.graylog.testing.mongodb.MongoDBFixtures;\r\n-import org.graylog.testing.mongodb.MongoDBInstance;\r\n+import org.graylog.testing.mongodb.MongoDBTestService;\r\n+import org.graylog.testing.mongodb.MongoJackExtension;\r\n import org.graylog2.Configuration;\r\n import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\r\n import org.graylog2.database.MongoConnection;\r\n@@ -40,7 +42,6 @@ import org.graylog2.database.NotFoundException;\r\n import org.graylog2.database.PersistedServiceImpl;\r\n import org.graylog2.plugin.database.ValidationException;\r\n import org.graylog2.plugin.database.users.User;\r\n-import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\r\n import org.graylog2.shared.security.Permissions;\r\n import org.graylog2.shared.security.RestPermissions;\r\n import org.graylog2.shared.users.Role;\r\n@@ -49,12 +50,11 @@ import org.graylog2.users.RoleService;\r\n import org.graylog2.users.RoleServiceImpl;\r\n import org.graylog2.users.UserImpl;\r\n import org.graylog2.users.UserServiceImplTest;\r\n-import org.junit.Before;\r\n-import org.junit.Rule;\r\n-import org.junit.Test;\r\n+import org.junit.jupiter.api.BeforeEach;\r\n+import org.junit.jupiter.api.Test;\r\n+import org.junit.jupiter.api.extension.ExtendWith;\r\n import org.mockito.Mock;\r\n-import org.mockito.junit.MockitoJUnit;\r\n-import org.mockito.junit.MockitoRule;\r\n+import org.mockito.junit.jupiter.MockitoExtension;\r\n \r\n import javax.annotation.Nullable;\r\n import javax.validation.Validator;\r\n@@ -70,34 +70,32 @@ import static org.assertj.core.api.Assertions.assertThatThrownBy;\r\n import static org.mockito.ArgumentMatchers.any;\r\n import static org.mockito.Mockito.when;\r\n \r\n+@ExtendWith(MongoDBExtension.class)\r\n+@ExtendWith(MongoJackExtension.class)\r\n+@ExtendWith(MockitoExtension.class)\r\n+@ExtendWith(GRNExtension.class)\r\n+@MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\r\n public class V20200803120800_MigrateRolesToGrantsTest {\r\n     private V20200803120800_MigrateRolesToGrants migration;\r\n     private RoleService roleService;\r\n     private DBGrantService dbGrantService;\r\n-    private ObjectMapper objectMapper;\r\n-\r\n-    @Rule\r\n-    public final MockitoRule mockitoRule = MockitoJUnit.rule();\r\n-\r\n-    @Rule\r\n-    public final MongoDBInstance mongodb = MongoDBInstance.createForClass();\r\n \r\n     @Mock\r\n     private Permissions permissions;\r\n-\r\n     @Mock\r\n     private Validator validator;\r\n+\r\n     private GRNRegistry grnRegistry;\r\n     private UserService userService;\r\n \r\n-    @Before\r\n-    public void setUp() {\r\n-        objectMapper = new ObjectMapperProvider().get();\r\n-        final MongoJackObjectMapperProvider mongoJackObjectMapperProvider = new MongoJackObjectMapperProvider(objectMapper);\r\n+    @BeforeEach\r\n+    public void setUp(MongoDBTestService mongodb,\r\n+                      MongoJackObjectMapperProvider mongoJackObjectMapperProvider,\r\n+                      GRNRegistry grnRegistry) {\r\n         when(permissions.readerBasePermissions()).thenReturn(ImmutableSet.of());\r\n         when(validator.validate(any())).thenReturn(ImmutableSet.of());\r\n \r\n-        grnRegistry = GRNRegistry.createWithBuiltinTypes();\r\n+        this.grnRegistry = grnRegistry;\r\n \r\n         roleService = new RoleServiceImpl(mongodb.mongoConnection(), mongoJackObjectMapperProvider, permissions, validator);\r\n \r\n@@ -108,7 +106,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\r\n     }\r\n \r\n     @Test\r\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\r\n     public void migrateSimpleRole() throws NotFoundException {\r\n \r\n         final User testuser1 = userService.load(\"testuser1\");\r\n@@ -141,7 +138,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\r\n     }\r\n \r\n     @Test\r\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\r\n     public void nonMigratableRole() throws NotFoundException {\r\n \r\n         final User testuser3 = userService.load(\"testuser3\");\r\n@@ -161,7 +157,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\r\n     }\r\n \r\n     @Test\r\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\r\n     public void partlyMigratableRole() throws NotFoundException {\r\n \r\n         final User testuser4 = userService.load(\"testuser3\");\r\n```", "bodyText": "Not really an issue, more like a FYI: you can reduce the setup and save some lines when using JUnit 5 tests with the new extensions:\ndiff --git graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\nindex 20bfb6ee20..fca0388ac0 100644\n--- graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n+++ graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n@@ -16,7 +16,6 @@\n  */\n package org.graylog2.migrations;\n \n-import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Sets;\n@@ -31,8 +30,11 @@ import org.graylog.security.Capability;\n import org.graylog.security.DBGrantService;\n import org.graylog.security.GrantDTO;\n import org.graylog.security.permissions.GRNPermission;\n+import org.graylog.testing.GRNExtension;\n+import org.graylog.testing.mongodb.MongoDBExtension;\n import org.graylog.testing.mongodb.MongoDBFixtures;\n-import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.graylog.testing.mongodb.MongoDBTestService;\n+import org.graylog.testing.mongodb.MongoJackExtension;\n import org.graylog2.Configuration;\n import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n import org.graylog2.database.MongoConnection;\n@@ -40,7 +42,6 @@ import org.graylog2.database.NotFoundException;\n import org.graylog2.database.PersistedServiceImpl;\n import org.graylog2.plugin.database.ValidationException;\n import org.graylog2.plugin.database.users.User;\n-import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n import org.graylog2.shared.security.Permissions;\n import org.graylog2.shared.security.RestPermissions;\n import org.graylog2.shared.users.Role;\n@@ -49,12 +50,11 @@ import org.graylog2.users.RoleService;\n import org.graylog2.users.RoleServiceImpl;\n import org.graylog2.users.UserImpl;\n import org.graylog2.users.UserServiceImplTest;\n-import org.junit.Before;\n-import org.junit.Rule;\n-import org.junit.Test;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n-import org.mockito.junit.MockitoJUnit;\n-import org.mockito.junit.MockitoRule;\n+import org.mockito.junit.jupiter.MockitoExtension;\n \n import javax.annotation.Nullable;\n import javax.validation.Validator;\n@@ -70,34 +70,32 @@ import static org.assertj.core.api.Assertions.assertThatThrownBy;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.when;\n \n+@ExtendWith(MongoDBExtension.class)\n+@ExtendWith(MongoJackExtension.class)\n+@ExtendWith(MockitoExtension.class)\n+@ExtendWith(GRNExtension.class)\n+@MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n public class V20200803120800_MigrateRolesToGrantsTest {\n     private V20200803120800_MigrateRolesToGrants migration;\n     private RoleService roleService;\n     private DBGrantService dbGrantService;\n-    private ObjectMapper objectMapper;\n-\n-    @Rule\n-    public final MockitoRule mockitoRule = MockitoJUnit.rule();\n-\n-    @Rule\n-    public final MongoDBInstance mongodb = MongoDBInstance.createForClass();\n \n     @Mock\n     private Permissions permissions;\n-\n     @Mock\n     private Validator validator;\n+\n     private GRNRegistry grnRegistry;\n     private UserService userService;\n \n-    @Before\n-    public void setUp() {\n-        objectMapper = new ObjectMapperProvider().get();\n-        final MongoJackObjectMapperProvider mongoJackObjectMapperProvider = new MongoJackObjectMapperProvider(objectMapper);\n+    @BeforeEach\n+    public void setUp(MongoDBTestService mongodb,\n+                      MongoJackObjectMapperProvider mongoJackObjectMapperProvider,\n+                      GRNRegistry grnRegistry) {\n         when(permissions.readerBasePermissions()).thenReturn(ImmutableSet.of());\n         when(validator.validate(any())).thenReturn(ImmutableSet.of());\n \n-        grnRegistry = GRNRegistry.createWithBuiltinTypes();\n+        this.grnRegistry = grnRegistry;\n \n         roleService = new RoleServiceImpl(mongodb.mongoConnection(), mongoJackObjectMapperProvider, permissions, validator);\n \n@@ -108,7 +106,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n     public void migrateSimpleRole() throws NotFoundException {\n \n         final User testuser1 = userService.load(\"testuser1\");\n@@ -141,7 +138,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n     public void nonMigratableRole() throws NotFoundException {\n \n         final User testuser3 = userService.load(\"testuser3\");\n@@ -161,7 +157,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")\n     public void partlyMigratableRole() throws NotFoundException {\n \n         final User testuser4 = userService.load(\"testuser3\");", "bodyHTML": "<p dir=\"auto\">Not really an issue, more like a FYI: you can reduce the setup and save some lines when using JUnit 5 tests with the new extensions:</p>\n<div class=\"highlight highlight-source-diff position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"diff --git graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\nindex 20bfb6ee20..fca0388ac0 100644\n--- graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n+++ graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java\n@@ -16,7 +16,6 @@\n  */\n package org.graylog2.migrations;\n \n-import com.fasterxml.jackson.databind.ObjectMapper;\n import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Sets;\n@@ -31,8 +30,11 @@ import org.graylog.security.Capability;\n import org.graylog.security.DBGrantService;\n import org.graylog.security.GrantDTO;\n import org.graylog.security.permissions.GRNPermission;\n+import org.graylog.testing.GRNExtension;\n+import org.graylog.testing.mongodb.MongoDBExtension;\n import org.graylog.testing.mongodb.MongoDBFixtures;\n-import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.graylog.testing.mongodb.MongoDBTestService;\n+import org.graylog.testing.mongodb.MongoJackExtension;\n import org.graylog2.Configuration;\n import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n import org.graylog2.database.MongoConnection;\n@@ -40,7 +42,6 @@ import org.graylog2.database.NotFoundException;\n import org.graylog2.database.PersistedServiceImpl;\n import org.graylog2.plugin.database.ValidationException;\n import org.graylog2.plugin.database.users.User;\n-import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n import org.graylog2.shared.security.Permissions;\n import org.graylog2.shared.security.RestPermissions;\n import org.graylog2.shared.users.Role;\n@@ -49,12 +50,11 @@ import org.graylog2.users.RoleService;\n import org.graylog2.users.RoleServiceImpl;\n import org.graylog2.users.UserImpl;\n import org.graylog2.users.UserServiceImplTest;\n-import org.junit.Before;\n-import org.junit.Rule;\n-import org.junit.Test;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n import org.mockito.Mock;\n-import org.mockito.junit.MockitoJUnit;\n-import org.mockito.junit.MockitoRule;\n+import org.mockito.junit.jupiter.MockitoExtension;\n \n import javax.annotation.Nullable;\n import javax.validation.Validator;\n@@ -70,34 +70,32 @@ import static org.assertj.core.api.Assertions.assertThatThrownBy;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.when;\n \n+@ExtendWith(MongoDBExtension.class)\n+@ExtendWith(MongoJackExtension.class)\n+@ExtendWith(MockitoExtension.class)\n+@ExtendWith(GRNExtension.class)\n+@MongoDBFixtures(&quot;V20200803120800_MigrateRolesToGrantsTest.json&quot;)\n public class V20200803120800_MigrateRolesToGrantsTest {\n     private V20200803120800_MigrateRolesToGrants migration;\n     private RoleService roleService;\n     private DBGrantService dbGrantService;\n-    private ObjectMapper objectMapper;\n-\n-    @Rule\n-    public final MockitoRule mockitoRule = MockitoJUnit.rule();\n-\n-    @Rule\n-    public final MongoDBInstance mongodb = MongoDBInstance.createForClass();\n \n     @Mock\n     private Permissions permissions;\n-\n     @Mock\n     private Validator validator;\n+\n     private GRNRegistry grnRegistry;\n     private UserService userService;\n \n-    @Before\n-    public void setUp() {\n-        objectMapper = new ObjectMapperProvider().get();\n-        final MongoJackObjectMapperProvider mongoJackObjectMapperProvider = new MongoJackObjectMapperProvider(objectMapper);\n+    @BeforeEach\n+    public void setUp(MongoDBTestService mongodb,\n+                      MongoJackObjectMapperProvider mongoJackObjectMapperProvider,\n+                      GRNRegistry grnRegistry) {\n         when(permissions.readerBasePermissions()).thenReturn(ImmutableSet.of());\n         when(validator.validate(any())).thenReturn(ImmutableSet.of());\n \n-        grnRegistry = GRNRegistry.createWithBuiltinTypes();\n+        this.grnRegistry = grnRegistry;\n \n         roleService = new RoleServiceImpl(mongodb.mongoConnection(), mongoJackObjectMapperProvider, permissions, validator);\n \n@@ -108,7 +106,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(&quot;V20200803120800_MigrateRolesToGrantsTest.json&quot;)\n     public void migrateSimpleRole() throws NotFoundException {\n \n         final User testuser1 = userService.load(&quot;testuser1&quot;);\n@@ -141,7 +138,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(&quot;V20200803120800_MigrateRolesToGrantsTest.json&quot;)\n     public void nonMigratableRole() throws NotFoundException {\n \n         final User testuser3 = userService.load(&quot;testuser3&quot;);\n@@ -161,7 +157,6 @@ public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n-    @MongoDBFixtures(&quot;V20200803120800_MigrateRolesToGrantsTest.json&quot;)\n     public void partlyMigratableRole() throws NotFoundException {\n \n         final User testuser4 = userService.load(&quot;testuser3&quot;);\"><pre><span class=\"pl-c1\">diff --git graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java</span>\nindex 20bfb6ee20..fca0388ac0 100644\n<span class=\"pl-md\">--- graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java</span>\n<span class=\"pl-mi1\">+++ graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java</span>\n<span class=\"pl-mdr\">@@ -16,7 +16,6 @@</span>\n  */\n package org.graylog2.migrations;\n \n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import com.fasterxml.jackson.databind.ObjectMapper;</span>\n import com.google.common.collect.ImmutableSet;\n import com.google.common.collect.Iterables;\n import com.google.common.collect.Sets;\n<span class=\"pl-mdr\">@@ -31,8 +30,11 @@</span> import org.graylog.security.Capability;\n import org.graylog.security.DBGrantService;\n import org.graylog.security.GrantDTO;\n import org.graylog.security.permissions.GRNPermission;\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.graylog.testing.GRNExtension;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.graylog.testing.mongodb.MongoDBExtension;</span>\n import org.graylog.testing.mongodb.MongoDBFixtures;\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import org.graylog.testing.mongodb.MongoDBInstance;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.graylog.testing.mongodb.MongoDBTestService;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.graylog.testing.mongodb.MongoJackExtension;</span>\n import org.graylog2.Configuration;\n import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n import org.graylog2.database.MongoConnection;\n<span class=\"pl-mdr\">@@ -40,7 +42,6 @@</span> import org.graylog2.database.NotFoundException;\n import org.graylog2.database.PersistedServiceImpl;\n import org.graylog2.plugin.database.ValidationException;\n import org.graylog2.plugin.database.users.User;\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import org.graylog2.shared.bindings.providers.ObjectMapperProvider;</span>\n import org.graylog2.shared.security.Permissions;\n import org.graylog2.shared.security.RestPermissions;\n import org.graylog2.shared.users.Role;\n<span class=\"pl-mdr\">@@ -49,12 +50,11 @@</span> import org.graylog2.users.RoleService;\n import org.graylog2.users.RoleServiceImpl;\n import org.graylog2.users.UserImpl;\n import org.graylog2.users.UserServiceImplTest;\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import org.junit.Before;</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import org.junit.Rule;</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import org.junit.Test;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.junit.jupiter.api.BeforeEach;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.junit.jupiter.api.Test;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.junit.jupiter.api.extension.ExtendWith;</span>\n import org.mockito.Mock;\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import org.mockito.junit.MockitoJUnit;</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>import org.mockito.junit.MockitoRule;</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>import org.mockito.junit.jupiter.MockitoExtension;</span>\n \n import javax.annotation.Nullable;\n import javax.validation.Validator;\n<span class=\"pl-mdr\">@@ -70,34 +70,32 @@</span> import static org.assertj.core.api.Assertions.assertThatThrownBy;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.Mockito.when;\n \n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>@ExtendWith(MongoDBExtension.class)</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>@ExtendWith(MongoJackExtension.class)</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>@ExtendWith(MockitoExtension.class)</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>@ExtendWith(GRNExtension.class)</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>@MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")</span>\n public class V20200803120800_MigrateRolesToGrantsTest {\n     private V20200803120800_MigrateRolesToGrants migration;\n     private RoleService roleService;\n     private DBGrantService dbGrantService;\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    private ObjectMapper objectMapper;</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span></span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    @Rule</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    public final MockitoRule mockitoRule = MockitoJUnit.rule();</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span></span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    @Rule</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    public final MongoDBInstance mongodb = MongoDBInstance.createForClass();</span>\n \n     @Mock\n     private Permissions permissions;\n<span class=\"pl-md\"><span class=\"pl-md\">-</span></span>\n     @Mock\n     private Validator validator;\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span></span>\n     private GRNRegistry grnRegistry;\n     private UserService userService;\n \n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    @Before</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    public void setUp() {</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>        objectMapper = new ObjectMapperProvider().get();</span>\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>        final MongoJackObjectMapperProvider mongoJackObjectMapperProvider = new MongoJackObjectMapperProvider(objectMapper);</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    @BeforeEach</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>    public void setUp(MongoDBTestService mongodb,</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>                      MongoJackObjectMapperProvider mongoJackObjectMapperProvider,</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>                      GRNRegistry grnRegistry) {</span>\n         when(permissions.readerBasePermissions()).thenReturn(ImmutableSet.of());\n         when(validator.validate(any())).thenReturn(ImmutableSet.of());\n \n<span class=\"pl-md\"><span class=\"pl-md\">-</span>        grnRegistry = GRNRegistry.createWithBuiltinTypes();</span>\n<span class=\"pl-mi1\"><span class=\"pl-mi1\">+</span>        this.grnRegistry = grnRegistry;</span>\n \n         roleService = new RoleServiceImpl(mongodb.mongoConnection(), mongoJackObjectMapperProvider, permissions, validator);\n \n<span class=\"pl-mdr\">@@ -108,7 +106,6 @@</span> public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")</span>\n     public void migrateSimpleRole() throws NotFoundException {\n \n         final User testuser1 = userService.load(\"testuser1\");\n<span class=\"pl-mdr\">@@ -141,7 +138,6 @@</span> public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")</span>\n     public void nonMigratableRole() throws NotFoundException {\n \n         final User testuser3 = userService.load(\"testuser3\");\n<span class=\"pl-mdr\">@@ -161,7 +157,6 @@</span> public class V20200803120800_MigrateRolesToGrantsTest {\n     }\n \n     @Test\n<span class=\"pl-md\"><span class=\"pl-md\">-</span>    @MongoDBFixtures(\"V20200803120800_MigrateRolesToGrantsTest.json\")</span>\n     public void partlyMigratableRole() throws NotFoundException {\n \n         final User testuser4 = userService.load(\"testuser3\");</pre></div>", "author": "bernd", "createdAt": "2020-08-14T09:44:43Z", "path": "graylog2-server/src/test/java/org/graylog2/migrations/V20200803120800_MigrateRolesToGrantsTest.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/**\n+ * This file is part of Graylog.\n+ *\n+ * Graylog is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as published by\n+ * the Free Software Foundation, either version 3 of the License, or\n+ * (at your option) any later version.\n+ *\n+ * Graylog is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public License\n+ * along with Graylog.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+package org.graylog2.migrations;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.collect.ImmutableSet;\n+import com.google.common.collect.Iterables;\n+import com.google.common.collect.Sets;\n+import com.mongodb.BasicDBObject;\n+import com.mongodb.BasicDBObjectBuilder;\n+import com.mongodb.DBObject;\n+import org.apache.shiro.authz.Permission;\n+import org.apache.shiro.authz.permission.WildcardPermission;\n+import org.bson.types.ObjectId;\n+import org.graylog.grn.GRNRegistry;\n+import org.graylog.security.Capability;\n+import org.graylog.security.DBGrantService;\n+import org.graylog.security.GrantDTO;\n+import org.graylog.security.permissions.GRNPermission;\n+import org.graylog.testing.mongodb.MongoDBFixtures;\n+import org.graylog.testing.mongodb.MongoDBInstance;\n+import org.graylog2.Configuration;\n+import org.graylog2.bindings.providers.MongoJackObjectMapperProvider;\n+import org.graylog2.database.MongoConnection;\n+import org.graylog2.database.NotFoundException;\n+import org.graylog2.database.PersistedServiceImpl;\n+import org.graylog2.plugin.database.ValidationException;\n+import org.graylog2.plugin.database.users.User;\n+import org.graylog2.shared.bindings.providers.ObjectMapperProvider;\n+import org.graylog2.shared.security.Permissions;\n+import org.graylog2.shared.security.RestPermissions;\n+import org.graylog2.shared.users.Role;\n+import org.graylog2.shared.users.UserService;\n+import org.graylog2.users.RoleService;\n+import org.graylog2.users.RoleServiceImpl;\n+import org.graylog2.users.UserImpl;\n+import org.graylog2.users.UserServiceImplTest;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+\n+import javax.annotation.Nullable;\n+import javax.validation.Validator;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.when;\n+\n+public class V20200803120800_MigrateRolesToGrantsTest {", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA3MDYwNQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r472070605", "bodyText": "cool! thanks", "author": "mpfz0r", "createdAt": "2020-08-18T10:15:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyMzU0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU3OTY5NA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470579694", "body": "Since we have a `String` now, I think we should check that the `userName` is not null **and** not empty.", "bodyText": "Since we have a String now, I think we should check that the userName is not null and not empty.", "bodyHTML": "<p dir=\"auto\">Since we have a <code>String</code> now, I think we should check that the <code>userName</code> is not null <strong>and</strong> not empty.</p>", "author": "bernd", "createdAt": "2020-08-14T11:55:44Z", "path": "graylog2-server/src/main/java/org/graylog/security/DBGrantService.java", "diffHunk": "@@ -89,10 +89,8 @@ public DBGrantService(MongoConnection mongoConnection,\n                 DBQuery.in(GrantDTO.FIELD_GRANTEE, grantees))).toArray();\n     }\n \n-    public GrantDTO create(GrantDTO grantDTO, @Nullable User currentUser) {\n+    public GrantDTO create(GrantDTO grantDTO, String userName) {\n         final ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n-        final String userName = requireNonNull(currentUser, \"currentUser cannot be null\").getName();", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU4MDAwNg==", "url": "https://github.com/Graylog2/graylog2-server/pull/8707#discussion_r470580006", "body": "How about adding a test for this? :slightly_smiling_face: ", "bodyText": "How about adding a test for this? \ud83d\ude42", "bodyHTML": "<p dir=\"auto\">How about adding a test for this? <g-emoji class=\"g-emoji\" alias=\"slightly_smiling_face\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f642.png\">\ud83d\ude42</g-emoji></p>", "author": "bernd", "createdAt": "2020-08-14T11:56:29Z", "path": "graylog2-server/src/main/java/org/graylog/security/DBGrantService.java", "diffHunk": "@@ -89,10 +89,8 @@ public DBGrantService(MongoConnection mongoConnection,\n                 DBQuery.in(GrantDTO.FIELD_GRANTEE, grantees))).toArray();\n     }\n \n-    public GrantDTO create(GrantDTO grantDTO, @Nullable User currentUser) {\n+    public GrantDTO create(GrantDTO grantDTO, String userName) {", "originalCommit": "888e61d5e6d0b69fd3a0d4b62107c166a94b6551", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "url": "https://github.com/Graylog2/graylog2-server/commit/58f5fc9482bbc34dbb91387dc8c3fcb55f0cb150", "message": "Apply review comments", "committedDate": "2020-08-18T10:44:55Z", "type": "forcePushed"}, {"oid": "38f2a88646e847c551713d9c2b3c8b432b4a0f8f", "url": "https://github.com/Graylog2/graylog2-server/commit/38f2a88646e847c551713d9c2b3c8b432b4a0f8f", "message": "Remove unneeded NotFoundException from RoleService.loadAll()", "committedDate": "2020-08-21T12:25:46Z", "type": "commit"}, {"oid": "966456d8d6aa422b250c079e103dc2edb7798a6e", "url": "https://github.com/Graylog2/graylog2-server/commit/966456d8d6aa422b250c079e103dc2edb7798a6e", "message": "Migrate streams and dashboards roles to grants\n\nThis migrates the currently UI configurable roles\nfor dashboards and streams into grants.\n\nIf the permissions of a role are empty after the migration, it gets removed\ncompletely.\n\nIf entities has permissions other than read and edit, we don't migrate\nit, so we don't end up having permissions on two different places for a\nsingle entity.", "committedDate": "2020-08-21T12:25:46Z", "type": "commit"}, {"oid": "14277d9fe61cfb932fed8d4f879391ec7493ae7a", "url": "https://github.com/Graylog2/graylog2-server/commit/14277d9fe61cfb932fed8d4f879391ec7493ae7a", "message": "Apply review comments", "committedDate": "2020-08-21T12:25:47Z", "type": "commit"}, {"oid": "14277d9fe61cfb932fed8d4f879391ec7493ae7a", "url": "https://github.com/Graylog2/graylog2-server/commit/14277d9fe61cfb932fed8d4f879391ec7493ae7a", "message": "Apply review comments", "committedDate": "2020-08-21T12:25:47Z", "type": "forcePushed"}]}