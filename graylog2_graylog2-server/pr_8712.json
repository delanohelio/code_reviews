{"pr_number": 8712, "pr_title": "Add missing routes to AuthzRolesResource", "pr_author": "kmerz", "pr_createdAt": "2020-08-06T11:34:37Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8712", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM5OTQwOQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8712#discussion_r466399409", "body": "I think we can use `PUT <role-id>/assignee/<username>` here:\r\n```suggestion\r\n    @Path(\"{roleId}/assignee/{username}\")\r\n```", "bodyText": "I think we can use PUT <role-id>/assignee/<username> here:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Path(\"{roleId}/assignee/add/{username}\")\n          \n          \n            \n                @Path(\"{roleId}/assignee/{username}\")", "bodyHTML": "<p dir=\"auto\">I think we can use <code>PUT &lt;role-id&gt;/assignee/&lt;username&gt;</code> here:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@Path</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{roleId}/assignee/<span class=\"x x-first x-last\">add/</span>{username}<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@Path</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{roleId}/assignee/{username}<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bernd", "createdAt": "2020-08-06T13:09:43Z", "path": "graylog2-server/src/main/java/org/graylog/security/authzroles/AuthzRolesResource.java", "diffHunk": "@@ -126,7 +180,53 @@ public AuthzRoleDTO get(@ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlan\n             throw new BadRequestException(\"Invalid argument in search query: \" + e.getMessage());\n         }\n \n-        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(searchQuery, page, perPage,sort, order, username);\n+        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(\n+                searchQuery, page, perPage,sort, order, username);\n         return PaginatedResponse.create(\"roles\", result, query);\n     }\n+\n+    @PUT\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(\"Add a user to a role\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    @Path(\"{roleId}/assignee/add/{username}\")", "originalCommit": "60170571ae8690a6d0eccd07e098dd0e3ac07123", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwMDQxMQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8712#discussion_r466400411", "body": "And `DELETE <role-id>/assignee/<username>` here:\r\n\r\n```suggestion\r\n    @DELETE\r\n    @ApiOperation(\"Remove a member to a team\")\r\n    @Path(\"{roleId}/assignee/{username}\")\r\n```", "bodyText": "And DELETE <role-id>/assignee/<username> here:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @PUT\n          \n          \n            \n                @ApiOperation(\"Remove a member to a team\")\n          \n          \n            \n                @Path(\"{roleId}/assignee/remove/{username}\")\n          \n          \n            \n                @DELETE\n          \n          \n            \n                @ApiOperation(\"Remove a member to a team\")\n          \n          \n            \n                @Path(\"{roleId}/assignee/{username}\")", "bodyHTML": "<p dir=\"auto\">And <code>DELETE &lt;role-id&gt;/assignee/&lt;username&gt;</code> here:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@<span class=\"x x-first x-last\">PUT</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@ApiOperation</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Remove a member to a team<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@Path</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{roleId}/assignee/<span class=\"x x-first x-last\">remove/</span>{username}<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@<span class=\"x x-first x-last\">DELETE</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@ApiOperation</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Remove a member to a team<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@Path</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{roleId}/assignee/{username}<span class=\"pl-pds\">\"</span></span>)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bernd", "createdAt": "2020-08-06T13:11:15Z", "path": "graylog2-server/src/main/java/org/graylog/security/authzroles/AuthzRolesResource.java", "diffHunk": "@@ -126,7 +180,53 @@ public AuthzRoleDTO get(@ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlan\n             throw new BadRequestException(\"Invalid argument in search query: \" + e.getMessage());\n         }\n \n-        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(searchQuery, page, perPage,sort, order, username);\n+        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(\n+                searchQuery, page, perPage,sort, order, username);\n         return PaginatedResponse.create(\"roles\", result, query);\n     }\n+\n+    @PUT\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(\"Add a user to a role\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    @Path(\"{roleId}/assignee/add/{username}\")\n+    public Response addUser(\n+            @ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlank String roleId,\n+            @ApiParam(name = \"username\") @PathParam(\"username\") @NotBlank String username) throws ValidationException {\n+        checkPermission(USERS_EDIT, username);\n+\n+        final User user = userService.load(username);\n+        if (user == null) {\n+            throw new NotFoundException(\"Cannot find user with name: \" + username);\n+        }\n+        authzRolesService.get(roleId).orElseThrow(() -> new NotFoundException(\"Cannot find role with id: \" + roleId));\n+        Set<String> roles = user.getRoleIds();\n+        roles.add(roleId);\n+        user.setRoleIds(roles);\n+        userService.save(user);\n+\n+        return Response.ok().build();\n+    }\n+\n+    @PUT\n+    @ApiOperation(\"Remove a member to a team\")\n+    @Path(\"{roleId}/assignee/remove/{username}\")", "originalCommit": "60170571ae8690a6d0eccd07e098dd0e3ac07123", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwMjU1Ng==", "url": "https://github.com/Graylog2/graylog2-server/pull/8712#discussion_r466402556", "body": "I think we should return a `204` if we don't want to return anything. (or make the method `void` instead of returning `Response`, that's the same)\r\n```suggestion\r\n        return Response.noContent().build();\r\n```", "bodyText": "I think we should return a 204 if we don't want to return anything. (or make the method void instead of returning Response, that's the same)\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Response.ok().build();\n          \n          \n            \n                    return Response.noContent().build();", "bodyHTML": "<p dir=\"auto\">I think we should return a <code>204</code> if we don't want to return anything. (or make the method <code>void</code> instead of returning <code>Response</code>, that's the same)</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> <span class=\"pl-smi\">Response</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">ok</span>()<span class=\"pl-k\">.</span>build();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> <span class=\"pl-smi\">Response</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">noContent</span>()<span class=\"pl-k\">.</span>build();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bernd", "createdAt": "2020-08-06T13:14:40Z", "path": "graylog2-server/src/main/java/org/graylog/security/authzroles/AuthzRolesResource.java", "diffHunk": "@@ -126,7 +180,53 @@ public AuthzRoleDTO get(@ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlan\n             throw new BadRequestException(\"Invalid argument in search query: \" + e.getMessage());\n         }\n \n-        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(searchQuery, page, perPage,sort, order, username);\n+        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(\n+                searchQuery, page, perPage,sort, order, username);\n         return PaginatedResponse.create(\"roles\", result, query);\n     }\n+\n+    @PUT\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(\"Add a user to a role\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    @Path(\"{roleId}/assignee/add/{username}\")\n+    public Response addUser(\n+            @ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlank String roleId,\n+            @ApiParam(name = \"username\") @PathParam(\"username\") @NotBlank String username) throws ValidationException {\n+        checkPermission(USERS_EDIT, username);\n+\n+        final User user = userService.load(username);\n+        if (user == null) {\n+            throw new NotFoundException(\"Cannot find user with name: \" + username);\n+        }\n+        authzRolesService.get(roleId).orElseThrow(() -> new NotFoundException(\"Cannot find role with id: \" + roleId));\n+        Set<String> roles = user.getRoleIds();\n+        roles.add(roleId);\n+        user.setRoleIds(roles);\n+        userService.save(user);\n+\n+        return Response.ok().build();", "originalCommit": "60170571ae8690a6d0eccd07e098dd0e3ac07123", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwMjc5OA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8712#discussion_r466402798", "body": "See comment above.\r\n```suggestion\r\n        return Response.noContent().build();\r\n```", "bodyText": "See comment above.\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Response.ok().build();\n          \n          \n            \n                    return Response.noContent().build();", "bodyHTML": "<p dir=\"auto\">See comment above.</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> <span class=\"pl-smi\">Response</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">ok</span>()<span class=\"pl-k\">.</span>build();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> <span class=\"pl-smi\">Response</span><span class=\"pl-k\">.</span><span class=\"x x-first x-last\">noContent</span>()<span class=\"pl-k\">.</span>build();</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "bernd", "createdAt": "2020-08-06T13:15:01Z", "path": "graylog2-server/src/main/java/org/graylog/security/authzroles/AuthzRolesResource.java", "diffHunk": "@@ -126,7 +180,53 @@ public AuthzRoleDTO get(@ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlan\n             throw new BadRequestException(\"Invalid argument in search query: \" + e.getMessage());\n         }\n \n-        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(searchQuery, page, perPage,sort, order, username);\n+        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(\n+                searchQuery, page, perPage,sort, order, username);\n         return PaginatedResponse.create(\"roles\", result, query);\n     }\n+\n+    @PUT\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(\"Add a user to a role\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    @Path(\"{roleId}/assignee/add/{username}\")\n+    public Response addUser(\n+            @ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlank String roleId,\n+            @ApiParam(name = \"username\") @PathParam(\"username\") @NotBlank String username) throws ValidationException {\n+        checkPermission(USERS_EDIT, username);\n+\n+        final User user = userService.load(username);\n+        if (user == null) {\n+            throw new NotFoundException(\"Cannot find user with name: \" + username);\n+        }\n+        authzRolesService.get(roleId).orElseThrow(() -> new NotFoundException(\"Cannot find role with id: \" + roleId));\n+        Set<String> roles = user.getRoleIds();\n+        roles.add(roleId);\n+        user.setRoleIds(roles);\n+        userService.save(user);\n+\n+        return Response.ok().build();\n+    }\n+\n+    @PUT\n+    @ApiOperation(\"Remove a member to a team\")\n+    @Path(\"{roleId}/assignee/remove/{username}\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    public Response removeUser(\n+            @ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlank String roleId,\n+            @ApiParam(name = \"username\") @PathParam(\"username\") @NotBlank String username) throws ValidationException {\n+        checkPermission(USERS_EDIT, username);\n+\n+        final User user = userService.load(username);\n+        if (user == null) {\n+            throw new NotFoundException(\"Cannot find user with name: \" + username);\n+        }\n+        authzRolesService.get(roleId).orElseThrow(() -> new NotFoundException(\"Cannot find role with id: \" + roleId));\n+        Set<String> roles = user.getRoleIds();\n+        roles.remove(roleId);\n+        user.setRoleIds(roles);\n+        userService.save(user);\n+\n+        return Response.ok().build();", "originalCommit": "60170571ae8690a6d0eccd07e098dd0e3ac07123", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwNzUwNA==", "url": "https://github.com/Graylog2/graylog2-server/pull/8712#discussion_r466407504", "body": "We have quite some duplication in `#addUser` and `#removeUser`. How about creating a private method to avoid the duplication? :slightly_smiling_face: (e.g. `updateUserRoles(username, roles -> roles.remove(roleId))` or something similar)", "bodyText": "We have quite some duplication in #addUser and #removeUser. How about creating a private method to avoid the duplication? \ud83d\ude42 (e.g. updateUserRoles(username, roles -> roles.remove(roleId)) or something similar)", "bodyHTML": "<p dir=\"auto\">We have quite some duplication in <code>#addUser</code> and <code>#removeUser</code>. How about creating a private method to avoid the duplication? <g-emoji class=\"g-emoji\" alias=\"slightly_smiling_face\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f642.png\">\ud83d\ude42</g-emoji> (e.g. <code>updateUserRoles(username, roles -&gt; roles.remove(roleId))</code> or something similar)</p>", "author": "bernd", "createdAt": "2020-08-06T13:22:22Z", "path": "graylog2-server/src/main/java/org/graylog/security/authzroles/AuthzRolesResource.java", "diffHunk": "@@ -126,7 +180,53 @@ public AuthzRoleDTO get(@ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlan\n             throw new BadRequestException(\"Invalid argument in search query: \" + e.getMessage());\n         }\n \n-        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(searchQuery, page, perPage,sort, order, username);\n+        final PaginatedList<AuthzRoleDTO> result = authzRolesService.findPaginatedForUser(\n+                searchQuery, page, perPage,sort, order, username);\n         return PaginatedResponse.create(\"roles\", result, query);\n     }\n+\n+    @PUT\n+    @Produces(MediaType.APPLICATION_JSON)\n+    @ApiOperation(\"Add a user to a role\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    @Path(\"{roleId}/assignee/add/{username}\")\n+    public Response addUser(\n+            @ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlank String roleId,\n+            @ApiParam(name = \"username\") @PathParam(\"username\") @NotBlank String username) throws ValidationException {\n+        checkPermission(USERS_EDIT, username);\n+\n+        final User user = userService.load(username);\n+        if (user == null) {\n+            throw new NotFoundException(\"Cannot find user with name: \" + username);\n+        }\n+        authzRolesService.get(roleId).orElseThrow(() -> new NotFoundException(\"Cannot find role with id: \" + roleId));\n+        Set<String> roles = user.getRoleIds();\n+        roles.add(roleId);\n+        user.setRoleIds(roles);\n+        userService.save(user);\n+\n+        return Response.ok().build();\n+    }\n+\n+    @PUT\n+    @ApiOperation(\"Remove a member to a team\")\n+    @Path(\"{roleId}/assignee/remove/{username}\")\n+    @AuditEvent(type = AuditEventTypes.USER_UPDATE)\n+    public Response removeUser(\n+            @ApiParam(name = \"roleId\") @PathParam(\"roleId\") @NotBlank String roleId,\n+            @ApiParam(name = \"username\") @PathParam(\"username\") @NotBlank String username) throws ValidationException {\n+        checkPermission(USERS_EDIT, username);\n+\n+        final User user = userService.load(username);\n+        if (user == null) {\n+            throw new NotFoundException(\"Cannot find user with name: \" + username);\n+        }\n+        authzRolesService.get(roleId).orElseThrow(() -> new NotFoundException(\"Cannot find role with id: \" + roleId));\n+        Set<String> roles = user.getRoleIds();\n+        roles.remove(roleId);\n+        user.setRoleIds(roles);\n+        userService.save(user);", "originalCommit": "60170571ae8690a6d0eccd07e098dd0e3ac07123", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fcbd4d197a3049f437e6b9f2fb481f6b0ea2365a", "url": "https://github.com/Graylog2/graylog2-server/commit/fcbd4d197a3049f437e6b9f2fb481f6b0ea2365a", "message": "Fix annotations from @bernd", "committedDate": "2020-08-07T08:27:48Z", "type": "forcePushed"}, {"oid": "37ecf3642aabfd70f27814ab4fbdf15ff649ba17", "url": "https://github.com/Graylog2/graylog2-server/commit/37ecf3642aabfd70f27814ab4fbdf15ff649ba17", "message": "Add missing routes to AuthzRolesResource\n\nPrior this change, there was no way to get all users which had a certain\nrole assigned. Also the user wanted to add and remove users from the\nrole.\n\nWith this change three new routes were introduced:\n   - get all users for a role\n   - add a role to a user\n   - remove a role from a user", "committedDate": "2020-08-07T11:58:04Z", "type": "commit"}, {"oid": "a9c0bb8e7fc9b2b58711f401289a47bcd8ef43df", "url": "https://github.com/Graylog2/graylog2-server/commit/a9c0bb8e7fc9b2b58711f401289a47bcd8ef43df", "message": "Fix annotations from @bernd", "committedDate": "2020-08-07T11:58:04Z", "type": "commit"}, {"oid": "3c67789c35152bcbfa15b695978bf0ef1503c0fd", "url": "https://github.com/Graylog2/graylog2-server/commit/3c67789c35152bcbfa15b695978bf0ef1503c0fd", "message": "Add missing delete route", "committedDate": "2020-08-07T12:15:05Z", "type": "commit"}, {"oid": "3c67789c35152bcbfa15b695978bf0ef1503c0fd", "url": "https://github.com/Graylog2/graylog2-server/commit/3c67789c35152bcbfa15b695978bf0ef1503c0fd", "message": "Add missing delete route", "committedDate": "2020-08-07T12:15:05Z", "type": "forcePushed"}]}