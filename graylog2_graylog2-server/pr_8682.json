{"pr_number": 8682, "pr_title": "Making LDAP TLS/SSL tests faster and more reliable.", "pr_author": "dennisoelkers", "pr_createdAt": "2020-08-03T14:11:20Z", "pr_url": "https://github.com/Graylog2/graylog2-server/pull/8682", "timeline": [{"oid": "11c2fc17f095f6c223652bf9b9e126987d545ac6", "url": "https://github.com/Graylog2/graylog2-server/commit/11c2fc17f095f6c223652bf9b9e126987d545ac6", "message": "Making LDAP TLS/SSL tests faster and more reliable.\n\nThis change is doing two things for the LDAP authenticator SSL/TLS tests:\n\n1.) Making them more reliable\n  Before this change, running the complete test class worked, but\n  running individual tests could result in test failures. This is related\n  to different exception classes being thrown, depending on if a\n  connection was attempted before or not. The real root cause for this is\n  unknown. The exceptions are thrown in two different places:\n    - When writing the initial packet (`InvalidConnectionException`), or\n    - When parsing the response (`LdapProtocolErrorException`)\n\n  As I was unable to find out the underlying cause, the assertions for\n  failed connections were relaxed. Instead of checking for the exact\n  exception class, we are now checking if an exception was thrown at all.\n  Together with the positive cases (connection works -> no exception is\n  thrown), this should still provide a reliable test coverage.\n\n2.) Making them faster\n  Before this change, the container was started/stopped for each test\n  (method). This change is now starting the container once for the\n  complete class, reducing runtime significantly (on my machine from 14.895s\n  down to 1.114s).", "committedDate": "2020-08-03T14:09:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ2NjI0OQ==", "url": "https://github.com/Graylog2/graylog2-server/pull/8682#discussion_r464466249", "body": "How about doing this as a try-with-resource?\r\nThat ensures cleanup even if we hit an exception\r\n```suggestion\r\n        try (final LdapNetworkConnection connection = ldapConnector.connect(request)) {\r\n            assertThat(connection.isAuthenticated()).isTrue();\r\n            assertThat(connection.isConnected()).isTrue();\r\n            assertThat(connection.isSecured()).isTrue();\r\n        }\r\n```", "bodyText": "How about doing this as a try-with-resource?\nThat ensures cleanup even if we hit an exception\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final LdapNetworkConnection connection = ldapConnector.connect(request);\n          \n          \n            \n                    assertThat(connection.isAuthenticated()).isTrue();\n          \n          \n            \n                    assertThat(connection.isConnected()).isTrue();\n          \n          \n            \n                    assertThat(connection.isSecured()).isTrue();\n          \n          \n            \n            \n          \n          \n            \n                    connection.close();\n          \n          \n            \n                    try (final LdapNetworkConnection connection = ldapConnector.connect(request)) {\n          \n          \n            \n                        assertThat(connection.isAuthenticated()).isTrue();\n          \n          \n            \n                        assertThat(connection.isConnected()).isTrue();\n          \n          \n            \n                        assertThat(connection.isSecured()).isTrue();\n          \n          \n            \n                    }", "bodyHTML": "<p dir=\"auto\">How about doing this as a try-with-resource?<br>\nThat ensures cleanup even if we hit an exception</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">final</span> <span class=\"pl-smi\">LdapNetworkConnection</span> connection <span class=\"pl-k\">=</span> ldapConnector<span class=\"pl-k\">.</span>connect(request);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        assertThat(connection<span class=\"pl-k\">.</span>isAuthenticated())<span class=\"pl-k\">.</span>isTrue();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        assertThat(connection<span class=\"pl-k\">.</span>isConnected())<span class=\"pl-k\">.</span>isTrue();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        assertThat(connection<span class=\"pl-k\">.</span>isSecured())<span class=\"pl-k\">.</span>isTrue();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        connection<span class=\"pl-k\">.</span>close();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">try</span> (<span class=\"pl-k\">final</span> <span class=\"pl-smi\">LdapNetworkConnection</span> connection <span class=\"pl-k\">=</span> ldapConnector<span class=\"pl-k\">.</span>connect(request)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            assertThat(connection<span class=\"pl-k\">.</span>isAuthenticated())<span class=\"pl-k\">.</span>isTrue();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            assertThat(connection<span class=\"pl-k\">.</span>isConnected())<span class=\"pl-k\">.</span>isTrue();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            assertThat(connection<span class=\"pl-k\">.</span>isSecured())<span class=\"pl-k\">.</span>isTrue();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "mpfz0r", "createdAt": "2020-08-03T14:54:10Z", "path": "graylog2-server/src/test/java/org/graylog2/security/ldap/LdapConnectorSSLTLSIT.java", "diffHunk": "@@ -194,11 +188,17 @@ private LdapTestConfigRequest createRequest(URI uri, boolean startTls, boolean t\n         );\n     }\n \n-    private void assertConnectionSuccess(LdapTestConfigRequest request) throws KeyStoreException, LdapException, NoSuchAlgorithmException {\n+    private void assertConnectionFailure(LdapTestConfigRequest request) {\n+        Assertions.assertThatThrownBy(() -> ldapConnector.connect(request)).isNotNull();\n+    }\n+\n+    private void assertConnectionSuccess(LdapTestConfigRequest request) throws KeyStoreException, LdapException, NoSuchAlgorithmException, IOException {\n         final LdapNetworkConnection connection = ldapConnector.connect(request);\n         assertThat(connection.isAuthenticated()).isTrue();\n         assertThat(connection.isConnected()).isTrue();\n         assertThat(connection.isSecured()).isTrue();\n+\n+        connection.close();", "originalCommit": "11c2fc17f095f6c223652bf9b9e126987d545ac6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f2899be486adcbabd96e08d4db766ca5e8bead59", "url": "https://github.com/Graylog2/graylog2-server/commit/f2899be486adcbabd96e08d4db766ca5e8bead59", "message": "Using try-with-resource for connection handling.\n\nCo-authored-by: Marco Pfatschbacher <marco@graylog.com>", "committedDate": "2020-08-04T08:00:09Z", "type": "commit"}]}