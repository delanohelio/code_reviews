{"pr_number": 4433, "pr_title": "PAYARA-3324 APPSERV-16 APPSERV-23 Allow Encryption of Web Session Data and SFSBs Stored in Hazelcast", "pr_author": "Pandrex247", "pr_createdAt": "2020-01-14T17:36:06Z", "pr_url": "https://github.com/payara/Payara/pull/4433", "merge_commit": "23485190728045a71fccc013b87e5837264d412a", "timeline": [{"oid": "2ddb2b43de1cd345f3ae46f2caf2b127323f74a6", "url": "https://github.com/payara/Payara/commit/2ddb2b43de1cd345f3ae46f2caf2b127323f74a6", "message": "PAYARA-3324 Generate encryption key and initial symmetric encryptor impl", "committedDate": "2020-01-14T16:50:04Z", "type": "commit"}, {"oid": "0a427d94a45af5ea70858a79c9167b0f2d3ba409", "url": "https://github.com/payara/Payara/commit/0a427d94a45af5ea70858a79c9167b0f2d3ba409", "message": "PAYARA-3324 sync datagrid key, and throw unprocessed event", "committedDate": "2020-01-14T16:50:24Z", "type": "commit"}, {"oid": "9a3f9423f21322caa22a99544a7d725412432f5e", "url": "https://github.com/payara/Payara/commit/9a3f9423f21322caa22a99544a7d725412432f5e", "message": "PAYARA-3324 Don't apply changes until restart and correct logic", "committedDate": "2020-01-14T16:50:35Z", "type": "commit"}, {"oid": "363119bc56fe5cdc5b1c09244653eb9378218327", "url": "https://github.com/payara/Payara/commit/363119bc56fe5cdc5b1c09244653eb9378218327", "message": "PAYARA-3324 APPSERV-23 Initial impl of session data encryption", "committedDate": "2020-01-14T16:50:54Z", "type": "commit"}, {"oid": "cf36e0d5384f536911760495ac81e3f4507c0e19", "url": "https://github.com/payara/Payara/commit/cf36e0d5384f536911760495ac81e3f4507c0e19", "message": "PAYARA-3324 Add SFSB Test", "committedDate": "2020-01-14T16:50:54Z", "type": "commit"}, {"oid": "62bcc30923c8bdb4bfcd0eb5446b971885817e4a", "url": "https://github.com/payara/Payara/commit/62bcc30923c8bdb4bfcd0eb5446b971885817e4a", "message": "PAYARA-3324 Copyright and formatting", "committedDate": "2020-01-14T16:50:56Z", "type": "commit"}, {"oid": "36c779e5b3ff4fd48062de7c3b8d71c6f7cf3067", "url": "https://github.com/payara/Payara/commit/36c779e5b3ff4fd48062de7c3b8d71c6f7cf3067", "message": "PAYARA-3324 Moar copyright", "committedDate": "2020-01-14T17:30:17Z", "type": "commit"}, {"oid": "93024348d2b320a12991bcc36a1c12bf08bb3408", "url": "https://github.com/payara/Payara/commit/93024348d2b320a12991bcc36a1c12bf08bb3408", "message": "PAYARA-3324 Prompt for key regeneration upon changing master password", "committedDate": "2020-01-15T17:08:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMwMzM4NA==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367303384", "body": "I assume you have thought about it decided not throwing an exception is the way to go. Just want to point this out once more as it looks like a \"throw exception\" situation.", "bodyText": "I assume you have thought about it decided not throwing an exception is the way to go. Just want to point this out once more as it looks like a \"throw exception\" situation.", "bodyHTML": "<p dir=\"auto\">I assume you have thought about it decided not throwing an exception is the way to go. Just want to point this out once more as it looks like a \"throw exception\" situation.</p>", "author": "jbee", "createdAt": "2020-01-16T09:09:40Z", "path": "appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java", "diffHunk": "@@ -73,40 +74,45 @@ public BackingStoreFactory getBackingStoreFactory() {\n     @Override\n     public V load(K k, String string) throws BackingStoreException {\n         init();\n-        return imap.get(k);\n+        try {\n+            return (V) clusteredStore.get(storeName, k);\n+        } catch (ClassCastException cce) {\n+            Logger.getLogger(HazelcastBackingStore.class.getName()).log(Level.WARNING,\n+                    \"ClassCastException when reading value from store, returning null\", cce);\n+            return null;", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5MjAzOA==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367392038", "bodyText": "Hmm, can't remember my exact intention here actually...\nReading the Javadoc for BackingStore would indicate that it probably should throw an exception - I'll make the change", "author": "Pandrex247", "createdAt": "2020-01-16T12:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMwMzM4NA=="}], "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java\nindex e7d3f37a6a..4ad9694c00 100644\n--- a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java\n+++ b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java\n", "chunk": "@@ -78,8 +78,8 @@ public class HazelcastBackingStore<K extends Serializable, V extends Serializabl\n             return (V) clusteredStore.get(storeName, k);\n         } catch (ClassCastException cce) {\n             Logger.getLogger(HazelcastBackingStore.class.getName()).log(Level.WARNING,\n-                    \"ClassCastException when reading value from store, returning null\", cce);\n-            return null;\n+                    \"ClassCastException when reading value from store\", cce);\n+            throw new BackingStoreException(cce.getMessage());\n         }\n     }\n \n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java\nindex e7d3f37a6a..4ad9694c00 100644\n--- a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java\n+++ b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStore.java\n", "chunk": "@@ -78,8 +78,8 @@ public class HazelcastBackingStore<K extends Serializable, V extends Serializabl\n             return (V) clusteredStore.get(storeName, k);\n         } catch (ClassCastException cce) {\n             Logger.getLogger(HazelcastBackingStore.class.getName()).log(Level.WARNING,\n-                    \"ClassCastException when reading value from store, returning null\", cce);\n-            return null;\n+                    \"ClassCastException when reading value from store\", cce);\n+            throw new BackingStoreException(cce.getMessage());\n         }\n     }\n \n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "efb512eabc3f44b343ec9a9885dc4a1b5b78dbef", "committedDate": "2020-12-08 13:43:33 -0600", "message": "Upgrade Payara to Hazelcast 4.1 (#5014)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzMzY1MA==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367333650", "body": "The `TestEjb` could implement `toString` to do this. The current implementation also has basically the same code twice which also should benefit from such a `toString` implementation.", "bodyText": "The TestEjb could implement toString to do this. The current implementation also has basically the same code twice which also should benefit from such a toString implementation.", "bodyHTML": "<p dir=\"auto\">The <code>TestEjb</code> could implement <code>toString</code> to do this. The current implementation also has basically the same code twice which also should benefit from such a <code>toString</code> implementation.</p>", "author": "jbee", "createdAt": "2020-01-16T10:12:26Z", "path": "appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) 2020 Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.samples.datagridencryption.sfsb;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+import javax.naming.InitialContext;\n+import javax.naming.NamingException;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import java.io.Serializable;\n+import java.util.Random;\n+\n+/**\n+ * @author Andrew Pielage <andrew.pielage@payara.fish>\n+ */\n+@ApplicationScoped\n+@Path(\"/TestEjb\")\n+public class TestEjbEndpoints implements Serializable {\n+\n+    @Inject\n+    TestEjb testEjb;\n+\n+    @Inject\n+    TestEjb testEjb2;\n+\n+    @GET\n+    public String testEjb() {\n+        testEjb.addItem(\"apple\");\n+        testEjb.addItem(\"pear\");\n+        testEjb.addItem(\"bear\");\n+        testEjb.removeItem(\"bear\");\n+\n+        String items = \"\";\n+        for (String item : testEjb.getItems()) {\n+            items += item + \",\";\n+        }\n+        items = items.substring(0, items.length() - 1);\n+        return items;\n+    }\n+\n+    @GET\n+    @Path(\"2\")\n+    public String testEjb2() {\n+        testEjb2.addItem(\"bapple\");\n+        testEjb2.addItem(\"bear\");\n+        testEjb2.addItem(\"care\");\n+        testEjb2.removeItem(\"bear\");\n+\n+        String items = \"\";\n+        for (String item : testEjb2.getItems()) {\n+            items += item + \",\";\n+        }\n+        items = items.substring(0, items.length() - 1);", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java b/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java\nindex f496e433a5..821f4f1dd6 100644\n--- a/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java\n+++ b/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java\n", "chunk": "@@ -84,12 +79,7 @@ public class TestEjbEndpoints implements Serializable {\n         testEjb2.addItem(\"care\");\n         testEjb2.removeItem(\"bear\");\n \n-        String items = \"\";\n-        for (String item : testEjb2.getItems()) {\n-            items += item + \",\";\n-        }\n-        items = items.substring(0, items.length() - 1);\n-        return items;\n+        return testEjb2.getItems();\n     }\n \n     @GET\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java b/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java\nindex f496e433a5..821f4f1dd6 100644\n--- a/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java\n+++ b/appserver/tests/payara-samples/samples/datagrid-encryption/sfsb-passivation/src/main/java/fish/payara/samples/datagridencryption/sfsb/TestEjbEndpoints.java\n", "chunk": "@@ -84,12 +79,7 @@ public class TestEjbEndpoints implements Serializable {\n         testEjb2.addItem(\"care\");\n         testEjb2.removeItem(\"bear\");\n \n-        String items = \"\";\n-        for (String item : testEjb2.getItems()) {\n-            items += item + \",\";\n-        }\n-        items = items.substring(0, items.length() - 1);\n-        return items;\n+        return testEjb2.getItems();\n     }\n \n     @GET\n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "e2a53d74a3a2eb04aec09b9a62f9281292637f23", "committedDate": "2021-01-20 14:56:33 -0600", "message": "[QACI-454] Payara Samples fixes (#5085)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzNjMzNQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367336335", "body": "A helper method `void runCommand(String logMsg, String... cmdArgs)` would make the above much more readable.", "bodyText": "A helper method void runCommand(String logMsg, String... cmdArgs) would make the above much more readable.", "bodyHTML": "<p dir=\"auto\">A helper method <code>void runCommand(String logMsg, String... cmdArgs)</code> would make the above much more readable.</p>", "author": "jbee", "createdAt": "2020-01-16T10:17:59Z", "path": "appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java", "diffHunk": "@@ -739,5 +739,84 @@ public static KeyStore getKeyStore(\n             throw new RuntimeException(ex);\n         }\n     }\n+\n+    public static void enableDataGridEncryption() {\n+        String javaEEServer = System.getProperty(\"javaEEServer\");\n+        if (\"payara-remote\".equals(javaEEServer)) {\n+            System.out.println(\"Enabling Data Grid Encryption\");\n+            List<String> cmd = new ArrayList<>();\n+            cmd.add(\"set-hazelcast-configuration\");\n+            cmd.add(\"--encryptdatagrid\");\n+            cmd.add(\"true\");\n+            CliCommands.payaraGlassFish(cmd);\n+\n+            System.out.println(\"Stopping Server\");\n+            String domain = System.getProperty(\"payara.domain.name\", \"domain1\");\n+            if (domain != null) {\n+                domain = getPayaraDomainFromServer();\n+                if (domain != null && !domain.equals(\"null\")) {\n+                    logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from server. \" +\n+                            \"If this is not correct use -Dpayara.domain.name to override.\");\n+                } else {\n+                    // Default to domain1\n+                    domain = \"domain1\";\n+                }\n+            }\n+            cmd = new ArrayList<>();\n+            cmd.add(\"stop-domain\");\n+            cmd.add(domain);\n+            CliCommands.payaraGlassFish(cmd);\n+\n+            System.out.println(\"Generating Encryption Key\");\n+            cmd = new ArrayList<>();\n+            cmd.add(\"-W\");\n+            cmd.add(Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\");\n+            cmd.add(\"generate-encryption-key\");\n+            CliCommands.payaraGlassFish(cmd);\n+\n+            System.out.println(\"Restarting Server\");\n+            cmd = new ArrayList<>();\n+            cmd.add(\"start-domain\");\n+            cmd.add(domain);\n+            CliCommands.payaraGlassFish(cmd);", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\nindex a12f3a4d2b..fd89bbe557 100644\n--- a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n+++ b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n", "chunk": "@@ -762,23 +758,15 @@ public class ServerOperations {\n                     domain = \"domain1\";\n                 }\n             }\n-            cmd = new ArrayList<>();\n-            cmd.add(\"stop-domain\");\n-            cmd.add(domain);\n-            CliCommands.payaraGlassFish(cmd);\n+            CliCommands.payaraGlassFish(\"stop-domain\", domain);\n \n             System.out.println(\"Generating Encryption Key\");\n-            cmd = new ArrayList<>();\n-            cmd.add(\"-W\");\n-            cmd.add(Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\");\n-            cmd.add(\"generate-encryption-key\");\n-            CliCommands.payaraGlassFish(cmd);\n+            CliCommands.payaraGlassFish(\"-W\",\n+                    Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\",\n+                    \"generate-encryption-key\");\n \n             System.out.println(\"Restarting Server\");\n-            cmd = new ArrayList<>();\n-            cmd.add(\"start-domain\");\n-            cmd.add(domain);\n-            CliCommands.payaraGlassFish(cmd);\n+            CliCommands.payaraGlassFish(\"start-domain\", domain);\n         } else {\n             if (javaEEServer == null) {\n                 System.out.println(\"javaEEServer not specified\");\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\nindex a12f3a4d2b..fd89bbe557 100644\n--- a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n+++ b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n", "chunk": "@@ -762,23 +758,15 @@ public class ServerOperations {\n                     domain = \"domain1\";\n                 }\n             }\n-            cmd = new ArrayList<>();\n-            cmd.add(\"stop-domain\");\n-            cmd.add(domain);\n-            CliCommands.payaraGlassFish(cmd);\n+            CliCommands.payaraGlassFish(\"stop-domain\", domain);\n \n             System.out.println(\"Generating Encryption Key\");\n-            cmd = new ArrayList<>();\n-            cmd.add(\"-W\");\n-            cmd.add(Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\");\n-            cmd.add(\"generate-encryption-key\");\n-            CliCommands.payaraGlassFish(cmd);\n+            CliCommands.payaraGlassFish(\"-W\",\n+                    Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\",\n+                    \"generate-encryption-key\");\n \n             System.out.println(\"Restarting Server\");\n-            cmd = new ArrayList<>();\n-            cmd.add(\"start-domain\");\n-            cmd.add(domain);\n-            CliCommands.payaraGlassFish(cmd);\n+            CliCommands.payaraGlassFish(\"start-domain\", domain);\n         } else {\n             if (javaEEServer == null) {\n                 System.out.println(\"javaEEServer not specified\");\n", "next_change": {"commit": "91c858c6d33e7cef6298ef3f04cb774d3aee7d9f", "changed_code": [{"header": "diff --git a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\nindex fd89bbe557..05ab298bec 100644\n--- a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n+++ b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n", "chunk": "@@ -756,14 +756,17 @@ public class ServerOperations {\n                 } else {\n                     // Default to domain1\n                     domain = \"domain1\";\n+                    logger.info(\"Using default domain \\\"\" + domain + \"\\\".\");\n                 }\n+            } else {\n+                logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from system property.\");\n             }\n             CliCommands.payaraGlassFish(\"stop-domain\", domain);\n \n             System.out.println(\"Generating Encryption Key\");\n             CliCommands.payaraGlassFish(\"-W\",\n                     Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\",\n-                    \"generate-encryption-key\");\n+                    \"generate-encryption-key\", domain);\n \n             System.out.println(\"Restarting Server\");\n             CliCommands.payaraGlassFish(\"start-domain\", domain);\n", "next_change": {"commit": "23ed2ccf8114a6970dca89bb39c771ffdd866e5e", "changed_code": [{"header": "diff --git a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\nindex 05ab298bec..f1b64a57aa 100644\n--- a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n+++ b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n", "chunk": "@@ -741,72 +541,51 @@ public class ServerOperations {\n     }\n \n     public static void enableDataGridEncryption() {\n-        String javaEEServer = System.getProperty(\"javaEEServer\");\n-        if (\"payara-remote\".equals(javaEEServer)) {\n-            System.out.println(\"Enabling Data Grid Encryption\");\n-            CliCommands.payaraGlassFish(\"set-hazelcast-configuration\", \"--encryptdatagrid\", \"true\");\n-\n-            System.out.println(\"Stopping Server\");\n-            String domain = System.getProperty(\"payara.domain.name\");\n-            if (domain == null) {\n-                domain = getPayaraDomainFromServer();\n-                if (domain != null && !domain.equals(\"null\")) {\n-                    logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from server. \" +\n-                            \"If this is not correct use -Dpayara.domain.name to override.\");\n-                } else {\n-                    // Default to domain1\n-                    domain = \"domain1\";\n-                    logger.info(\"Using default domain \\\"\" + domain + \"\\\".\");\n-                }\n-            } else {\n-                logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from system property.\");\n-            }\n-            CliCommands.payaraGlassFish(\"stop-domain\", domain);\n+        if (!isServer()) {\n+            throw new IllegalStateException(ERR_MESSAGE_UNSUPPORTED);\n+        }\n+        logger.info(\"Enabling Data Grid Encryption\");\n+        CliCommands.payaraGlassFish(\"set-hazelcast-configuration\", \"--encryptdatagrid\", \"true\");\n \n-            System.out.println(\"Generating Encryption Key\");\n-            CliCommands.payaraGlassFish(\"-W\",\n-                    Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\",\n-                    \"generate-encryption-key\", domain);\n+        logger.info(\"Stopping Server\");\n+        String domain = getDomainName();\n+        CliCommands.payaraGlassFish(\"stop-domain\", domain);\n \n-            System.out.println(\"Restarting Server\");\n-            CliCommands.payaraGlassFish(\"start-domain\", domain);\n-        } else {\n-            if (javaEEServer == null) {\n-                System.out.println(\"javaEEServer not specified\");\n-            } else {\n-                System.out.println(javaEEServer + \" not supported\");\n-            }\n-        }\n+        logger.info(\"Generating Encryption Key\");\n+        CliCommands.payaraGlassFish(\"-W\",\n+                Paths.get(\"\").toAbsolutePath() + \"/src/test/resources/passwordfile.txt\",\n+                \"generate-encryption-key\", domain);\n+\n+        logger.info(\"Restarting Server\");\n+        CliCommands.payaraGlassFish(\"start-domain\", domain);\n     }\n \n     public static void disableDataGridEncryption() {\n-        String javaEEServer = System.getProperty(\"javaEEServer\");\n-        if (\"payara-remote\".equals(javaEEServer)) {\n-            System.out.println(\"Disabling Data Grid Encryption\");\n-            CliCommands.payaraGlassFish(\"set-hazelcast-configuration\", \"--encryptdatagrid\", \"false\");\n-\n-            String domain = System.getProperty(\"payara.domain.name\");\n-            if (domain == null) {\n-                domain = getPayaraDomainFromServer();\n-                if (domain != null && !domain.equals(\"null\")) {\n-                    logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from server. \" +\n-                            \"If this is not correct use -Dpayara.domain.name to override.\");\n-                } else {\n-                    // Default to domain1\n-                    domain = \"domain1\";\n-                    logger.info(\"Using default domain \\\"\" + domain + \"\\\".\");\n-                }\n+        if (!isServer()) {\n+            throw new IllegalStateException(ERR_MESSAGE_UNSUPPORTED);\n+        }\n+        logger.info(\"Disabling Data Grid Encryption\");\n+        CliCommands.payaraGlassFish(\"set-hazelcast-configuration\", \"--encryptdatagrid\", \"false\");\n+        restartContainer(getDomainName());\n+    }\n+\n+    public static String getDomainName() {\n+        String domain = System.getProperty(\"payara.domain.name\");\n+        if (domain == null) {\n+            domain = getPayaraDomainFromServer();\n+            if (domain != null) {\n+                logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from server. \" +\n+                        \"If this is not correct use -Dpayara.domain.name to override.\");\n             } else {\n-                logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from system property.\");\n+                // Default to domain1\n+                domain = \"domain1\";\n+                logger.info(\"Using default domain \\\"\" + domain + \"\\\".\");\n             }\n-            restartContainer(domain);\n         } else {\n-            if (javaEEServer == null) {\n-                System.out.println(\"javaEEServer not specified\");\n-            } else {\n-                System.out.println(javaEEServer + \" not supported\");\n-            }\n+            logger.info(\"Using domain \\\"\" + domain + \"\\\" obtained from system property.\");\n         }\n+\n+        return domain;\n     }\n }\n \n", "next_change": {"commit": "e2a53d74a3a2eb04aec09b9a62f9281292637f23", "changed_code": [{"header": "diff --git a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\nindex f1b64a57aa..b1e0403a43 100644\n--- a/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n+++ b/appserver/tests/payara-samples/test-utils/src/main/java/fish/payara/samples/ServerOperations.java\n", "chunk": "@@ -588,4 +643,3 @@ public class ServerOperations {\n         return domain;\n     }\n }\n-\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "bd84acd8852f926a11b2c885e636e821c870b58a", "committedDate": "2020-02-13 11:36:25 +0000", "message": "get domain even when restart required"}, {"oid": "91c858c6d33e7cef6298ef3f04cb774d3aee7d9f", "committedDate": "2020-02-28 12:45:48 +0000", "message": "APPSERV-88 Fix if condition check and add more logging"}, {"oid": "bfbbc8660650abb8871c35d5951e64e0bb5ec02b", "committedDate": "2020-03-03 09:38:05 +0000", "message": "Refactor redundant block"}, {"oid": "23ed2ccf8114a6970dca89bb39c771ffdd866e5e", "committedDate": "2020-12-09 22:34:36 -0600", "message": "QACI-454 QACI-595 more reliable samples (#5037)"}, {"oid": "e9a36f6601642e6ac79f915d86f2553e7f32c9ad", "committedDate": "2020-12-16 14:42:09 -0600", "message": "All certificates are gotten from the server now instead of hardcoded localhost, was not working on multi-homed hosts"}, {"oid": "e2a53d74a3a2eb04aec09b9a62f9281292637f23", "committedDate": "2021-01-20 14:56:33 -0600", "message": "[QACI-454] Payara Samples fixes (#5085)"}, {"oid": "2da14f430102b1e8eb2289d21b27d4b9c8328ddd", "committedDate": "2021-10-26 16:54:26 +0100", "message": "Merge pull request #5427 from JamesHillyard/FISH-5645"}, {"oid": "9cf1d539f16a468946d35f4402da46293e31de7f", "committedDate": "2022-06-09 08:38:03 -0300", "message": "FISH-1366 references to .jks changed to .p12"}, {"oid": "985123ffa04de69092d833f160cd528909d4c6be", "committedDate": "2022-07-14 09:54:58 +0100", "message": "Revert \"Merge pull request #5801 from luiseufrasio/FISH-1366\""}, {"oid": "07d527c92081ef530a7b2b20b7fd68846820ae72", "committedDate": "2022-12-20 09:30:06 -0300", "message": "FISH-6406 : keystore & cacerts migrated to PKCS12 format"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzODYzNw==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367338637", "body": "ouch ", "bodyText": "ouch", "bodyHTML": "<p dir=\"auto\">ouch</p>", "author": "jbee", "createdAt": "2020-01-16T10:22:36Z", "path": "nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java", "diffHunk": "@@ -120,11 +127,29 @@ protected int executeCommand() throws CommandException {\n             domainConfig.put(DomainConfig.K_SAVE_MASTER_PASSWORD, savemp);\n             manager.changeMasterPassword(domainConfig);\n \n+            try {\n+                if (dataGridEncryptionEnabled()) {\n+                    logger.warning(\"Data grid encryption is enabled - \" +\n+                            \"you will need to regenerate the encryption key\");\n+                }\n+            } catch (IOException | SAXException | ParserConfigurationException | NullPointerException exception) {\n+                logger.warning(\"Could not determine if data grid encryption is enabled - \" +\n+                        \"you will need to regenerate the encryption key if it is\");\n+            }\n+\n             return 0;\n         } catch(Exception e) {\n             throw new CommandException(e.getMessage(),e);\n         }\n     }\n+\n+    private boolean dataGridEncryptionEnabled() throws IOException, SAXException, ParserConfigurationException {\n+        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder builder = factory.newDocumentBuilder();\n+        Document document = builder.parse(getDomainXml());\n+        return Boolean.valueOf(document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n+                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\").getNodeValue());\n+    }", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwMzY5Nw==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367403697", "bodyText": "Yep, it's horrendously heavyweight: if you have any suggestions I'd love them.\nI don't have access to config beans from the CLI as the server isn't running.\nI looked at the MiniXmlParser class but that's specific to configs, not root level domain stuff.\nI could write my own XmlStreamParser as the hazelcast configuration tends to be at the top, but as the many comments in the other parsers state, you can't guarantee the order.\nProbably still quicker though, I'll have another look", "author": "Pandrex247", "createdAt": "2020-01-16T13:00:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzODYzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODY4MA==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367438680", "bodyText": "Only suggestion I have is to leave a comment on the method explaining why this has to be done this way, like \"Server isn't running, no access to config beans => have to do it manually\" so that later \"us\" seeing this don't go \"ouch, does this have to be like that?\" again.", "author": "jbee", "createdAt": "2020-01-16T14:13:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzODYzNw=="}], "type": "inlineReview", "revised_code": {"commit": "7d449bf7b9b98cd749077937fdd0a7d1470edc1f", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\nindex f412145e37..2b6b757fb4 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n", "chunk": "@@ -147,8 +148,12 @@ public class ChangeMasterPasswordCommandDAS extends LocalDomainCommand {\n         DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n         DocumentBuilder builder = factory.newDocumentBuilder();\n         Document document = builder.parse(getDomainXml());\n-        return Boolean.valueOf(document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n-                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\").getNodeValue());\n+        Node node = document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n+                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\");\n+        if (node == null) {\n+            return false;\n+        }\n+        return Boolean.valueOf(node.getNodeValue());\n     }\n }\n \n", "next_change": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\nindex 2b6b757fb4..515cbae4a0 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n", "chunk": "@@ -144,17 +154,7 @@ public class ChangeMasterPasswordCommandDAS extends LocalDomainCommand {\n         }\n     }\n \n-    private boolean dataGridEncryptionEnabled() throws IOException, SAXException, ParserConfigurationException {\n-        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n-        DocumentBuilder builder = factory.newDocumentBuilder();\n-        Document document = builder.parse(getDomainXml());\n-        Node node = document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n-                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\");\n-        if (node == null) {\n-            return false;\n-        }\n-        return Boolean.valueOf(node.getNodeValue());\n-    }\n+\n }\n \n \n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\nindex f412145e37..515cbae4a0 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n", "chunk": "@@ -143,13 +154,7 @@ public class ChangeMasterPasswordCommandDAS extends LocalDomainCommand {\n         }\n     }\n \n-    private boolean dataGridEncryptionEnabled() throws IOException, SAXException, ParserConfigurationException {\n-        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n-        DocumentBuilder builder = factory.newDocumentBuilder();\n-        Document document = builder.parse(getDomainXml());\n-        return Boolean.valueOf(document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n-                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\").getNodeValue());\n-    }\n+\n }\n \n \n", "next_change": {"commit": "e93dc735c57b6e44519915e616b4d429a8671b9a", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\nindex 515cbae4a0..33cd5d716c 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/ChangeMasterPasswordCommandDAS.java\n", "chunk": "@@ -140,22 +128,36 @@ public class ChangeMasterPasswordCommandDAS extends LocalDomainCommand {\n \n             try {\n                 if (dataGridEncryptionEnabled()) {\n-                    logger.warning(\"Data grid encryption is enabled - \" +\n-                            \"you will need to regenerate the encryption key\");\n+                    logger.warning(\n+                            \"Data grid encryption is enabled - \" + \"you will need to regenerate the encryption key\");\n                 }\n             } catch (IOException | XMLStreamException exception) {\n-                logger.warning(\"Could not determine if data grid encryption is enabled - \" +\n-                        \"you will need to regenerate the encryption key if it is\");\n+                logger.warning(\"Could not determine if data grid encryption is enabled - \"\n+                        + \"you will need to regenerate the encryption key if it is\");\n+            }\n+\n+            try {\n+                HashMap<String, String> additionalTrustandKeyStores = getAdditionalTrustandKeyStores();\n+                if (additionalTrustandKeyStores.containsKey(\"additionalKeyStores\")) {\n+                    logger.log(Level.INFO,\n+                            \"The passwords of the additional KeyStores {0} have not been changed - please update these manually to continue using them.\",\n+                            Arrays.toString(additionalTrustandKeyStores.get(\"additionalKeyStores\").split(\":\")));\n+\n+                }\n+                if (additionalTrustandKeyStores.containsKey(\"additionalTrustStores\")) {\n+                    logger.log(Level.INFO,\n+                            \"The passwords of the additional TrustStores {0} have not been changed - please update these manually to continue using them.\",\n+                            Arrays.toString(additionalTrustandKeyStores.get(\"additionalTrustStores\").split(\":\")));\n+                }\n+            } catch (IOException | XMLStreamException exception) {\n+                logger.warning(\n+                        \"Could not fetch additional Trust and Keystores - if there are additional Trust Stores or Key Stores, the passwords need to be updated in order to continue using them.\");\n             }\n \n             return 0;\n-        } catch(Exception e) {\n-            throw new CommandException(e.getMessage(),e);\n+        } catch (Exception e) {\n+            throw new CommandException(e.getMessage(), e);\n         }\n     }\n \n-\n }\n-\n-\n-\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "e93dc735c57b6e44519915e616b4d429a8671b9a", "committedDate": "2021-08-12 14:30:35 +0100", "message": "FISH-5639 Warning message only appears if additional stores are present"}, {"oid": "1a6da55a432e72706b7fdaf0ea61c6489fc59cc7", "committedDate": "2021-08-13 11:33:41 +0100", "message": "FISH-5639 Updated copyright and formatting"}, {"oid": "d17c32332f64725aff459f3da8a628c8a8c723bd", "committedDate": "2021-08-17 13:58:42 +0100", "message": "FISH-5639 Implemented suggested changes"}, {"oid": "e45a6e48223ff7f7ccb0a9e8f61261e09761c00b", "committedDate": "2021-08-18 16:14:35 +0100", "message": "FISH-5639 Changed method name"}, {"oid": "5b0c2a4090268ad8208c5e2597c4ae7a49901efa", "committedDate": "2021-08-18 16:41:17 +0100", "message": "FISH-5639 Formatting issue"}, {"oid": "8da74c97384fdaed1ad7720a63e2563f4e67d359", "committedDate": "2023-05-04 13:46:07 +0200", "message": "FISH-7359 fix change-master-password for jks keystores"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0MTA2Mg==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367341062", "body": "Choice of name is a bit unfortunate as there is a method of the same name in the super class which returns something else. ", "bodyText": "Choice of name is a bit unfortunate as there is a method of the same name in the super class which returns something else.", "bodyHTML": "<p dir=\"auto\">Choice of name is a bit unfortunate as there is a method of the same name in the super class which returns something else.</p>", "author": "jbee", "createdAt": "2020-01-16T10:27:38Z", "path": "nucleus/admin/server-mgmt/src/main/java/fish/payara/admin/servermgmt/cli/GenerateEncryptionKey.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) 2020 Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.admin.servermgmt.cli;\n+\n+import com.sun.enterprise.admin.servermgmt.cli.ChangeMasterPasswordCommandDAS;\n+import com.sun.enterprise.admin.servermgmt.cli.LocalDomainCommand;\n+import com.sun.enterprise.universal.i18n.LocalStringsImpl;\n+import com.sun.enterprise.util.HostAndPort;\n+import com.sun.enterprise.util.net.NetUtils;\n+import org.glassfish.api.admin.CommandException;\n+import org.glassfish.hk2.api.PerLookup;\n+import org.glassfish.security.common.FileProtectionUtility;\n+import org.jvnet.hk2.annotations.Service;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKey;\n+import javax.crypto.SecretKeyFactory;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.PBEKeySpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.security.AlgorithmParameters;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.SecureRandom;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.util.Base64;\n+import java.util.Random;\n+\n+@Service(name = \"generate-encryption-key\")\n+@PerLookup\n+public class GenerateEncryptionKey extends LocalDomainCommand {\n+\n+    private static final String DATAGRID_KEY_FILE = \"datagrid-key\";\n+    private static final LocalStringsImpl SERVERMGMT_CLI_STRINGS =\n+            new LocalStringsImpl(ChangeMasterPasswordCommandDAS.class);\n+    private static final Random random = new SecureRandom();\n+    private static final String PBKDF_ALGORITHM = \"PBKDF2WithHmacSHA1\";\n+    private static final int ITERATION_COUNT = 65556;\n+    private static final int KEYSIZE = 256;\n+    private static final String AES = \"AES\";\n+    private static final String AES_ALGORITHM = \"AES/CBC/PKCS5Padding\";\n+\n+    @Override\n+    protected int executeCommand() throws CommandException {\n+        checkDomainIsNotRunning();\n+        char[] masterPasswordChars = verifyMasterPassword();\n+\n+        File datagridKeyFile = new File(getServerDirs().getConfigDir(), DATAGRID_KEY_FILE);\n+        if (!datagridKeyFile.exists()) {\n+            createDatagridEncryptionKeyFile(datagridKeyFile);\n+        }\n+\n+        byte[] encodedKey = generateAndEncryptKey(masterPasswordChars);\n+\n+        try {\n+            Files.write(datagridKeyFile.toPath(), encodedKey);\n+        } catch (IOException ioe) {\n+            throw new CommandException(\"Error writing encoded key to file\", ioe);\n+        }\n+\n+        return 0;\n+    }\n+\n+    private void checkDomainIsNotRunning() throws CommandException {\n+        HostAndPort adminAddress = getAdminAddress();\n+        if (NetUtils.isRunning(adminAddress.getHost(), adminAddress.getPort())) {\n+            throw new CommandException(SERVERMGMT_CLI_STRINGS.get(\"domain.is.running\",\n+                    getDomainName(), getDomainRootDir()));\n+        }\n+    }\n+\n+    private char[] verifyMasterPassword() throws CommandException {", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzNzQ2MA==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367437460", "bodyText": "There's only so many names in the world.\nThis is a private method with a different return type and parameters - I think it's fine personally.", "author": "Pandrex247", "createdAt": "2020-01-16T14:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0MTA2Mg=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": null, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "3b0708be636196f6b3fb145f7841b20455dbdacd", "committedDate": "2020-02-28 12:11:33 +0000", "message": "CUSTCOM-213 Allow specifying domain name for generate-encryption-key command"}, {"oid": "e2a53d74a3a2eb04aec09b9a62f9281292637f23", "committedDate": "2021-01-20 14:56:33 -0600", "message": "[QACI-454] Payara Samples fixes (#5085)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NjU2Nw==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367346567", "body": "I'm no security expert but the use of random salt confuses me. If the salt is random there is no way to redo this even if we would know the master password. Hence, the master password is irrelevant for this and we could equally just use random bytes. AFAIK salt usually is a fix yet configurable string that isn't accessible from the \"outside\".\r\n@rdebusscher WDYT?\r\n\r\nWith random salt I assume there is no way to verify that an encryption key belongs to a certain master password? So we rely on that password and encryption key change together? Is this how this kind of thing is done?", "bodyText": "I'm no security expert but the use of random salt confuses me. If the salt is random there is no way to redo this even if we would know the master password. Hence, the master password is irrelevant for this and we could equally just use random bytes. AFAIK salt usually is a fix yet configurable string that isn't accessible from the \"outside\".\n@rdebusscher WDYT?\nWith random salt I assume there is no way to verify that an encryption key belongs to a certain master password? So we rely on that password and encryption key change together? Is this how this kind of thing is done?", "bodyHTML": "<p dir=\"auto\">I'm no security expert but the use of random salt confuses me. If the salt is random there is no way to redo this even if we would know the master password. Hence, the master password is irrelevant for this and we could equally just use random bytes. AFAIK salt usually is a fix yet configurable string that isn't accessible from the \"outside\".<br>\n<a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/rdebusscher/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/rdebusscher\">@rdebusscher</a> WDYT?</p>\n<p dir=\"auto\">With random salt I assume there is no way to verify that an encryption key belongs to a certain master password? So we rely on that password and encryption key change together? Is this how this kind of thing is done?</p>", "author": "jbee", "createdAt": "2020-01-16T10:39:25Z", "path": "nucleus/admin/server-mgmt/src/main/java/fish/payara/admin/servermgmt/cli/GenerateEncryptionKey.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) 2020 Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.admin.servermgmt.cli;\n+\n+import com.sun.enterprise.admin.servermgmt.cli.ChangeMasterPasswordCommandDAS;\n+import com.sun.enterprise.admin.servermgmt.cli.LocalDomainCommand;\n+import com.sun.enterprise.universal.i18n.LocalStringsImpl;\n+import com.sun.enterprise.util.HostAndPort;\n+import com.sun.enterprise.util.net.NetUtils;\n+import org.glassfish.api.admin.CommandException;\n+import org.glassfish.hk2.api.PerLookup;\n+import org.glassfish.security.common.FileProtectionUtility;\n+import org.jvnet.hk2.annotations.Service;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKey;\n+import javax.crypto.SecretKeyFactory;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.PBEKeySpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.security.AlgorithmParameters;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.SecureRandom;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.util.Base64;\n+import java.util.Random;\n+\n+@Service(name = \"generate-encryption-key\")\n+@PerLookup\n+public class GenerateEncryptionKey extends LocalDomainCommand {\n+\n+    private static final String DATAGRID_KEY_FILE = \"datagrid-key\";\n+    private static final LocalStringsImpl SERVERMGMT_CLI_STRINGS =\n+            new LocalStringsImpl(ChangeMasterPasswordCommandDAS.class);\n+    private static final Random random = new SecureRandom();\n+    private static final String PBKDF_ALGORITHM = \"PBKDF2WithHmacSHA1\";\n+    private static final int ITERATION_COUNT = 65556;\n+    private static final int KEYSIZE = 256;\n+    private static final String AES = \"AES\";\n+    private static final String AES_ALGORITHM = \"AES/CBC/PKCS5Padding\";\n+\n+    @Override\n+    protected int executeCommand() throws CommandException {\n+        checkDomainIsNotRunning();\n+        char[] masterPasswordChars = verifyMasterPassword();\n+\n+        File datagridKeyFile = new File(getServerDirs().getConfigDir(), DATAGRID_KEY_FILE);\n+        if (!datagridKeyFile.exists()) {\n+            createDatagridEncryptionKeyFile(datagridKeyFile);\n+        }\n+\n+        byte[] encodedKey = generateAndEncryptKey(masterPasswordChars);\n+\n+        try {\n+            Files.write(datagridKeyFile.toPath(), encodedKey);\n+        } catch (IOException ioe) {\n+            throw new CommandException(\"Error writing encoded key to file\", ioe);\n+        }\n+\n+        return 0;\n+    }\n+\n+    private void checkDomainIsNotRunning() throws CommandException {\n+        HostAndPort adminAddress = getAdminAddress();\n+        if (NetUtils.isRunning(adminAddress.getHost(), adminAddress.getPort())) {\n+            throw new CommandException(SERVERMGMT_CLI_STRINGS.get(\"domain.is.running\",\n+                    getDomainName(), getDomainRootDir()));\n+        }\n+    }\n+\n+    private char[] verifyMasterPassword() throws CommandException {\n+        String masterpassword = super.readFromMasterPasswordFile();\n+        if (masterpassword == null) {\n+            masterpassword = passwords.get(\"AS_ADMIN_MASTERPASSWORD\");\n+            if (masterpassword == null) {\n+                char[] masterpasswordChars = super.readPassword(SERVERMGMT_CLI_STRINGS.get(\"current.mp\"));\n+                masterpassword = masterpasswordChars != null ? new String(masterpasswordChars) : null;\n+            }\n+        }\n+        if (masterpassword == null) {\n+            throw new CommandException(SERVERMGMT_CLI_STRINGS.get(\"no.console\"));\n+        }\n+        if (!super.verifyMasterPassword(masterpassword)) {\n+            throw new CommandException(SERVERMGMT_CLI_STRINGS.get(\"incorrect.mp\"));\n+        }\n+\n+        return masterpassword.toCharArray();\n+    }\n+\n+    private void createDatagridEncryptionKeyFile(File datagridKeyFile) throws CommandException {\n+        try {\n+            // Windows defaults to essentially \"7\" for current user, Admins, and System\n+            Files.createFile(datagridKeyFile.toPath());\n+            FileProtectionUtility.chmod0600(datagridKeyFile);\n+        } catch (IOException ioe) {\n+            throw new CommandException(ioe.getMessage(), ioe);\n+        }\n+    }\n+\n+    private byte[] generateAndEncryptKey(char[] masterpasswordChars) throws CommandException {\n+        byte[] saltBytes = new byte[20];\n+        random.nextBytes(saltBytes);", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzOTE0Mw==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r368439143", "bodyText": "If the salt is random there is no way to redo this even if we would know the master password. With random salt I assume there is no way to verify that an encryption key belongs to a certain master password?\n\n@jbee Correct, but we also store the salt when we need the symmetric key. This implementation is correct. Lets recap the process.\n\nWe need a Symmetric Key for the encryption with the Data Grid (call it DataGridSymKey).\nThis key needs to be stored on disk because it needs to be transferred to to other nodes/instances. So we need to encrypt it when stored on disk.\nWe need to encrypt it with something user/domain specific which is already safely stored, like the master password\nPassword are bad for encryption because they are mostly too short, hence the use of the Key Derivation function.\nPBKDF needs a salt and password to generate an enhanced 'password' (which is again a Symmetric Key EncryptionSymKey, which can be used to encrypt the DataGridSymKey.\nWhen decoding to retrieve the DataGridSymKey, we need the EncryptionSymKey. This can be generated again using the Master password and the salt.\nThat is the reason why the salt is also part of the output (see line 165 and next)\n\nSo the salt is used to generate a unique key, although 2 systems have the same master password, the key is different .", "author": "rdebusscher", "createdAt": "2020-01-20T09:20:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NjU2Nw=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": null, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "3b0708be636196f6b3fb145f7841b20455dbdacd", "committedDate": "2020-02-28 12:11:33 +0000", "message": "CUSTCOM-213 Allow specifying domain name for generate-encryption-key command"}, {"oid": "e2a53d74a3a2eb04aec09b9a62f9281292637f23", "committedDate": "2021-01-20 14:56:33 -0600", "message": "[QACI-454] Payara Samples fixes (#5085)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0Nzg1Ng==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367347856", "body": "This code looks familiar...", "bodyText": "This code looks familiar...", "bodyHTML": "<p dir=\"auto\">This code looks familiar...</p>", "author": "jbee", "createdAt": "2020-01-16T10:42:09Z", "path": "nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java", "diffHunk": "@@ -242,4 +259,12 @@ private boolean isRunning(File instanceDir) throws CommandException {\n         }\n     }\n \n+    private boolean dataGridEncryptionEnabled() throws IOException, SAXException, ParserConfigurationException {\n+        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder builder = factory.newDocumentBuilder();\n+        Document document = builder.parse(getDomainXml());\n+        return Boolean.valueOf(document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n+                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\").getNodeValue());\n+    }", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "7d449bf7b9b98cd749077937fdd0a7d1470edc1f", "changed_code": [{"header": "diff --git a/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java b/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\nindex bc6ad70317..b547de6aca 100644\n--- a/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\n+++ b/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\n", "chunk": "@@ -263,8 +264,12 @@ public class ChangeNodeMasterPasswordCommand extends LocalInstanceCommand {\n         DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n         DocumentBuilder builder = factory.newDocumentBuilder();\n         Document document = builder.parse(getDomainXml());\n-        return Boolean.valueOf(document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n-                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\").getNodeValue());\n+        Node node = document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n+                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\");\n+        if (node == null) {\n+            return false;\n+        }\n+        return Boolean.valueOf(node.getNodeValue());\n     }\n \n }\n", "next_change": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java b/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\nindex b547de6aca..bc8316e699 100644\n--- a/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\n+++ b/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\n", "chunk": "@@ -260,16 +255,4 @@ public class ChangeNodeMasterPasswordCommand extends LocalInstanceCommand {\n         }\n     }\n \n-    private boolean dataGridEncryptionEnabled() throws IOException, SAXException, ParserConfigurationException {\n-        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n-        DocumentBuilder builder = factory.newDocumentBuilder();\n-        Document document = builder.parse(getDomainXml());\n-        Node node = document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n-                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\");\n-        if (node == null) {\n-            return false;\n-        }\n-        return Boolean.valueOf(node.getNodeValue());\n-    }\n-\n }\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java b/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\nindex bc6ad70317..bc8316e699 100644\n--- a/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\n+++ b/nucleus/cluster/cli/src/main/java/com/sun/enterprise/admin/cli/cluster/ChangeNodeMasterPasswordCommand.java\n", "chunk": "@@ -259,12 +255,4 @@ public class ChangeNodeMasterPasswordCommand extends LocalInstanceCommand {\n         }\n     }\n \n-    private boolean dataGridEncryptionEnabled() throws IOException, SAXException, ParserConfigurationException {\n-        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n-        DocumentBuilder builder = factory.newDocumentBuilder();\n-        Document document = builder.parse(getDomainXml());\n-        return Boolean.valueOf(document.getElementsByTagName(\"hazelcast-runtime-configuration\")\n-                .item(0).getAttributes().getNamedItem(\"datagrid-encryption-enabled\").getNodeValue());\n-    }\n-\n }\n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "e93dc735c57b6e44519915e616b4d429a8671b9a", "committedDate": "2021-08-12 14:30:35 +0100", "message": "FISH-5639 Warning message only appears if additional stores are present"}, {"oid": "1a6da55a432e72706b7fdaf0ea61c6489fc59cc7", "committedDate": "2021-08-13 11:33:41 +0100", "message": "FISH-5639 Updated copyright and formatting"}, {"oid": "d17c32332f64725aff459f3da8a628c8a8c723bd", "committedDate": "2021-08-17 13:58:42 +0100", "message": "FISH-5639 Implemented suggested changes"}, {"oid": "e45a6e48223ff7f7ccb0a9e8f61261e09761c00b", "committedDate": "2021-08-18 16:14:35 +0100", "message": "FISH-5639 Changed method name"}, {"oid": "5b0c2a4090268ad8208c5e2597c4ae7a49901efa", "committedDate": "2021-08-18 16:41:17 +0100", "message": "FISH-5639 Formatting issue"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0ODI1OQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367348259", "body": "Multi-threading?", "bodyText": "Multi-threading?", "bodyHTML": "<p dir=\"auto\">Multi-threading?</p>", "author": "jbee", "createdAt": "2020-01-16T10:43:03Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java", "diffHunk": "@@ -116,6 +118,8 @@\n     private String memberName;\n     private String memberGroup;\n \n+    private boolean datagridEncryptionChanged = false;", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NDc2Ng==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367444766", "bodyText": "I wouldn't say it's any more of an issue than the other variables - changes are made transactionally.", "author": "Pandrex247", "createdAt": "2020-01-16T14:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0ODI1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1MDQwNg==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367450406", "bodyText": "If the @Service does not cause some wrapper or extension of the class that does some black magic then I don't see how the field is properly made visible when one thread is reading while another one is writing. This might be my lack of knowledge on HK2 or it is actually a problem. It sure looks like one to me. I'd consider the possibility that the same problem exists for the other values :D", "author": "jbee", "createdAt": "2020-01-16T14:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0ODI1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 921a2b135e..0981207fa6 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -118,7 +118,7 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     private String memberName;\n     private String memberGroup;\n \n-    private boolean datagridEncryptionChanged = false;\n+    private boolean oldDatagridEncryptionValue;\n \n     @Inject\n     Events events;\n", "next_change": {"commit": "7a84767d6d1414fa5306fd394fb6d51d878804f2", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 0981207fa6..eae6db5bd8 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -118,7 +118,7 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     private String memberName;\n     private String memberGroup;\n \n-    private boolean oldDatagridEncryptionValue;\n+    private boolean datagridEncryptionValue;\n \n     @Inject\n     Events events;\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 921a2b135e..db3fc8117f 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -118,7 +118,7 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     private String memberName;\n     private String memberGroup;\n \n-    private boolean datagridEncryptionChanged = false;\n+    private boolean datagridEncryptionValue;\n \n     @Inject\n     Events events;\n", "next_change": {"commit": "1dd71b6238fdee76a5b3302a1518c8287b61fb59", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex db3fc8117f..38ea255b76 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -125,13 +127,13 @@ public class HazelcastCore implements EventListener, ConfigListener {\n \n     @Inject\n     ServerContext context;\n-    \n+\n     @Inject\n     ServerEnvironment env;\n \n     @Inject\n     HazelcastRuntimeConfiguration configuration;\n-    \n+\n     @Inject\n     HazelcastConfigSpecificConfiguration nodeConfig;\n \n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "dd07f55c8f6b0ce789b83f744fc16efb87d00648", "committedDate": "2020-01-29 15:32:14 +0000", "message": "CUSTCOM-24 Remove ThreadLocal Hazelcast disable"}, {"oid": "bce9309afdd64ac53f344b58cfb529ead1d1da6b", "committedDate": "2020-02-11 11:54:35 +0000", "message": "CUSTCOM-79 Remove default hazelcast start port value"}, {"oid": "12ae70674f3c57c7739556853f1b2d3d608f08a0", "committedDate": "2020-03-09 13:42:20 +0000", "message": "CUSTCOM-223 Move log message into if block"}, {"oid": "1dd71b6238fdee76a5b3302a1518c8287b61fb59", "committedDate": "2020-11-04 20:43:06 -0600", "message": "even more refactoring, separated initPublicAddress() and initBindAddress() and made them even more self-describing and autonomous"}, {"oid": "efb512eabc3f44b343ec9a9885dc4a1b5b78dbef", "committedDate": "2020-12-08 13:43:33 -0600", "message": "Upgrade Payara to Hazelcast 4.1 (#5014)"}, {"oid": "9067d0736c4e167118c9d2db9382fdaa50cf9ea0", "committedDate": "2020-12-08 17:31:54 -0600", "message": "introduce tenant control"}, {"oid": "d62090658ce38d6d5f47820b857ce3cb99732455", "committedDate": "2021-03-26 16:55:26 +0100", "message": "Revert \"FISH-858 Upgrade to Hazelcast 4.2 from 4.1 and use Tenant Control APIs\""}, {"oid": "0fe1775753c8777e968fd926290b7237f8b07a99", "committedDate": "2021-03-26 13:45:48 -0500", "message": "[FISH-858] Upgrade to Hazelcast 4.2 from 4.1 and use Tenant Control APIs (#5176)"}, {"oid": "dbba8a86c0f535c4a1e916714b4834cfd1121733", "committedDate": "2021-04-08 10:55:52 +0530", "message": "FISH-1280 Jakarta EE9: Compile Payara 6 artifact with Jakarta EE namespace"}, {"oid": "3b0086a8ebd1bdf984a1c295862e352fc4249a0d", "committedDate": "2021-06-09 13:19:10 +0530", "message": "FISH-1321 Copyright year update"}, {"oid": "bd6380d3bc4f01722a7f5ac2da377199c7a1c9b5", "committedDate": "2022-05-16 19:35:22 +0800", "message": "Bugfix postbootcommandfile argument execution"}, {"oid": "f44183586417f8698fabf7f045fe46267886f873", "committedDate": "2022-05-18 17:25:35 +0800", "message": "Bugfix postbootcommandfile argument execution"}, {"oid": "6e418d2d4b903dd9bddccfbccfe7587e91391f92", "committedDate": "2022-08-29 17:11:49 +0200", "message": "Have implemented the fix. INtegration tests in progress"}, {"oid": "a03fd87db043592af99392a1492e9f87ba90b87a", "committedDate": "2022-08-29 17:11:49 +0200", "message": "Update nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java"}, {"oid": "bce8422734744c075394119762ab93858ab257db", "committedDate": "2022-09-12 12:40:25 +0200", "message": "FISH-6501 fix bootcommandservice runlevel"}, {"oid": "8dc2ec4c0ba8d00aa7326570b088fec35f39ed69", "committedDate": "2022-09-12 12:52:40 +0200", "message": "FISH-6501 fix bootcommandservice runlevel"}, {"oid": "3c61a52fc8048c01da254852c96789287aca463e", "committedDate": "2022-09-21 11:19:13 +0100", "message": "Merge branch 'master' into FISH-372"}, {"oid": "3641bd845538899391f997ffb404e8faff63cad6", "committedDate": "2022-10-10 16:22:45 -0300", "message": "FISH-6500 : verifying file path existence"}, {"oid": "af357179c87ccbbddb0198c4534b4ea26f671bcb", "committedDate": "2022-10-11 12:04:19 -0300", "message": "FISH-6500 : fill the config hazelcast from file when server starts"}, {"oid": "1542280a08dd97f811c50e58a6c464a040c9960b", "committedDate": "2022-10-17 14:31:51 -0300", "message": "FISH-6500 : Log to inform hazelcast config from file"}, {"oid": "4259aa06b36e241b665cc172e01959664e85ee03", "committedDate": "2022-10-18 06:23:29 -0300", "message": "FISH-6500 : Unused imports and member removed"}, {"oid": "88defca0ab341784e1276b6c0cc863b2013a8d16", "committedDate": "2022-10-18 08:40:03 -0300", "message": "FISH-6500 : values not changing dinamically"}, {"oid": "ab64c299263521e52d8d5c89827a729f6e3a64c8", "committedDate": "2022-10-18 10:41:21 -0300", "message": "FISH-6500 : hazelcast config file being read at startup"}, {"oid": "4d2d278b084d9ebb58c6959f0af7c2e8f6121aeb", "committedDate": "2022-10-18 16:04:24 -0300", "message": "FISH-6500 : hazelcast config with default values setted"}, {"oid": "25172d8d82421512316bfe407e9ce57fc3b21a80", "committedDate": "2022-10-18 16:18:30 -0300", "message": "FISH-6500 : unnecessary throws removed"}, {"oid": "d5a7391cc7727e7965ed5da8ad16f0df62b0f208", "committedDate": "2022-10-18 16:46:57 -0300", "message": "FISH-6500 : setting default config"}, {"oid": "3153563ee6a8af1f8bdea09b7aeea185370e5f52", "committedDate": "2022-10-22 14:47:44 -0300", "message": "FISH-6495 : not using xsd package"}, {"oid": "4f802c07f1ce7071d0ae424cd43a3c0e22ba2178", "committedDate": "2022-10-22 18:04:36 -0300", "message": "FISH-6500 : fill defaults correctly"}, {"oid": "572c567f7295a65cbaa66f3fa7c5d95544d36527", "committedDate": "2022-10-22 21:46:13 -0300", "message": "FISH-6500 : removing xjc generated files references"}, {"oid": "ae649dc60446556d6e4c6bef49c8d99b2bf14156", "committedDate": "2022-10-24 10:13:51 +0100", "message": "Merge pull request #5904 from nicolasduminil/fish-372"}, {"oid": "5e9f5f620ea2ce0ea68e090e9daf6e3f5fb43f66", "committedDate": "2022-10-24 21:32:25 -0300", "message": "FISH-6495 : using hazelcast boostrap config property"}, {"oid": "bc4144c32b976880a71a365e04e2bf03d6f20b3e", "committedDate": "2022-10-25 09:24:56 +0100", "message": "Merge pull request #5995 from Pandrex247/FISH-372-P6"}, {"oid": "25e046c7a8de8fcbdeabc18832046718799f956d", "committedDate": "2022-10-27 14:14:34 -0300", "message": "FISH-6495 : setting hazelcast property when passed"}, {"oid": "505c1ae4879d617fcf686beee2145315d0e18867", "committedDate": "2023-01-16 12:19:32 +0000", "message": "FISH-6816 Merge Payara6 into master"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1MDAzMA==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367350030", "body": "Could be `return datagridEncryptionChanged ^ configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\")`\r\nbut I don't get who a method called `isDatagridEncryptionEnabled` would return `true` when the configuration is `false`. That does not make sense for me even if the encryption has changed.", "bodyText": "Could be return datagridEncryptionChanged ^ configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\")\nbut I don't get who a method called isDatagridEncryptionEnabled would return true when the configuration is false. That does not make sense for me even if the encryption has changed.", "bodyHTML": "<p dir=\"auto\">Could be <code>return datagridEncryptionChanged ^ configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\")</code><br>\nbut I don't get who a method called <code>isDatagridEncryptionEnabled</code> would return <code>true</code> when the configuration is <code>false</code>. That does not make sense for me even if the encryption has changed.</p>", "author": "jbee", "createdAt": "2020-01-16T10:46:54Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java", "diffHunk": "@@ -555,6 +561,26 @@ public int getPort() {\n \n     @Override\n     public UnprocessedChangeEvents changed(PropertyChangeEvent[] pces) {\n-        return null;\n+        List<UnprocessedChangeEvent> unprocessedChanges = new ArrayList<>();\n+        for (PropertyChangeEvent pce : pces) {\n+            if (pce.getPropertyName().equalsIgnoreCase(\"datagrid-encryption-enabled\")) {\n+                datagridEncryptionChanged = true;\n+                unprocessedChanges.add(new UnprocessedChangeEvent(pce, \"Hazelcast encryption settings changed\"));\n+            }\n+        }\n+\n+        if (unprocessedChanges.isEmpty()) {\n+            return null;\n+        }\n+        return new UnprocessedChangeEvents(unprocessedChanges);\n+    }\n+\n+    public boolean isDatagridEncryptionEnabled() {\n+        // If the datagrid encryption settings have changed, we want to return the opposite of the current setting\n+        // to prevent the server changing encryption behaviour without a restart\n+        if (datagridEncryptionChanged) {\n+            return !configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n+        }\n+        return  configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MzAyMg==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367443022", "bodyText": "I don't get who a method called isDatagridEncryptionEnabled would return true when the configuration is false. That does not make sense for me even if the encryption has changed.\n\nI tried to explain why in the comment but I'll expand.\nIf you've changed the settings (let's say you've enabled it), this will be replicated to both the domain.xml and the config bean - any call to HazelcastRuntimeConfiguration.getDatagridEncryptionEnabled will return true. However, we don't want to suddenly start demanding that everything be encrypted otherwise we'll end up with a clustered store where only some things are encrypted. So until restart, we want to return the opposite.\nAlthough now thinking about it again, the current impl is flawed in that if you enable it and then disable it again without restarting the server, it'll start saying it's enabled - I'll change it so it stores the old value as it's changed and returns that.", "author": "Pandrex247", "createdAt": "2020-01-16T14:21:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1MDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NjYyNg==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367446626", "bodyText": "That sounds more reasonable. As I understand it this should always return the initial value at start.", "author": "jbee", "createdAt": "2020-01-16T14:27:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1MDAzMA=="}], "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 921a2b135e..0981207fa6 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -578,9 +577,10 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     public boolean isDatagridEncryptionEnabled() {\n         // If the datagrid encryption settings have changed, we want to return the opposite of the current setting\n         // to prevent the server changing encryption behaviour without a restart\n-        if (datagridEncryptionChanged) {\n-            return !configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n+        boolean datagridEncryptionEnabled = configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n+        if (oldDatagridEncryptionValue != datagridEncryptionEnabled) {\n+            return oldDatagridEncryptionValue;\n         }\n-        return  configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n+        return datagridEncryptionEnabled;\n     }\n }\n", "next_change": {"commit": "7a84767d6d1414fa5306fd394fb6d51d878804f2", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 0981207fa6..eae6db5bd8 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -575,12 +575,8 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     }\n \n     public boolean isDatagridEncryptionEnabled() {\n-        // If the datagrid encryption settings have changed, we want to return the opposite of the current setting\n-        // to prevent the server changing encryption behaviour without a restart\n-        boolean datagridEncryptionEnabled = configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n-        if (oldDatagridEncryptionValue != datagridEncryptionEnabled) {\n-            return oldDatagridEncryptionValue;\n-        }\n-        return datagridEncryptionEnabled;\n+        // We want to return the value as it was at boot time here to prevent the server changing encryption behaviour\n+        // without a restart\n+        return datagridEncryptionValue;\n     }\n }\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 921a2b135e..db3fc8117f 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -576,11 +576,8 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     }\n \n     public boolean isDatagridEncryptionEnabled() {\n-        // If the datagrid encryption settings have changed, we want to return the opposite of the current setting\n-        // to prevent the server changing encryption behaviour without a restart\n-        if (datagridEncryptionChanged) {\n-            return !configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n-        }\n-        return  configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n+        // We want to return the value as it was at boot time here to prevent the server changing encryption behaviour\n+        // without a restart\n+        return datagridEncryptionValue;\n     }\n }\n", "next_change": {"commit": "af357179c87ccbbddb0198c4534b4ea26f671bcb", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex db3fc8117f..0aeb250b8f 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -580,4 +687,95 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         // without a restart\n         return datagridEncryptionValue;\n     }\n+\n+    public void fillConfigurationFromHazelcastElem(fish.payara.nucleus.hazelcast.xsd.Hazelcast hazelcast,\n+                                                   HazelcastRuntimeConfiguration configuration) {\n+        for (Object item : hazelcast.getImportOrConfigReplacersOrClusterName()) {\n+            JAXBElement element = (JAXBElement) item;\n+            if (element.getName().getLocalPart().equals(\"cluster-name\")) {\n+                configuration.setClusterGroupName((String) element.getValue());\n+                continue;\n+            }\n+            if (element.getName().getLocalPart().equals(\"license-key\")) {\n+                configuration.setLicenseKey((String) element.getValue());\n+                continue;\n+            }\n+            if (element.getDeclaredType().equals(Network.class)) {\n+                Network network = (Network) element.getValue();\n+                Port port = network.getPort();\n+                if (port != null) {\n+                    configuration.setDasPort(String.valueOf(port.getValue()));\n+                    configuration.setAutoIncrementPort(\"\" + port.isAutoIncrement());\n+                }\n+                if (network.getPublicAddress() != null\n+                        && !\"\".equals(network.getPublicAddress().trim())) {\n+                    configuration.setDASPublicAddress(network.getPublicAddress());\n+                }\n+                Interfaces networkInterfaces = network.getInterfaces();\n+                if (networkInterfaces != null && networkInterfaces.isEnabled()) {\n+                    configuration.setInterface(String.join(\",\", networkInterfaces.getInterface()));\n+                }\n+                Join join = network.getJoin();\n+                if (join != null) {\n+                    TcpIp tcpIp = join.getTcpIp();\n+                    if (tcpIp != null) {\n+                        for (JAXBElement member : tcpIp.getRequiredMemberOrMemberOrInterface()) {\n+                            if (member.getDeclaredType().equals(TcpIp.MemberList.class)) {\n+                                TcpIp.MemberList memberList = (TcpIp.MemberList) member.getValue();\n+                                configuration.setTcpipMembers(String.join(\",\", memberList.getMember()));\n+                            }\n+                        }\n+                    }\n+                    Multicast multicast = join.getMulticast();\n+                    if (multicast != null && multicast.isEnabled()) {\n+                        configuration.setMulticastGroup(multicast.getMulticastGroup());\n+                        configuration.setMulticastPort(String.valueOf(multicast.getMulticastPort()));\n+                    }\n+                    AliasedDiscoveryStrategy kubernetes = join.getKubernetes();\n+                    if (kubernetes != null && kubernetes.isEnabled()) {\n+                        for (Element e : kubernetes.getAny()) {\n+                            if (e.getLocalName().equals(\"namespace\")) {\n+                                configuration.setKubernetesNamespace(e.getFirstChild().getNodeValue());\n+                            } else if (e.getLocalName().equals(\"service-name\")) {\n+                                configuration.setKubernetesServiceName(e.getFirstChild().getNodeValue());\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    public void fillSpecificConfigFromHazelcastElem(fish.payara.nucleus.hazelcast.xsd.Hazelcast hazelcast,\n+                                                   HazelcastConfigSpecificConfiguration specificConfig) {\n+        for (Object item : hazelcast.getImportOrConfigReplacersOrClusterName()) {\n+            JAXBElement element = (JAXBElement) item;\n+            if (element.getName().getLocalPart().equals(\"lite-member\")) {\n+                LiteMember liteMember = (LiteMember) element.getValue();\n+                Boolean lite = liteMember.isEnabled();\n+                specificConfig.setLite(lite.toString());\n+                continue;\n+            }\n+            if (element.getDeclaredType().equals(ExecutorService.class)) {\n+                ExecutorService executorService = (ExecutorService) element.getValue();\n+                if (executorService.getPoolSize() != null) {\n+                    specificConfig.setExecutorPoolSize(String.valueOf(executorService.getPoolSize()));\n+                }\n+                if (executorService.getQueueCapacity() != null) {\n+                    specificConfig.setExecutorQueueCapacity(String.valueOf(executorService.getQueueCapacity()));\n+                }\n+                continue;\n+            }\n+            if (element.getDeclaredType().equals(ScheduledExecutorService.class)) {\n+                ScheduledExecutorService scheduledExecutorService = (ScheduledExecutorService) element.getValue();\n+                if (scheduledExecutorService.getPoolSize() != null) {\n+                    specificConfig.setScheduledExecutorPoolSize(String.valueOf(scheduledExecutorService.getPoolSize()));\n+                }\n+                if (scheduledExecutorService.getCapacity() != null) {\n+                    specificConfig.setScheduledExecutorQueueCapacity(String.valueOf(scheduledExecutorService.getCapacity()));\n+                }\n+                continue;\n+            }\n+        }\n+    }\n }\n", "next_change": {"commit": "4d2d278b084d9ebb58c6959f0af7c2e8f6121aeb", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 0aeb250b8f..a9f13f13e2 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -778,4 +788,58 @@ public class HazelcastCore implements EventListener, ConfigListener {\n             }\n         }\n     }\n+\n+    private void fillConfigurationWithDefaults() throws TransactionFailure {\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastRuntimeConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastRuntimeConfiguration hazelcastRuntimeConfiguration)\n+                    throws PropertyVetoException, TransactionFailure {\n+                hazelcastRuntimeConfiguration.setChangeToDefault(\"false\");\n+                hazelcastRuntimeConfiguration.setHazelcastConfigurationFile(\"hazelcast-config.xml\");\n+                hazelcastRuntimeConfiguration.setAutoIncrementPort(\"true\");\n+                hazelcastRuntimeConfiguration.setStartPort(\"5900\");\n+                hazelcastRuntimeConfiguration.setDASPublicAddress(\"\");\n+                hazelcastRuntimeConfiguration.setDASBindAddress(\"\");\n+                hazelcastRuntimeConfiguration.setDasPort(\"4900\");\n+                hazelcastRuntimeConfiguration.setMulticastGroup(\"224.2.2.3\");\n+                hazelcastRuntimeConfiguration.setMulticastPort(\"54327\");\n+                hazelcastRuntimeConfiguration.setTcpipMembers(\"127.0.0.1:5900\");\n+                hazelcastRuntimeConfiguration.setDnsMembers(\"localhost:5900\");\n+                hazelcastRuntimeConfiguration.setDiscoveryMode(\"domain\");\n+                hazelcastRuntimeConfiguration.setGenerateNames(\"false\");\n+                hazelcastRuntimeConfiguration.setInterface(\"\");\n+                hazelcastRuntimeConfiguration.setClusterGroupName(\"development\");\n+                hazelcastRuntimeConfiguration.setHostAwarePartitioning(\"true\");\n+                hazelcastRuntimeConfiguration.setLicenseKey(\"\");\n+                hazelcastRuntimeConfiguration.setKubernetesNamespace(\"default\");\n+                hazelcastRuntimeConfiguration.setKubernetesServiceName(\"\");\n+                hazelcastRuntimeConfiguration.setDatagridEncryptionEnabled(\"false\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast general configuration filled with defaults\");\n+                return null;\n+            }\n+        }, configuration);\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration)\n+                    throws PropertyVetoException, TransactionFailure {\n+                hazelcastConfigSpecificConfiguration.setEnabled(\"true\");\n+                hazelcastConfigSpecificConfiguration.setClusteringEnabled(\"true\");\n+                hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n+                hazelcastConfigSpecificConfiguration.setMemberName(\"payara\");\n+                hazelcastConfigSpecificConfiguration.setMemberGroup(\"MicroShoal\");\n+                hazelcastConfigSpecificConfiguration.setJNDIName(\"payara/Hazelcast\");\n+                hazelcastConfigSpecificConfiguration.setCacheManagerJNDIName(\"payara/CacheManager\");\n+                hazelcastConfigSpecificConfiguration.setCachingProviderJNDIName(\"payara/CachingProvider\");\n+                hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n+                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast specific configuration filled with defaults\");\n+                return null;\n+            }\n+        }, nodeConfig);\n+    }\n }\n", "next_change": {"commit": "4f802c07f1ce7071d0ae424cd43a3c0e22ba2178", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex a9f13f13e2..3733cd8dc1 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -821,21 +744,13 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         }, configuration);\n         ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n             @Override\n-            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration)\n-                    throws PropertyVetoException, TransactionFailure {\n-                hazelcastConfigSpecificConfiguration.setEnabled(\"true\");\n-                hazelcastConfigSpecificConfiguration.setClusteringEnabled(\"true\");\n+            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration) {\n                 hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n-                hazelcastConfigSpecificConfiguration.setMemberName(\"payara\");\n-                hazelcastConfigSpecificConfiguration.setMemberGroup(\"MicroShoal\");\n-                hazelcastConfigSpecificConfiguration.setJNDIName(\"payara/Hazelcast\");\n-                hazelcastConfigSpecificConfiguration.setCacheManagerJNDIName(\"payara/CacheManager\");\n-                hazelcastConfigSpecificConfiguration.setCachingProviderJNDIName(\"payara/CachingProvider\");\n+                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n                 hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n                 hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n                 hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n                 hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n-                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n                 Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n                         \"Hazelcast specific configuration filled with defaults\");\n                 return null;\n", "next_change": {"commit": "ae649dc60446556d6e4c6bef49c8d99b2bf14156", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 3733cd8dc1..c5a6703e92 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -667,94 +627,4 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         // without a restart\n         return datagridEncryptionValue;\n     }\n-\n-    private void fillHazelcastConfigurationFromConfig(Config config,\n-                                                   HazelcastRuntimeConfiguration configuration) {\n-        configuration.setClusterGroupName(config.getClusterName());\n-        configuration.setLicenseKey(config.getLicenseKey());\n-\n-        if (env.isDas() && !env.isMicro()) {\n-            configuration.setDasPort(String.valueOf(config.getNetworkConfig().getPort()));\n-        } else {\n-            configuration.setStartPort(String.valueOf(config.getNetworkConfig().getPort()));\n-        }\n-        configuration.setAutoIncrementPort(String.valueOf(config.getNetworkConfig().isPortAutoIncrement()));\n-\n-        NetworkConfig nConfig = config.getNetworkConfig();\n-        InterfacesConfig interfacesConfig = nConfig.getInterfaces();\n-        if (interfacesConfig != null) {\n-            configuration.setInterface(\n-                interfacesConfig.getInterfaces().stream().collect(Collectors.joining(\",\")));\n-        }\n-        JoinConfig joinConfig = nConfig.getJoin();\n-        if (joinConfig != null) {\n-            TcpIpConfig tConfig = joinConfig.getTcpIpConfig();\n-            if (tConfig != null && tConfig.isEnabled()) {\n-                configuration.setTcpipMembers(tConfig.getMembers().stream().collect(Collectors.joining(\",\")));\n-            }\n-            MulticastConfig multicastConfig = joinConfig.getMulticastConfig();\n-            if (multicastConfig != null && multicastConfig.isEnabled()) {\n-                configuration.setMulticastGroup(multicastConfig.getMulticastGroup());\n-                configuration.setMulticastPort(String.valueOf(multicastConfig.getMulticastPort()));\n-            }\n-            KubernetesConfig kubernetesConfig = joinConfig.getKubernetesConfig();\n-            if (kubernetesConfig != null && kubernetesConfig.isEnabled()) {\n-                configuration.setKubernetesNamespace(kubernetesConfig.getProperty(KubernetesProperties.NAMESPACE.key()));\n-                configuration.setKubernetesServiceName(kubernetesConfig.getProperty(KubernetesProperties.SERVICE_NAME.key()));\n-            }\n-        }\n-    }\n-\n-    private void fillSpecificHazelcastConfigFromConfig(Config config,\n-                                                   HazelcastConfigSpecificConfiguration nodeConfig) {\n-        NetworkConfig nConfig = config.getNetworkConfig();\n-        if(nConfig.getPublicAddress() != null && !nConfig.getPublicAddress().isEmpty()) {\n-            nodeConfig.setPublicAddress(nConfig.getPublicAddress());\n-        }\n-        nodeConfig.setLite(String.valueOf(config.isLiteMember()));\n-        ExecutorConfig executorConfig = config.getExecutorConfig(CLUSTER_EXECUTOR_SERVICE_NAME);\n-        nodeConfig.setExecutorPoolSize(String.valueOf(executorConfig.getPoolSize()));\n-        nodeConfig.setExecutorQueueCapacity(String.valueOf(executorConfig.getQueueCapacity()));\n-        ScheduledExecutorConfig scheduledExecutorConfig = config.getScheduledExecutorConfig(\n-                SCHEDULED_CLUSTER_EXECUTOR_SERVICE_NAME);\n-        nodeConfig.setScheduledExecutorPoolSize(String.valueOf(scheduledExecutorConfig.getPoolSize()));\n-        nodeConfig.setScheduledExecutorQueueCapacity(String.valueOf(scheduledExecutorConfig.getCapacity()));\n-    }\n-\n-    private void fillConfigurationWithDefaults() throws TransactionFailure {\n-        ConfigSupport.apply(new SingleConfigCode<HazelcastRuntimeConfiguration>() {\n-            @Override\n-            public Object run(final HazelcastRuntimeConfiguration hazelcastRuntimeConfiguration) {\n-                hazelcastRuntimeConfiguration.setChangeToDefault(\"false\");\n-                hazelcastRuntimeConfiguration.setClusterGroupName(\"development\");\n-                hazelcastRuntimeConfiguration.setLicenseKey(\"\");\n-                hazelcastRuntimeConfiguration.setDasPort(\"4900\");\n-                hazelcastRuntimeConfiguration.setStartPort(\"5900\");\n-                hazelcastRuntimeConfiguration.setAutoIncrementPort(\"true\");\n-                hazelcastRuntimeConfiguration.setInterface(\"\");\n-                hazelcastRuntimeConfiguration.setTcpipMembers(\"127.0.0.1:5900\");\n-                hazelcastRuntimeConfiguration.setMulticastGroup(\"224.2.2.3\");\n-                hazelcastRuntimeConfiguration.setMulticastPort(\"54327\");\n-                hazelcastRuntimeConfiguration.setKubernetesNamespace(\"default\");\n-                hazelcastRuntimeConfiguration.setKubernetesServiceName(\"\");\n-                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n-                        \"Hazelcast general configuration filled with defaults\");\n-                return null;\n-            }\n-        }, configuration);\n-        ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n-            @Override\n-            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration) {\n-                hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n-                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n-                hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n-                hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n-                hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n-                hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n-                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n-                        \"Hazelcast specific configuration filled with defaults\");\n-                return null;\n-            }\n-        }, nodeConfig);\n-    }\n }\n", "next_change": {"commit": "5e9f5f620ea2ce0ea68e090e9daf6e3f5fb43f66", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex c5a6703e92..3b568d7648 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -627,4 +662,94 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         // without a restart\n         return datagridEncryptionValue;\n     }\n+\n+    private void fillHazelcastConfigurationFromConfig(Config config,\n+                                                   HazelcastRuntimeConfiguration configuration) {\n+        configuration.setClusterGroupName(config.getClusterName());\n+        configuration.setLicenseKey(config.getLicenseKey());\n+\n+        if (env.isDas() && !env.isMicro()) {\n+            configuration.setDasPort(String.valueOf(config.getNetworkConfig().getPort()));\n+        } else {\n+            configuration.setStartPort(String.valueOf(config.getNetworkConfig().getPort()));\n+        }\n+        configuration.setAutoIncrementPort(String.valueOf(config.getNetworkConfig().isPortAutoIncrement()));\n+\n+        NetworkConfig nConfig = config.getNetworkConfig();\n+        InterfacesConfig interfacesConfig = nConfig.getInterfaces();\n+        if (interfacesConfig != null) {\n+            configuration.setInterface(\n+                interfacesConfig.getInterfaces().stream().collect(Collectors.joining(\",\")));\n+        }\n+        JoinConfig joinConfig = nConfig.getJoin();\n+        if (joinConfig != null) {\n+            TcpIpConfig tConfig = joinConfig.getTcpIpConfig();\n+            if (tConfig != null && tConfig.isEnabled()) {\n+                configuration.setTcpipMembers(tConfig.getMembers().stream().collect(Collectors.joining(\",\")));\n+            }\n+            MulticastConfig multicastConfig = joinConfig.getMulticastConfig();\n+            if (multicastConfig != null && multicastConfig.isEnabled()) {\n+                configuration.setMulticastGroup(multicastConfig.getMulticastGroup());\n+                configuration.setMulticastPort(String.valueOf(multicastConfig.getMulticastPort()));\n+            }\n+            KubernetesConfig kubernetesConfig = joinConfig.getKubernetesConfig();\n+            if (kubernetesConfig != null && kubernetesConfig.isEnabled()) {\n+                configuration.setKubernetesNamespace(kubernetesConfig.getProperty(KubernetesProperties.NAMESPACE.key()));\n+                configuration.setKubernetesServiceName(kubernetesConfig.getProperty(KubernetesProperties.SERVICE_NAME.key()));\n+            }\n+        }\n+    }\n+\n+    private void fillSpecificHazelcastConfigFromConfig(Config config,\n+                                                   HazelcastConfigSpecificConfiguration nodeConfig) {\n+        NetworkConfig nConfig = config.getNetworkConfig();\n+        if(nConfig.getPublicAddress() != null && !nConfig.getPublicAddress().isEmpty()) {\n+            nodeConfig.setPublicAddress(nConfig.getPublicAddress());\n+        }\n+        nodeConfig.setLite(String.valueOf(config.isLiteMember()));\n+        ExecutorConfig executorConfig = config.getExecutorConfig(CLUSTER_EXECUTOR_SERVICE_NAME);\n+        nodeConfig.setExecutorPoolSize(String.valueOf(executorConfig.getPoolSize()));\n+        nodeConfig.setExecutorQueueCapacity(String.valueOf(executorConfig.getQueueCapacity()));\n+        ScheduledExecutorConfig scheduledExecutorConfig = config.getScheduledExecutorConfig(\n+                SCHEDULED_CLUSTER_EXECUTOR_SERVICE_NAME);\n+        nodeConfig.setScheduledExecutorPoolSize(String.valueOf(scheduledExecutorConfig.getPoolSize()));\n+        nodeConfig.setScheduledExecutorQueueCapacity(String.valueOf(scheduledExecutorConfig.getCapacity()));\n+    }\n+\n+    private void fillConfigurationWithDefaults() throws TransactionFailure {\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastRuntimeConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastRuntimeConfiguration hazelcastRuntimeConfiguration) {\n+                hazelcastRuntimeConfiguration.setChangeToDefault(\"false\");\n+                hazelcastRuntimeConfiguration.setClusterGroupName(\"development\");\n+                hazelcastRuntimeConfiguration.setLicenseKey(\"\");\n+                hazelcastRuntimeConfiguration.setDasPort(\"4900\");\n+                hazelcastRuntimeConfiguration.setStartPort(\"5900\");\n+                hazelcastRuntimeConfiguration.setAutoIncrementPort(\"true\");\n+                hazelcastRuntimeConfiguration.setInterface(\"\");\n+                hazelcastRuntimeConfiguration.setTcpipMembers(\"127.0.0.1:5900\");\n+                hazelcastRuntimeConfiguration.setMulticastGroup(\"224.2.2.3\");\n+                hazelcastRuntimeConfiguration.setMulticastPort(\"54327\");\n+                hazelcastRuntimeConfiguration.setKubernetesNamespace(\"default\");\n+                hazelcastRuntimeConfiguration.setKubernetesServiceName(\"\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast general configuration filled with defaults\");\n+                return null;\n+            }\n+        }, configuration);\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration) {\n+                hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n+                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n+                hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast specific configuration filled with defaults\");\n+                return null;\n+            }\n+        }, nodeConfig);\n+    }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "dd07f55c8f6b0ce789b83f744fc16efb87d00648", "committedDate": "2020-01-29 15:32:14 +0000", "message": "CUSTCOM-24 Remove ThreadLocal Hazelcast disable"}, {"oid": "bce9309afdd64ac53f344b58cfb529ead1d1da6b", "committedDate": "2020-02-11 11:54:35 +0000", "message": "CUSTCOM-79 Remove default hazelcast start port value"}, {"oid": "12ae70674f3c57c7739556853f1b2d3d608f08a0", "committedDate": "2020-03-09 13:42:20 +0000", "message": "CUSTCOM-223 Move log message into if block"}, {"oid": "1dd71b6238fdee76a5b3302a1518c8287b61fb59", "committedDate": "2020-11-04 20:43:06 -0600", "message": "even more refactoring, separated initPublicAddress() and initBindAddress() and made them even more self-describing and autonomous"}, {"oid": "efb512eabc3f44b343ec9a9885dc4a1b5b78dbef", "committedDate": "2020-12-08 13:43:33 -0600", "message": "Upgrade Payara to Hazelcast 4.1 (#5014)"}, {"oid": "9067d0736c4e167118c9d2db9382fdaa50cf9ea0", "committedDate": "2020-12-08 17:31:54 -0600", "message": "introduce tenant control"}, {"oid": "d62090658ce38d6d5f47820b857ce3cb99732455", "committedDate": "2021-03-26 16:55:26 +0100", "message": "Revert \"FISH-858 Upgrade to Hazelcast 4.2 from 4.1 and use Tenant Control APIs\""}, {"oid": "0fe1775753c8777e968fd926290b7237f8b07a99", "committedDate": "2021-03-26 13:45:48 -0500", "message": "[FISH-858] Upgrade to Hazelcast 4.2 from 4.1 and use Tenant Control APIs (#5176)"}, {"oid": "dbba8a86c0f535c4a1e916714b4834cfd1121733", "committedDate": "2021-04-08 10:55:52 +0530", "message": "FISH-1280 Jakarta EE9: Compile Payara 6 artifact with Jakarta EE namespace"}, {"oid": "3b0086a8ebd1bdf984a1c295862e352fc4249a0d", "committedDate": "2021-06-09 13:19:10 +0530", "message": "FISH-1321 Copyright year update"}, {"oid": "bd6380d3bc4f01722a7f5ac2da377199c7a1c9b5", "committedDate": "2022-05-16 19:35:22 +0800", "message": "Bugfix postbootcommandfile argument execution"}, {"oid": "f44183586417f8698fabf7f045fe46267886f873", "committedDate": "2022-05-18 17:25:35 +0800", "message": "Bugfix postbootcommandfile argument execution"}, {"oid": "6e418d2d4b903dd9bddccfbccfe7587e91391f92", "committedDate": "2022-08-29 17:11:49 +0200", "message": "Have implemented the fix. INtegration tests in progress"}, {"oid": "a03fd87db043592af99392a1492e9f87ba90b87a", "committedDate": "2022-08-29 17:11:49 +0200", "message": "Update nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java"}, {"oid": "bce8422734744c075394119762ab93858ab257db", "committedDate": "2022-09-12 12:40:25 +0200", "message": "FISH-6501 fix bootcommandservice runlevel"}, {"oid": "8dc2ec4c0ba8d00aa7326570b088fec35f39ed69", "committedDate": "2022-09-12 12:52:40 +0200", "message": "FISH-6501 fix bootcommandservice runlevel"}, {"oid": "3c61a52fc8048c01da254852c96789287aca463e", "committedDate": "2022-09-21 11:19:13 +0100", "message": "Merge branch 'master' into FISH-372"}, {"oid": "3641bd845538899391f997ffb404e8faff63cad6", "committedDate": "2022-10-10 16:22:45 -0300", "message": "FISH-6500 : verifying file path existence"}, {"oid": "af357179c87ccbbddb0198c4534b4ea26f671bcb", "committedDate": "2022-10-11 12:04:19 -0300", "message": "FISH-6500 : fill the config hazelcast from file when server starts"}, {"oid": "1542280a08dd97f811c50e58a6c464a040c9960b", "committedDate": "2022-10-17 14:31:51 -0300", "message": "FISH-6500 : Log to inform hazelcast config from file"}, {"oid": "4259aa06b36e241b665cc172e01959664e85ee03", "committedDate": "2022-10-18 06:23:29 -0300", "message": "FISH-6500 : Unused imports and member removed"}, {"oid": "88defca0ab341784e1276b6c0cc863b2013a8d16", "committedDate": "2022-10-18 08:40:03 -0300", "message": "FISH-6500 : values not changing dinamically"}, {"oid": "ab64c299263521e52d8d5c89827a729f6e3a64c8", "committedDate": "2022-10-18 10:41:21 -0300", "message": "FISH-6500 : hazelcast config file being read at startup"}, {"oid": "4d2d278b084d9ebb58c6959f0af7c2e8f6121aeb", "committedDate": "2022-10-18 16:04:24 -0300", "message": "FISH-6500 : hazelcast config with default values setted"}, {"oid": "25172d8d82421512316bfe407e9ce57fc3b21a80", "committedDate": "2022-10-18 16:18:30 -0300", "message": "FISH-6500 : unnecessary throws removed"}, {"oid": "d5a7391cc7727e7965ed5da8ad16f0df62b0f208", "committedDate": "2022-10-18 16:46:57 -0300", "message": "FISH-6500 : setting default config"}, {"oid": "3153563ee6a8af1f8bdea09b7aeea185370e5f52", "committedDate": "2022-10-22 14:47:44 -0300", "message": "FISH-6495 : not using xsd package"}, {"oid": "4f802c07f1ce7071d0ae424cd43a3c0e22ba2178", "committedDate": "2022-10-22 18:04:36 -0300", "message": "FISH-6500 : fill defaults correctly"}, {"oid": "572c567f7295a65cbaa66f3fa7c5d95544d36527", "committedDate": "2022-10-22 21:46:13 -0300", "message": "FISH-6500 : removing xjc generated files references"}, {"oid": "ae649dc60446556d6e4c6bef49c8d99b2bf14156", "committedDate": "2022-10-24 10:13:51 +0100", "message": "Merge pull request #5904 from nicolasduminil/fish-372"}, {"oid": "5e9f5f620ea2ce0ea68e090e9daf6e3f5fb43f66", "committedDate": "2022-10-24 21:32:25 -0300", "message": "FISH-6495 : using hazelcast boostrap config property"}, {"oid": "bc4144c32b976880a71a365e04e2bf03d6f20b3e", "committedDate": "2022-10-25 09:24:56 +0100", "message": "Merge pull request #5995 from Pandrex247/FISH-372-P6"}, {"oid": "25e046c7a8de8fcbdeabc18832046718799f956d", "committedDate": "2022-10-27 14:14:34 -0300", "message": "FISH-6495 : setting hazelcast property when passed"}, {"oid": "505c1ae4879d617fcf686beee2145315d0e18867", "committedDate": "2023-01-16 12:19:32 +0000", "message": "FISH-6816 Merge Payara6 into master"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1MTU3Mg==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367351572", "body": "Looks exactly like the code generating the key if I'm not mistaken.", "bodyText": "Looks exactly like the code generating the key if I'm not mistaken.", "bodyHTML": "<p dir=\"auto\">Looks exactly like the code generating the key if I'm not mistaken.</p>", "author": "jbee", "createdAt": "2020-01-16T10:50:15Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java", "diffHunk": "@@ -0,0 +1,222 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.nucleus.hazelcast.encryption;\n+\n+import com.hazelcast.core.HazelcastException;\n+import com.hazelcast.nio.IOUtil;\n+import com.sun.enterprise.security.ssl.impl.MasterPasswordImpl;\n+import org.glassfish.api.admin.ServerEnvironment;\n+import org.glassfish.internal.api.Globals;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKey;\n+import javax.crypto.SecretKeyFactory;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.PBEKeySpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.ObjectOutputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.security.AlgorithmParameters;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.SecureRandom;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.util.Base64;\n+import java.util.Random;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+/**\n+ * Class that encodes and decodes symmetric keys.\n+ *\n+ * @author Andrew Pielage <andrew.pielage@payara.fish>\n+ * @author Rudy De Busscher <rudy.de.busscher@payara.fish>\n+ */\n+public class SymmetricEncryptor {\n+\n+    private static final String DATAGRID_KEY_FILE = \"datagrid-key\";\n+    private static final String AES_ALGORITHM = \"AES/CBC/PKCS5Padding\";\n+    private static final String PBKDF_ALGORITHM = \"PBKDF2WithHmacSHA1\";\n+    private static final String AES = \"AES\";\n+    private static final int ITERATION_COUNT = 65556;\n+    private static final int KEYSIZE = 256;\n+    private static Random random = new SecureRandom();\n+    private static SecretKey secretKey;\n+\n+    static {\n+        secretKey = readAndDecryptSecretKey();\n+    }\n+\n+    public static String encode(byte[] value) {\n+        // Generate IV.\n+        byte[] saltBytes = new byte[20];\n+        random.nextBytes(saltBytes);\n+\n+        try {\n+            // Encrypting the data\n+            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n+            cipher.init(Cipher.ENCRYPT_MODE, secretKey);\n+            AlgorithmParameters params = cipher.getParameters();\n+            byte[] ivBytes = params.getParameterSpec(IvParameterSpec.class).getIV();\n+            byte[] encryptedTextBytes = cipher.doFinal(value);\n+\n+            // Prepend salt and IV\n+            byte[] buffer = new byte[saltBytes.length + ivBytes.length + encryptedTextBytes.length];\n+            System.arraycopy(saltBytes, 0, buffer, 0, saltBytes.length);\n+            System.arraycopy(ivBytes, 0, buffer, saltBytes.length, ivBytes.length);\n+            System.arraycopy(encryptedTextBytes, 0, buffer, saltBytes.length + ivBytes.length,\n+                    encryptedTextBytes.length);\n+            return Base64.getEncoder().encodeToString(buffer);\n+        } catch (NoSuchAlgorithmException | InvalidKeyException | NoSuchPaddingException | IllegalBlockSizeException", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nsimilarity index 90%\nrename from nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\nrename to nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex fe160a8abc..5853244f94 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -113,24 +120,24 @@ public class SymmetricEncryptor {\n             System.arraycopy(ivBytes, 0, buffer, saltBytes.length, ivBytes.length);\n             System.arraycopy(encryptedTextBytes, 0, buffer, saltBytes.length + ivBytes.length,\n                     encryptedTextBytes.length);\n-            return Base64.getEncoder().encodeToString(buffer);\n+            return buffer;\n         } catch (NoSuchAlgorithmException | InvalidKeyException | NoSuchPaddingException | IllegalBlockSizeException\n                 | InvalidParameterSpecException | BadPaddingException exception) {\n             throw new HazelcastException(exception);\n         }\n     }\n \n-    public static byte[] decode(String encryptedText) {\n+    public static byte[] decode(byte[] encryptedTextBytes) {\n         byte[] decryptedTextBytes;\n         try {\n             Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n             // Strip off the salt and IV\n-            ByteBuffer buffer = ByteBuffer.wrap(Base64.getDecoder().decode((encryptedText)));\n+            ByteBuffer buffer = ByteBuffer.wrap(encryptedTextBytes);\n             byte[] saltBytes = new byte[20];\n             buffer.get(saltBytes, 0, saltBytes.length);\n             byte[] ivBytes = new byte[cipher.getBlockSize()];\n             buffer.get(ivBytes, 0, ivBytes.length);\n-            byte[] encryptedTextBytes = new byte[buffer.capacity() - saltBytes.length - ivBytes.length];\n+            encryptedTextBytes = new byte[buffer.capacity() - saltBytes.length - ivBytes.length];\n \n             buffer.get(encryptedTextBytes);\n             cipher.init(Cipher.DECRYPT_MODE, secretKey, new IvParameterSpec(ivBytes));\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nsimilarity index 88%\nrename from nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\nrename to nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex fe160a8abc..601978289e 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -113,24 +122,24 @@ public class SymmetricEncryptor {\n             System.arraycopy(ivBytes, 0, buffer, saltBytes.length, ivBytes.length);\n             System.arraycopy(encryptedTextBytes, 0, buffer, saltBytes.length + ivBytes.length,\n                     encryptedTextBytes.length);\n-            return Base64.getEncoder().encodeToString(buffer);\n+            return buffer;\n         } catch (NoSuchAlgorithmException | InvalidKeyException | NoSuchPaddingException | IllegalBlockSizeException\n                 | InvalidParameterSpecException | BadPaddingException exception) {\n             throw new HazelcastException(exception);\n         }\n     }\n \n-    public static byte[] decode(String encryptedText) {\n+    public static byte[] decode(byte[] encryptedTextBytes) {\n         byte[] decryptedTextBytes;\n         try {\n             Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n             // Strip off the salt and IV\n-            ByteBuffer buffer = ByteBuffer.wrap(Base64.getDecoder().decode((encryptedText)));\n+            ByteBuffer buffer = ByteBuffer.wrap(encryptedTextBytes);\n             byte[] saltBytes = new byte[20];\n             buffer.get(saltBytes, 0, saltBytes.length);\n             byte[] ivBytes = new byte[cipher.getBlockSize()];\n             buffer.get(ivBytes, 0, ivBytes.length);\n-            byte[] encryptedTextBytes = new byte[buffer.capacity() - saltBytes.length - ivBytes.length];\n+            encryptedTextBytes = new byte[buffer.capacity() - saltBytes.length - ivBytes.length];\n \n             buffer.get(encryptedTextBytes);\n             cipher.init(Cipher.DECRYPT_MODE, secretKey, new IvParameterSpec(ivBytes));\n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1NDc1Mg==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367354752", "body": "I don't see why this would be a `String` instead of `byte[]` directly. The extra step of encoding that as `String` again seems unnecessary and a potential source or trouble.", "bodyText": "I don't see why this would be a String instead of byte[] directly. The extra step of encoding that as String again seems unnecessary and a potential source or trouble.", "bodyHTML": "<p dir=\"auto\">I don't see why this would be a <code>String</code> instead of <code>byte[]</code> directly. The extra step of encoding that as <code>String</code> again seems unnecessary and a potential source or trouble.</p>", "author": "jbee", "createdAt": "2020-01-16T10:57:34Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) 2020 Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.nucleus.hazelcast.encryption;\n+\n+import java.io.Serializable;\n+\n+/**\n+ * @author Andrew Pielage <andrew.pielage@payara.fish>\n+ */\n+public class PayaraHazelcastEncryptedValueHolder implements Serializable {\n+\n+    private String encryptedObjectString;", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1NDEwNQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367454105", "bodyText": "I don't know the low-level details well enough to comment on if there's an advantage to doing Base64.getEncoder().encodeToString(buffer); vs. Base64.getEncoder().encode(buffer);\nEven if there's no security advantage surely the difference is so low that it's never going to be the straw that broke the camel's back? Willing to be proven wrong but to me this seems like complaining about the use of int over short :P", "author": "Pandrex247", "createdAt": "2020-01-16T14:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1NDc1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1NjY3OQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367456679", "bodyText": "My suggestion was to not do base64 at all. Just take what comes out of crypto. As I understand it the base64 is just to make the result human readable but here there is no need. Just raw bytes are fine and spare us some back and forth conversion.", "author": "jbee", "createdAt": "2020-01-16T14:44:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1NDc1Mg=="}], "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java\nindex 3243563145..f65273f7c9 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java\n", "chunk": "@@ -46,13 +46,13 @@ import java.io.Serializable;\n  */\n public class PayaraHazelcastEncryptedValueHolder implements Serializable {\n \n-    private String encryptedObjectString;\n+    private byte[] encryptedObjectBytes;\n \n-    public PayaraHazelcastEncryptedValueHolder(String encryptedObjectString) {\n-        this.encryptedObjectString = encryptedObjectString;\n+    public PayaraHazelcastEncryptedValueHolder(byte[] encryptedObjectBytes) {\n+        this.encryptedObjectBytes = encryptedObjectBytes;\n     }\n \n-    public String getEncryptedObjectString() {\n-        return encryptedObjectString;\n+    public byte[] getEncryptedObjectBytes() {\n+        return encryptedObjectBytes;\n     }\n }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java\nindex 3243563145..f65273f7c9 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/PayaraHazelcastEncryptedValueHolder.java\n", "chunk": "@@ -46,13 +46,13 @@ import java.io.Serializable;\n  */\n public class PayaraHazelcastEncryptedValueHolder implements Serializable {\n \n-    private String encryptedObjectString;\n+    private byte[] encryptedObjectBytes;\n \n-    public PayaraHazelcastEncryptedValueHolder(String encryptedObjectString) {\n-        this.encryptedObjectString = encryptedObjectString;\n+    public PayaraHazelcastEncryptedValueHolder(byte[] encryptedObjectBytes) {\n+        this.encryptedObjectBytes = encryptedObjectBytes;\n     }\n \n-    public String getEncryptedObjectString() {\n-        return encryptedObjectString;\n+    public byte[] getEncryptedObjectBytes() {\n+        return encryptedObjectBytes;\n     }\n }\n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1NTUxOQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367355519", "body": "Is this intentionally build so it will not change until JVM is restarted even in case the underlying source (file?) should change?", "bodyText": "Is this intentionally build so it will not change until JVM is restarted even in case the underlying source (file?) should change?", "bodyHTML": "<p dir=\"auto\">Is this intentionally build so it will not change until JVM is restarted even in case the underlying source (file?) should change?</p>", "author": "jbee", "createdAt": "2020-01-16T10:59:12Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java", "diffHunk": "@@ -0,0 +1,222 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.nucleus.hazelcast.encryption;\n+\n+import com.hazelcast.core.HazelcastException;\n+import com.hazelcast.nio.IOUtil;\n+import com.sun.enterprise.security.ssl.impl.MasterPasswordImpl;\n+import org.glassfish.api.admin.ServerEnvironment;\n+import org.glassfish.internal.api.Globals;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKey;\n+import javax.crypto.SecretKeyFactory;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.PBEKeySpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.ObjectOutputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.security.AlgorithmParameters;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.SecureRandom;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.util.Base64;\n+import java.util.Random;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+/**\n+ * Class that encodes and decodes symmetric keys.\n+ *\n+ * @author Andrew Pielage <andrew.pielage@payara.fish>\n+ * @author Rudy De Busscher <rudy.de.busscher@payara.fish>\n+ */\n+public class SymmetricEncryptor {\n+\n+    private static final String DATAGRID_KEY_FILE = \"datagrid-key\";\n+    private static final String AES_ALGORITHM = \"AES/CBC/PKCS5Padding\";\n+    private static final String PBKDF_ALGORITHM = \"PBKDF2WithHmacSHA1\";\n+    private static final String AES = \"AES\";\n+    private static final int ITERATION_COUNT = 65556;\n+    private static final int KEYSIZE = 256;\n+    private static Random random = new SecureRandom();\n+    private static SecretKey secretKey;\n+\n+    static {\n+        secretKey = readAndDecryptSecretKey();", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU0NzY3NQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367547675", "bodyText": "Yes - to prevent things being stored using different encryption keys.\nThe key should be symmetric: domain-wide.", "author": "Pandrex247", "createdAt": "2020-01-16T17:18:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1NTUxOQ=="}], "type": "inlineReview", "revised_code": {"commit": "4d545b6ebb7598b7194def1bd2eb232d13f4fcf3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\nindex fe160a8abc..d3bfbe0b45 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n", "chunk": "@@ -91,7 +92,14 @@ public class SymmetricEncryptor {\n     private static SecretKey secretKey;\n \n     static {\n-        secretKey = readAndDecryptSecretKey();\n+        try {\n+            secretKey = readAndDecryptSecretKey();\n+        } catch (Exception exception) {\n+            // Shutting down Payara from the thread we're running in can only be done in fairly brutal ways\n+            Logger.getLogger(SymmetricEncryptor.class.getName()).log(Level.SEVERE,\n+                    \"Error starting Hazelcast due to exception reading encryption key\", exception);\n+            Globals.get(HazelcastCore.class).getInstance().shutdown();\n+        }\n     }\n \n     public static String encode(byte[] value) {\n", "next_change": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nsimilarity index 92%\nrename from nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\nrename to nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex d3bfbe0b45..5853244f94 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -96,13 +95,13 @@ public class SymmetricEncryptor {\n             secretKey = readAndDecryptSecretKey();\n         } catch (Exception exception) {\n             // Shutting down Payara from the thread we're running in can only be done in fairly brutal ways\n-            Logger.getLogger(SymmetricEncryptor.class.getName()).log(Level.SEVERE,\n+            Logger.getLogger(HazelcastSymmetricEncryptor.class.getName()).log(Level.SEVERE,\n                     \"Error starting Hazelcast due to exception reading encryption key\", exception);\n             Globals.get(HazelcastCore.class).getInstance().shutdown();\n         }\n     }\n \n-    public static String encode(byte[] value) {\n+    public static byte[] encode(byte[] value) {\n         // Generate IV.\n         byte[] saltBytes = new byte[20];\n         random.nextBytes(saltBytes);\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nsimilarity index 88%\nrename from nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\nrename to nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex fe160a8abc..601978289e 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -91,10 +91,19 @@ public class SymmetricEncryptor {\n     private static SecretKey secretKey;\n \n     static {\n-        secretKey = readAndDecryptSecretKey();\n+        try {\n+            secretKey = readAndDecryptSecretKey();\n+            Logger.getLogger(HazelcastSymmetricEncryptor.class.getName()).log(Level.FINE,\n+                    \"Data grid encryption key successfully read and decrypted\");\n+        } catch (Exception exception) {\n+            // Shutting down Payara from the thread we're running in can only be done in fairly brutal ways\n+            Logger.getLogger(HazelcastSymmetricEncryptor.class.getName()).log(Level.SEVERE,\n+                    \"Error starting Hazelcast due to exception reading encryption key\", exception);\n+            Globals.get(HazelcastCore.class).getInstance().shutdown();\n+        }\n     }\n \n-    public static String encode(byte[] value) {\n+    public static byte[] encode(byte[] value) {\n         // Generate IV.\n         byte[] saltBytes = new byte[20];\n         random.nextBytes(saltBytes);\n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1NjE4NQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367356185", "body": "What about encrypting `null` references?\r\nIf I read code in store correctly nulls are not wrapped and stored \"plain\".", "bodyText": "What about encrypting null references?\nIf I read code in store correctly nulls are not wrapped and stored \"plain\".", "bodyHTML": "<p dir=\"auto\">What about encrypting <code>null</code> references?<br>\nIf I read code in store correctly nulls are not wrapped and stored \"plain\".</p>", "author": "jbee", "createdAt": "2020-01-16T11:00:43Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java", "diffHunk": "@@ -0,0 +1,222 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.nucleus.hazelcast.encryption;\n+\n+import com.hazelcast.core.HazelcastException;\n+import com.hazelcast.nio.IOUtil;\n+import com.sun.enterprise.security.ssl.impl.MasterPasswordImpl;\n+import org.glassfish.api.admin.ServerEnvironment;\n+import org.glassfish.internal.api.Globals;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKey;\n+import javax.crypto.SecretKeyFactory;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.PBEKeySpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.ObjectOutputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.security.AlgorithmParameters;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.SecureRandom;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.util.Base64;\n+import java.util.Random;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+/**\n+ * Class that encodes and decodes symmetric keys.\n+ *\n+ * @author Andrew Pielage <andrew.pielage@payara.fish>\n+ * @author Rudy De Busscher <rudy.de.busscher@payara.fish>\n+ */\n+public class SymmetricEncryptor {\n+\n+    private static final String DATAGRID_KEY_FILE = \"datagrid-key\";\n+    private static final String AES_ALGORITHM = \"AES/CBC/PKCS5Padding\";\n+    private static final String PBKDF_ALGORITHM = \"PBKDF2WithHmacSHA1\";\n+    private static final String AES = \"AES\";\n+    private static final int ITERATION_COUNT = 65556;\n+    private static final int KEYSIZE = 256;\n+    private static Random random = new SecureRandom();\n+    private static SecretKey secretKey;\n+\n+    static {\n+        secretKey = readAndDecryptSecretKey();\n+    }\n+\n+    public static String encode(byte[] value) {\n+        // Generate IV.\n+        byte[] saltBytes = new byte[20];\n+        random.nextBytes(saltBytes);\n+\n+        try {\n+            // Encrypting the data\n+            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n+            cipher.init(Cipher.ENCRYPT_MODE, secretKey);\n+            AlgorithmParameters params = cipher.getParameters();\n+            byte[] ivBytes = params.getParameterSpec(IvParameterSpec.class).getIV();\n+            byte[] encryptedTextBytes = cipher.doFinal(value);\n+\n+            // Prepend salt and IV\n+            byte[] buffer = new byte[saltBytes.length + ivBytes.length + encryptedTextBytes.length];\n+            System.arraycopy(saltBytes, 0, buffer, 0, saltBytes.length);\n+            System.arraycopy(ivBytes, 0, buffer, saltBytes.length, ivBytes.length);\n+            System.arraycopy(encryptedTextBytes, 0, buffer, saltBytes.length + ivBytes.length,\n+                    encryptedTextBytes.length);\n+            return Base64.getEncoder().encodeToString(buffer);\n+        } catch (NoSuchAlgorithmException | InvalidKeyException | NoSuchPaddingException | IllegalBlockSizeException\n+                | InvalidParameterSpecException | BadPaddingException exception) {\n+            throw new HazelcastException(exception);\n+        }\n+    }\n+\n+    public static byte[] decode(String encryptedText) {\n+        byte[] decryptedTextBytes;\n+        try {\n+            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n+            // Strip off the salt and IV\n+            ByteBuffer buffer = ByteBuffer.wrap(Base64.getDecoder().decode((encryptedText)));\n+            byte[] saltBytes = new byte[20];\n+            buffer.get(saltBytes, 0, saltBytes.length);\n+            byte[] ivBytes = new byte[cipher.getBlockSize()];\n+            buffer.get(ivBytes, 0, ivBytes.length);\n+            byte[] encryptedTextBytes = new byte[buffer.capacity() - saltBytes.length - ivBytes.length];\n+\n+            buffer.get(encryptedTextBytes);\n+            cipher.init(Cipher.DECRYPT_MODE, secretKey, new IvParameterSpec(ivBytes));\n+            decryptedTextBytes = cipher.doFinal(encryptedTextBytes);\n+        } catch (BadPaddingException exception) {\n+            // BadPaddingException -> Wrong key\n+            throw new HazelcastException(\"BadPaddingException caught decoding data, \" +\n+                    \"this can be caused by an incorrect or changed key: \", exception);\n+        } catch (IllegalBlockSizeException | NoSuchAlgorithmException | InvalidAlgorithmParameterException\n+                | InvalidKeyException | NoSuchPaddingException exception) {\n+            throw new HazelcastException(exception);\n+        }\n+\n+        return decryptedTextBytes;\n+    }\n+\n+    private static SecretKey readAndDecryptSecretKey() {\n+        ServerEnvironment serverEnvironment = Globals.getDefaultBaseServiceLocator().getService(ServerEnvironment.class);\n+        char[] masterPassword = Globals.getDefaultBaseServiceLocator().getService(MasterPasswordImpl.class).getMasterPassword();\n+\n+        byte[] encryptedBytes = null;\n+        try {\n+            encryptedBytes = Files.readAllBytes(\n+                    new File(serverEnvironment.getConfigDirPath() + File.separator + DATAGRID_KEY_FILE).toPath());\n+        } catch (IOException ioe) {\n+            Logger.getLogger(SymmetricEncryptor.class.getName()).log(Level.SEVERE,\n+                    \"Error reading datagrid key, please check if it's accessible at expected location: \"\n+                            + serverEnvironment.getConfigDirPath() + File.separator + DATAGRID_KEY_FILE);\n+            throw new HazelcastException(\"Error reading encrypted key\", ioe);\n+        }\n+\n+        if (encryptedBytes == null) {\n+            throw new HazelcastException(\"Encrypted key appears to be null\");\n+        }\n+\n+        try {\n+            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n+\n+            // Strip off the salt and IV\n+            ByteBuffer buffer = ByteBuffer.wrap(Base64.getDecoder().decode(encryptedBytes));\n+            byte[] saltBytes = new byte[20];\n+            buffer.get(saltBytes, 0, saltBytes.length);\n+            byte[] ivBytes = new byte[cipher.getBlockSize()];\n+            buffer.get(ivBytes, 0, ivBytes.length);\n+            byte[] encryptedTextBytes = new byte[buffer.capacity() - saltBytes.length - ivBytes.length];\n+            buffer.get(encryptedTextBytes);\n+\n+            // Deriving the key\n+            SecretKeyFactory factory = SecretKeyFactory.getInstance(PBKDF_ALGORITHM);\n+            PBEKeySpec spec = new PBEKeySpec(masterPassword, saltBytes, ITERATION_COUNT, KEYSIZE);\n+            SecretKey secretKeySpec = new SecretKeySpec(factory.generateSecret(spec).getEncoded(), AES);\n+            cipher.init(Cipher.DECRYPT_MODE, secretKeySpec, new IvParameterSpec(ivBytes));\n+            return new SecretKeySpec(cipher.doFinal(encryptedTextBytes), \"AES\");\n+        } catch (BadPaddingException bpe) {\n+            throw new HazelcastException(\"BadPaddingException caught decrypting data grid key\" +\n+                    \"- likely caused by an incorrect or changed master password\", bpe);\n+        } catch (IllegalBlockSizeException | NoSuchAlgorithmException | InvalidAlgorithmParameterException\n+                | InvalidKeyException | InvalidKeySpecException | NoSuchPaddingException exception) {\n+            throw new HazelcastException(exception);\n+        }\n+    }\n+\n+    public static byte[] objectToByteArray(Object object) {\n+        byte[] bytes = null;\n+        try (ByteArrayOutputStream bos = new ByteArrayOutputStream(); ObjectOutputStream out = new ObjectOutputStream(bos)) {\n+            out.writeObject(object);\n+            bytes = bos.toByteArray();\n+        } catch (IOException ioe) {\n+            // See \"if (bytes == null)\"\n+        }\n+        if (bytes == null) {\n+            throw new HazelcastException(\"Error converting Object to Byte Array\");\n+        }\n+        return bytes;\n+    }\n+\n+    public static Object byteArrayToObject(byte[] bytes) {\n+        Object object;\n+        try (ByteArrayInputStream bis = new ByteArrayInputStream(bytes)) {\n+            object = IOUtil.newObjectInputStream(Thread.currentThread().getContextClassLoader(), null, bis).readObject();\n+        } catch (IOException | ClassNotFoundException exception) {\n+            throw new HazelcastException(\"Error converting Byte Array to Object\", exception);\n+        }\n+        if (object == null) {\n+            throw new HazelcastException(\"Object appears to be null, something probably went wrong converting Byte Array to Object\");", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzU1MDk5Ng==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367550996", "bodyText": "Good spot!", "author": "Pandrex247", "createdAt": "2020-01-16T17:25:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1NjE4NQ=="}], "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nsimilarity index 90%\nrename from nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\nrename to nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex fe160a8abc..5853244f94 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -214,9 +221,6 @@ public class SymmetricEncryptor {\n         } catch (IOException | ClassNotFoundException exception) {\n             throw new HazelcastException(\"Error converting Byte Array to Object\", exception);\n         }\n-        if (object == null) {\n-            throw new HazelcastException(\"Object appears to be null, something probably went wrong converting Byte Array to Object\");\n-        }\n         return object;\n     }\n }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nsimilarity index 88%\nrename from nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\nrename to nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex fe160a8abc..601978289e 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/SymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -214,9 +219,6 @@ public class SymmetricEncryptor {\n         } catch (IOException | ClassNotFoundException exception) {\n             throw new HazelcastException(\"Error converting Byte Array to Object\", exception);\n         }\n-        if (object == null) {\n-            throw new HazelcastException(\"Object appears to be null, something probably went wrong converting Byte Array to Object\");\n-        }\n         return object;\n     }\n }\n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM1ODA2MQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r367358061", "body": "Same code as above L194-200\r\nBTW: `instanceof` \"includes\" a check `!= null` as a `null` reference will come out as `false`", "bodyText": "Same code as above L194-200\nBTW: instanceof \"includes\" a check != null as a null reference will come out as false", "bodyHTML": "<p dir=\"auto\">Same code as above L194-200<br>\nBTW: <code>instanceof</code> \"includes\" a check <code>!= null</code> as a <code>null</code> reference will come out as <code>false</code></p>", "author": "jbee", "createdAt": "2020-01-16T11:05:19Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java", "diffHunk": "@@ -212,26 +226,19 @@ public void event(Event event) {\n             if (map != null) {\n                 Set<Serializable> keys = map.keySet();\n                 for (Serializable key : keys) {\n-                    result.put(key, (Serializable) map.get(key));\n+                    Serializable value = (Serializable) map.get(key);\n+\n+                    if (value != null && hzCore.isDatagridEncryptionEnabled()\n+                            && value instanceof PayaraHazelcastEncryptedValueHolder) {\n+                        value = (Serializable) SymmetricEncryptor.byteArrayToObject(\n+                                SymmetricEncryptor.decode(\n+                                        ((PayaraHazelcastEncryptedValueHolder) value).getEncryptedObjectString()));\n+                    }", "originalCommit": "93024348d2b320a12991bcc36a1c12bf08bb3408", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\nindex 8dec0d39ad..56f53acd81 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\n", "chunk": "@@ -228,11 +225,10 @@ public class ClusteredStore implements EventListener, MonitoringDataSource {\n                 for (Serializable key : keys) {\n                     Serializable value = (Serializable) map.get(key);\n \n-                    if (value != null && hzCore.isDatagridEncryptionEnabled()\n-                            && value instanceof PayaraHazelcastEncryptedValueHolder) {\n-                        value = (Serializable) SymmetricEncryptor.byteArrayToObject(\n-                                SymmetricEncryptor.decode(\n-                                        ((PayaraHazelcastEncryptedValueHolder) value).getEncryptedObjectString()));\n+                    if (value instanceof PayaraHazelcastEncryptedValueHolder && hzCore.isDatagridEncryptionEnabled()) {\n+                        value = (Serializable) HazelcastSymmetricEncryptor.byteArrayToObject(\n+                                HazelcastSymmetricEncryptor.decode(\n+                                        ((PayaraHazelcastEncryptedValueHolder) value).getEncryptedObjectBytes()));\n                     }\n \n                     result.put(key, value);\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\nindex 8dec0d39ad..56f53acd81 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\n", "chunk": "@@ -228,11 +225,10 @@ public class ClusteredStore implements EventListener, MonitoringDataSource {\n                 for (Serializable key : keys) {\n                     Serializable value = (Serializable) map.get(key);\n \n-                    if (value != null && hzCore.isDatagridEncryptionEnabled()\n-                            && value instanceof PayaraHazelcastEncryptedValueHolder) {\n-                        value = (Serializable) SymmetricEncryptor.byteArrayToObject(\n-                                SymmetricEncryptor.decode(\n-                                        ((PayaraHazelcastEncryptedValueHolder) value).getEncryptedObjectString()));\n+                    if (value instanceof PayaraHazelcastEncryptedValueHolder && hzCore.isDatagridEncryptionEnabled()) {\n+                        value = (Serializable) HazelcastSymmetricEncryptor.byteArrayToObject(\n+                                HazelcastSymmetricEncryptor.decode(\n+                                        ((PayaraHazelcastEncryptedValueHolder) value).getEncryptedObjectBytes()));\n                     }\n \n                     result.put(key, value);\n", "next_change": {"commit": "fe80880cfba7f7af4824ddc8728b23bc3b46eadd", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\nindex 56f53acd81..a0bc6b648f 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/store/ClusteredStore.java\n", "chunk": "@@ -219,19 +235,21 @@ public class ClusteredStore implements EventListener, MonitoringDataSource {\n     public Map<Serializable, Serializable> getMap(String storeName) {\n         HashMap<Serializable,Serializable> result = new HashMap<>();\n         if (hzCore.isEnabled()) {\n-            IMap map = hzCore.getInstance().getMap(storeName);\n-            if (map != null) {\n-                Set<Serializable> keys = map.keySet();\n-                for (Serializable key : keys) {\n-                    Serializable value = (Serializable) map.get(key);\n-\n-                    if (value instanceof PayaraHazelcastEncryptedValueHolder && hzCore.isDatagridEncryptionEnabled()) {\n-                        value = (Serializable) HazelcastSymmetricEncryptor.byteArrayToObject(\n-                                HazelcastSymmetricEncryptor.decode(\n-                                        ((PayaraHazelcastEncryptedValueHolder) value).getEncryptedObjectBytes()));\n-                    }\n+            try (Context ctx = ctxUtil.empty().pushContext()) {\n+                IMap map = hzCore.getInstance().getMap(storeName);\n+                if (map != null) {\n+                    Set<Serializable> keys = map.keySet();\n+                    for (Serializable key : keys) {\n+                        Serializable value = (Serializable) map.get(key);\n \n-                    result.put(key, value);\n+                        if (value instanceof PayaraHazelcastEncryptedValueHolder && hzCore.isDatagridEncryptionEnabled()) {\n+                            value = (Serializable) HazelcastSymmetricEncryptor.byteArrayToObject(\n+                                    HazelcastSymmetricEncryptor.decode(\n+                                            ((PayaraHazelcastEncryptedValueHolder) value).getEncryptedObjectBytes()));\n+                        }\n+\n+                        result.put(key, value);\n+                    }\n                 }\n             }\n         }\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "efb512eabc3f44b343ec9a9885dc4a1b5b78dbef", "committedDate": "2020-12-08 13:43:33 -0600", "message": "Upgrade Payara to Hazelcast 4.1 (#5014)"}, {"oid": "dbba8a86c0f535c4a1e916714b4834cfd1121733", "committedDate": "2021-04-08 10:55:52 +0530", "message": "FISH-1280 Jakarta EE9: Compile Payara 6 artifact with Jakarta EE namespace"}, {"oid": "3b0086a8ebd1bdf984a1c295862e352fc4249a0d", "committedDate": "2021-06-09 13:19:10 +0530", "message": "FISH-1321 Copyright year update"}, {"oid": "fe80880cfba7f7af4824ddc8728b23bc3b46eadd", "committedDate": "2022-01-31 12:45:06 +0000", "message": "- pushing exmpty context in ClusteredStore to prevent association of Hazelcast maps to tenant applications (#5188)"}, {"oid": "f44183586417f8698fabf7f045fe46267886f873", "committedDate": "2022-05-18 17:25:35 +0800", "message": "Bugfix postbootcommandfile argument execution"}, {"oid": "8dc2ec4c0ba8d00aa7326570b088fec35f39ed69", "committedDate": "2022-09-12 12:52:40 +0200", "message": "FISH-6501 fix bootcommandservice runlevel"}]}, {"oid": "4d545b6ebb7598b7194def1bd2eb232d13f4fcf3", "url": "https://github.com/payara/Payara/commit/4d545b6ebb7598b7194def1bd2eb232d13f4fcf3", "message": "PAYARA-3324 Kill Hazelcast if error reading encryption key", "committedDate": "2020-01-16T11:58:03Z", "type": "commit"}, {"oid": "7d449bf7b9b98cd749077937fdd0a7d1470edc1f", "url": "https://github.com/payara/Payara/commit/7d449bf7b9b98cd749077937fdd0a7d1470edc1f", "message": "PAYARA-3324 Better null handling when checking if encryption is enabled", "committedDate": "2020-01-16T12:21:16Z", "type": "commit"}, {"oid": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "url": "https://github.com/payara/Payara/commit/34b0369f09b6d68c77be29de279fc6f3da0afca3", "message": "PAYARA-3324 Address most review comments", "committedDate": "2020-01-17T11:58:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAxNDQ1NQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r368014455", "body": "If `oldDatagridEncryptionValue` is returned in case it is different to `datagridEncryptionEnabled` this method can be simplified to just `return oldDatagridEncryptionValue`.", "bodyText": "If oldDatagridEncryptionValue is returned in case it is different to datagridEncryptionEnabled this method can be simplified to just return oldDatagridEncryptionValue.", "bodyHTML": "<p dir=\"auto\">If <code>oldDatagridEncryptionValue</code> is returned in case it is different to <code>datagridEncryptionEnabled</code> this method can be simplified to just <code>return oldDatagridEncryptionValue</code>.</p>", "author": "jbee", "createdAt": "2020-01-17T16:08:57Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java", "diffHunk": "@@ -555,6 +561,26 @@ public int getPort() {\n \n     @Override\n     public UnprocessedChangeEvents changed(PropertyChangeEvent[] pces) {\n-        return null;\n+        List<UnprocessedChangeEvent> unprocessedChanges = new ArrayList<>();\n+        for (PropertyChangeEvent pce : pces) {\n+            if (pce.getPropertyName().equalsIgnoreCase(\"datagrid-encryption-enabled\")) {\n+                unprocessedChanges.add(new UnprocessedChangeEvent(pce, \"Hazelcast encryption settings changed\"));\n+            }\n+        }\n+\n+        if (unprocessedChanges.isEmpty()) {\n+            return null;\n+        }\n+        return new UnprocessedChangeEvents(unprocessedChanges);\n+    }\n+\n+    public boolean isDatagridEncryptionEnabled() {\n+        // If the datagrid encryption settings have changed, we want to return the opposite of the current setting\n+        // to prevent the server changing encryption behaviour without a restart\n+        boolean datagridEncryptionEnabled = configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n+        if (oldDatagridEncryptionValue != datagridEncryptionEnabled) {\n+            return oldDatagridEncryptionValue;\n+        }\n+        return datagridEncryptionEnabled;", "originalCommit": "34b0369f09b6d68c77be29de279fc6f3da0afca3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzODA5Mw==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r368038093", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f", "author": "Pandrex247", "createdAt": "2020-01-17T16:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAxNDQ1NQ=="}], "type": "inlineReview", "revised_code": {"commit": "7a84767d6d1414fa5306fd394fb6d51d878804f2", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 0981207fa6..eae6db5bd8 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -575,12 +575,8 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     }\n \n     public boolean isDatagridEncryptionEnabled() {\n-        // If the datagrid encryption settings have changed, we want to return the opposite of the current setting\n-        // to prevent the server changing encryption behaviour without a restart\n-        boolean datagridEncryptionEnabled = configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n-        if (oldDatagridEncryptionValue != datagridEncryptionEnabled) {\n-            return oldDatagridEncryptionValue;\n-        }\n-        return datagridEncryptionEnabled;\n+        // We want to return the value as it was at boot time here to prevent the server changing encryption behaviour\n+        // without a restart\n+        return datagridEncryptionValue;\n     }\n }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 0981207fa6..db3fc8117f 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -575,12 +576,8 @@ public class HazelcastCore implements EventListener, ConfigListener {\n     }\n \n     public boolean isDatagridEncryptionEnabled() {\n-        // If the datagrid encryption settings have changed, we want to return the opposite of the current setting\n-        // to prevent the server changing encryption behaviour without a restart\n-        boolean datagridEncryptionEnabled = configuration.getDatagridEncryptionEnabled().equalsIgnoreCase(\"true\");\n-        if (oldDatagridEncryptionValue != datagridEncryptionEnabled) {\n-            return oldDatagridEncryptionValue;\n-        }\n-        return datagridEncryptionEnabled;\n+        // We want to return the value as it was at boot time here to prevent the server changing encryption behaviour\n+        // without a restart\n+        return datagridEncryptionValue;\n     }\n }\n", "next_change": {"commit": "af357179c87ccbbddb0198c4534b4ea26f671bcb", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex db3fc8117f..0aeb250b8f 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -580,4 +687,95 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         // without a restart\n         return datagridEncryptionValue;\n     }\n+\n+    public void fillConfigurationFromHazelcastElem(fish.payara.nucleus.hazelcast.xsd.Hazelcast hazelcast,\n+                                                   HazelcastRuntimeConfiguration configuration) {\n+        for (Object item : hazelcast.getImportOrConfigReplacersOrClusterName()) {\n+            JAXBElement element = (JAXBElement) item;\n+            if (element.getName().getLocalPart().equals(\"cluster-name\")) {\n+                configuration.setClusterGroupName((String) element.getValue());\n+                continue;\n+            }\n+            if (element.getName().getLocalPart().equals(\"license-key\")) {\n+                configuration.setLicenseKey((String) element.getValue());\n+                continue;\n+            }\n+            if (element.getDeclaredType().equals(Network.class)) {\n+                Network network = (Network) element.getValue();\n+                Port port = network.getPort();\n+                if (port != null) {\n+                    configuration.setDasPort(String.valueOf(port.getValue()));\n+                    configuration.setAutoIncrementPort(\"\" + port.isAutoIncrement());\n+                }\n+                if (network.getPublicAddress() != null\n+                        && !\"\".equals(network.getPublicAddress().trim())) {\n+                    configuration.setDASPublicAddress(network.getPublicAddress());\n+                }\n+                Interfaces networkInterfaces = network.getInterfaces();\n+                if (networkInterfaces != null && networkInterfaces.isEnabled()) {\n+                    configuration.setInterface(String.join(\",\", networkInterfaces.getInterface()));\n+                }\n+                Join join = network.getJoin();\n+                if (join != null) {\n+                    TcpIp tcpIp = join.getTcpIp();\n+                    if (tcpIp != null) {\n+                        for (JAXBElement member : tcpIp.getRequiredMemberOrMemberOrInterface()) {\n+                            if (member.getDeclaredType().equals(TcpIp.MemberList.class)) {\n+                                TcpIp.MemberList memberList = (TcpIp.MemberList) member.getValue();\n+                                configuration.setTcpipMembers(String.join(\",\", memberList.getMember()));\n+                            }\n+                        }\n+                    }\n+                    Multicast multicast = join.getMulticast();\n+                    if (multicast != null && multicast.isEnabled()) {\n+                        configuration.setMulticastGroup(multicast.getMulticastGroup());\n+                        configuration.setMulticastPort(String.valueOf(multicast.getMulticastPort()));\n+                    }\n+                    AliasedDiscoveryStrategy kubernetes = join.getKubernetes();\n+                    if (kubernetes != null && kubernetes.isEnabled()) {\n+                        for (Element e : kubernetes.getAny()) {\n+                            if (e.getLocalName().equals(\"namespace\")) {\n+                                configuration.setKubernetesNamespace(e.getFirstChild().getNodeValue());\n+                            } else if (e.getLocalName().equals(\"service-name\")) {\n+                                configuration.setKubernetesServiceName(e.getFirstChild().getNodeValue());\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n+    public void fillSpecificConfigFromHazelcastElem(fish.payara.nucleus.hazelcast.xsd.Hazelcast hazelcast,\n+                                                   HazelcastConfigSpecificConfiguration specificConfig) {\n+        for (Object item : hazelcast.getImportOrConfigReplacersOrClusterName()) {\n+            JAXBElement element = (JAXBElement) item;\n+            if (element.getName().getLocalPart().equals(\"lite-member\")) {\n+                LiteMember liteMember = (LiteMember) element.getValue();\n+                Boolean lite = liteMember.isEnabled();\n+                specificConfig.setLite(lite.toString());\n+                continue;\n+            }\n+            if (element.getDeclaredType().equals(ExecutorService.class)) {\n+                ExecutorService executorService = (ExecutorService) element.getValue();\n+                if (executorService.getPoolSize() != null) {\n+                    specificConfig.setExecutorPoolSize(String.valueOf(executorService.getPoolSize()));\n+                }\n+                if (executorService.getQueueCapacity() != null) {\n+                    specificConfig.setExecutorQueueCapacity(String.valueOf(executorService.getQueueCapacity()));\n+                }\n+                continue;\n+            }\n+            if (element.getDeclaredType().equals(ScheduledExecutorService.class)) {\n+                ScheduledExecutorService scheduledExecutorService = (ScheduledExecutorService) element.getValue();\n+                if (scheduledExecutorService.getPoolSize() != null) {\n+                    specificConfig.setScheduledExecutorPoolSize(String.valueOf(scheduledExecutorService.getPoolSize()));\n+                }\n+                if (scheduledExecutorService.getCapacity() != null) {\n+                    specificConfig.setScheduledExecutorQueueCapacity(String.valueOf(scheduledExecutorService.getCapacity()));\n+                }\n+                continue;\n+            }\n+        }\n+    }\n }\n", "next_change": {"commit": "4d2d278b084d9ebb58c6959f0af7c2e8f6121aeb", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 0aeb250b8f..a9f13f13e2 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -778,4 +788,58 @@ public class HazelcastCore implements EventListener, ConfigListener {\n             }\n         }\n     }\n+\n+    private void fillConfigurationWithDefaults() throws TransactionFailure {\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastRuntimeConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastRuntimeConfiguration hazelcastRuntimeConfiguration)\n+                    throws PropertyVetoException, TransactionFailure {\n+                hazelcastRuntimeConfiguration.setChangeToDefault(\"false\");\n+                hazelcastRuntimeConfiguration.setHazelcastConfigurationFile(\"hazelcast-config.xml\");\n+                hazelcastRuntimeConfiguration.setAutoIncrementPort(\"true\");\n+                hazelcastRuntimeConfiguration.setStartPort(\"5900\");\n+                hazelcastRuntimeConfiguration.setDASPublicAddress(\"\");\n+                hazelcastRuntimeConfiguration.setDASBindAddress(\"\");\n+                hazelcastRuntimeConfiguration.setDasPort(\"4900\");\n+                hazelcastRuntimeConfiguration.setMulticastGroup(\"224.2.2.3\");\n+                hazelcastRuntimeConfiguration.setMulticastPort(\"54327\");\n+                hazelcastRuntimeConfiguration.setTcpipMembers(\"127.0.0.1:5900\");\n+                hazelcastRuntimeConfiguration.setDnsMembers(\"localhost:5900\");\n+                hazelcastRuntimeConfiguration.setDiscoveryMode(\"domain\");\n+                hazelcastRuntimeConfiguration.setGenerateNames(\"false\");\n+                hazelcastRuntimeConfiguration.setInterface(\"\");\n+                hazelcastRuntimeConfiguration.setClusterGroupName(\"development\");\n+                hazelcastRuntimeConfiguration.setHostAwarePartitioning(\"true\");\n+                hazelcastRuntimeConfiguration.setLicenseKey(\"\");\n+                hazelcastRuntimeConfiguration.setKubernetesNamespace(\"default\");\n+                hazelcastRuntimeConfiguration.setKubernetesServiceName(\"\");\n+                hazelcastRuntimeConfiguration.setDatagridEncryptionEnabled(\"false\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast general configuration filled with defaults\");\n+                return null;\n+            }\n+        }, configuration);\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration)\n+                    throws PropertyVetoException, TransactionFailure {\n+                hazelcastConfigSpecificConfiguration.setEnabled(\"true\");\n+                hazelcastConfigSpecificConfiguration.setClusteringEnabled(\"true\");\n+                hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n+                hazelcastConfigSpecificConfiguration.setMemberName(\"payara\");\n+                hazelcastConfigSpecificConfiguration.setMemberGroup(\"MicroShoal\");\n+                hazelcastConfigSpecificConfiguration.setJNDIName(\"payara/Hazelcast\");\n+                hazelcastConfigSpecificConfiguration.setCacheManagerJNDIName(\"payara/CacheManager\");\n+                hazelcastConfigSpecificConfiguration.setCachingProviderJNDIName(\"payara/CachingProvider\");\n+                hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n+                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast specific configuration filled with defaults\");\n+                return null;\n+            }\n+        }, nodeConfig);\n+    }\n }\n", "next_change": {"commit": "4f802c07f1ce7071d0ae424cd43a3c0e22ba2178", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex a9f13f13e2..3733cd8dc1 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -821,21 +744,13 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         }, configuration);\n         ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n             @Override\n-            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration)\n-                    throws PropertyVetoException, TransactionFailure {\n-                hazelcastConfigSpecificConfiguration.setEnabled(\"true\");\n-                hazelcastConfigSpecificConfiguration.setClusteringEnabled(\"true\");\n+            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration) {\n                 hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n-                hazelcastConfigSpecificConfiguration.setMemberName(\"payara\");\n-                hazelcastConfigSpecificConfiguration.setMemberGroup(\"MicroShoal\");\n-                hazelcastConfigSpecificConfiguration.setJNDIName(\"payara/Hazelcast\");\n-                hazelcastConfigSpecificConfiguration.setCacheManagerJNDIName(\"payara/CacheManager\");\n-                hazelcastConfigSpecificConfiguration.setCachingProviderJNDIName(\"payara/CachingProvider\");\n+                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n                 hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n                 hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n                 hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n                 hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n-                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n                 Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n                         \"Hazelcast specific configuration filled with defaults\");\n                 return null;\n", "next_change": {"commit": "ae649dc60446556d6e4c6bef49c8d99b2bf14156", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex 3733cd8dc1..c5a6703e92 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -667,94 +627,4 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         // without a restart\n         return datagridEncryptionValue;\n     }\n-\n-    private void fillHazelcastConfigurationFromConfig(Config config,\n-                                                   HazelcastRuntimeConfiguration configuration) {\n-        configuration.setClusterGroupName(config.getClusterName());\n-        configuration.setLicenseKey(config.getLicenseKey());\n-\n-        if (env.isDas() && !env.isMicro()) {\n-            configuration.setDasPort(String.valueOf(config.getNetworkConfig().getPort()));\n-        } else {\n-            configuration.setStartPort(String.valueOf(config.getNetworkConfig().getPort()));\n-        }\n-        configuration.setAutoIncrementPort(String.valueOf(config.getNetworkConfig().isPortAutoIncrement()));\n-\n-        NetworkConfig nConfig = config.getNetworkConfig();\n-        InterfacesConfig interfacesConfig = nConfig.getInterfaces();\n-        if (interfacesConfig != null) {\n-            configuration.setInterface(\n-                interfacesConfig.getInterfaces().stream().collect(Collectors.joining(\",\")));\n-        }\n-        JoinConfig joinConfig = nConfig.getJoin();\n-        if (joinConfig != null) {\n-            TcpIpConfig tConfig = joinConfig.getTcpIpConfig();\n-            if (tConfig != null && tConfig.isEnabled()) {\n-                configuration.setTcpipMembers(tConfig.getMembers().stream().collect(Collectors.joining(\",\")));\n-            }\n-            MulticastConfig multicastConfig = joinConfig.getMulticastConfig();\n-            if (multicastConfig != null && multicastConfig.isEnabled()) {\n-                configuration.setMulticastGroup(multicastConfig.getMulticastGroup());\n-                configuration.setMulticastPort(String.valueOf(multicastConfig.getMulticastPort()));\n-            }\n-            KubernetesConfig kubernetesConfig = joinConfig.getKubernetesConfig();\n-            if (kubernetesConfig != null && kubernetesConfig.isEnabled()) {\n-                configuration.setKubernetesNamespace(kubernetesConfig.getProperty(KubernetesProperties.NAMESPACE.key()));\n-                configuration.setKubernetesServiceName(kubernetesConfig.getProperty(KubernetesProperties.SERVICE_NAME.key()));\n-            }\n-        }\n-    }\n-\n-    private void fillSpecificHazelcastConfigFromConfig(Config config,\n-                                                   HazelcastConfigSpecificConfiguration nodeConfig) {\n-        NetworkConfig nConfig = config.getNetworkConfig();\n-        if(nConfig.getPublicAddress() != null && !nConfig.getPublicAddress().isEmpty()) {\n-            nodeConfig.setPublicAddress(nConfig.getPublicAddress());\n-        }\n-        nodeConfig.setLite(String.valueOf(config.isLiteMember()));\n-        ExecutorConfig executorConfig = config.getExecutorConfig(CLUSTER_EXECUTOR_SERVICE_NAME);\n-        nodeConfig.setExecutorPoolSize(String.valueOf(executorConfig.getPoolSize()));\n-        nodeConfig.setExecutorQueueCapacity(String.valueOf(executorConfig.getQueueCapacity()));\n-        ScheduledExecutorConfig scheduledExecutorConfig = config.getScheduledExecutorConfig(\n-                SCHEDULED_CLUSTER_EXECUTOR_SERVICE_NAME);\n-        nodeConfig.setScheduledExecutorPoolSize(String.valueOf(scheduledExecutorConfig.getPoolSize()));\n-        nodeConfig.setScheduledExecutorQueueCapacity(String.valueOf(scheduledExecutorConfig.getCapacity()));\n-    }\n-\n-    private void fillConfigurationWithDefaults() throws TransactionFailure {\n-        ConfigSupport.apply(new SingleConfigCode<HazelcastRuntimeConfiguration>() {\n-            @Override\n-            public Object run(final HazelcastRuntimeConfiguration hazelcastRuntimeConfiguration) {\n-                hazelcastRuntimeConfiguration.setChangeToDefault(\"false\");\n-                hazelcastRuntimeConfiguration.setClusterGroupName(\"development\");\n-                hazelcastRuntimeConfiguration.setLicenseKey(\"\");\n-                hazelcastRuntimeConfiguration.setDasPort(\"4900\");\n-                hazelcastRuntimeConfiguration.setStartPort(\"5900\");\n-                hazelcastRuntimeConfiguration.setAutoIncrementPort(\"true\");\n-                hazelcastRuntimeConfiguration.setInterface(\"\");\n-                hazelcastRuntimeConfiguration.setTcpipMembers(\"127.0.0.1:5900\");\n-                hazelcastRuntimeConfiguration.setMulticastGroup(\"224.2.2.3\");\n-                hazelcastRuntimeConfiguration.setMulticastPort(\"54327\");\n-                hazelcastRuntimeConfiguration.setKubernetesNamespace(\"default\");\n-                hazelcastRuntimeConfiguration.setKubernetesServiceName(\"\");\n-                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n-                        \"Hazelcast general configuration filled with defaults\");\n-                return null;\n-            }\n-        }, configuration);\n-        ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n-            @Override\n-            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration) {\n-                hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n-                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n-                hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n-                hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n-                hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n-                hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n-                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n-                        \"Hazelcast specific configuration filled with defaults\");\n-                return null;\n-            }\n-        }, nodeConfig);\n-    }\n }\n", "next_change": {"commit": "5e9f5f620ea2ce0ea68e090e9daf6e3f5fb43f66", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\nindex c5a6703e92..3b568d7648 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java\n", "chunk": "@@ -627,4 +662,94 @@ public class HazelcastCore implements EventListener, ConfigListener {\n         // without a restart\n         return datagridEncryptionValue;\n     }\n+\n+    private void fillHazelcastConfigurationFromConfig(Config config,\n+                                                   HazelcastRuntimeConfiguration configuration) {\n+        configuration.setClusterGroupName(config.getClusterName());\n+        configuration.setLicenseKey(config.getLicenseKey());\n+\n+        if (env.isDas() && !env.isMicro()) {\n+            configuration.setDasPort(String.valueOf(config.getNetworkConfig().getPort()));\n+        } else {\n+            configuration.setStartPort(String.valueOf(config.getNetworkConfig().getPort()));\n+        }\n+        configuration.setAutoIncrementPort(String.valueOf(config.getNetworkConfig().isPortAutoIncrement()));\n+\n+        NetworkConfig nConfig = config.getNetworkConfig();\n+        InterfacesConfig interfacesConfig = nConfig.getInterfaces();\n+        if (interfacesConfig != null) {\n+            configuration.setInterface(\n+                interfacesConfig.getInterfaces().stream().collect(Collectors.joining(\",\")));\n+        }\n+        JoinConfig joinConfig = nConfig.getJoin();\n+        if (joinConfig != null) {\n+            TcpIpConfig tConfig = joinConfig.getTcpIpConfig();\n+            if (tConfig != null && tConfig.isEnabled()) {\n+                configuration.setTcpipMembers(tConfig.getMembers().stream().collect(Collectors.joining(\",\")));\n+            }\n+            MulticastConfig multicastConfig = joinConfig.getMulticastConfig();\n+            if (multicastConfig != null && multicastConfig.isEnabled()) {\n+                configuration.setMulticastGroup(multicastConfig.getMulticastGroup());\n+                configuration.setMulticastPort(String.valueOf(multicastConfig.getMulticastPort()));\n+            }\n+            KubernetesConfig kubernetesConfig = joinConfig.getKubernetesConfig();\n+            if (kubernetesConfig != null && kubernetesConfig.isEnabled()) {\n+                configuration.setKubernetesNamespace(kubernetesConfig.getProperty(KubernetesProperties.NAMESPACE.key()));\n+                configuration.setKubernetesServiceName(kubernetesConfig.getProperty(KubernetesProperties.SERVICE_NAME.key()));\n+            }\n+        }\n+    }\n+\n+    private void fillSpecificHazelcastConfigFromConfig(Config config,\n+                                                   HazelcastConfigSpecificConfiguration nodeConfig) {\n+        NetworkConfig nConfig = config.getNetworkConfig();\n+        if(nConfig.getPublicAddress() != null && !nConfig.getPublicAddress().isEmpty()) {\n+            nodeConfig.setPublicAddress(nConfig.getPublicAddress());\n+        }\n+        nodeConfig.setLite(String.valueOf(config.isLiteMember()));\n+        ExecutorConfig executorConfig = config.getExecutorConfig(CLUSTER_EXECUTOR_SERVICE_NAME);\n+        nodeConfig.setExecutorPoolSize(String.valueOf(executorConfig.getPoolSize()));\n+        nodeConfig.setExecutorQueueCapacity(String.valueOf(executorConfig.getQueueCapacity()));\n+        ScheduledExecutorConfig scheduledExecutorConfig = config.getScheduledExecutorConfig(\n+                SCHEDULED_CLUSTER_EXECUTOR_SERVICE_NAME);\n+        nodeConfig.setScheduledExecutorPoolSize(String.valueOf(scheduledExecutorConfig.getPoolSize()));\n+        nodeConfig.setScheduledExecutorQueueCapacity(String.valueOf(scheduledExecutorConfig.getCapacity()));\n+    }\n+\n+    private void fillConfigurationWithDefaults() throws TransactionFailure {\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastRuntimeConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastRuntimeConfiguration hazelcastRuntimeConfiguration) {\n+                hazelcastRuntimeConfiguration.setChangeToDefault(\"false\");\n+                hazelcastRuntimeConfiguration.setClusterGroupName(\"development\");\n+                hazelcastRuntimeConfiguration.setLicenseKey(\"\");\n+                hazelcastRuntimeConfiguration.setDasPort(\"4900\");\n+                hazelcastRuntimeConfiguration.setStartPort(\"5900\");\n+                hazelcastRuntimeConfiguration.setAutoIncrementPort(\"true\");\n+                hazelcastRuntimeConfiguration.setInterface(\"\");\n+                hazelcastRuntimeConfiguration.setTcpipMembers(\"127.0.0.1:5900\");\n+                hazelcastRuntimeConfiguration.setMulticastGroup(\"224.2.2.3\");\n+                hazelcastRuntimeConfiguration.setMulticastPort(\"54327\");\n+                hazelcastRuntimeConfiguration.setKubernetesNamespace(\"default\");\n+                hazelcastRuntimeConfiguration.setKubernetesServiceName(\"\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast general configuration filled with defaults\");\n+                return null;\n+            }\n+        }, configuration);\n+        ConfigSupport.apply(new SingleConfigCode<HazelcastConfigSpecificConfiguration>() {\n+            @Override\n+            public Object run(final HazelcastConfigSpecificConfiguration hazelcastConfigSpecificConfiguration) {\n+                hazelcastConfigSpecificConfiguration.setPublicAddress(\"\");\n+                hazelcastConfigSpecificConfiguration.setLite(\"false\");\n+                hazelcastConfigSpecificConfiguration.setExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setExecutorQueueCapacity(\"20\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorPoolSize(\"4\");\n+                hazelcastConfigSpecificConfiguration.setScheduledExecutorQueueCapacity(\"20\");\n+                Logger.getLogger(HazelcastCore.class.getName()).log(Level.INFO,\n+                        \"Hazelcast specific configuration filled with defaults\");\n+                return null;\n+            }\n+        }, nodeConfig);\n+    }\n }\n", "next_change": null}]}}]}}]}}]}}]}}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "dd07f55c8f6b0ce789b83f744fc16efb87d00648", "committedDate": "2020-01-29 15:32:14 +0000", "message": "CUSTCOM-24 Remove ThreadLocal Hazelcast disable"}, {"oid": "bce9309afdd64ac53f344b58cfb529ead1d1da6b", "committedDate": "2020-02-11 11:54:35 +0000", "message": "CUSTCOM-79 Remove default hazelcast start port value"}, {"oid": "12ae70674f3c57c7739556853f1b2d3d608f08a0", "committedDate": "2020-03-09 13:42:20 +0000", "message": "CUSTCOM-223 Move log message into if block"}, {"oid": "1dd71b6238fdee76a5b3302a1518c8287b61fb59", "committedDate": "2020-11-04 20:43:06 -0600", "message": "even more refactoring, separated initPublicAddress() and initBindAddress() and made them even more self-describing and autonomous"}, {"oid": "efb512eabc3f44b343ec9a9885dc4a1b5b78dbef", "committedDate": "2020-12-08 13:43:33 -0600", "message": "Upgrade Payara to Hazelcast 4.1 (#5014)"}, {"oid": "9067d0736c4e167118c9d2db9382fdaa50cf9ea0", "committedDate": "2020-12-08 17:31:54 -0600", "message": "introduce tenant control"}, {"oid": "d62090658ce38d6d5f47820b857ce3cb99732455", "committedDate": "2021-03-26 16:55:26 +0100", "message": "Revert \"FISH-858 Upgrade to Hazelcast 4.2 from 4.1 and use Tenant Control APIs\""}, {"oid": "0fe1775753c8777e968fd926290b7237f8b07a99", "committedDate": "2021-03-26 13:45:48 -0500", "message": "[FISH-858] Upgrade to Hazelcast 4.2 from 4.1 and use Tenant Control APIs (#5176)"}, {"oid": "dbba8a86c0f535c4a1e916714b4834cfd1121733", "committedDate": "2021-04-08 10:55:52 +0530", "message": "FISH-1280 Jakarta EE9: Compile Payara 6 artifact with Jakarta EE namespace"}, {"oid": "3b0086a8ebd1bdf984a1c295862e352fc4249a0d", "committedDate": "2021-06-09 13:19:10 +0530", "message": "FISH-1321 Copyright year update"}, {"oid": "bd6380d3bc4f01722a7f5ac2da377199c7a1c9b5", "committedDate": "2022-05-16 19:35:22 +0800", "message": "Bugfix postbootcommandfile argument execution"}, {"oid": "f44183586417f8698fabf7f045fe46267886f873", "committedDate": "2022-05-18 17:25:35 +0800", "message": "Bugfix postbootcommandfile argument execution"}, {"oid": "6e418d2d4b903dd9bddccfbccfe7587e91391f92", "committedDate": "2022-08-29 17:11:49 +0200", "message": "Have implemented the fix. INtegration tests in progress"}, {"oid": "a03fd87db043592af99392a1492e9f87ba90b87a", "committedDate": "2022-08-29 17:11:49 +0200", "message": "Update nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/HazelcastCore.java"}, {"oid": "bce8422734744c075394119762ab93858ab257db", "committedDate": "2022-09-12 12:40:25 +0200", "message": "FISH-6501 fix bootcommandservice runlevel"}, {"oid": "8dc2ec4c0ba8d00aa7326570b088fec35f39ed69", "committedDate": "2022-09-12 12:52:40 +0200", "message": "FISH-6501 fix bootcommandservice runlevel"}, {"oid": "3c61a52fc8048c01da254852c96789287aca463e", "committedDate": "2022-09-21 11:19:13 +0100", "message": "Merge branch 'master' into FISH-372"}, {"oid": "3641bd845538899391f997ffb404e8faff63cad6", "committedDate": "2022-10-10 16:22:45 -0300", "message": "FISH-6500 : verifying file path existence"}, {"oid": "af357179c87ccbbddb0198c4534b4ea26f671bcb", "committedDate": "2022-10-11 12:04:19 -0300", "message": "FISH-6500 : fill the config hazelcast from file when server starts"}, {"oid": "1542280a08dd97f811c50e58a6c464a040c9960b", "committedDate": "2022-10-17 14:31:51 -0300", "message": "FISH-6500 : Log to inform hazelcast config from file"}, {"oid": "4259aa06b36e241b665cc172e01959664e85ee03", "committedDate": "2022-10-18 06:23:29 -0300", "message": "FISH-6500 : Unused imports and member removed"}, {"oid": "88defca0ab341784e1276b6c0cc863b2013a8d16", "committedDate": "2022-10-18 08:40:03 -0300", "message": "FISH-6500 : values not changing dinamically"}, {"oid": "ab64c299263521e52d8d5c89827a729f6e3a64c8", "committedDate": "2022-10-18 10:41:21 -0300", "message": "FISH-6500 : hazelcast config file being read at startup"}, {"oid": "4d2d278b084d9ebb58c6959f0af7c2e8f6121aeb", "committedDate": "2022-10-18 16:04:24 -0300", "message": "FISH-6500 : hazelcast config with default values setted"}, {"oid": "25172d8d82421512316bfe407e9ce57fc3b21a80", "committedDate": "2022-10-18 16:18:30 -0300", "message": "FISH-6500 : unnecessary throws removed"}, {"oid": "d5a7391cc7727e7965ed5da8ad16f0df62b0f208", "committedDate": "2022-10-18 16:46:57 -0300", "message": "FISH-6500 : setting default config"}, {"oid": "3153563ee6a8af1f8bdea09b7aeea185370e5f52", "committedDate": "2022-10-22 14:47:44 -0300", "message": "FISH-6495 : not using xsd package"}, {"oid": "4f802c07f1ce7071d0ae424cd43a3c0e22ba2178", "committedDate": "2022-10-22 18:04:36 -0300", "message": "FISH-6500 : fill defaults correctly"}, {"oid": "572c567f7295a65cbaa66f3fa7c5d95544d36527", "committedDate": "2022-10-22 21:46:13 -0300", "message": "FISH-6500 : removing xjc generated files references"}, {"oid": "ae649dc60446556d6e4c6bef49c8d99b2bf14156", "committedDate": "2022-10-24 10:13:51 +0100", "message": "Merge pull request #5904 from nicolasduminil/fish-372"}, {"oid": "5e9f5f620ea2ce0ea68e090e9daf6e3f5fb43f66", "committedDate": "2022-10-24 21:32:25 -0300", "message": "FISH-6495 : using hazelcast boostrap config property"}, {"oid": "bc4144c32b976880a71a365e04e2bf03d6f20b3e", "committedDate": "2022-10-25 09:24:56 +0100", "message": "Merge pull request #5995 from Pandrex247/FISH-372-P6"}, {"oid": "25e046c7a8de8fcbdeabc18832046718799f956d", "committedDate": "2022-10-27 14:14:34 -0300", "message": "FISH-6495 : setting hazelcast property when passed"}, {"oid": "505c1ae4879d617fcf686beee2145315d0e18867", "committedDate": "2023-01-16 12:19:32 +0000", "message": "FISH-6816 Merge Payara6 into master"}]}, {"oid": "7a84767d6d1414fa5306fd394fb6d51d878804f2", "url": "https://github.com/payara/Payara/commit/7a84767d6d1414fa5306fd394fb6d51d878804f2", "message": "D'oh!", "committedDate": "2020-01-17T17:01:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ3MjExMA==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r368472110", "body": "With `Boolean.parseBoolean` there is no autoboxing in the code.", "bodyText": "With Boolean.parseBoolean there is no autoboxing in the code.", "bodyHTML": "<p dir=\"auto\">With <code>Boolean.parseBoolean</code> there is no autoboxing in the code.</p>", "author": "rdebusscher", "createdAt": "2020-01-20T10:26:29Z", "path": "nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java", "diffHunk": "@@ -612,4 +619,25 @@ private long getEndTime() {\n         return CLIConstants.WAIT_FOR_DAS_TIME_MS + now();\n     }\n \n+    protected boolean dataGridEncryptionEnabled() throws IOException, XMLStreamException {\n+        // We can't access config beans from this invocation due to it being CLI vs. ASAdmin command - it's not\n+        // executing against a running server. This means we need to read directly from the domain.xml.\n+        XMLEventReader xmlReader = XMLInputFactory.newInstance().createXMLEventReader(new FileInputStream(getDomainXml()));\n+        while (xmlReader.hasNext()) {\n+            XMLEvent event = xmlReader.nextEvent();\n+\n+            if (event.isStartElement()\n+                    && event.asStartElement().getName().getLocalPart().equals(\"hazelcast-runtime-configuration\")) {\n+                Attribute attribute = event.asStartElement().getAttributeByName(new QName(\"datagrid-encryption-enabled\"));\n+                if (attribute == null) {\n+                    return false;\n+                }\n+                return Boolean.valueOf(attribute.getValue());", "originalCommit": "7a84767d6d1414fa5306fd394fb6d51d878804f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "969f3cff70a0bf27ad98ff698fa6723bbc7350dc", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\nindex b032c30fa9..90321d6185 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n", "chunk": "@@ -632,7 +632,7 @@ public abstract class LocalServerCommand extends CLICommand {\n                 if (attribute == null) {\n                     return false;\n                 }\n-                return Boolean.valueOf(attribute.getValue());\n+                return Boolean.parseBoolean(attribute.getValue());\n             }\n         }\n \n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\nindex b032c30fa9..90321d6185 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n", "chunk": "@@ -632,7 +632,7 @@ public abstract class LocalServerCommand extends CLICommand {\n                 if (attribute == null) {\n                     return false;\n                 }\n-                return Boolean.valueOf(attribute.getValue());\n+                return Boolean.parseBoolean(attribute.getValue());\n             }\n         }\n \n", "next_change": {"commit": "7d571b74b23672311b643fa6616f23f8922be6d7", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\nindex 90321d6185..2a64abee84 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n", "chunk": "@@ -640,4 +642,24 @@ public abstract class LocalServerCommand extends CLICommand {\n                 \"you will need to regenerate the encryption key if it is\");\n         return false;\n     }\n+\n+    /**\n+     * Gets the GlassFish installation root (using property com.sun.aas.installRoot),\n+     * first from asenv.conf.  If that's not available, then from java.lang.System.\n+     *\n+     * @return path of GlassFish install root\n+     * @throws CommandException if the GlassFish install root is not found\n+     */\n+    protected String getInstallRootPath() throws CommandException {\n+        String installRootPath = getSystemProperty(SystemPropertyConstants.INSTALL_ROOT_PROPERTY);\n+\n+        if (!StringUtils.ok(installRootPath)) {\n+            installRootPath = System.getProperty(SystemPropertyConstants.INSTALL_ROOT_PROPERTY);\n+        }\n+\n+        if (!StringUtils.ok(installRootPath)) {\n+            throw new CommandException(\"noInstallDirPath\");\n+        }\n+        return installRootPath;\n+    }\n }\n", "next_change": {"commit": "131f642e52d269031a43a90a36145c1e6cdbe30b", "changed_code": [{"header": "diff --git a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\nindex 2a64abee84..3eadf0da5a 100644\n--- a/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n+++ b/nucleus/admin/server-mgmt/src/main/java/com/sun/enterprise/admin/servermgmt/cli/LocalServerCommand.java\n", "chunk": "@@ -662,4 +660,41 @@ public abstract class LocalServerCommand extends CLICommand {\n         }\n         return installRootPath;\n     }\n-}\n+\n+    protected void checkAdditionalTrustAndKeyStores() throws IOException, XMLStreamException {\n+        HashMap<String, String> additionalTrustandKeyStores = new HashMap<>();\n+        try {\n+            DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();\n+            DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();\n+            Document document = documentBuilder.parse(getDomainXml());\n+            NodeList jvmOptionsNodes = document.getElementsByTagName(\"jvm-options\");\n+\n+            for (int i = 0; i < jvmOptionsNodes.getLength(); i++) {\n+                String jvmOption = jvmOptionsNodes.item(i).getTextContent();\n+                if (jvmOption.startsWith(\"-Dfish.payara.ssl.additionalKeyStores\")) {\n+                    String additionalKeyStores = jvmOption.split(\"=\")[1];\n+                    additionalTrustandKeyStores.compute(\"additionalKeyStores\", (key, value) -> value == null ? additionalKeyStores : value.concat(\", \" + additionalKeyStores));\n+                    continue;\n+                }\n+                if (jvmOption.startsWith(\"-Dfish.payara.ssl.additionalTrustStores\")) {\n+                    String additionalTrustStores = jvmOption.split(\"=\")[1];\n+                    additionalTrustandKeyStores.compute(\"additionalTrustStores\", (key, value) -> value == null ? additionalTrustStores : value.concat(\", \" + additionalTrustStores));\n+                    continue;\n+                }\n+            }\n+            if (additionalTrustandKeyStores.containsKey(\"additionalKeyStores\")) {\n+                logger.log(Level.INFO,\n+                        \"The passwords of additional KeyStores {0} have not been changed - please update these manually to continue using them.\",\n+                        Arrays.toString(additionalTrustandKeyStores.get(\"additionalKeyStores\").split(\":(?!\\\\\\\\)\")));\n+            }\n+            if (additionalTrustandKeyStores.containsKey(\"additionalTrustStores\")) {\n+                logger.log(Level.INFO,\n+                        \"The passwords of additional TrustStores {0} have not been changed - please update these manually to continue using them.\",\n+                        Arrays.toString(additionalTrustandKeyStores.get(\"additionalTrustStores\").split(\":(?!\\\\\\\\)\")));\n+            }\n+        } catch (ParserConfigurationException | SAXException exception) {\n+            logger.warning(\n+                    \"Could not determine if there were additional Key Stores or Trust stores, if the master-password has been updated, the password for the additional stores need updating in order to continue using them.\");\n+        }\n+    }\n+}\n\\ No newline at end of file\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "3207e1130e128102d148df3b2e7a9b9b98ae5452", "committedDate": "2020-06-04 15:15:02 +0100", "message": "CUSTCOM-14 Improvements in stop-domain process"}, {"oid": "7d571b74b23672311b643fa6616f23f8922be6d7", "committedDate": "2020-06-23 10:57:31 +0100", "message": "APPSERV-151 Add command to generate CSR and some minor refactors"}, {"oid": "6f959188dc6512a1c6b2207ff3675d64318901fd", "committedDate": "2020-06-24 09:44:53 +0100", "message": "Merge pull request #4699 from MeroRai/CUSTCOM-14"}, {"oid": "131f642e52d269031a43a90a36145c1e6cdbe30b", "committedDate": "2021-10-11 10:45:26 +0100", "message": "Merge pull request #5370 from kalinchan/FISH-5639"}, {"oid": "9befc0d68f4e5928b02c53c7487e1fc861bcf45e", "committedDate": "2021-10-11 10:48:28 +0100", "message": "Merge pull request #5395 from JamesHillyard/FISH-5693"}, {"oid": "49a423bba352e166ed27af4e2a94d7306a299386", "committedDate": "2022-04-05 16:42:03 +0100", "message": "FISH-898 Add Timeout Option"}, {"oid": "9cf1d539f16a468946d35f4402da46293e31de7f", "committedDate": "2022-06-09 08:38:03 -0300", "message": "FISH-1366 references to .jks changed to .p12"}, {"oid": "985123ffa04de69092d833f160cd528909d4c6be", "committedDate": "2022-07-14 09:54:58 +0100", "message": "Revert \"Merge pull request #5801 from luiseufrasio/FISH-1366\""}, {"oid": "07d527c92081ef530a7b2b20b7fd68846820ae72", "committedDate": "2022-12-20 09:30:06 -0300", "message": "FISH-6406 : keystore & cacerts migrated to PKCS12 format"}, {"oid": "437774502a3e84bbdc3047bc6885a392235dd585", "committedDate": "2023-04-26 13:17:33 +0200", "message": "FISH-6504 during verification of master password, load cacerts.jks if p12 is not found"}, {"oid": "ec8fd16647ce3d644c66b88e859469bda2b84708", "committedDate": "2023-04-26 17:13:16 +0200", "message": "FISH-6504 typo and copyright"}, {"oid": "8da74c97384fdaed1ad7720a63e2563f4e67d359", "committedDate": "2023-05-04 13:46:07 +0200", "message": "FISH-7359 fix change-master-password for jks keystores"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ3MjYwMg==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r368472602", "body": "Explicit types not needed.", "bodyText": "Explicit types not needed.", "bodyHTML": "<p dir=\"auto\">Explicit types not needed.</p>", "author": "rdebusscher", "createdAt": "2020-01-20T10:27:28Z", "path": "appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java", "diffHunk": "@@ -36,9 +60,12 @@ and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n     @Inject\n     HazelcastCore core;\n \n+    @Inject\n+    ClusteredStore clusteredStore;\n+\n     @Override\n     public <K extends Serializable, V extends Serializable> BackingStore<K, V> createBackingStore(BackingStoreConfiguration<K, V> bsc) throws BackingStoreException {\n-        return new HazelcastBackingStore<K, V>(this, bsc.getStoreName(), core);\n+        return new HazelcastBackingStore<K, V>(this, bsc.getStoreName(), clusteredStore);", "originalCommit": "7a84767d6d1414fa5306fd394fb6d51d878804f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "969f3cff70a0bf27ad98ff698fa6723bbc7350dc", "changed_code": [{"header": "diff --git a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java\nindex ff1b1e0bf0..e9265194ef 100644\n--- a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java\n+++ b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java\n", "chunk": "@@ -65,7 +65,7 @@ public class HazelcastBackingStoreFactory implements BackingStoreFactory {\n \n     @Override\n     public <K extends Serializable, V extends Serializable> BackingStore<K, V> createBackingStore(BackingStoreConfiguration<K, V> bsc) throws BackingStoreException {\n-        return new HazelcastBackingStore<K, V>(this, bsc.getStoreName(), clusteredStore);\n+        return new HazelcastBackingStore<>(this, bsc.getStoreName(), clusteredStore);\n     }\n \n     @Override\n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java\nindex ff1b1e0bf0..e9265194ef 100644\n--- a/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java\n+++ b/appserver/ha/ha-hazelcast-store/src/main/java/fish/payara/ha/hazelcast/store/HazelcastBackingStoreFactory.java\n", "chunk": "@@ -65,7 +65,7 @@ public class HazelcastBackingStoreFactory implements BackingStoreFactory {\n \n     @Override\n     public <K extends Serializable, V extends Serializable> BackingStore<K, V> createBackingStore(BackingStoreConfiguration<K, V> bsc) throws BackingStoreException {\n-        return new HazelcastBackingStore<K, V>(this, bsc.getStoreName(), clusteredStore);\n+        return new HazelcastBackingStore<>(this, bsc.getStoreName(), clusteredStore);\n     }\n \n     @Override\n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "dbba8a86c0f535c4a1e916714b4834cfd1121733", "committedDate": "2021-04-08 10:55:52 +0530", "message": "FISH-1280 Jakarta EE9: Compile Payara 6 artifact with Jakarta EE namespace"}, {"oid": "3b0086a8ebd1bdf984a1c295862e352fc4249a0d", "committedDate": "2021-06-09 13:19:10 +0530", "message": "FISH-1321 Copyright year update"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ3NDAxMQ==", "url": "https://github.com/payara/Payara/pull/4433#discussion_r368474011", "body": "encryptedBytes is never null as `Files.readAllBytes` never returns null.", "bodyText": "encryptedBytes is never null as Files.readAllBytes never returns null.", "bodyHTML": "<p dir=\"auto\">encryptedBytes is never null as <code>Files.readAllBytes</code> never returns null.</p>", "author": "rdebusscher", "createdAt": "2020-01-20T10:30:18Z", "path": "nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/*\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS HEADER.\n+ *\n+ * Copyright (c) [2020] Payara Foundation and/or its affiliates. All rights reserved.\n+ *\n+ * The contents of this file are subject to the terms of either the GNU\n+ * General Public License Version 2 only (\"GPL\") or the Common Development\n+ * and Distribution License(\"CDDL\") (collectively, the \"License\").  You\n+ * may not use this file except in compliance with the License.  You can\n+ * obtain a copy of the License at\n+ * https://github.com/payara/Payara/blob/master/LICENSE.txt\n+ * See the License for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing the software, include this License Header Notice in each\n+ * file and include the License file at glassfish/legal/LICENSE.txt.\n+ *\n+ * GPL Classpath Exception:\n+ * The Payara Foundation designates this particular file as subject to the \"Classpath\"\n+ * exception as provided by the Payara Foundation in the GPL Version 2 section of the License\n+ * file that accompanied this code.\n+ *\n+ * Modifications:\n+ * If applicable, add the following below the License Header, with the fields\n+ * enclosed by brackets [] replaced by your own identifying information:\n+ * \"Portions Copyright [year] [name of copyright owner]\"\n+ *\n+ * Contributor(s):\n+ * If you wish your version of this file to be governed by only the CDDL or\n+ * only the GPL Version 2, indicate your decision by adding \"[Contributor]\n+ * elects to include this software in this distribution under the [CDDL or GPL\n+ * Version 2] license.\"  If you don't indicate a single choice of license, a\n+ * recipient has the option to distribute your version of this file under\n+ * either the CDDL, the GPL Version 2 or to extend the choice of license to\n+ * its licensees as provided above.  However, if you add GPL Version 2 code\n+ * and therefore, elected the GPL Version 2 license, then the option applies\n+ * only if the new code is made subject to such option by the copyright\n+ * holder.\n+ */\n+package fish.payara.nucleus.hazelcast.encryption;\n+\n+import com.hazelcast.core.HazelcastException;\n+import com.hazelcast.nio.IOUtil;\n+import com.sun.enterprise.security.ssl.impl.MasterPasswordImpl;\n+import fish.payara.nucleus.hazelcast.HazelcastCore;\n+import org.glassfish.api.admin.ServerEnvironment;\n+import org.glassfish.internal.api.Globals;\n+\n+import javax.crypto.BadPaddingException;\n+import javax.crypto.Cipher;\n+import javax.crypto.IllegalBlockSizeException;\n+import javax.crypto.NoSuchPaddingException;\n+import javax.crypto.SecretKey;\n+import javax.crypto.SecretKeyFactory;\n+import javax.crypto.spec.IvParameterSpec;\n+import javax.crypto.spec.PBEKeySpec;\n+import javax.crypto.spec.SecretKeySpec;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.File;\n+import java.io.IOException;\n+import java.io.ObjectOutputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.file.Files;\n+import java.security.AlgorithmParameters;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.InvalidKeyException;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.SecureRandom;\n+import java.security.spec.InvalidKeySpecException;\n+import java.security.spec.InvalidParameterSpecException;\n+import java.util.Random;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+/**\n+ * Class that encodes and decodes symmetric keys.\n+ *\n+ * @author Andrew Pielage <andrew.pielage@payara.fish>\n+ * @author Rudy De Busscher <rudy.de.busscher@payara.fish>\n+ */\n+public class HazelcastSymmetricEncryptor {\n+\n+    private static final String DATAGRID_KEY_FILE = \"datagrid-key\";\n+    private static final String AES_ALGORITHM = \"AES/CBC/PKCS5Padding\";\n+    private static final String PBKDF_ALGORITHM = \"PBKDF2WithHmacSHA1\";\n+    private static final String AES = \"AES\";\n+    private static final int ITERATION_COUNT = 65556;\n+    private static final int KEYSIZE = 256;\n+    private static Random random = new SecureRandom();\n+    private static SecretKey secretKey;\n+\n+    static {\n+        try {\n+            secretKey = readAndDecryptSecretKey();\n+        } catch (Exception exception) {\n+            // Shutting down Payara from the thread we're running in can only be done in fairly brutal ways\n+            Logger.getLogger(HazelcastSymmetricEncryptor.class.getName()).log(Level.SEVERE,\n+                    \"Error starting Hazelcast due to exception reading encryption key\", exception);\n+            Globals.get(HazelcastCore.class).getInstance().shutdown();\n+        }\n+    }\n+\n+    public static byte[] encode(byte[] value) {\n+        // Generate IV.\n+        byte[] saltBytes = new byte[20];\n+        random.nextBytes(saltBytes);\n+\n+        try {\n+            // Encrypting the data\n+            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n+            cipher.init(Cipher.ENCRYPT_MODE, secretKey);\n+            AlgorithmParameters params = cipher.getParameters();\n+            byte[] ivBytes = params.getParameterSpec(IvParameterSpec.class).getIV();\n+            byte[] encryptedTextBytes = cipher.doFinal(value);\n+\n+            // Prepend salt and IV\n+            byte[] buffer = new byte[saltBytes.length + ivBytes.length + encryptedTextBytes.length];\n+            System.arraycopy(saltBytes, 0, buffer, 0, saltBytes.length);\n+            System.arraycopy(ivBytes, 0, buffer, saltBytes.length, ivBytes.length);\n+            System.arraycopy(encryptedTextBytes, 0, buffer, saltBytes.length + ivBytes.length,\n+                    encryptedTextBytes.length);\n+            return buffer;\n+        } catch (NoSuchAlgorithmException | InvalidKeyException | NoSuchPaddingException | IllegalBlockSizeException\n+                | InvalidParameterSpecException | BadPaddingException exception) {\n+            throw new HazelcastException(exception);\n+        }\n+    }\n+\n+    public static byte[] decode(byte[] encryptedTextBytes) {\n+        byte[] decryptedTextBytes;\n+        try {\n+            Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n+            // Strip off the salt and IV\n+            ByteBuffer buffer = ByteBuffer.wrap(encryptedTextBytes);\n+            byte[] saltBytes = new byte[20];\n+            buffer.get(saltBytes, 0, saltBytes.length);\n+            byte[] ivBytes = new byte[cipher.getBlockSize()];\n+            buffer.get(ivBytes, 0, ivBytes.length);\n+            encryptedTextBytes = new byte[buffer.capacity() - saltBytes.length - ivBytes.length];\n+\n+            buffer.get(encryptedTextBytes);\n+            cipher.init(Cipher.DECRYPT_MODE, secretKey, new IvParameterSpec(ivBytes));\n+            decryptedTextBytes = cipher.doFinal(encryptedTextBytes);\n+        } catch (BadPaddingException exception) {\n+            // BadPaddingException -> Wrong key\n+            throw new HazelcastException(\"BadPaddingException caught decoding data, \" +\n+                    \"this can be caused by an incorrect or changed key: \", exception);\n+        } catch (IllegalBlockSizeException | NoSuchAlgorithmException | InvalidAlgorithmParameterException\n+                | InvalidKeyException | NoSuchPaddingException exception) {\n+            throw new HazelcastException(exception);\n+        }\n+\n+        return decryptedTextBytes;\n+    }\n+\n+    private static SecretKey readAndDecryptSecretKey() {\n+        ServerEnvironment serverEnvironment = Globals.getDefaultBaseServiceLocator().getService(ServerEnvironment.class);\n+        char[] masterPassword = Globals.getDefaultBaseServiceLocator().getService(MasterPasswordImpl.class).getMasterPassword();\n+\n+        byte[] encryptedBytes = null;\n+        try {\n+            encryptedBytes = Files.readAllBytes(\n+                    new File(serverEnvironment.getConfigDirPath() + File.separator + DATAGRID_KEY_FILE).toPath());\n+        } catch (IOException ioe) {\n+            Logger.getLogger(HazelcastSymmetricEncryptor.class.getName()).log(Level.SEVERE,\n+                    \"Error reading datagrid key, please check if it's accessible at expected location: \"\n+                            + serverEnvironment.getConfigDirPath() + File.separator + DATAGRID_KEY_FILE);\n+            throw new HazelcastException(\"Error reading encrypted key\", ioe);\n+        }\n+\n+        if (encryptedBytes == null) {", "originalCommit": "7a84767d6d1414fa5306fd394fb6d51d878804f2", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "969f3cff70a0bf27ad98ff698fa6723bbc7350dc", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex 5853244f94..9b6f0d4d2b 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -169,10 +169,6 @@ public class HazelcastSymmetricEncryptor {\n             throw new HazelcastException(\"Error reading encrypted key\", ioe);\n         }\n \n-        if (encryptedBytes == null) {\n-            throw new HazelcastException(\"Encrypted key appears to be null\");\n-        }\n-\n         try {\n             Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n \n", "next_change": null}]}, "revised_code_in_main": {"commit": "23485190728045a71fccc013b87e5837264d412a", "changed_code": [{"header": "diff --git a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\nindex 5853244f94..601978289e 100644\n--- a/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n+++ b/nucleus/payara-modules/hazelcast-bootstrap/src/main/java/fish/payara/nucleus/hazelcast/encryption/HazelcastSymmetricEncryptor.java\n", "chunk": "@@ -169,10 +171,6 @@ public class HazelcastSymmetricEncryptor {\n             throw new HazelcastException(\"Error reading encrypted key\", ioe);\n         }\n \n-        if (encryptedBytes == null) {\n-            throw new HazelcastException(\"Encrypted key appears to be null\");\n-        }\n-\n         try {\n             Cipher cipher = Cipher.getInstance(AES_ALGORITHM);\n \n", "next_change": null}]}, "commits_in_main": [{"oid": "23485190728045a71fccc013b87e5837264d412a", "message": "Merge commit", "committedDate": null}, {"oid": "efb512eabc3f44b343ec9a9885dc4a1b5b78dbef", "committedDate": "2020-12-08 13:43:33 -0600", "message": "Upgrade Payara to Hazelcast 4.1 (#5014)"}]}, {"oid": "969f3cff70a0bf27ad98ff698fa6723bbc7350dc", "url": "https://github.com/payara/Payara/commit/969f3cff70a0bf27ad98ff698fa6723bbc7350dc", "message": "Rdebusscher Review Comments\n\nRemove unnecessary autoboxing and null check, and use diamond operator", "committedDate": "2020-01-21T10:57:06Z", "type": "commit"}, {"oid": "bab2e6b860ca9650da239ece3fc4604e4916ab8c", "url": "https://github.com/payara/Payara/commit/bab2e6b860ca9650da239ece3fc4604e4916ab8c", "message": "APPSERV-41 Add encryption enabled log messages", "committedDate": "2020-01-22T15:28:15Z", "type": "commit"}]}