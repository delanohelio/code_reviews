{"pr_number": 1077, "pr_title": "Simple bypass for servlet spec < 3.x", "pr_author": "SylvainJuge", "pr_createdAt": "2020-03-06T18:32:09Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1077", "timeline": [{"oid": "d7aa309953896fa5bd2aa8086d3514cbd104444c", "url": "https://github.com/elastic/apm-agent-java/commit/d7aa309953896fa5bd2aa8086d3514cbd104444c", "message": "Simple bypass for servlet spec < 3.x", "committedDate": "2020-03-06T18:20:49Z", "type": "commit"}, {"oid": "82143cfdf359846b8658ff34b90d57dc44bb61de", "url": "https://github.com/elastic/apm-agent-java/commit/82143cfdf359846b8658ff34b90d57dc44bb61de", "message": "update changelog", "committedDate": "2020-03-06T18:46:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0Mjc5NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r389342794", "body": "```suggestion\r\n    protected AbstractServletInstrumentation(ElasticApmTracer tracer){\r\n```\r\nProvides a more accurate access and works also if the actual instrumentation is loaded by a different class loader than the one loading this abstract parent", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                AbstractServletInstrumentation(ElasticApmTracer tracer){\n          \n          \n            \n                protected AbstractServletInstrumentation(ElasticApmTracer tracer){\n          \n      \n    \n    \n  \n\nProvides a more accurate access and works also if the actual instrumentation is loaded by a different class loader than the one loading this abstract parent", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    AbstractServletInstrumentation(<span class=\"pl-smi\">ElasticApmTracer</span> tracer){</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k x x-first\">protected</span><span class=\"x x-last\"> </span>AbstractServletInstrumentation(<span class=\"pl-smi\">ElasticApmTracer</span> tracer){</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Provides a more accurate access and works also if the actual instrumentation is loaded by a different class loader than the one loading this abstract parent</p>", "author": "eyalkoren", "createdAt": "2020-03-08T07:22:10Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/AbstractServletInstrumentation.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.bytebuddy.CustomElementMatchers;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+\n+public abstract class AbstractServletInstrumentation extends ElasticApmInstrumentation {\n+\n+    AbstractServletInstrumentation(ElasticApmTracer tracer){", "originalCommit": "82143cfdf359846b8658ff34b90d57dc44bb61de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0Mjk1OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r389342958", "body": "This shouldn't be done here, as it is not required for all subclasses. Adds a non-required dependency between `AsyncInstrumentation` and `ServletApiAdvice`.", "bodyText": "This shouldn't be done here, as it is not required for all subclasses. Adds a non-required dependency between AsyncInstrumentation and ServletApiAdvice.", "bodyHTML": "<p dir=\"auto\">This shouldn't be done here, as it is not required for all subclasses. Adds a non-required dependency between <code>AsyncInstrumentation</code> and <code>ServletApiAdvice</code>.</p>", "author": "eyalkoren", "createdAt": "2020-03-08T07:25:16Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/AbstractServletInstrumentation.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.bytebuddy.CustomElementMatchers;\n+import co.elastic.apm.agent.impl.ElasticApmTracer;\n+import net.bytebuddy.matcher.ElementMatcher;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+\n+public abstract class AbstractServletInstrumentation extends ElasticApmInstrumentation {\n+\n+    AbstractServletInstrumentation(ElasticApmTracer tracer){\n+        ServletApiAdvice.init(tracer);", "originalCommit": "82143cfdf359846b8658ff34b90d57dc44bb61de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc4MjY0OQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r389782649", "bodyText": "fixed in the last commit", "author": "SylvainJuge", "createdAt": "2020-03-09T15:51:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0Mjk1OA=="}], "type": "inlineReview"}, {"oid": "70e9f8ba3acdee51cf815277bf5443055b52695e", "url": "https://github.com/elastic/apm-agent-java/commit/70e9f8ba3acdee51cf815277bf5443055b52695e", "message": "Update apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/AbstractServletInstrumentation.java\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>", "committedDate": "2020-03-09T09:29:04Z", "type": "commit"}, {"oid": "24045fd87b2ee65445d5a93977e4ed44178c5f89", "url": "https://github.com/elastic/apm-agent-java/commit/24045fd87b2ee65445d5a93977e4ed44178c5f89", "message": "post-review changes + attempt to fix on payara", "committedDate": "2020-03-09T15:47:42Z", "type": "commit"}, {"oid": "4205376b0b03a52b95b6aa89f06cd8f8cd3daeb7", "url": "https://github.com/elastic/apm-agent-java/commit/4205376b0b03a52b95b6aa89f06cd8f8cd3daeb7", "message": "warn only once", "committedDate": "2020-03-10T08:35:08Z", "type": "commit"}, {"oid": "6ce246f7c5eb9da67b223b735ad58db97e1f9b36", "url": "https://github.com/elastic/apm-agent-java/commit/6ce246f7c5eb9da67b223b735ad58db97e1f9b36", "message": "Merge branch 'master' into do-not-instrument-old-servlet", "committedDate": "2020-03-10T08:41:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2MzA3OQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390163079", "body": "Also instrument `Servlet#doService`, as all servlets might already be initialized once the agent attaches.", "bodyText": "Also instrument Servlet#doService, as all servlets might already be initialized once the agent attaches.", "bodyHTML": "<p dir=\"auto\">Also instrument <code>Servlet#doService</code>, as all servlets might already be initialized once the agent attaches.</p>", "author": "felixbarny", "createdAt": "2020-03-10T08:45:50Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/ServletInitInstrumentation.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.VisibleForAdvice;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.NamedElement;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import javax.servlet.ServletConfig;\n+import javax.servlet.ServletContext;\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+import static net.bytebuddy.matcher.ElementMatchers.hasSuperType;\n+import static net.bytebuddy.matcher.ElementMatchers.isInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContains;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContainsIgnoreCase;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * Instruments {@link javax.servlet.Servlet#init(ServletConfig)} to provide a warning when an unsupported Servlet version is used", "originalCommit": "6ce246f7c5eb9da67b223b735ad58db97e1f9b36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDIxODY1OA==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390218658", "bodyText": "done in the last commit", "author": "SylvainJuge", "createdAt": "2020-03-10T10:26:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2MzA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2MzU4Nw==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390163587", "body": "As we're ok with logging twice, it's fine to make this non-volatile\r\n```suggestion\r\n    public static boolean doCheckAndWarn = true;\r\n```", "bodyText": "As we're ok with logging twice, it's fine to make this non-volatile\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static volatile boolean doCheckAndWarn = true;\n          \n          \n            \n                public static boolean doCheckAndWarn = true;", "bodyHTML": "<p dir=\"auto\">As we're ok with logging twice, it's fine to make this non-volatile</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k x x-first\">volatile</span><span class=\"x x-last\"> </span><span class=\"pl-k\">boolean</span> doCheckAndWarn <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">boolean</span> doCheckAndWarn <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "felixbarny", "createdAt": "2020-03-10T08:46:55Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/ServletInitInstrumentation.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.VisibleForAdvice;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.NamedElement;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import javax.servlet.ServletConfig;\n+import javax.servlet.ServletContext;\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+import static net.bytebuddy.matcher.ElementMatchers.hasSuperType;\n+import static net.bytebuddy.matcher.ElementMatchers.isInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContains;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContainsIgnoreCase;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * Instruments {@link javax.servlet.Servlet#init(ServletConfig)} to provide a warning when an unsupported Servlet version is used\n+ */\n+public class ServletInitInstrumentation extends ElasticApmInstrumentation {\n+\n+    @VisibleForAdvice\n+    public static final Logger logger = LoggerFactory.getLogger(ServletTransactionHelper.class);\n+\n+    /**\n+     * Allows to perform check only once with loose concurrency requirements. Thus there might be multiple warning\n+     * messages, but most of the time there won't.\n+     */\n+    @VisibleForAdvice\n+    public static volatile boolean doCheckAndWarn = true;", "originalCommit": "6ce246f7c5eb9da67b223b735ad58db97e1f9b36", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2Njk0NA==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390166944", "body": "```suggestion\r\ndoCheckAndWarn = false;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            doCheckAndWarn = false;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"x x-first\">doCheckAndWarn </span><span class=\"pl-k x\">=</span><span class=\"x\"> </span><span class=\"pl-c1 x\">false</span><span class=\"x x-last\">;</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "felixbarny", "createdAt": "2020-03-10T08:53:31Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/ServletInitInstrumentation.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.VisibleForAdvice;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.NamedElement;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import javax.servlet.ServletConfig;\n+import javax.servlet.ServletContext;\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+import static net.bytebuddy.matcher.ElementMatchers.hasSuperType;\n+import static net.bytebuddy.matcher.ElementMatchers.isInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContains;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContainsIgnoreCase;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * Instruments {@link javax.servlet.Servlet#init(ServletConfig)} to provide a warning when an unsupported Servlet version is used\n+ */\n+public class ServletInitInstrumentation extends ElasticApmInstrumentation {\n+\n+    @VisibleForAdvice\n+    public static final Logger logger = LoggerFactory.getLogger(ServletTransactionHelper.class);\n+\n+    /**\n+     * Allows to perform check only once with loose concurrency requirements. Thus there might be multiple warning\n+     * messages, but most of the time there won't.\n+     */\n+    @VisibleForAdvice\n+    public static volatile boolean doCheckAndWarn = true;\n+\n+    @Override\n+    public ElementMatcher<? super NamedElement> getTypeMatcherPreFilter() {\n+        return nameContains(\"Servlet\").or(nameContainsIgnoreCase(\"jsp\"));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return not(isInterface())\n+            .and(hasSuperType(named(\"javax.servlet.Servlet\")));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+        return named(\"init\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletConfig\")));\n+    }\n+\n+    @Override\n+    public Collection<String> getInstrumentationGroupNames() {\n+        return Collections.singleton(SERVLET_API);\n+    }\n+\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    private static void onEnter(@Advice.Argument(0) @Nullable ServletConfig servletConfig) {\n+\n+        if (!doCheckAndWarn) {\n+            return;\n+        }\n+", "originalCommit": "6ce246f7c5eb9da67b223b735ad58db97e1f9b36", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2NzEzOA==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390167138", "body": "```suggestion\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doCheckAndWarn = false;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">        doCheckAndWarn </span><span class=\"pl-k x\">=</span><span class=\"x\"> </span><span class=\"pl-c1 x\">false</span><span class=\"x x-last\">;</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "felixbarny", "createdAt": "2020-03-10T08:53:51Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/ServletInitInstrumentation.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.VisibleForAdvice;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.NamedElement;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import javax.servlet.ServletConfig;\n+import javax.servlet.ServletContext;\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+import static net.bytebuddy.matcher.ElementMatchers.hasSuperType;\n+import static net.bytebuddy.matcher.ElementMatchers.isInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContains;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContainsIgnoreCase;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * Instruments {@link javax.servlet.Servlet#init(ServletConfig)} to provide a warning when an unsupported Servlet version is used\n+ */\n+public class ServletInitInstrumentation extends ElasticApmInstrumentation {\n+\n+    @VisibleForAdvice\n+    public static final Logger logger = LoggerFactory.getLogger(ServletTransactionHelper.class);\n+\n+    /**\n+     * Allows to perform check only once with loose concurrency requirements. Thus there might be multiple warning\n+     * messages, but most of the time there won't.\n+     */\n+    @VisibleForAdvice\n+    public static volatile boolean doCheckAndWarn = true;\n+\n+    @Override\n+    public ElementMatcher<? super NamedElement> getTypeMatcherPreFilter() {\n+        return nameContains(\"Servlet\").or(nameContainsIgnoreCase(\"jsp\"));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return not(isInterface())\n+            .and(hasSuperType(named(\"javax.servlet.Servlet\")));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+        return named(\"init\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletConfig\")));\n+    }\n+\n+    @Override\n+    public Collection<String> getInstrumentationGroupNames() {\n+        return Collections.singleton(SERVLET_API);\n+    }\n+\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    private static void onEnter(@Advice.Argument(0) @Nullable ServletConfig servletConfig) {\n+\n+        if (!doCheckAndWarn) {\n+            return;\n+        }\n+\n+        int majorVersion = -1;\n+        int minorVersion = -1;\n+        if (servletConfig != null) {\n+            ServletContext servletContext = servletConfig.getServletContext();\n+            if (null != servletContext) {\n+                majorVersion = servletContext.getMajorVersion();\n+                minorVersion = servletContext.getMinorVersion();\n+            }\n+        }\n+\n+        if (majorVersion < 3) {\n+            logger.warn(\"Unsupported servlet version detected: {}.{}, no Servlet transaction will be created\", majorVersion, minorVersion);\n+        }\n+\n+        doCheckAndWarn = false;", "originalCommit": "6ce246f7c5eb9da67b223b735ad58db97e1f9b36", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDE2ODM0Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390168342", "body": "Kill two birds with one stone and also log the servlet info. That will be really useful to avoid back-and-forth in support requests.\r\n\r\n```java\r\nlogger.info(servletConfig.getServletContext().getServerInfo());\r\n```", "bodyText": "Kill two birds with one stone and also log the servlet info. That will be really useful to avoid back-and-forth in support requests.\nlogger.info(servletConfig.getServletContext().getServerInfo());", "bodyHTML": "<p dir=\"auto\">Kill two birds with one stone and also log the servlet info. That will be really useful to avoid back-and-forth in support requests.</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"logger.info(servletConfig.getServletContext().getServerInfo());\n\"><pre>logger<span class=\"pl-k\">.</span>info(servletConfig<span class=\"pl-k\">.</span>getServletContext()<span class=\"pl-k\">.</span>getServerInfo());</pre></div>", "author": "felixbarny", "createdAt": "2020-03-10T08:56:04Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/ServletInitInstrumentation.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.VisibleForAdvice;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.NamedElement;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import javax.servlet.ServletConfig;\n+import javax.servlet.ServletContext;\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+import static net.bytebuddy.matcher.ElementMatchers.hasSuperType;\n+import static net.bytebuddy.matcher.ElementMatchers.isInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContains;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContainsIgnoreCase;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * Instruments {@link javax.servlet.Servlet#init(ServletConfig)} to provide a warning when an unsupported Servlet version is used\n+ */\n+public class ServletInitInstrumentation extends ElasticApmInstrumentation {\n+\n+    @VisibleForAdvice\n+    public static final Logger logger = LoggerFactory.getLogger(ServletTransactionHelper.class);\n+\n+    /**\n+     * Allows to perform check only once with loose concurrency requirements. Thus there might be multiple warning\n+     * messages, but most of the time there won't.\n+     */\n+    @VisibleForAdvice\n+    public static volatile boolean doCheckAndWarn = true;\n+\n+    @Override\n+    public ElementMatcher<? super NamedElement> getTypeMatcherPreFilter() {\n+        return nameContains(\"Servlet\").or(nameContainsIgnoreCase(\"jsp\"));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return not(isInterface())\n+            .and(hasSuperType(named(\"javax.servlet.Servlet\")));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+        return named(\"init\")\n+            .and(takesArgument(0, named(\"javax.servlet.ServletConfig\")));\n+    }\n+\n+    @Override\n+    public Collection<String> getInstrumentationGroupNames() {\n+        return Collections.singleton(SERVLET_API);\n+    }\n+\n+    @Advice.OnMethodEnter(suppress = Throwable.class)\n+    private static void onEnter(@Advice.Argument(0) @Nullable ServletConfig servletConfig) {\n+\n+        if (!doCheckAndWarn) {\n+            return;\n+        }\n+\n+        int majorVersion = -1;\n+        int minorVersion = -1;\n+        if (servletConfig != null) {\n+            ServletContext servletContext = servletConfig.getServletContext();\n+            if (null != servletContext) {\n+                majorVersion = servletContext.getMajorVersion();\n+                minorVersion = servletContext.getMinorVersion();\n+            }\n+        }\n+", "originalCommit": "6ce246f7c5eb9da67b223b735ad58db97e1f9b36", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "90b42c6ea1186647de946b2b101e6e875ad7af28", "url": "https://github.com/elastic/apm-agent-java/commit/90b42c6ea1186647de946b2b101e6e875ad7af28", "message": "use atomic boolean + instrument service method", "committedDate": "2020-03-10T10:13:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI0MjY4Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390242682", "body": "To avoid a CAS on every invocation\r\n```suggestion\r\n            if (!doLogAndWarn.get() || !doLogAndWarn.getAndSet(false)) {\r\n```\r\n\r\nmaybe rename `doLogAndWarn` to `alreadyLogged` to get rid of the negations which are a bit harder to parse?", "bodyText": "To avoid a CAS on every invocation\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (!doLogAndWarn.getAndSet(false)) {\n          \n          \n            \n                        if (!doLogAndWarn.get() || !doLogAndWarn.getAndSet(false)) {\n          \n      \n    \n    \n  \n\nmaybe rename doLogAndWarn to alreadyLogged to get rid of the negations which are a bit harder to parse?", "bodyHTML": "<p dir=\"auto\">To avoid a CAS on every invocation</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>doLogAndWarn<span class=\"pl-k\">.</span>getAndSet(<span class=\"pl-c1\">false</span>)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (<span class=\"pl-k\">!</span>doLogAndWarn<span class=\"pl-k\">.</span><span class=\"x x-first\">get() </span><span class=\"pl-k x\">||</span><span class=\"x\"> </span><span class=\"pl-k x\">!</span><span class=\"x\">doLogAndWarn</span><span class=\"pl-k x x-last\">.</span>getAndSet(<span class=\"pl-c1\">false</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">maybe rename <code>doLogAndWarn</code> to <code>alreadyLogged</code> to get rid of the negations which are a bit harder to parse?</p>", "author": "felixbarny", "createdAt": "2020-03-10T11:12:21Z", "path": "apm-agent-plugins/apm-servlet-plugin/src/main/java/co/elastic/apm/agent/servlet/ServletVersionInstrumentation.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*-\n+ * #%L\n+ * Elastic APM Java agent\n+ * %%\n+ * Copyright (C) 2018 - 2020 Elastic and contributors\n+ * %%\n+ * Licensed to Elasticsearch B.V. under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch B.V. licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ * #L%\n+ */\n+package co.elastic.apm.agent.servlet;\n+\n+import co.elastic.apm.agent.bci.ElasticApmInstrumentation;\n+import co.elastic.apm.agent.bci.VisibleForAdvice;\n+import net.bytebuddy.asm.Advice;\n+import net.bytebuddy.description.NamedElement;\n+import net.bytebuddy.description.method.MethodDescription;\n+import net.bytebuddy.description.type.TypeDescription;\n+import net.bytebuddy.matcher.ElementMatcher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.annotation.Nullable;\n+import javax.servlet.Servlet;\n+import javax.servlet.ServletConfig;\n+import javax.servlet.ServletContext;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static co.elastic.apm.agent.servlet.ServletInstrumentation.SERVLET_API;\n+import static net.bytebuddy.matcher.ElementMatchers.hasSuperType;\n+import static net.bytebuddy.matcher.ElementMatchers.isInterface;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContains;\n+import static net.bytebuddy.matcher.ElementMatchers.nameContainsIgnoreCase;\n+import static net.bytebuddy.matcher.ElementMatchers.named;\n+import static net.bytebuddy.matcher.ElementMatchers.not;\n+import static net.bytebuddy.matcher.ElementMatchers.takesArgument;\n+\n+/**\n+ * Instruments {@link javax.servlet.Servlet} to log Servlet container details and warns about unsupported version.\n+ * <p>\n+ * Does not inherit from {@link AbstractServletInstrumentation} in order to still instrument when servlet version is not\n+ * supported.\n+ */\n+public abstract class ServletVersionInstrumentation extends ElasticApmInstrumentation {\n+\n+    @VisibleForAdvice\n+    public static final Logger logger = LoggerFactory.getLogger(ServletVersionInstrumentation.class);\n+\n+    @VisibleForAdvice\n+    public static AtomicBoolean doLogAndWarn = new AtomicBoolean(true);\n+\n+    @Override\n+    public ElementMatcher<? super NamedElement> getTypeMatcherPreFilter() {\n+        return nameContains(\"Servlet\").or(nameContainsIgnoreCase(\"jsp\"));\n+    }\n+\n+    @Override\n+    public ElementMatcher<? super TypeDescription> getTypeMatcher() {\n+        return not(isInterface())\n+            .and(hasSuperType(named(\"javax.servlet.Servlet\")));\n+    }\n+\n+    @Override\n+    public Collection<String> getInstrumentationGroupNames() {\n+        return Collections.singleton(SERVLET_API);\n+    }\n+\n+    /**\n+     * Instruments {@link javax.servlet.Servlet#init(ServletConfig)}\n+     */\n+    public static class Init extends ServletVersionInstrumentation {\n+\n+        @Override\n+        public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+            return named(\"init\")\n+                .and(takesArgument(0, named(\"javax.servlet.ServletConfig\")));\n+        }\n+\n+        @Advice.OnMethodEnter(suppress = Throwable.class)\n+        @SuppressWarnings(\"Duplicates\") // duplication is fine here as it allows to inline code\n+        private static void onEnter(@Advice.Argument(0) @Nullable ServletConfig servletConfig) {\n+            if (!doLogAndWarn.getAndSet(false)) {\n+                return;\n+            }\n+\n+            int majorVersion = -1;\n+            int minorVersion = -1;\n+            String serverInfo = null;\n+            if (servletConfig != null) {\n+                ServletContext servletContext = servletConfig.getServletContext();\n+                if (null != servletContext) {\n+                    majorVersion = servletContext.getMajorVersion();\n+                    minorVersion = servletContext.getMinorVersion();\n+                    serverInfo = servletContext.getServerInfo();\n+                }\n+            }\n+\n+            logger.info(\"Servlet container info = {}\", serverInfo);\n+            if (majorVersion < 3) {\n+                logger.warn(\"Unsupported servlet version detected: {}.{}, no Servlet transaction will be created\", majorVersion, minorVersion);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Instruments {@link javax.servlet.Servlet#service(ServletRequest, ServletResponse)}\n+     */\n+    public static class Service extends ServletVersionInstrumentation {\n+\n+        @Override\n+        public ElementMatcher<? super MethodDescription> getMethodMatcher() {\n+            return named(\"service\")\n+                .and(takesArgument(0, named(\"javax.servlet.ServletRequest\")))\n+                .and(takesArgument(1, named(\"javax.servlet.ServletResponse\")));\n+        }\n+\n+        @Advice.OnMethodEnter(suppress = Throwable.class)\n+        @SuppressWarnings(\"Duplicates\") // duplication is fine here as it allows to inline code\n+        private static void onEnter(@Advice.This Servlet servlet) {\n+            if (!doLogAndWarn.getAndSet(false)) {", "originalCommit": "90b42c6ea1186647de946b2b101e6e875ad7af28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMyMTg3Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1077#discussion_r390321872", "bodyText": "definitely agree on having less negations, however doing a double check here seems a bit overkill. I think it's fine to replace this AtomicBoolean with a simple volatile boolean as AtomicBoolean.get does makes a volatile read, thus it won't be more efficient.", "author": "SylvainJuge", "createdAt": "2020-03-10T13:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDI0MjY4Mg=="}], "type": "inlineReview"}, {"oid": "016e0d9279f7b85830c28fa87129a279aa1afd4a", "url": "https://github.com/elastic/apm-agent-java/commit/016e0d9279f7b85830c28fa87129a279aa1afd4a", "message": "avoid double negations and use a simple volatile", "committedDate": "2020-03-10T13:45:08Z", "type": "commit"}]}