{"pr_number": 1075, "pr_title": "Disable agent on early Java 8 versions", "pr_author": "SylvainJuge", "pr_createdAt": "2020-03-04T17:28:38Z", "pr_url": "https://github.com/elastic/apm-agent-java/pull/1075", "timeline": [{"oid": "0186deec95fb62574988f1fa1220c69008527182", "url": "https://github.com/elastic/apm-agent-java/commit/0186deec95fb62574988f1fa1220c69008527182", "message": "make java 8 before update 40 not supported", "committedDate": "2020-03-04T16:52:58Z", "type": "commit"}, {"oid": "9164a80689d09140a102e7dab660450c2cb2c983", "url": "https://github.com/elastic/apm-agent-java/commit/9164a80689d09140a102e7dab660450c2cb2c983", "message": "update doc for unsupported early java 8 versions", "committedDate": "2020-03-04T17:13:25Z", "type": "commit"}, {"oid": "68314c96526dd3c4d0c9ed00bcd78d221032fa44", "url": "https://github.com/elastic/apm-agent-java/commit/68314c96526dd3c4d0c9ed00bcd78d221032fa44", "message": "add missing licence in tests", "committedDate": "2020-03-04T17:31:29Z", "type": "commit"}, {"oid": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b", "url": "https://github.com/elastic/apm-agent-java/commit/963eed4280724a0a58c3aa9f1cfa96a87ce3df4b", "message": "update changelog", "committedDate": "2020-03-04T17:33:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyNDIwNQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1075#discussion_r388124205", "body": "One of our Tomcat tests fails due to the version called: `1.8.0_72-internal` \ud83d\ude41 ", "bodyText": "One of our Tomcat tests fails due to the version called: 1.8.0_72-internal \ud83d\ude41", "bodyHTML": "<p dir=\"auto\">One of our Tomcat tests fails due to the version called: <code>1.8.0_72-internal</code> <g-emoji class=\"g-emoji\" alias=\"slightly_frowning_face\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f641.png\">\ud83d\ude41</g-emoji></p>", "author": "eyalkoren", "createdAt": "2020-03-05T07:48:37Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java", "diffHunk": "@@ -90,6 +98,43 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n         }\n     }\n \n+    /**\n+     * Checks if a given version of the JVM is supported by this agent.\n+     * Supports values provided before and after https://openjdk.java.net/jeps/223\n+     *\n+     * @param javaVersion jvm version, from {@code System.getProperty(\"java.version\")}\n+     * @return true if the version is supported, false otherwise\n+     */\n+    // package-protected for testing\n+    static boolean isJavaVersionSupported(String javaVersion) {\n+        boolean postJsr223 = !javaVersion.startsWith(\"1.\");\n+        // new scheme introduced in java 9, thus we can use it as a shortcut\n+        if (postJsr223) {\n+            return true;\n+        }\n+\n+        char major = javaVersion.charAt(2);\n+        if (major < '7') {\n+            // given code is compiled with java 7, this one is unlikely in practice\n+            return false;\n+        } else if (major == '7' || major > '8') {\n+            return true;\n+        } else {\n+            // java 8\n+            int updateIndex = javaVersion.lastIndexOf(\"_\");\n+            if (updateIndex <= 0) {\n+                return false;\n+            } else {\n+                String updateVersion = javaVersion.substring(updateIndex + 1);", "originalCommit": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE0ODY5Mg==", "url": "https://github.com/elastic/apm-agent-java/pull/1075#discussion_r388148692", "bodyText": "fixed in the last commit.", "author": "SylvainJuge", "createdAt": "2020-03-05T08:46:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyNDIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyNTA5Ng==", "url": "https://github.com/elastic/apm-agent-java/pull/1075#discussion_r388125096", "body": "```suggestion\r\n            System.err.println(String.format(\"Failed to start agent - JVM version not supported: %s\", javaVersion));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        System.err.println(String.format(\"Failed ot start agent - JVM version not supported: %s\", javaVersion));\n          \n          \n            \n                        System.err.println(String.format(\"Failed to start agent - JVM version not supported: %s\", javaVersion));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">System</span><span class=\"pl-k\">.</span>err<span class=\"pl-k\">.</span>println(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Failed <span class=\"x x-first x-last\">ot</span> start agent - JVM version not supported: %s<span class=\"pl-pds\">\"</span></span>, javaVersion));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">System</span><span class=\"pl-k\">.</span>err<span class=\"pl-k\">.</span>println(<span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Failed <span class=\"x x-first x-last\">to</span> start agent - JVM version not supported: %s<span class=\"pl-pds\">\"</span></span>, javaVersion));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "eyalkoren", "createdAt": "2020-03-05T07:50:59Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java", "diffHunk": "@@ -72,8 +72,16 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n             // for example, Spring Boot restarts the application in dev mode\n             return;\n         }\n+\n+        String javaVersion = System.getProperty(\"java.version\");\n+        if (!isJavaVersionSupported(javaVersion)) {\n+            // gracefully abort agent startup is better than unexpected failure down the road\n+            System.err.println(String.format(\"Failed ot start agent - JVM version not supported: %s\", javaVersion));", "originalCommit": "963eed4280724a0a58c3aa9f1cfa96a87ce3df4b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "622cc1cc5d7da9046ea85acdff183d5a97784ec9", "url": "https://github.com/elastic/apm-agent-java/commit/622cc1cc5d7da9046ea85acdff183d5a97784ec9", "message": "fix versions with '-xxx' suffix", "committedDate": "2020-03-05T08:14:38Z", "type": "commit"}, {"oid": "3309ef91ec98c63182c19c1bff22f19d01410144", "url": "https://github.com/elastic/apm-agent-java/commit/3309ef91ec98c63182c19c1bff22f19d01410144", "message": "improve a few comments", "committedDate": "2020-03-05T09:10:22Z", "type": "commit"}, {"oid": "bfd9b64878fb7a8285a1f6bedf8c6a8566a6bf07", "url": "https://github.com/elastic/apm-agent-java/commit/bfd9b64878fb7a8285a1f6bedf8c6a8566a6bf07", "message": "limit checks to hotspot for now", "committedDate": "2020-03-05T13:23:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MTQ0NQ==", "url": "https://github.com/elastic/apm-agent-java/pull/1075#discussion_r388291445", "body": "```suggestion\r\n            // HotSpot 8\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // java 8\n          \n          \n            \n                        // HotSpot 8", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">java</span> 8</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">HotSpot</span> 8</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "eyalkoren", "createdAt": "2020-03-05T13:27:58Z", "path": "apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java", "diffHunk": "@@ -99,43 +105,52 @@ public synchronized static void init(String agentArguments, Instrumentation inst\n     }\n \n     /**\n-     * Checks if a given version of the JVM is supported by this agent.\n-     * Supports values provided before and after https://openjdk.java.net/jeps/223\n+     * Checks if a given version of the JVM is likely supported by this agent.\n+     * <br/>\n+     * Supports values provided before and after https://openjdk.java.net/jeps/223, in case parsing fails due to an\n+     * unknown version format, we assume it's supported, thus this method might return false positives, but never false\n+     * negatives.\n      *\n-     * @param javaVersion jvm version, from {@code System.getProperty(\"java.version\")}\n+     * @param version jvm version, from {@code System.getProperty(\"java.version\")}\n+     * @param vmName  jvm name, from {@code System.getProperty(\"java.vm.name\")}\n      * @return true if the version is supported, false otherwise\n      */\n     // package-protected for testing\n-    static boolean isJavaVersionSupported(String javaVersion) {\n-        boolean postJsr223 = !javaVersion.startsWith(\"1.\");\n+    static boolean isJavaVersionSupported(String version, String vmName) {\n+        boolean postJsr223 = !version.startsWith(\"1.\");\n         // new scheme introduced in java 9, thus we can use it as a shortcut\n         if (postJsr223) {\n             return true;\n         }\n \n-        char major = javaVersion.charAt(2);\n+        char major = version.charAt(2);\n         if (major < '7') {\n             // given code is compiled with java 7, this one is unlikely in practice\n             return false;\n         } else if (major == '7' || major > '8') {\n             return true;\n+        } else if (!vmName.contains(\"HotSpot(TM)\")) {\n+            // non-hotspot JVMs are not concerned (yet)\n+            return true;\n         } else {\n             // java 8", "originalCommit": "bfd9b64878fb7a8285a1f6bedf8c6a8566a6bf07", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6a3a7756bb692dcd290b063b7da1fef65ef00a3a", "url": "https://github.com/elastic/apm-agent-java/commit/6a3a7756bb692dcd290b063b7da1fef65ef00a3a", "message": "Update apm-agent-core/src/main/java/co/elastic/apm/agent/bci/AgentMain.java\n\nCo-Authored-By: eyalkoren <41850454+eyalkoren@users.noreply.github.com>", "committedDate": "2020-03-05T14:26:29Z", "type": "commit"}, {"oid": "8e6d891932adaff48eaf4a2ef70f83f0ace064d6", "url": "https://github.com/elastic/apm-agent-java/commit/8e6d891932adaff48eaf4a2ef70f83f0ace064d6", "message": "add sample error message when jvm not supported", "committedDate": "2020-03-05T14:47:00Z", "type": "commit"}]}