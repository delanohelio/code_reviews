{"pr_number": 2691, "pr_title": "Flush logger context for LR on exit", "pr_author": "hisundar", "pr_createdAt": "2020-08-10T18:15:24Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2691", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA5MjA5MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2691#discussion_r468092090", "body": "can we move this to a flushAsyncAppender() function?", "bodyText": "can we move this to a flushAsyncAppender() function?", "bodyHTML": "<p dir=\"auto\">can we move this to a flushAsyncAppender() function?</p>", "author": "annym", "createdAt": "2020-08-10T18:19:30Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuInterClusterReplicationServer.java", "diffHunk": "@@ -271,6 +272,9 @@ private void startServer() {\n         }\n \n         log.info(\"main: Server exiting due to shutdown\");\n+        // Flush the async appender before exiting to prevent the loss of logs", "originalCommit": "fa011a6f95c1bf586d9f8f22509e312fa3bd52bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4MzYwNQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2691#discussion_r468183605", "bodyText": "sure. done", "author": "hisundar", "createdAt": "2020-08-10T21:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA5MjA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA5NjQzOQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2691#discussion_r468096439", "body": "Should we add a check to see if the `activeServer` is null?\r\nIf `startDiscoveryService` throws an exception, activeServer will be null and the shutdown hook hit NPE. Logger flush will be skipped.\r\n\r\nhttps://github.com/CorfuDB/CorfuDB/blob/fa011a6f95c1bf586d9f8f22509e312fa3bd52bf/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuInterClusterReplicationServer.java#L344", "bodyText": "Should we add a check to see if the activeServer is null?\nIf startDiscoveryService throws an exception, activeServer will be null and the shutdown hook hit NPE. Logger flush will be skipped.\n\n  \n    \n      CorfuDB/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuInterClusterReplicationServer.java\n    \n    \n         Line 344\n      in\n      fa011a6\n    \n    \n    \n    \n\n        \n          \n           activeServer.close();", "bodyHTML": "<p dir=\"auto\">Should we add a check to see if the <code>activeServer</code> is null?<br>\nIf <code>startDiscoveryService</code> throws an exception, activeServer will be null and the shutdown hook hit NPE. Logger flush will be skipped.</p>\n<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/CorfuDB/CorfuDB/blob/fa011a6f95c1bf586d9f8f22509e312fa3bd52bf/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuInterClusterReplicationServer.java#L344\">CorfuDB/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuInterClusterReplicationServer.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 344\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/CorfuDB/CorfuDB/commit/fa011a6f95c1bf586d9f8f22509e312fa3bd52bf\">fa011a6</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L344\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"344\"></td>\n          <td id=\"LC344\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> activeServer<span class=\"pl-k\">.</span>close(); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "zhangn49", "createdAt": "2020-08-10T18:27:45Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuInterClusterReplicationServer.java", "diffHunk": "@@ -341,6 +345,9 @@ public void cleanShutdown() {\n         if (replicationDiscoveryService != null) {\n             replicationDiscoveryService.shutdown();\n         }\n+        // Flush the async appender before exiting to prevent the loss of logs", "originalCommit": "fa011a6f95c1bf586d9f8f22509e312fa3bd52bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODE4Mzc1Nw==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2691#discussion_r468183757", "bodyText": "done. thanks", "author": "hisundar", "createdAt": "2020-08-10T21:01:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA5NjQzOQ=="}], "type": "inlineReview"}, {"oid": "36d90493b87a19ec622cfeffb1f9b7170f2cc091", "url": "https://github.com/CorfuDB/CorfuDB/commit/36d90493b87a19ec622cfeffb1f9b7170f2cc091", "message": "Flush logger context for LR on exit\n\n+Add in cleanshutdown too\n+Increase retry attempts in openTable to 9", "committedDate": "2020-08-10T20:12:39Z", "type": "forcePushed"}, {"oid": "b7f56dc6ea745fc0f6e463447ab1bad28c63fc82", "url": "https://github.com/CorfuDB/CorfuDB/commit/b7f56dc6ea745fc0f6e463447ab1bad28c63fc82", "message": "Flush logger context for LR on exit\n\n+Add in cleanshutdown too\n+Increase retry attempts in openTable to 9", "committedDate": "2020-08-10T21:05:58Z", "type": "commit"}, {"oid": "b7f56dc6ea745fc0f6e463447ab1bad28c63fc82", "url": "https://github.com/CorfuDB/CorfuDB/commit/b7f56dc6ea745fc0f6e463447ab1bad28c63fc82", "message": "Flush logger context for LR on exit\n\n+Add in cleanshutdown too\n+Increase retry attempts in openTable to 9", "committedDate": "2020-08-10T21:05:58Z", "type": "forcePushed"}]}