{"pr_number": 2704, "pr_title": "Fix NPE & Shutdown Server for UnrecoverableErrors", "pr_author": "annym", "pr_createdAt": "2020-08-12T04:24:43Z", "pr_url": "https://github.com/CorfuDB/CorfuDB/pull/2704", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNTM2MA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469005360", "body": "A little confused, If a new topology is not valid, we don't update the localClusterDescriptor, right? How we hit this NPE?\r\n\r\nIf the localClusterDescriptor is always null, how does the log replication start?... It should hit NPE here.\r\nhttps://github.com/CorfuDB/CorfuDB/blob/8fc1b8b4671c8783462330247c65ceebfa9bef07/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java#L414\r\n", "bodyText": "A little confused, If a new topology is not valid, we don't update the localClusterDescriptor, right? How we hit this NPE?\nIf the localClusterDescriptor is always null, how does the log replication start?... It should hit NPE here.\n\n  \n    \n      CorfuDB/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java\n    \n    \n         Line 414\n      in\n      8fc1b8b\n    \n    \n    \n    \n\n        \n          \n           switch (localClusterDescriptor.getRole()) {", "bodyHTML": "<p dir=\"auto\">A little confused, If a new topology is not valid, we don't update the localClusterDescriptor, right? How we hit this NPE?</p>\n<p dir=\"auto\">If the localClusterDescriptor is always null, how does the log replication start?... It should hit NPE here.<br>\n<div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/CorfuDB/CorfuDB/blob/8fc1b8b4671c8783462330247c65ceebfa9bef07/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java#L414\">CorfuDB/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n         Line 414\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/CorfuDB/CorfuDB/commit/8fc1b8b4671c8783462330247c65ceebfa9bef07\">8fc1b8b</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L414\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"414\"></td>\n          <td id=\"LC414\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">switch</span> (localClusterDescriptor<span class=\"pl-k\">.</span>getRole()) { </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>", "author": "zhangn49", "createdAt": "2020-08-12T04:58:22Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -463,7 +465,7 @@ private void fetchTopologyFromClusterManager() {\n      * Stop Log Replication\n      */\n     private void stopLogReplication() {\n-        if (localClusterDescriptor.getRole() == ClusterRole.ACTIVE && isLeader.get()) {\n+        if (localClusterDescriptor != null && localClusterDescriptor.getRole() == ClusterRole.ACTIVE && isLeader.get()) {", "originalCommit": "291afa64ff6dbb024c89962d05a1959c5600dcb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNzg5NA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469007894", "bodyText": "Yes,  we don't update the localClusterDescriptor and this is called from:\n\n  \n    \n      CorfuDB/infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java\n    \n    \n         Line 579\n      in\n      8fc1b8b\n    \n    \n    \n    \n\n        \n          \n           stopLogReplication(); \n        \n    \n  \n\n\nAt this point we haven't started LR, we wouldn't even be able to acquire the lock because we are still not recognized as part of any cluster...We just. get topology updates from SM, where we don't show up as part of any active or standby cluster...", "author": "annym", "createdAt": "2020-08-12T05:08:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNTM2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNjk3OA==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469006978", "body": "dint we want to make this trace?", "bodyText": "dint we want to make this trace?", "bodyHTML": "<p dir=\"auto\">dint we want to make this trace?</p>", "author": "pankti-m", "createdAt": "2020-08-12T05:04:53Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/LogReplicationServer.java", "diffHunk": "@@ -123,9 +123,10 @@ private void handleLogReplicationNegotiationRequest(CorfuMsg msg, ChannelHandler\n \n     @ServerHandler(type = CorfuMsgType.LOG_REPLICATION_QUERY_LEADERSHIP)\n     private void handleLogReplicationQueryLeadership(CorfuMsg msg, ChannelHandlerContext ctx, IServerRouter r) {\n-        log.info(\"Log Replication Query Leadership Request received by Server.\");\n+        log.debug(\"Log Replication Query Leadership Request received by Server.\");", "originalCommit": "291afa64ff6dbb024c89962d05a1959c5600dcb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMzEwMg==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469013102", "bodyText": "yes, but eventually when the product is a bit more stable. We said to leave it while we're still in early testing stage. But definitely something to downgrade to trace afterwards.", "author": "annym", "createdAt": "2020-08-12T05:28:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNjk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNzg2NQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469007865", "body": "is it a good idea to add a todo for revisiting these exceptions handling which we discussed today?", "bodyText": "is it a good idea to add a todo for revisiting these exceptions handling which we discussed today?", "bodyHTML": "<p dir=\"auto\">is it a good idea to add a todo for revisiting these exceptions handling which we discussed today?</p>", "author": "pankti-m", "createdAt": "2020-08-12T05:08:28Z", "path": "infrastructure/src/main/java/org/corfudb/infrastructure/logreplication/infrastructure/CorfuReplicationDiscoveryService.java", "diffHunk": "@@ -188,11 +188,13 @@ public void run() {\n                 }\n             }\n         } catch (Exception e) {\n-            log.error(\"Unhandled exception caught during log replication service discovery. Retry,\", e);\n+            log.error(\"Unhandled exception caught during log replication service discovery.\", e);", "originalCommit": "291afa64ff6dbb024c89962d05a1959c5600dcb9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMzE3MQ==", "url": "https://github.com/CorfuDB/CorfuDB/pull/2704#discussion_r469013171", "bodyText": "definitely, so we don't forget it. Let me add it.", "author": "annym", "createdAt": "2020-08-12T05:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAwNzg2NQ=="}], "type": "inlineReview"}, {"oid": "5797463b3ef310a976ebeee6706957aeb07113e5", "url": "https://github.com/CorfuDB/CorfuDB/commit/5797463b3ef310a976ebeee6706957aeb07113e5", "message": "Fix NPE & Shutdown Server for UnrecoverableErrors", "committedDate": "2020-08-12T05:32:37Z", "type": "commit"}, {"oid": "5797463b3ef310a976ebeee6706957aeb07113e5", "url": "https://github.com/CorfuDB/CorfuDB/commit/5797463b3ef310a976ebeee6706957aeb07113e5", "message": "Fix NPE & Shutdown Server for UnrecoverableErrors", "committedDate": "2020-08-12T05:32:37Z", "type": "forcePushed"}]}