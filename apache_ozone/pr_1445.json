{"pr_number": 1445, "pr_title": "HDDS-4272. Volume namespace: add usedNamespace and update it when create and delete bucket", "pr_author": "amaliujia", "pr_createdAt": "2020-09-24T04:28:34Z", "pr_url": "https://github.com/apache/ozone/pull/1445", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA5NTYzNg==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494095636", "body": "How about we update the comment of this constructor by add `@param usedNamespace - volume quota usage in counts`\r\n\r\nThe description of the parameter is IMHO, feel free to correct it if you have an idea. \r\n ", "bodyText": "How about we update the comment of this constructor by add @param usedNamespace - volume quota usage in counts\nThe description of the parameter is IMHO, feel free to correct it if you have an idea.", "bodyHTML": "<p dir=\"auto\">How about we update the comment of this constructor by add <code>@param usedNamespace - volume quota usage in counts</code></p>\n<p dir=\"auto\">The description of the parameter is IMHO, feel free to correct it if you have an idea.</p>", "author": "cxorm", "createdAt": "2020-09-24T07:27:27Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -68,15 +69,16 @@\n       \"builder.\"})\n   private OmVolumeArgs(String adminName, String ownerName, String volume,\n       long quotaInBytes, long quotaInCounts, Map<String, String> metadata,\n-      long usedBytes, OmOzoneAclMap aclMap, long creationTime,\n-      long modificationTime, long objectID, long updateID) {\n+      long usedBytes, long usedNamespace, OmOzoneAclMap aclMap,\n+      long creationTime, long modificationTime, long objectID, long updateID) {", "originalCommit": "964463dfcb39a29e90639ae7300f992d7b2c6513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NjI3Ng==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494576276", "bodyText": "I see. @param usedNamespace and updated both description of @param usedNamespace  and @param usedBytes", "author": "amaliujia", "createdAt": "2020-09-24T19:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA5NTYzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA5OTI2OQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494099269", "body": "```suggestion\r\n      omClientResponse = new OMBucketCreateResponse(omResponse.build(),\r\n          omBucketInfo, omVolumeArgs);\r\n```\r\nIt's my nit : could we use less indent here to keep consistent with this file", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  omClientResponse = new OMBucketCreateResponse(omResponse.build(),\n          \n          \n            \n                      omBucketInfo);\n          \n          \n            \n                          omBucketInfo, omVolumeArgs);\n          \n          \n            \n                  omClientResponse = new OMBucketCreateResponse(omResponse.build(),\n          \n          \n            \n                      omBucketInfo, omVolumeArgs);\n          \n      \n    \n    \n  \n\nIt's my nit : could we use less indent here to keep consistent with this file", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      omClientResponse <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">OMBucketCreateResponse</span>(omResponse<span class=\"pl-k\">.</span>build(),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">          omBucketInfo);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">              omBucketInfo, omVolumeArgs);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      omClientResponse <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">OMBucketCreateResponse</span>(omResponse<span class=\"pl-k\">.</span>build(),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          omBucketInfo, omVolumeArgs);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">It's my nit : could we use less indent here to keep consistent with this file</p>", "author": "cxorm", "createdAt": "2020-09-24T07:33:48Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -209,7 +211,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       omResponse.setCreateBucketResponse(\n           CreateBucketResponse.newBuilder().build());\n       omClientResponse = new OMBucketCreateResponse(omResponse.build(),\n-          omBucketInfo);\n+              omBucketInfo, omVolumeArgs);", "originalCommit": "964463dfcb39a29e90639ae7300f992d7b2c6513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NTk3OQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494575979", "bodyText": "+1", "author": "amaliujia", "createdAt": "2020-09-24T19:58:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA5OTI2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2MTAwMg==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494161002", "body": "Seems we don't use this variable, \r\nCould you be so kind as to let me know its usage if I miss something.", "bodyText": "Seems we don't use this variable,\nCould you be so kind as to let me know its usage if I miss something.", "bodyHTML": "<p dir=\"auto\">Seems we don't use this variable,<br>\nCould you be so kind as to let me know its usage if I miss something.</p>", "author": "cxorm", "createdAt": "2020-09-24T09:12:06Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -270,6 +270,7 @@ private OzoneConsts() {\n   public static final String SRC_KEY = \"srcKey\";\n   public static final String DST_KEY = \"dstKey\";\n   public static final String USED_BYTES = \"usedBytes\";\n+  public static final String USED_NAMESPACE = \"usedNamespace\";", "originalCommit": "964463dfcb39a29e90639ae7300f992d7b2c6513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NTkzMA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494575930", "bodyText": "Indeed it is not used. Removed this constant and we can add it in the future when there is a need.", "author": "amaliujia", "createdAt": "2020-09-24T19:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2MTAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2MjI4Nw==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494162287", "body": "```suggestion\r\n          omMetadataManager.getVolumeKey(omVolumeArgs.getVolume()),\r\n          omVolumeArgs);\r\n```\r\nJust nits.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          omMetadataManager.getVolumeKey(omVolumeArgs.getVolume()),\n          \n          \n            \n                          omVolumeArgs);\n          \n          \n            \n                      omMetadataManager.getVolumeKey(omVolumeArgs.getVolume()),\n          \n          \n            \n                      omVolumeArgs);\n          \n      \n    \n    \n  \n\nJust nits.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"83\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">          <span class=\"x x-first x-last\">    </span>omMetadataManager<span class=\"pl-k\">.</span>getVolumeKey(omVolumeArgs<span class=\"pl-k\">.</span>getVolume()),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"84\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">          <span class=\"x x-first x-last\">    </span>omVolumeArgs);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"83\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          omMetadataManager<span class=\"pl-k\">.</span>getVolumeKey(omVolumeArgs<span class=\"pl-k\">.</span>getVolume()),</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"84\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">          omVolumeArgs);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">Just nits.</p>", "author": "cxorm", "createdAt": "2020-09-24T09:14:16Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/bucket/OMBucketCreateResponse.java", "diffHunk": "@@ -66,6 +77,12 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n             omBucketInfo.getBucketName());\n     omMetadataManager.getBucketTable().putWithBatch(batchOperation,\n         dbBucketKey, omBucketInfo);\n+    // update volume usedNamespace\n+    if (omVolumeArgs != null) {\n+      omMetadataManager.getVolumeTable().putWithBatch(batchOperation,\n+              omMetadataManager.getVolumeKey(omVolumeArgs.getVolume()),\n+              omVolumeArgs);", "originalCommit": "964463dfcb39a29e90639ae7300f992d7b2c6513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NTcyNg==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494575726", "bodyText": "makes sense \ud83d\udc4d", "author": "amaliujia", "createdAt": "2020-09-24T19:57:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE2MjI4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE3MTM2Mw==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494171363", "body": "How about we update it this to `add quota of used namespace` or the same as `update used namespace for volume` in `OMBucketDeleteRequest`  ?", "bodyText": "How about we update it this to add quota of used namespace or the same as update used namespace for volume in OMBucketDeleteRequest  ?", "bodyHTML": "<p dir=\"auto\">How about we update it this to <code>add quota of used namespace</code> or the same as <code>update used namespace for volume</code> in <code>OMBucketDeleteRequest</code>  ?</p>", "author": "cxorm", "createdAt": "2020-09-24T09:29:04Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -201,6 +201,8 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       // Add default acls from volume.\n       addDefaultAcls(omBucketInfo, omVolumeArgs);\n \n+      // quotaAdd used namespace", "originalCommit": "964463dfcb39a29e90639ae7300f992d7b2c6513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU3NTY1NA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494575654", "bodyText": "used update used namespace for volume for both now.", "author": "amaliujia", "createdAt": "2020-09-24T19:57:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE3MTM2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDE3NDIzMA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494174230", "body": "```suggestion\r\n      // update used namespace for volume\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // update used namespace for volumn\n          \n          \n            \n                  // update used namespace for volume", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> update used namespace for <span class=\"x x-first x-last\">volumn</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> update used namespace for <span class=\"x x-first x-last\">volume</span></span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-24T09:33:45Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketDeleteRequest.java", "diffHunk": "@@ -134,6 +135,12 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       omResponse.setDeleteBucketResponse(\n           DeleteBucketResponse.newBuilder().build());\n \n+      // update used namespace for volumn", "originalCommit": "964463dfcb39a29e90639ae7300f992d7b2c6513", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI5NzAxOA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r494297018", "body": "indent", "bodyText": "indent", "bodyHTML": "<p dir=\"auto\">indent</p>", "author": "captainzmc", "createdAt": "2020-09-24T13:00:39Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/bucket/OMBucketDeleteResponse.java", "diffHunk": "@@ -64,6 +76,12 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n         omMetadataManager.getBucketKey(volumeName, bucketName);\n     omMetadataManager.getBucketTable().deleteWithBatch(batchOperation,\n         dbBucketKey);\n+    // update volume usedNamespace\n+    if (omVolumeArgs != null) {\n+      omMetadataManager.getVolumeTable().putWithBatch(batchOperation,\n+              omMetadataManager.getVolumeKey(omVolumeArgs.getVolume()),\n+              omVolumeArgs);", "originalCommit": "964463dfcb39a29e90639ae7300f992d7b2c6513", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "url": "https://github.com/apache/ozone/commit/f28ad7892f97a1f1d04c443b05340c5721d25c48", "message": "HDDS-4272. Volume namespace: add usedNamesapce and update it when create and delete bucket", "committedDate": "2020-12-11T04:44:01Z", "type": "commit"}, {"oid": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "url": "https://github.com/apache/ozone/commit/f28ad7892f97a1f1d04c443b05340c5721d25c48", "message": "HDDS-4272. Volume namespace: add usedNamesapce and update it when create and delete bucket", "committedDate": "2020-12-11T04:44:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDcyOTkyOA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r540729928", "body": "indent", "bodyText": "indent", "bodyHTML": "<p dir=\"auto\">indent</p>", "author": "captainzmc", "createdAt": "2020-12-11T06:55:00Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketDeleteRequest.java", "diffHunk": "@@ -134,9 +135,15 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       omResponse.setDeleteBucketResponse(\n           DeleteBucketResponse.newBuilder().build());\n \n+      // update used namespace for volume\n+      String volumeKey = omMetadataManager.getVolumeKey(volumeName);\n+      OmVolumeArgs omVolumeArgs =\n+              omMetadataManager.getVolumeTable().getReadCopy(volumeKey);", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDczMDEwMw==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r540730103", "body": "indent", "bodyText": "indent", "bodyHTML": "<p dir=\"auto\">indent</p>", "author": "captainzmc", "createdAt": "2020-12-11T06:55:34Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -885,6 +885,42 @@ public void testCheckUsedBytesQuota() throws IOException {\n     Assert.assertEquals(3, countException);\n   }\n \n+  @Test\n+  public void testVolumnUsedNamespace() throws IOException {\n+    String volumeName = UUID.randomUUID().toString();\n+    String bucketName = UUID.randomUUID().toString();\n+    OzoneVolume volume = null;\n+\n+    store.createVolume(volumeName);\n+    volume = store.getVolume(volumeName);\n+    // The initial value should be 0\n+    Assert.assertEquals(0L, volume.getUsedNamespace());\n+    volume.createBucket(bucketName);\n+    // Used namespace should be 1\n+    volume = store.getVolume(volumeName);\n+    Assert.assertEquals(1L, volume.getUsedNamespace());\n+\n+    // test linked bucket\n+    String targetVolName = UUID.randomUUID().toString();\n+    store.createVolume(targetVolName);\n+    OzoneVolume volumeWithLinkedBucket = store.getVolume(targetVolName);\n+    String targetBucketName = UUID.randomUUID().toString();\n+    BucketArgs.Builder argsBuilder = new BucketArgs.Builder()\n+            .setStorageType(StorageType.DEFAULT)\n+            .setVersioning(false)\n+            .setSourceVolume(volumeName)\n+            .setSourceBucket(bucketName);", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MDY1Mg==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541040652", "body": "As I see we defined usedBytes corresponding to quotaInBytes, so quotaInCounts  expected to be  quotaInNamespace. This is just my first feeling for this variable name. We could revisit these later in a separate JIRA to make this more understandable.\r\n", "bodyText": "As I see we defined usedBytes corresponding to quotaInBytes, so quotaInCounts  expected to be  quotaInNamespace. This is just my first feeling for this variable name. We could revisit these later in a separate JIRA to make this more understandable.", "bodyHTML": "<p dir=\"auto\">As I see we defined usedBytes corresponding to quotaInBytes, so quotaInCounts  expected to be  quotaInNamespace. This is just my first feeling for this variable name. We could revisit these later in a separate JIRA to make this more understandable.</p>", "author": "linyiqun", "createdAt": "2020-12-11T15:45:41Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -270,6 +270,7 @@ private OzoneConsts() {\n   public static final String SRC_KEY = \"srcKey\";\n   public static final String DST_KEY = \"dstKey\";\n   public static final String USED_BYTES = \"usedBytes\";\n+  public static final String USED_NAMESPACE = \"usedNamespace\";\n   public static final String QUOTA_IN_BYTES = \"quotaInBytes\";\n   public static final String QUOTA_IN_COUNTS = \"quotaInCounts\";", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTI5OTg4NQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541299885", "bodyText": "Yes. quotaInCounts seems not very readable to me as well :) I didn't change it in this PR as it is not relevant.\nCreated https://issues.apache.org/jira/browse/HDDS-4582 to revisit it later.", "author": "amaliujia", "createdAt": "2020-12-11T21:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MDY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzNTc4OQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541335789", "bodyText": "I started to use quotaInNamespace in my new code. HDDS-4582 will be replacing existing quotaInCounts to quotaInNamesapce", "author": "amaliujia", "createdAt": "2020-12-11T21:55:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MDY1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ5Nzk4OA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541497988", "bodyText": "Makes sense to me.", "author": "linyiqun", "createdAt": "2020-12-12T04:28:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MDY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MzYzNQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541043635", "body": "Not fully get this point, why this bucket create way will not increased the namespace quota? Just curious for this.", "bodyText": "Not fully get this point, why this bucket create way will not increased the namespace quota? Just curious for this.", "bodyHTML": "<p dir=\"auto\">Not fully get this point, why this bucket create way will not increased the namespace quota? Just curious for this.</p>", "author": "linyiqun", "createdAt": "2020-12-11T15:50:00Z", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -885,6 +885,42 @@ public void testCheckUsedBytesQuota() throws IOException {\n     Assert.assertEquals(3, countException);\n   }\n \n+  @Test\n+  public void testVolumnUsedNamespace() throws IOException {\n+    String volumeName = UUID.randomUUID().toString();\n+    String bucketName = UUID.randomUUID().toString();\n+    OzoneVolume volume = null;\n+\n+    store.createVolume(volumeName);\n+    volume = store.getVolume(volumeName);\n+    // The initial value should be 0\n+    Assert.assertEquals(0L, volume.getUsedNamespace());\n+    volume.createBucket(bucketName);\n+    // Used namespace should be 1\n+    volume = store.getVolume(volumeName);\n+    Assert.assertEquals(1L, volume.getUsedNamespace());\n+\n+    // test linked bucket\n+    String targetVolName = UUID.randomUUID().toString();\n+    store.createVolume(targetVolName);\n+    OzoneVolume volumeWithLinkedBucket = store.getVolume(targetVolName);\n+    String targetBucketName = UUID.randomUUID().toString();\n+    BucketArgs.Builder argsBuilder = new BucketArgs.Builder()\n+            .setStorageType(StorageType.DEFAULT)\n+            .setVersioning(false)\n+            .setSourceVolume(volumeName)\n+            .setSourceBucket(bucketName);\n+    volumeWithLinkedBucket.createBucket(targetBucketName, argsBuilder.build());\n+    // Used namespace should be 0 because linked bucket does not consume\n+    // namespace quota\n+    Assert.assertEquals(0L, volumeWithLinkedBucket.getUsedNamespace());", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMwMjQwOA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541302408", "bodyText": "@amaliujia , could you add a new UT for bucket link case? Linked bucket should not be counted in the namespace quota.\n\nThis comes from one of the comment above. I consider this is more like a decision that linked bucket should not consume quota. At least linked bucket should not consume space quota. I think to make consistent, do not apply namespace quota also makes sense.", "author": "amaliujia", "createdAt": "2020-12-11T21:19:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MzYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0NDc0MQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541044741", "body": "Can you add an empty check for omVolumeArgs before updating the namespace used?\r\n```java\r\n    if (volumeArgs == null) {\r\n      throw new OMException(\"Volume \" + volume + \" is not found\",\r\n          OMException.ResultCodes.VOLUME_NOT_FOUND);\r\n    }\r\n```", "bodyText": "Can you add an empty check for omVolumeArgs before updating the namespace used?\n    if (volumeArgs == null) {\n      throw new OMException(\"Volume \" + volume + \" is not found\",\n          OMException.ResultCodes.VOLUME_NOT_FOUND);\n    }", "bodyHTML": "<p dir=\"auto\">Can you add an empty check for omVolumeArgs before updating the namespace used?</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    if (volumeArgs == null) {\n      throw new OMException(&quot;Volume &quot; + volume + &quot; is not found&quot;,\n          OMException.ResultCodes.VOLUME_NOT_FOUND);\n    }\n\"><pre>    <span class=\"pl-k\">if</span> (volumeArgs <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span>) {\n      <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">OMException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Volume <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> volume <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span> is not found<span class=\"pl-pds\">\"</span></span>,\n          <span class=\"pl-smi\">OMException</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">ResultCodes</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>VOLUME_NOT_FOUND</span>);\n    }</pre></div>", "author": "linyiqun", "createdAt": "2020-12-11T15:51:31Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketDeleteRequest.java", "diffHunk": "@@ -134,9 +135,15 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       omResponse.setDeleteBucketResponse(\n           DeleteBucketResponse.newBuilder().build());\n \n+      // update used namespace for volume\n+      String volumeKey = omMetadataManager.getVolumeKey(volumeName);\n+      OmVolumeArgs omVolumeArgs =\n+              omMetadataManager.getVolumeTable().getReadCopy(volumeKey);", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0Nzc4NQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541047785", "body": "We should also update the volume table cache like above, as omVolumeArgs be updated.", "bodyText": "We should also update the volume table cache like above, as omVolumeArgs be updated.", "bodyHTML": "<p dir=\"auto\">We should also update the volume table cache like above, as omVolumeArgs be updated.</p>", "author": "linyiqun", "createdAt": "2020-12-11T15:55:59Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -205,14 +205,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       // Add default acls from volume.\n       addDefaultAcls(omBucketInfo, omVolumeArgs);\n \n+      // update used namespace for volume\n+      omVolumeArgs.incrUsedNamespace(1L);\n+\n       // Update table cache.\n       metadataManager.getBucketTable().addCacheEntry(new CacheKey<>(bucketKey),\n           new CacheValue<>(Optional.of(omBucketInfo), transactionLogIndex));\n ", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMwNTE0OQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541305149", "bodyText": "O I see. it make senses.", "author": "amaliujia", "createdAt": "2020-12-11T21:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0Nzc4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0ODM2OA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541048368", "body": "Volume  table cache also need to be updated here as we update table cache in OMBucketCreateRequest.java", "bodyText": "Volume  table cache also need to be updated here as we update table cache in OMBucketCreateRequest.java", "bodyHTML": "<p dir=\"auto\">Volume  table cache also need to be updated here as we update table cache in OMBucketCreateRequest.java</p>", "author": "linyiqun", "createdAt": "2020-12-11T15:56:42Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketDeleteRequest.java", "diffHunk": "@@ -134,9 +135,15 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       omResponse.setDeleteBucketResponse(\n           DeleteBucketResponse.newBuilder().build());\n \n+      // update used namespace for volume\n+      String volumeKey = omMetadataManager.getVolumeKey(volumeName);\n+      OmVolumeArgs omVolumeArgs =\n+              omMetadataManager.getVolumeTable().getReadCopy(volumeKey);\n+      omVolumeArgs.incrUsedNamespace(-1L);\n+", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA1MDgxNQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541050815", "body": "Before this update, we need to do the namespace quota check in checkQuotaBytesValid.", "bodyText": "Before this update, we need to do the namespace quota check in checkQuotaBytesValid.", "bodyHTML": "<p dir=\"auto\">Before this update, we need to do the namespace quota check in checkQuotaBytesValid.</p>", "author": "linyiqun", "createdAt": "2020-12-11T16:00:08Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -205,14 +205,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       // Add default acls from volume.\n       addDefaultAcls(omBucketInfo, omVolumeArgs);\n \n+      // update used namespace for volume\n+      omVolumeArgs.incrUsedNamespace(1L);\n+", "originalCommit": "f28ad7892f97a1f1d04c443b05340c5721d25c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTMzNjU1Nw==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541336557", "bodyText": "Also updated the test to test quota exceed case.", "author": "amaliujia", "createdAt": "2020-12-11T21:56:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA1MDgxNQ=="}], "type": "inlineReview"}, {"oid": "505bf7b840090cba7127b4db6506dbb85a22bddd", "url": "https://github.com/apache/ozone/commit/505bf7b840090cba7127b4db6506dbb85a22bddd", "message": "fixup! comments addressed.", "committedDate": "2020-12-11T21:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ5Njk4MA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541496980", "body": "Can you use omVolumeArgs.getQuotaInCounts() != OzoneConsts.QUOTA_RESET to replace above condition check? That will be the better check in case maybe OzoneConsts.QUOTA_RESET value can be changed to the positive number.", "bodyText": "Can you use omVolumeArgs.getQuotaInCounts() != OzoneConsts.QUOTA_RESET to replace above condition check? That will be the better check in case maybe OzoneConsts.QUOTA_RESET value can be changed to the positive number.", "bodyHTML": "<p dir=\"auto\">Can you use omVolumeArgs.getQuotaInCounts() != OzoneConsts.QUOTA_RESET to replace above condition check? That will be the better check in case maybe OzoneConsts.QUOTA_RESET value can be changed to the positive number.</p>", "author": "linyiqun", "createdAt": "2020-12-12T04:21:18Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketCreateRequest.java", "diffHunk": "@@ -301,6 +309,25 @@ private BucketEncryptionInfoProto getBeinfo(\n     return bekb.build();\n   }\n \n+  /**\n+   * Check namespace quota.\n+   */\n+  private void checkQuotaInNamespace(OmVolumeArgs omVolumeArgs,\n+      long allocatedNamespace) throws IOException {\n+    if (omVolumeArgs.getQuotaInCounts() > OzoneConsts.QUOTA_RESET) {\n+      long usedNamespace = omVolumeArgs.getUsedNamespace();", "originalCommit": "505bf7b840090cba7127b4db6506dbb85a22bddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTUyMzY1OA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541523658", "bodyText": "make senses! Done!", "author": "amaliujia", "createdAt": "2020-12-12T07:29:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ5Njk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ5NzIyOQ==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541497229", "body": "We could directly use volumeKey, don't need to invoke omMetadataManager.getVolumeKey again.", "bodyText": "We could directly use volumeKey, don't need to invoke omMetadataManager.getVolumeKey again.", "bodyHTML": "<p dir=\"auto\">We could directly use volumeKey, don't need to invoke omMetadataManager.getVolumeKey again.</p>", "author": "linyiqun", "createdAt": "2020-12-12T04:22:47Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketDeleteRequest.java", "diffHunk": "@@ -134,9 +135,23 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       omResponse.setDeleteBucketResponse(\n           DeleteBucketResponse.newBuilder().build());\n \n+      // update used namespace for volume\n+      String volumeKey = omMetadataManager.getVolumeKey(volumeName);\n+      OmVolumeArgs omVolumeArgs =\n+          omMetadataManager.getVolumeTable().getReadCopy(volumeKey);\n+      if (omVolumeArgs == null) {\n+        throw new OMException(\"Volume \" + volumeName + \" is not found\",\n+            OMException.ResultCodes.VOLUME_NOT_FOUND);\n+      }\n+      omVolumeArgs.incrUsedNamespace(-1L);\n+      // Update table cache.\n+      omMetadataManager.getVolumeTable().addCacheEntry(\n+          new CacheKey<>(omMetadataManager.getVolumeKey(volumeName)),", "originalCommit": "505bf7b840090cba7127b4db6506dbb85a22bddd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTUyMzcwNA==", "url": "https://github.com/apache/ozone/pull/1445#discussion_r541523704", "bodyText": "O yes :)", "author": "amaliujia", "createdAt": "2020-12-12T07:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ5NzIyOQ=="}], "type": "inlineReview"}, {"oid": "cdfe3ba9a2307ca4c8c6b9d65576bc0e1feedabb", "url": "https://github.com/apache/ozone/commit/cdfe3ba9a2307ca4c8c6b9d65576bc0e1feedabb", "message": "fjxup! address comments", "committedDate": "2020-12-12T07:29:21Z", "type": "commit"}, {"oid": "b8b6e4822903ef6b074a7115d9cdf6bc24cd94af", "url": "https://github.com/apache/ozone/commit/b8b6e4822903ef6b074a7115d9cdf6bc24cd94af", "message": "trigger new CI check", "committedDate": "2020-12-12T19:55:39Z", "type": "commit"}, {"oid": "7268bec38515ea7db1d4cb2c762eeb43e62f9224", "url": "https://github.com/apache/ozone/commit/7268bec38515ea7db1d4cb2c762eeb43e62f9224", "message": "fixup! fix UT", "committedDate": "2020-12-13T00:30:51Z", "type": "commit"}, {"oid": "42d7b3354c0b08fd7f12e5579b5d4a390dffb64e", "url": "https://github.com/apache/ozone/commit/42d7b3354c0b08fd7f12e5579b5d4a390dffb64e", "message": "fixup! fix CI", "committedDate": "2020-12-13T03:02:13Z", "type": "commit"}]}