{"pr_number": 1012, "pr_title": "HDDS-3658. Stop to persist container related pipeline info of each ke\u2026", "pr_author": "ChenSammi", "pr_createdAt": "2020-06-03T02:33:26Z", "pr_url": "https://github.com/apache/ozone/pull/1012", "timeline": [{"oid": "6ce2a9170711e1b46acd839d7c7a68ad66494573", "url": "https://github.com/apache/ozone/commit/6ce2a9170711e1b46acd839d7c7a68ad66494573", "message": "fix checktyle issues", "committedDate": "2020-06-04T02:58:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE4NjAwNw==", "url": "https://github.com/apache/ozone/pull/1012#discussion_r453186007", "body": "OmKeyInfo was changed in #1034 to avoid streams.  `keyLocationVersions` is now converted in a loop:\r\n\r\nhttps://github.com/apache/hadoop-ozone/blob/2af6198686d81daa3ad0513f723118637d2945cf/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java#L388-L391\r\n\r\nThat's where normal/compact protobuf conversion should happen depending on `ignorePipeline` parameter.", "bodyText": "OmKeyInfo was changed in #1034 to avoid streams.  keyLocationVersions is now converted in a loop:\nhttps://github.com/apache/hadoop-ozone/blob/2af6198686d81daa3ad0513f723118637d2945cf/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java#L388-L391\nThat's where normal/compact protobuf conversion should happen depending on ignorePipeline parameter.", "bodyHTML": "<p dir=\"auto\">OmKeyInfo was changed in <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"634282737\" data-permission-text=\"Title is private\" data-url=\"https://github.com/apache/ozone/issues/1034\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/apache/ozone/pull/1034/hovercard\" href=\"https://github.com/apache/ozone/pull/1034\">#1034</a> to avoid streams.  <code>keyLocationVersions</code> is now converted in a loop:</p>\n<p dir=\"auto\"><a href=\"https://github.com/apache/hadoop-ozone/blob/2af6198686d81daa3ad0513f723118637d2945cf/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java#L388-L391\">https://github.com/apache/hadoop-ozone/blob/2af6198686d81daa3ad0513f723118637d2945cf/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java#L388-L391</a></p>\n<p dir=\"auto\">That's where normal/compact protobuf conversion should happen depending on <code>ignorePipeline</code> parameter.</p>", "author": "adoroszlai", "createdAt": "2020-07-11T11:33:07Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -408,6 +421,15 @@ public KeyInfo getProtobuf() {\n     if (encInfo != null) {\n       kb.setFileEncryptionInfo(OMPBHelper.convert(encInfo));\n     }\n+    if (ignorePipeline) {\n+      kb.addAllKeyLocationList(keyLocationVersions.stream()\n+          .map(OmKeyLocationInfoGroup::getCompactProtobuf)\n+          .collect(Collectors.toList()));\n+    } else {\n+      kb.addAllKeyLocationList(keyLocationVersions.stream()\n+          .map(OmKeyLocationInfoGroup::getProtobuf)\n+          .collect(Collectors.toList()));\n+    }", "originalCommit": "c9c72dae5c72053e85cc81f085876585b38f71d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzE4NjM1OA==", "url": "https://github.com/apache/ozone/pull/1012#discussion_r453186358", "body": "Can we avoid duplication by extracting to a helper method that takes `OmKeyLocationInfo` conversion function (`OmKeyLocationInfo::getCompactProtobuf` or `OmKeyLocationInfo::getProtobuf`)?", "bodyText": "Can we avoid duplication by extracting to a helper method that takes OmKeyLocationInfo conversion function (OmKeyLocationInfo::getCompactProtobuf or OmKeyLocationInfo::getProtobuf)?", "bodyHTML": "<p dir=\"auto\">Can we avoid duplication by extracting to a helper method that takes <code>OmKeyLocationInfo</code> conversion function (<code>OmKeyLocationInfo::getCompactProtobuf</code> or <code>OmKeyLocationInfo::getProtobuf</code>)?</p>", "author": "adoroszlai", "createdAt": "2020-07-11T11:38:10Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfoGroup.java", "diffHunk": "@@ -58,11 +58,22 @@ public long getVersion() {\n     return locationList;\n   }\n \n+  public KeyLocationList getCompactProtobuf() {\n+    return KeyLocationList.newBuilder()\n+        .setVersion(version)\n+        .addAllKeyLocations(\n+            locationList.stream().map(\n+                OmKeyLocationInfo::getCompactProtobuf)\n+                .collect(Collectors.toList()))\n+        .build();\n+  }\n+", "originalCommit": "c9c72dae5c72053e85cc81f085876585b38f71d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "047c124965cfe1cd41ddab89282aee650db881af", "url": "https://github.com/apache/ozone/commit/047c124965cfe1cd41ddab89282aee650db881af", "message": "fix checktyle issues", "committedDate": "2020-07-20T12:11:17Z", "type": "forcePushed"}, {"oid": "0295a16825836bb8b8c41c43fa9ba4ec6f2a0411", "url": "https://github.com/apache/ozone/commit/0295a16825836bb8b8c41c43fa9ba4ec6f2a0411", "message": "HDDS-3658. Stop to persist container related pipeline info of each key into OM DB to reduce DB size.", "committedDate": "2020-07-20T12:32:31Z", "type": "forcePushed"}, {"oid": "a0c3b5259bbf6fd7fbb1b71e8cce29fa2e8b8f09", "url": "https://github.com/apache/ozone/commit/a0c3b5259bbf6fd7fbb1b71e8cce29fa2e8b8f09", "message": "HDDS-3658. Stop to persist container related pipeline info of each key into OM DB to reduce DB size.", "committedDate": "2020-07-23T07:28:18Z", "type": "commit"}, {"oid": "a0c3b5259bbf6fd7fbb1b71e8cce29fa2e8b8f09", "url": "https://github.com/apache/ozone/commit/a0c3b5259bbf6fd7fbb1b71e8cce29fa2e8b8f09", "message": "HDDS-3658. Stop to persist container related pipeline info of each key into OM DB to reduce DB size.", "committedDate": "2020-07-23T07:28:18Z", "type": "forcePushed"}, {"oid": "99272b689e6a8c0a1e96b2e2dccc1aad3eb11ca3", "url": "https://github.com/apache/ozone/commit/99272b689e6a8c0a1e96b2e2dccc1aad3eb11ca3", "message": "trigger new CI chck", "committedDate": "2020-07-23T12:14:11Z", "type": "commit"}]}