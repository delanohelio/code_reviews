{"pr_number": 1296, "pr_title": "HDDS-4053. Volume space: add quotaUsageInBytes and update it when write and delete key.", "pr_author": "captainzmc", "pr_createdAt": "2020-08-06T13:41:37Z", "pr_url": "https://github.com/apache/ozone/pull/1296", "timeline": [{"oid": "fe3011b9800194a0bff906188a0832a95bc6bb22", "url": "https://github.com/apache/ozone/commit/fe3011b9800194a0bff906188a0832a95bc6bb22", "message": "add UT", "committedDate": "2020-08-06T14:02:35Z", "type": "forcePushed"}, {"oid": "07f7c17f3dceb19ef7aab0472a3c48a66e93a65a", "url": "https://github.com/apache/ozone/commit/07f7c17f3dceb19ef7aab0472a3c48a66e93a65a", "message": "add UT", "committedDate": "2020-08-06T14:15:32Z", "type": "forcePushed"}, {"oid": "642710a9464ac0919a988f762432294d6a8ef431", "url": "https://github.com/apache/ozone/commit/642710a9464ac0919a988f762432294d6a8ef431", "message": "fix some issues.", "committedDate": "2020-08-13T18:28:33Z", "type": "forcePushed"}, {"oid": "ce40e90197af2e827668b1b4edb480329bc70cf1", "url": "https://github.com/apache/ozone/commit/ce40e90197af2e827668b1b4edb480329bc70cf1", "message": "fix some issues.", "committedDate": "2020-08-14T01:02:26Z", "type": "forcePushed"}, {"oid": "20b41048a85150adc94e7ab8cb1c1f0a52845124", "url": "https://github.com/apache/ozone/commit/20b41048a85150adc94e7ab8cb1c1f0a52845124", "message": "use atomic operations instead of volume lock.", "committedDate": "2020-09-03T09:25:04Z", "type": "forcePushed"}, {"oid": "09807959ecfdafff7f6afddd6714a60056b8454e", "url": "https://github.com/apache/ozone/commit/09807959ecfdafff7f6afddd6714a60056b8454e", "message": "use atomic operations instead of volume lock.", "committedDate": "2020-09-07T06:54:36Z", "type": "forcePushed"}, {"oid": "a8251c38a3211b63210662147b6732e0cf5700a9", "url": "https://github.com/apache/ozone/commit/a8251c38a3211b63210662147b6732e0cf5700a9", "message": "fix issues.", "committedDate": "2020-09-07T07:28:49Z", "type": "forcePushed"}, {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "url": "https://github.com/apache/ozone/commit/cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "message": "fix issues.", "committedDate": "2020-09-07T07:39:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1MTMwMA==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485051300", "body": "NIT: Can we add a builder to avoid managing constructors with different parameters?", "bodyText": "NIT: Can we add a builder to avoid managing constructors with different parameters?", "bodyHTML": "<p dir=\"auto\">NIT: Can we add a builder to avoid managing constructors with different parameters?</p>", "author": "xiaoyuyao", "createdAt": "2020-09-08T16:31:40Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -131,6 +133,18 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n+  @SuppressWarnings(\"parameternumber\")", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ0NzM0Mg==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485447342", "bodyText": "I think that's good advice, and that's a problem that also exists in OzoneBucket. We can optimize these problems separately, I opened a JIRA HDDS-4223 to follow and optimize this part.", "author": "captainzmc", "createdAt": "2020-09-09T08:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1MTMwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3NTI2Mw==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r486775263", "bodyText": "sounds good to me.", "author": "xiaoyuyao", "createdAt": "2020-09-11T05:04:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1MTMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNzM4OQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484607389", "body": "How do we use `QUOTA_USAGE = \"quotaUsage\"` here ?\r\n\r\nCould you please update the rest part if you agree the idea ?", "bodyText": "How do we use QUOTA_USAGE = \"quotaUsage\" here ?\nCould you please update the rest part if you agree the idea ?", "bodyHTML": "<p dir=\"auto\">How do we use <code>QUOTA_USAGE = \"quotaUsage\"</code> here ?</p>\n<p dir=\"auto\">Could you please update the rest part if you agree the idea ?</p>", "author": "cxorm", "createdAt": "2020-09-08T01:46:17Z", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -269,6 +269,7 @@ private OzoneConsts() {\n   public static final String KEY = \"key\";\n   public static final String SRC_KEY = \"srcKey\";\n   public static final String DST_KEY = \"dstKey\";\n+  public static final String QUOTA_USAGE_IN_BYTES = \"quotaUsageInBytes\";", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0NzUyMg==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485547522", "bodyText": "Using quotaUsage here may not be appropriate because it makes it impossible to distinguish between QuotaUsageInBytes and later QuotaUsageInCount.\nHere we can use the usage in ContainerInfo, use usedBytes.", "author": "captainzmc", "createdAt": "2020-09-09T11:47:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNzM4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwOTE3Mw==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484609173", "body": "```suggestion\r\n    this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\r\n        creationTime, modificationTime, acls, metadata);\r\n    this.quotaUsageInBytes = quotaUsageInBytes;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n          \n          \n            \n                    creationTime, acls, metadata);\n          \n          \n            \n                this.modificationTime = Instant.ofEpochMilli(modificationTime);\n          \n          \n            \n                this.quotaUsageInBytes = quotaUsageInBytes;\n          \n          \n            \n                this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n          \n          \n            \n                    creationTime, modificationTime, acls, metadata);\n          \n          \n            \n                this.quotaUsageInBytes = quotaUsageInBytes;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c1\">this</span>(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        creationTime, acls, metadata);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>modificationTime <span class=\"pl-k\">=</span> <span class=\"pl-smi\">Instant</span><span class=\"pl-k\">.</span>ofEpochMilli(modificationTime);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>quotaUsageInBytes <span class=\"pl-k\">=</span> quotaUsageInBytes;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c1\">this</span>(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        creationTime, modificationTime, acls, metadata);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c1\">this</span><span class=\"pl-k\">.</span>quotaUsageInBytes <span class=\"pl-k\">=</span> quotaUsageInBytes;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-08T01:54:09Z", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -131,6 +133,18 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n+  @SuppressWarnings(\"parameternumber\")\n+  public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n+      String name, String admin, String owner, long quotaInBytes,\n+      long quotaInCounts, long creationTime, long modificationTime,\n+      List<OzoneAcl> acls, Map<String, String> metadata,\n+      long quotaUsageInBytes) {\n+    this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n+        creationTime, acls, metadata);\n+    this.modificationTime = Instant.ofEpochMilli(modificationTime);\n+    this.quotaUsageInBytes = quotaUsageInBytes;", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxNDMwOQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484614309", "body": "I'm fine with the `LongAdder` here.\r\n\r\nOut of curiosity,\r\nCould you be so kind to tell me why we use it here ? \r\n(Or please describe the bad pattern if we use just `long` or `Long`) ", "bodyText": "I'm fine with the LongAdder here.\nOut of curiosity,\nCould you be so kind to tell me why we use it here ?\n(Or please describe the bad pattern if we use just long or Long)", "bodyHTML": "<p dir=\"auto\">I'm fine with the <code>LongAdder</code> here.</p>\n<p dir=\"auto\">Out of curiosity,<br>\nCould you be so kind to tell me why we use it here ?<br>\n(Or please describe the bad pattern if we use just <code>long</code> or <code>Long</code>)</p>", "author": "cxorm", "createdAt": "2020-09-08T02:17:37Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -46,6 +47,7 @@\n   private long quotaInBytes;\n   private long quotaInCounts;\n   private final OmOzoneAclMap aclMap;\n+  private LongAdder quotaUsageInBytes = new LongAdder();", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3MDY1MQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485570651", "bodyText": "QuotaUsageInBytes is a property of Volume that needs to be updated each time when CreateKey, AllocateBlock, CommitKey, DeleteKey. and at the beginning, we used the volume lock.\nBut, Previously, only Bucket locks were used for these operation, and use volume lock greatly affect the concurrency performance of different buckets under same volume.\nSo to avoid Volume locking for poor performance, LongAdder is used here to complete the atomic update of quotaUsageInBytes.\nI did a performance test with freon. Multi-threading wrote different buckets under the same volume, and using LongAdder had little impact on the original performance.", "author": "captainzmc", "createdAt": "2020-09-09T12:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxNDMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzMjQ0OQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484632449", "body": "```suggestion\r\n```", "bodyText": "Suggested change", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-08T03:38:11Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -222,6 +218,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       acquireLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,\n           volumeName, bucketName);\n+", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzNTY2Ng==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484635666", "body": "```suggestion\r\n      long preAllocatedSpace = newLocationList.size() * scmBlockSize\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long updateNum = newLocationList.size() * scmBlockSize\n          \n          \n            \n                  long preAllocatedSpace = newLocationList.size() * scmBlockSize", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">updateNum</span> <span class=\"pl-k\">=</span> newLocationList<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">*</span> scmBlockSize</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">preAllocatedSpace</span> <span class=\"pl-k\">=</span> newLocationList<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">*</span> scmBlockSize</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-08T03:52:59Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -295,14 +293,28 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOpenKeyName),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+\n+      // Here we refer to the implementation of HDFS:\n+      // If the key size is 600MB, when createKey, keyLocationList is 3, and\n+      // the every pre-allocated block length is 256MB. If the number of factor\n+      // is 3, the total pre-allocated block size is 256MB*3*3.\n+      // We will allocate more 256MB*3* 3-600mb *3 = 504MB in advance, and we\n+      // will subtract this part when we finally commitKey.\n+      long updateNum = newLocationList.size() * scmBlockSize", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzNjE3Mw==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484636173", "body": "```suggestion\r\n      // Here we refer to the implementation of HDFS:\r\n      // If the key size is 600MB, when createKey, keyLocationInfo in keyLocationList is 3, and\r\n      // the every pre-allocated block length is 256MB. If the number of factor\r\n      // is 3, the total pre-allocated block size is 256MB * 3 * 3.\r\n      // We will allocate more 256MB * 3 * 3 - 600MB * 3 = 504MB in advance, and we\r\n      // will subtract this part when we finally commitKey.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // Here we refer to the implementation of HDFS:\n          \n          \n            \n                  // If the key size is 600MB, when createKey, keyLocationList is 3, and\n          \n          \n            \n                  // the every pre-allocated block length is 256MB. If the number of factor\n          \n          \n            \n                  // is 3, the total pre-allocated block size is 256MB*3*3.\n          \n          \n            \n                  // We will allocate more 256MB*3* 3-600mb *3 = 504MB in advance, and we\n          \n          \n            \n                  // will subtract this part when we finally commitKey.\n          \n          \n            \n                  // Here we refer to the implementation of HDFS:\n          \n          \n            \n                  // If the key size is 600MB, when createKey, keyLocationInfo in keyLocationList is 3, and\n          \n          \n            \n                  // the every pre-allocated block length is 256MB. If the number of factor\n          \n          \n            \n                  // is 3, the total pre-allocated block size is 256MB * 3 * 3.\n          \n          \n            \n                  // We will allocate more 256MB * 3 * 3 - 600MB * 3 = 504MB in advance, and we\n          \n          \n            \n                  // will subtract this part when we finally commitKey.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> Here we refer to the implementation of HDFS:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> If the key size is 600MB, when createKey, keyLocationList is 3, and</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> the every pre-allocated block length is 256MB. If the number of factor</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> is 3, the total pre-allocated block size is 256MB<span class=\"x x-first x-last\">*3*</span>3.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> We will allocate more 256MB<span class=\"x x-first x-last\">*3</span>* 3<span class=\"x x-first x-last\">-600mb *</span>3 = 504MB in advance, and we</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> will subtract this part when we finally commitKey.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> Here we refer to the implementation of HDFS:</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> If the key size is 600MB, when createKey, <span class=\"x x-first x-last\">keyLocationInfo in </span>keyLocationList is 3, and</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> the every pre-allocated block length is 256MB. If the number of factor</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> is 3, the total pre-allocated block size is 256MB<span class=\"x x-first x-last\"> * 3 * </span>3.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> We will allocate more 256MB<span class=\"x x-first x-last\"> * 3 </span>* 3<span class=\"x x-first x-last\"> - 600MB * </span>3 = 504MB in advance, and we</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> will subtract this part when we finally commitKey.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-08T03:55:21Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -295,14 +293,28 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOpenKeyName),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+\n+      // Here we refer to the implementation of HDFS:\n+      // If the key size is 600MB, when createKey, keyLocationList is 3, and\n+      // the every pre-allocated block length is 256MB. If the number of factor\n+      // is 3, the total pre-allocated block size is 256MB*3*3.\n+      // We will allocate more 256MB*3* 3-600mb *3 = 504MB in advance, and we\n+      // will subtract this part when we finally commitKey.", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3MTU4Mg==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485271582", "body": "```suggestion\r\n      long quotaReleased = 0;\r\n```\r\n\r\nWe could name the variable in a proper meaning IMHO,\r\nfeel free to rename it if you have an idea.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long totalKeySize = 0;\n          \n          \n            \n                  long quotaReleased = 0;\n          \n      \n    \n    \n  \n\nWe could name the variable in a proper meaning IMHO,\nfeel free to rename it if you have an idea.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">totalKeySize</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">quotaReleased</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">We could name the variable in a proper meaning IMHO,<br>\nfeel free to rename it if you have an idea.</p>", "author": "cxorm", "createdAt": "2020-09-09T00:44:50Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -143,14 +143,25 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n               keyName)),\n           new CacheValue<>(Optional.absent(), trxnLogIndex));\n \n+      long totalKeySize = 0;", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3MjQ5NA==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485272494", "body": "```suggestion\r\n      // update quotaUsage atomically.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // atom update quotaUsage.\n          \n          \n            \n                  // update quotaUsage atomically.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">atom </span>update quotaUsage.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> update quotaUsage<span class=\"x x-first x-last\"> atomically</span>.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-09T00:48:17Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -143,14 +143,25 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n               keyName)),\n           new CacheValue<>(Optional.absent(), trxnLogIndex));\n \n+      long totalKeySize = 0;\n+      int keyFactor = omKeyInfo.getFactor().getNumber();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      OmKeyLocationInfoGroup keyLocationGroup =\n+          omKeyInfo.getLatestVersionLocations();\n+      for(OmKeyLocationInfo locationInfo: keyLocationGroup.getLocationList()){\n+        totalKeySize += locationInfo.getLength() * keyFactor;\n+      }\n+      // atom update quotaUsage.", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3Mjg0Mg==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485272842", "body": "```suggestion\r\n      long quotaReleased = 0;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long totalKeySize = 0;\n          \n          \n            \n                  long quotaReleased = 0;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">totalKeySize</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">quotaReleased</span> <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-09T00:49:45Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeysDeleteRequest.java", "diffHunk": "@@ -151,21 +154,32 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         }\n       }\n \n+      long totalKeySize = 0;", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3MzgzNg==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485273836", "body": "```suggestion\r\n      // update quotaUsage atomically.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // atom update quotaUsage.\n          \n          \n            \n                  // update quotaUsage atomically.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">atom </span>update quotaUsage.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> update quotaUsage<span class=\"x x-first x-last\"> atomically</span>.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-09T00:53:28Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeysDeleteRequest.java", "diffHunk": "@@ -151,21 +154,32 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         }\n       }\n \n+      long totalKeySize = 0;\n+      OmVolumeArgs omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+\n       // Mark all keys which can be deleted, in cache as deleted.\n       for (OmKeyInfo omKeyInfo : omKeyInfoList) {\n         omMetadataManager.getKeyTable().addCacheEntry(\n             new CacheKey<>(omMetadataManager.getOzoneKey(volumeName, bucketName,\n                 omKeyInfo.getKeyName())),\n             new CacheValue<>(Optional.absent(), trxnLogIndex));\n+\n+        int keyFactor = omKeyInfo.getFactor().getNumber();\n+        OmKeyLocationInfoGroup keyLocationGroup =\n+            omKeyInfo.getLatestVersionLocations();\n+        for(OmKeyLocationInfo locationInfo: keyLocationGroup.getLocationList()){\n+          totalKeySize += locationInfo.getLength() * keyFactor;\n+        }\n       }\n+      // atom update quotaUsage.", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3NDQyOA==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485274428", "body": "```suggestion\r\n}\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"117\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">}</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"117\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">}</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-09T00:55:34Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeysDeleteResponse.java", "diffHunk": "@@ -105,5 +108,10 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n       omMetadataManager.getDeletedTable().putWithBatch(batchOperation,\n           deleteKey, repeatedOmKeyInfo);\n     }\n+\n+    // update volume quotaUsageInBytes.\n+    omMetadataManager.getVolumeTable().putWithBatch(batchOperation,\n+        omMetadataManager.getVolumeKey(omVolumeArgs.getVolume()),\n+        omVolumeArgs);\n   }\n }", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTMzOA==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485281338", "body": "I'm confused about the meaning of the variable. \r\n(Please let me know the meaning of the variable if I miss something.)\r\n\r\nCould you please add some comments about it ?", "bodyText": "I'm confused about the meaning of the variable.\n(Please let me know the meaning of the variable if I miss something.)\nCould you please add some comments about it ?", "bodyHTML": "<p dir=\"auto\">I'm confused about the meaning of the variable.<br>\n(Please let me know the meaning of the variable if I miss something.)</p>\n<p dir=\"auto\">Could you please add some comments about it ?</p>", "author": "cxorm", "createdAt": "2020-09-09T01:21:11Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -182,8 +179,16 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOzoneKey),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      int factor = omKeyInfo.getFactor().getNumber();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = omKeyInfo.getDataSize() * factor -\n+          locationInfoList.size() * scmBlockSize * factor;", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3Mzc2NQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485573765", "bodyText": "I will add comment to describe the calculation here.", "author": "captainzmc", "createdAt": "2020-09-09T12:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTYwMw==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485281603", "body": "```suggestion\r\n      long preAllocatedSpace = newLocationList.size() * scmBlockSize\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long updateNum = newLocationList.size() * scmBlockSize\n          \n          \n            \n                  long preAllocatedSpace = newLocationList.size() * scmBlockSize", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">updateNum</span> <span class=\"pl-k\">=</span> newLocationList<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">*</span> scmBlockSize</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">preAllocatedSpace</span> <span class=\"pl-k\">=</span> newLocationList<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">*</span> scmBlockSize</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-09T01:22:11Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -292,14 +289,21 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           bucketName, Optional.absent(), Optional.of(missingParentInfos),\n           trxnLogIndex);\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = newLocationList.size() * scmBlockSize", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTg1OQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485281859", "body": "```suggestion\r\n      long preAllocatedSpace = newLocationList.size() * scmBlockSize\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long updateNum = newLocationList.size() * scmBlockSize\n          \n          \n            \n                  long preAllocatedSpace = newLocationList.size() * scmBlockSize", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">updateNum</span> <span class=\"pl-k\">=</span> newLocationList<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">*</span> scmBlockSize</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-k\">long</span> <span class=\"x x-first x-last\">preAllocatedSpace</span> <span class=\"pl-k\">=</span> newLocationList<span class=\"pl-k\">.</span>size() <span class=\"pl-k\">*</span> scmBlockSize</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-09T01:23:11Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -210,10 +206,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(openKeyName),\n           new CacheValue<>(Optional.of(openKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = newLocationList.size() * scmBlockSize", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MjEwNA==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485282104", "body": "The same as `OMKeyCommitRequest`", "bodyText": "The same as OMKeyCommitRequest", "bodyHTML": "<p dir=\"auto\">The same as <code>OMKeyCommitRequest</code></p>", "author": "cxorm", "createdAt": "2020-09-09T01:24:14Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadCommitPartRequest.java", "diffHunk": "@@ -207,13 +209,21 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(openKey),\n           new CacheValue<>(Optional.absent(), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      int factor = omKeyInfo.getFactor().getNumber();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = omKeyInfo.getDataSize() * factor -\n+          keyArgs.getKeyLocationsList().size() * scmBlockSize * factor;", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MzAwNg==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485283006", "body": "```suggestion\r\n      // update quotaUsage atomically.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // atom update quotaUsage.\n          \n          \n            \n                  // update quotaUsage atomically.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> <span class=\"x x-first x-last\">atom </span>update quotaUsage.</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">      <span class=\"pl-c\"><span class=\"pl-c\">//</span> update quotaUsage<span class=\"x x-first x-last\"> atomically</span>.</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "cxorm", "createdAt": "2020-09-09T01:27:30Z", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -210,10 +206,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(openKeyName),\n           new CacheValue<>(Optional.of(openKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = newLocationList.size() * scmBlockSize\n+          * openKeyInfo.getFactor().getNumber();\n+      // atom update quotaUsage.", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0ODYwOQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484848609", "body": "add final ", "bodyText": "add final", "bodyHTML": "<p dir=\"auto\">add final</p>", "author": "ChenSammi", "createdAt": "2020-09-08T11:35:47Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -46,6 +47,7 @@\n   private long quotaInBytes;\n   private long quotaInCounts;\n   private final OmOzoneAclMap aclMap;\n+  private LongAdder quotaUsageInBytes = new LongAdder();", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0ODk1MQ==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484848951", "body": "setQuotaUsageInBytes -> increase***", "bodyText": "setQuotaUsageInBytes -> increase***", "bodyHTML": "<p dir=\"auto\">setQuotaUsageInBytes -&gt; increase***</p>", "author": "ChenSammi", "createdAt": "2020-09-08T11:36:28Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -172,6 +176,14 @@ public long getQuotaInCounts() {\n   public OmOzoneAclMap getAclMap() {\n     return aclMap;\n   }\n+\n+  public LongAdder getQuotaUsageInBytes() {\n+    return quotaUsageInBytes;\n+  }\n+\n+  public void setQuotaUsageInBytes(long quotaUsageInBytes) {", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2NjI2OA==", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484866268", "body": "Should getObjectInfo also be changed?", "bodyText": "Should getObjectInfo also be changed?", "bodyHTML": "<p dir=\"auto\">Should getObjectInfo also be changed?</p>", "author": "ChenSammi", "createdAt": "2020-09-08T12:09:46Z", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -386,7 +408,7 @@ public OmVolumeArgs copyObject() {\n     OmOzoneAclMap cloneAclMap = aclMap.copyObject();\n \n     return new OmVolumeArgs(adminName, ownerName, volume, quotaInBytes,\n-        quotaInCounts, cloneMetadata, cloneAclMap, creationTime,\n-        modificationTime, objectID, updateID);\n+        quotaInCounts, cloneMetadata, quotaUsageInBytes.sum(), cloneAclMap,\n+        creationTime, modificationTime, objectID, updateID);\n   }\n }", "originalCommit": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "34277903759a624d6de4d614f700573795da2426", "url": "https://github.com/apache/ozone/commit/34277903759a624d6de4d614f700573795da2426", "message": "add volume quota usage", "committedDate": "2020-09-15T08:25:17Z", "type": "commit"}, {"oid": "0117885333c1b4dad75fe8723a7cd904525b6973", "url": "https://github.com/apache/ozone/commit/0117885333c1b4dad75fe8723a7cd904525b6973", "message": "fix review issues and resolve conflict.", "committedDate": "2020-09-15T08:47:52Z", "type": "forcePushed"}, {"oid": "c272d010afa3b031682633f438bef89896fb61a7", "url": "https://github.com/apache/ozone/commit/c272d010afa3b031682633f438bef89896fb61a7", "message": "fix review issues and resolve conflict.", "committedDate": "2020-09-15T10:15:31Z", "type": "commit"}, {"oid": "c272d010afa3b031682633f438bef89896fb61a7", "url": "https://github.com/apache/ozone/commit/c272d010afa3b031682633f438bef89896fb61a7", "message": "fix review issues and resolve conflict.", "committedDate": "2020-09-15T10:15:31Z", "type": "forcePushed"}, {"oid": "bce9bf4bd3b00d0843f46c21bc96a099c585777d", "url": "https://github.com/apache/ozone/commit/bce9bf4bd3b00d0843f46c21bc96a099c585777d", "message": "fix review issues", "committedDate": "2020-09-15T11:52:31Z", "type": "commit"}, {"oid": "203804e6e8d466d06a700bc75b65a987815544cb", "url": "https://github.com/apache/ozone/commit/203804e6e8d466d06a700bc75b65a987815544cb", "message": "fix s3 MultipartUploadAbort.", "committedDate": "2020-09-16T02:22:43Z", "type": "commit"}]}