{"pr_number": 833, "pr_title": "HDDS-3314. FIx ContainerOperationClient#readContainer to use Grpc Client to read from datanode", "pr_author": "sadanand48", "pr_createdAt": "2020-04-16T11:40:50Z", "pr_url": "https://github.com/apache/ozone/pull/833", "timeline": [{"oid": "c71b6202e139e36e54f18370492abc2edfe889dc", "url": "https://github.com/apache/ozone/commit/c71b6202e139e36e54f18370492abc2edfe889dc", "message": "HDDS-3314. scmcli container info command failing intermittently", "committedDate": "2020-04-16T11:31:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg4NTE5MA==", "url": "https://github.com/apache/ozone/pull/833#discussion_r409885190", "body": "I have not really understood this change, as we just changed from acquireClient  -> acquireClientForReadData.\r\nHow that will handle failures, and how it will retry on other datanodes.\r\n\r\nAnd also InfoSubCommand Uses below code, and it is not calling readContainer.\r\n      final ContainerWithPipeline container = scmClient.\r\n          getContainerWithPipeline(containerID);\r\n\r\n>       final ContainerWithPipeline container = scmClient.\r\n>           getContainerWithPipeline(containerID);\r\n>       Preconditions.checkNotNull(container, \"Container cannot be null\");\r\n\r\nIf possible, can you explain this change, not sure if I am missing something here.", "bodyText": "I have not really understood this change, as we just changed from acquireClient  -> acquireClientForReadData.\nHow that will handle failures, and how it will retry on other datanodes.\nAnd also InfoSubCommand Uses below code, and it is not calling readContainer.\nfinal ContainerWithPipeline container = scmClient.\ngetContainerWithPipeline(containerID);\n\n  final ContainerWithPipeline container = scmClient.\n      getContainerWithPipeline(containerID);\n  Preconditions.checkNotNull(container, \"Container cannot be null\");\n\n\nIf possible, can you explain this change, not sure if I am missing something here.", "bodyHTML": "<p dir=\"auto\">I have not really understood this change, as we just changed from acquireClient  -&gt; acquireClientForReadData.<br>\nHow that will handle failures, and how it will retry on other datanodes.</p>\n<p dir=\"auto\">And also InfoSubCommand Uses below code, and it is not calling readContainer.<br>\nfinal ContainerWithPipeline container = scmClient.<br>\ngetContainerWithPipeline(containerID);</p>\n<blockquote>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  final ContainerWithPipeline container = scmClient.\n      getContainerWithPipeline(containerID);\n  Preconditions.checkNotNull(container, &quot;Container cannot be null&quot;);\n\"><pre><code>  final ContainerWithPipeline container = scmClient.\n      getContainerWithPipeline(containerID);\n  Preconditions.checkNotNull(container, \"Container cannot be null\");\n</code></pre></div>\n</blockquote>\n<p dir=\"auto\">If possible, can you explain this change, not sure if I am missing something here.</p>", "author": "bharatviswa504", "createdAt": "2020-04-16T22:28:45Z", "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ContainerOperationClient.java", "diffHunk": "@@ -382,7 +382,7 @@ public ContainerDataProto readContainer(long containerID,\n       Pipeline pipeline) throws IOException {\n     XceiverClientSpi client = null;\n     try {\n-      client = xceiverClientManager.acquireClient(pipeline);\n+      client = xceiverClientManager.acquireClientForReadData(pipeline);", "originalCommit": "c71b6202e139e36e54f18370492abc2edfe889dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5OTMzNA==", "url": "https://github.com/apache/ozone/pull/833#discussion_r410099334", "bodyText": "@bharat, if we use acquireClientForReadData, it will use XceiverClientGrpc to read the info rather than Ratis(which reads only from the leader if we use acquireClient). XceiverClientGrpc automatically fails over from datanode to another and retries if it sees a failure.\nInfoSubCommand has recently been changed to not use readContainer call to read data from datanode. But , in Ozone, as we only use XceiverClientGrpc to read from datanode , it make sense here to use the same while reading the containerData as well (acquireClient -> acquireClientForReadData). This function is used by ChunkKeyHandler. I have modified the description of the ira accordingly.", "author": "bshashikant", "createdAt": "2020-04-17T09:19:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg4NTE5MA=="}], "type": "inlineReview"}]}