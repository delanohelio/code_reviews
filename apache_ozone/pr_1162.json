{"pr_number": 1162, "pr_title": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen\u2026", "pr_author": "ChenSammi", "pr_createdAt": "2020-07-04T09:24:17Z", "pr_url": "https://github.com/apache/ozone/pull/1162", "timeline": [{"oid": "247c40c4a70e204f9a6fe9e5001862fb8a8a34a5", "url": "https://github.com/apache/ozone/commit/247c40c4a70e204f9a6fe9e5001862fb8a8a34a5", "message": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes", "committedDate": "2020-07-04T09:27:40Z", "type": "forcePushed"}, {"oid": "a05598276e11bf7981b5c142a470e993293f375a", "url": "https://github.com/apache/ozone/commit/a05598276e11bf7981b5c142a470e993293f375a", "message": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes", "committedDate": "2020-07-04T14:14:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450514295", "body": "NIT: this line to move the line to calculate delta from 547->549 is not needed.  Only the line 550 is the core change that breaks out when we've already handle the under replicate container via inflight replication. ", "bodyText": "NIT: this line to move the line to calculate delta from 547->549 is not needed.  Only the line 550 is the core change that breaks out when we've already handle the under replicate container via inflight replication.", "bodyHTML": "<p dir=\"auto\">NIT: this line to move the line to calculate delta from 547-&gt;549 is not needed.  Only the line 550 is the core change that breaks out when we've already handle the under replicate container via inflight replication.</p>", "author": "xiaoyuyao", "createdAt": "2020-07-06T22:35:21Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);", "originalCommit": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzNTIzMg==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452035232", "bodyText": "This delta calculation and check in line 550 is required.  Currenlty placementStatus.isPolicySatisfied() only checks whether topology requirement is satisfied or not. It doesn't check whether it has enough replicas.", "author": "ChenSammi", "createdAt": "2020-07-09T08:00:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0MTMxNQ==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452541315", "bodyText": "Got it. I agree delta calculation is needed. I mean move delta calculation after placementStatus is not necessary.", "author": "xiaoyuyao", "createdAt": "2020-07-09T23:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMDM5Nw==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450820397", "body": "Rather than this new IF block here, would it make sense to simply add:\r\n\r\n```\r\nif (replicasNeeded <= 0) {\r\n  LOG.debug(...);\r\n  return;\r\n}\r\n```\r\n\r\nAt line 554 / 558, just after the line:\r\n\r\n```\r\n        final int replicasNeeded\r\n            = delta < misRepDelta ? misRepDelta : delta;\r\n```\r\n\r\nThat would avoid needing to check call `placementStatus.isPolicySatisfied()` and then `placementStatus.misReplicationCount()` afterwards, as `misReplicationCount()` calls `isPolicySatisfied()` anyway.", "bodyText": "Rather than this new IF block here, would it make sense to simply add:\nif (replicasNeeded <= 0) {\n  LOG.debug(...);\n  return;\n}\n\nAt line 554 / 558, just after the line:\n        final int replicasNeeded\n            = delta < misRepDelta ? misRepDelta : delta;\n\nThat would avoid needing to check call placementStatus.isPolicySatisfied() and then placementStatus.misReplicationCount() afterwards, as misReplicationCount() calls isPolicySatisfied() anyway.", "bodyHTML": "<p dir=\"auto\">Rather than this new IF block here, would it make sense to simply add:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"if (replicasNeeded &lt;= 0) {\n  LOG.debug(...);\n  return;\n}\n\"><pre><code>if (replicasNeeded &lt;= 0) {\n  LOG.debug(...);\n  return;\n}\n</code></pre></div>\n<p dir=\"auto\">At line 554 / 558, just after the line:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"        final int replicasNeeded\n            = delta &lt; misRepDelta ? misRepDelta : delta;\n\"><pre><code>        final int replicasNeeded\n            = delta &lt; misRepDelta ? misRepDelta : delta;\n</code></pre></div>\n<p dir=\"auto\">That would avoid needing to check call <code>placementStatus.isPolicySatisfied()</code> and then <code>placementStatus.misReplicationCount()</code> afterwards, as <code>misReplicationCount()</code> calls <code>isPolicySatisfied()</code> anyway.</p>", "author": "sodonnel", "createdAt": "2020-07-07T12:17:50Z", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);\n+        if (placementStatus.isPolicySatisfied() && delta <= 0) {", "originalCommit": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1MjM1Mg==", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452052352", "bodyText": "Make sense.", "author": "ChenSammi", "createdAt": "2020-07-09T08:30:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMDM5Nw=="}], "type": "inlineReview"}, {"oid": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "url": "https://github.com/apache/ozone/commit/091a7b634b2b9342efdc28ef4acc9e3e77be4300", "message": "address comments", "committedDate": "2020-07-09T08:26:53Z", "type": "commit"}, {"oid": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "url": "https://github.com/apache/ozone/commit/091a7b634b2b9342efdc28ef4acc9e3e77be4300", "message": "address comments", "committedDate": "2020-07-09T08:26:53Z", "type": "forcePushed"}, {"oid": "277b028818ffe992416c2b412805f2a790db0c50", "url": "https://github.com/apache/ozone/commit/277b028818ffe992416c2b412805f2a790db0c50", "message": "trigger new CI check", "committedDate": "2020-07-10T06:15:05Z", "type": "commit"}]}