{"pr_number": 1703, "pr_title": "HDDS-4591. BasicOzoneFileSystem reports StorageUnit class not found.", "pr_author": "ChenSammi", "pr_createdAt": "2020-12-15T12:21:55Z", "pr_url": "https://github.com/apache/ozone/pull/1703", "timeline": [{"oid": "5d507094a5baa2785914fa9ed036f0d966d4319f", "url": "https://github.com/apache/ozone/commit/5d507094a5baa2785914fa9ed036f0d966d4319f", "message": "HDDS-4591. BasicOzoneFileSystem reports StorageUnit class not found.", "committedDate": "2020-12-15T12:19:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYxMzI2OA==", "url": "https://github.com/apache/ozone/pull/1703#discussion_r543613268", "body": "NIT: can we wrap this as a helper function as I can see the initialize() has similar logic. \r\n", "bodyText": "NIT: can we wrap this as a helper function as I can see the initialize() has similar logic.", "bodyHTML": "<p dir=\"auto\">NIT: can we wrap this as a helper function as I can see the initialize() has similar logic.</p>", "author": "xiaoyuyao", "createdAt": "2020-12-15T19:08:14Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -703,7 +703,14 @@ public boolean mkdirs(Path f, FsPermission permission) throws IOException {\n \n   @Override\n   public long getDefaultBlockSize() {\n-    return (long) getConf().getStorageSize(\n+    Configuration conf = getConf();\n+    ConfigurationSource source;", "originalCommit": "5d507094a5baa2785914fa9ed036f0d966d4319f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYxMzY3NA==", "url": "https://github.com/apache/ozone/pull/1703#discussion_r543613674", "body": "We need a fix for this in BasicRootedOzoneFileSystem#getDefaultBlockSize() as well. ", "bodyText": "We need a fix for this in BasicRootedOzoneFileSystem#getDefaultBlockSize() as well.", "bodyHTML": "<p dir=\"auto\">We need a fix for this in BasicRootedOzoneFileSystem#getDefaultBlockSize() as well.</p>", "author": "xiaoyuyao", "createdAt": "2020-12-15T19:08:50Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -703,7 +703,14 @@ public boolean mkdirs(Path f, FsPermission permission) throws IOException {\n \n   @Override\n   public long getDefaultBlockSize() {", "originalCommit": "5d507094a5baa2785914fa9ed036f0d966d4319f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYxMzY4NQ==", "url": "https://github.com/apache/ozone/pull/1703#discussion_r543613685", "body": "Instead of duplicating this logic from `initialize`:\r\n\r\nhttps://github.com/apache/ozone/blob/09579756b0756fcaf1b22b860c1ee1eb927e82c2/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java#L161-L166\r\n\r\nI think it would be cleaner to store this `ConfigurationSource`\r\n\r\n* either in `BasicOzoneFileSystem`\r\n* or in `BasicOzoneClientAdapterImpl` (and expose it via accessor method)\r\n\r\nand then use it here.", "bodyText": "Instead of duplicating this logic from initialize:\n\n  \n    \n      ozone/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java\n    \n    \n        Lines 161 to 166\n      in\n      0957975\n    \n    \n    \n    \n\n        \n          \n           ConfigurationSource source; \n        \n\n        \n          \n           if (conf instanceof OzoneConfiguration) { \n        \n\n        \n          \n             source = (ConfigurationSource) conf; \n        \n\n        \n          \n           } else { \n        \n\n        \n          \n             source = new LegacyHadoopConfigurationSource(conf); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nI think it would be cleaner to store this ConfigurationSource\n\neither in BasicOzoneFileSystem\nor in BasicOzoneClientAdapterImpl (and expose it via accessor method)\n\nand then use it here.", "bodyHTML": "<p dir=\"auto\">Instead of duplicating this logic from <code>initialize</code>:</p>\n<p dir=\"auto\"><div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/apache/ozone/blob/09579756b0756fcaf1b22b860c1ee1eb927e82c2/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java#L161-L166\">ozone/hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 161 to 166\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/apache/ozone/commit/09579756b0756fcaf1b22b860c1ee1eb927e82c2\">0957975</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L161\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"161\"></td>\n          <td id=\"LC161\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">ConfigurationSource</span> source; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L162\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"162\"></td>\n          <td id=\"LC162\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">if</span> (conf <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">OzoneConfiguration</span>) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L163\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"163\"></td>\n          <td id=\"LC163\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   source <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">ConfigurationSource</span>) conf; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L164\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"164\"></td>\n          <td id=\"LC164\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } <span class=\"pl-k\">else</span> { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L165\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"165\"></td>\n          <td id=\"LC165\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">   source <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">LegacyHadoopConfigurationSource</span>(conf); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L166\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"166\"></td>\n          <td id=\"LC166\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n</p>\n<p dir=\"auto\">I think it would be cleaner to store this <code>ConfigurationSource</code></p>\n<ul dir=\"auto\">\n<li>either in <code>BasicOzoneFileSystem</code></li>\n<li>or in <code>BasicOzoneClientAdapterImpl</code> (and expose it via accessor method)</li>\n</ul>\n<p dir=\"auto\">and then use it here.</p>", "author": "adoroszlai", "createdAt": "2020-12-15T19:08:51Z", "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -703,7 +703,14 @@ public boolean mkdirs(Path f, FsPermission permission) throws IOException {\n \n   @Override\n   public long getDefaultBlockSize() {\n-    return (long) getConf().getStorageSize(\n+    Configuration conf = getConf();\n+    ConfigurationSource source;\n+    if (conf instanceof OzoneConfiguration) {\n+      source = (ConfigurationSource) conf;\n+    } else {\n+      source = new LegacyHadoopConfigurationSource(conf);\n+    }", "originalCommit": "5d507094a5baa2785914fa9ed036f0d966d4319f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9ebf8317659876d9850d7d41a1258b2876871a28", "url": "https://github.com/apache/ozone/commit/9ebf8317659876d9850d7d41a1258b2876871a28", "message": "address comments", "committedDate": "2020-12-16T06:31:51Z", "type": "commit"}]}