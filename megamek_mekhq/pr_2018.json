{"pr_number": 2018, "pr_title": "Improved tracking of integrated heat sink changes during refit", "pr_author": "RexPearce", "pr_createdAt": "2020-09-17T20:38:01Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/2018", "timeline": [{"oid": "94523d9a51ce8027b5c00976cbeb4c59ada89040", "url": "https://github.com/MegaMek/mekhq/commit/94523d9a51ce8027b5c00976cbeb4c59ada89040", "message": "new integrated heat sinks should be added as MissingParts, otherwise they will be ignored by shoppingList", "committedDate": "2020-09-17T02:37:07Z", "type": "commit"}, {"oid": "1bd5efc05ca97a538a068f3d324daa0dea1d6745", "url": "https://github.com/MegaMek/mekhq/commit/1bd5efc05ca97a538a068f3d324daa0dea1d6745", "message": "cleanup Integrated heat sink parts: don't actually add them to the unit", "committedDate": "2020-09-17T05:06:09Z", "type": "commit"}, {"oid": "518eff0aabb071820c8226d20465dbc5ff7c6050", "url": "https://github.com/MegaMek/mekhq/commit/518eff0aabb071820c8226d20465dbc5ff7c6050", "message": "when refitting internal heat sinks, check warehouse for spares before ordering new ones", "committedDate": "2020-09-17T05:46:40Z", "type": "commit"}, {"oid": "d2c532c163c25c04e9c5fdbe46df73ca77882f82", "url": "https://github.com/MegaMek/mekhq/commit/d2c532c163c25c04e9c5fdbe46df73ca77882f82", "message": "Merge remote-tracking branch 'upstream/master' into fix-refit-integrated-heat-sinks", "committedDate": "2020-09-17T13:39:54Z", "type": "commit"}, {"oid": "45f407c020714ed45a4a98d068aa42ea6350b5e3", "url": "https://github.com/MegaMek/mekhq/commit/45f407c020714ed45a4a98d068aa42ea6350b5e3", "message": "better cleanup of integrated heat sinks for Tanks and Aeros", "committedDate": "2020-09-17T18:20:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4NDIyMg==", "url": "https://github.com/MegaMek/mekhq/pull/2018#discussion_r490584222", "body": "```suggestion\r\n        for (Part nHsPart : newIntegratedHS) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for(Part nHsPart : newIntegratedHS) {\n          \n          \n            \n                    for (Part nHsPart : newIntegratedHS) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">for</span>(<span class=\"pl-smi\">Part</span> nHsPart <span class=\"pl-k\">:</span> newIntegratedHS) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">for</span><span class=\"x x-first x-last\"> </span>(<span class=\"pl-smi\">Part</span> nHsPart <span class=\"pl-k\">:</span> newIntegratedHS) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-09-17T21:55:29Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -907,15 +906,40 @@ public void calculate() {\n             if (oldHS != newHS) {\n                 Part hsPart = heatSinkPart(newEntity); // only single HS allowed, so they have to be of the same type\n                 for (int i = oldHS; i < newHS; i++) {\n-                    newIntegratedHS.add(hsPart.clone());\n+                    // Heat sink added for supply chain tracking purposes and removed from refit later\n+                    newIntegratedHS.add(hsPart.clone().getMissingPart());\n                 }\n                 for (int i = newHS; i < oldHS; i++) {\n                     oldIntegratedHS.add(hsPart.clone());\n                 }\n             }\n         }\n         time += (oldIntegratedHS.size() + newIntegratedHS.size()) * 90;\n-        shoppingList.addAll(newIntegratedHS);\n+        for(Part nHsPart : newIntegratedHS) {", "originalCommit": "45f407c020714ed45a4a98d068aa42ea6350b5e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4NDg4OQ==", "url": "https://github.com/MegaMek/mekhq/pull/2018#discussion_r490584889", "body": "```suggestion\r\n            if ((null != replacement) && (null == partQuantity.get(replacement.getId()))) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if((null != replacement) && (null == partQuantity.get(replacement.getId()))) {\n          \n          \n            \n                        if ((null != replacement) && (null == partQuantity.get(replacement.getId()))) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span>((<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement) <span class=\"pl-k\">&amp;&amp;</span> (<span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"pl-k\">.</span>getId()))) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span><span class=\"x x-first x-last\"> </span>((<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement) <span class=\"pl-k\">&amp;&amp;</span> (<span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"pl-k\">.</span>getId()))) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-09-17T21:57:05Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -907,15 +906,40 @@ public void calculate() {\n             if (oldHS != newHS) {\n                 Part hsPart = heatSinkPart(newEntity); // only single HS allowed, so they have to be of the same type\n                 for (int i = oldHS; i < newHS; i++) {\n-                    newIntegratedHS.add(hsPart.clone());\n+                    // Heat sink added for supply chain tracking purposes and removed from refit later\n+                    newIntegratedHS.add(hsPart.clone().getMissingPart());\n                 }\n                 for (int i = newHS; i < oldHS; i++) {\n                     oldIntegratedHS.add(hsPart.clone());\n                 }\n             }\n         }\n         time += (oldIntegratedHS.size() + newIntegratedHS.size()) * 90;\n-        shoppingList.addAll(newIntegratedHS);\n+        for(Part nHsPart : newIntegratedHS) {\n+            // Check warehouse for spare heat sinks before adding to shopping list\n+            Part replacement = ((MissingPart)nHsPart).findReplacement(true);\n+            //check quantity\n+            if((null != replacement) && (null == partQuantity.get(replacement.getId()))) {", "originalCommit": "45f407c020714ed45a4a98d068aa42ea6350b5e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4NDkzOA==", "url": "https://github.com/MegaMek/mekhq/pull/2018#discussion_r490584938", "body": "```suggestion\r\n            Part replacement = ((MissingPart) nHsPart).findReplacement(true);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Part replacement = ((MissingPart)nHsPart).findReplacement(true);\n          \n          \n            \n                        Part replacement = ((MissingPart) nHsPart).findReplacement(true);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">Part</span> replacement <span class=\"pl-k\">=</span> ((<span class=\"pl-smi\">MissingPart</span>)nHsPart)<span class=\"pl-k\">.</span>findReplacement(<span class=\"pl-c1\">true</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">Part</span> replacement <span class=\"pl-k\">=</span> ((<span class=\"pl-smi\">MissingPart</span>)<span class=\"x x-first x-last\"> </span>nHsPart)<span class=\"pl-k\">.</span>findReplacement(<span class=\"pl-c1\">true</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-09-17T21:57:11Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -907,15 +906,40 @@ public void calculate() {\n             if (oldHS != newHS) {\n                 Part hsPart = heatSinkPart(newEntity); // only single HS allowed, so they have to be of the same type\n                 for (int i = oldHS; i < newHS; i++) {\n-                    newIntegratedHS.add(hsPart.clone());\n+                    // Heat sink added for supply chain tracking purposes and removed from refit later\n+                    newIntegratedHS.add(hsPart.clone().getMissingPart());\n                 }\n                 for (int i = newHS; i < oldHS; i++) {\n                     oldIntegratedHS.add(hsPart.clone());\n                 }\n             }\n         }\n         time += (oldIntegratedHS.size() + newIntegratedHS.size()) * 90;\n-        shoppingList.addAll(newIntegratedHS);\n+        for(Part nHsPart : newIntegratedHS) {\n+            // Check warehouse for spare heat sinks before adding to shopping list\n+            Part replacement = ((MissingPart)nHsPart).findReplacement(true);", "originalCommit": "45f407c020714ed45a4a98d068aa42ea6350b5e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4NTAwNQ==", "url": "https://github.com/MegaMek/mekhq/pull/2018#discussion_r490585005", "body": "```suggestion\r\n            if ((null != replacement) && (partQuantity.get(replacement.getId())) > 0) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if((null != replacement) && (partQuantity.get(replacement.getId())) > 0) {\n          \n          \n            \n                        if ((null != replacement) && (partQuantity.get(replacement.getId())) > 0) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span>((<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement) <span class=\"pl-k\">&amp;&amp;</span> (partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"pl-k\">.</span>getId())) <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span><span class=\"x x-first x-last\"> </span>((<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement) <span class=\"pl-k\">&amp;&amp;</span> (partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"pl-k\">.</span>getId())) <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-09-17T21:57:19Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -907,15 +906,40 @@ public void calculate() {\n             if (oldHS != newHS) {\n                 Part hsPart = heatSinkPart(newEntity); // only single HS allowed, so they have to be of the same type\n                 for (int i = oldHS; i < newHS; i++) {\n-                    newIntegratedHS.add(hsPart.clone());\n+                    // Heat sink added for supply chain tracking purposes and removed from refit later\n+                    newIntegratedHS.add(hsPart.clone().getMissingPart());\n                 }\n                 for (int i = newHS; i < oldHS; i++) {\n                     oldIntegratedHS.add(hsPart.clone());\n                 }\n             }\n         }\n         time += (oldIntegratedHS.size() + newIntegratedHS.size()) * 90;\n-        shoppingList.addAll(newIntegratedHS);\n+        for(Part nHsPart : newIntegratedHS) {\n+            // Check warehouse for spare heat sinks before adding to shopping list\n+            Part replacement = ((MissingPart)nHsPart).findReplacement(true);\n+            //check quantity\n+            if((null != replacement) && (null == partQuantity.get(replacement.getId()))) {\n+                partQuantity.put(replacement.getId(), replacement.getQuantity());\n+            }\n+            if((null != replacement) && (partQuantity.get(replacement.getId())) > 0) {", "originalCommit": "45f407c020714ed45a4a98d068aa42ea6350b5e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU4NTA3MA==", "url": "https://github.com/MegaMek/mekhq/pull/2018#discussion_r490585070", "body": "```suggestion\r\n                partQuantity.put(replacement.getId(), partQuantity.get(replacement.getId()) - 1);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            partQuantity.put(replacement.getId(), partQuantity.get(replacement.getId())-1);\n          \n          \n            \n                            partQuantity.put(replacement.getId(), partQuantity.get(replacement.getId()) - 1);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                partQuantity<span class=\"pl-k\">.</span>put(replacement<span class=\"pl-k\">.</span>getId(), partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"pl-k\">.</span>getId())<span class=\"pl-k x x-first x-last\">-</span><span class=\"pl-c1\">1</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                partQuantity<span class=\"pl-k\">.</span>put(replacement<span class=\"pl-k\">.</span>getId(), partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"pl-k\">.</span>getId())<span class=\"x x-first\"> </span><span class=\"pl-k x\">-</span><span class=\"x x-last\"> </span><span class=\"pl-c1\">1</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-09-17T21:57:28Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -907,15 +906,40 @@ public void calculate() {\n             if (oldHS != newHS) {\n                 Part hsPart = heatSinkPart(newEntity); // only single HS allowed, so they have to be of the same type\n                 for (int i = oldHS; i < newHS; i++) {\n-                    newIntegratedHS.add(hsPart.clone());\n+                    // Heat sink added for supply chain tracking purposes and removed from refit later\n+                    newIntegratedHS.add(hsPart.clone().getMissingPart());\n                 }\n                 for (int i = newHS; i < oldHS; i++) {\n                     oldIntegratedHS.add(hsPart.clone());\n                 }\n             }\n         }\n         time += (oldIntegratedHS.size() + newIntegratedHS.size()) * 90;\n-        shoppingList.addAll(newIntegratedHS);\n+        for(Part nHsPart : newIntegratedHS) {\n+            // Check warehouse for spare heat sinks before adding to shopping list\n+            Part replacement = ((MissingPart)nHsPart).findReplacement(true);\n+            //check quantity\n+            if((null != replacement) && (null == partQuantity.get(replacement.getId()))) {\n+                partQuantity.put(replacement.getId(), replacement.getQuantity());\n+            }\n+            if((null != replacement) && (partQuantity.get(replacement.getId())) > 0) {\n+                newUnitParts.add(replacement.getId());\n+                //adjust quantity\n+                partQuantity.put(replacement.getId(), partQuantity.get(replacement.getId())-1);", "originalCommit": "45f407c020714ed45a4a98d068aa42ea6350b5e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "03309dbf8f46910e840d753d89824ac1f5187667", "url": "https://github.com/MegaMek/mekhq/commit/03309dbf8f46910e840d753d89824ac1f5187667", "message": "style formatting fixes", "committedDate": "2020-09-17T23:29:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4MDI4Mw==", "url": "https://github.com/MegaMek/mekhq/pull/2018#discussion_r490680283", "body": "Can't this just be newHS.getMissingPart() ?", "bodyText": "Can't this just be newHS.getMissingPart() ?", "bodyHTML": "<p dir=\"auto\">Can't this just be newHS.getMissingPart() ?</p>", "author": "Windchild292", "createdAt": "2020-09-18T03:32:47Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -881,14 +878,16 @@ public void calculate() {\n                     oldIntegratedHS.add(oldHS.clone());\n                 }\n                 for (int i = 0; i < newCount - oldCount; i++) {\n-                    newIntegratedHS.add(oldHS.clone());\n+                    // Heat sink added for supply chain tracking purposes and removed from refit later\n+                    newIntegratedHS.add(newHS.clone().getMissingPart());", "originalCommit": "03309dbf8f46910e840d753d89824ac1f5187667", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "46ceeb4975d8a0d1775da40feb014f3e2476a870", "url": "https://github.com/MegaMek/mekhq/commit/46ceeb4975d8a0d1775da40feb014f3e2476a870", "message": "unnecessary clones", "committedDate": "2020-09-18T04:39:25Z", "type": "commit"}]}