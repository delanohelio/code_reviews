{"pr_number": 2105, "pr_title": "Avoid part ID references in Refits and elsewhere", "pr_author": "sixlettervariables", "pr_createdAt": "2020-10-03T20:46:15Z", "pr_url": "https://github.com/MegaMek/mekhq/pull/2105", "timeline": [{"oid": "4e039470304bbba97aa8ee7fb45339920b12c78b", "url": "https://github.com/MegaMek/mekhq/commit/4e039470304bbba97aa8ee7fb45339920b12c78b", "message": "Don't reference replacement parts by ID", "committedDate": "2020-10-04T19:25:15Z", "type": "commit"}, {"oid": "fa1c7570f0fe4c708a608fdc06049bd17fed0de7", "url": "https://github.com/MegaMek/mekhq/commit/fa1c7570f0fe4c708a608fdc06049bd17fed0de7", "message": "Don't merge parts which can't be merged", "committedDate": "2020-10-04T19:25:15Z", "type": "commit"}, {"oid": "04f474c18716b5c22e7ae1d8295871dab1aced2e", "url": "https://github.com/MegaMek/mekhq/commit/04f474c18716b5c22e7ae1d8295871dab1aced2e", "message": "Have Refit use part references rather than IDs", "committedDate": "2020-10-04T19:27:19Z", "type": "commit"}, {"oid": "7e807e174ec689e004f76e39bb3725cdd686636d", "url": "https://github.com/MegaMek/mekhq/commit/7e807e174ec689e004f76e39bb3725cdd686636d", "message": "Fix ammo and armor errors with cancelled refits", "committedDate": "2020-10-04T19:27:21Z", "type": "commit"}, {"oid": "6fd9a4dd390b1138942ac8b75a673d1bc63c91f6", "url": "https://github.com/MegaMek/mekhq/commit/6fd9a4dd390b1138942ac8b75a673d1bc63c91f6", "message": "Make campaign respect non-spare parts\n\n- Stage for AmmoBin not doing some campaign level work", "committedDate": "2020-10-04T19:27:21Z", "type": "commit"}, {"oid": "5df75cb0176fc774c1563c3f483978b01cdd3669", "url": "https://github.com/MegaMek/mekhq/commit/5df75cb0176fc774c1563c3f483978b01cdd3669", "message": "Don't use ammo reserved for refits", "committedDate": "2020-10-04T19:27:21Z", "type": "commit"}, {"oid": "bc97b7ce52a91b90670105f61b8e64278bf2feea", "url": "https://github.com/MegaMek/mekhq/commit/bc97b7ce52a91b90670105f61b8e64278bf2feea", "message": "Track ammo as a part on a refit", "committedDate": "2020-10-04T19:27:21Z", "type": "commit"}, {"oid": "88f5910fa9d3e9f870e4f93410e5249c8ffc9908", "url": "https://github.com/MegaMek/mekhq/commit/88f5910fa9d3e9f870e4f93410e5249c8ffc9908", "message": "Get closer to fixing ammo purchases for custom refits", "committedDate": "2020-10-04T20:26:33Z", "type": "commit"}, {"oid": "88f5910fa9d3e9f870e4f93410e5249c8ffc9908", "url": "https://github.com/MegaMek/mekhq/commit/88f5910fa9d3e9f870e4f93410e5249c8ffc9908", "message": "Get closer to fixing ammo purchases for custom refits", "committedDate": "2020-10-04T20:26:33Z", "type": "forcePushed"}, {"oid": "7a3dccbbb75f2ed0e57ec9a0d43865451cb36123", "url": "https://github.com/MegaMek/mekhq/commit/7a3dccbbb75f2ed0e57ec9a0d43865451cb36123", "message": "Minor improvements to Campaign w.r.t. parts and refits", "committedDate": "2020-10-04T21:06:28Z", "type": "commit"}, {"oid": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780", "url": "https://github.com/MegaMek/mekhq/commit/c813ca62eae3e3c42a7da2b7cc161ea7e775e780", "message": "Don't double the ammo we order", "committedDate": "2020-10-04T21:06:48Z", "type": "commit"}, {"oid": "a813ac22fa818f4926651115303b2c7bae26c8e6", "url": "https://github.com/MegaMek/mekhq/commit/a813ac22fa818f4926651115303b2c7bae26c8e6", "message": "Don't use part IDs when a part will do", "committedDate": "2020-10-04T21:22:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTY5OQ==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289699", "body": "```suggestion\r\n                && !p.isReservedForRefit() && !p.isReservedForReplacement()) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        && !p.isReservedForRefit() && !p.isReservedForReplacement()) {\n          \n          \n            \n                            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForRefit() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForReplacement()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first x-last\">    </span><span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForRefit() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForReplacement()) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:16:42Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1634,7 +1634,8 @@ public void addPart(Part p, int transitDays) {\n             p.setId(-1);\n             return;\n         }\n-        if ((null == p.getUnit()) && !p.hasParentPart()) {\n+        if ((null == p.getUnit()) && !p.hasParentPart()\n+            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "originalCommit": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTc0Mw==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289743", "body": "```suggestion\r\n                && !p.isReservedForRefit() && !p.isReservedForReplacement()) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        && !p.isReservedForRefit() && !p.isReservedForReplacement()) {\n          \n          \n            \n                            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForRefit() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForReplacement()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first x-last\">    </span><span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForRefit() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k\">!</span>p<span class=\"pl-k\">.</span>isReservedForReplacement()) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:17:11Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1746,7 +1747,8 @@ public void addPartWithoutId(Part p) {\n         // go ahead and check for existing parts because some version weren't\n         // properly collecting parts\n         Part mergedWith = null;\n-        if (!(p instanceof MissingPart) && null == p.getUnitId()) {\n+        if (!(p instanceof MissingPart) && (null == p.getUnitId())\n+            && !p.isReservedForRefit() && !p.isReservedForReplacement()) {", "originalCommit": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTc1NA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289754", "body": "```suggestion\r\n            // Go through each unit and its refits to see if the new armor should be updated\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Go through each unit and its refits to see if the new armorshould be updated\n          \n          \n            \n                        // Go through each unit and its refits to see if the new armor should be updated", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> Go through each unit and its refits to see if the new <span class=\"x x-first x-last\">armorshould</span> be updated</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-c\"><span class=\"pl-c\">//</span> Go through each unit and its refits to see if the new <span class=\"x x-first x-last\">armor should</span> be updated</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:17:21Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1773,39 +1775,19 @@ public void addPartWithoutId(Part p) {\n             parts.put(p.getId(), p);\n             MekHQ.triggerEvent(new PartNewEvent(p));\n         } else {\n-            // Go through each unit and its refits to see if the new armor ID should be updated\n+            // Go through each unit and its refits to see if the new armorshould be updated", "originalCommit": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI4OTk0NA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499289944", "body": "```suggestion\r\n                            Armor mergedArmor = (Armor) mergedWith;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        Armor mergedArmor = (Armor)mergedWith;\n          \n          \n            \n                                        Armor mergedArmor = (Armor) mergedWith;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                            <span class=\"pl-smi\">Armor</span> mergedArmor <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">Armor</span>)mergedWith;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                            <span class=\"pl-smi\">Armor</span> mergedArmor <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">Armor</span>)<span class=\"x x-first x-last\"> </span>mergedWith;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:19:32Z", "path": "MekHQ/src/mekhq/campaign/Campaign.java", "diffHunk": "@@ -1773,39 +1775,19 @@ public void addPartWithoutId(Part p) {\n             parts.put(p.getId(), p);\n             MekHQ.triggerEvent(new PartNewEvent(p));\n         } else {\n-            // Go through each unit and its refits to see if the new armor ID should be updated\n+            // Go through each unit and its refits to see if the new armorshould be updated\n             // CAW: I believe all other parts on a refit have a unit assigned to them.\n-            for (Unit u : getUnits()) {\n-                Refit r = u.getRefit();\n-                // If there is a refit and this part matches the new armor, update the ID\n-                if (null != r) {\n-                    if (mergedWith instanceof Armor\n-                        && r.getNewArmorSuppliesId() == p.getId()) {\n-                        MekHQ.getLogger().info(Campaign.class, \"addPartWithoutId\",\n-                            String.format(\"%s (%d) was merged with %s (%d) used in a refit for %s\", p.getName(),\n-                                p.getId(), mergedWith.getName(), mergedWith.getId(), u.getName()));\n-                        Armor mergedArmor = (Armor)mergedWith;\n-                        r.setNewArmorSupplies(mergedArmor);\n-                    } else {\n-                        List<Integer> ids = r.getOldUnitPartIds();\n-                        for (int ii = 0; ii < ids.size(); ++ii) {\n-                            int oid = ids.get(ii);\n-                            if (p.getId() == oid) {\n-                                MekHQ.getLogger().info(Campaign.class, \"addPartWithoutId\",\n-                                String.format(\"%s (%d) was merged with %s (%d) used in the old unit in a refit for %s\", p.getName(),\n-                                    p.getId(), mergedWith.getName(), mergedWith.getId(), u.getName()));\n-                                ids.set(ii, mergedWith.getId());\n-                            }\n-                        }\n-                        ids = r.getNewUnitPartIds();\n-                        for (int ii = 0; ii < ids.size(); ++ii) {\n-                            int nid = ids.get(ii);\n-                            if (p.getId() == nid) {\n-                                MekHQ.getLogger().info(Campaign.class, \"addPartWithoutId\",\n-                                String.format(\"%s (%d) was merged with %s (%d) used in the new unit in a refit for %s\", p.getName(),\n+            if (mergedWith instanceof Armor) {\n+                for (Unit u : getUnits()) {\n+                    Refit r = u.getRefit();\n+                    // If there is a refit and this part matches the new armor, update the armor entry\n+                    if (null != r) {\n+                        if (r.getNewArmorSupplies() == p) {\n+                            MekHQ.getLogger().info(\n+                                String.format(\"%s (%d) was merged with %s (%d) used in a refit for %s\", p.getName(),\n                                     p.getId(), mergedWith.getName(), mergedWith.getId(), u.getName()));\n-                                ids.set(ii, mergedWith.getId());\n-                            }\n+                            Armor mergedArmor = (Armor)mergedWith;", "originalCommit": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDIzNw==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290237", "body": "Tab vs Space formatting", "bodyText": "Tab vs Space formatting", "bodyHTML": "<p dir=\"auto\">Tab vs Space formatting</p>", "author": "Windchild292", "createdAt": "2020-10-04T21:22:54Z", "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "diffHunk": "@@ -161,12 +161,10 @@ public Part findReplacement(boolean refit) {\n \t\tPart bestPart = null;\n \n \t\t//check to see if we already have a replacement assigned\n-\t\tif(replacementId > -1) {\n-\t\t\tbestPart = campaign.getPart(replacementId);\n-\t\t\tif(null != bestPart) {\n-\t\t\t\treturn bestPart;\n-\t\t\t}\n-\t\t}\n+\t\tif (hasReplacementPart()) {\n+\t\t\treturn getReplacementPart();\n+        }\n+", "originalCommit": "c813ca62eae3e3c42a7da2b7cc161ea7e775e780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDQyNg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290426", "body": "```suggestion\r\n            MekHqXmlUtil.writeSimpleXmlTag(pw1, indent + 1, \"replacementId\", getReplacementPart().getId());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        pw1.println(MekHqXmlUtil.indentStr(indent+1)\n          \n          \n            \n                                +\"<replacementId>\"\n          \n          \n            \n                                + getReplacementPart().getId()\n          \n          \n            \n                                +\"</replacementId>\");\n          \n          \n            \n                        MekHqXmlUtil.writeSimpleXmlTag(pw1, indent + 1, \"replacementId\", getReplacementPart().getId());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            pw1<span class=\"pl-k\">.</span>println(<span class=\"pl-smi\">MekHqXmlUtil</span><span class=\"pl-k\">.</span>indentStr(indent<span class=\"pl-k\">+</span><span class=\"pl-c1\">1</span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">+</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>&lt;replacementId&gt;<span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">+</span> getReplacementPart()<span class=\"pl-k\">.</span>getId()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">+</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>&lt;/replacementId&gt;<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">MekHqXmlUtil</span><span class=\"pl-k\">.</span>writeSimpleXmlTag(pw1, indent <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1</span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>replacementId<span class=\"pl-pds\">\"</span></span>, getReplacementPart()<span class=\"pl-k\">.</span>getId());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:25:24Z", "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "diffHunk": "@@ -347,11 +345,13 @@ public void writeToXmlBegin(PrintWriter pw1, int indent) {\n \t\tpw1.println(MekHqXmlUtil.indentStr(indent+1)\n \t\t\t\t+\"<daysToWait>\"\n \t\t\t\t+daysToWait\n-\t\t\t\t+\"</daysToWait>\");\n-\t\tpw1.println(MekHqXmlUtil.indentStr(indent+1)\n-\t\t\t\t+\"<replacementId>\"\n-\t\t\t\t+replacementId\n-\t\t\t\t+\"</replacementId>\");\n+                +\"</daysToWait>\");\n+        if (hasReplacementPart()) {\n+            pw1.println(MekHqXmlUtil.indentStr(indent+1)\n+                    +\"<replacementId>\"\n+                    + getReplacementPart().getId()\n+                    +\"</replacementId>\");", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDQ2Mg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290462", "body": "```suggestion\r\n\t\tif (hasReplacementPart() && (null != replacement)) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (hasReplacementPart() && null != replacement) {\n          \n          \n            \n            \t\tif (hasReplacementPart() && (null != replacement)) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">\t\t<span class=\"pl-k\">if</span> (hasReplacementPart() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">\t\t<span class=\"pl-k\">if</span> (hasReplacementPart() <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first x-last\">(</span><span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement<span class=\"x x-first x-last\">)</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:26:02Z", "path": "MekHQ/src/mekhq/campaign/parts/MissingPart.java", "diffHunk": "@@ -402,29 +402,29 @@ public void reservePart() {\n \t\t//shouldn't be null, but it never hurts to check\n \t\tPart replacement = findReplacement(false);\n \t\tUUID teamId = getTeamId();\n-\t\tif(null != replacement && null != teamId) {\n-\t\t\tif(replacement.getQuantity() > 1) {\n+\t\tif ((null != replacement) &&(null != teamId)) {\n+\t\t\tif (replacement.getQuantity() > 1) {\n \t\t\t\tPart actualReplacement = replacement.clone();\n \t\t\t\tactualReplacement.setReserveId(teamId);\n-\t\t\t\tcampaign.addPart(actualReplacement, 0);\n-\t\t\t\treplacementId = actualReplacement.getId();\n+                campaign.addPart(actualReplacement, 0);\n+                setReplacementPart(actualReplacement);\n \t\t\t\treplacement.decrementQuantity();\n \t\t\t} else {\n-\t\t\t\treplacement.setReserveId(teamId);\n-\t\t\t\treplacementId = replacement.getId();\n+                replacement.setReserveId(teamId);\n+                setReplacementPart(replacement);\n \t\t\t}\n \t\t}\n \t}\n \n \t@Override\n \tpublic void cancelReservation() {\n \t\tPart replacement = findReplacement(false);\n-\t\tif(replacementId > -1 && null != replacement) {\n-\t\t\treplacementId = -1;\n+\t\tif (hasReplacementPart() && null != replacement) {", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDUyNg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290526", "body": "```suggestion\r\n                MekHQ.getLogger().error(\r\n                    String.format(\"Part %d ('%s') references missing replacement part %d\",\r\n                        getId(), getName(), id));\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            MekHQ.getLogger().error(PartRef.class,\n          \n          \n            \n                                String.format(\"Part %d ('%s') references missing replacement part %d\",\n          \n          \n            \n                                    getId(), getName(), id));\n          \n          \n            \n                            MekHQ.getLogger().error(\n          \n          \n            \n                                String.format(\"Part %d ('%s') references missing replacement part %d\",\n          \n          \n            \n                                    getId(), getName(), id));", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"1832\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(<span class=\"pl-smi x x-first\">PartRef</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">class,</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"1833\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Part %d ('%s') references missing replacement part %d<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"1834\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        getId(), getName(), id));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"1832\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"1833\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Part %d ('%s') references missing replacement part %d<span class=\"pl-pds\">\"</span></span>,</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"1834\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        getId(), getName(), id));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:26:48Z", "path": "MekHQ/src/mekhq/campaign/parts/Part.java", "diffHunk": "@@ -1783,6 +1823,16 @@ public SimpleTechLevel getStaticTechLevel() {\n     }\n \n     public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (replacementPart instanceof PartRef) {\n+            int id = replacementPart.getId();\n+            replacementPart = knownParts.get(id);\n+            if ((replacementPart == null) && (id > 0)) {\n+                MekHQ.getLogger().error(PartRef.class,\n+                    String.format(\"Part %d ('%s') references missing replacement part %d\",\n+                        getId(), getName(), id));", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89b73fcf6132c4789f68835de8e4400bae0ec178", "url": "https://github.com/MegaMek/mekhq/commit/89b73fcf6132c4789f68835de8e4400bae0ec178", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-10-04T21:43:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDgxOA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290818", "body": "```suggestion\r\n        converted = (int) Math.round((double) converted / curType.getRackSize());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    converted = (int)Math.round((double)converted/curType.getRackSize());\n          \n          \n            \n                    converted = (int) Math.round((double) converted / curType.getRackSize());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        converted <span class=\"pl-k\">=</span> (<span class=\"pl-k\">int</span>)<span class=\"pl-smi\">Math</span><span class=\"pl-k\">.</span>round((<span class=\"pl-k\">double</span>)converted<span class=\"pl-k x x-first x-last\">/</span>curType<span class=\"pl-k\">.</span>getRackSize());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        converted <span class=\"pl-k\">=</span> (<span class=\"pl-k\">int</span>)<span class=\"x x-first x-last\"> </span><span class=\"pl-smi\">Math</span><span class=\"pl-k\">.</span>round((<span class=\"pl-k\">double</span>)<span class=\"x x-first x-last\"> </span>converted<span class=\"x x-first\"> </span><span class=\"pl-k x\">/</span><span class=\"x x-last\"> </span>curType<span class=\"pl-k\">.</span>getRackSize());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:30:30Z", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -582,13 +582,17 @@ public void swapAmmoFromCompatible(int needed, AmmoStorage as) {\n                 }\n             }\n         }\n-        converted = Math.round((float)converted/curType.getRackSize());\n-        as.changeAmountAvailable(converted, curType);\n+        converted = (int)Math.round((double)converted/curType.getRackSize());", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDk0NA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290944", "body": "```suggestion\r\n        return getAmountAvailable(campaign, (AmmoType) getType());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return getAmountAvailable(campaign, (AmmoType)getType());\n          \n          \n            \n                    return getAmountAvailable(campaign, (AmmoType) getType());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> getAmountAvailable(campaign, (<span class=\"pl-smi\">AmmoType</span>)getType());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> getAmountAvailable(campaign, (<span class=\"pl-smi\">AmmoType</span>)<span class=\"x x-first x-last\"> </span>getType());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:31:49Z", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -684,38 +692,41 @@ public boolean isCompatibleAmmo(AmmoType a1, AmmoType a2) {\n     }\n \n     public int getAmountAvailable() {\n-        final AmmoType thisType = (AmmoType)getType();\n+        return getAmountAvailable(campaign, (AmmoType)getType());", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDk2OA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290968", "body": "```suggestion\r\n                               } else if (isCompatibleAmmo(campaign, aType, ammoType) && (ammoType.getRackSize() != 0)) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                           } else if (isCompatibleAmmo(campaign, aType, ammoType) && ammoType.getRackSize() != 0) {\n          \n          \n            \n                                           } else if (isCompatibleAmmo(campaign, aType, ammoType) && (ammoType.getRackSize() != 0)) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                               } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (isCompatibleAmmo(campaign, aType, ammoType) <span class=\"pl-k\">&amp;&amp;</span> ammoType<span class=\"pl-k\">.</span>getRackSize() <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                               } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (isCompatibleAmmo(campaign, aType, ammoType) <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first x-last\">(</span>ammoType<span class=\"pl-k\">.</span>getRackSize() <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">0</span><span class=\"x x-first x-last\">)</span>) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:32:07Z", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -684,38 +692,41 @@ public boolean isCompatibleAmmo(AmmoType a1, AmmoType a2) {\n     }\n \n     public int getAmountAvailable() {\n-        final AmmoType thisType = (AmmoType)getType();\n+        return getAmountAvailable(campaign, (AmmoType)getType());\n+    }\n+\n+    public static int getAmountAvailable(Campaign campaign, AmmoType ammoType) {\n         if (campaign.getCampaignOptions().useAmmoByType()) {\n             Predicate<Part> predicate;\n-            if (AmmoBin.ALLOWED_BY_TYPE.contains(thisType.getAmmoType())) {\n+            if (AmmoBin.ALLOWED_BY_TYPE.contains(ammoType.getAmmoType())) {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             } else {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equals(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equals(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             }\n             AmmoStorage a = (AmmoStorage) campaign.findSparePart(predicate);\n             return a != null ? a.getShots() : 0;\n         } else {\n             return campaign.streamSpareParts()\n-                            .filter(part -> part instanceof AmmoStorage && part.isPresent())\n-                            .mapToInt(part -> {\n-                                AmmoStorage a = (AmmoStorage)part;\n-                                AmmoType aType = (AmmoType)a.getType();\n-                                if (aType.equals(getType()) && thisType.getMunitionType() == aType.getMunitionType()) {\n-                                    return a.getShots();\n-                                } else if (isCompatibleAmmo(aType, thisType) && thisType.getRackSize() != 0) {\n-                                    return (a.getShots() * aType.getRackSize()) / thisType.getRackSize();\n-                                }\n-                                return 0;\n-                            })\n-                            .sum();\n+                           .filter(part -> part instanceof AmmoStorage && part.isPresent())\n+                           .mapToInt(part -> {\n+                               AmmoStorage a = (AmmoStorage)part;\n+                               AmmoType aType = (AmmoType)a.getType();\n+                               if (aType.equals(ammoType) && ammoType.getMunitionType() == aType.getMunitionType()) {\n+                                   return a.getShots();\n+                               } else if (isCompatibleAmmo(campaign, aType, ammoType) && ammoType.getRackSize() != 0) {", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MDk4NQ==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499290985", "body": "```suggestion\r\n                               if (aType.equals(ammoType) && (ammoType.getMunitionType() == aType.getMunitionType())) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                           if (aType.equals(ammoType) && ammoType.getMunitionType() == aType.getMunitionType()) {\n          \n          \n            \n                                           if (aType.equals(ammoType) && (ammoType.getMunitionType() == aType.getMunitionType())) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                               <span class=\"pl-k\">if</span> (aType<span class=\"pl-k\">.</span>equals(ammoType) <span class=\"pl-k\">&amp;&amp;</span> ammoType<span class=\"pl-k\">.</span>getMunitionType() <span class=\"pl-k\">==</span> aType<span class=\"pl-k\">.</span>getMunitionType()) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                               <span class=\"pl-k\">if</span> (aType<span class=\"pl-k\">.</span>equals(ammoType) <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first x-last\">(</span>ammoType<span class=\"pl-k\">.</span>getMunitionType() <span class=\"pl-k\">==</span> aType<span class=\"pl-k\">.</span>getMunitionType(<span class=\"x x-first x-last\">)</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T21:32:16Z", "path": "MekHQ/src/mekhq/campaign/parts/equipment/AmmoBin.java", "diffHunk": "@@ -684,38 +692,41 @@ public boolean isCompatibleAmmo(AmmoType a1, AmmoType a2) {\n     }\n \n     public int getAmountAvailable() {\n-        final AmmoType thisType = (AmmoType)getType();\n+        return getAmountAvailable(campaign, (AmmoType)getType());\n+    }\n+\n+    public static int getAmountAvailable(Campaign campaign, AmmoType ammoType) {\n         if (campaign.getCampaignOptions().useAmmoByType()) {\n             Predicate<Part> predicate;\n-            if (AmmoBin.ALLOWED_BY_TYPE.contains(thisType.getAmmoType())) {\n+            if (AmmoBin.ALLOWED_BY_TYPE.contains(ammoType.getAmmoType())) {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equalsAmmoTypeOnly(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             } else {\n                 predicate = part -> {\n                     return part instanceof AmmoStorage\n-                            && thisType.equals(((AmmoStorage) part).getType())\n-                            && thisType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n+                            && ammoType.equals(((AmmoStorage) part).getType())\n+                            && ammoType.getMunitionType() == ((AmmoType) ((AmmoStorage) part).getType()).getMunitionType();\n                 };\n             }\n             AmmoStorage a = (AmmoStorage) campaign.findSparePart(predicate);\n             return a != null ? a.getShots() : 0;\n         } else {\n             return campaign.streamSpareParts()\n-                            .filter(part -> part instanceof AmmoStorage && part.isPresent())\n-                            .mapToInt(part -> {\n-                                AmmoStorage a = (AmmoStorage)part;\n-                                AmmoType aType = (AmmoType)a.getType();\n-                                if (aType.equals(getType()) && thisType.getMunitionType() == aType.getMunitionType()) {\n-                                    return a.getShots();\n-                                } else if (isCompatibleAmmo(aType, thisType) && thisType.getRackSize() != 0) {\n-                                    return (a.getShots() * aType.getRackSize()) / thisType.getRackSize();\n-                                }\n-                                return 0;\n-                            })\n-                            .sum();\n+                           .filter(part -> part instanceof AmmoStorage && part.isPresent())\n+                           .mapToInt(part -> {\n+                               AmmoStorage a = (AmmoStorage)part;\n+                               AmmoType aType = (AmmoType)a.getType();\n+                               if (aType.equals(ammoType) && ammoType.getMunitionType() == aType.getMunitionType()) {", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzM5Mg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293392", "body": "```suggestion\r\n                if ((null != replacement) && (null == partQuantity.get(replacement))) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (null != replacement && null == partQuantity.get(replacement)) {\n          \n          \n            \n                            if ((null != replacement) && (null == partQuantity.get(replacement))) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">if</span> (<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> partQuantity<span class=\"pl-k\">.</span>get(replacement)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">if</span> (<span class=\"x x-first x-last\">(</span><span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement<span class=\"x x-first x-last\">)</span> <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first x-last\">(</span><span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"x x-first x-last\">)</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:00:35Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -508,15 +503,15 @@ public void calculate() {\n                 Part replacement = ((MissingPart)nPart).findReplacement(true);\n                 //check quantity\n                 //TODO: the one weakness here is that we will not pick up damaged parts\n-                if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                    partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                if (null != replacement && null == partQuantity.get(replacement)) {", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzQyMQ==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293421", "body": "```suggestion\r\n\r\n                if ((null != replacement) && (partQuantity.get(replacement) > 0)) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (null != replacement && partQuantity.get(replacement) > 0) {\n          \n          \n            \n            \n          \n          \n            \n                            if ((null != replacement) && (partQuantity.get(replacement) > 0)) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">                </span><span class=\"pl-k x\">if</span><span class=\"x\"> (</span><span class=\"pl-c1 x\">null</span><span class=\"x\"> </span><span class=\"pl-k x\">!=</span><span class=\"x\"> replacement </span><span class=\"pl-k x\">&amp;&amp;</span><span class=\"x\"> partQuantity</span><span class=\"pl-k x\">.</span><span class=\"x\">get(replacement) </span><span class=\"pl-k x\">&gt;</span><span class=\"x\"> </span><span class=\"pl-c1 x\">0</span><span class=\"x x-last\">) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">if</span> ((<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement) <span class=\"pl-k\">&amp;&amp;</span> (partQuantity<span class=\"pl-k\">.</span>get(replacement) <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:00:51Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -508,15 +503,15 @@ public void calculate() {\n                 Part replacement = ((MissingPart)nPart).findReplacement(true);\n                 //check quantity\n                 //TODO: the one weakness here is that we will not pick up damaged parts\n-                if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                    partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                if (null != replacement && null == partQuantity.get(replacement)) {\n+                    partQuantity.put(replacement, replacement.getQuantity());\n                 }\n-                if (null != replacement && partQuantity.get(replacement.getId()) > 0) {\n-                    newUnitParts.add(replacement.getId());\n+                if (null != replacement && partQuantity.get(replacement) > 0) {", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzQ1OQ==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293459", "body": "```suggestion\r\n                    partQuantity.put(replacement, partQuantity.get(replacement) - 1);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                partQuantity.put(replacement, partQuantity.get(replacement)-1);\n          \n          \n            \n                                partQuantity.put(replacement, partQuantity.get(replacement) - 1);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    partQuantity<span class=\"pl-k\">.</span>put(replacement, partQuantity<span class=\"pl-k\">.</span>get(replacement)<span class=\"pl-k x x-first x-last\">-</span><span class=\"pl-c1\">1</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    partQuantity<span class=\"pl-k\">.</span>put(replacement, partQuantity<span class=\"pl-k\">.</span>get(replacement)<span class=\"x x-first\"> </span><span class=\"pl-k x\">-</span><span class=\"x x-last\"> </span><span class=\"pl-c1\">1</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:01:19Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -508,15 +503,15 @@ public void calculate() {\n                 Part replacement = ((MissingPart)nPart).findReplacement(true);\n                 //check quantity\n                 //TODO: the one weakness here is that we will not pick up damaged parts\n-                if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                    partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                if (null != replacement && null == partQuantity.get(replacement)) {\n+                    partQuantity.put(replacement, replacement.getQuantity());\n                 }\n-                if (null != replacement && partQuantity.get(replacement.getId()) > 0) {\n-                    newUnitParts.add(replacement.getId());\n+                if (null != replacement && partQuantity.get(replacement) > 0) {\n+                    newUnitParts.add(replacement);\n                     //adjust quantity\n-                    partQuantity.put(replacement.getId(), partQuantity.get(replacement.getId())-1);\n+                    partQuantity.put(replacement, partQuantity.get(replacement)-1);", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzQ4MA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293480", "body": "```suggestion\r\n                    if ((null != replacement) && (null == partQuantity.get(replacement))) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (null != replacement && null == partQuantity.get(replacement)) {\n          \n          \n            \n                                if ((null != replacement) && (null == partQuantity.get(replacement))) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-k\">if</span> (<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> partQuantity<span class=\"pl-k\">.</span>get(replacement)) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-k\">if</span> (<span class=\"x x-first x-last\">(</span><span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement<span class=\"x x-first x-last\">)</span> <span class=\"pl-k\">&amp;&amp;</span> <span class=\"x x-first x-last\">(</span><span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> partQuantity<span class=\"pl-k\">.</span>get(replacement<span class=\"x x-first x-last\">)</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:01:41Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -554,15 +549,15 @@ public void calculate() {\n                     Part replacement = mab.findReplacement(true);\n                     //check quantity\n                     //TODO: the one weakness here is that we will not pick up damaged parts\n-                    if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                        partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                    if (null != replacement && null == partQuantity.get(replacement)) {", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzUwOQ==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293509", "body": "```suggestion\r\n\r\n                    if ((null != replacement) && (partQuantity.get(replacement) > 0)) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (null != replacement && partQuantity.get(replacement) > 0) {\n          \n          \n            \n            \n          \n          \n            \n                                if ((null != replacement) && (partQuantity.get(replacement) > 0)) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"><span class=\"x x-first\">                    </span><span class=\"pl-k x\">if</span><span class=\"x\"> (</span><span class=\"pl-c1 x\">null</span><span class=\"x\"> </span><span class=\"pl-k x\">!=</span><span class=\"x\"> replacement </span><span class=\"pl-k x\">&amp;&amp;</span><span class=\"x\"> partQuantity</span><span class=\"pl-k x\">.</span><span class=\"x\">get(replacement) </span><span class=\"pl-k x\">&gt;</span><span class=\"x\"> </span><span class=\"pl-c1 x\">0</span><span class=\"x x-last\">) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-k\">if</span> ((<span class=\"pl-c1\">null</span> <span class=\"pl-k\">!=</span> replacement) <span class=\"pl-k\">&amp;&amp;</span> (partQuantity<span class=\"pl-k\">.</span>get(replacement) <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>)) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:01:59Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -554,15 +549,15 @@ public void calculate() {\n                     Part replacement = mab.findReplacement(true);\n                     //check quantity\n                     //TODO: the one weakness here is that we will not pick up damaged parts\n-                    if (null != replacement && null == partQuantity.get(replacement.getId())) {\n-                        partQuantity.put(replacement.getId(), replacement.getQuantity());\n+                    if (null != replacement && null == partQuantity.get(replacement)) {\n+                        partQuantity.put(replacement, replacement.getQuantity());\n                     }\n-                    if (null != replacement && partQuantity.get(replacement.getId()) > 0) {\n-                        newUnitParts.add(replacement.getId());\n+                    if (null != replacement && partQuantity.get(replacement) > 0) {", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzcwNw==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293707", "body": "```suggestion\r\n            && ((null == newArmorSupplies) || (armorNeeded - newArmorSupplies.getAmount()) <= 0);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        && (null == newArmorSupplies || (armorNeeded - newArmorSupplies.getAmount()) <= 0);\n          \n          \n            \n                        && ((null == newArmorSupplies) || (armorNeeded - newArmorSupplies.getAmount()) <= 0);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">&amp;&amp;</span> (<span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> newArmorSupplies <span class=\"pl-k\">||</span> (armorNeeded <span class=\"pl-k\">-</span> newArmorSupplies<span class=\"pl-k\">.</span>getAmount()) <span class=\"pl-k\">&lt;=</span> <span class=\"pl-c1\">0</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">&amp;&amp;</span> (<span class=\"x x-first x-last\">(</span><span class=\"pl-c1\">null</span> <span class=\"pl-k\">==</span> newArmorSupplies<span class=\"x x-first x-last\">)</span> <span class=\"pl-k\">||</span> (armorNeeded <span class=\"pl-k\">-</span> newArmorSupplies<span class=\"pl-k\">.</span>getAmount()) <span class=\"pl-k\">&lt;=</span> <span class=\"pl-c1\">0</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:04:43Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1214,7 +1224,8 @@ public boolean acquireParts() {\n             return false;\n         }\n \n-        return shoppingList.size() == 0 && !missingAmmo && (null == newArmorSupplies || (armorNeeded - newArmorSupplies.getAmount()) <= 0);\n+        return shoppingList.size() == 0\n+            && (null == newArmorSupplies || (armorNeeded - newArmorSupplies.getAmount()) <= 0);", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzczMg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293732", "body": "```suggestion\r\n                AmmoStorage ammoStorage = (AmmoStorage) part;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage)part;\n          \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage) part;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi\">AmmoStorage</span> ammoStorage <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">AmmoStorage</span>)part;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">AmmoStorage</span> ammoStorage <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">AmmoStorage</span>)<span class=\"x x-first x-last\"> </span>part;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:04:56Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1276,13 +1275,20 @@ private void updateRefitClass(int rClass) {\n \n     public void cancel() {\n         oldUnit.setRefit(null);\n-        for (int pid : newUnitParts) {\n-            Part part = oldUnit.getCampaign().getPart(pid);\n-            if (null == part) {\n-                MekHQ.getLogger().error(this, \"part with id \" + pid + \" not found for refit of \" + getDesc());\n-                continue;\n+\n+        // Return our reserved ammo back to the campaign\n+        for (Part part : newUnitParts) {\n+            if (part instanceof AmmoStorage) {\n+                // merge back into the campaign\n+                AmmoStorage ammoStorage = (AmmoStorage)part;", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5Mzc3Mg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293772", "body": "```suggestion\r\n                AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType) ammoStorage.getType());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());\n          \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType) ammoStorage.getType());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi\">AmmoBin</span><span class=\"pl-k\">.</span>changeAmountAvailable(campaign, ammoStorage<span class=\"pl-k\">.</span>getShots(), (<span class=\"pl-smi\">AmmoType</span>)ammoStorage<span class=\"pl-k\">.</span>getType());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">AmmoBin</span><span class=\"pl-k\">.</span>changeAmountAvailable(campaign, ammoStorage<span class=\"pl-k\">.</span>getShots(), (<span class=\"pl-smi\">AmmoType</span>)<span class=\"x x-first x-last\"> </span>ammoStorage<span class=\"pl-k\">.</span>getType());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:05:04Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1276,13 +1275,20 @@ private void updateRefitClass(int rClass) {\n \n     public void cancel() {\n         oldUnit.setRefit(null);\n-        for (int pid : newUnitParts) {\n-            Part part = oldUnit.getCampaign().getPart(pid);\n-            if (null == part) {\n-                MekHQ.getLogger().error(this, \"part with id \" + pid + \" not found for refit of \" + getDesc());\n-                continue;\n+\n+        // Return our reserved ammo back to the campaign\n+        for (Part part : newUnitParts) {\n+            if (part instanceof AmmoStorage) {\n+                // merge back into the campaign\n+                AmmoStorage ammoStorage = (AmmoStorage)part;\n+                AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5MzgxOQ==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499293819", "body": "```suggestion\r\n                AmmoStorage ammoStorage = (AmmoStorage) part;\r\n                AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType) ammoStorage.getType());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage)part;\n          \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());\n          \n          \n            \n                            AmmoStorage ammoStorage = (AmmoStorage) part;\n          \n          \n            \n                            AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType) ammoStorage.getType());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi\">AmmoStorage</span> ammoStorage <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">AmmoStorage</span>)part;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi\">AmmoBin</span><span class=\"pl-k\">.</span>changeAmountAvailable(campaign, ammoStorage<span class=\"pl-k\">.</span>getShots(), (<span class=\"pl-smi\">AmmoType</span>)ammoStorage<span class=\"pl-k\">.</span>getType());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">AmmoStorage</span> ammoStorage <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">AmmoStorage</span>)<span class=\"x x-first x-last\"> </span>part;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">AmmoBin</span><span class=\"pl-k\">.</span>changeAmountAvailable(campaign, ammoStorage<span class=\"pl-k\">.</span>getShots(), (<span class=\"pl-smi\">AmmoType</span>)<span class=\"x x-first x-last\"> </span>ammoStorage<span class=\"pl-k\">.</span>getType());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:05:42Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -1465,6 +1458,12 @@ else if ((part instanceof AeroHeatSink) && (newEntity instanceof Aero) && !part.\n                     oldUnit.getCampaign().removePart(part);\n                     continue;\n                 }\n+            } else if (part instanceof AmmoStorage) {\n+                // merge back into the campaign before completing the refit\n+                AmmoStorage ammoStorage = (AmmoStorage)part;\n+                AmmoBin.changeAmountAvailable(campaign, ammoStorage.getShots(), (AmmoType)ammoStorage.getType());", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDAwMA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294000", "body": "```suggestion\r\n                newArmorSupplies = (Armor) realPart;\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            newArmorSupplies = (Armor)realPart;\n          \n          \n            \n                            newArmorSupplies = (Armor) realPart;", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                newArmorSupplies <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">Armor</span>)realPart;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                newArmorSupplies <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">Armor</span>)<span class=\"x x-first x-last\"> </span>realPart;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:08:20Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDAxMg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294012", "body": "```suggestion\r\n                MekHQ.getLogger().error(\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            MekHQ.getLogger().error(RefitArmorRef.class,\n          \n          \n            \n                            MekHQ.getLogger().error(", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(<span class=\"pl-smi x x-first\">RefitArmorRef</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">class,</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:08:27Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDAzMA==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294030", "body": "```suggestion\r\n                    MekHQ.getLogger().error(\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                MekHQ.getLogger().error(RefitPartRef.class,\n          \n          \n            \n                                MekHQ.getLogger().error(", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(<span class=\"pl-smi x x-first\">RefitPartRef</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">class,</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:08:40Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,\n+                    String.format(\"Refit %s (Unit: %s) references missing armor supplies %d\",\n+                        getRefitId(), getUnitId(), newArmorSupplies.getId()));\n+                newArmorSupplies = null;\n+            }\n+        }\n+\n+        for (int ii = oldUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = oldUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    oldUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDA1MQ==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294051", "body": "```suggestion\r\n                    MekHQ.getLogger().error(\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                MekHQ.getLogger().error(RefitPartRef.class,\n          \n          \n            \n                                MekHQ.getLogger().error(", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(<span class=\"pl-smi x x-first\">RefitPartRef</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">class,</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:08:55Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,\n+                    String.format(\"Refit %s (Unit: %s) references missing armor supplies %d\",\n+                        getRefitId(), getUnitId(), newArmorSupplies.getId()));\n+                newArmorSupplies = null;\n+            }\n+        }\n+\n+        for (int ii = oldUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = oldUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    oldUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,\n+                        String.format(\"Refit %s (Unit: %s) references missing old unit part %d\",\n+                            getRefitId(), getUnitId(), part.getId()));\n+                    oldUnitParts.remove(ii);\n+                }\n+            }\n+        }\n+\n+        for (int ii = newUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = newUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    newUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI5NDA2Mg==", "url": "https://github.com/MegaMek/mekhq/pull/2105#discussion_r499294062", "body": "```suggestion\r\n                    MekHQ.getLogger().error(\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                MekHQ.getLogger().error(RefitPartRef.class,\n          \n          \n            \n                                MekHQ.getLogger().error(", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(<span class=\"pl-smi x x-first\">RefitPartRef</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">class,</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"pl-smi\">MekHQ</span><span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>error(</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "Windchild292", "createdAt": "2020-10-04T22:09:07Z", "path": "MekHQ/src/mekhq/campaign/parts/Refit.java", "diffHunk": "@@ -2589,4 +2581,166 @@ public boolean isIntroducedBy(int year, boolean clan, int techFaction) {\n     public boolean isExtinctIn(int year, boolean clan, int techFaction) {\n         return isExtinct(year, clan, techFaction);\n     }\n+\n+    @Override\n+    public void fixupPartReferences(Map<Integer, Part> knownParts) {\n+        if (newArmorSupplies instanceof RefitArmorRef) {\n+            Part realPart = knownParts.get(newArmorSupplies.getId());\n+            if (realPart instanceof Armor) {\n+                newArmorSupplies = (Armor)realPart;\n+            } else {\n+                MekHQ.getLogger().error(RefitArmorRef.class,\n+                    String.format(\"Refit %s (Unit: %s) references missing armor supplies %d\",\n+                        getRefitId(), getUnitId(), newArmorSupplies.getId()));\n+                newArmorSupplies = null;\n+            }\n+        }\n+\n+        for (int ii = oldUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = oldUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    oldUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,\n+                        String.format(\"Refit %s (Unit: %s) references missing old unit part %d\",\n+                            getRefitId(), getUnitId(), part.getId()));\n+                    oldUnitParts.remove(ii);\n+                }\n+            }\n+        }\n+\n+        for (int ii = newUnitParts.size() - 1; ii >= 0; --ii) {\n+            Part part = newUnitParts.get(ii);\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                if (realPart != null) {\n+                    newUnitParts.set(ii, realPart);\n+                } else if (part.getId() > 0) {\n+                    MekHQ.getLogger().error(RefitPartRef.class,\n+                        String.format(\"Refit %s (Unit: %s) references missing new unit part %d\",\n+                            getRefitId(), getUnitId(), part.getId()));\n+                    newUnitParts.remove(ii);\n+                }\n+            }\n+        }\n+\n+        List<Part> realParts = new ArrayList<>();\n+        Iterator<Part> it = lcBinsToChange.iterator();\n+        while (it.hasNext()) {\n+            Part part = it.next();\n+            if (part instanceof RefitPartRef) {\n+                Part realPart = knownParts.get(part.getId());\n+                it.remove();\n+                if (realPart != null) {\n+                    realParts.add(realPart);\n+                } else {\n+                    MekHQ.getLogger().error(RefitPartRef.class,", "originalCommit": "a813ac22fa818f4926651115303b2c7bae26c8e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "407bad67e01c0d3483e5cc23025f4043c2634fef", "url": "https://github.com/MegaMek/mekhq/commit/407bad67e01c0d3483e5cc23025f4043c2634fef", "message": "Apply suggestions from code review\n\nCo-authored-by: Justin Bowen <39067288+Windchild292@users.noreply.github.com>", "committedDate": "2020-10-05T02:22:50Z", "type": "commit"}, {"oid": "882a7efc10b211821ddcdab1e09aed00268f3922", "url": "https://github.com/MegaMek/mekhq/commit/882a7efc10b211821ddcdab1e09aed00268f3922", "message": "Fix space vs tabs", "committedDate": "2020-10-05T18:12:04Z", "type": "commit"}, {"oid": "7e8b82f1215558b045ed983d9aa288f829adb6e5", "url": "https://github.com/MegaMek/mekhq/commit/7e8b82f1215558b045ed983d9aa288f829adb6e5", "message": "Merge remote-tracking branch 'upstream/master' into avoid-part-id-references", "committedDate": "2020-10-05T18:14:16Z", "type": "commit"}]}