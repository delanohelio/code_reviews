{"pr_number": 1899, "pr_title": "added ChirpStack lora provider", "pr_author": "BobClaerhout", "pr_createdAt": "2020-04-14T13:27:11Z", "pr_url": "https://github.com/eclipse/hono/pull/1899", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4Mzc4Mg==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r408683782", "body": "I do not think that you started working on this last year, did you? ;-)", "bodyText": "I do not think that you started working on this last year, did you? ;-)", "bodyHTML": "<p dir=\"auto\">I do not think that you started working on this last year, did you? ;-)</p>", "author": "sophokles73", "createdAt": "2020-04-15T08:52:10Z", "path": "adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation", "originalCommit": "ea50d79ed465cf813cfb68942a2284c43d2146bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f499cf891bfbf7e516888b22d185cd2c745e45bb", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 9c2a4ced0..0c65512d2 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -1,5 +1,5 @@\n /*******************************************************************************\n- * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n  *\n  * See the NOTICE file(s) distributed with this work for additional\n  * information regarding copyright ownership.\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NTkxNg==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r408685916", "body": "this should throw `LoraProviderMalformedPayloadException` if the device ID cannot be extracted", "bodyText": "this should throw LoraProviderMalformedPayloadException if the device ID cannot be extracted", "bodyHTML": "<p dir=\"auto\">this should throw <code>LoraProviderMalformedPayloadException</code> if the device ID cannot be extracted</p>", "author": "sophokles73", "createdAt": "2020-04-15T08:55:41Z", "path": "adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.adapter.lora.providers;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.hono.adapter.lora.LoraConstants;\n+import org.eclipse.hono.adapter.lora.LoraMessageType;\n+import org.springframework.stereotype.Component;\n+\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A LoRaWAN provider with API for ChirpStack.\n+ */\n+@Component\n+public class ChirpStackProvider implements LoraProvider {\n+\n+    private static final String FIELD_CHIRPSTACK_PAYLOAD = \"data\";\n+    private static final String FIELD_CHIRPSTACK_DEVICE = \"devEUI\";\n+    private static final String FIELD_CHIRPSTACK_TX_INFO = \"txInfo\";\n+    private static final String FIELD_CHIRPSTACK_SPREADING_FACTOR = \"spreadingFactor\";\n+    private static final String FIELD_CHIRPSTACK_BANDWIDTH = \"bandwidth\";\n+    private static final String FIELD_CHIRPSTACK_FUNCTION_PORT = \"fPort\";\n+    private static final String FIELD_CHIRPSTACK_CODE_RATE = \"codeRate\";\n+    private static final String FIELD_CHIRPSTACK_LORA_MODULATION_INFO = \"loRaModulationInfo\";\n+    private static final String FIELD_CHIRPSTACK_FREQUENCY = \"frequency\";\n+    private static final String FIELD_CHIRPSTACK_FRAME_COUNT = \"fCnt\";\n+    private static final String FIELD_CHIRPSTACK_RX_INFO = \"rxInfo\";\n+    private static final String FIELD_CHIRPSTACK_GATEWAY_ID = \"gatewayID\";\n+    private static final String FIELD_CHIRPSTACK_RSSI = \"rssi\";\n+    private static final String FIELD_CHIRPSTACK_LSNR = \"loRaSNR\";\n+    private static final String FIELD_CHIRPSTACK_CHANNEL = \"channel\";\n+    private static final String FIELD_CHIRPSTACK_LOCATION = \"location\";\n+    private static final String FIELD_CHIRPSTACK_LATITUDE = \"latitude\";\n+    private static final String FIELD_CHIRPSTACK_LONGITUDE = \"longitude\";\n+\n+    @Override\n+    public String getProviderName() {\n+        return \"chirpStack\";\n+    }\n+\n+    @Override\n+    public String pathPrefix() {\n+        return \"/chirpstack\";\n+    }\n+\n+    @Override\n+    public String extractDeviceId(final JsonObject loraMessage) {\n+        return loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);", "originalCommit": "ea50d79ed465cf813cfb68942a2284c43d2146bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTMzNzY3Nw==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r409337677", "bodyText": "ok, first thing I've heard from it.", "author": "BobClaerhout", "createdAt": "2020-04-16T07:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NTkxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3NDcyNg==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r409574726", "bodyText": "this is defined by the LoraProvider interface ...", "author": "sophokles73", "createdAt": "2020-04-16T13:54:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NTkxNg=="}], "type": "inlineReview", "revised_code": {"commit": "f499cf891bfbf7e516888b22d185cd2c745e45bb", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 9c2a4ced0..0c65512d2 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -60,12 +60,21 @@ public class ChirpStackProvider implements LoraProvider {\n \n     @Override\n     public String extractDeviceId(final JsonObject loraMessage) {\n-        return loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+        final String deviceId = loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+        if (deviceId == null) {\n+            throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n+        }\n+\n+        return deviceId;\n     }\n \n     @Override\n     public String extractPayload(final JsonObject loraMessage) {\n-        return loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+        final String payload = loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+        if (payload == null){\n+            throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message.\", null);\n+        }\n+        return payload;\n     }\n \n     @Override\n", "next_change": {"commit": "2b20fbf6041c18926b65abd7f8b74af7360af1a5", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 0c65512d2..08d670a84 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -65,13 +65,13 @@ public class ChirpStackProvider implements LoraProvider {\n             throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n         }\n \n-        return deviceId;\n+        return LoraUtils.convertFromBase64ToHex(deviceId);\n     }\n \n     @Override\n     public String extractPayload(final JsonObject loraMessage) {\n         final String payload = loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n-        if (payload == null){\n+        if (payload == null) {\n             throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message.\", null);\n         }\n         return payload;\n", "next_change": {"commit": "9643b06a859c5c4953ccf2c6db171cf64b84df32", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 08d670a84..fa1a48ca9 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -60,21 +60,29 @@ public class ChirpStackProvider implements LoraProvider {\n \n     @Override\n     public String extractDeviceId(final JsonObject loraMessage) {\n-        final String deviceId = loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+        final Object deviceId = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\n         if (deviceId == null) {\n             throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n         }\n+        if (deviceId instanceof String) {\n+            return LoraUtils.convertFromBase64ToHex((String) deviceId);\n+        }\n \n-        return LoraUtils.convertFromBase64ToHex(deviceId);\n+        return null;\n     }\n \n     @Override\n     public String extractPayload(final JsonObject loraMessage) {\n-        final String payload = loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+        final Object payload = loraMessage.getValue(FIELD_CHIRPSTACK_PAYLOAD);\n         if (payload == null) {\n             throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message.\", null);\n         }\n-        return payload;\n+\n+        if (payload instanceof String) {\n+            return (String) payload;\n+        }\n+\n+        return null;\n     }\n \n     @Override\n", "next_change": {"commit": "6ffa383c0033b450361ed0db2e9995b14f82a6c7", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex fa1a48ca9..432d3ebac 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -82,7 +83,8 @@ public class ChirpStackProvider implements LoraProvider {\n             return (String) payload;\n         }\n \n-        return null;\n+        throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message. Expected \" +\n+                \"string, got \" + payload.getClass().getName(), null);\n     }\n \n     @Override\n", "next_change": null}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NjAzNQ==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r408686035", "body": "this should throw `LoraProviderMalformedPayloadException` if the payload cannot be extracted", "bodyText": "this should throw LoraProviderMalformedPayloadException if the payload cannot be extracted", "bodyHTML": "<p dir=\"auto\">this should throw <code>LoraProviderMalformedPayloadException</code> if the payload cannot be extracted</p>", "author": "sophokles73", "createdAt": "2020-04-15T08:55:51Z", "path": "adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.adapter.lora.providers;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.hono.adapter.lora.LoraConstants;\n+import org.eclipse.hono.adapter.lora.LoraMessageType;\n+import org.springframework.stereotype.Component;\n+\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A LoRaWAN provider with API for ChirpStack.\n+ */\n+@Component\n+public class ChirpStackProvider implements LoraProvider {\n+\n+    private static final String FIELD_CHIRPSTACK_PAYLOAD = \"data\";\n+    private static final String FIELD_CHIRPSTACK_DEVICE = \"devEUI\";\n+    private static final String FIELD_CHIRPSTACK_TX_INFO = \"txInfo\";\n+    private static final String FIELD_CHIRPSTACK_SPREADING_FACTOR = \"spreadingFactor\";\n+    private static final String FIELD_CHIRPSTACK_BANDWIDTH = \"bandwidth\";\n+    private static final String FIELD_CHIRPSTACK_FUNCTION_PORT = \"fPort\";\n+    private static final String FIELD_CHIRPSTACK_CODE_RATE = \"codeRate\";\n+    private static final String FIELD_CHIRPSTACK_LORA_MODULATION_INFO = \"loRaModulationInfo\";\n+    private static final String FIELD_CHIRPSTACK_FREQUENCY = \"frequency\";\n+    private static final String FIELD_CHIRPSTACK_FRAME_COUNT = \"fCnt\";\n+    private static final String FIELD_CHIRPSTACK_RX_INFO = \"rxInfo\";\n+    private static final String FIELD_CHIRPSTACK_GATEWAY_ID = \"gatewayID\";\n+    private static final String FIELD_CHIRPSTACK_RSSI = \"rssi\";\n+    private static final String FIELD_CHIRPSTACK_LSNR = \"loRaSNR\";\n+    private static final String FIELD_CHIRPSTACK_CHANNEL = \"channel\";\n+    private static final String FIELD_CHIRPSTACK_LOCATION = \"location\";\n+    private static final String FIELD_CHIRPSTACK_LATITUDE = \"latitude\";\n+    private static final String FIELD_CHIRPSTACK_LONGITUDE = \"longitude\";\n+\n+    @Override\n+    public String getProviderName() {\n+        return \"chirpStack\";\n+    }\n+\n+    @Override\n+    public String pathPrefix() {\n+        return \"/chirpstack\";\n+    }\n+\n+    @Override\n+    public String extractDeviceId(final JsonObject loraMessage) {\n+        return loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+    }\n+\n+    @Override\n+    public String extractPayload(final JsonObject loraMessage) {\n+        return loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);", "originalCommit": "ea50d79ed465cf813cfb68942a2284c43d2146bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f499cf891bfbf7e516888b22d185cd2c745e45bb", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 9c2a4ced0..0c65512d2 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -60,12 +60,21 @@ public class ChirpStackProvider implements LoraProvider {\n \n     @Override\n     public String extractDeviceId(final JsonObject loraMessage) {\n-        return loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+        final String deviceId = loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+        if (deviceId == null) {\n+            throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n+        }\n+\n+        return deviceId;\n     }\n \n     @Override\n     public String extractPayload(final JsonObject loraMessage) {\n-        return loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+        final String payload = loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+        if (payload == null){\n+            throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message.\", null);\n+        }\n+        return payload;\n     }\n \n     @Override\n", "next_change": {"commit": "2b20fbf6041c18926b65abd7f8b74af7360af1a5", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 0c65512d2..08d670a84 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -65,13 +65,13 @@ public class ChirpStackProvider implements LoraProvider {\n             throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n         }\n \n-        return deviceId;\n+        return LoraUtils.convertFromBase64ToHex(deviceId);\n     }\n \n     @Override\n     public String extractPayload(final JsonObject loraMessage) {\n         final String payload = loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n-        if (payload == null){\n+        if (payload == null) {\n             throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message.\", null);\n         }\n         return payload;\n", "next_change": {"commit": "9643b06a859c5c4953ccf2c6db171cf64b84df32", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 08d670a84..fa1a48ca9 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -60,21 +60,29 @@ public class ChirpStackProvider implements LoraProvider {\n \n     @Override\n     public String extractDeviceId(final JsonObject loraMessage) {\n-        final String deviceId = loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+        final Object deviceId = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\n         if (deviceId == null) {\n             throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n         }\n+        if (deviceId instanceof String) {\n+            return LoraUtils.convertFromBase64ToHex((String) deviceId);\n+        }\n \n-        return LoraUtils.convertFromBase64ToHex(deviceId);\n+        return null;\n     }\n \n     @Override\n     public String extractPayload(final JsonObject loraMessage) {\n-        final String payload = loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+        final Object payload = loraMessage.getValue(FIELD_CHIRPSTACK_PAYLOAD);\n         if (payload == null) {\n             throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message.\", null);\n         }\n-        return payload;\n+\n+        if (payload instanceof String) {\n+            return (String) payload;\n+        }\n+\n+        return null;\n     }\n \n     @Override\n", "next_change": {"commit": "6ffa383c0033b450361ed0db2e9995b14f82a6c7", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex fa1a48ca9..432d3ebac 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -82,7 +83,8 @@ public class ChirpStackProvider implements LoraProvider {\n             return (String) payload;\n         }\n \n-        return null;\n+        throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message. Expected \" +\n+                \"string, got \" + payload.getClass().getName(), null);\n     }\n \n     @Override\n", "next_change": null}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NjgzNw==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r408686837", "body": "I do not think that you need to look up the key twice ...\r\nthe same is true for all of the other properties you are retrieving in the remainder of the method.", "bodyText": "I do not think that you need to look up the key twice ...\nthe same is true for all of the other properties you are retrieving in the remainder of the method.", "bodyHTML": "<p dir=\"auto\">I do not think that you need to look up the key twice ...<br>\nthe same is true for all of the other properties you are retrieving in the remainder of the method.</p>", "author": "sophokles73", "createdAt": "2020-04-15T08:57:13Z", "path": "adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.adapter.lora.providers;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.hono.adapter.lora.LoraConstants;\n+import org.eclipse.hono.adapter.lora.LoraMessageType;\n+import org.springframework.stereotype.Component;\n+\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A LoRaWAN provider with API for ChirpStack.\n+ */\n+@Component\n+public class ChirpStackProvider implements LoraProvider {\n+\n+    private static final String FIELD_CHIRPSTACK_PAYLOAD = \"data\";\n+    private static final String FIELD_CHIRPSTACK_DEVICE = \"devEUI\";\n+    private static final String FIELD_CHIRPSTACK_TX_INFO = \"txInfo\";\n+    private static final String FIELD_CHIRPSTACK_SPREADING_FACTOR = \"spreadingFactor\";\n+    private static final String FIELD_CHIRPSTACK_BANDWIDTH = \"bandwidth\";\n+    private static final String FIELD_CHIRPSTACK_FUNCTION_PORT = \"fPort\";\n+    private static final String FIELD_CHIRPSTACK_CODE_RATE = \"codeRate\";\n+    private static final String FIELD_CHIRPSTACK_LORA_MODULATION_INFO = \"loRaModulationInfo\";\n+    private static final String FIELD_CHIRPSTACK_FREQUENCY = \"frequency\";\n+    private static final String FIELD_CHIRPSTACK_FRAME_COUNT = \"fCnt\";\n+    private static final String FIELD_CHIRPSTACK_RX_INFO = \"rxInfo\";\n+    private static final String FIELD_CHIRPSTACK_GATEWAY_ID = \"gatewayID\";\n+    private static final String FIELD_CHIRPSTACK_RSSI = \"rssi\";\n+    private static final String FIELD_CHIRPSTACK_LSNR = \"loRaSNR\";\n+    private static final String FIELD_CHIRPSTACK_CHANNEL = \"channel\";\n+    private static final String FIELD_CHIRPSTACK_LOCATION = \"location\";\n+    private static final String FIELD_CHIRPSTACK_LATITUDE = \"latitude\";\n+    private static final String FIELD_CHIRPSTACK_LONGITUDE = \"longitude\";\n+\n+    @Override\n+    public String getProviderName() {\n+        return \"chirpStack\";\n+    }\n+\n+    @Override\n+    public String pathPrefix() {\n+        return \"/chirpstack\";\n+    }\n+\n+    @Override\n+    public String extractDeviceId(final JsonObject loraMessage) {\n+        return loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+    }\n+\n+    @Override\n+    public String extractPayload(final JsonObject loraMessage) {\n+        return loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+    }\n+\n+    @Override\n+    public LoraMessageType extractMessageType(final JsonObject loraMessage) {\n+        if (loraMessage.containsKey(FIELD_CHIRPSTACK_PAYLOAD)) {\n+            return LoraMessageType.UPLINK;\n+        }\n+        return LoraMessageType.UNKNOWN;\n+    }\n+\n+    @Override\n+    public Map<String, Object> extractNormalizedData(final JsonObject loraMessage) {\n+        final Map<String, Object> returnMap = new HashMap<>();\n+        if (loraMessage.containsKey(FIELD_CHIRPSTACK_TX_INFO)) {\n+            final JsonObject txInfo = loraMessage.getJsonObject(FIELD_CHIRPSTACK_TX_INFO);", "originalCommit": "ea50d79ed465cf813cfb68942a2284c43d2146bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f499cf891bfbf7e516888b22d185cd2c745e45bb", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 9c2a4ced0..0c65512d2 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -79,63 +88,37 @@ public class ChirpStackProvider implements LoraProvider {\n     @Override\n     public Map<String, Object> extractNormalizedData(final JsonObject loraMessage) {\n         final Map<String, Object> returnMap = new HashMap<>();\n-        if (loraMessage.containsKey(FIELD_CHIRPSTACK_TX_INFO)) {\n-            final JsonObject txInfo = loraMessage.getJsonObject(FIELD_CHIRPSTACK_TX_INFO);\n-            if (txInfo.containsKey(FIELD_CHIRPSTACK_LORA_MODULATION_INFO)) {\n-                final JsonObject loraModulationInfo = txInfo.getJsonObject(FIELD_CHIRPSTACK_LORA_MODULATION_INFO);\n-                if (loraModulationInfo.containsKey(FIELD_CHIRPSTACK_SPREADING_FACTOR)) {\n-                    returnMap.put(LoraConstants.APP_PROPERTY_SPREADING_FACTOR,\n-                            loraModulationInfo.getInteger(FIELD_CHIRPSTACK_SPREADING_FACTOR));\n-                }\n-                if (loraModulationInfo.containsKey(FIELD_CHIRPSTACK_BANDWIDTH)) {\n-                    returnMap.put(LoraConstants.APP_PROPERTY_BANDWIDTH, loraModulationInfo.getInteger(FIELD_CHIRPSTACK_BANDWIDTH));\n-                }\n-                if (loraModulationInfo.containsKey(FIELD_CHIRPSTACK_CODE_RATE)) {\n-                    returnMap.put(LoraConstants.CODING_RATE, loraModulationInfo.getString(FIELD_CHIRPSTACK_CODE_RATE));\n-                }\n-            }\n-            if (txInfo.containsKey(FIELD_CHIRPSTACK_FREQUENCY)) {\n-                returnMap.put(LoraConstants.FREQUENCY, txInfo.getInteger(FIELD_CHIRPSTACK_FREQUENCY));\n+        final JsonObject txInfo = loraMessage.getJsonObject(FIELD_CHIRPSTACK_TX_INFO);\n+        if (txInfo != null) {\n+            final JsonObject loraModulationInfo = txInfo.getJsonObject(FIELD_CHIRPSTACK_LORA_MODULATION_INFO);\n+            if (loraModulationInfo != null) {\n+                returnMap.put(LoraConstants.APP_PROPERTY_SPREADING_FACTOR,\n+                        loraModulationInfo.getInteger(FIELD_CHIRPSTACK_SPREADING_FACTOR));\n+                returnMap.put(LoraConstants.APP_PROPERTY_BANDWIDTH, loraModulationInfo.getInteger(FIELD_CHIRPSTACK_BANDWIDTH));\n+                returnMap.put(LoraConstants.CODING_RATE, loraModulationInfo.getString(FIELD_CHIRPSTACK_CODE_RATE));\n             }\n+            returnMap.put(LoraConstants.FREQUENCY, txInfo.getInteger(FIELD_CHIRPSTACK_FREQUENCY));\n         }\n \n-        if (loraMessage.containsKey(FIELD_CHIRPSTACK_FUNCTION_PORT)) {\n-            returnMap.put(LoraConstants.APP_PROPERTY_FUNCTION_PORT, loraMessage.getInteger(FIELD_CHIRPSTACK_FUNCTION_PORT));\n-        }\n-        if (loraMessage.containsKey(FIELD_CHIRPSTACK_FRAME_COUNT)) {\n-            returnMap.put(LoraConstants.FRAME_COUNT, loraMessage.getInteger(FIELD_CHIRPSTACK_FRAME_COUNT));\n-        }\n+        returnMap.put(LoraConstants.APP_PROPERTY_FUNCTION_PORT, loraMessage.getInteger(FIELD_CHIRPSTACK_FUNCTION_PORT));\n+        returnMap.put(LoraConstants.FRAME_COUNT, loraMessage.getInteger(FIELD_CHIRPSTACK_FRAME_COUNT));\n \n-        if (loraMessage.containsKey(FIELD_CHIRPSTACK_RX_INFO)) {\n-            final JsonArray rxInfos = loraMessage.getJsonArray(FIELD_CHIRPSTACK_RX_INFO);\n+        final JsonArray rxInfos = loraMessage.getJsonArray(FIELD_CHIRPSTACK_RX_INFO);\n+        if (rxInfos != null) {\n             final JsonArray normalizedGatways = new JsonArray();\n             for (int i = 0; i < rxInfos.size(); i++) {\n                 final JsonObject rxInfo = rxInfos.getJsonObject(i);\n                 final JsonObject normalizedGatway = new JsonObject();\n-                if (rxInfo.containsKey(FIELD_CHIRPSTACK_GATEWAY_ID)) {\n-                    normalizedGatway.put(LoraConstants.GATEWAY_ID, rxInfo.getString(FIELD_CHIRPSTACK_GATEWAY_ID));\n-                }\n-                if (rxInfo.containsKey(FIELD_CHIRPSTACK_RSSI)) {\n-                    normalizedGatway.put(LoraConstants.APP_PROPERTY_RSS, rxInfo.getInteger(FIELD_CHIRPSTACK_RSSI));\n-                }\n-                if (rxInfo.containsKey(FIELD_CHIRPSTACK_LSNR)) {\n-                    normalizedGatway.put(LoraConstants.APP_PROPERTY_SNR, rxInfo.getDouble(FIELD_CHIRPSTACK_LSNR));\n-                }\n-                if (rxInfo.containsKey(FIELD_CHIRPSTACK_CHANNEL)) {\n-                    normalizedGatway.put(LoraConstants.APP_PROPERTY_CHANNEL,\n-                            rxInfo.getDouble(FIELD_CHIRPSTACK_CHANNEL));\n-                }\n-                if (rxInfo.containsKey(FIELD_CHIRPSTACK_LOCATION)) {\n-                    final JsonObject location = rxInfo.getJsonObject(FIELD_CHIRPSTACK_LOCATION);\n-                    if (location.containsKey(FIELD_CHIRPSTACK_LATITUDE)) {\n-                        normalizedGatway.put(LoraConstants.APP_PROPERTY_FUNCTION_LATITUDE,\n-                                location.getDouble(FIELD_CHIRPSTACK_LATITUDE));\n-                    }\n-\n-                    if (location.containsKey(FIELD_CHIRPSTACK_LONGITUDE)) {\n-                        normalizedGatway.put(LoraConstants.APP_PROPERTY_FUNCTION_LONGITUDE,\n-                                location.getDouble(FIELD_CHIRPSTACK_LONGITUDE));\n-                    }\n+                normalizedGatway.put(LoraConstants.GATEWAY_ID, rxInfo.getString(FIELD_CHIRPSTACK_GATEWAY_ID));\n+                normalizedGatway.put(LoraConstants.APP_PROPERTY_RSS, rxInfo.getInteger(FIELD_CHIRPSTACK_RSSI));\n+                normalizedGatway.put(LoraConstants.APP_PROPERTY_SNR, rxInfo.getDouble(FIELD_CHIRPSTACK_LSNR));\n+                normalizedGatway.put(LoraConstants.APP_PROPERTY_CHANNEL, rxInfo.getDouble(FIELD_CHIRPSTACK_CHANNEL));\n+                final JsonObject location = rxInfo.getJsonObject(FIELD_CHIRPSTACK_LOCATION);\n+                if (location != null) {\n+                    normalizedGatway.put(LoraConstants.APP_PROPERTY_FUNCTION_LATITUDE,\n+                            location.getDouble(FIELD_CHIRPSTACK_LATITUDE));\n+                    normalizedGatway.put(LoraConstants.APP_PROPERTY_FUNCTION_LONGITUDE,\n+                            location.getDouble(FIELD_CHIRPSTACK_LONGITUDE));\n                 }\n                 normalizedGatways.add(normalizedGatway);\n             }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4NzUwNw==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r408687507", "body": "2020?", "bodyText": "2020?", "bodyHTML": "<p dir=\"auto\">2020?</p>", "author": "sophokles73", "createdAt": "2020-04-15T08:58:15Z", "path": "adapters/lora-vertx/src/test/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProviderTest.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/*******************************************************************************\n+ * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation", "originalCommit": "ea50d79ed465cf813cfb68942a2284c43d2146bd", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f499cf891bfbf7e516888b22d185cd2c745e45bb", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/test/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProviderTest.java b/adapters/lora-vertx/src/test/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProviderTest.java\nindex e85c60b04..3d17541a6 100644\n--- a/adapters/lora-vertx/src/test/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProviderTest.java\n+++ b/adapters/lora-vertx/src/test/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProviderTest.java\n", "chunk": "@@ -1,5 +1,5 @@\n /*******************************************************************************\n- * Copyright (c) 2019, 2020 Contributors to the Eclipse Foundation\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n  *\n  * See the NOTICE file(s) distributed with this work for additional\n  * information regarding copyright ownership.\n", "next_change": null}]}}, {"oid": "f499cf891bfbf7e516888b22d185cd2c745e45bb", "url": "https://github.com/eclipse/hono/commit/f499cf891bfbf7e516888b22d185cd2c745e45bb", "message": "added ChirpStack lora provider\n\nSigned-off-by: Bob Claerhout <claerhout.bob@gmail.com>", "committedDate": "2020-04-16T07:31:04Z", "type": "forcePushed"}, {"oid": "244911bc816d912130bc4daf1204197f42056945", "url": "https://github.com/eclipse/hono/commit/244911bc816d912130bc4daf1204197f42056945", "message": "added ChirpStack lora provider\n\nSigned-off-by: Bob Claerhout <claerhout.bob@gmail.com>", "committedDate": "2020-04-16T08:56:31Z", "type": "forcePushed"}, {"oid": "dfba9ed42f4511b564c3b97eb72f185e69d70e70", "url": "https://github.com/eclipse/hono/commit/dfba9ed42f4511b564c3b97eb72f185e69d70e70", "message": "added ChirpStack lora provider\n\nSigned-off-by: Bob Claerhout <claerhout.bob@gmail.com>", "committedDate": "2020-04-16T09:04:56Z", "type": "forcePushed"}, {"oid": "2b20fbf6041c18926b65abd7f8b74af7360af1a5", "url": "https://github.com/eclipse/hono/commit/2b20fbf6041c18926b65abd7f8b74af7360af1a5", "message": "added ChirpStack lora provider\n\nSigned-off-by: Bob Claerhout <claerhout.bob@gmail.com>", "committedDate": "2020-04-16T09:13:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3NjI2MQ==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r409576261", "body": "I believe that this will throw a *ClassCastException* if the property is not a String ...\r\nHow about a more defensive approach:\r\n```\r\nfinal Object obj = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\r\nif (obj instanceof String) {\r\n  return (String) obj;\r\n} else {\r\n  return null;\r\n}\r\n```", "bodyText": "I believe that this will throw a ClassCastException if the property is not a String ...\nHow about a more defensive approach:\nfinal Object obj = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\nif (obj instanceof String) {\n  return (String) obj;\n} else {\n  return null;\n}", "bodyHTML": "<p dir=\"auto\">I believe that this will throw a <em>ClassCastException</em> if the property is not a String ...<br>\nHow about a more defensive approach:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"final Object obj = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\nif (obj instanceof String) {\n  return (String) obj;\n} else {\n  return null;\n}\"><pre><code>final Object obj = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\nif (obj instanceof String) {\n  return (String) obj;\n} else {\n  return null;\n}\n</code></pre></div>", "author": "sophokles73", "createdAt": "2020-04-16T13:56:14Z", "path": "adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.adapter.lora.providers;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.hono.adapter.lora.LoraConstants;\n+import org.eclipse.hono.adapter.lora.LoraMessageType;\n+import org.springframework.stereotype.Component;\n+\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A LoRaWAN provider with API for ChirpStack.\n+ */\n+@Component\n+public class ChirpStackProvider implements LoraProvider {\n+\n+    private static final String FIELD_CHIRPSTACK_PAYLOAD = \"data\";\n+    private static final String FIELD_CHIRPSTACK_DEVICE = \"devEUI\";\n+    private static final String FIELD_CHIRPSTACK_TX_INFO = \"txInfo\";\n+    private static final String FIELD_CHIRPSTACK_SPREADING_FACTOR = \"spreadingFactor\";\n+    private static final String FIELD_CHIRPSTACK_BANDWIDTH = \"bandwidth\";\n+    private static final String FIELD_CHIRPSTACK_FUNCTION_PORT = \"fPort\";\n+    private static final String FIELD_CHIRPSTACK_CODE_RATE = \"codeRate\";\n+    private static final String FIELD_CHIRPSTACK_LORA_MODULATION_INFO = \"loRaModulationInfo\";\n+    private static final String FIELD_CHIRPSTACK_FREQUENCY = \"frequency\";\n+    private static final String FIELD_CHIRPSTACK_FRAME_COUNT = \"fCnt\";\n+    private static final String FIELD_CHIRPSTACK_RX_INFO = \"rxInfo\";\n+    private static final String FIELD_CHIRPSTACK_GATEWAY_ID = \"gatewayID\";\n+    private static final String FIELD_CHIRPSTACK_RSSI = \"rssi\";\n+    private static final String FIELD_CHIRPSTACK_LSNR = \"loRaSNR\";\n+    private static final String FIELD_CHIRPSTACK_CHANNEL = \"channel\";\n+    private static final String FIELD_CHIRPSTACK_LOCATION = \"location\";\n+    private static final String FIELD_CHIRPSTACK_LATITUDE = \"latitude\";\n+    private static final String FIELD_CHIRPSTACK_LONGITUDE = \"longitude\";\n+\n+    @Override\n+    public String getProviderName() {\n+        return \"chirpStack\";\n+    }\n+\n+    @Override\n+    public String pathPrefix() {\n+        return \"/chirpstack\";\n+    }\n+\n+    @Override\n+    public String extractDeviceId(final JsonObject loraMessage) {\n+        final String deviceId = loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);", "originalCommit": "2b20fbf6041c18926b65abd7f8b74af7360af1a5", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "9643b06a859c5c4953ccf2c6db171cf64b84df32", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex 08d670a84..fa1a48ca9 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -60,21 +60,29 @@ public class ChirpStackProvider implements LoraProvider {\n \n     @Override\n     public String extractDeviceId(final JsonObject loraMessage) {\n-        final String deviceId = loraMessage.getString(FIELD_CHIRPSTACK_DEVICE);\n+        final Object deviceId = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\n         if (deviceId == null) {\n             throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n         }\n+        if (deviceId instanceof String) {\n+            return LoraUtils.convertFromBase64ToHex((String) deviceId);\n+        }\n \n-        return LoraUtils.convertFromBase64ToHex(deviceId);\n+        return null;\n     }\n \n     @Override\n     public String extractPayload(final JsonObject loraMessage) {\n-        final String payload = loraMessage.getString(FIELD_CHIRPSTACK_PAYLOAD);\n+        final Object payload = loraMessage.getValue(FIELD_CHIRPSTACK_PAYLOAD);\n         if (payload == null) {\n             throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message.\", null);\n         }\n-        return payload;\n+\n+        if (payload instanceof String) {\n+            return (String) payload;\n+        }\n+\n+        return null;\n     }\n \n     @Override\n", "next_change": {"commit": "6ffa383c0033b450361ed0db2e9995b14f82a6c7", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex fa1a48ca9..432d3ebac 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -82,7 +83,8 @@ public class ChirpStackProvider implements LoraProvider {\n             return (String) payload;\n         }\n \n-        return null;\n+        throw new LoraProviderMalformedPayloadException(\"Payload could not be extracted from message. Expected \" +\n+                \"string, got \" + payload.getClass().getName(), null);\n     }\n \n     @Override\n", "next_change": null}]}}]}}, {"oid": "9643b06a859c5c4953ccf2c6db171cf64b84df32", "url": "https://github.com/eclipse/hono/commit/9643b06a859c5c4953ccf2c6db171cf64b84df32", "message": "added ChirpStack lora provider\n\nSigned-off-by: Bob Claerhout <claerhout.bob@gmail.com>", "committedDate": "2020-04-20T14:44:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk1MDI0Mw==", "url": "https://github.com/eclipse/hono/pull/1899#discussion_r411950243", "body": "shouldn't we also throw the exception if the object is not null but is e.g. a number instead of a String? Isn't the *devEUI* field expected to be contained in each message and to hold a (Base64) String value?", "bodyText": "shouldn't we also throw the exception if the object is not null but is e.g. a number instead of a String? Isn't the devEUI field expected to be contained in each message and to hold a (Base64) String value?", "bodyHTML": "<p dir=\"auto\">shouldn't we also throw the exception if the object is not null but is e.g. a number instead of a String? Isn't the <em>devEUI</em> field expected to be contained in each message and to hold a (Base64) String value?</p>", "author": "sophokles73", "createdAt": "2020-04-21T07:43:36Z", "path": "adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Contributors to the Eclipse Foundation\n+ *\n+ * See the NOTICE file(s) distributed with this work for additional\n+ * information regarding copyright ownership.\n+ *\n+ * This program and the accompanying materials are made available under the\n+ * terms of the Eclipse Public License 2.0 which is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *******************************************************************************/\n+\n+package org.eclipse.hono.adapter.lora.providers;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.eclipse.hono.adapter.lora.LoraConstants;\n+import org.eclipse.hono.adapter.lora.LoraMessageType;\n+import org.springframework.stereotype.Component;\n+\n+import io.vertx.core.json.JsonArray;\n+import io.vertx.core.json.JsonObject;\n+\n+/**\n+ * A LoRaWAN provider with API for ChirpStack.\n+ */\n+@Component\n+public class ChirpStackProvider implements LoraProvider {\n+\n+    private static final String FIELD_CHIRPSTACK_PAYLOAD = \"data\";\n+    private static final String FIELD_CHIRPSTACK_DEVICE = \"devEUI\";\n+    private static final String FIELD_CHIRPSTACK_TX_INFO = \"txInfo\";\n+    private static final String FIELD_CHIRPSTACK_SPREADING_FACTOR = \"spreadingFactor\";\n+    private static final String FIELD_CHIRPSTACK_BANDWIDTH = \"bandwidth\";\n+    private static final String FIELD_CHIRPSTACK_FUNCTION_PORT = \"fPort\";\n+    private static final String FIELD_CHIRPSTACK_CODE_RATE = \"codeRate\";\n+    private static final String FIELD_CHIRPSTACK_LORA_MODULATION_INFO = \"loRaModulationInfo\";\n+    private static final String FIELD_CHIRPSTACK_FREQUENCY = \"frequency\";\n+    private static final String FIELD_CHIRPSTACK_FRAME_COUNT = \"fCnt\";\n+    private static final String FIELD_CHIRPSTACK_RX_INFO = \"rxInfo\";\n+    private static final String FIELD_CHIRPSTACK_GATEWAY_ID = \"gatewayID\";\n+    private static final String FIELD_CHIRPSTACK_RSSI = \"rssi\";\n+    private static final String FIELD_CHIRPSTACK_LSNR = \"loRaSNR\";\n+    private static final String FIELD_CHIRPSTACK_CHANNEL = \"channel\";\n+    private static final String FIELD_CHIRPSTACK_LOCATION = \"location\";\n+    private static final String FIELD_CHIRPSTACK_LATITUDE = \"latitude\";\n+    private static final String FIELD_CHIRPSTACK_LONGITUDE = \"longitude\";\n+\n+    @Override\n+    public String getProviderName() {\n+        return \"chirpStack\";\n+    }\n+\n+    @Override\n+    public String pathPrefix() {\n+        return \"/chirpstack\";\n+    }\n+\n+    @Override\n+    public String extractDeviceId(final JsonObject loraMessage) {\n+        final Object deviceId = loraMessage.getValue(FIELD_CHIRPSTACK_DEVICE);\n+        if (deviceId == null) {\n+            throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message.\", null);\n+        }\n+        if (deviceId instanceof String) {\n+            return LoraUtils.convertFromBase64ToHex((String) deviceId);\n+        }\n+\n+        return null;", "originalCommit": "9643b06a859c5c4953ccf2c6db171cf64b84df32", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "6ffa383c0033b450361ed0db2e9995b14f82a6c7", "changed_code": [{"header": "diff --git a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\nindex fa1a48ca9..432d3ebac 100644\n--- a/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n+++ b/adapters/lora-vertx/src/main/java/org/eclipse/hono/adapter/lora/providers/ChirpStackProvider.java\n", "chunk": "@@ -68,7 +68,8 @@ public class ChirpStackProvider implements LoraProvider {\n             return LoraUtils.convertFromBase64ToHex((String) deviceId);\n         }\n \n-        return null;\n+        throw new LoraProviderMalformedPayloadException(\"DeviceId could not be extracted from message. Expected \" +\n+                \"string, got \" + deviceId.getClass().getName(), null);\n     }\n \n     @Override\n", "next_change": null}]}}, {"oid": "6ffa383c0033b450361ed0db2e9995b14f82a6c7", "url": "https://github.com/eclipse/hono/commit/6ffa383c0033b450361ed0db2e9995b14f82a6c7", "message": "added ChirpStack lora provider\n\nSigned-off-by: Bob Claerhout <claerhout.bob@gmail.com>", "committedDate": "2020-04-21T09:02:54Z", "type": "commit"}, {"oid": "6ffa383c0033b450361ed0db2e9995b14f82a6c7", "url": "https://github.com/eclipse/hono/commit/6ffa383c0033b450361ed0db2e9995b14f82a6c7", "message": "added ChirpStack lora provider\n\nSigned-off-by: Bob Claerhout <claerhout.bob@gmail.com>", "committedDate": "2020-04-21T09:02:54Z", "type": "forcePushed"}]}