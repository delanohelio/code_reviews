{"pr_number": 1894, "pr_title": "[#1732] Use timeout to wait for disposition update", "pr_author": "Alfusainey", "pr_createdAt": "2020-04-13T12:33:49Z", "pr_url": "https://github.com/eclipse/hono/pull/1894", "timeline": [{"oid": "b8f1152fd80454488cfc6ccada580b55ec58d215", "url": "https://github.com/eclipse/hono/commit/b8f1152fd80454488cfc6ccada580b55ec58d215", "message": "[#1732] Use timeout to wait for disposition update\n\nAMQP adapter now uses timeout to wait for a disposition update\nin response to a command sent to the device.\n\nfixes #1732\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>", "committedDate": "2020-04-13T12:28:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg5MjM5OA==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r407892398", "body": "Wrong reference here.", "bodyText": "Wrong reference here.", "bodyHTML": "<p dir=\"auto\">Wrong reference here.</p>", "author": "calohmn", "createdAt": "2020-04-14T06:20:48Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/AmqpAdapterProperties.java", "diffHunk": "@@ -137,4 +143,30 @@ public final void setIdleTimeout(final int timeout) {\n     public final int getIdleTimeout() {\n         return this.idleTimeout;\n     }\n+\n+    /**\n+     * Gets the time to wait for a delivery update from a device before the AMQP sender link to the\n+     * device is closed.\n+     * <p>\n+     * The default value of this property is {@link #DEFAULT_SEND_COMMAND_TIMEOUT}.", "originalCommit": "b8f1152fd80454488cfc6ccada580b55ec58d215", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg5MjgyOQ==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r407892829", "body": "Comment can be removed.", "bodyText": "Comment can be removed.", "bodyHTML": "<p dir=\"auto\">Comment can be removed.</p>", "author": "calohmn", "createdAt": "2020-04-14T06:22:10Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -892,7 +892,20 @@ protected void onCommandReceived(final TenantObject tenantObject, final ProtonSe\n         }\n \n         // TODO time out waiting for disposition update", "originalCommit": "b8f1152fd80454488cfc6ccada580b55ec58d215", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg5NzIzNg==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r407897236", "body": "The case that the deliveryUpdateTimeout  is `0` should be taken into account here. That would lead to an IllegalArgumentException in `vertx.setTimer()`. How about adding a check for that here and using `null` as `timerId` in that case (like it is done in `AbstractSender.sendMessageAndWaitForOutcome`) and further down adding a `null` check around `vertx.cancelTimer(timerId);`.", "bodyText": "The case that the deliveryUpdateTimeout  is 0 should be taken into account here. That would lead to an IllegalArgumentException in vertx.setTimer(). How about adding a check for that here and using null as timerId in that case (like it is done in AbstractSender.sendMessageAndWaitForOutcome) and further down adding a null check around vertx.cancelTimer(timerId);.", "bodyHTML": "<p dir=\"auto\">The case that the deliveryUpdateTimeout  is <code>0</code> should be taken into account here. That would lead to an IllegalArgumentException in <code>vertx.setTimer()</code>. How about adding a check for that here and using <code>null</code> as <code>timerId</code> in that case (like it is done in <code>AbstractSender.sendMessageAndWaitForOutcome</code>) and further down adding a <code>null</code> check around <code>vertx.cancelTimer(timerId);</code>.</p>", "author": "calohmn", "createdAt": "2020-04-14T06:34:01Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -892,7 +892,20 @@ protected void onCommandReceived(final TenantObject tenantObject, final ProtonSe\n         }\n \n         // TODO time out waiting for disposition update\n+        final Long timerId = vertx.setTimer(getConfig().getDeliveryUpdateTimeout(), tid -> {", "originalCommit": "b8f1152fd80454488cfc6ccada580b55ec58d215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNjcwNA==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r408106704", "bodyText": "The case that the deliveryUpdateTimeout is 0 should be taken into account here\n\nhow about only allowing values > 0 for this config property?", "author": "Alfusainey", "createdAt": "2020-04-14T12:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg5NzIzNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODE3OTgyOA==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r408179828", "bodyText": "I would rather keep it in line with the handling of the sendMessageTimeout value (and e.g. connection requestTimeout) and allow 0 for an infinite timeout.", "author": "calohmn", "createdAt": "2020-04-14T14:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg5NzIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkwNjA2MA==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r407906060", "body": "I'm wondering whether the name of the property (`deliveryUpdateTimeout`) isn't a bit too technical here.\r\nThe corresponding property for waiting for a disposition update when the adapter sends a message downstream to the AMQP messaging network is called `sendMessageTimeout`.\r\nWhile I think it is indeed good to have a separate property for the other direction (adapter to device), maybe we could align the naming somewhat. Maybe `sendMessageToDeviceTimeout`? \r\n\r\nIn any case, the property should also be documented here:\r\nhttps://www.eclipse.org/hono/docs/admin-guide/amqp-adapter-config/#service-configuration", "bodyText": "I'm wondering whether the name of the property (deliveryUpdateTimeout) isn't a bit too technical here.\nThe corresponding property for waiting for a disposition update when the adapter sends a message downstream to the AMQP messaging network is called sendMessageTimeout.\nWhile I think it is indeed good to have a separate property for the other direction (adapter to device), maybe we could align the naming somewhat. Maybe sendMessageToDeviceTimeout?\nIn any case, the property should also be documented here:\nhttps://www.eclipse.org/hono/docs/admin-guide/amqp-adapter-config/#service-configuration", "bodyHTML": "<p dir=\"auto\">I'm wondering whether the name of the property (<code>deliveryUpdateTimeout</code>) isn't a bit too technical here.<br>\nThe corresponding property for waiting for a disposition update when the adapter sends a message downstream to the AMQP messaging network is called <code>sendMessageTimeout</code>.<br>\nWhile I think it is indeed good to have a separate property for the other direction (adapter to device), maybe we could align the naming somewhat. Maybe <code>sendMessageToDeviceTimeout</code>?</p>\n<p dir=\"auto\">In any case, the property should also be documented here:<br>\n<a href=\"https://www.eclipse.org/hono/docs/admin-guide/amqp-adapter-config/#service-configuration\" rel=\"nofollow\">https://www.eclipse.org/hono/docs/admin-guide/amqp-adapter-config/#service-configuration</a></p>", "author": "calohmn", "createdAt": "2020-04-14T06:55:31Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/AmqpAdapterProperties.java", "diffHunk": "@@ -137,4 +143,30 @@ public final void setIdleTimeout(final int timeout) {\n     public final int getIdleTimeout() {\n         return this.idleTimeout;\n     }\n+\n+    /**\n+     * Gets the time to wait for a delivery update from a device before the AMQP sender link to the\n+     * device is closed.\n+     * <p>\n+     * The default value of this property is {@link #DEFAULT_SEND_COMMAND_TIMEOUT}.\n+     * \n+     * @return The wait time in milliseconds.\n+     */\n+    public long getDeliveryUpdateTimeout() {\n+        return this.deliveryUpdateTimeout;\n+    }\n+\n+    /**\n+     * Sets the time to wait for a delivery update from a device before the AMQP sender link is closed.\n+     * \n+     * @param deliveryUpdateTimeout The timeout value in milliseconds.\n+     * \n+     * @throws IllegalArgumentException if the timeout value is negative.\n+     */\n+    public final void setDeliveryUpdateTimeout(final long deliveryUpdateTimeout) {", "originalCommit": "b8f1152fd80454488cfc6ccada580b55ec58d215", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODEwNzkzNA==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r408107934", "bodyText": "make sense to me \ud83d\udc4d", "author": "Alfusainey", "createdAt": "2020-04-14T12:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkwNjA2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkwODcxOA==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r407908718", "body": "A check is needed here whether the timeout has already occurred, skipping the delivery update handling below in that case.", "bodyText": "A check is needed here whether the timeout has already occurred, skipping the delivery update handling below in that case.", "bodyHTML": "<p dir=\"auto\">A check is needed here whether the timeout has already occurred, skipping the delivery update handling below in that case.</p>", "author": "calohmn", "createdAt": "2020-04-14T07:01:24Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -892,7 +892,20 @@ protected void onCommandReceived(final TenantObject tenantObject, final ProtonSe\n         }\n \n         // TODO time out waiting for disposition update\n+        final Long timerId = vertx.setTimer(getConfig().getDeliveryUpdateTimeout(), tid -> {\n+            log.debug(\"waiting for delivery update timed out after \" + getConfig().getDeliveryUpdateTimeout() + \" ms\");\n+            final Exception ex = new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE,\n+                    \"timeout waiting for delivery update\");\n+            closeLinkWithError(sender, ex, commandContext.getCurrentSpan());\n+            // timeout expired -> release command\n+            commandContext.getCurrentSpan().log(\"timeout waiting for delivery update from device\");\n+            commandContext.release();\n+        });\n+\n         sender.send(msg, delivery -> {\n+            // disposition received -> cancel timer\n+            vertx.cancelTimer(timerId);\n+\n             // release the command message when the device either", "originalCommit": "b8f1152fd80454488cfc6ccada580b55ec58d215", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "235b32f6b2520a92cfa443e175713679a3cd6b53", "url": "https://github.com/eclipse/hono/commit/235b32f6b2520a92cfa443e175713679a3cd6b53", "message": "minor update\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>", "committedDate": "2020-04-15T02:00:03Z", "type": "commit"}, {"oid": "235b32f6b2520a92cfa443e175713679a3cd6b53", "url": "https://github.com/eclipse/hono/commit/235b32f6b2520a92cfa443e175713679a3cd6b53", "message": "minor update\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>", "committedDate": "2020-04-15T02:00:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1NzM3Mw==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r408757373", "body": "\"is closed\"", "bodyText": "\"is closed\"", "bodyHTML": "<p dir=\"auto\">\"is closed\"</p>", "author": "calohmn", "createdAt": "2020-04-15T11:01:10Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/AmqpAdapterProperties.java", "diffHunk": "@@ -137,4 +143,30 @@ public final void setIdleTimeout(final int timeout) {\n     public final int getIdleTimeout() {\n         return this.idleTimeout;\n     }\n+\n+    /**\n+     * Gets the time to wait for a delivery update from a device before the AMQP sender link to the\n+     * device is close.", "originalCommit": "235b32f6b2520a92cfa443e175713679a3cd6b53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1ODE0OQ==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r408758149", "body": "The link should probably go to `DEFAULT_SEND_MESSAGE_TO_DEVICE_TIMEOUT`.", "bodyText": "The link should probably go to DEFAULT_SEND_MESSAGE_TO_DEVICE_TIMEOUT.", "bodyHTML": "<p dir=\"auto\">The link should probably go to <code>DEFAULT_SEND_MESSAGE_TO_DEVICE_TIMEOUT</code>.</p>", "author": "calohmn", "createdAt": "2020-04-15T11:02:34Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/AmqpAdapterProperties.java", "diffHunk": "@@ -137,4 +143,30 @@ public final void setIdleTimeout(final int timeout) {\n     public final int getIdleTimeout() {\n         return this.idleTimeout;\n     }\n+\n+    /**\n+     * Gets the time to wait for a delivery update from a device before the AMQP sender link to the\n+     * device is close.\n+     * <p>\n+     * The default value of this property is {@link #sendMessageToDeviceTimeout}.", "originalCommit": "235b32f6b2520a92cfa443e175713679a3cd6b53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc1OTI3OQ==", "url": "https://github.com/eclipse/hono/pull/1894#discussion_r408759279", "body": "Can you run the code-formatter here? I think the code will be better readable then.", "bodyText": "Can you run the code-formatter here? I think the code will be better readable then.", "bodyHTML": "<p dir=\"auto\">Can you run the code-formatter here? I think the code will be better readable then.</p>", "author": "calohmn", "createdAt": "2020-04-15T11:04:45Z", "path": "adapters/amqp-vertx/src/main/java/org/eclipse/hono/adapter/amqp/impl/VertxBasedAmqpProtocolAdapter.java", "diffHunk": "@@ -891,42 +892,68 @@ protected void onCommandReceived(final TenantObject tenantObject, final ProtonSe\n             MessageHelper.addDeviceId(msg, command.getOriginalDeviceId());\n         }\n \n-        // TODO time out waiting for disposition update\n+        final AtomicBoolean isCommandSettled = new AtomicBoolean(false);\n+\n+        final Long timerId = getConfig().getSendMessageToDeviceTimeout() < 1 ? null :\n+            vertx.setTimer(getConfig().getSendMessageToDeviceTimeout(), tid -> {\n+            log.debug(\"waiting for delivery update timed out after \" + getConfig().getSendMessageToDeviceTimeout() + \" ms\");\n+            if (isCommandSettled.compareAndSet(false, true)) {\n+                final Exception ex = new ServerErrorException(HttpURLConnection.HTTP_UNAVAILABLE,\n+                        \"timeout waiting for delivery update\");\n+                closeLinkWithError(sender, ex, commandContext.getCurrentSpan());\n+                // timeout expired -> release command\n+                commandContext.getCurrentSpan().log(\"timeout waiting for delivery update from device\");\n+                commandContext.release();\n+            } else {\n+                log.trace(\"command is already settled and downstream application notified\");\n+            }\n+        });", "originalCommit": "235b32f6b2520a92cfa443e175713679a3cd6b53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8d64d6d410158fa7a274df18b528ec1dd1a20f4e", "url": "https://github.com/eclipse/hono/commit/8d64d6d410158fa7a274df18b528ec1dd1a20f4e", "message": "format timer handling + minor grammer fix according to feedback\n\nSigned-off-by: Alfusainey Jallow <alf.jallow@gmail.com>", "committedDate": "2020-04-15T11:53:22Z", "type": "commit"}]}