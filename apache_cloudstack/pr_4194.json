{"pr_number": 4194, "pr_title": "enable update tags on disk offerings", "pr_author": "RodrigoDLopez", "pr_createdAt": "2020-07-01T13:06:00Z", "pr_url": "https://github.com/apache/cloudstack/pull/4194", "timeline": [{"oid": "e78de2e1c6b85b3e903fae3be183afd32fc488af", "url": "https://github.com/apache/cloudstack/commit/e78de2e1c6b85b3e903fae3be183afd32fc488af", "message": "enable update tags on disk offerings\n\nThis PR enables `updateDiskOfferingCmd` to edit storage pool tags for `diskoffering`. Thus, providing greater control to ADMINS decide where disks will be allocated.\n\nChanges on UI to enable the user to edit diskoffering tags", "committedDate": "2020-07-01T13:14:03Z", "type": "commit"}, {"oid": "e78de2e1c6b85b3e903fae3be183afd32fc488af", "url": "https://github.com/apache/cloudstack/commit/e78de2e1c6b85b3e903fae3be183afd32fc488af", "message": "enable update tags on disk offerings\n\nThis PR enables `updateDiskOfferingCmd` to edit storage pool tags for `diskoffering`. Thus, providing greater control to ADMINS decide where disks will be allocated.\n\nChanges on UI to enable the user to edit diskoffering tags", "committedDate": "2020-07-01T13:14:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxMzI1Mg==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r448413252", "body": "> Comma-separated list of tags to be added to disk offering\r\n\r\nWhat do you think of changing this description to somethings as:\r\n_\"comma-separated list of tags for the disk offering, tags should match with existing storage pool tags\"_", "bodyText": "Comma-separated list of tags to be added to disk offering\n\nWhat do you think of changing this description to somethings as:\n\"comma-separated list of tags for the disk offering, tags should match with existing storage pool tags\"", "bodyHTML": "<blockquote>\n<p dir=\"auto\">Comma-separated list of tags to be added to disk offering</p>\n</blockquote>\n<p dir=\"auto\">What do you think of changing this description to somethings as:<br>\n<em>\"comma-separated list of tags for the disk offering, tags should match with existing storage pool tags\"</em></p>", "author": "GabrielBrascher", "createdAt": "2020-07-01T14:43:10Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/offering/UpdateDiskOfferingCmd.java", "diffHunk": "@@ -77,6 +77,13 @@\n             since = \"4.13\")\n     private String zoneIds;\n \n+    @Parameter(name = ApiConstants.TAGS,\n+            type = CommandType.STRING,\n+            description = \"Comma-separated list of tags to be added to disk offering\",", "originalCommit": "e78de2e1c6b85b3e903fae3be183afd32fc488af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4MzY2Mg==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r448483662", "bodyText": "i will improve this description", "author": "RodrigoDLopez", "createdAt": "2020-07-01T16:33:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxMzI1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQyNzAzMw==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r448427033", "body": "Can you please update the code formation according to the [CloudStack coding conventions](https://cwiki.apache.org/confluence/display/CLOUDSTACK/Coding+conventions)?\r\n\r\nExample of code formated:\r\n```\r\nif (tags != null) {\r\n    if (tags.isBlank()) {\r\n        diskOffering.setTags(null);\r\n    } else {\r\n        diskOffering.setTags(tags);\r\n    }\r\n}\r\n```\r\n\r\nDocumentation: https://cwiki.apache.org/confluence/display/CLOUDSTACK/Coding+conventions", "bodyText": "Can you please update the code formation according to the CloudStack coding conventions?\nExample of code formated:\nif (tags != null) {\n    if (tags.isBlank()) {\n        diskOffering.setTags(null);\n    } else {\n        diskOffering.setTags(tags);\n    }\n}\n\nDocumentation: https://cwiki.apache.org/confluence/display/CLOUDSTACK/Coding+conventions", "bodyHTML": "<p dir=\"auto\">Can you please update the code formation according to the <a href=\"https://cwiki.apache.org/confluence/display/CLOUDSTACK/Coding+conventions\" rel=\"nofollow\">CloudStack coding conventions</a>?</p>\n<p dir=\"auto\">Example of code formated:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"if (tags != null) {\n    if (tags.isBlank()) {\n        diskOffering.setTags(null);\n    } else {\n        diskOffering.setTags(tags);\n    }\n}\n\"><pre><code>if (tags != null) {\n    if (tags.isBlank()) {\n        diskOffering.setTags(null);\n    } else {\n        diskOffering.setTags(tags);\n    }\n}\n</code></pre></div>\n<p dir=\"auto\">Documentation: <a href=\"https://cwiki.apache.org/confluence/display/CLOUDSTACK/Coding+conventions\" rel=\"nofollow\">https://cwiki.apache.org/confluence/display/CLOUDSTACK/Coding+conventions</a></p>", "author": "GabrielBrascher", "createdAt": "2020-07-01T15:02:53Z", "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -3207,30 +3208,13 @@ public DiskOffering updateDiskOffering(final UpdateDiskOfferingCmd cmd) {\n             diskOffering.setDisplayOffering(displayDiskOffering);\n         }\n \n-        // Note: tag editing commented out for now;keeping the code intact,\n-        // might need to re-enable in next releases\n-        // if (tags != null)\n-        // {\n-        // if (tags.trim().isEmpty() && diskOfferingHandle.getTags() == null)\n-        // {\n-        // //no new tags; no existing tags\n-        // diskOffering.setTagsArray(csvTagsToList(null));\n-        // }\n-        // else if (!tags.trim().isEmpty() && diskOfferingHandle.getTags() !=\n-        // null)\n-        // {\n-        // //new tags + existing tags\n-        // List<String> oldTags = csvTagsToList(diskOfferingHandle.getTags());\n-        // List<String> newTags = csvTagsToList(tags);\n-        // oldTags.addAll(newTags);\n-        // diskOffering.setTagsArray(oldTags);\n-        // }\n-        // else if(!tags.trim().isEmpty())\n-        // {\n-        // //new tags; NO existing tags\n-        // diskOffering.setTagsArray(csvTagsToList(tags));\n-        // }\n-        // }\n+        if (tags != null){\n+            if(tags.isBlank()){\n+                diskOffering.setTags(null);\n+            }else {\n+                diskOffering.setTags(tags);\n+            }\n+        }", "originalCommit": "e78de2e1c6b85b3e903fae3be183afd32fc488af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4MzgwNw==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r448483807", "bodyText": "done, fixed checkstyle issue", "author": "RodrigoDLopez", "createdAt": "2020-07-01T16:34:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQyNzAzMw=="}], "type": "inlineReview"}, {"oid": "ca08e28d35af4c81f0404ef7d0f828d87469d681", "url": "https://github.com/apache/cloudstack/commit/ca08e28d35af4c81f0404ef7d0f828d87469d681", "message": "improve api msg and fix checkstyle issue", "committedDate": "2020-07-01T16:33:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3MzIwMQ==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r453673201", "body": "authorized = {RoleType.Admin}\r\n\r\n?\r\n\r\n", "bodyText": "authorized = {RoleType.Admin}\n?", "bodyHTML": "<p dir=\"auto\">authorized = {RoleType.Admin}</p>\n<p dir=\"auto\">?</p>", "author": "weizhouapache", "createdAt": "2020-07-13T14:03:06Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/offering/UpdateDiskOfferingCmd.java", "diffHunk": "@@ -77,6 +77,13 @@\n             since = \"4.13\")\n     private String zoneIds;\n \n+    @Parameter(name = ApiConstants.TAGS,\n+            type = CommandType.STRING,\n+            description = \"comma-separated list of tags for the disk offering, tags should match with existing storage pool tags\",\n+            since = \"4.15\")\n+    private String tags;", "originalCommit": "ca08e28d35af4c81f0404ef7d0f828d87469d681", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY5OTQ1Ng==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r453699456", "bodyText": "code has been updated, thanks for the hint @weizhouapache", "author": "RodrigoDLopez", "createdAt": "2020-07-13T14:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY3MzIwMQ=="}], "type": "inlineReview"}, {"oid": "d5d13d91c4868efdd5c89c00d6b71db9ae15d81d", "url": "https://github.com/apache/cloudstack/commit/d5d13d91c4868efdd5c89c00d6b71db9ae15d81d", "message": "add RoleType.Admin when updating tag for diskoffering", "committedDate": "2020-07-13T14:31:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNDMzNw==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r460404337", "body": "Can you extract this `name != null || displayText != null || sortKey != null || displayDiskOffering != null || tags != null` to a method? Then, you can document it (explain what it checks, and why), and after that, you can write unit tests for all of the cases that the method must return true/false.\r\n\r\nMoreover, instead of checking if it is different from null, you could use `String.Utils.isNotBlank`", "bodyText": "Can you extract this name != null || displayText != null || sortKey != null || displayDiskOffering != null || tags != null to a method? Then, you can document it (explain what it checks, and why), and after that, you can write unit tests for all of the cases that the method must return true/false.\nMoreover, instead of checking if it is different from null, you could use String.Utils.isNotBlank", "bodyHTML": "<p dir=\"auto\">Can you extract this <code>name != null || displayText != null || sortKey != null || displayDiskOffering != null || tags != null</code> to a method? Then, you can document it (explain what it checks, and why), and after that, you can write unit tests for all of the cases that the method must return true/false.</p>\n<p dir=\"auto\">Moreover, instead of checking if it is different from null, you could use <code>String.Utils.isNotBlank</code></p>", "author": "rafaelweingartner", "createdAt": "2020-07-25T13:18:38Z", "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -3183,7 +3184,7 @@ public DiskOffering updateDiskOffering(final UpdateDiskOfferingCmd cmd) {\n             throw new InvalidParameterValueException(String.format(\"Unable to update disk offering: %s by id user: %s because it is not root-admin or domain-admin\", diskOfferingHandle.getUuid(), user.getUuid()));\n         }\n \n-        final boolean updateNeeded = name != null || displayText != null || sortKey != null || displayDiskOffering != null;\n+        final boolean updateNeeded = name != null || displayText != null || sortKey != null || displayDiskOffering != null || tags != null;", "originalCommit": "d5d13d91c4868efdd5c89c00d6b71db9ae15d81d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1OTE0Mw==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r461859143", "bodyText": "I extract this to an method, and add documentation for this new method", "author": "RodrigoDLopez", "createdAt": "2020-07-28T20:29:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNDMzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNDM3Mw==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r460404373", "body": "Use the String utils here, then you do not need two ifs", "bodyText": "Use the String utils here, then you do not need two ifs", "bodyHTML": "<p dir=\"auto\">Use the String utils here, then you do not need two ifs</p>", "author": "rafaelweingartner", "createdAt": "2020-07-25T13:19:03Z", "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -3207,30 +3208,13 @@ public DiskOffering updateDiskOffering(final UpdateDiskOfferingCmd cmd) {\n             diskOffering.setDisplayOffering(displayDiskOffering);\n         }\n \n-        // Note: tag editing commented out for now;keeping the code intact,\n-        // might need to re-enable in next releases\n-        // if (tags != null)\n-        // {\n-        // if (tags.trim().isEmpty() && diskOfferingHandle.getTags() == null)\n-        // {\n-        // //no new tags; no existing tags\n-        // diskOffering.setTagsArray(csvTagsToList(null));\n-        // }\n-        // else if (!tags.trim().isEmpty() && diskOfferingHandle.getTags() !=\n-        // null)\n-        // {\n-        // //new tags + existing tags\n-        // List<String> oldTags = csvTagsToList(diskOfferingHandle.getTags());\n-        // List<String> newTags = csvTagsToList(tags);\n-        // oldTags.addAll(newTags);\n-        // diskOffering.setTagsArray(oldTags);\n-        // }\n-        // else if(!tags.trim().isEmpty())\n-        // {\n-        // //new tags; NO existing tags\n-        // diskOffering.setTagsArray(csvTagsToList(tags));\n-        // }\n-        // }\n+        if (tags != null){", "originalCommit": "d5d13d91c4868efdd5c89c00d6b71db9ae15d81d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNDQ3MQ==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r460404471", "body": "So, whenever updating the offering, we need to send the old(already configured) tags? Even when we do not want to update them?\r\n\r\nOtherwise, it seems that you would always set it to null (even if we do not want that)", "bodyText": "So, whenever updating the offering, we need to send the old(already configured) tags? Even when we do not want to update them?\nOtherwise, it seems that you would always set it to null (even if we do not want that)", "bodyHTML": "<p dir=\"auto\">So, whenever updating the offering, we need to send the old(already configured) tags? Even when we do not want to update them?</p>\n<p dir=\"auto\">Otherwise, it seems that you would always set it to null (even if we do not want that)</p>", "author": "rafaelweingartner", "createdAt": "2020-07-25T13:20:00Z", "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -3207,30 +3208,13 @@ public DiskOffering updateDiskOffering(final UpdateDiskOfferingCmd cmd) {\n             diskOffering.setDisplayOffering(displayDiskOffering);\n         }\n \n-        // Note: tag editing commented out for now;keeping the code intact,\n-        // might need to re-enable in next releases\n-        // if (tags != null)\n-        // {\n-        // if (tags.trim().isEmpty() && diskOfferingHandle.getTags() == null)\n-        // {\n-        // //no new tags; no existing tags\n-        // diskOffering.setTagsArray(csvTagsToList(null));\n-        // }\n-        // else if (!tags.trim().isEmpty() && diskOfferingHandle.getTags() !=\n-        // null)\n-        // {\n-        // //new tags + existing tags\n-        // List<String> oldTags = csvTagsToList(diskOfferingHandle.getTags());\n-        // List<String> newTags = csvTagsToList(tags);\n-        // oldTags.addAll(newTags);\n-        // diskOffering.setTagsArray(oldTags);\n-        // }\n-        // else if(!tags.trim().isEmpty())\n-        // {\n-        // //new tags; NO existing tags\n-        // diskOffering.setTagsArray(csvTagsToList(tags));\n-        // }\n-        // }\n+        if (tags != null){\n+            if(tags.isBlank()){", "originalCommit": "d5d13d91c4868efdd5c89c00d6b71db9ae15d81d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDUxNzIzMQ==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r460517231", "bodyText": "I see what you did now. I created a method to remove the tags by sending blank spaces. Can you extract this to a method? Then, document it, and create unit tests? Also, we need an end-user documentation for this one.", "author": "rafaelweingartner", "createdAt": "2020-07-26T11:47:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNDQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1OTUzNQ==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r461859535", "bodyText": "done... thanks for the hint", "author": "RodrigoDLopez", "createdAt": "2020-07-28T20:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQwNDQ3MQ=="}], "type": "inlineReview"}, {"oid": "96b3aef5df9d8f26a442d6cdabcc14cf1303bd5b", "url": "https://github.com/apache/cloudstack/commit/96b3aef5df9d8f26a442d6cdabcc14cf1303bd5b", "message": "Extract new methods\n\nadd two new methods: updateDiskOfferingTagsIfIsNotNull that will check  and set tags to the diskOffering; isUpdateDiskOfferingNeeded that verify if any update is needed.\n\nCreate unit tests do cover all those new methods", "committedDate": "2020-07-28T19:36:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTk0NTkxMQ==", "url": "https://github.com/apache/cloudstack/pull/4194#discussion_r461945911", "body": "`shouldUpdateDiskOffering` sounds better to me. However, I am not a native speaker. Therefore, change only if you also agree with me.", "bodyText": "shouldUpdateDiskOffering sounds better to me. However, I am not a native speaker. Therefore, change only if you also agree with me.", "bodyHTML": "<p dir=\"auto\"><code>shouldUpdateDiskOffering</code> sounds better to me. However, I am not a native speaker. Therefore, change only if you also agree with me.</p>", "author": "rafaelweingartner", "createdAt": "2020-07-28T23:14:33Z", "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -3183,7 +3184,7 @@ public DiskOffering updateDiskOffering(final UpdateDiskOfferingCmd cmd) {\n             throw new InvalidParameterValueException(String.format(\"Unable to update disk offering: %s by id user: %s because it is not root-admin or domain-admin\", diskOfferingHandle.getUuid(), user.getUuid()));\n         }\n \n-        final boolean updateNeeded = name != null || displayText != null || sortKey != null || displayDiskOffering != null;\n+        final boolean updateNeeded = isUpdateDiskOfferingNeeded(name, displayText, sortKey, displayDiskOffering, tags);", "originalCommit": "96b3aef5df9d8f26a442d6cdabcc14cf1303bd5b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "81e086bb1d9da5a248c6725ecb905bc59ed5ece8", "url": "https://github.com/apache/cloudstack/commit/81e086bb1d9da5a248c6725ecb905bc59ed5ece8", "message": "Extract new methods\n\nadd two new methods: updateDiskOfferingTagsIfIsNotNull that will check  and set tags to the diskOffering; isUpdateDiskOfferingNeeded that verify if any update is needed.\n\nCreate unit tests do cover all those new methods\n\n\nfix", "committedDate": "2020-07-29T18:05:30Z", "type": "forcePushed"}, {"oid": "c8fa15703b36f40be2d510660346561973d617ea", "url": "https://github.com/apache/cloudstack/commit/c8fa15703b36f40be2d510660346561973d617ea", "message": "Extract new methods\n\nadd two new methods: updateDiskOfferingTagsIfIsNotNull that will check  and set tags to the diskOffering; isUpdateDiskOfferingNeeded that verify if any update is needed.\n\nCreate unit tests do cover all those new methods", "committedDate": "2020-07-29T19:05:52Z", "type": "commit"}, {"oid": "c8fa15703b36f40be2d510660346561973d617ea", "url": "https://github.com/apache/cloudstack/commit/c8fa15703b36f40be2d510660346561973d617ea", "message": "Extract new methods\n\nadd two new methods: updateDiskOfferingTagsIfIsNotNull that will check  and set tags to the diskOffering; isUpdateDiskOfferingNeeded that verify if any update is needed.\n\nCreate unit tests do cover all those new methods", "committedDate": "2020-07-29T19:05:52Z", "type": "forcePushed"}]}