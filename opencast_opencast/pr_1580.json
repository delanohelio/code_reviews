{"pr_number": 1580, "pr_title": "TagWorkflowOperationHandler now allows wildcards in target flavor", "pr_author": "marwyg", "pr_createdAt": "2020-05-12T15:33:09Z", "pr_url": "https://github.com/opencast/opencast/pull/1580", "timeline": [{"oid": "7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "url": "https://github.com/opencast/opencast/commit/7ecfc38080d7a392d5e3553fc61b7d469fa912f1", "message": "TagWorkflowOperationHandler now allows wildcards in type and subtype.", "committedDate": "2020-06-09T17:49:00Z", "type": "forcePushed"}, {"oid": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "url": "https://github.com/opencast/opencast/commit/ae3986b8d69562a72ac9fcae6bd211139952ad32", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-06-10T18:40:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MDc3Mg==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496040772", "body": "This should be `WorkflowOperationException`", "bodyText": "This should be WorkflowOperationException", "bodyHTML": "<p dir=\"auto\">This should be <code>WorkflowOperationException</code></p>", "author": "gregorydlogan", "createdAt": "2020-09-28T15:28:24Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTE2MA==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496041160", "body": "Ideally this should be a class level constant.", "bodyText": "Ideally this should be a class level constant.", "bodyHTML": "<p dir=\"auto\">Ideally this should be a class level constant.</p>", "author": "gregorydlogan", "createdAt": "2020-09-28T15:28:52Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);\n+      }\n+      wildcardInTargetFlavorType = \"*\".equals(targetFlavorTypes[0]);", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA0MTc2OA==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496041768", "body": "This call escapes the *, the following one does not.  They should be the same, right?", "bodyText": "This call escapes the *, the following one does not.  They should be the same, right?", "bodyHTML": "<p dir=\"auto\">This call escapes the *, the following one does not.  They should be the same, right?</p>", "author": "gregorydlogan", "createdAt": "2020-09-28T15:29:44Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -127,8 +141,21 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n         element.setIdentifier(null);\n         element.setURI(e.getURI()); // use the same URI as the original\n       }\n-      if (configuredTargetFlavor != null)\n-        element.setFlavor(MediaPackageElementFlavor.parseFlavor(configuredTargetFlavor));\n+\n+      if (configuredTargetFlavor != null) {\n+        String targetFlavor = configuredTargetFlavor;\n+\n+        if (wildcardInTargetFlavorType) {\n+          targetFlavor = targetFlavor.replaceFirst(\"\\\\*\", element.getFlavor().getType());", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4NzMwMw==", "url": "https://github.com/opencast/opencast/pull/1580#discussion_r496087303", "body": "Don't log an error when you throw an exception anyway. The result will just be that you see the same error twice in the logs. Also, I like short messages ;-)\r\n\r\n```suggestion\r\n        final String errorMsg = String.format(\"The configured target flavor `%s` has a wrong format.\", configuredTargetFlavor);\r\n        throw new RuntimeException(errorMsg);\r\n```", "bodyText": "Don't log an error when you throw an exception anyway. The result will just be that you see the same error twice in the logs. Also, I like short messages ;-)\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n          \n          \n            \n                            + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n          \n          \n            \n                    logger.error(errorMsg);\n          \n          \n            \n                    throw new RuntimeException(errorMsg);\n          \n          \n            \n                    final String errorMsg = String.format(\"The configured target flavor `%s` has a wrong format.\", configuredTargetFlavor);\n          \n          \n            \n                    throw new RuntimeException(errorMsg);", "bodyHTML": "<p dir=\"auto\">Don't log an error when you throw an exception anyway. The result will just be that you see the same error twice in the logs. Also, I like short messages ;-)</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">String</span> errorMsg <span class=\"pl-k\">=</span> <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The configured target flavor has a wrong format. <span class=\"pl-pds\">\"</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The configured target flavor: '%s'.<span class=\"pl-pds\">\"</span></span>, configuredTargetFlavor);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        logger<span class=\"pl-k\">.</span>error(errorMsg);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RuntimeException</span>(errorMsg);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> errorMsg <span class=\"pl-k\">=</span> <span class=\"pl-smi\">String</span><span class=\"pl-k\">.</span>format(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>The configured target flavor `%s` has a wrong format.<span class=\"pl-pds\">\"</span></span>, configuredTargetFlavor);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">RuntimeException</span>(errorMsg);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "lkiesow", "createdAt": "2020-09-28T16:38:45Z", "path": "modules/workflow-workflowoperation/src/main/java/org/opencastproject/workflow/handler/workflow/TagWorkflowOperationHandler.java", "diffHunk": "@@ -119,6 +119,20 @@ public WorkflowOperationResult start(WorkflowInstance workflowInstance, JobConte\n       elementSelector.addTag(tag);\n     }\n \n+    boolean wildcardInTargetFlavorType = false;\n+    boolean wildcardInTargetFlavorSubtype = false;\n+    if (configuredTargetFlavor != null) {\n+      String[] targetFlavorTypes = configuredTargetFlavor.split(\"/\");\n+      if (targetFlavorTypes.length != 2) {\n+        String errorMsg = String.format(\"The configured target flavor has a wrong format. \"\n+                + \"The configured target flavor: '%s'.\", configuredTargetFlavor);\n+        logger.error(errorMsg);\n+        throw new RuntimeException(errorMsg);", "originalCommit": "ae3986b8d69562a72ac9fcae6bd211139952ad32", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "url": "https://github.com/opencast/opencast/commit/f66c688d021c80aabdbee54fcae98c91cc0fc7a7", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:33:44Z", "type": "forcePushed"}, {"oid": "d8953199f672eec83d36ac6a939d7fa0ae69174f", "url": "https://github.com/opencast/opencast/commit/d8953199f672eec83d36ac6a939d7fa0ae69174f", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:43:00Z", "type": "forcePushed"}, {"oid": "9757ef62aa0ea7ba0c853a7ef4c400368133336e", "url": "https://github.com/opencast/opencast/commit/9757ef62aa0ea7ba0c853a7ef4c400368133336e", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:59:45Z", "type": "commit"}, {"oid": "9757ef62aa0ea7ba0c853a7ef4c400368133336e", "url": "https://github.com/opencast/opencast/commit/9757ef62aa0ea7ba0c853a7ef4c400368133336e", "message": "TagWorkflowOperationHandler now allows wildcards in target flavor type and subtype.", "committedDate": "2020-09-30T14:59:45Z", "type": "forcePushed"}]}