{"pr_number": 1633, "pr_title": "Using ConcurrentHashMap for synchronizing LTI user login", "pr_author": "otti-ssystems", "pr_createdAt": "2020-06-08T18:13:27Z", "pr_url": "https://github.com/opencast/opencast/pull/1633", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1OTQxOA==", "url": "https://github.com/opencast/opencast/pull/1633#discussion_r437059418", "body": "This now becomes expected behavior and is not something we need to warn users about, is it?\r\n\r\n```suggestion\r\n        logger.debug(\"Concurrent access of user {}. Igoring.\", username);\r\n```", "bodyText": "This now becomes expected behavior and is not something we need to warn users about, is it?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    logger.warn(\"Concurrent access of user {}. Igoring.\", username);\n          \n          \n            \n                    logger.debug(\"Concurrent access of user {}. Igoring.\", username);", "bodyHTML": "<p dir=\"auto\">This now becomes expected behavior and is not something we need to warn users about, is it?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        logger<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">warn</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Concurrent access of user {}. Igoring.<span class=\"pl-pds\">\"</span></span>, username);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        logger<span class=\"pl-k\">.</span><span class=\"x x-first x-last\">debug</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Concurrent access of user {}. Igoring.<span class=\"pl-pds\">\"</span></span>, username);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "lkiesow", "createdAt": "2020-06-08T23:42:07Z", "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -315,37 +317,36 @@ public Authentication createAuthentication(HttpServletRequest request, ConsumerA\n     userAuthorities.add(new SimpleGrantedAuthority(\"ROLE_USER\"));\n     userAuthorities.add(new SimpleGrantedAuthority(\"ROLE_ANONYMOUS\"));\n \n-\n     // Create/Update the user reference\n     if (createJpaUserReference) {\n-      JpaOrganization organization = fromOrganization(securityService.getOrganization());\n-\n-      JpaUserReference jpaUserReference = userReferenceProvider.findUserReference(username, organization.getId());\n-\n-      Set<JpaRole> jpaRoles = new HashSet<>();\n-      for (GrantedAuthority authority : userAuthorities) {\n-        jpaRoles.add(new JpaRole(authority.getAuthority(), organization));\n-      }\n-\n-      Date loginDate = new Date();\n+      if (attempts.putIfAbsent(username, Boolean.TRUE) != null) {\n+        logger.warn(\"Concurrent access of user {}. Igoring.\", username);", "originalCommit": "dd4fdb536875c867eb24f932c0194da07cfb464c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA2MDA4MA==", "url": "https://github.com/opencast/opencast/pull/1633#discussion_r437060080", "body": "Purely nitpicking but it's not that we count attempts so the choice for the name seems a bit odd.\r\n;aybe:\r\n\r\n```suggestion\r\n  private Map<String, Boolean> activePersistence = new ConcurrentHashMap<>(128);\r\n```", "bodyText": "Purely nitpicking but it's not that we count attempts so the choice for the name seems a bit odd.\n;aybe:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private Map<String, Boolean> attempts = new ConcurrentHashMap<>(128);\n          \n          \n            \n              private Map<String, Boolean> activePersistence = new ConcurrentHashMap<>(128);", "bodyHTML": "<p dir=\"auto\">Purely nitpicking but it's not that we count attempts so the choice for the name seems a bit odd.<br>\n;aybe:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Boolean</span>&gt;</span> <span class=\"x x-first x-last\">attempts</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ConcurrentHashMap&lt;&gt;</span>(<span class=\"pl-c1\">128</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">  <span class=\"pl-k\">private</span> <span class=\"pl-k\">Map&lt;<span class=\"pl-smi\">String</span>, <span class=\"pl-smi\">Boolean</span>&gt;</span> <span class=\"x x-first x-last\">activePersistence</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">ConcurrentHashMap&lt;&gt;</span>(<span class=\"pl-c1\">128</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "lkiesow", "createdAt": "2020-06-08T23:44:13Z", "path": "modules/security-lti/src/main/java/org/opencastproject/security/lti/LtiLaunchAuthenticationHandler.java", "diffHunk": "@@ -137,6 +137,9 @@\n   /** Set of usernames that should not authenticated as themselves even if the OAuth consumer keys is trusted */\n   private Set<String> usernameBlacklist = new HashSet<>();\n \n+  /** concurrent attemtps */\n+  private Map<String, Boolean> attempts = new ConcurrentHashMap<>(128);", "originalCommit": "dd4fdb536875c867eb24f932c0194da07cfb464c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "df29ed6f7c55df3cb996ccae3c4db6afb82ac71f", "url": "https://github.com/opencast/opencast/commit/df29ed6f7c55df3cb996ccae3c4db6afb82ac71f", "message": "refs #4904 FIX using ConcurrentHashMap for LTI login User", "committedDate": "2020-06-09T18:16:40Z", "type": "commit"}, {"oid": "59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "url": "https://github.com/opencast/opencast/commit/59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "message": "Fix LTI build and naming\n\n- Fix build\n- warn to debug logging\n- Fix typo\n- Improve name of HashMap", "committedDate": "2020-06-09T18:23:45Z", "type": "commit"}, {"oid": "59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "url": "https://github.com/opencast/opencast/commit/59908ed3ef1c9a108d274e6e5f08e3ed1c15d0d1", "message": "Fix LTI build and naming\n\n- Fix build\n- warn to debug logging\n- Fix typo\n- Improve name of HashMap", "committedDate": "2020-06-09T18:23:45Z", "type": "forcePushed"}, {"oid": "8d53f7bb63e8155cc04be041e31514fbb5130bbb", "url": "https://github.com/opencast/opencast/commit/8d53f7bb63e8155cc04be041e31514fbb5130bbb", "message": "Concurrent LTI Requests\n\nThis patch adds an additional safeguard for handling concurrent\nauthentication requests executed on multiple server.", "committedDate": "2020-06-09T20:24:19Z", "type": "commit"}]}