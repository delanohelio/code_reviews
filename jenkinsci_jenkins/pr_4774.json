{"pr_number": 4774, "pr_title": "[JENKINS-26097] Adjust label expression auto-completion and validation", "pr_author": "Zastai", "pr_createdAt": "2020-06-06T16:21:38Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4774", "timeline": [{"oid": "d7a89aed2ec64f2b30688bdb2cbdbf2c3a89b17f", "url": "https://github.com/jenkinsci/jenkins/commit/d7a89aed2ec64f2b30688bdb2cbdbf2c3a89b17f", "message": "JENKINS-26097: Adjust label expression auto-completion and validation.\n\nThis moves label expression auto-completion and validation from AbstractProject\nto LabelExpression.\n\nAuto-Completion:\n- AbstractProject.AutoCompleteSeerder was moved to LabelExpression\n  - test class correspondingly moved to the relevant package\n- added static LabelExpression.autoComplete() method\n  - does what the non-static AbstractProject.doAutoCompleteLabel() used to do; that now calls the new static method\n\nValidation:\n- added LabelExpression.LabelValidator, which is like AbstractProject.LabelValidator except it takes a Job instead of an AbstractProject\n  - AbstractProject.LabelValidator is now deprecated\n- added static LabelExpression.validate(String, Job) method, which replaces AbstractProject.validateLabelExpression(String, AbstractProject)\n  - the latter is marked as deprecated and forwards to the former\n- LabelExpressionTest.formValidation() uses the new static method", "committedDate": "2020-06-06T16:01:55Z", "type": "commit"}, {"oid": "9cbd50ae57c1a10d29d4c13e59999c8974f4bf55", "url": "https://github.com/jenkinsci/jenkins/commit/9cbd50ae57c1a10d29d4c13e59999c8974f4bf55", "message": "Add auto-completion and validation for the label fields on tool installers.", "committedDate": "2020-06-06T17:11:58Z", "type": "commit"}, {"oid": "ab7fa7dc32bc4715d566f358b64e668e6dd6d467", "url": "https://github.com/jenkinsci/jenkins/commit/ab7fa7dc32bc4715d566f358b64e668e6dd6d467", "message": "Merge branch 'master' into JENKINS-26097", "committedDate": "2020-06-06T19:36:10Z", "type": "commit"}, {"oid": "14d1efb4a42cf086a269f6010f46ed54876d9589", "url": "https://github.com/jenkinsci/jenkins/commit/14d1efb4a42cf086a269f6010f46ed54876d9589", "message": "Use TODO, not FIXME for @since.", "committedDate": "2020-06-06T20:39:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2MzcyMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437663720", "body": "Could be an `interface` I suppose.", "bodyText": "Could be an interface I suppose.", "bodyHTML": "<p dir=\"auto\">Could be an <code>interface</code> I suppose.</p>", "author": "jglick", "createdAt": "2020-06-09T19:22:19Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -210,4 +225,158 @@ public LabelOperatorPrecedence precedence() {\n             return LabelOperatorPrecedence.IMPLIES;\n         }\n     }\n+\n+    //region Auto-Completion and Validation\n+\n+    /**\n+     * Utility class for taking the current input value and computing a list of potential terms to match against the\n+     * list of defined labels.\n+     */\n+    static class AutoCompleteSeeder {\n+        private String source;\n+\n+        AutoCompleteSeeder(String source) {\n+            this.source = source;\n+        }\n+\n+        List<String> getSeeds() {\n+            ArrayList<String> terms = new ArrayList<>();\n+            boolean trailingQuote = source.endsWith(\"\\\"\");\n+            boolean leadingQuote = source.startsWith(\"\\\"\");\n+            boolean trailingSpace = source.endsWith(\" \");\n+\n+            if (trailingQuote || (trailingSpace && !leadingQuote)) {\n+                terms.add(\"\");\n+            } else {\n+                if (leadingQuote) {\n+                    int quote = source.lastIndexOf('\"');\n+                    if (quote == 0) {\n+                        terms.add(source.substring(1));\n+                    } else {\n+                        terms.add(\"\");\n+                    }\n+                } else {\n+                    int space = source.lastIndexOf(' ');\n+                    if (space > -1) {\n+                        terms.add(source.substring(space+1));\n+                    } else {\n+                        terms.add(source);\n+                    }\n+                }\n+            }\n+\n+            return terms;\n+        }\n+    }\n+\n+    /**\n+     * Plugins may want to contribute additional restrictions on the use of specific labels for specific jobs.\n+     * This extension point allows such restrictions.\n+     *\n+     * @since TODO\n+     */\n+    public static abstract class LabelValidator implements ExtensionPoint {", "originalCommit": "14d1efb4a42cf086a269f6010f46ed54876d9589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwMDQzMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437700433", "bodyText": "Sure. I tried keeping it as close to the original as possible.", "author": "Zastai", "createdAt": "2020-06-09T20:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2MzcyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc1ODAwNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437758004", "bodyText": "Have done this now.", "author": "Zastai", "createdAt": "2020-06-09T22:30:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2MzcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NDEzMw==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437664133", "body": "or can use `ExtensionList.lookup`", "bodyText": "or can use ExtensionList.lookup", "bodyHTML": "<p dir=\"auto\">or can use <code>ExtensionList.lookup</code></p>", "author": "jglick", "createdAt": "2020-06-09T19:23:04Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -210,4 +225,158 @@ public LabelOperatorPrecedence precedence() {\n             return LabelOperatorPrecedence.IMPLIES;\n         }\n     }\n+\n+    //region Auto-Completion and Validation\n+\n+    /**\n+     * Utility class for taking the current input value and computing a list of potential terms to match against the\n+     * list of defined labels.\n+     */\n+    static class AutoCompleteSeeder {\n+        private String source;\n+\n+        AutoCompleteSeeder(String source) {\n+            this.source = source;\n+        }\n+\n+        List<String> getSeeds() {\n+            ArrayList<String> terms = new ArrayList<>();\n+            boolean trailingQuote = source.endsWith(\"\\\"\");\n+            boolean leadingQuote = source.startsWith(\"\\\"\");\n+            boolean trailingSpace = source.endsWith(\" \");\n+\n+            if (trailingQuote || (trailingSpace && !leadingQuote)) {\n+                terms.add(\"\");\n+            } else {\n+                if (leadingQuote) {\n+                    int quote = source.lastIndexOf('\"');\n+                    if (quote == 0) {\n+                        terms.add(source.substring(1));\n+                    } else {\n+                        terms.add(\"\");\n+                    }\n+                } else {\n+                    int space = source.lastIndexOf(' ');\n+                    if (space > -1) {\n+                        terms.add(source.substring(space+1));\n+                    } else {\n+                        terms.add(source);\n+                    }\n+                }\n+            }\n+\n+            return terms;\n+        }\n+    }\n+\n+    /**\n+     * Plugins may want to contribute additional restrictions on the use of specific labels for specific jobs.\n+     * This extension point allows such restrictions.\n+     *\n+     * @since TODO\n+     */\n+    public static abstract class LabelValidator implements ExtensionPoint {\n+\n+        /**\n+         * Validates the use of a label within a job context.\n+         *\n+         * @param job   The job that wants to restrict itself to the specified label.\n+         * @param label The label that the job wants to restrict itself to.\n+         * @return The validation result.\n+         */\n+        @NonNull\n+        public abstract FormValidation check(@NonNull Job<?, ?> job, @NonNull Label label);\n+\n+    }\n+\n+    /**\n+     * Generates auto-completion candidates for a (partial) label.\n+     *\n+     * @param label The (partial) label for which auto-completion is being requested.\n+     * @return A set of auto-completion candidates.\n+     * @since TODO\n+     */\n+    public static AutoCompletionCandidates autoComplete(@Nullable String label) {\n+        AutoCompletionCandidates c = new AutoCompletionCandidates();\n+        Set<Label> labels = Jenkins.get().getLabels();\n+        List<String> queries = new AutoCompleteSeeder(label).getSeeds();\n+\n+        for (String term : queries) {\n+            for (Label l : labels) {\n+                if (l.getName().startsWith(term)) {\n+                    c.add(l.getName());\n+                }\n+            }\n+        }\n+        return c;\n+    }\n+\n+    /**\n+     * Validates a label expression.\n+     *\n+     * @param expression The expression to validate.\n+     * @return The validation result.\n+     * @since TODO\n+     */\n+    @NonNull\n+    public static FormValidation validate(@Nullable String expression) {\n+        return LabelExpression.validate(expression, null);\n+    }\n+\n+    /**\n+     * Validates a label expression.\n+     *\n+     * @param expression The label expression to validate.\n+     * @param job        The job context, if applicable; used for potential additional restrictions.\n+     * @return The validation result.\n+     * @since TODO\n+     */\n+    // FIXME: Should the messages be moved, or kept where they are for backward compatibility?\n+    @NonNull\n+    public static FormValidation validate(@Nullable String expression, @CheckForNull Job<?, ?> job) {\n+        if (Util.fixEmpty(expression) == null)\n+            return FormValidation.ok(); // nothing typed yet\n+        try {\n+            Label.parseExpression(expression);\n+        } catch (ANTLRException e) {\n+            return FormValidation.error(e,\n+                    Messages.AbstractProject_AssignedLabelString_InvalidBooleanExpression(e.getMessage()));\n+        }\n+        Jenkins j = Jenkins.get();\n+        Label l = j.getLabel(expression);\n+        if (l.isEmpty()) {\n+            for (LabelAtom a : l.listAtoms()) {\n+                if (a.isEmpty()) {\n+                    LabelAtom nearest = LabelAtom.findNearest(a.getName());\n+                    return FormValidation.warning(Messages.AbstractProject_AssignedLabelString_NoMatch_DidYouMean(a.getName(),nearest.getDisplayName()));\n+                }\n+            }\n+            return FormValidation.warning(Messages.AbstractProject_AssignedLabelString_NoMatch());\n+        }\n+        if (job != null) {\n+            if (job instanceof AbstractProject) { // Use any project-oriented label validators\n+                final AbstractProject<?, ?> project = (AbstractProject<?,?>) job;\n+                for (AbstractProject.LabelValidator v : j.getExtensionList(AbstractProject.LabelValidator.class)) {", "originalCommit": "14d1efb4a42cf086a269f6010f46ed54876d9589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwMTEzNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437701136", "bodyText": "I just kept the original code (other than wrapping it in a is-it-a-project check); I can look at using this other method instead.", "author": "Zastai", "createdAt": "2020-06-09T20:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NDEzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwMzAwNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437703006", "bodyText": "I just kept the original code (other than wrapping it in a is-it-a-project check)\n\nFine, this was just FYI.", "author": "jglick", "createdAt": "2020-06-09T20:37:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NDEzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NDkxOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437664918", "body": "Why not make `job` be `@CheckForNull` in case a validator can work without a job context?\r\n\r\nOr relax the context type to `Item`?", "bodyText": "Why not make job be @CheckForNull in case a validator can work without a job context?\nOr relax the context type to Item?", "bodyHTML": "<p dir=\"auto\">Why not make <code>job</code> be <code>@CheckForNull</code> in case a validator can work without a job context?</p>\n<p dir=\"auto\">Or relax the context type to <code>Item</code>?</p>", "author": "jglick", "createdAt": "2020-06-09T19:24:32Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -210,4 +225,158 @@ public LabelOperatorPrecedence precedence() {\n             return LabelOperatorPrecedence.IMPLIES;\n         }\n     }\n+\n+    //region Auto-Completion and Validation\n+\n+    /**\n+     * Utility class for taking the current input value and computing a list of potential terms to match against the\n+     * list of defined labels.\n+     */\n+    static class AutoCompleteSeeder {\n+        private String source;\n+\n+        AutoCompleteSeeder(String source) {\n+            this.source = source;\n+        }\n+\n+        List<String> getSeeds() {\n+            ArrayList<String> terms = new ArrayList<>();\n+            boolean trailingQuote = source.endsWith(\"\\\"\");\n+            boolean leadingQuote = source.startsWith(\"\\\"\");\n+            boolean trailingSpace = source.endsWith(\" \");\n+\n+            if (trailingQuote || (trailingSpace && !leadingQuote)) {\n+                terms.add(\"\");\n+            } else {\n+                if (leadingQuote) {\n+                    int quote = source.lastIndexOf('\"');\n+                    if (quote == 0) {\n+                        terms.add(source.substring(1));\n+                    } else {\n+                        terms.add(\"\");\n+                    }\n+                } else {\n+                    int space = source.lastIndexOf(' ');\n+                    if (space > -1) {\n+                        terms.add(source.substring(space+1));\n+                    } else {\n+                        terms.add(source);\n+                    }\n+                }\n+            }\n+\n+            return terms;\n+        }\n+    }\n+\n+    /**\n+     * Plugins may want to contribute additional restrictions on the use of specific labels for specific jobs.\n+     * This extension point allows such restrictions.\n+     *\n+     * @since TODO\n+     */\n+    public static abstract class LabelValidator implements ExtensionPoint {\n+\n+        /**\n+         * Validates the use of a label within a job context.\n+         *\n+         * @param job   The job that wants to restrict itself to the specified label.\n+         * @param label The label that the job wants to restrict itself to.\n+         * @return The validation result.\n+         */\n+        @NonNull\n+        public abstract FormValidation check(@NonNull Job<?, ?> job, @NonNull Label label);", "originalCommit": "14d1efb4a42cf086a269f6010f46ed54876d9589", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcwNTI5NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437705294", "bodyText": "I think the validator concept was added specifically for project-based validation (the main validation code already handles pure label expression validation). It was certainly only ever invoked when a project was specified.\nBut given that this is new API specifically to relax the Project-oriented existing API, I have no issue using Item instead. I lack the familiarity with the codebase to know what additional cases that would enable though.", "author": "Zastai", "createdAt": "2020-06-09T20:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NDkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzcxNTgyNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437715826", "bodyText": "I lack the familiarity with the codebase to know what additional cases that would enable though.\n\nMainly validation on Folders, in case you have something that offers certain labels only in some subfolders. Something like https://github.com/jenkinsci/kubernetes-plugin/blob/d9cf6a810fce807fe35cd56ebe17ffb343c702f4/src/main/resources/org/csanchez/jenkins/plugins/kubernetes/KubernetesFolderProperty/config.jelly#L5 perhaps. (CloudBees CI also has a proprietary example I think.)", "author": "jglick", "createdAt": "2020-06-09T20:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NDkxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc1Nzg3Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r437757872", "bodyText": "Done - Item is now used instead of Job.", "author": "Zastai", "createdAt": "2020-06-09T22:29:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY2NDkxOA=="}], "type": "inlineReview"}, {"oid": "bb89a72e3037189b509e307718d8cbfbf189eee4", "url": "https://github.com/jenkinsci/jenkins/commit/bb89a72e3037189b509e307718d8cbfbf189eee4", "message": "Use Item as validation context for the new API (instead of Job).\n\nIn addition, the new LabelValidators are now applied to AbstractProjects too.", "committedDate": "2020-06-09T22:27:14Z", "type": "commit"}, {"oid": "3fb2b663336bf178dc9cac7832639717759aa470", "url": "https://github.com/jenkinsci/jenkins/commit/3fb2b663336bf178dc9cac7832639717759aa470", "message": "Make LabelExpression.LabelValidator an interface.", "committedDate": "2020-06-09T22:28:56Z", "type": "commit"}, {"oid": "5519088f143934111e70df9e7b260f54cec4741d", "url": "https://github.com/jenkinsci/jenkins/commit/5519088f143934111e70df9e7b260f54cec4741d", "message": "Fix a JavaDoc reference.", "committedDate": "2020-06-10T08:45:12Z", "type": "commit"}, {"oid": "0428cd8726679d09f5ea0de933a72c0698dd0af7", "url": "https://github.com/jenkinsci/jenkins/commit/0428cd8726679d09f5ea0de933a72c0698dd0af7", "message": "Merge branch 'master' into JENKINS-26097", "committedDate": "2020-06-11T15:41:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NDU3NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440044574", "body": "Note that many plugins have copy-pasted the code: https://github.com/search?q=org%3Ajenkinsci+AutoCompleteSeeder&type=Code .\r\nMaybe it;s time to consider making it a public API in `jenkins.model.labels`", "bodyText": "Note that many plugins have copy-pasted the code: https://github.com/search?q=org%3Ajenkinsci+AutoCompleteSeeder&type=Code .\nMaybe it;s time to consider making it a public API in jenkins.model.labels", "bodyHTML": "<p dir=\"auto\">Note that many plugins have copy-pasted the code: <a href=\"https://github.com/search?q=org%3Ajenkinsci+AutoCompleteSeeder&amp;type=Code\">https://github.com/search?q=org%3Ajenkinsci+AutoCompleteSeeder&amp;type=Code</a> .<br>\nMaybe it;s time to consider making it a public API in <code>jenkins.model.labels</code></p>", "author": "oleg-nenashev", "createdAt": "2020-06-15T09:24:33Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -210,4 +225,156 @@ public LabelOperatorPrecedence precedence() {\n             return LabelOperatorPrecedence.IMPLIES;\n         }\n     }\n+\n+    //region Auto-Completion and Validation\n+\n+    /**\n+     * Utility class for taking the current input value and computing a list of potential terms to match against the\n+     * list of defined labels.\n+     */\n+    static class AutoCompleteSeeder {", "originalCommit": "0428cd8726679d09f5ea0de933a72c0698dd0af7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIzNzcxMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440237711", "bodyText": "Makes sense, although it may have been private in part because the auto-completion for labels is still far from perfect - \"foo&&b\" will pop up completion for the \"b\" part, but selecting \"bar\" then replaces the entire expression (mitigated slightly by setting ' ' as delimiter and typing \"foo && b\").\nTo me, the fact that many plugins copied the internal implentation just shows how useful exposing an autoComplete method is; it does not necessarily make a case for exposing that method's internals.\nHaving said that, I don't feel all that strongly about not exposing it either.", "author": "Zastai", "createdAt": "2020-06-15T14:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NDU3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NDk4Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440044983", "body": "```suggestion\r\n    static class LabelAutoCompleteSeeder {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static class AutoCompleteSeeder {\n          \n          \n            \n                static class LabelAutoCompleteSeeder {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">static</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">AutoCompleteSeeder</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">static</span> <span class=\"pl-k\">class</span> <span class=\"pl-en x x-first x-last\">LabelAutoCompleteSeeder</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "oleg-nenashev", "createdAt": "2020-06-15T09:25:11Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -210,4 +225,156 @@ public LabelOperatorPrecedence precedence() {\n             return LabelOperatorPrecedence.IMPLIES;\n         }\n     }\n+\n+    //region Auto-Completion and Validation\n+\n+    /**\n+     * Utility class for taking the current input value and computing a list of potential terms to match against the\n+     * list of defined labels.\n+     */\n+    static class AutoCompleteSeeder {", "originalCommit": "0428cd8726679d09f5ea0de933a72c0698dd0af7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIzODQyNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440238424", "bodyText": "Yes, if moving it out of LabelExpression, adding the Label prefix makes total sense.", "author": "Zastai", "createdAt": "2020-06-15T14:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NDk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NjQyNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440046424", "body": "I would suggest to move it into `jenkins.model.labels` instead of introducing a new nested interface", "bodyText": "I would suggest to move it into jenkins.model.labels instead of introducing a new nested interface", "bodyHTML": "<p dir=\"auto\">I would suggest to move it into <code>jenkins.model.labels</code> instead of introducing a new nested interface</p>", "author": "oleg-nenashev", "createdAt": "2020-06-15T09:27:39Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -210,4 +225,156 @@ public LabelOperatorPrecedence precedence() {\n             return LabelOperatorPrecedence.IMPLIES;\n         }\n     }\n+\n+    //region Auto-Completion and Validation\n+\n+    /**\n+     * Utility class for taking the current input value and computing a list of potential terms to match against the\n+     * list of defined labels.\n+     */\n+    static class AutoCompleteSeeder {\n+        private String source;\n+\n+        AutoCompleteSeeder(String source) {\n+            this.source = source;\n+        }\n+\n+        List<String> getSeeds() {\n+            ArrayList<String> terms = new ArrayList<>();\n+            boolean trailingQuote = source.endsWith(\"\\\"\");\n+            boolean leadingQuote = source.startsWith(\"\\\"\");\n+            boolean trailingSpace = source.endsWith(\" \");\n+\n+            if (trailingQuote || (trailingSpace && !leadingQuote)) {\n+                terms.add(\"\");\n+            } else {\n+                if (leadingQuote) {\n+                    int quote = source.lastIndexOf('\"');\n+                    if (quote == 0) {\n+                        terms.add(source.substring(1));\n+                    } else {\n+                        terms.add(\"\");\n+                    }\n+                } else {\n+                    int space = source.lastIndexOf(' ');\n+                    if (space > -1) {\n+                        terms.add(source.substring(space+1));\n+                    } else {\n+                        terms.add(source);\n+                    }\n+                }\n+            }\n+\n+            return terms;\n+        }\n+    }\n+\n+    /**\n+     * Plugins may want to contribute additional restrictions on the use of specific labels for specific context items.\n+     * This extension point allows such restrictions.\n+     *\n+     * @since TODO\n+     */\n+    public interface LabelValidator extends ExtensionPoint {", "originalCommit": "0428cd8726679d09f5ea0de933a72c0698dd0af7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIzMjQ0MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440232441", "bodyText": "I agree - I initially tried to keep the implementation as close to the original as possible.", "author": "Zastai", "createdAt": "2020-06-15T14:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NjQyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0Njc2OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440046769", "body": "```suggestion\r\n    @NonNull\r\n    public static AutoCompletionCandidates autoComplete(@Nullable String label) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static AutoCompletionCandidates autoComplete(@Nullable String label) {\n          \n          \n            \n                @NonNull\n          \n          \n            \n                public static AutoCompletionCandidates autoComplete(@Nullable String label) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"240\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">public</span><span class=\"x\"> </span><span class=\"pl-k x\">static</span><span class=\"x\"> </span><span class=\"pl-smi x\">AutoCompletionCandidates</span><span class=\"x\"> autoComplete(</span><span class=\"pl-k x\">@Nullable</span><span class=\"x\"> </span><span class=\"pl-smi x\">String</span><span class=\"x x-last\"> label) {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"240\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k x x-first x-last\">@NonNull</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"241\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">AutoCompletionCandidates</span> autoComplete(<span class=\"pl-k\">@Nullable</span> <span class=\"pl-smi\">String</span> label) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "oleg-nenashev", "createdAt": "2020-06-15T09:28:17Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -210,4 +225,156 @@ public LabelOperatorPrecedence precedence() {\n             return LabelOperatorPrecedence.IMPLIES;\n         }\n     }\n+\n+    //region Auto-Completion and Validation\n+\n+    /**\n+     * Utility class for taking the current input value and computing a list of potential terms to match against the\n+     * list of defined labels.\n+     */\n+    static class AutoCompleteSeeder {\n+        private String source;\n+\n+        AutoCompleteSeeder(String source) {\n+            this.source = source;\n+        }\n+\n+        List<String> getSeeds() {\n+            ArrayList<String> terms = new ArrayList<>();\n+            boolean trailingQuote = source.endsWith(\"\\\"\");\n+            boolean leadingQuote = source.startsWith(\"\\\"\");\n+            boolean trailingSpace = source.endsWith(\" \");\n+\n+            if (trailingQuote || (trailingSpace && !leadingQuote)) {\n+                terms.add(\"\");\n+            } else {\n+                if (leadingQuote) {\n+                    int quote = source.lastIndexOf('\"');\n+                    if (quote == 0) {\n+                        terms.add(source.substring(1));\n+                    } else {\n+                        terms.add(\"\");\n+                    }\n+                } else {\n+                    int space = source.lastIndexOf(' ');\n+                    if (space > -1) {\n+                        terms.add(source.substring(space+1));\n+                    } else {\n+                        terms.add(source);\n+                    }\n+                }\n+            }\n+\n+            return terms;\n+        }\n+    }\n+\n+    /**\n+     * Plugins may want to contribute additional restrictions on the use of specific labels for specific context items.\n+     * This extension point allows such restrictions.\n+     *\n+     * @since TODO\n+     */\n+    public interface LabelValidator extends ExtensionPoint {\n+\n+        /**\n+         * Validates the use of a label within a particular context.\n+         *\n+         * @param item  The context item to be restricted by the label.\n+         * @param label The label that the job wants to restrict itself to.\n+         * @return The validation result.\n+         */\n+        @NonNull\n+        FormValidation check(@NonNull Item item, @NonNull Label label);\n+\n+    }\n+\n+    /**\n+     * Generates auto-completion candidates for a (partial) label.\n+     *\n+     * @param label The (partial) label for which auto-completion is being requested.\n+     * @return A set of auto-completion candidates.\n+     * @since TODO\n+     */\n+    public static AutoCompletionCandidates autoComplete(@Nullable String label) {", "originalCommit": "0428cd8726679d09f5ea0de933a72c0698dd0af7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDIzOTM4NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440239385", "bodyText": "Yes. After applying the other suggested changes, I'll make another pass to ensure all new/changed API has complete nullability annotations.", "author": "Zastai", "createdAt": "2020-06-15T14:59:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0Njc2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0ODE1Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440048157", "body": "This approach makes it difficult to adopt the new API without bumping the core dependency. E.g. I could not update https://plugins.jenkins.io/label-verifier/ . Maybe it makes sense to introduce a temporary bridge method in this class so that checks could be added in the existing extension point.\r\n\r\nDoes not block it", "bodyText": "This approach makes it difficult to adopt the new API without bumping the core dependency. E.g. I could not update https://plugins.jenkins.io/label-verifier/ . Maybe it makes sense to introduce a temporary bridge method in this class so that checks could be added in the existing extension point.\nDoes not block it", "bodyHTML": "<p dir=\"auto\">This approach makes it difficult to adopt the new API without bumping the core dependency. E.g. I could not update <a href=\"https://plugins.jenkins.io/label-verifier/\" rel=\"nofollow\">https://plugins.jenkins.io/label-verifier/</a> . Maybe it makes sense to introduce a temporary bridge method in this class so that checks could be added in the existing extension point.</p>\n<p dir=\"auto\">Does not block it</p>", "author": "oleg-nenashev", "createdAt": "2020-06-15T09:30:39Z", "path": "core/src/main/java/hudson/model/AbstractProject.java", "diffHunk": "@@ -2128,7 +2048,9 @@ public void setCustomWorkspace(String customWorkspace) throws IOException {\n      * This extension point allows such restrictions.\n      *\n      * @since 1.540\n+     * @deprecated Use {@link LabelExpression.LabelValidator} instead.\n      */\n+    @Deprecated", "originalCommit": "0428cd8726679d09f5ea0de933a72c0698dd0af7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0NzcwNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440247706", "bodyText": "I mean, the implementation for both validate and auto-complete is standalone.\nSo it could be created as a separate plugin/library, containing just this functionality (wrapped in some new class like LabelUtil, not inside LabelExpression). Then new core could use that \"plugin\", and existing plugins could add a dependency on that rather than a newer Jenkins core.\nI'm just not sure a fairly minor feature like this warrants that.", "author": "Zastai", "createdAt": "2020-06-15T15:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0ODE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4Mzk5Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440383993", "bodyText": "It can be done without a plugin and without complex code actually\n\nUpdate LabelValidator\n\npublic FormValidation checkJob(@NonNull Job<?, ?> job, @NonNull Label label) {\n    return FormValidation.ok()\n}\n\n\n\nIn LabelExpression#validate() add invocation of this method and fail if not OK\n\n\nIn a plugin implement a method without adding explicit @Override annotation. Thanks to Java, it will still be an override which does not require core bump", "author": "oleg-nenashev", "createdAt": "2020-06-15T19:02:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0ODE1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQyMTU1Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440421552", "bodyText": "Ah you meant for the LabelValidator, so for plugins wanting to add validation processing, not plugins wanting to consume the new API.\nSure, I can do that - but I think I'll make the default implementation use Item, and call through to the plain check() when the passed item is an AbstractProject.", "author": "Zastai", "createdAt": "2020-06-15T20:15:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0ODE1Nw=="}], "type": "inlineReview"}, {"oid": "9a658883cc9b4ff6c6522458692c1c54c8a51a23", "url": "https://github.com/jenkinsci/jenkins/commit/9a658883cc9b4ff6c6522458692c1c54c8a51a23", "message": "Move LabelValidator to the top level.", "committedDate": "2020-06-15T18:12:51Z", "type": "commit"}, {"oid": "7a3d722208d7111e6164eb9809f9f47f9011b440", "url": "https://github.com/jenkinsci/jenkins/commit/7a3d722208d7111e6164eb9809f9f47f9011b440", "message": "Move LabelExpression.AutoCompleteSeeder to top level as LabelAutoCompleteSeeder.\n\nThis also adds missing nullability annotations.", "committedDate": "2020-06-15T18:23:42Z", "type": "commit"}, {"oid": "863eae52ec112a136d0c591a1bc659fe929c4730", "url": "https://github.com/jenkinsci/jenkins/commit/863eae52ec112a136d0c591a1bc659fe929c4730", "message": "Moved the i18n messages.\n\nThese are now under LabelExpression.xxx instead of AbstractProject.xxx.\n\nFor the translations, properties were either renamed in-place or moved, depending on whether the file seemed to be sorted alphabetically by property name.", "committedDate": "2020-06-15T18:52:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4MTY1Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440381652", "body": "```suggestion\r\n * list of defined labels.\r\n * @since TODO\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * list of defined labels.\n          \n          \n            \n             * list of defined labels.\n          \n          \n            \n             * @since TODO", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> list of defined labels.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> list of defined labels.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\">TODO</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "oleg-nenashev", "createdAt": "2020-06-15T18:57:49Z", "path": "core/src/main/java/hudson/model/labels/LabelAutoCompleteSeeder.java", "diffHunk": "@@ -0,0 +1,49 @@\n+package hudson.model.labels;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Utility class for taking the current input value and computing a list of potential terms to match against the\n+ * list of defined labels.", "originalCommit": "863eae52ec112a136d0c591a1bc659fe929c4730", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQwNzIzOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r440407239", "bodyText": "Yes, missed that.", "author": "Zastai", "createdAt": "2020-06-15T19:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDM4MTY1Mg=="}], "type": "inlineReview"}, {"oid": "f0621c2700362dddf48b279aa24e0d1f410b53d4", "url": "https://github.com/jenkinsci/jenkins/commit/f0621c2700362dddf48b279aa24e0d1f410b53d4", "message": "Add JavaDoc.", "committedDate": "2020-06-15T20:06:10Z", "type": "commit"}, {"oid": "dc286c768c5493db3b335623b4ab1bf413eb0d26", "url": "https://github.com/jenkinsci/jenkins/commit/dc286c768c5493db3b335623b4ab1bf413eb0d26", "message": "Add a checkItem() to the \"old\" LabelValidator.\n\nBy default, this calls the regular check() if the item is an AbstractProject;\notherwise, it returns OK.\nThis allows a plugin to implement an override for that method in order to have its\nvalidator applied to Jobs too, without needing to bump their Jenkins dependency in\norder to get the new LabelValidator.\n\nAs a result, LabelExpression.validate() now always uses the \"old\" LabelValidators,\ncalling this new method.", "committedDate": "2020-06-15T20:20:38Z", "type": "commit"}, {"oid": "d542a76aee1647b456159c7b4dd1502fbd8ac423", "url": "https://github.com/jenkinsci/jenkins/commit/d542a76aee1647b456159c7b4dd1502fbd8ac423", "message": "Merge branch 'master' into JENKINS-26097", "committedDate": "2020-06-16T21:01:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2NjU4Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r441166583", "body": "I think we prefer to use `jenkins.*` packages for new classes right @oleg-nenashev / @daniel-beck ?", "bodyText": "I think we prefer to use jenkins.* packages for new classes right @oleg-nenashev / @daniel-beck ?", "bodyHTML": "<p dir=\"auto\">I think we prefer to use <code>jenkins.*</code> packages for new classes right <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/oleg-nenashev/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/oleg-nenashev\">@oleg-nenashev</a> / <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/daniel-beck/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/daniel-beck\">@daniel-beck</a> ?</p>", "author": "jglick", "createdAt": "2020-06-16T22:00:09Z", "path": "core/src/main/java/hudson/model/labels/LabelAutoCompleteSeeder.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package hudson.model.labels;", "originalCommit": "d542a76aee1647b456159c7b4dd1502fbd8ac423", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4ODAzOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r441188039", "bodyText": "I can move them, no problem.", "author": "Zastai", "createdAt": "2020-06-16T22:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2NjU4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MTc2NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r441281765", "bodyText": "Yes, we should keep new API in \"jenkins\" if possible. Hudson is still a subject to potential trademark disputes", "author": "oleg-nenashev", "createdAt": "2020-06-17T05:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2NjU4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2NjkyMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r441166921", "body": "Unnecessary IMO; `AbstractProject.LabelValidator` should just be deprecated.", "bodyText": "Unnecessary IMO; AbstractProject.LabelValidator should just be deprecated.", "bodyHTML": "<p dir=\"auto\">Unnecessary IMO; <code>AbstractProject.LabelValidator</code> should just be deprecated.</p>", "author": "jglick", "createdAt": "2020-06-16T22:00:55Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -340,27 +278,27 @@ public static FormValidation validate(@Nullable String expression, @CheckForNull\n             Label.parseExpression(expression);\n         } catch (ANTLRException e) {\n             return FormValidation.error(e,\n-                    Messages.AbstractProject_AssignedLabelString_InvalidBooleanExpression(e.getMessage()));\n+                    Messages.LabelExpression_InvalidBooleanExpression(e.getMessage()));\n         }\n         final Jenkins j = Jenkins.get();\n         Label l = j.getLabel(expression);\n         if (l.isEmpty()) {\n             for (LabelAtom a : l.listAtoms()) {\n                 if (a.isEmpty()) {\n                     LabelAtom nearest = LabelAtom.findNearest(a.getName());\n-                    return FormValidation.warning(Messages.AbstractProject_AssignedLabelString_NoMatch_DidYouMean(a.getName(),nearest.getDisplayName()));\n+                    return FormValidation.warning(Messages.LabelExpression_NoMatch_DidYouMean(a.getName(),nearest.getDisplayName()));\n                 }\n             }\n-            return FormValidation.warning(Messages.AbstractProject_AssignedLabelString_NoMatch());\n+            return FormValidation.warning(Messages.LabelExpression_NoMatch());\n         }\n         if (item != null) {\n-            if (item instanceof AbstractProject) { // Use any project-oriented label validators\n-                final AbstractProject<?, ?> project = (AbstractProject<?,?>) item;\n-                for (AbstractProject.LabelValidator v : j.getExtensionList(AbstractProject.LabelValidator.class)) {\n-                    FormValidation result = v.check(project, l);\n-                    if (!FormValidation.Kind.OK.equals(result.kind)) {\n-                        return result;\n-                    }\n+            // Use the project-oriented validators (including any that might implement checkItem to support non-Project\n+            // items too).\n+            // FIXME: Perhaps these should aggregate their errors/warnings?", "originalCommit": "d542a76aee1647b456159c7b4dd1502fbd8ac423", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE4OTg4Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r441189886", "bodyText": "Without applying AbstractProject.LabelValidator Instances, existing plugins implementing that extension point would stop being applied (and there would be no way for them to support pipeline jobs without changing their core dependency).", "author": "Zastai", "createdAt": "2020-06-16T23:05:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE2NjkyMQ=="}], "type": "inlineReview"}, {"oid": "df6c3735feb21f287633222e86bdb8e67c19a172", "url": "https://github.com/jenkinsci/jenkins/commit/df6c3735feb21f287633222e86bdb8e67c19a172", "message": "Move new classes to jenkins.model.labels.\n\nMoved the test class over as well.\n\nThis also makes the constructor and getSeeds() method of\nLabelAutoCompleteSeeder public.", "committedDate": "2020-06-17T08:20:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNDM0NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444334345", "body": "Perhaps clarify that only non-`OK` results are considered. (You can create `OK` with message, which would be thrown out in this context IIUC.)", "bodyText": "Perhaps clarify that only non-OK results are considered. (You can create OK with message, which would be thrown out in this context IIUC.)", "bodyHTML": "<p dir=\"auto\">Perhaps clarify that only non-<code>OK</code> results are considered. (You can create <code>OK</code> with message, which would be thrown out in this context IIUC.)</p>", "author": "jglick", "createdAt": "2020-06-23T15:58:55Z", "path": "core/src/main/java/jenkins/model/labels/LabelValidator.java", "diffHunk": "@@ -0,0 +1,27 @@\n+package jenkins.model.labels;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import hudson.ExtensionPoint;\n+import hudson.model.Item;\n+import hudson.model.Label;\n+import hudson.util.FormValidation;\n+\n+/**\n+ * Plugins may want to contribute additional restrictions on the use of specific labels for specific context items.\n+ * This extension point allows such restrictions.\n+ *\n+ * @since TODO\n+ */\n+public interface LabelValidator extends ExtensionPoint {\n+\n+    /**\n+     * Validates the use of a label within a particular context.\n+     *\n+     * @param item  The context item to be restricted by the label.\n+     * @param label The label that the job wants to restrict itself to.\n+     * @return The validation result.", "originalCommit": "df6c3735feb21f287633222e86bdb8e67c19a172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzNzQyOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444537429", "bodyText": "Done. I also adjusted the use of these validators so that all warnings and errors they report are aggregated and shown.", "author": "Zastai", "createdAt": "2020-06-23T22:12:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNDM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444336596", "body": "```suggestion\r\n */\r\n@Restricted(NoExternalUse.class)\r\n```\r\n\r\nsince I do not see it being used in any of the downstream PRs and I would expect it to be called only from `LabelExpression.autoComplete`.", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *\n          \n          \n            \n             * @since TODO\n          \n          \n            \n             */\n          \n          \n            \n             */\n          \n          \n            \n            @Restricted(NoExternalUse.class)\n          \n      \n    \n    \n  \n\nsince I do not see it being used in any of the downstream PRs and I would expect it to be called only from LabelExpression.autoComplete.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"12\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"13\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\">TODO</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"14\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"> <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"12\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"> <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"13\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"><span class=\"pl-k\">@Restricted</span>(<span class=\"pl-smi\">NoExternalUse</span><span class=\"pl-k\">.</span>class)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">since I do not see it being used in any of the downstream PRs and I would expect it to be called only from <code>LabelExpression.autoComplete</code>.</p>", "author": "jglick", "createdAt": "2020-06-23T16:02:07Z", "path": "core/src/main/java/jenkins/model/labels/LabelAutoCompleteSeeder.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package jenkins.model.labels;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Utility class for taking the current input value and computing a list of potential terms to match against the\n+ * list of defined labels.\n+ *\n+ * @since TODO\n+ */", "originalCommit": "df6c3735feb21f287633222e86bdb8e67c19a172", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM4ODEwMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444388100", "bodyText": "(plus imports of course)", "author": "jglick", "createdAt": "2020-06-23T17:25:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2ODcyNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444468727", "bodyText": "I'm confused. First I get asked to move it out of the class as a public type so it can be reused, and now you want me to flag it to prevent use.", "author": "Zastai", "createdAt": "2020-06-23T19:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3MDM0NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444470345", "bodyText": "#4774 (comment) for reference. Indeed there are a few plugins which have copied this class. The question is whether they actually needed to, or if they could call LabelExpression.autoComplete instead. If there is a legitimate need to refer to LabelAutocompleteSeeder directly, it could be unrestricted if and when there is a downstream PR demonstrating its proper use.", "author": "jglick", "createdAt": "2020-06-23T19:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3MTcwMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444471700", "bodyText": "Sorry for the mixup, just trying to avoid introducing new public APIs without a clear need.", "author": "jglick", "createdAt": "2020-06-23T19:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3MTg3NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444471875", "bodyText": "I don't really see why anyone would need to use it. I'd personally be in favour to move it back as a private nested implementation detail class.", "author": "Zastai", "createdAt": "2020-06-23T19:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3Mjg3Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444472876", "bodyText": "Assuming that a quick review of the existing copies suggests that they could use the simple autoComplete method, then yes a private nested implementation class would be fine. I see a usage from test sources though it was not clear if that was necessary or not. (Note that @Restricted is ignored in src/test/java/**/*.java. It is designed only to prevent improper use of types in production code.)", "author": "jglick", "createdAt": "2020-06-23T19:59:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3NjcwOQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444476709", "bodyText": "I'll do an org search and check, but I very much suspect all cases copied the seeder because they also copied the autocomplete method, which used the seeder.\nAs for the test, I think the nested class was package-private to make those tests work. I'm not super convinced that unit tests for the seeder make sense though, given that it's just an implementation detail. But it was there, so I kept it, and will continue to keep it until asked otherwise.", "author": "Zastai", "createdAt": "2020-06-23T20:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzNDY0OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444534649", "bodyText": "Each of the cases found by the org search from #4774 (comment) is a plugin that copied the doAutoCompleteXXX() method, and also copied the seeder - some as a nested class, some as a separate one. Think I'll just apply the @Restricted as suggested - it's less work than moving it back and adapting the unit test again too.", "author": "Zastai", "createdAt": "2020-06-23T22:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzNjY4NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r444536685", "bodyText": "Done", "author": "Zastai", "createdAt": "2020-06-23T22:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMzNjU5Ng=="}], "type": "inlineReview"}, {"oid": "071214363e63651427fc056f90a043d0d56fef27", "url": "https://github.com/jenkinsci/jenkins/commit/071214363e63651427fc056f90a043d0d56fef27", "message": "Merge branch 'master' into JENKINS-26097", "committedDate": "2020-06-23T21:14:21Z", "type": "commit"}, {"oid": "1a0aea1239c8d854699837d1403057a09a8b4d6a", "url": "https://github.com/jenkinsci/jenkins/commit/1a0aea1239c8d854699837d1403057a09a8b4d6a", "message": "Tweak messages.\n\nThis avoids referring to a job (because the label validation can be\napplied completely outside of any job context, like in tool installers)\nor an assignment.\n\nAlso aligned terms (\"is serviced by\" -> \"matches\").", "committedDate": "2020-06-23T21:21:41Z", "type": "commit"}, {"oid": "6cfba40d96902bf6fdaf6f7a5477015de6235a0b", "url": "https://github.com/jenkinsci/jenkins/commit/6cfba40d96902bf6fdaf6f7a5477015de6235a0b", "message": "Aggregate label validation problems.\n\nThis still discards all OKs, but instead of stopping at and returning\nthe first warning/error reported, all warnings/errors are returned as\nan aggregated result.\n\nThe JavaDoc for the relevant messages was extended to describe this\nbehaviour.", "committedDate": "2020-06-23T21:47:16Z", "type": "commit"}, {"oid": "a94cb38c96edba174cd9c5e399e833b07b9640f2", "url": "https://github.com/jenkinsci/jenkins/commit/a94cb38c96edba174cd9c5e399e833b07b9640f2", "message": "Flag LabelAutoCompleteSeeder as NoExternalUse.", "committedDate": "2020-06-23T22:08:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1NTY4NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r445055685", "body": "BTW I think if https://github.com/jenkinsci/jenkins/blob/339f9b930e13c78c545a2409e016127e36520c87/core/src/main/java/hudson/util/FormValidation.java#L227-L238 were refined slightly, to ignore all occurrences of `FormValidation.OK` in its input, then the API and this impl could be simplified a bit while actually handling `ok(String)` from validators. Not necessary in this PR, just something I noticed while looking at `aggregate`.", "bodyText": "BTW I think if \n  \n    \n      jenkins/core/src/main/java/hudson/util/FormValidation.java\n    \n    \n        Lines 227 to 238\n      in\n      339f9b9\n    \n    \n    \n    \n\n        \n          \n           final StringBuilder sb = new StringBuilder(\"<ul style='list-style-type: none; padding-left: 0; margin: 0'>\"); \n        \n\n        \n          \n           FormValidation.Kind worst = Kind.OK; \n        \n\n        \n          \n           for (FormValidation validation: validations) { \n        \n\n        \n          \n               sb.append(\"<li>\").append(validation.renderHtml()).append(\"</li>\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (validation.kind.ordinal() > worst.ordinal()) { \n        \n\n        \n          \n                   worst = validation.kind; \n        \n\n        \n          \n               } \n        \n\n        \n          \n           } \n        \n\n        \n          \n           sb.append(\"</ul>\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n           return respond(worst, sb.toString()); \n        \n    \n  \n\n were refined slightly, to ignore all occurrences of FormValidation.OK in its input, then the API and this impl could be simplified a bit while actually handling ok(String) from validators. Not necessary in this PR, just something I noticed while looking at aggregate.", "bodyHTML": "<p dir=\"auto\">BTW I think if <div class=\"border rounded-1 my-2\">\n  <div class=\"f6 px-3 py-2 lh-condensed border-bottom color-bg-subtle\">\n    <p class=\"mb-0 text-bold\">\n      <a href=\"https://github.com/jenkinsci/jenkins/blob/339f9b930e13c78c545a2409e016127e36520c87/core/src/main/java/hudson/util/FormValidation.java#L227-L238\">jenkins/core/src/main/java/hudson/util/FormValidation.java</a>\n    </p>\n    <p class=\"mb-0 color-fg-muted\">\n        Lines 227 to 238\n      in\n      <a data-pjax=\"true\" class=\"commit-tease-sha\" href=\"/jenkinsci/jenkins/commit/339f9b930e13c78c545a2409e016127e36520c87\">339f9b9</a>\n    </p>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper blob-wrapper-embedded data\">\n    <table class=\"highlight tab-size mb-0 js-file-line-container\" data-tab-size=\"8\" data-paste-markdown-skip=\"\">\n\n        <tbody><tr class=\"border-0\">\n          <td id=\"L227\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"227\"></td>\n          <td id=\"LC227\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">StringBuilder</span> sb <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">StringBuilder</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>&lt;ul style='list-style-type: none; padding-left: 0; margin: 0'&gt;<span class=\"pl-pds\">\"</span></span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L228\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"228\"></td>\n          <td id=\"LC228\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-smi\">FormValidation</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Kind</span> worst <span class=\"pl-k\">=</span> <span class=\"pl-smi\">Kind</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>OK</span>; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L229\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"229\"></td>\n          <td id=\"LC229\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">for</span> (<span class=\"pl-smi\">FormValidation</span> validation<span class=\"pl-k\">:</span> validations) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L230\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"230\"></td>\n          <td id=\"LC230\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     sb<span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>&lt;li&gt;<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">.</span>append(validation<span class=\"pl-k\">.</span>renderHtml())<span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>&lt;/li&gt;<span class=\"pl-pds\">\"</span></span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L231\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"231\"></td>\n          <td id=\"LC231\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L232\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"232\"></td>\n          <td id=\"LC232\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     <span class=\"pl-k\">if</span> (validation<span class=\"pl-k\">.</span>kind<span class=\"pl-k\">.</span>ordinal() <span class=\"pl-k\">&gt;</span> worst<span class=\"pl-k\">.</span>ordinal()) { </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L233\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"233\"></td>\n          <td id=\"LC233\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">         worst <span class=\"pl-k\">=</span> validation<span class=\"pl-k\">.</span>kind; </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L234\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"234\"></td>\n          <td id=\"LC234\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">     } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L235\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"235\"></td>\n          <td id=\"LC235\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> } </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L236\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"236\"></td>\n          <td id=\"LC236\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> sb<span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>&lt;/ul&gt;<span class=\"pl-pds\">\"</span></span>); </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L237\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"237\"></td>\n          <td id=\"LC237\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\">  </td>\n        </tr>\n\n        <tr class=\"border-0\">\n          <td id=\"L238\" class=\"blob-num border-0 px-3 py-0 color-bg-default js-line-number\" data-line-number=\"238\"></td>\n          <td id=\"LC238\" class=\"blob-code border-0 px-3 py-0 color-bg-default blob-code-inner js-file-line\"> <span class=\"pl-k\">return</span> respond(worst, sb<span class=\"pl-k\">.</span>toString()); </td>\n        </tr>\n    </tbody></table>\n  </div>\n</div>\n were refined slightly, to ignore all occurrences of <code>FormValidation.OK</code> in its input, then the API and this impl could be simplified a bit while actually handling <code>ok(String)</code> from validators. Not necessary in this PR, just something I noticed while looking at <code>aggregate</code>.</p>", "author": "jglick", "createdAt": "2020-06-24T17:27:58Z", "path": "core/src/main/java/hudson/model/labels/LabelExpression.java", "diffHunk": "@@ -288,28 +289,35 @@ public static FormValidation validate(@Nullable String expression, @CheckForNull\n             for (LabelAtom a : l.listAtoms()) {\n                 if (a.isEmpty()) {\n                     LabelAtom nearest = LabelAtom.findNearest(a.getName());\n-                    return FormValidation.warning(Messages.LabelExpression_NoMatch_DidYouMean(a.getName(),nearest.getDisplayName()));\n+                    return FormValidation.warning(Messages.LabelExpression_NoMatch_DidYouMean(a.getName(), nearest.getDisplayName()));\n                 }\n             }\n             return FormValidation.warning(Messages.LabelExpression_NoMatch());\n         }\n         if (item != null) {\n-            // Use the project-oriented validators (including any that might implement checkItem to support non-Project\n-            // items too).\n-            // FIXME: Perhaps these should aggregate their errors/warnings?\n+            final List<FormValidation> problems = new ArrayList<>();\n+            // Use the project-oriented validators too, so that validation from older plugins still gets applied.\n             for (AbstractProject.LabelValidator v : j.getExtensionList(AbstractProject.LabelValidator.class)) {\n                 FormValidation result = v.checkItem(item, l);\n-                if (!FormValidation.Kind.OK.equals(result.kind)) {\n-                    return result;\n+                if (FormValidation.Kind.OK.equals(result.kind)) {\n+                    continue;", "originalCommit": "a94cb38c96edba174cd9c5e399e833b07b9640f2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5MzE1OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r445093159", "bodyText": "Yes I looked there too. But I'm not sure it would help to get bulleted list entries for \"Label is valid\" (assuming a validator might put that in the OK text) among the errors/warnings.", "author": "Zastai", "createdAt": "2020-06-24T18:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1NTY4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA5NTc0NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4774#discussion_r445095745", "bodyText": "Right\u2014aggregate would need to be made smarter, perhaps:\n\nif no arguments, or all FormValidation.OK, return FormValidation.OK\nelse consider all non-FormValidation.OK arguments with the worst status among the bunch, and\n\nif only one, return that as is\nelse return a bulleted list of those messages", "author": "jglick", "createdAt": "2020-06-24T18:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA1NTY4NQ=="}], "type": "inlineReview"}]}