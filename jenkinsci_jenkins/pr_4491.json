{"pr_number": 4491, "pr_title": "[JENKINS-61071] Ensure that initialization tasks run as SYSTEM", "pr_author": "jglick", "pr_createdAt": "2020-02-13T00:58:25Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4491", "timeline": [{"oid": "f9f8a17292c3acc9875c0779bb89205a450567f1", "url": "https://github.com/jenkinsci/jenkins/commit/f9f8a17292c3acc9875c0779bb89205a450567f1", "message": "[JENKINS-61071] Ensure that initialization tasks run as SYSTEM", "committedDate": "2020-02-13T00:46:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwNDAyNg==", "url": "https://github.com/jenkinsci/jenkins/pull/4491#discussion_r378604026", "body": "Without patch:\r\n\r\n```\r\njava.io.IOException: Failed to install require-system-in-initializer plugin\r\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:942)\r\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:876)\r\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:72)\r\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:62)\r\n\tat hudson.PluginManagerTest.dynamicLoad(PluginManagerTest.java:519)\r\n\tat hudson.PluginManagerTest.requireSystemInInitializer(PluginManagerTest.java:512)\r\n\tat \u2026\r\nCaused by: org.jvnet.hudson.reactor.ReactorException: java.lang.Error: java.lang.reflect.InvocationTargetException\r\n\tat org.jvnet.hudson.reactor.Reactor.execute(Reactor.java:282)\r\n\tat jenkins.InitReactorRunner.run(InitReactorRunner.java:48)\r\n\tat hudson.PluginManager.start(PluginManager.java:992)\r\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:935)\r\n\t... 18 more\r\nCaused by: java.lang.Error: java.lang.reflect.InvocationTargetException\r\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:110)\r\n\tat hudson.init.TaskMethodFinder$TaskImpl.run(TaskMethodFinder.java:175)\r\n\tat org.jvnet.hudson.reactor.Reactor.runTask(Reactor.java:296)\r\n\tat org.jvnet.hudson.reactor.Reactor$2.run(Reactor.java:214)\r\n\tat org.jvnet.hudson.reactor.Reactor$Node.run(Reactor.java:117)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\t... 1 more\r\nCaused by: java.lang.reflect.InvocationTargetException\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:104)\r\n\t... 7 more\r\nCaused by: hudson.security.AccessDeniedException2: anonymous is missing the Overall/Administer permission\r\n\tat hudson.security.ACL.checkPermission(ACL.java:73)\r\n\tat hudson.security.AccessControlled.checkPermission(AccessControlled.java:47)\r\n\tat io.jenkins.plugins.require_system_in_initializer.Main.stuff(Main.java:34)\r\n\t... 12 more\r\n```", "bodyText": "Without patch:\njava.io.IOException: Failed to install require-system-in-initializer plugin\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:942)\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:876)\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:72)\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:62)\n\tat hudson.PluginManagerTest.dynamicLoad(PluginManagerTest.java:519)\n\tat hudson.PluginManagerTest.requireSystemInInitializer(PluginManagerTest.java:512)\n\tat \u2026\nCaused by: org.jvnet.hudson.reactor.ReactorException: java.lang.Error: java.lang.reflect.InvocationTargetException\n\tat org.jvnet.hudson.reactor.Reactor.execute(Reactor.java:282)\n\tat jenkins.InitReactorRunner.run(InitReactorRunner.java:48)\n\tat hudson.PluginManager.start(PluginManager.java:992)\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:935)\n\t... 18 more\nCaused by: java.lang.Error: java.lang.reflect.InvocationTargetException\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:110)\n\tat hudson.init.TaskMethodFinder$TaskImpl.run(TaskMethodFinder.java:175)\n\tat org.jvnet.hudson.reactor.Reactor.runTask(Reactor.java:296)\n\tat org.jvnet.hudson.reactor.Reactor$2.run(Reactor.java:214)\n\tat org.jvnet.hudson.reactor.Reactor$Node.run(Reactor.java:117)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\t... 1 more\nCaused by: java.lang.reflect.InvocationTargetException\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:104)\n\t... 7 more\nCaused by: hudson.security.AccessDeniedException2: anonymous is missing the Overall/Administer permission\n\tat hudson.security.ACL.checkPermission(ACL.java:73)\n\tat hudson.security.AccessControlled.checkPermission(AccessControlled.java:47)\n\tat io.jenkins.plugins.require_system_in_initializer.Main.stuff(Main.java:34)\n\t... 12 more", "bodyHTML": "<p dir=\"auto\">Without patch:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"java.io.IOException: Failed to install require-system-in-initializer plugin\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:942)\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:876)\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:72)\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:62)\n\tat hudson.PluginManagerTest.dynamicLoad(PluginManagerTest.java:519)\n\tat hudson.PluginManagerTest.requireSystemInInitializer(PluginManagerTest.java:512)\n\tat \u2026\nCaused by: org.jvnet.hudson.reactor.ReactorException: java.lang.Error: java.lang.reflect.InvocationTargetException\n\tat org.jvnet.hudson.reactor.Reactor.execute(Reactor.java:282)\n\tat jenkins.InitReactorRunner.run(InitReactorRunner.java:48)\n\tat hudson.PluginManager.start(PluginManager.java:992)\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:935)\n\t... 18 more\nCaused by: java.lang.Error: java.lang.reflect.InvocationTargetException\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:110)\n\tat hudson.init.TaskMethodFinder$TaskImpl.run(TaskMethodFinder.java:175)\n\tat org.jvnet.hudson.reactor.Reactor.runTask(Reactor.java:296)\n\tat org.jvnet.hudson.reactor.Reactor$2.run(Reactor.java:214)\n\tat org.jvnet.hudson.reactor.Reactor$Node.run(Reactor.java:117)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\t... 1 more\nCaused by: java.lang.reflect.InvocationTargetException\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:104)\n\t... 7 more\nCaused by: hudson.security.AccessDeniedException2: anonymous is missing the Overall/Administer permission\n\tat hudson.security.ACL.checkPermission(ACL.java:73)\n\tat hudson.security.AccessControlled.checkPermission(AccessControlled.java:47)\n\tat io.jenkins.plugins.require_system_in_initializer.Main.stuff(Main.java:34)\n\t... 12 more\"><pre><code>java.io.IOException: Failed to install require-system-in-initializer plugin\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:942)\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:876)\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:72)\n\tat hudson.PluginManagerUtil.dynamicLoad(PluginManagerUtil.java:62)\n\tat hudson.PluginManagerTest.dynamicLoad(PluginManagerTest.java:519)\n\tat hudson.PluginManagerTest.requireSystemInInitializer(PluginManagerTest.java:512)\n\tat \u2026\nCaused by: org.jvnet.hudson.reactor.ReactorException: java.lang.Error: java.lang.reflect.InvocationTargetException\n\tat org.jvnet.hudson.reactor.Reactor.execute(Reactor.java:282)\n\tat jenkins.InitReactorRunner.run(InitReactorRunner.java:48)\n\tat hudson.PluginManager.start(PluginManager.java:992)\n\tat hudson.PluginManager.dynamicLoad(PluginManager.java:935)\n\t... 18 more\nCaused by: java.lang.Error: java.lang.reflect.InvocationTargetException\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:110)\n\tat hudson.init.TaskMethodFinder$TaskImpl.run(TaskMethodFinder.java:175)\n\tat org.jvnet.hudson.reactor.Reactor.runTask(Reactor.java:296)\n\tat org.jvnet.hudson.reactor.Reactor$2.run(Reactor.java:214)\n\tat org.jvnet.hudson.reactor.Reactor$Node.run(Reactor.java:117)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\t... 1 more\nCaused by: java.lang.reflect.InvocationTargetException\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat hudson.init.TaskMethodFinder.invoke(TaskMethodFinder.java:104)\n\t... 7 more\nCaused by: hudson.security.AccessDeniedException2: anonymous is missing the Overall/Administer permission\n\tat hudson.security.ACL.checkPermission(ACL.java:73)\n\tat hudson.security.AccessControlled.checkPermission(AccessControlled.java:47)\n\tat io.jenkins.plugins.require_system_in_initializer.Main.stuff(Main.java:34)\n\t... 12 more\n</code></pre></div>", "author": "jglick", "createdAt": "2020-02-13T01:18:47Z", "path": "test/src/test/java/hudson/PluginManagerTest.java", "diffHunk": "@@ -503,6 +503,18 @@ public void requireSystemDuringStart() throws Exception {\n         }\n     }\n \n+    @Issue(\"JENKINS-61071\")\n+    @Test\n+    public void requireSystemInInitializer() throws Exception {\n+        r.jenkins.setSecurityRealm(r.createDummySecurityRealm());\n+        r.jenkins.setAuthorizationStrategy(new MockAuthorizationStrategy());\n+        String pluginShortName = \"require-system-in-initializer\";\n+        dynamicLoad(pluginShortName + \".jpi\");\n+        try (ACLContext context = ACL.as(User.getById(\"underprivileged\", true).impersonate())) {\n+            r.jenkins.pluginManager.start(Collections.singletonList(r.jenkins.pluginManager.getPlugin(pluginShortName)));", "originalCommit": "f9f8a17292c3acc9875c0779bb89205a450567f1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2edec70ab03db0bcf02eaa3e36dd996a8d5d59fe", "url": "https://github.com/jenkinsci/jenkins/commit/2edec70ab03db0bcf02eaa3e36dd996a8d5d59fe", "message": "Merge branch 'master' into InitReactorRunner-SYSTEM-JENKINS-61071", "committedDate": "2020-02-15T11:38:38Z", "type": "commit"}]}