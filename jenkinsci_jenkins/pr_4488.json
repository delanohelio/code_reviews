{"pr_number": 4488, "pr_title": "[JENKINS-61046] - Allow plugins to force an update of the UpdateCenter", "pr_author": "jtnord", "pr_createdAt": "2020-02-11T11:06:58Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4488", "timeline": [{"oid": "7d2346e348022390ca8a498319cef98f7acb85b6", "url": "https://github.com/jenkinsci/jenkins/commit/7d2346e348022390ca8a498319cef98f7acb85b6", "message": "Allow plugins to force an update of the UpdateCenter", "committedDate": "2020-02-11T10:57:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyNTMyNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4488#discussion_r377625324", "body": "Since this becomes part of the public API could you document it?", "bodyText": "Since this becomes part of the public API could you document it?", "bodyHTML": "<p dir=\"auto\">Since this becomes part of the public API could you document it?</p>", "author": "res0nance", "createdAt": "2020-02-11T13:14:28Z", "path": "core/src/main/java/hudson/model/UpdateSite.java", "diffHunk": "@@ -180,7 +180,6 @@ public long getDataTimestamp() {\n         }\n     }\n \n-    @Restricted(NoExternalUse.class)", "originalCommit": "7d2346e348022390ca8a498319cef98f7acb85b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MjQ4Mg==", "url": "https://github.com/jenkinsci/jenkins/pull/4488#discussion_r377672482", "bodyText": "addressed in 9d642eb", "author": "jtnord", "createdAt": "2020-02-11T14:36:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyNTMyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MjAxMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4488#discussion_r377672012", "body": "```suggestion\r\n    /**\r\n     * Forces an update the data file from the configured URL, irrespective of the last time the data was retrieved.\r\n     * @param signatureCheck whether to enforce the signature (may be off only for testing!)\r\n     * @return A {@code FormValidation} indicating the if the update metadata was successfully downloaded from the configured update site\r\n     * @since TODO\r\n     * @throws IOException if there was an error downloading or saving the file.\r\n     */\r\n    public @Nonnull FormValidation updateDirectlyNow(boolean signatureCheck) throws IOException {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @Nonnull FormValidation updateDirectlyNow(boolean signatureCheck) throws IOException {\n          \n          \n            \n                /**\n          \n          \n            \n                 * Forces an update the data file from the configured URL, irrespective of the last time the data was retrieved.\n          \n          \n            \n                 * @param signatureCheck whether to enforce the signature (may be off only for testing!)\n          \n          \n            \n                 * @return A {@code FormValidation} indicating the if the update metadata was successfully downloaded from the configured update site\n          \n          \n            \n                 * @since TODO\n          \n          \n            \n                 * @throws IOException if there was an error downloading or saving the file.\n          \n          \n            \n                 */\n          \n          \n            \n                public @Nonnull FormValidation updateDirectlyNow(boolean signatureCheck) throws IOException {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"207\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k x x-first\">public</span><span class=\"x\"> </span><span class=\"pl-k x\">@Nonnull</span><span class=\"x\"> </span><span class=\"pl-smi x\">FormValidation</span><span class=\"x\"> updateDirectlyNow(</span><span class=\"pl-k x\">boolean</span><span class=\"x\"> signatureCheck) throws </span><span class=\"pl-smi x\">IOException</span><span class=\"x x-last\"> {</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"207\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c x x-first x-last\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"208\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Forces</span> an update the data file from the configured <span class=\"pl-c1\">URL</span>, irrespective of the last time the data was retrieved.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"209\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@param</span> signatureCheck whether to enforce the signature (may be off only <span class=\"pl-k\">for</span> testing<span class=\"pl-k\">!</span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"210\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@return</span> <span class=\"pl-smi\">A</span> {<span class=\"pl-k\">@code</span> <span class=\"pl-smi\">FormValidation</span>} indicating the <span class=\"pl-k\">if</span> the update metadata was successfully downloaded from the configured update site</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"211\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\">TODO</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"212\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@throws</span> <span class=\"pl-smi\">IOException</span> <span class=\"pl-k\">if</span> there was an error downloading or saving the file.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"213\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"214\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">@Nonnull</span> <span class=\"pl-smi\">FormValidation</span> updateDirectlyNow(<span class=\"pl-k\">boolean</span> signatureCheck) throws <span class=\"pl-smi\">IOException</span> {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "jtnord", "createdAt": "2020-02-11T14:35:44Z", "path": "core/src/main/java/hudson/model/UpdateSite.java", "diffHunk": "@@ -180,7 +180,6 @@ public long getDataTimestamp() {\n         }\n     }\n \n-    @Restricted(NoExternalUse.class)\n     public @Nonnull FormValidation updateDirectlyNow(boolean signatureCheck) throws IOException {", "originalCommit": "7d2346e348022390ca8a498319cef98f7acb85b6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d642ebd8c08d8642ef3a433f1a4035d01a1d4f7", "url": "https://github.com/jenkinsci/jenkins/commit/9d642ebd8c08d8642ef3a433f1a4035d01a1d4f7", "message": "Add javadoc to updateDirectlyNow", "committedDate": "2020-02-11T14:36:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk4NzQ0Mw==", "url": "https://github.com/jenkinsci/jenkins/pull/4488#discussion_r377987443", "body": "```suggestion\r\n     * Forces an update of the data file from the configured URL, irrespective of the last time the data was retrieved.\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Forces an update the data file from the configured URL, irrespective of the last time the data was retrieved.\n          \n          \n            \n                 * Forces an update of the data file from the configured URL, irrespective of the last time the data was retrieved.", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Forces</span> an update the data file from the configured <span class=\"pl-c1\">URL</span>, irrespective of the last time the data was retrieved.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Forces</span> an update <span class=\"x x-first x-last\">of </span>the data file from the configured <span class=\"pl-c1\">URL</span>, irrespective of the last time the data was retrieved.</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "res0nance", "createdAt": "2020-02-12T00:56:03Z", "path": "core/src/main/java/hudson/model/UpdateSite.java", "diffHunk": "@@ -180,7 +180,13 @@ public long getDataTimestamp() {\n         }\n     }\n \n-    @Restricted(NoExternalUse.class)\n+    /**\n+     * Forces an update the data file from the configured URL, irrespective of the last time the data was retrieved.", "originalCommit": "9d642ebd8c08d8642ef3a433f1a4035d01a1d4f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "20a2c768a164d7ee474e64cf419e495167a89cd3", "url": "https://github.com/jenkinsci/jenkins/commit/20a2c768a164d7ee474e64cf419e495167a89cd3", "message": "[JENKINS-61046] introduce updateDirectlyNow() and updateDirectly()\n\n@oleg-nenashev notes that the public API should not expose the security\noption that is for testing.  Introduced updateDirectlyNow() as the new\nAPI and updateDirectly() to have a mirror and deprecated\nupdateDirectly(boolean) as a consequence.", "committedDate": "2020-02-12T12:36:52Z", "type": "commit"}, {"oid": "24e42832f26aadccadbd8cf90cc70d04b61186f8", "url": "https://github.com/jenkinsci/jenkins/commit/24e42832f26aadccadbd8cf90cc70d04b61186f8", "message": "fix javadoc grammar\r\n\r\nfixes the grammar of the UpdateSite#updateDirectlyNow javadoc\n\nCo-Authored-By: Raihaan Shouhell <raihaanhimself@gmail.com>", "committedDate": "2020-02-12T12:43:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDExNTU1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4488#discussion_r380115556", "body": "Bonus points for restricting the external use", "bodyText": "Bonus points for restricting the external use", "bodyHTML": "<p dir=\"auto\">Bonus points for restricting the external use</p>", "author": "oleg-nenashev", "createdAt": "2020-02-17T10:59:33Z", "path": "core/src/main/java/hudson/model/UpdateSite.java", "diffHunk": "@@ -160,14 +160,27 @@ public long getDataTimestamp() {\n         return dataTimestamp;\n     }\n \n+    /**\n+     * Update the data file from the given URL if the file\n+     * does not exist, or is otherwise due for update.\n+     * Accepted formats are JSONP or HTML with {@code postMessage}, not raw JSON.\n+     * @return null if no updates are necessary, or the future result\n+     * @since TODO\n+     */\n+    public @CheckForNull Future<FormValidation> updateDirectly() {\n+        return updateDirectly(DownloadService.signatureCheck);\n+    }\n+\n     /**\n      * Update the data file from the given URL if the file\n      * does not exist, or is otherwise due for update.\n      * Accepted formats are JSONP or HTML with {@code postMessage}, not raw JSON.\n      * @param signatureCheck whether to enforce the signature (may be off only for testing!)\n      * @return null if no updates are necessary, or the future result\n      * @since 1.502\n+     * @deprecated use {@linkplain #updateDirectly()}\n      */\n+    @Deprecated", "originalCommit": "24e42832f26aadccadbd8cf90cc70d04b61186f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDExNzE3NA==", "url": "https://github.com/jenkinsci/jenkins/pull/4488#discussion_r380117174", "bodyText": "that would break source compatibility, and that could break some (at least internal) workflows, as well as having the potential to force disabling the Restrictions check a for another year - which was the whole point of this PR to begin with.\nLet's just at least deprecate it for at least a few LTS version first (we could/should start looking at doing a sweep of all deprecated API and look at restrict them based on how long they have been deprecated).", "author": "jtnord", "createdAt": "2020-02-17T11:02:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDExNTU1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyNDg0Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4488#discussion_r380124846", "bodyText": "Fine with me. We break compatibility too often in recent releases", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:19:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDExNTU1Ng=="}], "type": "inlineReview"}]}