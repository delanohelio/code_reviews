{"pr_number": 4478, "pr_title": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "pr_author": "stellargo", "pr_createdAt": "2020-02-06T20:39:12Z", "pr_url": "https://github.com/jenkinsci/jenkins/pull/4478", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r376113724", "body": "Will the tools that discover getters and setters (like Pipeline, Configuration as Code, etc.) recognize the prefix \"block\" and the prefix \"unblock\" as setters?  Are any of them ever expected to need to discover these?", "bodyText": "Will the tools that discover getters and setters (like Pipeline, Configuration as Code, etc.) recognize the prefix \"block\" and the prefix \"unblock\" as setters?  Are any of them ever expected to need to discover these?", "bodyHTML": "<p dir=\"auto\">Will the tools that discover getters and setters (like Pipeline, Configuration as Code, etc.) recognize the prefix \"block\" and the prefix \"unblock\" as setters?  Are any of them ever expected to need to discover these?</p>", "author": "MarkEWaite", "createdAt": "2020-02-06T22:17:52Z", "path": "core/src/main/java/jenkins/model/FingerprintFacet.java", "diffHunk": "@@ -103,6 +108,27 @@ public long getTimestamp() {\n         return timestamp;\n     }\n \n+    /**\n+     * Returns whether Fingerprint deletion has been blocked by this Facet.\n+     */\n+    public boolean isFingerprintDeletionBlocked() {\n+        return fingerprintDeletionBlocked;\n+    }\n+\n+    /**\n+     * Blocks deletion of Fingerprint associated with this Facet.\n+     */\n+    public void blockFingerprintDeletion() {", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI0MDE3MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r376240170", "bodyText": "IIUC, the plugins do need to be able to discover these setters (since they are the ones that create the facets), and would want to block the deletion of the facet.", "author": "stellargo", "createdAt": "2020-02-07T07:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODc3NTc0MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r378775740", "bodyText": "I'm with Mark here, better to use well-known names for setters and getter", "author": "MRamonLeon", "createdAt": "2020-02-13T10:32:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODgzNjY1Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r378836656", "bodyText": "Hi, I had misunderstood. I am happy to convert it to the Jenkins standards. It would be really helpful if you could point me to a code snippet which uses these standards.", "author": "stellargo", "createdAt": "2020-02-13T12:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTU5NQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931595", "bodyText": "It would be a way to go (standard Java setter implemetation)\n    public void setFingerprintDeletionBlocked(boolean value) {", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjExMzcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTYyMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931621", "body": "```suggestion\r\n     * Returns whether Fingerprint deletion has been blocked by this Facet.\r\n     * @since TODO\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns whether Fingerprint deletion has been blocked by this Facet.\n          \n          \n            \n                 * Returns whether Fingerprint deletion has been blocked by this Facet.\n          \n          \n            \n                 * @since TODO", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"107\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Returns</span> whether <span class=\"pl-smi\">Fingerprint</span> deletion has been blocked by <span class=\"pl-c1\">this</span> <span class=\"pl-smi\">Facet</span>.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"107\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Returns</span> whether <span class=\"pl-smi\">Fingerprint</span> deletion has been blocked by <span class=\"pl-c1\">this</span> <span class=\"pl-smi\">Facet</span>.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"108\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\">TODO</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:39:50Z", "path": "core/src/main/java/jenkins/model/FingerprintFacet.java", "diffHunk": "@@ -103,6 +108,27 @@ public long getTimestamp() {\n         return timestamp;\n     }\n \n+    /**\n+     * Returns whether Fingerprint deletion has been blocked by this Facet.", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTYzMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931631", "body": "```suggestion\r\n     * Checks if any Facet of the Fingerprint is blocking its deletion.\r\n     * @since TODO\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Checks if any Facet of the Fingerprint is blocking its deletion.\n          \n          \n            \n                 * Checks if any Facet of the Fingerprint is blocking its deletion.\n          \n          \n            \n                 * @since TODO", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Checks</span> <span class=\"pl-k\">if</span> any <span class=\"pl-smi\">Facet</span> of the <span class=\"pl-smi\">Fingerprint</span> is blocking its deletion.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Checks</span> <span class=\"pl-k\">if</span> any <span class=\"pl-smi\">Facet</span> of the <span class=\"pl-smi\">Fingerprint</span> is blocking its deletion.</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-k\">@since</span> <span class=\"pl-c1\">TODO</span></td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:40:04Z", "path": "core/src/main/java/hudson/model/Fingerprint.java", "diffHunk": "@@ -1305,6 +1305,17 @@ void save(File file) throws IOException {\n         }\n     }\n \n+    /**\n+     * Checks if any Facet of the Fingerprint is blocking its deletion.", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTcwMQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379931701", "body": "Might be great to add some logging later, but the current chance follows the convention", "bodyText": "Might be great to add some logging later, but the current chance follows the convention", "bodyHTML": "<p dir=\"auto\">Might be great to add some logging later, but the current chance follows the convention</p>", "author": "oleg-nenashev", "createdAt": "2020-02-16T20:41:10Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,7 +107,7 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && !fp.isFingerprintDeletionBlocked()) ) {", "originalCommit": "0a0737584adfdf831a1f530114a4c79d05026f39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk5NjMzMA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r379996330", "bodyText": "Thanks @oleg-nenashev , I added logging, let me know if it is fine.", "author": "stellargo", "createdAt": "2020-02-17T05:55:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkzMTcwMQ=="}], "type": "inlineReview"}, {"oid": "25c3eb4dcd16248bf5b97de5903df2ade27d3ff5", "url": "https://github.com/jenkinsci/jenkins/commit/25c3eb4dcd16248bf5b97de5903df2ade27d3ff5", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-17T05:36:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r380129737", "body": "Would be great to reference the facet blocking it", "bodyText": "Would be great to reference the facet blocking it", "bodyHTML": "<p dir=\"auto\">Would be great to reference the facet blocking it</p>", "author": "oleg-nenashev", "createdAt": "2020-02-17T11:31:12Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,11 +107,13 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && !fp.isFingerprintDeletionBlocked()) ) {\n                 listener.getLogger().println(\"deleting obsolete \" + fingerprintFile);\n                 fingerprintFile.delete();\n                 return true;\n             } else {\n+                if (!fp.isAlive() && fp.isFingerprintDeletionBlocked())\n+                    listener.getLogger().println((\"Facet blocked deletion of \" + fingerprintFile));", "originalCommit": "25c3eb4dcd16248bf5b97de5903df2ade27d3ff5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEzNzg5Ng==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r380137896", "bodyText": "A facet by default IIUC only has timestamp and fingerprint attached with it. How would I reference the facet? Should I do it by timestamp? Or should i write a toString method for the facet class?", "author": "stellargo", "createdAt": "2020-02-17T11:51:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE2NzAyOA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381167028", "bodyText": "What about just printing a className? It would at least give the user some idea which facet blocks it", "author": "oleg-nenashev", "createdAt": "2020-02-19T09:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ0MDQ5Nw==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381440497", "bodyText": "@oleg-nenashev Done, I also added the timestamp of creation. Let me know if anything more is required", "author": "stellargo", "createdAt": "2020-02-19T17:49:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEyOTczNw=="}], "type": "inlineReview"}, {"oid": "987bc66dee709d6a9da648a0f213ce398f4af2b9", "url": "https://github.com/jenkinsci/jenkins/commit/987bc66dee709d6a9da648a0f213ce398f4af2b9", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:33:25Z", "type": "forcePushed"}, {"oid": "8815fbc5636ea73124b452bad31a7421ae362c8b", "url": "https://github.com/jenkinsci/jenkins/commit/8815fbc5636ea73124b452bad31a7421ae362c8b", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:52:46Z", "type": "forcePushed"}, {"oid": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "url": "https://github.com/jenkinsci/jenkins/commit/50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:55:16Z", "type": "commit"}, {"oid": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "url": "https://github.com/jenkinsci/jenkins/commit/50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "message": "[JENKINS-28379] Allow FingerprintFacet to block the deletion of Fingerprint", "committedDate": "2020-02-19T14:55:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxMjI0OQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381912249", "body": "```suggestion\r\n            if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion() == null) ) {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion()==null) ) {\n          \n          \n            \n                        if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion() == null) ) {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">if</span> (fp <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">||</span> (<span class=\"pl-k\">!</span>fp<span class=\"pl-k\">.</span>isAlive() <span class=\"pl-k\">&amp;&amp;</span> fp<span class=\"pl-k\">.</span>facetBlockingDeletion()<span class=\"pl-k x x-first x-last\">==</span><span class=\"pl-c1\">null</span>) ) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">if</span> (fp <span class=\"pl-k\">==</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">||</span> (<span class=\"pl-k\">!</span>fp<span class=\"pl-k\">.</span>isAlive() <span class=\"pl-k\">&amp;&amp;</span> fp<span class=\"pl-k\">.</span>facetBlockingDeletion()<span class=\"x x-first\"> </span><span class=\"pl-k x\">==</span><span class=\"x x-last\"> </span><span class=\"pl-c1\">null</span>) ) {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecharp", "createdAt": "2020-02-20T10:29:12Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,11 +111,15 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion()==null) ) {", "originalCommit": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxMzQwMg==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381913402", "body": "```suggestion\r\n                    listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" + DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp()) + \" blocked deletion of \" + fingerprintFile);\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                listener.getLogger().println(deletionBlockerFacet.getClass().getName()+\" created on \"+DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp())+\" blocked deletion of \" + fingerprintFile);\n          \n          \n            \n                                listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" + DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp()) + \" blocked deletion of \" + fingerprintFile);", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    listener<span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>println(deletionBlockerFacet<span class=\"pl-k\">.</span>getClass()<span class=\"pl-k\">.</span>getName()<span class=\"pl-k x x-first x-last\">+</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span> created on <span class=\"pl-pds\">\"</span></span><span class=\"pl-k x x-first x-last\">+</span><span class=\"pl-c1\">DATE_CONVERTER</span><span class=\"pl-k\">.</span>toString(deletionBlockerFacet<span class=\"pl-k\">.</span>getTimestamp())<span class=\"pl-k x x-first x-last\">+</span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span> blocked deletion of <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> fingerprintFile);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    listener<span class=\"pl-k\">.</span>getLogger()<span class=\"pl-k\">.</span>println(deletionBlockerFacet<span class=\"pl-k\">.</span>getClass()<span class=\"pl-k\">.</span>getName()<span class=\"x x-first\"> </span><span class=\"pl-k x\">+</span><span class=\"x x-last\"> </span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span> created on <span class=\"pl-pds\">\"</span></span><span class=\"x x-first\"> </span><span class=\"pl-k x\">+</span><span class=\"x x-last\"> </span><span class=\"pl-c1\">DATE_CONVERTER</span><span class=\"pl-k\">.</span>toString(deletionBlockerFacet<span class=\"pl-k\">.</span>getTimestamp())<span class=\"x x-first\"> </span><span class=\"pl-k x\">+</span><span class=\"x x-last\"> </span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span> blocked deletion of <span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> fingerprintFile);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "alecharp", "createdAt": "2020-02-20T10:31:31Z", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -107,11 +111,15 @@ private void deleteIfEmpty(File dir) {\n     private boolean check(File fingerprintFile, TaskListener listener) {\n         try {\n             Fingerprint fp = loadFingerprint(fingerprintFile);\n-            if (fp == null || !fp.isAlive()) {\n+            if (fp == null || (!fp.isAlive() && fp.facetBlockingDeletion()==null) ) {\n                 listener.getLogger().println(\"deleting obsolete \" + fingerprintFile);\n                 fingerprintFile.delete();\n                 return true;\n             } else {\n+                if (!fp.isAlive()) {\n+                    FingerprintFacet deletionBlockerFacet = fp.facetBlockingDeletion();\n+                    listener.getLogger().println(deletionBlockerFacet.getClass().getName()+\" created on \"+DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp())+\" blocked deletion of \" + fingerprintFile);", "originalCommit": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTkxNDg4MA==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r381914880", "body": "Shouldn't it be annotated with `@CheckForNull`?", "bodyText": "Shouldn't it be annotated with @CheckForNull?", "bodyHTML": "<p dir=\"auto\">Shouldn't it be annotated with <code>@CheckForNull</code>?</p>", "author": "alecharp", "createdAt": "2020-02-20T10:34:02Z", "path": "core/src/main/java/hudson/model/Fingerprint.java", "diffHunk": "@@ -1305,6 +1305,19 @@ void save(File file) throws IOException {\n         }\n     }\n \n+    /**\n+     * Returns a facet that blocks the deletion of the fingerprint.\n+     * Returns null if no such facet.\n+     * @since TODO\n+     */\n+    public FingerprintFacet facetBlockingDeletion() {", "originalCommit": "50cc8ce315e2e66b2aca3e55fd330f26edd7e778", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3b77413b0b82d3529145076258fd98b957456dfa", "url": "https://github.com/jenkinsci/jenkins/commit/3b77413b0b82d3529145076258fd98b957456dfa", "message": "Syntax improvements + CheckForNull annotation", "committedDate": "2020-02-21T20:22:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzc3NzU4MQ==", "url": "https://github.com/jenkinsci/jenkins/pull/4478#discussion_r383777581", "body": "```suggestion\r\n    public @CheckForNull FingerprintFacet getFacetBlockingDeletion() {\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public @CheckForNull FingerprintFacet facetBlockingDeletion() {\n          \n          \n            \n                public @CheckForNull FingerprintFacet getFacetBlockingDeletion() {", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">@CheckForNull</span> <span class=\"pl-smi\">FingerprintFacet</span> <span class=\"x x-first x-last\">facetBlockingDeletion</span>() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-k\">@CheckForNull</span> <span class=\"pl-smi\">FingerprintFacet</span> <span class=\"x x-first x-last\">getFacetBlockingDeletion</span>() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "oleg-nenashev", "createdAt": "2020-02-25T10:05:47Z", "path": "core/src/main/java/hudson/model/Fingerprint.java", "diffHunk": "@@ -1305,6 +1305,19 @@ void save(File file) throws IOException {\n         }\n     }\n \n+    /**\n+     * Returns a facet that blocks the deletion of the fingerprint.\n+     * Returns null if no such facet.\n+     * @since TODO\n+     */\n+    public @CheckForNull FingerprintFacet facetBlockingDeletion() {", "originalCommit": "3b77413b0b82d3529145076258fd98b957456dfa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "url": "https://github.com/jenkinsci/jenkins/commit/7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "message": "Changed method name 'facetBlockingDeletion' -> 'getFacetBlockingDeletion'", "committedDate": "2020-02-25T12:31:00Z", "type": "commit"}, {"oid": "7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "url": "https://github.com/jenkinsci/jenkins/commit/7ace7a77fc849232d9fef11f4dfafb7f8dd7f137", "message": "Changed method name 'facetBlockingDeletion' -> 'getFacetBlockingDeletion'", "committedDate": "2020-02-25T12:31:00Z", "type": "forcePushed"}]}