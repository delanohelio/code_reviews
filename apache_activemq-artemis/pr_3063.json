{"pr_number": 3063, "pr_title": "ARTEMIS-2692 refactor queue creation", "pr_createdAt": "2020-04-05T15:27:49Z", "pr_url": "https://github.com/apache/activemq-artemis/pull/3063", "merge_commit": "42f75537e47a4b7b1ceb3d3528a1df3833397f9f", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczMDM5MA==", "url": "https://github.com/apache/activemq-artemis/pull/3063#discussion_r403730390", "body": "I'm wondering, do we still need all these overloads like `createSharedQueue` and `createTemporaryQueue`. Shouldn't the intent be expressed by the state of `QueueConfiguration` object itself? As the client of the api, I wouldn't expect that the configuration I am passing will be mutated. ", "bodyText": "I'm wondering, do we still need all these overloads like createSharedQueue and createTemporaryQueue. Shouldn't the intent be expressed by the state of QueueConfiguration object itself? As the client of the api, I wouldn't expect that the configuration I am passing will be mutated.", "bodyHTML": "<p dir=\"auto\">I'm wondering, do we still need all these overloads like <code>createSharedQueue</code> and <code>createTemporaryQueue</code>. Shouldn't the intent be expressed by the state of <code>QueueConfiguration</code> object itself? As the client of the api, I wouldn't expect that the configuration I am passing will be mutated.</p>", "author": "Havret", "createdAt": "2020-04-05T17:12:14Z", "path": "artemis-core-client/src/main/java/org/apache/activemq/artemis/core/client/impl/ClientSessionImpl.java", "diffHunk": "@@ -298,6 +299,28 @@ public void createAddress(final SimpleString address, RoutingType routingType, b\n       createAddress(address, EnumSet.of(routingType), autoCreated);\n    }\n \n+   @Override\n+   public void createQueue(QueueConfiguration queueConfiguration) throws ActiveMQException {\n+      internalCreateQueue(queueConfiguration);\n+   }\n+\n+   @Override\n+   public void createSharedQueue(QueueConfiguration queueConfiguration) throws ActiveMQException {\n+      checkClosed();\n+\n+      startCall();\n+      try {\n+         sessionContext.createSharedQueue(queueConfiguration);\n+      } finally {\n+         endCall();\n+      }\n+   }\n+\n+   @Override\n+   public void createTemporaryQueue(QueueConfiguration queueConfiguration) throws ActiveMQException {", "originalCommit": "40bab72d61b1c5972da0c356edb2f21de1b87ad6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczMzgxOQ==", "url": "https://github.com/apache/activemq-artemis/pull/3063#discussion_r403733819", "bodyText": "I would agree, essentially a shared queue or temporary queue is just all attributes of a queue. As such having a more simplified single createQueue method will be cleaner.", "author": "michaelandrepearce", "createdAt": "2020-04-05T17:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczMDM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzgwMzE4OQ==", "url": "https://github.com/apache/activemq-artemis/pull/3063#discussion_r403803189", "bodyText": "I'm in favor of that. I'll take those out to simplify it even further.", "author": "jbertram", "createdAt": "2020-04-06T02:44:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzczMDM5MA=="}], "type": "inlineReview", "revised_code": {"commit": "50b45d275d4c0a04c937f0f41279dfbb2b3f4a06", "changed_code": [{"header": "diff --git a/artemis-core-client/src/main/java/org/apache/activemq/artemis/core/client/impl/ClientSessionImpl.java b/artemis-core-client/src/main/java/org/apache/activemq/artemis/core/client/impl/ClientSessionImpl.java\nindex 5e5ced8c01..b87207ef01 100644\n--- a/artemis-core-client/src/main/java/org/apache/activemq/artemis/core/client/impl/ClientSessionImpl.java\n+++ b/artemis-core-client/src/main/java/org/apache/activemq/artemis/core/client/impl/ClientSessionImpl.java\n", "chunk": "@@ -316,11 +316,6 @@ public final class ClientSessionImpl implements ClientSessionInternal, FailureLi\n       }\n    }\n \n-   @Override\n-   public void createTemporaryQueue(QueueConfiguration queueConfiguration) throws ActiveMQException {\n-      internalCreateQueue(queueConfiguration.setDurable(false).setTemporary(true).setAutoCreated(false));\n-   }\n-\n    @Override\n    public void createQueue(final SimpleString address,\n                            final SimpleString queueName,\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNTY5Ng==", "url": "https://github.com/apache/activemq-artemis/pull/3063#discussion_r403915696", "body": "I would encapsulate this logic in a separate method on a separate class to make it more readeable an d shorter ie translation from `request` to `QueueConfiguration`", "bodyText": "I would encapsulate this logic in a separate method on a separate class to make it more readeable an d shorter ie translation from request to QueueConfiguration", "bodyHTML": "<p dir=\"auto\">I would encapsulate this logic in a separate method on a separate class to make it more readeable an d shorter ie translation from <code>request</code> to <code>QueueConfiguration</code></p>", "author": "franz1981", "createdAt": "2020-04-06T08:31:13Z", "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java", "diffHunk": "@@ -357,9 +363,29 @@ private void slowPacketHandler(final Packet packet) {\n                case CREATE_QUEUE_V2: {\n                   CreateQueueMessage_V2 request = (CreateQueueMessage_V2) packet;\n                   requiresResponse = request.isRequiresResponse();\n-                  session.createQueue(request.getAddress(), request.getQueueName(), request.getRoutingType(), request.getFilterString(), request.isTemporary(), request.isDurable(), request.getMaxConsumers(), request.isPurgeOnNoConsumers(),\n-                                      request.isExclusive(), request.isGroupRebalance(), request.getGroupBuckets(), request.getGroupFirstKey(), request.isLastValue(), request.getLastValueKey(), request.isNonDestructive(), request.getConsumersBeforeDispatch(), request.getDelayBeforeDispatch(),\n-                                      request.isAutoDelete(), request.getAutoDeleteDelay(), request.getAutoDeleteMessageCount(), request.isAutoCreated(), request.getRingSize());\n+                  session.createQueue(new QueueConfiguration(request.getQueueName())", "originalCommit": "40bab72d61b1c5972da0c356edb2f21de1b87ad6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0NzI3NA==", "url": "https://github.com/apache/activemq-artemis/pull/3063#discussion_r404347274", "bodyText": "Will do.", "author": "jbertram", "createdAt": "2020-04-06T19:51:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNTY5Ng=="}], "type": "inlineReview", "revised_code": {"commit": "50b45d275d4c0a04c937f0f41279dfbb2b3f4a06", "changed_code": [{"header": "diff --git a/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java b/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\nindex 5e84f960f9..4c583aabdd 100644\n--- a/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\n+++ b/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\n", "chunk": "@@ -363,28 +363,7 @@ public class ServerSessionPacketHandler implements ChannelHandler {\n                case CREATE_QUEUE_V2: {\n                   CreateQueueMessage_V2 request = (CreateQueueMessage_V2) packet;\n                   requiresResponse = request.isRequiresResponse();\n-                  session.createQueue(new QueueConfiguration(request.getQueueName())\n-                                         .setAddress(request.getAddress())\n-                                         .setRoutingType(request.getRoutingType())\n-                                         .setFilterString(request.getFilterString())\n-                                         .setTemporary(request.isTemporary())\n-                                         .setDurable(request.isDurable())\n-                                         .setMaxConsumers(request.getMaxConsumers())\n-                                         .setPurgeOnNoConsumers(request.isPurgeOnNoConsumers())\n-                                         .setExclusive(request.isExclusive())\n-                                         .setGroupRebalance(request.isGroupRebalance())\n-                                         .setGroupBuckets(request.getGroupBuckets())\n-                                         .setGroupFirstKey(request.getGroupFirstKey())\n-                                         .setLastValue(request.isLastValue())\n-                                         .setLastValueKey(request.getLastValueKey())\n-                                         .setNonDestructive(request.isNonDestructive())\n-                                         .setConsumersBeforeDispatch(request.getConsumersBeforeDispatch())\n-                                         .setDelayBeforeDispatch(request.getDelayBeforeDispatch())\n-                                         .setAutoDelete(request.isAutoDelete())\n-                                         .setAutoDeleteDelay(request.getAutoDeleteDelay())\n-                                         .setAutoDeleteMessageCount(request.getAutoDeleteMessageCount())\n-                                         .setAutoCreated(request.isAutoCreated())\n-                                         .setRingSize(request.getRingSize()));\n+                  session.createQueue(request.toQueueConfiguration());\n \n                   if (requiresResponse) {\n                      response = createNullResponseMessage(packet);\n", "next_change": null}]}, "revised_code_in_main": {"commit": "42f75537e47a4b7b1ceb3d3528a1df3833397f9f", "changed_code": [{"header": "diff --git a/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java b/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\nindex 5e84f960f9..4c583aabdd 100644\n--- a/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\n+++ b/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\n", "chunk": "@@ -363,28 +363,7 @@ public class ServerSessionPacketHandler implements ChannelHandler {\n                case CREATE_QUEUE_V2: {\n                   CreateQueueMessage_V2 request = (CreateQueueMessage_V2) packet;\n                   requiresResponse = request.isRequiresResponse();\n-                  session.createQueue(new QueueConfiguration(request.getQueueName())\n-                                         .setAddress(request.getAddress())\n-                                         .setRoutingType(request.getRoutingType())\n-                                         .setFilterString(request.getFilterString())\n-                                         .setTemporary(request.isTemporary())\n-                                         .setDurable(request.isDurable())\n-                                         .setMaxConsumers(request.getMaxConsumers())\n-                                         .setPurgeOnNoConsumers(request.isPurgeOnNoConsumers())\n-                                         .setExclusive(request.isExclusive())\n-                                         .setGroupRebalance(request.isGroupRebalance())\n-                                         .setGroupBuckets(request.getGroupBuckets())\n-                                         .setGroupFirstKey(request.getGroupFirstKey())\n-                                         .setLastValue(request.isLastValue())\n-                                         .setLastValueKey(request.getLastValueKey())\n-                                         .setNonDestructive(request.isNonDestructive())\n-                                         .setConsumersBeforeDispatch(request.getConsumersBeforeDispatch())\n-                                         .setDelayBeforeDispatch(request.getDelayBeforeDispatch())\n-                                         .setAutoDelete(request.isAutoDelete())\n-                                         .setAutoDeleteDelay(request.getAutoDeleteDelay())\n-                                         .setAutoDeleteMessageCount(request.getAutoDeleteMessageCount())\n-                                         .setAutoCreated(request.isAutoCreated())\n-                                         .setRingSize(request.getRingSize()));\n+                  session.createQueue(request.toQueueConfiguration());\n \n                   if (requiresResponse) {\n                      response = createNullResponseMessage(packet);\n", "next_change": null}]}, "commits_in_main": [{"oid": "42f75537e47a4b7b1ceb3d3528a1df3833397f9f", "message": "Merge commit", "committedDate": null}, {"oid": "8a04ee07de8a7c863daf37a07a1176131151caa0", "committedDate": "2020-05-04 15:19:08 +0100", "message": "ARTEMIS-2648 - audit logging improvements"}, {"oid": "9c5ec1b07ccf908adab1bec3c5ef7d3f778f94a4", "committedDate": "2021-02-07 10:41:41 +0800", "message": "ARTEMIS-3105 large message file not closed on backup side"}, {"oid": "bc83b3123277ce3bc2d2a030ae55770497ec3b51", "committedDate": "2021-03-03 13:51:05 -0500", "message": "ARTEMIS-3133 Reduce memory usage for Null an Ping packets"}, {"oid": "05c55d382c3310cb8f98593889074e6f194c3d44", "committedDate": "2021-03-04 10:38:14 -0500", "message": "ARTEMIS-3133 Just Encapsulating ObjectPool into a small utility"}, {"oid": "3b9008bda008ee8e7413c05c5c6238503d9a3bcc", "committedDate": "2021-03-17 13:36:09 -0500", "message": "ARTEMIS-3174: Set new connection on ServerSession during reattachment"}, {"oid": "1d1a9433bc3bde0d65159117312dae3ce053d25c", "committedDate": "2021-03-18 18:26:07 -0400", "message": "ARTEMIS-2870: Transfer connection close/failure listeners one by one on reattachment"}, {"oid": "d0c550bcd781273df023c19490f31e21f12c2718", "committedDate": "2022-03-21 10:36:28 -0400", "message": "ARTEMIS-3729 Fix JMS CORE client commit after async sends"}, {"oid": "729fdc4aabe557b42dbac4233e7d2f739f3e0e75", "committedDate": "2022-08-25 18:12:11 -0400", "message": "ARTEMIS-3955 consolidate Subject on RemotingConnection"}, {"oid": "9873fccf744c0cb0a25dd905fab67ea52ef7aa7d", "committedDate": "2022-09-28 14:01:54 -0400", "message": "ARTEMIS-4020: switch to using SLF4J API for logging, use Log4J 2 as impl for broker distribution and tests"}, {"oid": "12cc70c5bf1020087a0bedc6a9f86cc2d78bf7d6", "committedDate": "2022-09-29 17:46:51 -0400", "message": "ARTEMIS-4020 Using a little trick to create the Loggers"}, {"oid": "617269319a7e6cbe98ae981743d2af24632e730c", "committedDate": "2022-10-07 15:40:53 -0400", "message": "ARTEMIS-4020: Remove string appends and various isXEnabled logger checks (add some where useful)"}, {"oid": "b02002fc6645c5fcde9019a053f4575ab273df4d", "committedDate": "2023-01-13 15:49:44 -0500", "message": "ARTEMIS-3875 - adding consumer and producer metrics"}, {"oid": "82fc42987a2af70600f832037adebde0826c8783", "committedDate": "2023-02-16 13:34:29 -0800", "message": "ARTEMIS-4171 potential large message file leak"}, {"oid": "fb169bc4af15dcad6deb7c050c8177576562e8d6", "committedDate": "2023-02-16 13:34:29 -0800", "message": "ARTEMIS-4172 sending large msg via core skips plugins & audit log"}, {"oid": "3a5601572e63dfa9299625f72e1a9a1fe12d1a7d", "committedDate": "2023-03-15 12:46:50 -0700", "message": "ARTEMIS-4207 Redistribution could leave messages stranded in the folder"}, {"oid": "8b2be8ef3bdb417deb0edb274aa1dcba1aa4e1c6", "committedDate": "2023-03-15 16:24:25 -0400", "message": "ARTEMIS-4207 Removing logger.info added by accident (temporary debug)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNTkzNg==", "url": "https://github.com/apache/activemq-artemis/pull/3063#discussion_r403915936", "body": "I would encapsulate this logic in a separate method on a separate class to make it more readeable an d shorter ie translation from request to QueueConfiguration", "bodyText": "I would encapsulate this logic in a separate method on a separate class to make it more readeable an d shorter ie translation from request to QueueConfiguration", "bodyHTML": "<p dir=\"auto\">I would encapsulate this logic in a separate method on a separate class to make it more readeable an d shorter ie translation from request to QueueConfiguration</p>", "author": "franz1981", "createdAt": "2020-04-06T08:31:38Z", "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java", "diffHunk": "@@ -382,9 +411,25 @@ private void slowPacketHandler(final Packet packet) {\n                   requiresResponse = request.isRequiresResponse();\n                   QueueQueryResult result = session.executeQueueQuery(request.getQueueName());\n                   if (!(result.isExists() && Objects.equals(result.getAddress(), request.getAddress()) && Objects.equals(result.getFilterString(), request.getFilterString()))) {\n-                     session.createSharedQueue(request.getAddress(), request.getQueueName(), request.getRoutingType(), request.getFilterString(), request.isDurable(), request.getMaxConsumers(), request.isPurgeOnNoConsumers(),\n-                                               request.isExclusive(), request.isGroupRebalance(), request.getGroupBuckets(), request.getGroupFirstKey(), request.isLastValue(), request.getLastValueKey(), request.isNonDestructive(), request.getConsumersBeforeDispatch(), request.getDelayBeforeDispatch(),\n-                                               request.isAutoDelete(), request.getAutoDeleteDelay(), request.getAutoDeleteMessageCount());\n+                     session.createSharedQueue(new QueueConfiguration(request.getQueueName())", "originalCommit": "40bab72d61b1c5972da0c356edb2f21de1b87ad6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0NzMzMA==", "url": "https://github.com/apache/activemq-artemis/pull/3063#discussion_r404347330", "bodyText": "Will do.", "author": "jbertram", "createdAt": "2020-04-06T19:51:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNTkzNg=="}], "type": "inlineReview", "revised_code": {"commit": "50b45d275d4c0a04c937f0f41279dfbb2b3f4a06", "changed_code": [{"header": "diff --git a/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java b/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\nindex 5e84f960f9..4c583aabdd 100644\n--- a/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\n+++ b/artemis-server/src/main/java/org/apache/activemq/artemis/core/protocol/core/ServerSessionPacketHandler.java\n", "chunk": "@@ -411,25 +390,7 @@ public class ServerSessionPacketHandler implements ChannelHandler {\n                   requiresResponse = request.isRequiresResponse();\n                   QueueQueryResult result = session.executeQueueQuery(request.getQueueName());\n                   if (!(result.isExists() && Objects.equals(result.getAddress(), request.getAddress()) && Objects.equals(result.getFilterString(), request.getFilterString()))) {\n-                     session.createSharedQueue(new QueueConfiguration(request.getQueueName())\n-                                                  .setAddress(request.getAddress())\n-                                                  .setRoutingType(request.getRoutingType())\n-                                                  .setFilterString(request.getFilterString())\n-                                                  .setDurable(request.isDurable())\n-                                                  .setMaxConsumers(request.getMaxConsumers())\n-                                                  .setPurgeOnNoConsumers(request.isPurgeOnNoConsumers())\n-                                                  .setExclusive(request.isExclusive())\n-                                                  .setGroupRebalance(request.isGroupRebalance())\n-                                                  .setGroupBuckets(request.getGroupBuckets())\n-                                                  .setGroupFirstKey(request.getGroupFirstKey())\n-                                                  .setLastValue(request.isLastValue())\n-                                                  .setLastValueKey(request.getLastValueKey())\n-                                                  .setNonDestructive(request.isNonDestructive())\n-                                                  .setConsumersBeforeDispatch(request.getConsumersBeforeDispatch())\n-                                                  .setDelayBeforeDispatch(request.getDelayBeforeDispatch())\n-                                                  .setAutoDelete(request.isAutoDelete())\n-                                                  .setAutoDeleteDelay(request.getAutoDeleteDelay())\n-                                                  .setAutoDeleteMessageCount(request.getAutoDeleteMessageCount()));\n+                     session.createSharedQueue(request.toQueueConfiguration());\n                   }\n                   if (requiresResponse) {\n                      response = createNullResponseMessage(packet);\n", "next_change": null}]}}, {"oid": "50b45d275d4c0a04c937f0f41279dfbb2b3f4a06", "url": "https://github.com/apache/activemq-artemis/commit/50b45d275d4c0a04c937f0f41279dfbb2b3f4a06", "message": "ARTEMIS-2692 refactor queue creation\n\nThis commit changes all tests to use the new methods.", "committedDate": "2020-04-12T02:47:20Z", "type": "forcePushed"}, {"oid": "2efa44daf52994790737e21ee29ae830f8f0a12c", "url": "https://github.com/apache/activemq-artemis/commit/2efa44daf52994790737e21ee29ae830f8f0a12c", "message": "ARTEMIS-2692 refactor queue creation\n\nThis commit does the following:\n- Deprecates existing overloaded createQueue, createSharedQueue,\n  createTemporaryQueue, & updateQueue methods for ClientSession,\n  ServerSession, ActiveMQServer, & ActiveMQServerControl where\n  applicable.\n- Deprecates QueueAttributes, QueueConfig, & CoreQueueConfiguration.\n- Deprecates existing overloaded constructors for QueueImpl.\n- Implements QueueConfiguration with JavaDoc to be the single,\n  centralized configuration object for both client-side and broker-side\n  queue creation including methods to convert to & from JSON for use in\n  the management API.\n- Implements new createQueue, createSharedQueue & updateQueue methods\n  with JavaDoc for ClientSession, ServerSession, ActiveMQServer, &\n  ActiveMQServerControl as well as a new constructor for QueueImpl all\n  using the new QueueConfiguration object.\n- Changes all internal broker code to use the new methods.", "committedDate": "2020-04-13T19:25:30Z", "type": "commit"}, {"oid": "701b4e47944fad231b7ee94f89f93b4b11329b90", "url": "https://github.com/apache/activemq-artemis/commit/701b4e47944fad231b7ee94f89f93b4b11329b90", "message": "ARTEMIS-2692 refactor queue creation\n\nThis commit changes all tests to use the new methods.", "committedDate": "2020-04-13T19:25:30Z", "type": "commit"}, {"oid": "701b4e47944fad231b7ee94f89f93b4b11329b90", "url": "https://github.com/apache/activemq-artemis/commit/701b4e47944fad231b7ee94f89f93b4b11329b90", "message": "ARTEMIS-2692 refactor queue creation\n\nThis commit changes all tests to use the new methods.", "committedDate": "2020-04-13T19:25:30Z", "type": "forcePushed"}]}