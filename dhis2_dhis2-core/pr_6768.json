{"pr_number": 6768, "pr_title": "fix: DHIS2-10001 logic added to tracker importer to validate TEIs mandatory attributes", "pr_author": "gnespolino", "pr_createdAt": "2020-11-26T17:17:55Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6768", "timeline": [{"oid": "1b412fdd1af0016d9c06a3d320dc2ceb7c9a9392", "url": "https://github.com/dhis2/dhis2-core/commit/1b412fdd1af0016d9c06a3d320dc2ceb7c9a9392", "message": "fix: DHIS2-10001 logic added to tracker importer to validate TEIs mandatory attributes", "committedDate": "2020-11-26T17:17:16Z", "type": "commit"}, {"oid": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "url": "https://github.com/dhis2/dhis2-core/commit/fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "message": "fix: DHIS2-10001 mandatory attributes in existing tests is set to false to fix tests", "committedDate": "2020-11-27T12:45:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyODYxOA==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533428618", "body": "This TEI passed to validation cannot be null, so we could simply get the attributes without the optional", "bodyText": "This TEI passed to validation cannot be null, so we could simply get the attributes without the optional", "bodyHTML": "<p dir=\"auto\">This TEI passed to validation cannot be null, so we could simply get the attributes without the optional</p>", "author": "enricocolasante", "createdAt": "2020-12-01T14:01:39Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )", "originalCommit": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5NzAyMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r534097021", "bodyText": "you're right, thank you", "author": "gnespolino", "createdAt": "2020-12-02T11:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyODYxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzNTQ0Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r533435447", "body": "I found difficult following this Optional.of and then orElse flow and I am not sure if in this case you could really have a null TrackedEntityTypeAttribute in the list of trackedEntityType.getTrackedEntityTypeAttributes()\r\nI would go with \r\n\r\n```suggestion\r\n               .filter(Obects::isNotNull)\r\n               .filter(TrackedEntityTypeAttribute::isMandatory)\r\n```\r\n\r\nbut of course this is purely personal style", "bodyText": "I found difficult following this Optional.of and then orElse flow and I am not sure if in this case you could really have a null TrackedEntityTypeAttribute in the list of trackedEntityType.getTrackedEntityTypeAttributes()\nI would go with\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .filter( this::isMandatory )\n          \n          \n            \n                           .filter(Obects::isNotNull)\n          \n          \n            \n                           .filter(TrackedEntityTypeAttribute::isMandatory)\n          \n      \n    \n    \n  \n\nbut of course this is purely personal style", "bodyHTML": "<p dir=\"auto\">I found difficult following this Optional.of and then orElse flow and I am not sure if in this case you could really have a null TrackedEntityTypeAttribute in the list of trackedEntityType.getTrackedEntityTypeAttributes()<br>\nI would go with</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">               <span class=\"x x-first x-last\"> </span>.filter(<span class=\"x x-first\"> </span><span class=\"pl-c1 x\">this</span><span class=\"pl-k x\">::</span><span class=\"x x-last\">isMandatory </span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">               .filter(<span class=\"pl-smi x x-first\">Obects</span><span class=\"pl-k x\">::</span><span class=\"x x-last\">isNotNull</span>)</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">               .filter(<span class=\"pl-smi\">TrackedEntityTypeAttribute</span><span class=\"pl-k\">::</span>isMandatory)</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">but of course this is purely personal style</p>", "author": "enricocolasante", "createdAt": "2020-12-01T14:11:10Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/validation/hooks/TrackedEntityAttributeValidationHook.java", "diffHunk": "@@ -97,6 +104,47 @@ public void validateTrackedEntity( ValidationErrorReporter reporter, TrackedEnti\n         OrganisationUnit organisationUnit = context.getOrganisationUnit( trackedEntity.getOrgUnit() );\n \n         validateAttributes( reporter, trackedEntity, tei, organisationUnit );\n+        validateMandatoryAttributes( reporter, trackedEntity );\n+    }\n+\n+    private void validateMandatoryAttributes( ValidationErrorReporter reporter, TrackedEntity trackedEntity )\n+    {\n+        TrackedEntityType trackedEntityType = reporter.getValidationContext()\n+            .getTrackedEntityType( trackedEntity.getTrackedEntityType() );\n+\n+        if ( trackedEntityType != null )\n+        {\n+            Set<String> trackedEntityAttributes = Optional.of( trackedEntity )\n+                .map( TrackedEntity::getAttributes )\n+                .orElse( Collections.emptyList() )\n+                .stream()\n+                .map( Attribute::getAttribute )\n+                .collect( Collectors.toSet() );\n+\n+            trackedEntityType.getTrackedEntityTypeAttributes()\n+                .stream()\n+                .filter( this::isMandatory )", "originalCommit": "fe8c907baeb7e9cf517e7452431782eb6f7b38e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA5NzI1Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/6768#discussion_r534097257", "bodyText": "yes, your version is much easier, I'll change it", "author": "gnespolino", "createdAt": "2020-12-02T11:31:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzNTQ0Nw=="}], "type": "inlineReview"}, {"oid": "2c30dad98da1bb63160b2cfb98d195bf6633371d", "url": "https://github.com/dhis2/dhis2-core/commit/2c30dad98da1bb63160b2cfb98d195bf6633371d", "message": "feat: DHIS2-10001 mandatory attribute check implementation", "committedDate": "2020-12-02T15:14:04Z", "type": "commit"}]}