{"pr_number": 4908, "pr_title": "fix: (2.31) Malformed Image on download from data entry", "pr_author": "vietnguyen", "pr_createdAt": "2020-02-20T13:10:00Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/4908", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUwMjk3Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/4908#discussion_r382502972", "body": "@vietnguyen there is a method `setContentLengthLong`  on ServletResponse / HttpServletResponse which you can use here instead.\r\n\r\nhttps://docs.oracle.com/javaee/7/api/javax/servlet/ServletResponse.html#setContentLengthLong-long-\r\n", "bodyText": "@vietnguyen there is a method setContentLengthLong  on ServletResponse / HttpServletResponse which you can use here instead.\nhttps://docs.oracle.com/javaee/7/api/javax/servlet/ServletResponse.html#setContentLengthLong-long-", "bodyHTML": "<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/vietnguyen/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/vietnguyen\">@vietnguyen</a> there is a method <code>setContentLengthLong</code>  on ServletResponse / HttpServletResponse which you can use here instead.</p>\n<p dir=\"auto\"><a href=\"https://docs.oracle.com/javaee/7/api/javax/servlet/ServletResponse.html#setContentLengthLong-long-\" rel=\"nofollow\">https://docs.oracle.com/javaee/7/api/javax/servlet/ServletResponse.html#setContentLengthLong-long-</a></p>", "author": "larshelge", "createdAt": "2020-02-21T10:19:46Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/DataValueController.java", "diffHunk": "@@ -569,9 +569,16 @@ public void getDataValueFile(\n         setNoStore( response );\n         try\n         {\n-            InputStream file = fileResourceService.getFileResourceContent( fileResource );\n-            response.setContentLength( file.available() );\n-            IOUtils.copy( file, response.getOutputStream() );\n+            long contentLength = fileResourceService.copyFileResourceContent( fileResource, response.getOutputStream() );\n+\n+            if ( contentLength <= Integer.MAX_VALUE )", "originalCommit": "cf9c82d5b57336aa63d96fb6ca4da1974f98566e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjk2ODA4MA==", "url": "https://github.com/dhis2/dhis2-core/pull/4908#discussion_r382968080", "bodyText": "fixed", "author": "vietnguyen", "createdAt": "2020-02-23T06:17:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjUwMjk3Mg=="}], "type": "inlineReview"}, {"oid": "dfd3cb35c19195eb83701ddc099f37d3ec6ac1c2", "url": "https://github.com/dhis2/dhis2-core/commit/dfd3cb35c19195eb83701ddc099f37d3ec6ac1c2", "message": "fix: Malformed Image on download from data entry", "committedDate": "2020-02-23T06:14:13Z", "type": "commit"}, {"oid": "dfd3cb35c19195eb83701ddc099f37d3ec6ac1c2", "url": "https://github.com/dhis2/dhis2-core/commit/dfd3cb35c19195eb83701ddc099f37d3ec6ac1c2", "message": "fix: Malformed Image on download from data entry", "committedDate": "2020-02-23T06:14:13Z", "type": "forcePushed"}]}