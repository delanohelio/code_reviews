{"pr_number": 6163, "pr_title": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it", "pr_author": "enricocolasante", "pr_createdAt": "2020-09-16T15:14:10Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6163", "timeline": [{"oid": "3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "url": "https://github.com/dhis2/dhis2-core/commit/3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "message": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it", "committedDate": "2020-09-16T15:15:09Z", "type": "commit"}, {"oid": "3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "url": "https://github.com/dhis2/dhis2-core/commit/3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "message": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it", "committedDate": "2020-09-16T15:15:09Z", "type": "forcePushed"}, {"oid": "6f752745e476d1421f775ef5044315ab564d954a", "url": "https://github.com/dhis2/dhis2-core/commit/6f752745e476d1421f775ef5044315ab564d954a", "message": "Fix sonar code smells", "committedDate": "2020-09-16T15:45:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjA0MA==", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492556040", "body": "Minor: Might be slightly more compact and avoid to stream twice, like this:\r\n \r\n```suggestion\r\n    @Override\r\n    public String allowDeleteProgramStage( ProgramStage programStage )\r\n    {\r\n        String programRuleVariables = programRuleService\r\n            .getProgramRule( programStage.getProgram() )\r\n            .stream()\r\n            .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\r\n            .map( BaseIdentifiableObject::getName )\r\n            .collect( Collectors.joining( \", \" ) );\r\n\r\n        return StringUtils.isBlank( programRuleVariables ) ? null : programRuleVariables;\r\n    }\r\n```", "bodyText": "Minor: Might be slightly more compact and avoid to stream twice, like this:\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Override\n          \n          \n            \n                public String allowDeleteProgramStage( ProgramStage programStage )\n          \n          \n            \n                {\n          \n          \n            \n                    List<ProgramRule> programRuleVariables = programRuleService\n          \n          \n            \n                        .getProgramRule( programStage.getProgram() )\n          \n          \n            \n                        .stream()\n          \n          \n            \n                        .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n          \n          \n            \n                        .collect( Collectors.toList() );\n          \n          \n            \n            \n          \n          \n            \n                    if ( programRuleVariables.isEmpty() )\n          \n          \n            \n                    {\n          \n          \n            \n                        return null;\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    return programRuleVariables.stream()\n          \n          \n            \n                        .map( BaseIdentifiableObject::getName )\n          \n          \n            \n                        .collect( Collectors.joining( \", \" ) );\n          \n          \n            \n                }\n          \n          \n            \n                @Override\n          \n          \n            \n                public String allowDeleteProgramStage( ProgramStage programStage )\n          \n          \n            \n                {\n          \n          \n            \n                    String programRuleVariables = programRuleService\n          \n          \n            \n                        .getProgramRule( programStage.getProgram() )\n          \n          \n            \n                        .stream()\n          \n          \n            \n                        .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n          \n          \n            \n                        .map( BaseIdentifiableObject::getName )\n          \n          \n            \n                        .collect( Collectors.joining( \", \" ) );\n          \n          \n            \n            \n          \n          \n            \n                    return StringUtils.isBlank( programRuleVariables ) ? null : programRuleVariables;\n          \n          \n            \n                }", "bodyHTML": "<p dir=\"auto\">Minor: Might be slightly more compact and avoid to stream twice, like this:</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"94\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">@Override</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"95\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">String</span> allowDeleteProgramStage( <span class=\"pl-smi\">ProgramStage</span> programStage )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"96\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"97\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">List&lt;<span class=\"pl-smi\">ProgramRule</span>&gt;</span> programRuleVariables <span class=\"pl-k\">=</span> programRuleService</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"98\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            .getProgramRule( programStage<span class=\"pl-k\">.</span>getProgram() )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"99\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            .stream()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"100\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            .filter( pr <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> isLinkedToProgramStage( programStage, pr ) )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"101\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            .collect( <span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>toList() );</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"102\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"103\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> ( programRuleVariables<span class=\"pl-k\">.</span>isEmpty() )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"104\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"105\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">return</span> <span class=\"pl-c1\">null</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"106\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"107\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"108\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">return</span> programRuleVariables<span class=\"pl-k\">.</span>stream()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"109\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            .map( <span class=\"pl-smi\">BaseIdentifiableObject</span><span class=\"pl-k\">::</span>getName )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"110\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            .collect( <span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>joining( <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span> ) );</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"111\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"94\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">@Override</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"95\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">public</span> <span class=\"pl-smi\">String</span> allowDeleteProgramStage( <span class=\"pl-smi\">ProgramStage</span> programStage )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"96\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"97\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">String</span> programRuleVariables <span class=\"pl-k\">=</span> programRuleService</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"98\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            .getProgramRule( programStage<span class=\"pl-k\">.</span>getProgram() )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"99\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            .stream()</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"100\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            .filter( pr <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> isLinkedToProgramStage( programStage, pr ) )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"101\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            .map( <span class=\"pl-smi\">BaseIdentifiableObject</span><span class=\"pl-k\">::</span>getName )</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"102\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            .collect( <span class=\"pl-smi\">Collectors</span><span class=\"pl-k\">.</span>joining( <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>, <span class=\"pl-pds\">\"</span></span> ) );</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"103\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"104\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">return</span> <span class=\"pl-smi\">StringUtils</span><span class=\"pl-k\">.</span>isBlank( programRuleVariables ) <span class=\"pl-k\">?</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">:</span> programRuleVariables;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"105\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "gnespolino", "createdAt": "2020-09-22T08:23:26Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleDeletionHandler.java", "diffHunk": "@@ -72,4 +78,31 @@ public void deleteProgram( Program program )\n             programRuleService.deleteProgramRule( programRule );\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteProgramStage( ProgramStage programStage )\n+    {\n+        List<ProgramRule> programRuleVariables = programRuleService\n+            .getProgramRule( programStage.getProgram() )\n+            .stream()\n+            .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n+            .collect( Collectors.toList() );\n+\n+        if ( programRuleVariables.isEmpty() )\n+        {\n+            return null;\n+        }\n+\n+        return programRuleVariables.stream()\n+            .map( BaseIdentifiableObject::getName )\n+            .collect( Collectors.joining( \", \" ) );\n+    }", "originalCommit": "6f752745e476d1421f775ef5044315ab564d954a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjU2NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492556565", "body": "Same comment as before.", "bodyText": "Same comment as before.", "bodyHTML": "<p dir=\"auto\">Same comment as before.</p>", "author": "gnespolino", "createdAt": "2020-09-22T08:24:18Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleVariableDeletionHandler.java", "diffHunk": "@@ -61,6 +67,25 @@ protected String getClassName()\n     {\n         return ProgramRuleVariable.class.getSimpleName();\n     }\n+\n+    @Override\n+    public String allowDeleteProgramStage( ProgramStage programStage )\n+    {\n+        List<ProgramRuleVariable> programRuleVariables = programRuleVariableService\n+            .getProgramRuleVariable( programStage.getProgram() )\n+            .stream()\n+            .filter( prv -> Objects.equals( prv.getProgramStage(), programStage ) )\n+            .collect( Collectors.toList() );\n+\n+        if ( programRuleVariables.isEmpty() )\n+        {\n+            return null;\n+        }\n+\n+        return programRuleVariables.stream()\n+            .map( BaseIdentifiableObject::getName )\n+            .collect( Collectors.joining( \", \" ) );\n+    }", "originalCommit": "6f752745e476d1421f775ef5044315ab564d954a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MDA0MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492570041", "bodyText": "Done", "author": "enricocolasante", "createdAt": "2020-09-22T08:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjU2NQ=="}], "type": "inlineReview"}, {"oid": "4bef0e4db734072ae447ebb1758a099f600f8c23", "url": "https://github.com/dhis2/dhis2-core/commit/4bef0e4db734072ae447ebb1758a099f600f8c23", "message": "Update dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleDeletionHandler.java\n\nCo-authored-by: Giuseppe Nespolino <gnespolino@users.noreply.github.com>", "committedDate": "2020-09-22T08:28:22Z", "type": "commit"}, {"oid": "06026774dfacdce202d249e63bb053ffc9937111", "url": "https://github.com/dhis2/dhis2-core/commit/06026774dfacdce202d249e63bb053ffc9937111", "message": "Code review fixes", "committedDate": "2020-09-22T08:44:24Z", "type": "commit"}]}