{"pr_number": 734, "pr_title": "Add Future Utils Library", "pr_author": "vmaheshw", "pr_createdAt": "2020-07-22T06:13:31Z", "pr_url": "https://github.com/linkedin/brooklin/pull/734", "timeline": [{"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "message": "Merge pull request #1 from linkedin/master\n\nPull latest", "committedDate": "2019-11-18T20:06:44Z", "type": "commit"}, {"oid": "221646fde4fbf6d4d5301a2b4dc6aa0dc7194906", "url": "https://github.com/linkedin/brooklin/commit/221646fde4fbf6d4d5301a2b4dc6aa0dc7194906", "message": "Merge branch 'master' of github.com:vmaheshw/Brooklin", "committedDate": "2020-07-21T18:00:40Z", "type": "commit"}, {"oid": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "url": "https://github.com/linkedin/brooklin/commit/5c47b4d03f1f1b4063531a0390d1a8be8d302274", "message": "Add FutureUtils library", "committedDate": "2020-07-22T06:10:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2MTg3Mw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458861873", "body": "Please add a private ctor ", "bodyText": "Please add a private ctor", "bodyHTML": "<p dir=\"auto\">Please add a private ctor</p>", "author": "ahmedahamid", "createdAt": "2020-07-22T15:03:57Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2Mzg3NQ==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458863875", "body": "Pool size is too generous, especially if we consider what these threads are used for; they're only meant for fairly rapid checks. The thread pool queues work if no thread is idle. I'd say give it a modest value (e.g. 4).", "bodyText": "Pool size is too generous, especially if we consider what these threads are used for; they're only meant for fairly rapid checks. The thread pool queues work if no thread is idle. I'd say give it a modest value (e.g. 4).", "bodyHTML": "<p dir=\"auto\">Pool size is too generous, especially if we consider what these threads are used for; they're only meant for fairly rapid checks. The thread pool queues work if no thread is idle. I'd say give it a modest value (e.g. 4).</p>", "author": "ahmedahamid", "createdAt": "2020-07-22T15:06:31Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMTQ4NQ==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458921485", "body": "I know our discussions have been mostly focused on the specific use-case that motivated the introduction of this API. However, we need to consider how such a fundamental utility will be used in general.\r\n\r\nFor instance:\r\n1. If I'm calling this API, wouldn't I naturally find it useful if it offered me a way to access the result of `futureToAwait` in case it completed successfully? This should be fairly straightforward for this API to accomplish because all it takes in this case is calling `futureToAwait.get()`, sparing the caller this effort.\r\n\r\n2. Wouldn't it be useful if the returned `CompletableFuture` communicated the success/failure/cancellation of `futureToAwait` instead? One of the annoying things about `Future` in Java is the lack of composability; there's no straightforward way to chain other futures to it. However, this isn't the case with `CompletableFuture`. So, as a caller, I would imagine composing the returned future to react to success and cancellation/failure of the future I passed. This would allow me to do:\r\n```java\r\n    CompletableFuture<?> result = awaitFutureOrCancel(future, timeout);\r\n    result\r\n        .exceptionally()   // future didn't complete successfully (threw or got cancelled)\r\n        .thenRun();        // future completed successfully\r\n```\r\n\r\nHere's a proposed impl that addresses these two issues:\r\n```java\r\n  public static <T> CompletableFuture<T> awaitFutureOrCancel(Future<T> future, Duration timeout) {\r\n    CompletableFuture<T> result = new CompletableFuture<>();\r\n\r\n    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {\r\n      if (future.isDone()) {\r\n        try {\r\n          T t = future.get();\r\n          result.complete(t);\r\n        } catch (InterruptedException e) {\r\n          result.completeExceptionally(e);\r\n        } catch (ExecutionException e) {\r\n          result.completeExceptionally(e.getCause());\r\n        } catch (CancellationException e) {\r\n          result.cancel(false);\r\n        }\r\n      } else {\r\n        future.cancel(true);\r\n        result.cancel(false);\r\n      }\r\n    }, timeout.toMillis(), TimeUnit.MILLISECONDS);\r\n    return result;\r\n  }\r\n```", "bodyText": "I know our discussions have been mostly focused on the specific use-case that motivated the introduction of this API. However, we need to consider how such a fundamental utility will be used in general.\nFor instance:\n\n\nIf I'm calling this API, wouldn't I naturally find it useful if it offered me a way to access the result of futureToAwait in case it completed successfully? This should be fairly straightforward for this API to accomplish because all it takes in this case is calling futureToAwait.get(), sparing the caller this effort.\n\n\nWouldn't it be useful if the returned CompletableFuture communicated the success/failure/cancellation of futureToAwait instead? One of the annoying things about Future in Java is the lack of composability; there's no straightforward way to chain other futures to it. However, this isn't the case with CompletableFuture. So, as a caller, I would imagine composing the returned future to react to success and cancellation/failure of the future I passed. This would allow me to do:\n\n\n    CompletableFuture<?> result = awaitFutureOrCancel(future, timeout);\n    result\n        .exceptionally()   // future didn't complete successfully (threw or got cancelled)\n        .thenRun();        // future completed successfully\nHere's a proposed impl that addresses these two issues:\n  public static <T> CompletableFuture<T> awaitFutureOrCancel(Future<T> future, Duration timeout) {\n    CompletableFuture<T> result = new CompletableFuture<>();\n\n    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {\n      if (future.isDone()) {\n        try {\n          T t = future.get();\n          result.complete(t);\n        } catch (InterruptedException e) {\n          result.completeExceptionally(e);\n        } catch (ExecutionException e) {\n          result.completeExceptionally(e.getCause());\n        } catch (CancellationException e) {\n          result.cancel(false);\n        }\n      } else {\n        future.cancel(true);\n        result.cancel(false);\n      }\n    }, timeout.toMillis(), TimeUnit.MILLISECONDS);\n    return result;\n  }", "bodyHTML": "<p dir=\"auto\">I know our discussions have been mostly focused on the specific use-case that motivated the introduction of this API. However, we need to consider how such a fundamental utility will be used in general.</p>\n<p dir=\"auto\">For instance:</p>\n<ol dir=\"auto\">\n<li>\n<p dir=\"auto\">If I'm calling this API, wouldn't I naturally find it useful if it offered me a way to access the result of <code>futureToAwait</code> in case it completed successfully? This should be fairly straightforward for this API to accomplish because all it takes in this case is calling <code>futureToAwait.get()</code>, sparing the caller this effort.</p>\n</li>\n<li>\n<p dir=\"auto\">Wouldn't it be useful if the returned <code>CompletableFuture</code> communicated the success/failure/cancellation of <code>futureToAwait</code> instead? One of the annoying things about <code>Future</code> in Java is the lack of composability; there's no straightforward way to chain other futures to it. However, this isn't the case with <code>CompletableFuture</code>. So, as a caller, I would imagine composing the returned future to react to success and cancellation/failure of the future I passed. This would allow me to do:</p>\n</li>\n</ol>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"    CompletableFuture&lt;?&gt; result = awaitFutureOrCancel(future, timeout);\n    result\n        .exceptionally()   // future didn't complete successfully (threw or got cancelled)\n        .thenRun();        // future completed successfully\"><pre>    <span class=\"pl-k\">CompletableFuture&lt;?&gt;</span> result <span class=\"pl-k\">=</span> awaitFutureOrCancel(future, timeout);\n    result\n        .exceptionally()   <span class=\"pl-c\"><span class=\"pl-c\">//</span> future didn't complete successfully (threw or got cancelled)</span>\n        .thenRun();        <span class=\"pl-c\"><span class=\"pl-c\">//</span> future completed successfully</span></pre></div>\n<p dir=\"auto\">Here's a proposed impl that addresses these two issues:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  public static &lt;T&gt; CompletableFuture&lt;T&gt; awaitFutureOrCancel(Future&lt;T&gt; future, Duration timeout) {\n    CompletableFuture&lt;T&gt; result = new CompletableFuture&lt;&gt;();\n\n    SCHEDULED_EXECUTOR_SERVICE.schedule(() -&gt; {\n      if (future.isDone()) {\n        try {\n          T t = future.get();\n          result.complete(t);\n        } catch (InterruptedException e) {\n          result.completeExceptionally(e);\n        } catch (ExecutionException e) {\n          result.completeExceptionally(e.getCause());\n        } catch (CancellationException e) {\n          result.cancel(false);\n        }\n      } else {\n        future.cancel(true);\n        result.cancel(false);\n      }\n    }, timeout.toMillis(), TimeUnit.MILLISECONDS);\n    return result;\n  }\"><pre>  <span class=\"pl-k\">public</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">&lt;</span><span class=\"pl-smi\">T</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">CompletableFuture&lt;<span class=\"pl-smi\">T</span>&gt;</span> awaitFutureOrCancel(<span class=\"pl-k\">Future&lt;<span class=\"pl-smi\">T</span>&gt;</span> future, <span class=\"pl-smi\">Duration</span> timeout) {\n    <span class=\"pl-k\">CompletableFuture&lt;<span class=\"pl-smi\">T</span>&gt;</span> result <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">CompletableFuture&lt;&gt;</span>();\n\n    <span class=\"pl-c1\">SCHEDULED_EXECUTOR_SERVICE</span><span class=\"pl-k\">.</span>schedule(() <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> {\n      <span class=\"pl-k\">if</span> (future<span class=\"pl-k\">.</span>isDone()) {\n        <span class=\"pl-k\">try</span> {\n          <span class=\"pl-smi\">T</span> t <span class=\"pl-k\">=</span> future<span class=\"pl-k\">.</span>get();\n          result<span class=\"pl-k\">.</span>complete(t);\n        } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">InterruptedException</span> e) {\n          result<span class=\"pl-k\">.</span>completeExceptionally(e);\n        } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">ExecutionException</span> e) {\n          result<span class=\"pl-k\">.</span>completeExceptionally(e<span class=\"pl-k\">.</span>getCause());\n        } <span class=\"pl-k\">catch</span> (<span class=\"pl-smi\">CancellationException</span> e) {\n          result<span class=\"pl-k\">.</span>cancel(<span class=\"pl-c1\">false</span>);\n        }\n      } <span class=\"pl-k\">else</span> {\n        future<span class=\"pl-k\">.</span>cancel(<span class=\"pl-c1\">true</span>);\n        result<span class=\"pl-k\">.</span>cancel(<span class=\"pl-c1\">false</span>);\n      }\n    }, timeout<span class=\"pl-k\">.</span>toMillis(), <span class=\"pl-smi\">TimeUnit</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>MILLISECONDS</span>);\n    <span class=\"pl-k\">return</span> result;\n  }</pre></div>", "author": "ahmedahamid", "createdAt": "2020-07-22T16:25:46Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMzA0Nw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458923047", "body": "I'd rather disallow null `futureToAwait`", "bodyText": "I'd rather disallow null futureToAwait", "bodyHTML": "<p dir=\"auto\">I'd rather disallow null <code>futureToAwait</code></p>", "author": "ahmedahamid", "createdAt": "2020-07-22T16:27:40Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {\n+    CompletableFuture<?> result = new CompletableFuture<>();\n+\n+    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {\n+      if ((futureToAwait == null) || futureToAwait.isDone()) {", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzMDMyMw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458930323", "body": "This comment is purely about naming.\r\n\r\n- I think it'd be better to rename `futureToAwait` to just `future`\r\n- If you decide to go with an implementation that propagates back the future's result, I'd consider giving the method a different name, one that reflects that it is meant to get the future's result (if possible) after a specific duration (e.g. `getIfDoneOrCancel`?)\r\n- `timeout` is a misleading name for that param cause it implies we may check/finish sooner. We need a name that conveys that this is how much we'll wait (should we call it `after`?)", "bodyText": "This comment is purely about naming.\n\nI think it'd be better to rename futureToAwait to just future\nIf you decide to go with an implementation that propagates back the future's result, I'd consider giving the method a different name, one that reflects that it is meant to get the future's result (if possible) after a specific duration (e.g. getIfDoneOrCancel?)\ntimeout is a misleading name for that param cause it implies we may check/finish sooner. We need a name that conveys that this is how much we'll wait (should we call it after?)", "bodyHTML": "<p dir=\"auto\">This comment is purely about naming.</p>\n<ul dir=\"auto\">\n<li>I think it'd be better to rename <code>futureToAwait</code> to just <code>future</code></li>\n<li>If you decide to go with an implementation that propagates back the future's result, I'd consider giving the method a different name, one that reflects that it is meant to get the future's result (if possible) after a specific duration (e.g. <code>getIfDoneOrCancel</code>?)</li>\n<li><code>timeout</code> is a misleading name for that param cause it implies we may check/finish sooner. We need a name that conveys that this is how much we'll wait (should we call it <code>after</code>?)</li>\n</ul>", "author": "ahmedahamid", "createdAt": "2020-07-22T16:36:47Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNTE1Ng==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458935156", "body": "The javadocs can be improved for greater accuracy so users don't have to grok the code themselves.\r\n\r\n- The description can be something like: \r\n```java\r\n/**\r\n * Check if {@code future} is done after {@code timeout} ... (and the rest of the story)\r\n```\r\n- `Future to complete/stop` - check/cancel?\r\n- `before aborting future` - before checking actually\r\n- We'd need to document when and how the returned future is completed successfully, completed w/ an exception, or cancelled.", "bodyText": "The javadocs can be improved for greater accuracy so users don't have to grok the code themselves.\n\nThe description can be something like:\n\n/**\n * Check if {@code future} is done after {@code timeout} ... (and the rest of the story)\n\nFuture to complete/stop - check/cancel?\nbefore aborting future - before checking actually\nWe'd need to document when and how the returned future is completed successfully, completed w/ an exception, or cancelled.", "bodyHTML": "<p dir=\"auto\">The javadocs can be improved for greater accuracy so users don't have to grok the code themselves.</p>\n<ul dir=\"auto\">\n<li>The description can be something like:</li>\n</ul>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"/**\n * Check if {@code future} is done after {@code timeout} ... (and the rest of the story)\"><pre><span class=\"pl-c\"><span class=\"pl-c\">/**</span></span>\n<span class=\"pl-c\"> * Check if {<span class=\"pl-k\">@code</span><span class=\"pl-c1\"> future</span>} is done after {<span class=\"pl-k\">@code</span><span class=\"pl-c1\"> timeout</span>} ... (and the rest of the story)</span></pre></div>\n<ul dir=\"auto\">\n<li><code>Future to complete/stop</code> - check/cancel?</li>\n<li><code>before aborting future</code> - before checking actually</li>\n<li>We'd need to document when and how the returned future is completed successfully, completed w/ an exception, or cancelled.</li>\n</ul>", "author": "ahmedahamid", "createdAt": "2020-07-22T16:44:36Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNTc2OA==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458935768", "body": "Change to `false`; `true` makes little sense for `CompletableFuture`", "bodyText": "Change to false; true makes little sense for CompletableFuture", "bodyHTML": "<p dir=\"auto\">Change to <code>false</code>; <code>true</code> makes little sense for <code>CompletableFuture</code></p>", "author": "ahmedahamid", "createdAt": "2020-07-22T16:45:27Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {\n+    CompletableFuture<?> result = new CompletableFuture<>();\n+\n+    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {\n+      if ((futureToAwait == null) || futureToAwait.isDone()) {\n+        result.complete(null);\n+      } else {\n+        boolean cancel = futureToAwait.cancel(true);\n+        if (!cancel) {\n+          result.cancel(true);", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjM4MQ==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458936381", "body": "nit: inline", "bodyText": "nit: inline", "bodyHTML": "<p dir=\"auto\">nit: inline</p>", "author": "ahmedahamid", "createdAt": "2020-07-22T16:46:29Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {\n+    CompletableFuture<?> result = new CompletableFuture<>();\n+\n+    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {\n+      if ((futureToAwait == null) || futureToAwait.isDone()) {\n+        result.complete(null);\n+      } else {\n+        boolean cancel = futureToAwait.cancel(true);", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjcxMw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458936713", "body": "nit: invert if/else for simplicity", "bodyText": "nit: invert if/else for simplicity", "bodyHTML": "<p dir=\"auto\">nit: invert if/else for simplicity</p>", "author": "ahmedahamid", "createdAt": "2020-07-22T16:47:01Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {\n+    CompletableFuture<?> result = new CompletableFuture<>();\n+\n+    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {\n+      if ((futureToAwait == null) || futureToAwait.isDone()) {\n+        result.complete(null);\n+      } else {\n+        boolean cancel = futureToAwait.cancel(true);\n+        if (!cancel) {", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk3NDI0Mg==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458974242", "body": "Does completing a `null` future immediately make sense semantically? ", "bodyText": "Does completing a null future immediately make sense semantically?", "bodyHTML": "<p dir=\"auto\">Does completing a <code>null</code> future immediately make sense semantically?</p>", "author": "jzakaryan", "createdAt": "2020-07-22T17:49:14Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {\n+    CompletableFuture<?> result = new CompletableFuture<>();\n+\n+    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {\n+      if ((futureToAwait == null) || futureToAwait.isDone()) {", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDgwNw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r458980807", "body": "One drawback of this is that the user of this API will have to wait for the duration of `timeout` even if the future completes quickly. I think the version I had in the other PR was taking care of that by creating a separate timeout future and composing it with the provided one. I don't know whether this optimization is important for your use case but we may want to have that if it's a general purpose util.", "bodyText": "One drawback of this is that the user of this API will have to wait for the duration of timeout even if the future completes quickly. I think the version I had in the other PR was taking care of that by creating a separate timeout future and composing it with the provided one. I don't know whether this optimization is important for your use case but we may want to have that if it's a general purpose util.", "bodyHTML": "<p dir=\"auto\">One drawback of this is that the user of this API will have to wait for the duration of <code>timeout</code> even if the future completes quickly. I think the version I had in the other PR was taking care of that by creating a separate timeout future and composing it with the provided one. I don't know whether this optimization is important for your use case but we may want to have that if it's a general purpose util.</p>", "author": "jzakaryan", "createdAt": "2020-07-22T17:59:52Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);\n+\n+  /**\n+   * This function waits till timeout for Future to complete, otherwise, it cancels it.\n+   * @param futureToAwait Future to complete/stop\n+   * @param timeout time to wait before aborting future\n+   * @return CompletableFuture for this operation\n+   */\n+  public static CompletableFuture<?> awaitFutureOrCancel(Future<?> futureToAwait, Duration timeout) {\n+    CompletableFuture<?> result = new CompletableFuture<>();\n+\n+    SCHEDULED_EXECUTOR_SERVICE.schedule(() -> {", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA1NTI5OA==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459055298", "bodyText": "True. The problem here's there's no easy way to compose that separate timeout future with the provided Future since it's not a CompletableFuture.", "author": "ahmedahamid", "createdAt": "2020-07-22T20:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk4MDgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA1NzE1NA==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459057154", "body": "It would be useful to give this executor a thread factory so we can give its threads meaningful names.", "bodyText": "It would be useful to give this executor a thread factory so we can give its threads meaningful names.", "bodyHTML": "<p dir=\"auto\">It would be useful to give this executor a thread factory so we can give its threads meaningful names.</p>", "author": "ahmedahamid", "createdAt": "2020-07-22T20:16:38Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(100);", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5fe498771871e09e32261cd02887179b5b14f42a", "url": "https://github.com/linkedin/brooklin/commit/5fe498771871e09e32261cd02887179b5b14f42a", "message": "Address review comments", "committedDate": "2020-07-23T23:03:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4ODkwMw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459788903", "body": "You don't have to declare `throws` for runtime exceptions", "bodyText": "You don't have to declare throws for runtime exceptions", "bodyHTML": "<p dir=\"auto\">You don't have to declare <code>throws</code> for runtime exceptions</p>", "author": "ahmedahamid", "createdAt": "2020-07-23T23:49:33Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.lang.NullArgumentException;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+\n+\n+/**\n+ * Utilities to work with {@link Future}\n+ */\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(4,\n+      new ThreadFactoryBuilder().setDaemon(true).setNameFormat(\"FutureUtils-%d\").build());\n+\n+  private FutureUtils() {\n+\n+  }\n+  /**\n+   * Check if {@code future} is done after {@code after}. Otherwise, cancels {@code future}.\n+   * It returns {@link CompletableFuture} which should be used directly for light-weight operations to avoid blocking the\n+   * executor thread, or call {@link CompletableFuture#supplyAsync(Supplier)} or {@link CompletableFuture#supplyAsync(Supplier, Executor)}\n+   * which uses another thread to execute and does not block the main executor thread.\n+   * @param future {@code future} to check/cancel\n+   * @param after time to wait before aborting {@code future}\n+   * @return {@link CompletableFuture} completed with computed result of {@code future}, if {@code future} was done before {@code after}.\n+   *         {@link CompletableFuture} completed exceptionally with {@link InterruptedException}, if {@code future} was interrupted.\n+   *         {@link CompletableFuture} completed exceptionally with cause of Exception, if {@code future} hit {@link ExecutionException}.\n+   *         {@link CompletableFuture} cancelled, if {@code future} thread was cancelled.\n+   * @throws NullArgumentException {@link NullArgumentException} is Thrown if future is Null\n+   */\n+  public static <T> CompletableFuture<T> getIfDoneOrCancel(Future<T> future, Duration after) throws\n+                                                                                             NullArgumentException {", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4OTI2OQ==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459789269", "body": "1. Instead of creating/throwing an exception yourself, you can use `Objects.requireNonNull()` or `org.apache.commons.lang3.Validate.notNull()`.\r\n2. You need to null-check `after` as well", "bodyText": "Instead of creating/throwing an exception yourself, you can use Objects.requireNonNull() or org.apache.commons.lang3.Validate.notNull().\nYou need to null-check after as well", "bodyHTML": "<ol dir=\"auto\">\n<li>Instead of creating/throwing an exception yourself, you can use <code>Objects.requireNonNull()</code> or <code>org.apache.commons.lang3.Validate.notNull()</code>.</li>\n<li>You need to null-check <code>after</code> as well</li>\n</ol>", "author": "ahmedahamid", "createdAt": "2020-07-23T23:50:44Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.lang.NullArgumentException;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+\n+\n+/**\n+ * Utilities to work with {@link Future}\n+ */\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(4,\n+      new ThreadFactoryBuilder().setDaemon(true).setNameFormat(\"FutureUtils-%d\").build());\n+\n+  private FutureUtils() {\n+\n+  }\n+  /**\n+   * Check if {@code future} is done after {@code after}. Otherwise, cancels {@code future}.\n+   * It returns {@link CompletableFuture} which should be used directly for light-weight operations to avoid blocking the\n+   * executor thread, or call {@link CompletableFuture#supplyAsync(Supplier)} or {@link CompletableFuture#supplyAsync(Supplier, Executor)}\n+   * which uses another thread to execute and does not block the main executor thread.\n+   * @param future {@code future} to check/cancel\n+   * @param after time to wait before aborting {@code future}\n+   * @return {@link CompletableFuture} completed with computed result of {@code future}, if {@code future} was done before {@code after}.\n+   *         {@link CompletableFuture} completed exceptionally with {@link InterruptedException}, if {@code future} was interrupted.\n+   *         {@link CompletableFuture} completed exceptionally with cause of Exception, if {@code future} hit {@link ExecutionException}.\n+   *         {@link CompletableFuture} cancelled, if {@code future} thread was cancelled.\n+   * @throws NullArgumentException {@link NullArgumentException} is Thrown if future is Null\n+   */\n+  public static <T> CompletableFuture<T> getIfDoneOrCancel(Future<T> future, Duration after) throws\n+                                                                                             NullArgumentException {\n+    if (future == null) {\n+      throw new NullArgumentException(\"future\");\n+    }", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5MDQzNg==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459790436", "body": "Not needed. We typically throw `NullPointerException` for null args.", "bodyText": "Not needed. We typically throw NullPointerException for null args.", "bodyHTML": "<p dir=\"auto\">Not needed. We typically throw <code>NullPointerException</code> for null args.</p>", "author": "ahmedahamid", "createdAt": "2020-07-23T23:55:00Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.lang.NullArgumentException;", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5MDc3MQ==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459790771", "body": "Best practice nit: this would entail adding a dependency on Guava under `project(':datastream-utils') {` in `build.gradle`.", "bodyText": "Best practice nit: this would entail adding a dependency on Guava under project(':datastream-utils') { in build.gradle.", "bodyHTML": "<p dir=\"auto\">Best practice nit: this would entail adding a dependency on Guava under <code>project(':datastream-utils') {</code> in <code>build.gradle</code>.</p>", "author": "ahmedahamid", "createdAt": "2020-07-23T23:56:13Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.lang.NullArgumentException;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NzQwMw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459797403", "body": "1. nit: rename `expectedException` to `expectException`, `isExceptionExpected`, `shouldThrow` ... etc.\r\n2. `timeout` can be of type `Duration`\r\n", "bodyText": "nit: rename expectedException to expectException, isExceptionExpected, shouldThrow ... etc.\ntimeout can be of type Duration", "bodyHTML": "<ol dir=\"auto\">\n<li>nit: rename <code>expectedException</code> to <code>expectException</code>, <code>isExceptionExpected</code>, <code>shouldThrow</code> ... etc.</li>\n<li><code>timeout</code> can be of type <code>Duration</code></li>\n</ol>", "author": "ahmedahamid", "createdAt": "2020-07-24T00:21:33Z", "path": "datastream-utils/src/test/java/com/linkedin/datastream/common/TestFutureUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/**\n+ *  Copyright 2020 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+/**\n+ * Tests for {@link FutureUtils}\n+ */\n+public class TestFutureUtils {\n+\n+  @Test\n+  public void withinFutureTimesOutAfterDuration() throws ExecutionException, InterruptedException {\n+    runAndVerifyTimeoutFuture(10000, 10, true);\n+    runAndVerifyTimeoutFuture(5, 10, false);\n+  }\n+\n+  private void runAndVerifyTimeoutFuture(long futureRunTime, long timeout, boolean expectedException)", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5NzcwOQ==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459797709", "body": "We need to assert the state and value of the returned future as well.", "bodyText": "We need to assert the state and value of the returned future as well.", "bodyHTML": "<p dir=\"auto\">We need to assert the state and value of the returned future as well.</p>", "author": "ahmedahamid", "createdAt": "2020-07-24T00:22:54Z", "path": "datastream-utils/src/test/java/com/linkedin/datastream/common/TestFutureUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/**\n+ *  Copyright 2020 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+/**\n+ * Tests for {@link FutureUtils}\n+ */\n+public class TestFutureUtils {\n+\n+  @Test\n+  public void withinFutureTimesOutAfterDuration() throws ExecutionException, InterruptedException {\n+    runAndVerifyTimeoutFuture(10000, 10, true);\n+    runAndVerifyTimeoutFuture(5, 10, false);\n+  }\n+\n+  private void runAndVerifyTimeoutFuture(long futureRunTime, long timeout, boolean expectedException)\n+      throws ExecutionException, InterruptedException {\n+    CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {\n+      try {\n+        Thread.sleep(futureRunTime);\n+        return 10;\n+      } catch (Exception ex) {\n+        throw new RuntimeException();\n+      }\n+    });\n+\n+    boolean exception = false;\n+    FutureUtils.getIfDoneOrCancel(future, Duration.ofMillis(timeout));", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5OTIzMw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459799233", "body": "nit: `exceptionThrown`?", "bodyText": "nit: exceptionThrown?", "bodyHTML": "<p dir=\"auto\">nit: <code>exceptionThrown</code>?</p>", "author": "ahmedahamid", "createdAt": "2020-07-24T00:29:32Z", "path": "datastream-utils/src/test/java/com/linkedin/datastream/common/TestFutureUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/**\n+ *  Copyright 2020 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+/**\n+ * Tests for {@link FutureUtils}\n+ */\n+public class TestFutureUtils {\n+\n+  @Test\n+  public void withinFutureTimesOutAfterDuration() throws ExecutionException, InterruptedException {\n+    runAndVerifyTimeoutFuture(10000, 10, true);\n+    runAndVerifyTimeoutFuture(5, 10, false);\n+  }\n+\n+  private void runAndVerifyTimeoutFuture(long futureRunTime, long timeout, boolean expectedException)\n+      throws ExecutionException, InterruptedException {\n+    CompletableFuture<Integer> future = CompletableFuture.supplyAsync(() -> {\n+      try {\n+        Thread.sleep(futureRunTime);\n+        return 10;\n+      } catch (Exception ex) {\n+        throw new RuntimeException();\n+      }\n+    });\n+\n+    boolean exception = false;", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc5OTk1Mw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459799953", "body": "`@Test`", "bodyText": "@Test", "bodyHTML": "<p dir=\"auto\"><code>@Test</code></p>", "author": "ahmedahamid", "createdAt": "2020-07-24T00:32:37Z", "path": "datastream-utils/src/test/java/com/linkedin/datastream/common/TestFutureUtils.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/**\n+ *  Copyright 2020 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.testng.Assert;\n+import org.testng.annotations.Test;\n+\n+\n+/**\n+ * Tests for {@link FutureUtils}\n+ */\n+public class TestFutureUtils {", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTgwNTk3OQ==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r459805979", "body": "- lightweight\r\n- \"if future was done ~~before~~ after the specified {@code after} elapsed\"\r\n- \"if +the thread retrieving the result of+ the future was interrupted \" \r\n- \"completed exceptionally with the exception thrown by future's computation if it threw one\" \r\n- \"if future's computation was cancelled before it completed normally\"", "bodyText": "lightweight\n\"if future was done before after the specified {@code after} elapsed\"\n\"if +the thread retrieving the result of+ the future was interrupted \"\n\"completed exceptionally with the exception thrown by future's computation if it threw one\"\n\"if future's computation was cancelled before it completed normally\"", "bodyHTML": "<ul dir=\"auto\">\n<li>lightweight</li>\n<li>\"if future was done <del>before</del> after the specified {<a class=\"user-mention\" data-hovercard-type=\"organization\" data-hovercard-url=\"/orgs/code/hovercard\" href=\"https://github.com/code\">@code</a> after} elapsed\"</li>\n<li>\"if +the thread retrieving the result of+ the future was interrupted \"</li>\n<li>\"completed exceptionally with the exception thrown by future's computation if it threw one\"</li>\n<li>\"if future's computation was cancelled before it completed normally\"</li>\n</ul>", "author": "ahmedahamid", "createdAt": "2020-07-24T00:59:13Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.lang.NullArgumentException;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+\n+\n+/**\n+ * Utilities to work with {@link Future}\n+ */\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(4,\n+      new ThreadFactoryBuilder().setDaemon(true).setNameFormat(\"FutureUtils-%d\").build());\n+\n+  private FutureUtils() {\n+\n+  }\n+  /**\n+   * Check if {@code future} is done after {@code after}. Otherwise, cancels {@code future}.\n+   * It returns {@link CompletableFuture} which should be used directly for light-weight operations to avoid blocking the\n+   * executor thread, or call {@link CompletableFuture#supplyAsync(Supplier)} or {@link CompletableFuture#supplyAsync(Supplier, Executor)}\n+   * which uses another thread to execute and does not block the main executor thread.\n+   * @param future {@code future} to check/cancel\n+   * @param after time to wait before aborting {@code future}\n+   * @return {@link CompletableFuture} completed with computed result of {@code future}, if {@code future} was done before {@code after}.\n+   *         {@link CompletableFuture} completed exceptionally with {@link InterruptedException}, if {@code future} was interrupted.\n+   *         {@link CompletableFuture} completed exceptionally with cause of Exception, if {@code future} hit {@link ExecutionException}.\n+   *         {@link CompletableFuture} cancelled, if {@code future} thread was cancelled.\n+   * @throws NullArgumentException {@link NullArgumentException} is Thrown if future is Null\n+   */", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE1MTc4Ng==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r460151786", "body": "Copyright need to be updated.", "bodyText": "Copyright need to be updated.", "bodyHTML": "<p dir=\"auto\">Copyright need to be updated.</p>", "author": "vishwajith-s", "createdAt": "2020-07-24T16:13:24Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.", "originalCommit": "5c47b4d03f1f1b4063531a0390d1a8be8d302274", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE1NTY3Mw==", "url": "https://github.com/linkedin/brooklin/pull/734#discussion_r460155673", "body": "Can we have this number 4 as a static int?", "bodyText": "Can we have this number 4 as a static int?", "bodyHTML": "<p dir=\"auto\">Can we have this number 4 as a static int?</p>", "author": "vishwajith-s", "createdAt": "2020-07-24T16:20:38Z", "path": "datastream-utils/src/main/java/com/linkedin/datastream/common/FutureUtils.java", "diffHunk": "@@ -0,0 +1,73 @@\n+/**\n+ *  Copyright 2019 LinkedIn Corporation. All rights reserved.\n+ *  Licensed under the BSD 2-Clause License. See the LICENSE file in the project root for license information.\n+ *  See the NOTICE file in the project root for additional information regarding copyright ownership.\n+ */\n+package com.linkedin.datastream.common;\n+\n+import java.time.Duration;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.apache.commons.lang.NullArgumentException;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+\n+\n+/**\n+ * Utilities to work with {@link Future}\n+ */\n+public class FutureUtils {\n+\n+  private static final ScheduledExecutorService SCHEDULED_EXECUTOR_SERVICE = Executors.newScheduledThreadPool(4,", "originalCommit": "5fe498771871e09e32261cd02887179b5b14f42a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3c00000184faef37c8d18791c2c74d12be52ee84", "url": "https://github.com/linkedin/brooklin/commit/3c00000184faef37c8d18791c2c74d12be52ee84", "message": "Address review comments", "committedDate": "2020-07-24T18:58:21Z", "type": "commit"}, {"oid": "021020fb453376d28f504b264b30f752ff1666db", "url": "https://github.com/linkedin/brooklin/commit/021020fb453376d28f504b264b30f752ff1666db", "message": "Address review comments", "committedDate": "2020-07-24T21:38:14Z", "type": "commit"}]}