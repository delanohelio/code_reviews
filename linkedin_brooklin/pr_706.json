{"pr_number": 706, "pr_title": "Reuse task from dead instances instead of creating new task in Broadcast strategy.", "pr_author": "vmaheshw", "pr_createdAt": "2020-04-29T21:34:29Z", "pr_url": "https://github.com/linkedin/brooklin/pull/706", "timeline": [{"oid": "c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "url": "https://github.com/linkedin/brooklin/commit/c31cd4a15cc8dd69b0a653dbe4201de934ea6d65", "message": "Merge pull request #1 from linkedin/master\n\nPull latest", "committedDate": "2019-11-18T20:06:44Z", "type": "commit"}, {"oid": "5900c04825b275064c70964236604a5e28f395bd", "url": "https://github.com/linkedin/brooklin/commit/5900c04825b275064c70964236604a5e28f395bd", "message": "Merge branch 'master' of github.com:linkedin/brooklin into HEAD", "committedDate": "2020-04-29T17:00:30Z", "type": "commit"}, {"oid": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "url": "https://github.com/linkedin/brooklin/commit/4f9089651ff0d2c8a567f383381c2f6b08b643b7", "message": "Reuse task from dead instances in BroadcastStrategy", "committedDate": "2020-04-29T21:25:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4MTg5MQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r420281891", "body": "\"removing the reused tasks\"? Did you mean removing the tasks assigned to current live instances? \r\n\r\n> to avoid assignment of same task from dead instance to two live instances in case of interrupt exception.\r\n\r\nSo that part of the comment is a bit confusing here. What got interrupted? This will only make sense to people who already know the details about the problem you are solving. Instead can you modify this to talk about interrupted cleanup of ZK nodes due to shutdown during leader assignment?", "bodyText": "\"removing the reused tasks\"? Did you mean removing the tasks assigned to current live instances?\n\nto avoid assignment of same task from dead instance to two live instances in case of interrupt exception.\n\nSo that part of the comment is a bit confusing here. What got interrupted? This will only make sense to people who already know the details about the problem you are solving. Instead can you modify this to talk about interrupted cleanup of ZK nodes due to shutdown during leader assignment?", "bodyHTML": "<p dir=\"auto\">\"removing the reused tasks\"? Did you mean removing the tasks assigned to current live instances?</p>\n<blockquote>\n<p dir=\"auto\">to avoid assignment of same task from dead instance to two live instances in case of interrupt exception.</p>\n</blockquote>\n<p dir=\"auto\">So that part of the comment is a bit confusing here. What got interrupted? This will only make sense to people who already know the details about the problem you are solving. Instead can you modify this to talk about interrupted cleanup of ZK nodes due to shutdown during leader assignment?</p>", "author": "somandal", "createdAt": "2020-05-05T17:27:09Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/BroadcastStrategy.java", "diffHunk": "@@ -59,17 +60,27 @@ public BroadcastStrategy(Optional<Integer> maxTasks) {\n \n     Map<String, Set<DatastreamTask>> newAssignment = new HashMap<>();\n \n+    Set<DatastreamTask> tasksAvailableToReuse = new HashSet<>();\n     // Make a copy of the current assignment, since the strategy modifies it during calculation\n     Map<String, Set<DatastreamTask>> currentAssignmentCopy = new HashMap<>(currentAssignment.size());\n-    currentAssignment.forEach((k, v) -> currentAssignmentCopy.put(k, new HashSet<>(v)));\n+    currentAssignment.forEach((k, v) -> {\n+      currentAssignmentCopy.put(k, new HashSet<>(v));\n+      // building the full list and then removing the reused tasks rather than building the list from dead tasks\n+      // to avoid assignment of same task from dead instance to two live instances in case of interrupt exception.", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyODkyMA==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421028920", "bodyText": "Strongly agree.\nThere's a whole story behind reusing tasks assigned to dead instances. I'd suggest expanding the comment even further to explain:\n\nwhy we reuse tasks assigned to dead instances to begin with\ncaveats we consider during this reuse, like the possibility of having the same task assigned to more than one instance (and why that might happen in the first place)", "author": "ahmedahamid", "createdAt": "2020-05-06T19:11:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4MTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDg5NQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840895", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:57:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4MTg5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4NDI4NQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r420284285", "body": "You can modify this to be:\r\n\r\n`return ((reuseTasksPerDg.size() > 0) ? reuseTasksPerDg.remove(0) : new DatastreamTaskImpl(dg.getDatastreams()));`\r\n\r\nYou can also inline this where it is called if you'd like.", "bodyText": "You can modify this to be:\nreturn ((reuseTasksPerDg.size() > 0) ? reuseTasksPerDg.remove(0) : new DatastreamTaskImpl(dg.getDatastreams()));\nYou can also inline this where it is called if you'd like.", "bodyHTML": "<p dir=\"auto\">You can modify this to be:</p>\n<p dir=\"auto\"><code>return ((reuseTasksPerDg.size() &gt; 0) ? reuseTasksPerDg.remove(0) : new DatastreamTaskImpl(dg.getDatastreams()));</code></p>\n<p dir=\"auto\">You can also inline this where it is called if you'd like.</p>", "author": "somandal", "createdAt": "2020-05-05T17:30:42Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/BroadcastStrategy.java", "diffHunk": "@@ -93,6 +107,13 @@ public BroadcastStrategy(Optional<Integer> maxTasks) {\n     return newAssignment;\n   }\n \n+  private DatastreamTask getOrCreateDatastreamTask(List<DatastreamTask> reuseTasksPerDg, DatastreamGroup dg) {\n+    if (reuseTasksPerDg.size() > 0) {\n+      return reuseTasksPerDg.remove(0);\n+    }\n+    return new DatastreamTaskImpl(dg.getDatastreams());", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDg2OQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840869", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:57:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4NDI4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4NzM1NQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r420287355", "body": "Do you need these logs in the test?", "bodyText": "Do you need these logs in the test?", "bodyHTML": "<p dir=\"auto\">Do you need these logs in the test?</p>", "author": "somandal", "createdAt": "2020-05-05T17:35:45Z", "path": "datastream-server/src/test/java/com/linkedin/datastream/server/assignment/TestBroadcastStrategy.java", "diffHunk": "@@ -279,4 +280,21 @@ public void testRebalanceTasksWhenNewInstanceIsAdded() {\n \n     Assert.assertEquals(newAssignment.get(instance4).size(), expectedNumTasksPerInstance);\n   }\n+\n+  @Test\n+  public void testDontCreateNewTasksWhenInstanceChanged() {\n+    String[] instances = new String[]{\"instance1\", \"instance2\", \"instance3\"};\n+    List<DatastreamGroup> datastreams = generateDatastreams(\"ds\", 5);\n+    BroadcastStrategy strategy = new BroadcastStrategy(Optional.empty());\n+    Map<String, Set<DatastreamTask>> assignment =\n+        strategy.assign(datastreams, Arrays.asList(instances), new HashMap<>());\n+    instances = new String[]{\"instance1\", \"instance2\", \"instance4\"};\n+\n+    Map<String, Set<DatastreamTask>> newAssignment = strategy.assign(datastreams, Arrays.asList(instances), assignment);\n+    Set<DatastreamTask> oldAssignmentTasks = assignment.values().stream().flatMap(Set::stream).collect(Collectors.toSet());\n+    Set<DatastreamTask> newAssignmentTasks = newAssignment.values().stream().flatMap(Set::stream).collect(Collectors.toSet());\n+    LOG.info(\"{}\", oldAssignmentTasks);\n+    LOG.info(\"{}\", newAssignmentTasks);", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NzQ5Mw==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421047493", "bodyText": "+1", "author": "ahmedahamid", "createdAt": "2020-05-06T19:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4NzM1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDgxMw==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840813", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:57:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI4NzM1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMDY5MA==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421030690", "body": "Not your fault: this isn't very efficient; `new HashSet` isn't needed if `instance` is not absent. This could be improved to:\r\n```java\r\n currentAssignmentCopy.computeIfAbsent(instance, i -> new HashSet<>());\r\n```\r\nIf we do that, we could also improve line 76 by avoiding the extra `get()`:\r\n```java\r\nSet<DatastreamTask> instanceTasks = currentAssignmentCopy.computeIfAbsent(instance, i -> new HashSet<>());\r\ntasksAvailableToReuse.removeAll(instanceTasks);\r\n```", "bodyText": "Not your fault: this isn't very efficient; new HashSet isn't needed if instance is not absent. This could be improved to:\n currentAssignmentCopy.computeIfAbsent(instance, i -> new HashSet<>());\nIf we do that, we could also improve line 76 by avoiding the extra get():\nSet<DatastreamTask> instanceTasks = currentAssignmentCopy.computeIfAbsent(instance, i -> new HashSet<>());\ntasksAvailableToReuse.removeAll(instanceTasks);", "bodyHTML": "<p dir=\"auto\">Not your fault: this isn't very efficient; <code>new HashSet</code> isn't needed if <code>instance</code> is not absent. This could be improved to:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\" currentAssignmentCopy.computeIfAbsent(instance, i -&gt; new HashSet&lt;&gt;());\"><pre> currentAssignmentCopy<span class=\"pl-k\">.</span>computeIfAbsent(instance, i <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashSet&lt;&gt;</span>());</pre></div>\n<p dir=\"auto\">If we do that, we could also improve line 76 by avoiding the extra <code>get()</code>:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Set&lt;DatastreamTask&gt; instanceTasks = currentAssignmentCopy.computeIfAbsent(instance, i -&gt; new HashSet&lt;&gt;());\ntasksAvailableToReuse.removeAll(instanceTasks);\"><pre><span class=\"pl-k\">Set&lt;<span class=\"pl-smi\">DatastreamTask</span>&gt;</span> instanceTasks <span class=\"pl-k\">=</span> currentAssignmentCopy<span class=\"pl-k\">.</span>computeIfAbsent(instance, i <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> <span class=\"pl-k\">new</span> <span class=\"pl-k\">HashSet&lt;&gt;</span>());\ntasksAvailableToReuse<span class=\"pl-k\">.</span>removeAll(instanceTasks);</pre></div>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:14:31Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/BroadcastStrategy.java", "diffHunk": "@@ -59,17 +60,27 @@ public BroadcastStrategy(Optional<Integer> maxTasks) {\n \n     Map<String, Set<DatastreamTask>> newAssignment = new HashMap<>();\n \n+    Set<DatastreamTask> tasksAvailableToReuse = new HashSet<>();\n     // Make a copy of the current assignment, since the strategy modifies it during calculation\n     Map<String, Set<DatastreamTask>> currentAssignmentCopy = new HashMap<>(currentAssignment.size());\n-    currentAssignment.forEach((k, v) -> currentAssignmentCopy.put(k, new HashSet<>(v)));\n+    currentAssignment.forEach((k, v) -> {\n+      currentAssignmentCopy.put(k, new HashSet<>(v));\n+      // building the full list and then removing the reused tasks rather than building the list from dead tasks\n+      // to avoid assignment of same task from dead instance to two live instances in case of interrupt exception.\n+      tasksAvailableToReuse.addAll(v);\n+    });\n \n     for (String instance : instances) {\n       newAssignment.put(instance, new HashSet<>());\n       currentAssignmentCopy.putIfAbsent(instance, new HashSet<>());", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDc1OQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840759", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:57:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzMDY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MTE5OA==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421041198", "body": "Would it be better if we built a map of `taskPrefix` -> `List<DatastreamTask>` out of `tasksAvailableToReuse` before the loop on 80 instead of doing this? \r\n\r\nI think that'll be simpler, let alone it'll spare us having to filter `tasksAvailableToReuse` over and over for every `dg`.", "bodyText": "Would it be better if we built a map of taskPrefix -> List<DatastreamTask> out of tasksAvailableToReuse before the loop on 80 instead of doing this?\nI think that'll be simpler, let alone it'll spare us having to filter tasksAvailableToReuse over and over for every dg.", "bodyHTML": "<p dir=\"auto\">Would it be better if we built a map of <code>taskPrefix</code> -&gt; <code>List&lt;DatastreamTask&gt;</code> out of <code>tasksAvailableToReuse</code> before the loop on 80 instead of doing this?</p>\n<p dir=\"auto\">I think that'll be simpler, let alone it'll spare us having to filter <code>tasksAvailableToReuse</code> over and over for every <code>dg</code>.</p>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:33:09Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/BroadcastStrategy.java", "diffHunk": "@@ -59,17 +60,27 @@ public BroadcastStrategy(Optional<Integer> maxTasks) {\n \n     Map<String, Set<DatastreamTask>> newAssignment = new HashMap<>();\n \n+    Set<DatastreamTask> tasksAvailableToReuse = new HashSet<>();\n     // Make a copy of the current assignment, since the strategy modifies it during calculation\n     Map<String, Set<DatastreamTask>> currentAssignmentCopy = new HashMap<>(currentAssignment.size());\n-    currentAssignment.forEach((k, v) -> currentAssignmentCopy.put(k, new HashSet<>(v)));\n+    currentAssignment.forEach((k, v) -> {\n+      currentAssignmentCopy.put(k, new HashSet<>(v));\n+      // building the full list and then removing the reused tasks rather than building the list from dead tasks\n+      // to avoid assignment of same task from dead instance to two live instances in case of interrupt exception.\n+      tasksAvailableToReuse.addAll(v);\n+    });\n \n     for (String instance : instances) {\n       newAssignment.put(instance, new HashSet<>());\n       currentAssignmentCopy.putIfAbsent(instance, new HashSet<>());\n+      tasksAvailableToReuse.removeAll(currentAssignmentCopy.get(instance));\n     }\n \n     int instancePos = 0;\n     for (DatastreamGroup dg : datastreams) {\n+      List<DatastreamTask> reuseTasksPerDg = tasksAvailableToReuse.stream().filter(x ->\n+          x.getTaskPrefix().equals(dg.getTaskPrefix())).collect(Collectors.toList());", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDczMg==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840732", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:57:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MTE5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MjY2MA==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421042660", "body": "You can make this part of the previous expression by replacing `orElse(null)` with:\r\n```java\r\n.orElseGet(() -> getOrCreateDatastreamTask(reuseTasksPerDg, dg));\r\n```", "bodyText": "You can make this part of the previous expression by replacing orElse(null) with:\n.orElseGet(() -> getOrCreateDatastreamTask(reuseTasksPerDg, dg));", "bodyHTML": "<p dir=\"auto\">You can make this part of the previous expression by replacing <code>orElse(null)</code> with:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\".orElseGet(() -&gt; getOrCreateDatastreamTask(reuseTasksPerDg, dg));\"><pre>.orElseGet(() <span class=\"pl-k\">-</span><span class=\"pl-k\">&gt;</span> getOrCreateDatastreamTask(reuseTasksPerDg, dg));</pre></div>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:35:41Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/BroadcastStrategy.java", "diffHunk": "@@ -78,7 +89,10 @@ public BroadcastStrategy(Optional<Integer> maxTasks) {\n             .stream()\n             .filter(x -> x.getTaskPrefix().equals(dg.getTaskPrefix()))\n             .findFirst()\n-            .orElse(new DatastreamTaskImpl(dg.getDatastreams()));\n+            .orElse(null);\n+        if (foundDatastreamTask == null) {\n+          foundDatastreamTask = getOrCreateDatastreamTask(reuseTasksPerDg, dg);\n+        }", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDY5MQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840691", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MjY2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MzIyMA==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421043220", "body": "Removing the last one is cheaper.", "bodyText": "Removing the last one is cheaper.", "bodyHTML": "<p dir=\"auto\">Removing the last one is cheaper.</p>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:36:46Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/BroadcastStrategy.java", "diffHunk": "@@ -93,6 +107,13 @@ public BroadcastStrategy(Optional<Integer> maxTasks) {\n     return newAssignment;\n   }\n \n+  private DatastreamTask getOrCreateDatastreamTask(List<DatastreamTask> reuseTasksPerDg, DatastreamGroup dg) {\n+    if (reuseTasksPerDg.size() > 0) {\n+      return reuseTasksPerDg.remove(0);", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDY2OQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840669", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MzgwMw==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421043803", "body": "Can be more succinctly expressed as `if (!reuseTasksPerDg.isEmpty())`", "bodyText": "Can be more succinctly expressed as if (!reuseTasksPerDg.isEmpty())", "bodyHTML": "<p dir=\"auto\">Can be more succinctly expressed as <code>if (!reuseTasksPerDg.isEmpty())</code></p>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:37:55Z", "path": "datastream-server/src/main/java/com/linkedin/datastream/server/assignment/BroadcastStrategy.java", "diffHunk": "@@ -93,6 +107,13 @@ public BroadcastStrategy(Optional<Integer> maxTasks) {\n     return newAssignment;\n   }\n \n+  private DatastreamTask getOrCreateDatastreamTask(List<DatastreamTask> reuseTasksPerDg, DatastreamGroup dg) {\n+    if (reuseTasksPerDg.size() > 0) {", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDY0Mg==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840642", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:56:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0MzgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NjczMg==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421046732", "body": "nit: Names are slightly inconsistent; we get `oldAssignmentTasks` from `assignment` but `newAssignmentTasks` from `newAssignment`.\r\n\r\nHow about `firstAssignment` -> `firstAssignmentTasks` and `secondAssignment` -> `secondAssignmentTasks`?", "bodyText": "nit: Names are slightly inconsistent; we get oldAssignmentTasks from assignment but newAssignmentTasks from newAssignment.\nHow about firstAssignment -> firstAssignmentTasks and secondAssignment -> secondAssignmentTasks?", "bodyHTML": "<p dir=\"auto\">nit: Names are slightly inconsistent; we get <code>oldAssignmentTasks</code> from <code>assignment</code> but <code>newAssignmentTasks</code> from <code>newAssignment</code>.</p>\n<p dir=\"auto\">How about <code>firstAssignment</code> -&gt; <code>firstAssignmentTasks</code> and <code>secondAssignment</code> -&gt; <code>secondAssignmentTasks</code>?</p>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:43:22Z", "path": "datastream-server/src/test/java/com/linkedin/datastream/server/assignment/TestBroadcastStrategy.java", "diffHunk": "@@ -279,4 +280,21 @@ public void testRebalanceTasksWhenNewInstanceIsAdded() {\n \n     Assert.assertEquals(newAssignment.get(instance4).size(), expectedNumTasksPerInstance);\n   }\n+\n+  @Test\n+  public void testDontCreateNewTasksWhenInstanceChanged() {\n+    String[] instances = new String[]{\"instance1\", \"instance2\", \"instance3\"};\n+    List<DatastreamGroup> datastreams = generateDatastreams(\"ds\", 5);\n+    BroadcastStrategy strategy = new BroadcastStrategy(Optional.empty());\n+    Map<String, Set<DatastreamTask>> assignment =\n+        strategy.assign(datastreams, Arrays.asList(instances), new HashMap<>());\n+    instances = new String[]{\"instance1\", \"instance2\", \"instance4\"};\n+\n+    Map<String, Set<DatastreamTask>> newAssignment = strategy.assign(datastreams, Arrays.asList(instances), assignment);\n+    Set<DatastreamTask> oldAssignmentTasks = assignment.values().stream().flatMap(Set::stream).collect(Collectors.toSet());\n+    Set<DatastreamTask> newAssignmentTasks = newAssignment.values().stream().flatMap(Set::stream).collect(Collectors.toSet());", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI5MjgxMA==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421292810", "bodyText": "I kept the names inline with rest of the tests in the class for uniformity. Please let me know if you feel otherwise.", "author": "vmaheshw", "createdAt": "2020-05-07T07:24:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NjczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2NTYyNw==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421665627", "bodyText": "Understood. No problem. Feel free to keep them as is.", "author": "ahmedahamid", "createdAt": "2020-05-07T17:17:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NjczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NzE4MQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421047181", "body": "Rename to something along the lines of: `testReuseDeadInstanceTasks`?", "bodyText": "Rename to something along the lines of: testReuseDeadInstanceTasks?", "bodyHTML": "<p dir=\"auto\">Rename to something along the lines of: <code>testReuseDeadInstanceTasks</code>?</p>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:44:09Z", "path": "datastream-server/src/test/java/com/linkedin/datastream/server/assignment/TestBroadcastStrategy.java", "diffHunk": "@@ -279,4 +280,21 @@ public void testRebalanceTasksWhenNewInstanceIsAdded() {\n \n     Assert.assertEquals(newAssignment.get(instance4).size(), expectedNumTasksPerInstance);\n   }\n+\n+  @Test\n+  public void testDontCreateNewTasksWhenInstanceChanged() {", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDQ5OA==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840498", "bodyText": "kept the test name same as StickyMulticastStrategy.", "author": "vmaheshw", "createdAt": "2020-05-07T22:56:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NzE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1Njk3OQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421856979", "bodyText": "No problem", "author": "ahmedahamid", "createdAt": "2020-05-07T23:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0NzE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0OTI3Mg==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421049272", "body": "1. Should we make this assert stricter: assert they're actually the exact same set of tasks?\r\n\r\n```java\r\nAssert.assertEquals(oldAssignmentTasks, newAssignmentTasks);\r\n```\r\n\r\n2. Should we also assert that no task was assigned to more than one instance?", "bodyText": "Should we make this assert stricter: assert they're actually the exact same set of tasks?\n\nAssert.assertEquals(oldAssignmentTasks, newAssignmentTasks);\n\nShould we also assert that no task was assigned to more than one instance?", "bodyHTML": "<ol dir=\"auto\">\n<li>Should we make this assert stricter: assert they're actually the exact same set of tasks?</li>\n</ol>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Assert.assertEquals(oldAssignmentTasks, newAssignmentTasks);\"><pre><span class=\"pl-smi\">Assert</span><span class=\"pl-k\">.</span>assertEquals(oldAssignmentTasks, newAssignmentTasks);</pre></div>\n<ol start=\"2\" dir=\"auto\">\n<li>Should we also assert that no task was assigned to more than one instance?</li>\n</ol>", "author": "ahmedahamid", "createdAt": "2020-05-06T19:47:52Z", "path": "datastream-server/src/test/java/com/linkedin/datastream/server/assignment/TestBroadcastStrategy.java", "diffHunk": "@@ -279,4 +280,21 @@ public void testRebalanceTasksWhenNewInstanceIsAdded() {\n \n     Assert.assertEquals(newAssignment.get(instance4).size(), expectedNumTasksPerInstance);\n   }\n+\n+  @Test\n+  public void testDontCreateNewTasksWhenInstanceChanged() {\n+    String[] instances = new String[]{\"instance1\", \"instance2\", \"instance3\"};\n+    List<DatastreamGroup> datastreams = generateDatastreams(\"ds\", 5);\n+    BroadcastStrategy strategy = new BroadcastStrategy(Optional.empty());\n+    Map<String, Set<DatastreamTask>> assignment =\n+        strategy.assign(datastreams, Arrays.asList(instances), new HashMap<>());\n+    instances = new String[]{\"instance1\", \"instance2\", \"instance4\"};\n+\n+    Map<String, Set<DatastreamTask>> newAssignment = strategy.assign(datastreams, Arrays.asList(instances), assignment);\n+    Set<DatastreamTask> oldAssignmentTasks = assignment.values().stream().flatMap(Set::stream).collect(Collectors.toSet());\n+    Set<DatastreamTask> newAssignmentTasks = newAssignment.values().stream().flatMap(Set::stream).collect(Collectors.toSet());\n+    LOG.info(\"{}\", oldAssignmentTasks);\n+    LOG.info(\"{}\", newAssignmentTasks);\n+    Assert.assertTrue(oldAssignmentTasks.containsAll(newAssignmentTasks));", "originalCommit": "4f9089651ff0d2c8a567f383381c2f6b08b643b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU3OQ==", "url": "https://github.com/linkedin/brooklin/pull/706#discussion_r421840579", "bodyText": "Done.", "author": "vmaheshw", "createdAt": "2020-05-07T22:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA0OTI3Mg=="}], "type": "inlineReview"}, {"oid": "07fd332db34ee601bea810e224c876f86e45b893", "url": "https://github.com/linkedin/brooklin/commit/07fd332db34ee601bea810e224c876f86e45b893", "message": "Address review comments", "committedDate": "2020-05-07T18:01:16Z", "type": "commit"}, {"oid": "2198c2dc2991cc6936a5c4cd992a3c334348e684", "url": "https://github.com/linkedin/brooklin/commit/2198c2dc2991cc6936a5c4cd992a3c334348e684", "message": "Address review comments", "committedDate": "2020-05-07T23:43:18Z", "type": "commit"}]}