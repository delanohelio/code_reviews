{"pr_number": 1632, "pr_title": "Select correct ObjectInspector based on Hive version on classpath", "pr_author": "marton-bod", "pr_createdAt": "2020-10-19T14:58:15Z", "pr_url": "https://github.com/apache/iceberg/pull/1632", "timeline": [{"oid": "30f63ea227d7cac81cfae1877401f6922fb690af", "url": "https://github.com/apache/iceberg/commit/30f63ea227d7cac81cfae1877401f6922fb690af", "message": "Select correct ObjectInspector based on Hive version on classpath", "committedDate": "2020-10-19T14:52:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5MzQ4Ng==", "url": "https://github.com/apache/iceberg/pull/1632#discussion_r507893486", "body": "Nit: indentation is off now.", "bodyText": "Nit: indentation is off now.", "bodyHTML": "<p dir=\"auto\">Nit: indentation is off now.</p>", "author": "rdblue", "createdAt": "2020-10-19T16:34:50Z", "path": "mr/src/main/java/org/apache/iceberg/mr/hive/serde/objectinspector/IcebergObjectInspector.java", "diffHunk": "@@ -36,23 +37,29 @@\n \n   // get the correct inspectors depending on whether we're working with Hive2 or Hive3 dependencies\n   // we need to do this because there is a breaking API change in Date/TimestampObjectInspector between Hive2 and Hive3\n-  private static final ObjectInspector DATE_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspectorHive3\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\")\n-      .buildStatic()\n-      .invoke();\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(false);\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR_WITH_TZ = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(true);\n+  private static final ObjectInspector DATE_INSPECTOR = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\",", "originalCommit": "30f63ea227d7cac81cfae1877401f6922fb690af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTMwOQ==", "url": "https://github.com/apache/iceberg/pull/1632#discussion_r507895309", "body": "It seems like it would be a bit easier to read if you didn't wrap the `DynMethods` call and instead just swapped out the class:\r\n\r\n```java\r\nprivate static final TIMESTAMP_INSPECTOR_CLASS = MetastoreUtil.hive3PresentOnClasspath() ?\r\n    \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\" :\r\n    \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\";\r\nprivate static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(\"get\")\r\n    .impl(TIMESTAMP_INSPECTOR_CLASS, boolean.class)\r\n    .buildStatic()\r\n    .invoke(false);\r\n```\r\n\r\nThat way you don't need all of the inline array literals.", "bodyText": "It seems like it would be a bit easier to read if you didn't wrap the DynMethods call and instead just swapped out the class:\nprivate static final TIMESTAMP_INSPECTOR_CLASS = MetastoreUtil.hive3PresentOnClasspath() ?\n    \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\" :\n    \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\";\nprivate static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(\"get\")\n    .impl(TIMESTAMP_INSPECTOR_CLASS, boolean.class)\n    .buildStatic()\n    .invoke(false);\nThat way you don't need all of the inline array literals.", "bodyHTML": "<p dir=\"auto\">It seems like it would be a bit easier to read if you didn't wrap the <code>DynMethods</code> call and instead just swapped out the class:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"private static final TIMESTAMP_INSPECTOR_CLASS = MetastoreUtil.hive3PresentOnClasspath() ?\n    &quot;org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector&quot; :\n    &quot;org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3&quot;;\nprivate static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(&quot;get&quot;)\n    .impl(TIMESTAMP_INSPECTOR_CLASS, boolean.class)\n    .buildStatic()\n    .invoke(false);\n\"><pre><span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-c1\">TIMESTAMP_INSPECTOR_CLASS</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">MetastoreUtil</span><span class=\"pl-k\">.</span>hive3PresentOnClasspath() <span class=\"pl-k\">?</span>\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector<span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">:</span>\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3<span class=\"pl-pds\">\"</span></span>;\n<span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">ObjectInspector</span> <span class=\"pl-c1\">TIMESTAMP_INSPECTOR</span> <span class=\"pl-k\">=</span> <span class=\"pl-smi\">DynMethods</span><span class=\"pl-k\">.</span>builder(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>get<span class=\"pl-pds\">\"</span></span>)\n    .impl(<span class=\"pl-c1\">TIMESTAMP_INSPECTOR_CLASS</span>, <span class=\"pl-k\">boolean</span><span class=\"pl-k\">.</span>class)\n    .buildStatic()\n    .invoke(<span class=\"pl-c1\">false</span>);</pre></div>\n<p dir=\"auto\">That way you don't need all of the inline array literals.</p>", "author": "rdblue", "createdAt": "2020-10-19T16:37:41Z", "path": "mr/src/main/java/org/apache/iceberg/mr/hive/serde/objectinspector/IcebergObjectInspector.java", "diffHunk": "@@ -36,23 +37,29 @@\n \n   // get the correct inspectors depending on whether we're working with Hive2 or Hive3 dependencies\n   // we need to do this because there is a breaking API change in Date/TimestampObjectInspector between Hive2 and Hive3\n-  private static final ObjectInspector DATE_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspectorHive3\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\")\n-      .buildStatic()\n-      .invoke();\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(false);\n-\n-  private static final ObjectInspector TIMESTAMP_INSPECTOR_WITH_TZ = DynMethods.builder(\"get\")\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\", boolean.class)\n-      .impl(\"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\", boolean.class)\n-      .buildStatic()\n-      .invoke(true);\n+  private static final ObjectInspector DATE_INSPECTOR = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspector\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergDateObjectInspectorHive3\",\n+          new Class[] {}, new Object[] {});\n+\n+  private static final ObjectInspector TIMESTAMP_INSPECTOR = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\",\n+          new Class[] { boolean.class }, new Object[] { false });\n+\n+  private static final ObjectInspector TIMESTAMP_INSPECTOR_WITH_TZ = getObjectInspectorBasedOnHiveVersion(\"get\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspector\",\n+          \"org.apache.iceberg.mr.hive.serde.objectinspector.IcebergTimestampObjectInspectorHive3\",\n+          new Class[] { boolean.class }, new Object[] { true });\n+\n+  private static ObjectInspector getObjectInspectorBasedOnHiveVersion(\n+          String staticMethod, String hive2Class, String hive3Class, Class[] argTypes, Object[] args) {\n+    String classToUse = MetastoreUtil.hive3PresentOnClasspath() ? hive3Class : hive2Class;\n+    return DynMethods.builder(staticMethod)\n+            .impl(classToUse, argTypes)\n+            .buildStatic()\n+            .invoke(args);", "originalCommit": "30f63ea227d7cac81cfae1877401f6922fb690af", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkxOTU5OQ==", "url": "https://github.com/apache/iceberg/pull/1632#discussion_r507919599", "bodyText": "yep...much simpler, thanks:)\nchanged it", "author": "marton-bod", "createdAt": "2020-10-19T17:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg5NTMwOQ=="}], "type": "inlineReview"}, {"oid": "d2db4242f3f50b3de4ce18b66c46ec38844e2f8d", "url": "https://github.com/apache/iceberg/commit/d2db4242f3f50b3de4ce18b66c46ec38844e2f8d", "message": "Simplify object inspector selection logic", "committedDate": "2020-10-19T17:14:48Z", "type": "commit"}]}