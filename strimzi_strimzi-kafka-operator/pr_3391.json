{"pr_number": 3391, "pr_title": "[systemtest] Load ST variables from json config", "pr_author": "kornys", "pr_createdAt": "2020-07-27T11:01:52Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391", "timeline": [{"oid": "18893f94092313506d63a0c4d0b74ac2ee52d2c3", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/18893f94092313506d63a0c4d0b74ac2ee52d2c3", "message": "[SystemTest] Load ST env from configuration\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T10:50:37Z", "type": "commit"}, {"oid": "fc0c0eeab8b404363253eae726660822e615b23d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fc0c0eeab8b404363253eae726660822e615b23d", "message": "Write doc\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T12:09:11Z", "type": "forcePushed"}, {"oid": "036196cd0cdd259312786b264893e305c171ae09", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/036196cd0cdd259312786b264893e305c171ae09", "message": "Write doc\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T12:42:41Z", "type": "commit"}, {"oid": "036196cd0cdd259312786b264893e305c171ae09", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/036196cd0cdd259312786b264893e305c171ae09", "message": "Write doc\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-27T12:42:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3MzI0OA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r461173248", "body": "```suggestion\r\n    private static final String CONFIG_FILE_PATH_ENVAR = \"SYSTEM_TEST_CONFIG_PATH\";\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String CONFIG_ENV = \"CONFIG\";\n          \n          \n            \n                private static final String CONFIG_FILE_PATH_ENVAR = \"SYSTEM_TEST_CONFIG_PATH\";", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">CONFIG_ENV</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">CONFIG</span><span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">String</span> <span class=\"pl-c1 x x-first x-last\">CONFIG_FILE_PATH_ENVAR</span> <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"x x-first x-last\">SYSTEM_TEST_CONFIG_PATH</span><span class=\"pl-pds\">\"</span></span>;</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "samuel-hawker", "createdAt": "2020-07-27T21:12:56Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/Environment.java", "diffHunk": "@@ -4,18 +4,33 @@\n  */\n package io.strimzi.systemtest;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n import java.util.Locale;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n \n /**\n  * Class which holds environment variables for system tests.\n  */\n public class Environment {\n \n     private static final Logger LOGGER = LogManager.getLogger(Environment.class);\n+    private static final Map<String, String> VALUES = new HashMap<>();\n+    private static final JsonNode JSON_DATA = loadJsonEnv();\n \n+    /**\n+     * Specify config json/yaml path with env variables values\n+     */\n+    private static final String CONFIG_ENV = \"CONFIG\";", "originalCommit": "036196cd0cdd259312786b264893e305c171ae09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3Mzk1Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r461173957", "body": "```suggestion\r\n     * Specify the system test configuration file path from an environmental variable\r\n     * This configuration file has a JSON or YAML format\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Specify config json/yaml path with env variables values\n          \n          \n            \n                 * Specify the system test configuration file path from an environmental variable\n          \n          \n            \n                 * This configuration file has a JSON or YAML format", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Specify</span> <span class=\"x x-first\">config json</span><span class=\"pl-k x\">/</span><span class=\"x x-last\">yaml </span>path <span class=\"x x-first x-last\">with env variables values</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Specify</span> <span class=\"x x-first x-last\">the system test configuration file </span>path <span class=\"x x-first x-last\">from an environmental variable</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">This</span> configuration file has a <span class=\"pl-c1\">JSON</span> or <span class=\"pl-c1\">YAML</span> format</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "samuel-hawker", "createdAt": "2020-07-27T21:14:21Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/Environment.java", "diffHunk": "@@ -4,18 +4,33 @@\n  */\n package io.strimzi.systemtest;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import org.apache.logging.log4j.LogManager;\n import org.apache.logging.log4j.Logger;\n \n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n import java.util.Locale;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.function.Function;\n \n /**\n  * Class which holds environment variables for system tests.\n  */\n public class Environment {\n \n     private static final Logger LOGGER = LogManager.getLogger(Environment.class);\n+    private static final Map<String, String> VALUES = new HashMap<>();\n+    private static final JsonNode JSON_DATA = loadJsonEnv();\n \n+    /**\n+     * Specify config json/yaml path with env variables values", "originalCommit": "036196cd0cdd259312786b264893e305c171ae09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTE3NTExMw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3391#discussion_r461175113", "body": "```suggestion\r\n    private static JsonNode loadConfigurationFile() {\r\n```\r\nI would recommend this renaming to make clearer what it is doing, the fact that the file is JSON/YAML is an implementation detail and (hopefully) should be obvious from the documentation + return type", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static JsonNode loadJsonEnv() {\n          \n          \n            \n                private static JsonNode loadConfigurationFile() {\n          \n      \n    \n    \n  \n\nI would recommend this renaming to make clearer what it is doing, the fact that the file is JSON/YAML is an implementation detail and (hopefully) should be obvious from the documentation + return type", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">JsonNode</span> <span class=\"x x-first x-last\">loadJsonEnv</span>() {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-smi\">JsonNode</span> <span class=\"x x-first x-last\">loadConfigurationFile</span>() {</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">I would recommend this renaming to make clearer what it is doing, the fact that the file is JSON/YAML is an implementation detail and (hopefully) should be obvious from the documentation + return type</p>", "author": "samuel-hawker", "createdAt": "2020-07-27T21:16:40Z", "path": "systemtest/src/main/java/io/strimzi/systemtest/Environment.java", "diffHunk": "@@ -161,4 +164,35 @@ public static boolean isHelmInstall() {\n     public static boolean useLatestReleasedBridge() {\n         return Environment.BRIDGE_IMAGE.equals(Environment.BRIDGE_IMAGE_DEFAULT);\n     }\n+\n+    private static String getOrDefault(String varName, String defaultValue) {\n+        return getOrDefault(varName, String::toString, defaultValue);\n+    }\n+\n+    private static <T> T getOrDefault(String var, Function<String, T> converter, T defaultValue) {\n+        String value = System.getenv(var) != null ?\n+                System.getenv(var) :\n+                (Objects.requireNonNull(JSON_DATA).get(var) != null ?\n+                        JSON_DATA.get(var).asText() :\n+                        null);\n+        T returnValue = defaultValue;\n+        if (value != null) {\n+            returnValue = converter.apply(value);\n+        }\n+        VALUES.put(var, String.valueOf(returnValue));\n+        return returnValue;\n+    }\n+\n+    private static JsonNode loadJsonEnv() {", "originalCommit": "036196cd0cdd259312786b264893e305c171ae09", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "92ba4a96a63e443ecc1cbde704844c681e769b0e", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/92ba4a96a63e443ecc1cbde704844c681e769b0e", "message": "Address comments\n\nSigned-off-by: David Kornel <kornys@outlook.com>", "committedDate": "2020-07-28T07:46:54Z", "type": "commit"}]}