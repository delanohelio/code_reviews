{"pr_number": 3754, "pr_title": "Fix upgrade from 0.19 when Kafka version is not specified in the CRD", "pr_author": "scholzj", "pr_createdAt": "2020-10-07T00:03:14Z", "pr_url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3754", "timeline": [{"oid": "fe7def7f0f42b1c6db882e2152feb41feefba2e5", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fe7def7f0f42b1c6db882e2152feb41feefba2e5", "message": "Fix upgrade from 0.19 when Kafka version is not specified in the CRD - Closes #3685\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-10-06T22:41:19Z", "type": "commit"}, {"oid": "cb1d957a1dd5a9de8803af2172b47681f8b2027d", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cb1d957a1dd5a9de8803af2172b47681f8b2027d", "message": "Fix NPE on new clusters when the version is not known yet\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-10-06T23:22:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwNjQxMA==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3754#discussion_r500806410", "body": "Just typo ... \r\n```suggestion\r\n                log.debug(\"{}: Kafka versions are not known yet, upgrade will be skipped\", reconciliation);\r\n```", "bodyText": "Just typo ...\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.debug(\"{}: Kafka versions are not known yet, upgrade iwll be skipped\", reconciliation);\n          \n          \n            \n                            log.debug(\"{}: Kafka versions are not known yet, upgrade will be skipped\", reconciliation);", "bodyHTML": "<p dir=\"auto\">Just typo ...</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                log<span class=\"pl-k\">.</span>debug(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{}: Kafka versions are not known yet, upgrade <span class=\"x x-first x-last\">iwll</span> be skipped<span class=\"pl-pds\">\"</span></span>, reconciliation);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                log<span class=\"pl-k\">.</span>debug(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>{}: Kafka versions are not known yet, upgrade <span class=\"x x-first x-last\">will</span> be skipped<span class=\"pl-pds\">\"</span></span>, reconciliation);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "im-konge", "createdAt": "2020-10-07T07:49:46Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -896,35 +898,65 @@ private KafkaVersionChange getKafkaVersionChange(StatefulSet kafkaSts) {\n                             return Future.succeededFuture(this);\n                         }\n \n-                        KafkaVersionChange versionChange = getKafkaVersionChange(oldSts);\n+                        this.versionChange = getKafkaVersionChange(oldSts);\n+                        return Future.succeededFuture(this);\n+                    });\n+        }\n \n-                        // Get the current version of the cluster\n-                        KafkaVersion currentVersion = versions.version(Annotations.annotations(oldSts).get(ANNO_STRIMZI_IO_KAFKA_VERSION));\n+        /**\n+         * Does the Kafka upgrade from one version to another. Regular upgrades with Kafka version specified in the\n+         * Kafka CR are done as early as possible in the cycle since the broker has already rolled with the new Strimzi\n+         * version before. This is indicated by the postponedUpgrade flag being set to false. Upgrades without Kafka\n+         * version specified in the Kafka CR upgrade the operator and Kafka in one go. These have to run only before the\n+         * regular Kafka rolling update when all resources are already updated. This is indicated by the\n+         * postponedUpgrade flag being set to true.\n+         *\n+         * @param postponedUpgrade     Indicates the phase from which is this method called.\n+         * @return\n+         */\n+        Future<ReconciliationState> kafkaVersionChange(boolean postponedUpgrade) {\n+            boolean shouldBePostponed = kafkaAssembly.getSpec().getKafka().getVersion() == null;\n \n-                        StatefulSet sts;\n-                        ConfigMap cm;\n+            if (versionChange == null)   {\n+                log.debug(\"{}: Kafka versions are not known yet, upgrade iwll be skipped\", reconciliation);", "originalCommit": "cb1d957a1dd5a9de8803af2172b47681f8b2027d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgwODc0MQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3754#discussion_r500808741", "body": "I think that we can remove this, as we are not checking this anywhere.", "bodyText": "I think that we can remove this, as we are not checking this anywhere.", "bodyHTML": "<p dir=\"auto\">I think that we can remove this, as we are not checking this anywhere.</p>", "author": "im-konge", "createdAt": "2020-10-07T07:53:28Z", "path": "systemtest/src/test/java/io/strimzi/systemtest/upgrade/StrimziUpgradeST.java", "diffHunk": "@@ -180,33 +179,34 @@ void testChainUpgrade() throws Exception {\n         }\n     }\n \n-    // TODO: remove disabled tag after fix of issue #3685\n     @Test\n-    @Disabled(\"Disabled because of bug https://github.com/strimzi/strimzi-kafka-operator/issues/3685\")\n     void testUpgradeKafkaWithoutVersion() throws IOException {\n-        File dir = FileUtils.downloadAndUnzip(latestReleasedOperator);\n-        File kafkaPersistent = new File(dir, \"strimzi-\" + latestReleasedVersion + \"/examples/kafka/kafka-persistent.yaml\");\n-        File kafkaVersions = FileUtils.downloadYaml(\"https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/\" + latestReleasedVersion + \"/kafka-versions.yaml\");\n+        File dir = FileUtils.downloadAndUnzip(strimziReleaseWithOlderKafka);\n+        File previousKafkaPersistent = new File(dir, \"strimzi-\" + strimziReleaseWithOlderKafkaVersion + \"/examples/kafka/kafka-persistent.yaml\");\n+        File previousKafkaVersionsYaml = FileUtils.downloadYaml(\"https://raw.githubusercontent.com/strimzi/strimzi-kafka-operator/\" + strimziReleaseWithOlderKafkaVersion + \"/kafka-versions.yaml\");\n+        File latestKafkaVersionsYaml = new File(TestUtils.USER_PATH + \"//../kafka-versions.yaml\");\n \n-        coDir = new File(dir, \"strimzi-\" + latestReleasedVersion + \"/install/cluster-operator/\");\n+        coDir = new File(dir, \"strimzi-\" + strimziReleaseWithOlderKafkaVersion + \"/install/cluster-operator/\");\n \n-        String latestKafkaVersion = getValueForLastKafkaVersionInFile(kafkaVersions, \"version\");\n+        //String previousKafkaVersion = getValueForLastKafkaVersionInFile(previousKafkaVersionsYaml, \"version\");", "originalCommit": "cb1d957a1dd5a9de8803af2172b47681f8b2027d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3ODIwMQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3754#discussion_r500978201", "body": "Do we want to use a boolean argument here, I wonder if it would be better to have two separate methods:\r\n```\r\nkafkaVersionChange\r\n```\r\nand\r\n```\r\nkafkaVersionChangePostponed\r\n```", "bodyText": "Do we want to use a boolean argument here, I wonder if it would be better to have two separate methods:\nkafkaVersionChange\n\nand\nkafkaVersionChangePostponed", "bodyHTML": "<p dir=\"auto\">Do we want to use a boolean argument here, I wonder if it would be better to have two separate methods:</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"kafkaVersionChange\"><pre><code>kafkaVersionChange\n</code></pre></div>\n<p dir=\"auto\">and</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"kafkaVersionChangePostponed\"><pre><code>kafkaVersionChangePostponed\n</code></pre></div>", "author": "samuel-hawker", "createdAt": "2020-10-07T12:40:05Z", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -280,7 +280,8 @@ public KafkaAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pfa,\n                 .compose(state -> state.kafkaManualPodCleaning())\n                 .compose(state -> state.kafkaNetPolicy())\n                 .compose(state -> state.kafkaManualRollingUpdate())\n-                .compose(state -> state.kafkaVersionChange())\n+                .compose(state -> state.kafkaVersionChangeCheck())\n+                .compose(state -> state.kafkaVersionChange(false))", "originalCommit": "cb1d957a1dd5a9de8803af2172b47681f8b2027d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3OTE1Nw==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3754#discussion_r500979157", "bodyText": "The methods are otherwise almost the same. So is it really worth to have separate methods duplicating the code? Or would you just want to have methods which simply delegate to the shared method again?", "author": "scholzj", "createdAt": "2020-10-07T12:41:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3ODIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk4ODc0OQ==", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3754#discussion_r500988749", "bodyText": "I was thinking through this as I was reading through the method, it would be nice if they could be split, with the duplicated logic being moved out to separate methods, I started refactoring it locally and realized to rip out the boolean would be a non-trivial effort for not enough value. I thought it was worth bringing up, as boolean arguments normally can be extracted, but in this case it wouldn't be worth it.", "author": "samuel-hawker", "createdAt": "2020-10-07T12:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk3ODIwMQ=="}], "type": "inlineReview"}, {"oid": "1f4fb9a69d09c00c027e5b30d9ecd497abac6bf7", "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1f4fb9a69d09c00c027e5b30d9ecd497abac6bf7", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>", "committedDate": "2020-10-07T17:48:54Z", "type": "commit"}]}