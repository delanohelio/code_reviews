{"pr_number": 1070, "pr_title": "Fail requests if ServiceDiscoverer emits an error", "pr_author": "idelpivnitskiy", "pr_createdAt": "2020-05-27T17:08:42Z", "pr_url": "https://github.com/apple/servicetalk/pull/1070", "timeline": [{"oid": "352b07bd749b2c81bfb745691997f80c0a07de23", "url": "https://github.com/apple/servicetalk/commit/352b07bd749b2c81bfb745691997f80c0a07de23", "message": "Fail requests if ServiceDiscoverer emits an error\n\nMotivation:\n\nBy default, DNS lookup failures are retried by `DefaultDnsServiceDiscoverer`.\nThis has a downside that if a DNS name is wrong, requests will wait forever\nwith no indication that the DNS name is wrong. Although, treating DNS failures\nas transient is mostly appropriate, lack of visibility of these failures in\nthe request path is confusing.\n\nModifications:\n\n- Disable retry on `UnknownHostException` for `DefaultDnsServiceDiscoverer`;\n- Retry `UnknownHostException` on the HTTP client side;\n- Default `AutoRetryStrategy` stops waiting for LB ready event if SD emits\nan error;\n- Allow users to configure `DefaultAutoRetryStrategyProvider` to ignore\nerrors from SD while it waits for LB ready event;\n\nResult:\n\nRequest fails if `ServiceDiscoverer` emits an error. Users can configure\n`AutoRetryStrategyProvider` to ignore those errors.\nHTTP client retries `UnknownHostException`s. Users can apply a filter for\n`ServiceDiscoverer` to alter the retry strategy.", "committedDate": "2020-05-27T01:44:23Z", "type": "commit"}, {"oid": "31a817e96ceaf799e1ecdc7448644b59df72442e", "url": "https://github.com/apple/servicetalk/commit/31a817e96ceaf799e1ecdc7448644b59df72442e", "message": "Revert back DELIBERATE_EXCEPTION for verifyOnInitializedFailedFailsAction", "committedDate": "2020-05-27T17:42:56Z", "type": "commit"}, {"oid": "8dc5d39ba43785e0ee6d0e34692bc4b3dfbf4cfe", "url": "https://github.com/apple/servicetalk/commit/8dc5d39ba43785e0ee6d0e34692bc4b3dfbf4cfe", "message": "Add serialVersionUID", "committedDate": "2020-05-28T00:29:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzNTAxMQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r431535011", "body": "Suggestion; just rename the method to `newStrategy()`", "bodyText": "Suggestion; just rename the method to newStrategy()", "bodyHTML": "<p dir=\"auto\">Suggestion; just rename the method to <code>newStrategy()</code></p>", "author": "NiteshKant", "createdAt": "2020-05-28T01:38:43Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/AutoRetryStrategyProvider.java", "diffHunk": "@@ -32,15 +33,16 @@\n     /**\n      * An {@link AutoRetryStrategyProvider} that disables automatic retries;\n      */\n-    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = __ -> (___, cause) -> failed(cause);\n+    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = (lbEventStream, sdErrorStream) -> (___, cause) -> failed(cause);\n \n     /**\n      * Create a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.\n      *\n-     * @param loadBalancer {@link LoadBalancer} to use.\n+     * @param lbEventStream a stream of events from {@link LoadBalancer#eventStream() LoadBalancer}\n+     * @param sdErrorStream a stream of errors from {@link ServiceDiscoverer#discover(Object) ServiceDiscoverer}\n      * @return New {@link AutoRetryStrategy} instance.\n      */\n-    AutoRetryStrategy forLoadbalancer(LoadBalancer<?> loadBalancer);\n+    AutoRetryStrategy forClient(Publisher<Object> lbEventStream, Publisher<Throwable> sdErrorStream);", "originalCommit": "31a817e96ceaf799e1ecdc7448644b59df72442e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzNzM4NQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r431537385", "body": "IIUC, we do not need a `Publisher` here but just a way to asynchronously emit an error so that a request waiting for LB can be pre-empted. If so, I would suggest using a `Completable` instead.", "bodyText": "IIUC, we do not need a Publisher here but just a way to asynchronously emit an error so that a request waiting for LB can be pre-empted. If so, I would suggest using a Completable instead.", "bodyHTML": "<p dir=\"auto\">IIUC, we do not need a <code>Publisher</code> here but just a way to asynchronously emit an error so that a request waiting for LB can be pre-empted. If so, I would suggest using a <code>Completable</code> instead.</p>", "author": "NiteshKant", "createdAt": "2020-05-28T01:48:16Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/AutoRetryStrategyProvider.java", "diffHunk": "@@ -32,15 +33,16 @@\n     /**\n      * An {@link AutoRetryStrategyProvider} that disables automatic retries;\n      */\n-    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = __ -> (___, cause) -> failed(cause);\n+    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = (lbEventStream, sdErrorStream) -> (___, cause) -> failed(cause);\n \n     /**\n      * Create a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.\n      *\n-     * @param loadBalancer {@link LoadBalancer} to use.\n+     * @param lbEventStream a stream of events from {@link LoadBalancer#eventStream() LoadBalancer}\n+     * @param sdErrorStream a stream of errors from {@link ServiceDiscoverer#discover(Object) ServiceDiscoverer}\n      * @return New {@link AutoRetryStrategy} instance.\n      */\n-    AutoRetryStrategy forLoadbalancer(LoadBalancer<?> loadBalancer);\n+    AutoRetryStrategy forClient(Publisher<Object> lbEventStream, Publisher<Throwable> sdErrorStream);", "originalCommit": "31a817e96ceaf799e1ecdc7448644b59df72442e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4Nzg1OA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432187858", "bodyText": "I was thinking between Publisher and Completable during the implementation and decided to go with a Publisher to make it work in a similar way as LB events: each request waits for either an LB-ready event or a new SD error.\nIf you think it's enough to wait only for the first error from SD and subsequent requests should fail fast, then I can switch to Completable. Both ways work for me.", "author": "idelpivnitskiy", "createdAt": "2020-05-29T00:02:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzNzM4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MDAyOQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r431540029", "body": "Can we remove this retry now as we are retrying from the client?", "bodyText": "Can we remove this retry now as we are retrying from the client?", "bodyHTML": "<p dir=\"auto\">Can we remove this retry now as we are retrying from the client?</p>", "author": "NiteshKant", "createdAt": "2020-05-28T01:58:24Z", "path": "servicetalk-dns-discovery-netty/src/main/java/io/servicetalk/dns/discovery/netty/DefaultDnsServiceDiscovererBuilder.java", "diffHunk": "@@ -156,12 +155,13 @@ public DefaultDnsServiceDiscovererBuilder dnsResolverAddressTypes(\n     }\n \n     /**\n-     * Do not perform retries if DNS lookup fails. Instead, terminate the {@link Publisher} with the error.\n+     * Perform retries if DNS lookup fails instead of terminating the\n+     * {@link ServiceDiscoverer#discover(Object) discovery} with an error.\n      *\n      * @return {@code this}.\n      */\n-    public DefaultDnsServiceDiscovererBuilder noRetriesOnDnsFailures() {\n-        this.applyRetryFilter = false;\n+    public DefaultDnsServiceDiscovererBuilder retryOnDnsFailures() {", "originalCommit": "31a817e96ceaf799e1ecdc7448644b59df72442e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4ODQxMg==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432188412", "bodyText": "Was going to ask if we need this at all. If not, we can remove this method, DnsClientFilterFactory, and RetryingDnsClientFilter.", "author": "idelpivnitskiy", "createdAt": "2020-05-29T00:04:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MDAyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MDE4OQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r431540189", "body": "As we are doing retries internally, we should provide a way to modify/disable these retries.", "bodyText": "As we are doing retries internally, we should provide a way to modify/disable these retries.", "bodyHTML": "<p dir=\"auto\">As we are doing retries internally, we should provide a way to modify/disable these retries.</p>", "author": "NiteshKant", "createdAt": "2020-05-28T01:59:09Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -219,6 +228,33 @@ private DefaultSingleAddressHttpClientBuilder(@Nullable final U address,\n                     proxyAddress != null ? proxyAddress : builder.address);\n         }\n \n+        Publisher<? extends ServiceDiscovererEvent<R>> discover(\n+                PublisherSource.Processor<Throwable, Throwable> processor) {\n+            assert builder.address != null : \"Attempted to buildStreaming with an unknown address\";\n+            return builder.serviceDiscoverer.discover(\n+                    proxyAddress != null ? proxyAddress : builder.address)\n+                    .retryWhen(retryWithConstantBackoffAndJitter(MAX_VALUE, t -> {", "originalCommit": "31a817e96ceaf799e1ecdc7448644b59df72442e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5MDc1MA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432190750", "bodyText": "How about starting without providing configurations for this and deferring this API until we have a request from users? I didn't find a good place for this config, not sure if a client builder or auto-retry strategy provider builder are good for this.\nIt looks ok to me to always retry java.net.UnknownHostException, because this is a well-known JDK exception and not-retrying it means that the discovery publisher will terminate. Therefore, the entire client becomes useless. This is a bit separate discussion, but maybe we need to close the client if SD terminates to clear resources.\nFor now, users can wrap SD to apply a different retry strategy or map java.net.UnknownHostException into something else if their intent is to terminate the discovery publisher.", "author": "idelpivnitskiy", "createdAt": "2020-05-29T00:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MDE4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1MTIzMQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432651231", "bodyText": "How about starting without providing configurations for this and deferring this API until we have a request from users?\n\nIf we are using some default strategy that depends on an externally provided implementation (service discoverer in this case), we should always assume there is a case which needs customization. As an example; what if the retry duration has to be changed?\n\nI didn't find a good place for this config, not sure if a client builder or auto-retry strategy provider builder are good for this.\n\nServiceDiscoverer retry is not really tied to auto-retry so both of them having some configuration around SD errors. How about adding the method retryServiceDiscoveryErrors(BiIntFunction<Throwable, ? extends Completable>)  on the client builder?", "author": "NiteshKant", "createdAt": "2020-05-29T18:04:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MDE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU0MTQ5MQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r431541491", "body": "Better not to use short-forms in method names => `ignoreServiceDiscovererErrors()`", "bodyText": "Better not to use short-forms in method names => ignoreServiceDiscovererErrors()", "bodyHTML": "<p dir=\"auto\">Better not to use short-forms in method names =&gt; <code>ignoreServiceDiscovererErrors()</code></p>", "author": "NiteshKant", "createdAt": "2020-05-28T02:04:08Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/DefaultAutoRetryStrategyProvider.java", "diffHunk": "@@ -70,6 +77,19 @@ public Builder disableWaitForLoadBalancer() {\n             return this;\n         }\n \n+        /**\n+         * By default, automatic retries waits for the associated {@link LoadBalancer} to be ready or\n+         * {@link ServiceDiscoverer} to emit an error before triggering a retry for requests. This method allows a retry\n+         * strategy to ignore errors from {@link ServiceDiscoverer} and wait for {@link LoadBalancer} forever.\n+         *\n+         * @return {@code this}.\n+         * @see #disableWaitForLoadBalancer()\n+         */\n+        public Builder ignoreSdErrors() {", "originalCommit": "31a817e96ceaf799e1ecdc7448644b59df72442e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3616ea8938ce07181c9bfc4979c3617ab81b204a", "url": "https://github.com/apple/servicetalk/commit/3616ea8938ce07181c9bfc4979c3617ab81b204a", "message": "Rename AutoRetryStrategyProvider#forClient -> newStrategy", "committedDate": "2020-05-29T00:16:03Z", "type": "commit"}, {"oid": "559076a455097ac15e8abbcb57038b7ed71d03e1", "url": "https://github.com/apple/servicetalk/commit/559076a455097ac15e8abbcb57038b7ed71d03e1", "message": "Rename ignoreSdErrors() -> ignoreServiceDiscovererErrors()", "committedDate": "2020-05-29T00:18:49Z", "type": "commit"}, {"oid": "0fda796eccad0a17f3c7ae5de824bb80731d2d97", "url": "https://github.com/apple/servicetalk/commit/0fda796eccad0a17f3c7ae5de824bb80731d2d97", "message": "Remove DefaultDnsServiceDiscovererBuilder#retryOnDnsFailures()", "committedDate": "2020-05-29T00:25:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0MTIzNQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432641235", "body": "Lets also get rid of \"using ...\" part as we have to update it for all arguments.", "bodyText": "Lets also get rid of \"using ...\" part as we have to update it for all arguments.", "bodyHTML": "<p dir=\"auto\">Lets also get rid of \"using ...\" part as we have to update it for all arguments.</p>", "author": "NiteshKant", "createdAt": "2020-05-29T17:44:10Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/AutoRetryStrategyProvider.java", "diffHunk": "@@ -36,13 +36,13 @@\n     AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = (lbEventStream, sdErrorStream) -> (___, cause) -> failed(cause);\n \n     /**\n-     * Create a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.\n+     * Creates a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.", "originalCommit": "0fda796eccad0a17f3c7ae5de824bb80731d2d97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0NTAzNA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432645034", "body": "I don't think we should bail out from here if SD has completed. LB should make that decision (via lb events) based on whether hosts are available before SD completed.", "bodyText": "I don't think we should bail out from here if SD has completed. LB should make that decision (via lb events) based on whether hosts are available before SD completed.", "bodyHTML": "<p dir=\"auto\">I don't think we should bail out from here if SD has completed. LB should make that decision (via lb events) based on whether hosts are available before SD completed.</p>", "author": "NiteshKant", "createdAt": "2020-05-29T17:51:40Z", "path": "servicetalk-client-api/src/test/java/io/servicetalk/client/api/DefaultAutoRetryStrategyProviderTest.java", "diffHunk": "@@ -119,6 +128,46 @@ public void defaultForNoAvailableHost() {\n         verifyRetryResultCompleted();\n     }\n \n+    @Test\n+    public void defaultForNoAvailableHostOnUnknownHostException() {\n+        AutoRetryStrategy strategy = newStrategy(identity());\n+        Completable retry = strategy.apply(1, NO_AVAILABLE_HOST);\n+        toSource(retry).subscribe(retrySubscriber);\n+        sdErrors.onNext(UNKNOWN_HOST_EXCEPTION);\n+        verifyRetryResultError(UNKNOWN_HOST_EXCEPTION);\n+    }\n+\n+    @Test\n+    public void defaultForNoAvailableHostOnServiceDiscovererError() {\n+        AutoRetryStrategy strategy = newStrategy(identity());\n+        Completable retry = strategy.apply(1, NO_AVAILABLE_HOST);\n+        toSource(retry).subscribe(retrySubscriber);\n+        sdErrors.onError(DELIBERATE_EXCEPTION);\n+        verifyRetryResultError(DELIBERATE_EXCEPTION);\n+    }\n+\n+    @Test\n+    public void ignoreSdErrorsForNoAvailableHost() {\n+        AutoRetryStrategy strategy = newStrategy(Builder::ignoreServiceDiscovererErrors);\n+        Completable retry = strategy.apply(1, NO_AVAILABLE_HOST);\n+        toSource(retry).subscribe(retrySubscriber);\n+        assertThat(\"Unexpected subscribe for SD errors.\", sdErrors.isSubscribed(), is(false));\n+        assertThat(\"Unexpected terminal.\", retrySubscriber.takeTerminal(), is(nullValue()));\n+        lbEvents.onNext(LOAD_BALANCER_READY_EVENT);\n+        verifyRetryResultCompleted();\n+    }\n+\n+    @Test\n+    public void defaultForNoAvailableHostWhenServiceDiscovererTerminated() {\n+        AutoRetryStrategy strategy = newStrategy(identity());\n+        sdErrors.onComplete();\n+        Completable retry = strategy.apply(1, NO_AVAILABLE_HOST);\n+        toSource(retry).subscribe(retrySubscriber);\n+        TerminalNotification terminal = retrySubscriber.takeTerminal();\n+        assertThat(\"Unexpected terminal.\", terminal, is(notNullValue()));\n+        assertThat(\"Unexpected terminal.\", terminal.cause(), is(instanceOf(IllegalStateException.class)));", "originalCommit": "0fda796eccad0a17f3c7ae5de824bb80731d2d97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU0MjYzNA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433542634", "bodyText": "Not for this PR, but for the potential follow-up:\nAgreed that if SD terminates we should rely on LB events to handle further retries. But it looks like we should return a Completable.failed(new IllegalStateException(\"LB events stream is terminated\")) here [1] instead of completed() if we still see NoAvailableHostException after termination. WDYT?\n[1] \n  \n    \n      servicetalk/servicetalk-client-api/src/main/java/io/servicetalk/client/api/LoadBalancerReadySubscriber.java\n    \n    \n         Line 47\n      in\n      5e83430\n    \n    \n    \n    \n\n        \n          \n           return onHostsAvailable == null ? completed() : fromSource(onHostsAvailable);", "author": "idelpivnitskiy", "createdAt": "2020-06-01T23:33:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0NTAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY0ODUwMg==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432648502", "body": "(Continuation of https://github.com/apple/servicetalk/pull/1070#discussion_r432187858 as I can't reply there)\r\n\r\n> If you think it's enough to wait only for the first error from SD and subsequent requests should fail fast, then I can switch to Completable.\r\n\r\nThats not what I meant. Even if you switch to `Completable`; it doesn't have to represent the first error. It can instead represent any error since start or after the previous `onNext` of SD publisher. You can implement such a `Completable` as:\r\n\r\n```java\r\n\r\nprivate static final class SDErrorsCompletable extends Completable {\r\n    private static final AtomicReferenceFieldUpdater<SDErrorsCompletable, CompletableSource.Processor>\r\n            currentProcessorUpdater = AtomicReferenceFieldUpdater.newUpdater(SDErrorsCompletable.class,\r\n            CompletableSource.Processor.class, \"currentProcessor\");\r\n\r\n    private volatile CompletableSource.Processor currentProcessor = newCompletableProcessor();\r\n\r\n    @Override\r\n    protected void handleSubscribe(final CompletableSource.Subscriber subscriber) {\r\n        currentProcessor.subscribe(subscriber);\r\n    }\r\n\r\n    void nextSuccess() {\r\n        CompletableSource.Processor newProcessor = newCompletableProcessor();\r\n        CompletableSource.Processor oldProcessor = currentProcessorUpdater.getAndSet(this, newProcessor);\r\n        oldProcessor.onComplete();\r\n    }\r\n\r\n    void nextError(final Throwable error) {\r\n        CompletableSource.Processor newProcessor = newCompletableProcessor();\r\n        CompletableSource.Processor oldProcessor = currentProcessorUpdater.getAndSet(this, newProcessor);\r\n        oldProcessor.onError(error);\r\n        newProcessor.onError(error);\r\n    }\r\n}\r\n```\r\n\r\nThe positive here is that the `AutoRetryStrategyProvider` implementaions can be simple (directly use the passed `Completable`) as opposed to managing stateful `Subscriber` as you do now.\r\n\r\nThis is different than load balancer as the `lbEventStream` may potentially contain other events apart from on-ready.", "bodyText": "(Continuation of #1070 (comment) as I can't reply there)\n\nIf you think it's enough to wait only for the first error from SD and subsequent requests should fail fast, then I can switch to Completable.\n\nThats not what I meant. Even if you switch to Completable; it doesn't have to represent the first error. It can instead represent any error since start or after the previous onNext of SD publisher. You can implement such a Completable as:\nprivate static final class SDErrorsCompletable extends Completable {\n    private static final AtomicReferenceFieldUpdater<SDErrorsCompletable, CompletableSource.Processor>\n            currentProcessorUpdater = AtomicReferenceFieldUpdater.newUpdater(SDErrorsCompletable.class,\n            CompletableSource.Processor.class, \"currentProcessor\");\n\n    private volatile CompletableSource.Processor currentProcessor = newCompletableProcessor();\n\n    @Override\n    protected void handleSubscribe(final CompletableSource.Subscriber subscriber) {\n        currentProcessor.subscribe(subscriber);\n    }\n\n    void nextSuccess() {\n        CompletableSource.Processor newProcessor = newCompletableProcessor();\n        CompletableSource.Processor oldProcessor = currentProcessorUpdater.getAndSet(this, newProcessor);\n        oldProcessor.onComplete();\n    }\n\n    void nextError(final Throwable error) {\n        CompletableSource.Processor newProcessor = newCompletableProcessor();\n        CompletableSource.Processor oldProcessor = currentProcessorUpdater.getAndSet(this, newProcessor);\n        oldProcessor.onError(error);\n        newProcessor.onError(error);\n    }\n}\nThe positive here is that the AutoRetryStrategyProvider implementaions can be simple (directly use the passed Completable) as opposed to managing stateful Subscriber as you do now.\nThis is different than load balancer as the lbEventStream may potentially contain other events apart from on-ready.", "bodyHTML": "<p dir=\"auto\">(Continuation of <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"625872892\" data-permission-text=\"Title is private\" data-url=\"https://github.com/apple/servicetalk/issues/1070\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/apple/servicetalk/pull/1070/hovercard?comment_id=432187858&amp;comment_type=review_comment\" href=\"https://github.com/apple/servicetalk/pull/1070#discussion_r432187858\">#1070 (comment)</a> as I can't reply there)</p>\n<blockquote>\n<p dir=\"auto\">If you think it's enough to wait only for the first error from SD and subsequent requests should fail fast, then I can switch to Completable.</p>\n</blockquote>\n<p dir=\"auto\">Thats not what I meant. Even if you switch to <code>Completable</code>; it doesn't have to represent the first error. It can instead represent any error since start or after the previous <code>onNext</code> of SD publisher. You can implement such a <code>Completable</code> as:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"\nprivate static final class SDErrorsCompletable extends Completable {\n    private static final AtomicReferenceFieldUpdater&lt;SDErrorsCompletable, CompletableSource.Processor&gt;\n            currentProcessorUpdater = AtomicReferenceFieldUpdater.newUpdater(SDErrorsCompletable.class,\n            CompletableSource.Processor.class, &quot;currentProcessor&quot;);\n\n    private volatile CompletableSource.Processor currentProcessor = newCompletableProcessor();\n\n    @Override\n    protected void handleSubscribe(final CompletableSource.Subscriber subscriber) {\n        currentProcessor.subscribe(subscriber);\n    }\n\n    void nextSuccess() {\n        CompletableSource.Processor newProcessor = newCompletableProcessor();\n        CompletableSource.Processor oldProcessor = currentProcessorUpdater.getAndSet(this, newProcessor);\n        oldProcessor.onComplete();\n    }\n\n    void nextError(final Throwable error) {\n        CompletableSource.Processor newProcessor = newCompletableProcessor();\n        CompletableSource.Processor oldProcessor = currentProcessorUpdater.getAndSet(this, newProcessor);\n        oldProcessor.onError(error);\n        newProcessor.onError(error);\n    }\n}\n\"><pre><span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">class</span> <span class=\"pl-en\">SDErrorsCompletable</span> <span class=\"pl-k\">extends</span> <span class=\"pl-e\">Completable</span> {\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-k\">AtomicReferenceFieldUpdater&lt;<span class=\"pl-smi\">SDErrorsCompletable</span>, <span class=\"pl-smi\">CompletableSource</span>.</span><span class=\"pl-smi\">Processor</span><span class=\"pl-k\">&gt;</span>\n            currentProcessorUpdater <span class=\"pl-k\">=</span> AtomicReferenceFieldUpdater.<span class=\"pl-en\">newUpdater</span>(<span class=\"pl-smi\">SDErrorsCompletable</span>.<span class=\"pl-v\">class</span>,\n            <span class=\"pl-smi\">CompletableSource</span>.<span class=\"pl-smi\">Processor</span>.<span class=\"pl-v\">class</span>, \"<span class=\"pl-v\">currentProcessor</span>\");\n\n    <span class=\"pl-k\">private</span> <span class=\"pl-k\">volatile</span> <span class=\"pl-smi\">CompletableSource</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Processor</span> currentProcessor <span class=\"pl-k\">=</span> newCompletableProcessor();\n\n    <span class=\"pl-k\">@Override</span>\n    <span class=\"pl-k\">protected</span> <span class=\"pl-k\">void</span> <span class=\"pl-en\">handleSubscribe</span>(<span class=\"pl-k\">final</span> <span class=\"pl-smi\">CompletableSource</span>.<span class=\"pl-smi\">Subscriber</span> <span class=\"pl-v\">subscriber</span>) {\n        currentProcessor<span class=\"pl-k\">.</span>subscribe(subscriber);\n    }\n\n    <span class=\"pl-k\">void</span> <span class=\"pl-en\">nextSuccess</span>() {\n        <span class=\"pl-smi\">CompletableSource</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Processor</span> newProcessor <span class=\"pl-k\">=</span> newCompletableProcessor();\n        <span class=\"pl-smi\">CompletableSource</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Processor</span> oldProcessor <span class=\"pl-k\">=</span> currentProcessorUpdater<span class=\"pl-k\">.</span>getAndSet(<span class=\"pl-c1\">this</span>, newProcessor);\n        oldProcessor<span class=\"pl-k\">.</span>onComplete();\n    }\n\n    <span class=\"pl-k\">void</span> <span class=\"pl-en\">nextError</span>(<span class=\"pl-k\">final</span> <span class=\"pl-smi\">Throwable</span> <span class=\"pl-v\">error</span>) {\n        <span class=\"pl-smi\">CompletableSource</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Processor</span> newProcessor <span class=\"pl-k\">=</span> newCompletableProcessor();\n        <span class=\"pl-smi\">CompletableSource</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Processor</span> oldProcessor <span class=\"pl-k\">=</span> currentProcessorUpdater<span class=\"pl-k\">.</span>getAndSet(<span class=\"pl-c1\">this</span>, newProcessor);\n        oldProcessor<span class=\"pl-k\">.</span>onError(error);\n        newProcessor<span class=\"pl-k\">.</span>onError(error);\n    }\n}</pre></div>\n<p dir=\"auto\">The positive here is that the <code>AutoRetryStrategyProvider</code> implementaions can be simple (directly use the passed <code>Completable</code>) as opposed to managing stateful <code>Subscriber</code> as you do now.</p>\n<p dir=\"auto\">This is different than load balancer as the <code>lbEventStream</code> may potentially contain other events apart from on-ready.</p>", "author": "NiteshKant", "createdAt": "2020-05-29T17:58:32Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/AutoRetryStrategyProvider.java", "diffHunk": "@@ -32,15 +33,16 @@\n     /**\n      * An {@link AutoRetryStrategyProvider} that disables automatic retries;\n      */\n-    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = __ -> (___, cause) -> failed(cause);\n+    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = (lbEventStream, sdErrorStream) -> (___, cause) -> failed(cause);\n \n     /**\n-     * Create a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.\n+     * Creates a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.\n      *\n-     * @param loadBalancer {@link LoadBalancer} to use.\n+     * @param lbEventStream a stream of events from {@link LoadBalancer#eventStream() LoadBalancer}\n+     * @param sdErrorStream a stream of errors from {@link ServiceDiscoverer#discover(Object) ServiceDiscoverer}\n      * @return New {@link AutoRetryStrategy} instance.\n      */\n-    AutoRetryStrategy forLoadbalancer(LoadBalancer<?> loadBalancer);\n+    AutoRetryStrategy newStrategy(Publisher<Object> lbEventStream, Publisher<Throwable> sdErrorStream);", "originalCommit": "0fda796eccad0a17f3c7ae5de824bb80731d2d97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1MTYzNQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432651635", "body": "Why not retry all SD errors by default?", "bodyText": "Why not retry all SD errors by default?", "bodyHTML": "<p dir=\"auto\">Why not retry all SD errors by default?</p>", "author": "NiteshKant", "createdAt": "2020-05-29T18:05:02Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -219,6 +228,33 @@ private DefaultSingleAddressHttpClientBuilder(@Nullable final U address,\n                     proxyAddress != null ? proxyAddress : builder.address);\n         }\n \n+        Publisher<? extends ServiceDiscovererEvent<R>> discover(\n+                PublisherSource.Processor<Throwable, Throwable> processor) {\n+            assert builder.address != null : \"Attempted to buildStreaming with an unknown address\";\n+            return builder.serviceDiscoverer.discover(\n+                    proxyAddress != null ? proxyAddress : builder.address)\n+                    .retryWhen(retryWithConstantBackoffAndJitter(MAX_VALUE, t -> {\n+                        processor.onNext(t);\n+                        return t instanceof UnknownHostException;", "originalCommit": "0fda796eccad0a17f3c7ae5de824bb80731d2d97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1NzEzNQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432657135", "bodyText": "Just to keep existing behavior as-is. But if we will have retryServiceDiscoveryErrors on the client builder +1 for retry all by default. Will update.", "author": "idelpivnitskiy", "createdAt": "2020-05-29T18:16:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1MTYzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY1MzAxMQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r432653011", "body": "As we do not use `RetryingDNSClientFilter` anymore, we can delete the class and remove references from the tests", "bodyText": "As we do not use RetryingDNSClientFilter anymore, we can delete the class and remove references from the tests", "bodyHTML": "<p dir=\"auto\">As we do not use <code>RetryingDNSClientFilter</code> anymore, we can delete the class and remove references from the tests</p>", "author": "NiteshKant", "createdAt": "2020-05-29T18:07:53Z", "path": "servicetalk-dns-discovery-netty/src/main/java/io/servicetalk/dns/discovery/netty/DefaultDnsServiceDiscovererBuilder.java", "diffHunk": "@@ -233,16 +221,11 @@ public DefaultDnsServiceDiscovererBuilder ioExecutor(final IoExecutor ioExecutor\n      * @return a new instance of {@link DnsClient}.\n      */\n     DnsClient build() {\n-        DnsClient rawClient = new DefaultDnsClient(\n+        final DnsClient rawClient = new DefaultDnsClient(\n                 ioExecutor == null ? globalExecutionContext().ioExecutor() : ioExecutor, minTTLSeconds, ndots,\n                 invalidateHostsOnDnsFailure, optResourceEnabled, queryTimeout, dnsResolverAddressTypes,\n                 dnsServerAddressStreamProvider);\n-        DnsClientFilterFactory rawFilterFactory = filterFactory;\n-        if (applyRetryFilter) {", "originalCommit": "0fda796eccad0a17f3c7ae5de824bb80731d2d97", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba9c1929e88c2fcede16312495fb3e9e8936d2f9", "url": "https://github.com/apple/servicetalk/commit/ba9c1929e88c2fcede16312495fb3e9e8936d2f9", "message": "Fail-fast for `invalid.` hostname to avoid increasing test timeout.", "committedDate": "2020-05-29T18:50:01Z", "type": "commit"}, {"oid": "168ff22e6294c9bf4e0b6620feec31d10f14d13e", "url": "https://github.com/apple/servicetalk/commit/168ff22e6294c9bf4e0b6620feec31d10f14d13e", "message": "Allow configuring retry strategy for SD errors", "committedDate": "2020-06-01T19:02:32Z", "type": "commit"}, {"oid": "896f5b5d443a1a95a430061dab2067e658e3317a", "url": "https://github.com/apple/servicetalk/commit/896f5b5d443a1a95a430061dab2067e658e3317a", "message": "Fix MultiAddressUrlHttpClientTest", "committedDate": "2020-06-01T19:02:52Z", "type": "commit"}, {"oid": "a0a063ec60d11a8c5209e00a3aae5d7445c31949", "url": "https://github.com/apple/servicetalk/commit/a0a063ec60d11a8c5209e00a3aae5d7445c31949", "message": "Remove RetryingDnsClientFilter", "committedDate": "2020-06-01T21:14:52Z", "type": "commit"}, {"oid": "1eae53f8e8296270d5edac72e753e8f54f037c11", "url": "https://github.com/apple/servicetalk/commit/1eae53f8e8296270d5edac72e753e8f54f037c11", "message": "Use Completable for SD status instead of Publisher", "committedDate": "2020-06-01T23:15:24Z", "type": "commit"}, {"oid": "f93ac7096da2f4274a54483fb87865b4c6433886", "url": "https://github.com/apple/servicetalk/commit/f93ac7096da2f4274a54483fb87865b4c6433886", "message": "Verifu SdStatusCompletable resubscribe works", "committedDate": "2020-06-01T23:16:00Z", "type": "commit"}, {"oid": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "url": "https://github.com/apple/servicetalk/commit/e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "message": "minor fixes", "committedDate": "2020-06-01T23:27:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1MzM4NQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433553385", "body": "As we do not expect SD streams to complete, can we not mention the completion contract here?\n\nIf we complete the `Completable` when SD completes, any request waiting may prematurely be retried before LB being ready.", "bodyText": "As we do not expect SD streams to complete, can we not mention the completion contract here?\nIf we complete the Completable when SD completes, any request waiting may prematurely be retried before LB being ready.", "bodyHTML": "<p dir=\"auto\">As we do not expect SD streams to complete, can we not mention the completion contract here?</p>\n<p dir=\"auto\">If we complete the <code>Completable</code> when SD completes, any request waiting may prematurely be retried before LB being ready.</p>", "author": "NiteshKant", "createdAt": "2020-06-02T00:12:47Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/AutoRetryStrategyProvider.java", "diffHunk": "@@ -32,15 +33,18 @@\n     /**\n      * An {@link AutoRetryStrategyProvider} that disables automatic retries;\n      */\n-    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = __ -> (___, cause) -> failed(cause);\n+    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = (lbEventStream, sdErrorStream) -> (___, cause) -> failed(cause);\n \n     /**\n-     * Create a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.\n+     * Creates a new {@link AutoRetryStrategy} instance.\n      *\n-     * @param loadBalancer {@link LoadBalancer} to use.\n+     * @param lbEventStream a stream of events from {@link LoadBalancer#eventStream() LoadBalancer}\n+     * @param sdStatus a {@link Completable} that reports current {@link ServiceDiscoverer} status. It fails when\n+     * {@link ServiceDiscoverer#discover(Object) discovery publisher} emits an error or completes when the publisher", "originalCommit": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1NTg0OA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433555848", "body": "It would be useful to not cross-reference methods here as it is correct but more complex to understand. \n\nSimply, you can say that auto-retry strategies fail a request if the last signal from the associated `ServiceDiscoverer` was an error. This method disables that behavior.\n", "bodyText": "It would be useful to not cross-reference methods here as it is correct but more complex to understand.\nSimply, you can say that auto-retry strategies fail a request if the last signal from the associated ServiceDiscoverer was an error. This method disables that behavior.", "bodyHTML": "<p dir=\"auto\">It would be useful to not cross-reference methods here as it is correct but more complex to understand.</p>\n<p dir=\"auto\">Simply, you can say that auto-retry strategies fail a request if the last signal from the associated <code>ServiceDiscoverer</code> was an error. This method disables that behavior.</p>", "author": "NiteshKant", "createdAt": "2020-06-02T00:22:10Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/DefaultAutoRetryStrategyProvider.java", "diffHunk": "@@ -70,6 +76,19 @@ public Builder disableWaitForLoadBalancer() {\n             return this;\n         }\n \n+        /**\n+         * By default, automatic retries wait for the associated {@link LoadBalancer} to be ready or", "originalCommit": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1Njg2Mw==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433556863", "body": "`for errors ...` => `to retry errors`\n\n`discovery publisher` => `service discoverer`?", "bodyText": "for errors ... => to retry errors\ndiscovery publisher => service discoverer?", "bodyHTML": "<p dir=\"auto\"><code>for errors ...</code> =&gt; <code>to retry errors</code></p>\n<p dir=\"auto\"><code>discovery publisher</code> =&gt; <code>service discoverer</code>?</p>", "author": "NiteshKant", "createdAt": "2020-06-02T00:25:33Z", "path": "servicetalk-http-api/src/main/java/io/servicetalk/http/api/HttpClientBuilder.java", "diffHunk": "@@ -181,6 +184,16 @@\n     public abstract HttpClientBuilder<U, R, SDE> serviceDiscoverer(\n             ServiceDiscoverer<U, R, ? extends SDE> serviceDiscoverer);\n \n+    /**\n+     * Sets a retry strategy for errors emitted by {@link ServiceDiscoverer#discover(Object) discovery publisher}.", "originalCommit": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1ODMzNw==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433558337", "body": "Do we need the complete `Processor` contract here? \n\nIf we are just using `onComplet()` and `onError()` then not using the `Processor` contract helps remove the extra `subscribe()` method and delegation to `subscribeInternal()`", "bodyText": "Do we need the complete Processor contract here?\nIf we are just using onComplet() and onError() then not using the Processor contract helps remove the extra subscribe() method and delegation to subscribeInternal()", "bodyHTML": "<p dir=\"auto\">Do we need the complete <code>Processor</code> contract here?</p>\n<p dir=\"auto\">If we are just using <code>onComplet()</code> and <code>onError()</code> then not using the <code>Processor</code> contract helps remove the extra <code>subscribe()</code> method and delegation to <code>subscribeInternal()</code></p>", "author": "NiteshKant", "createdAt": "2020-06-02T00:31:27Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -552,4 +602,52 @@ public Completable closeAsyncGracefully() {\n             return closeable.closeAsyncGracefully();\n         }\n     }\n+\n+    private static final class SdStatusCompletable extends Completable implements CompletableSource.Processor {", "originalCommit": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1OTk5MA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433559990", "body": "This approach is incorrect as it misses errors when `nextError()` happens first and then never happens again.\n\nInstead what you need is to always have a `Processor` which queues the error till a subscriber arrives.\n\nOnce the error is queued, it needs a callback to clear the queued error once a successful event happens on the SD ", "bodyText": "This approach is incorrect as it misses errors when nextError() happens first and then never happens again.\nInstead what you need is to always have a Processor which queues the error till a subscriber arrives.\nOnce the error is queued, it needs a callback to clear the queued error once a successful event happens on the SD", "bodyHTML": "<p dir=\"auto\">This approach is incorrect as it misses errors when <code>nextError()</code> happens first and then never happens again.</p>\n<p dir=\"auto\">Instead what you need is to always have a <code>Processor</code> which queues the error till a subscriber arrives.</p>\n<p dir=\"auto\">Once the error is queued, it needs a callback to clear the queued error once a successful event happens on the SD</p>", "author": "NiteshKant", "createdAt": "2020-06-02T00:38:06Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -552,4 +602,52 @@ public Completable closeAsyncGracefully() {\n             return closeable.closeAsyncGracefully();\n         }\n     }\n+\n+    private static final class SdStatusCompletable extends Completable implements CompletableSource.Processor {\n+        private static final AtomicReferenceFieldUpdater<SdStatusCompletable, CompletableSource.Processor>\n+                currentProcessorUpdater = AtomicReferenceFieldUpdater.newUpdater(SdStatusCompletable.class,\n+                CompletableSource.Processor.class, \"currentProcessor\");\n+        @Nullable\n+        private volatile CompletableSource.Processor currentProcessor;\n+\n+        @Override\n+        protected void handleSubscribe(final CompletableSource.Subscriber subscriber) {\n+            final CompletableSource.Processor currentProcessor = currentProcessorUpdater.updateAndGet(this,", "originalCommit": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU2MDgzMA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433560830", "body": "As mentioned in the `AutoRetryStrategy` comment, we should not send an `onComplete()` here as it may prematurely retry a request. Instead let the LB decide when to retry if SD completes.\n", "bodyText": "As mentioned in the AutoRetryStrategy comment, we should not send an onComplete() here as it may prematurely retry a request. Instead let the LB decide when to retry if SD completes.", "bodyHTML": "<p dir=\"auto\">As mentioned in the <code>AutoRetryStrategy</code> comment, we should not send an <code>onComplete()</code> here as it may prematurely retry a request. Instead let the LB decide when to retry if SD completes.</p>", "author": "NiteshKant", "createdAt": "2020-06-02T00:41:34Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -219,6 +234,32 @@ private DefaultSingleAddressHttpClientBuilder(@Nullable final U address,\n                     proxyAddress != null ? proxyAddress : builder.address);\n         }\n \n+        Publisher<? extends ServiceDiscovererEvent<R>> discover(final SdStatusCompletable sdStatus) {\n+            assert builder.address != null : \"Attempted to buildStreaming with an unknown address\";\n+            final BiIntFunction<Throwable, ? extends Completable> retryWhen = builder.serviceDiscovererRetryStrategy;\n+            return builder.serviceDiscoverer.discover(proxyAddress != null ? proxyAddress : builder.address)\n+                    .retryWhen((i, t) -> {\n+                        sdStatus.nextError(t);\n+                        return retryWhen.apply(i, t);\n+                    })\n+                    .whenFinally(new TerminalSignalConsumer() {\n+                        @Override\n+                        public void onComplete() {\n+                            sdStatus.onComplete();", "originalCommit": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "url": "https://github.com/apple/servicetalk/commit/0ef351e3758cfb2ad0eab9a63b54190ecf474256", "message": "Address comments", "committedDate": "2020-06-02T07:17:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA1MTk1OA==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434051958", "body": "nit: you shouldn't need a `defer()` here.", "bodyText": "nit: you shouldn't need a defer() here.", "bodyHTML": "<p dir=\"auto\">nit: you shouldn't need a <code>defer()</code> here.</p>", "author": "NiteshKant", "createdAt": "2020-06-02T17:32:57Z", "path": "servicetalk-http-netty/src/test/java/io/servicetalk/http/netty/MultiAddressUrlHttpClientTest.java", "diffHunk": "@@ -132,6 +143,32 @@ public static void afterClass() throws Exception {\n         afterClassCloseables.close();\n     }\n \n+    private static ServiceDiscoverer<HostAndPort, InetSocketAddress, ServiceDiscovererEvent<InetSocketAddress>>\n+    sdThatSupportsInvalidHostname() {\n+        return new ServiceDiscoverer<HostAndPort, InetSocketAddress, ServiceDiscovererEvent<InetSocketAddress>>() {\n+            @Override\n+            public Publisher<ServiceDiscovererEvent<InetSocketAddress>> discover(final HostAndPort hostAndPort) {\n+                return defer(() -> {", "originalCommit": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA3MTA4MQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434071081", "body": "nit: inline `oldProcessor` \r\n```suggestion\r\n            processorUpdater.getAndSet(this, newProcessor).onError(t);\r\n```", "bodyText": "nit: inline oldProcessor\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        final CompletableSource.Processor oldProcessor = processorUpdater.getAndSet(this, newProcessor);\n          \n          \n            \n                        oldProcessor.onError(t);\n          \n          \n            \n                        processorUpdater.getAndSet(this, newProcessor).onError(t);", "bodyHTML": "<p dir=\"auto\">nit: inline <code>oldProcessor</code></p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">final</span> <span class=\"pl-smi\">CompletableSource</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">Processor</span> oldProcessor <span class=\"pl-k\">=</span> processorUpdater<span class=\"pl-k\">.</span>getAndSet(<span class=\"pl-c1\">this</span>, newProcessor);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            oldProcessor<span class=\"pl-k\">.</span>onError(t);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            processorUpdater<span class=\"pl-k\">.</span>getAndSet(<span class=\"pl-c1\">this</span>, newProcessor)<span class=\"pl-k\">.</span>onError(t);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "NiteshKant", "createdAt": "2020-06-02T18:03:06Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -552,4 +587,32 @@ public Completable closeAsyncGracefully() {\n             return closeable.closeAsyncGracefully();\n         }\n     }\n+\n+    private static final class SdStatusCompletable extends Completable {\n+        private static final AtomicReferenceFieldUpdater<SdStatusCompletable, CompletableSource.Processor>\n+                processorUpdater = newUpdater(SdStatusCompletable.class, CompletableSource.Processor.class,\n+                \"processor\");\n+        private volatile CompletableSource.Processor processor = newCompletableProcessor();\n+        private boolean seenError;\n+\n+        @Override\n+        protected void handleSubscribe(final Subscriber subscriber) {\n+            processor.subscribe(subscriber);\n+        }\n+\n+        void nextError(final Throwable t) {\n+            final CompletableSource.Processor newProcessor = newCompletableProcessor();\n+            newProcessor.onError(t);\n+            final CompletableSource.Processor oldProcessor = processorUpdater.getAndSet(this, newProcessor);\n+            oldProcessor.onError(t);", "originalCommit": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA3OTAyMQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434079021", "body": "set this state before setting errors on the processors for weird re-entrancy back to `resetError()`", "bodyText": "set this state before setting errors on the processors for weird re-entrancy back to resetError()", "bodyHTML": "<p dir=\"auto\">set this state before setting errors on the processors for weird re-entrancy back to <code>resetError()</code></p>", "author": "NiteshKant", "createdAt": "2020-06-02T18:12:18Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -552,4 +587,32 @@ public Completable closeAsyncGracefully() {\n             return closeable.closeAsyncGracefully();\n         }\n     }\n+\n+    private static final class SdStatusCompletable extends Completable {\n+        private static final AtomicReferenceFieldUpdater<SdStatusCompletable, CompletableSource.Processor>\n+                processorUpdater = newUpdater(SdStatusCompletable.class, CompletableSource.Processor.class,\n+                \"processor\");\n+        private volatile CompletableSource.Processor processor = newCompletableProcessor();\n+        private boolean seenError;\n+\n+        @Override\n+        protected void handleSubscribe(final Subscriber subscriber) {\n+            processor.subscribe(subscriber);\n+        }\n+\n+        void nextError(final Throwable t) {\n+            final CompletableSource.Processor newProcessor = newCompletableProcessor();\n+            newProcessor.onError(t);\n+            final CompletableSource.Processor oldProcessor = processorUpdater.getAndSet(this, newProcessor);\n+            oldProcessor.onError(t);\n+            seenError = true;", "originalCommit": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA5NzY3Nw==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434097677", "body": "As the updates to `processor ` (`nextError` and `resetError`) aren't concurrent, we do not need an atomic updater. ", "bodyText": "As the updates to processor  (nextError and resetError) aren't concurrent, we do not need an atomic updater.", "bodyHTML": "<p dir=\"auto\">As the updates to <code>processor </code> (<code>nextError</code> and <code>resetError</code>) aren't concurrent, we do not need an atomic updater.</p>", "author": "NiteshKant", "createdAt": "2020-06-02T18:38:01Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -552,4 +587,32 @@ public Completable closeAsyncGracefully() {\n             return closeable.closeAsyncGracefully();\n         }\n     }\n+\n+    private static final class SdStatusCompletable extends Completable {\n+        private static final AtomicReferenceFieldUpdater<SdStatusCompletable, CompletableSource.Processor>", "originalCommit": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA5ODMwOQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434098309", "body": "Since this field isn't `volatile`, just add a comment that this is only accessed from `nextError` and `resetError` which are not concurrent.", "bodyText": "Since this field isn't volatile, just add a comment that this is only accessed from nextError and resetError which are not concurrent.", "bodyHTML": "<p dir=\"auto\">Since this field isn't <code>volatile</code>, just add a comment that this is only accessed from <code>nextError</code> and <code>resetError</code> which are not concurrent.</p>", "author": "NiteshKant", "createdAt": "2020-06-02T18:39:11Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -552,4 +587,32 @@ public Completable closeAsyncGracefully() {\n             return closeable.closeAsyncGracefully();\n         }\n     }\n+\n+    private static final class SdStatusCompletable extends Completable {\n+        private static final AtomicReferenceFieldUpdater<SdStatusCompletable, CompletableSource.Processor>\n+                processorUpdater = newUpdater(SdStatusCompletable.class, CompletableSource.Processor.class,\n+                \"processor\");\n+        private volatile CompletableSource.Processor processor = newCompletableProcessor();\n+        private boolean seenError;", "originalCommit": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU1OTI5Nw==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r433559297", "body": "nit: you can kill this temp variable now that we don't have to conditionally apply a filter ", "bodyText": "nit: you can kill this temp variable now that we don't have to conditionally apply a filter", "bodyHTML": "<p dir=\"auto\">nit: you can kill this temp variable now that we don't have to conditionally apply a filter</p>", "author": "Scottmitch", "createdAt": "2020-06-02T00:35:23Z", "path": "servicetalk-dns-discovery-netty/src/main/java/io/servicetalk/dns/discovery/netty/DefaultDnsServiceDiscovererBuilder.java", "diffHunk": "@@ -233,16 +221,11 @@ public DefaultDnsServiceDiscovererBuilder ioExecutor(final IoExecutor ioExecutor\n      * @return a new instance of {@link DnsClient}.\n      */\n     DnsClient build() {\n-        DnsClient rawClient = new DefaultDnsClient(\n+        final DnsClient rawClient = new DefaultDnsClient(\n                 ioExecutor == null ? globalExecutionContext().ioExecutor() : ioExecutor, minTTLSeconds, ndots,\n                 invalidateHostsOnDnsFailure, optResourceEnabled, queryTimeout, dnsResolverAddressTypes,\n                 dnsServerAddressStreamProvider);\n-        DnsClientFilterFactory rawFilterFactory = filterFactory;\n-        if (applyRetryFilter) {\n-            DnsClientFilterFactory retryFilterFactory = new RetryingDnsClientFilter();\n-            rawFilterFactory = rawFilterFactory == null ? retryFilterFactory :\n-                    retryFilterFactory.append(rawFilterFactory);\n-        }\n+        final DnsClientFilterFactory rawFilterFactory = filterFactory;", "originalCommit": "e0541cd7581b75ba99f4ecb9f1be4a6455d2c1cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MDc5Nw==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434170797", "body": "what is the intention of creating the `newProcessor` (that is failed) and swapping with the old processor (which is also failed)?", "bodyText": "what is the intention of creating the newProcessor (that is failed) and swapping with the old processor (which is also failed)?", "bodyHTML": "<p dir=\"auto\">what is the intention of creating the <code>newProcessor</code> (that is failed) and swapping with the old processor (which is also failed)?</p>", "author": "Scottmitch", "createdAt": "2020-06-02T20:56:41Z", "path": "servicetalk-http-netty/src/main/java/io/servicetalk/http/netty/DefaultSingleAddressHttpClientBuilder.java", "diffHunk": "@@ -552,4 +587,32 @@ public Completable closeAsyncGracefully() {\n             return closeable.closeAsyncGracefully();\n         }\n     }\n+\n+    private static final class SdStatusCompletable extends Completable {\n+        private static final AtomicReferenceFieldUpdater<SdStatusCompletable, CompletableSource.Processor>\n+                processorUpdater = newUpdater(SdStatusCompletable.class, CompletableSource.Processor.class,\n+                \"processor\");\n+        private volatile CompletableSource.Processor processor = newCompletableProcessor();\n+        private boolean seenError;\n+\n+        @Override\n+        protected void handleSubscribe(final Subscriber subscriber) {\n+            processor.subscribe(subscriber);\n+        }\n+\n+        void nextError(final Throwable t) {\n+            final CompletableSource.Processor newProcessor = newCompletableProcessor();\n+            newProcessor.onError(t);", "originalCommit": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIyODUwMw==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434228503", "bodyText": "Because we expect any Throwable here, we use it as a way to update the state and always deliver the latest observed t to subscribers.\nThis is not on the hot path, therefore it's ok to use this approach vs duplicating support for multiple subscribers from CompletableProcessor.", "author": "idelpivnitskiy", "createdAt": "2020-06-02T23:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE3MDc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5MjM1Mw==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434192353", "body": "this isn't expected to complete IIUC and instead provides notification when the publisher for `discover` encounters an error. Consider clarifying the java docs on this statement:\r\n\r\n> @param sdStatus a {@link Completable} that will terminate with an error when the corresponding\r\n{@link ServiceDiscoverer#discover(Object)} terminates with an error.", "bodyText": "this isn't expected to complete IIUC and instead provides notification when the publisher for discover encounters an error. Consider clarifying the java docs on this statement:\n\n@param sdStatus a {@link Completable} that will terminate with an error when the corresponding\n{@link ServiceDiscoverer#discover(Object)} terminates with an error.", "bodyHTML": "<p dir=\"auto\">this isn't expected to complete IIUC and instead provides notification when the publisher for <code>discover</code> encounters an error. Consider clarifying the java docs on this statement:</p>\n<blockquote>\n<p dir=\"auto\"><a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/param/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/param\">@param</a> sdStatus a {<a class=\"user-mention\" data-hovercard-type=\"organization\" data-hovercard-url=\"/orgs/link/hovercard\" href=\"https://github.com/link\">@link</a> Completable} that will terminate with an error when the corresponding<br>\n{<a class=\"user-mention\" data-hovercard-type=\"organization\" data-hovercard-url=\"/orgs/link/hovercard\" href=\"https://github.com/link\">@link</a> ServiceDiscoverer#discover(Object)} terminates with an error.</p>\n</blockquote>", "author": "Scottmitch", "createdAt": "2020-06-02T21:43:06Z", "path": "servicetalk-client-api/src/main/java/io/servicetalk/client/api/AutoRetryStrategyProvider.java", "diffHunk": "@@ -32,15 +33,16 @@\n     /**\n      * An {@link AutoRetryStrategyProvider} that disables automatic retries;\n      */\n-    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = __ -> (___, cause) -> failed(cause);\n+    AutoRetryStrategyProvider DISABLE_AUTO_RETRIES = (lbEventStream, sdErrorStream) -> (___, cause) -> failed(cause);\n \n     /**\n-     * Create a new {@link AutoRetryStrategy} instance using the passed {@link LoadBalancer}.\n+     * Creates a new {@link AutoRetryStrategy} instance.\n      *\n-     * @param loadBalancer {@link LoadBalancer} to use.\n+     * @param lbEventStream a stream of events from {@link LoadBalancer#eventStream() LoadBalancer}\n+     * @param sdStatus a {@link Completable} that reports {@link ServiceDiscoverer} status", "originalCommit": "0ef351e3758cfb2ad0eab9a63b54190ecf474256", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5NTcwOQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434195709", "bodyText": "this also seems somewhat opinionated to our current approach for the client.api package. For example what if there are multiple LBs/SDs internally in the builder then this AutoRetryStrategyProvider may not be applicable. Does it makes sense to move this to http.netty for now?", "author": "Scottmitch", "createdAt": "2020-06-02T21:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5MjM1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMTMxMQ==", "url": "https://github.com/apple/servicetalk/pull/1070#discussion_r434231311", "bodyText": "Good question,\nLet's discuss this offline and consider as a follow-up if necessary.\nAutoRetryStrategyProvider is currently used in http-api and grpc-api. Not easy to move it to http-netty.", "author": "idelpivnitskiy", "createdAt": "2020-06-02T23:36:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDE5MjM1Mw=="}], "type": "inlineReview"}, {"oid": "c0e64c2146973ab1f7bc682b9e2823ee230e95d4", "url": "https://github.com/apple/servicetalk/commit/c0e64c2146973ab1f7bc682b9e2823ee230e95d4", "message": "Address comments", "committedDate": "2020-06-02T23:32:27Z", "type": "commit"}, {"oid": "35b920446f8815ce98fa8e141b54263da3188675", "url": "https://github.com/apple/servicetalk/commit/35b920446f8815ce98fa8e141b54263da3188675", "message": "Add `@FunctionalInterface` annotation for `AutoRetryStrategyProvider`", "committedDate": "2020-06-02T23:34:04Z", "type": "commit"}]}