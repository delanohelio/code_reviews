{"pr_number": 5995, "pr_title": "Fix potential gRPC connection leak(not closed) for the channels among OAP instances. ", "pr_author": "wu-sheng", "pr_createdAt": "2020-12-12T01:51:28Z", "pr_url": "https://github.com/apache/skywalking/pull/5995", "timeline": [{"oid": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "url": "https://github.com/apache/skywalking/commit/c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "message": "Fix potential gRPC connection leak(not closed) for the channels among OAP instances.", "committedDate": "2020-12-12T01:47:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NzU1Mw==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541477553", "body": "```suggestion\r\n                                              && \r\nremoteClientAction.getRemoteClient() != null\r\n                                              &&                                           !remoteClientAction.getRemoteClient().getAddress().isSelf()\r\n```\r\n", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                          && !remoteClientAction.getRemoteClient().getAddress().isSelf()\n          \n          \n            \n                                                          && \n          \n          \n            \n            remoteClientAction.getRemoteClient() != null\n          \n          \n            \n                                                          &&                                           !remoteClientAction.getRemoteClient().getAddress().isSelf()", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"251\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                                              <span class=\"pl-k\">&amp;&amp;</span> <span class=\"pl-k x x-first\">!</span><span class=\"x\">remoteClientAction</span><span class=\"pl-k x\">.</span><span class=\"x\">getRemoteClient()</span><span class=\"pl-k x\">.</span><span class=\"x\">getAddress()</span><span class=\"pl-k x\">.</span><span class=\"x x-last\">isSelf()</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"251\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                                              <span class=\"pl-k\">&amp;&amp;</span> </td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"252\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">remoteClientAction<span class=\"pl-k\">.</span>getRemoteClient() <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"253\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                                              <span class=\"pl-k\">&amp;&amp;</span>                                           <span class=\"pl-k\">!</span>remoteClientAction<span class=\"pl-k\">.</span>getRemoteClient()<span class=\"pl-k\">.</span>getAddress()<span class=\"pl-k\">.</span>isSelf()</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "hanahmily", "createdAt": "2020-12-12T02:16:00Z", "path": "oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/remote/client/RemoteClientManager.java", "diffHunk": "@@ -230,7 +246,10 @@ private void reBuildRemoteClients(List<RemoteInstance> remoteInstances) {\n \n         remoteClientCollection.values()\n                               .stream()\n-                              .filter(remoteClientAction -> remoteClientAction.getAction().equals(Action.Close))\n+                              .filter(remoteClientAction ->\n+                                          remoteClientAction.getAction().equals(Action.Close)\n+                                              && !remoteClientAction.getRemoteClient().getAddress().isSelf()", "originalCommit": "c707e4a4cabb11bb022ea7f4dedff31ec61cc8ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4MDk0OA==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541480948", "bodyText": "This would not be null. I enhanced another by following Filter OAP instances(unassigned in booting stage) of the empty IP in KubernetesCoordinator.", "author": "wu-sheng", "createdAt": "2020-12-12T02:36:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ3NzU1Mw=="}], "type": "inlineReview"}, {"oid": "34870014eb3facb09954da00490b1ff3291867d7", "url": "https://github.com/apache/skywalking/commit/34870014eb3facb09954da00490b1ff3291867d7", "message": "Filter OAP instances(unassigned in booting stage) of the empty IP in KubernetesCoordinator.", "committedDate": "2020-12-12T02:36:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4ODg0NQ==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541488845", "body": "*NULL_DEREFERENCE:*  object returned by `pod.getStatus()` could be null and is dereferenced at line 78.", "bodyText": "NULL_DEREFERENCE:  object returned by pod.getStatus() could be null and is dereferenced at line 78.", "bodyHTML": "<p dir=\"auto\"><em>NULL_DEREFERENCE:</em>  object returned by <code>pod.getStatus()</code> could be null and is dereferenced at line 78.</p>", "author": "sonatype-lift", "createdAt": "2020-12-12T03:26:12Z", "path": "oap-server/server-cluster-plugin/cluster-kubernetes-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/kubernetes/KubernetesCoordinator.java", "diffHunk": "@@ -66,23 +65,25 @@ public KubernetesCoordinator(final ModuleDefineHolder manager,\n             List<V1Pod> pods = NamespacedPodListInformer.INFORMER.listPods().orElseGet(this::selfPod);\n             if (log.isDebugEnabled()) {\n                 List<String> uidList = pods\n-                        .stream()\n-                        .map(item -> item.getMetadata().getUid())\n-                        .collect(Collectors.toList());\n+                    .stream()\n+                    .map(item -> item.getMetadata().getUid())\n+                    .collect(Collectors.toList());\n                 log.debug(\"[kubernetes cluster pods uid list]:{}\", uidList.toString());\n             }\n             if (port == -1) {\n                 port = manager.find(CoreModule.NAME).provider().getService(ConfigService.class).getGRPCPort();\n             }\n-            List<RemoteInstance> remoteInstances =  pods.stream()\n+            List<RemoteInstance> remoteInstances =\n+                pods.stream()\n+                    .filter(pod -> StringUtil.isNotBlank(pod.getStatus().getPodIP()))", "originalCommit": "34870014eb3facb09954da00490b1ff3291867d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ4ODg0OA==", "url": "https://github.com/apache/skywalking/pull/5995#discussion_r541488848", "body": "*NULL_DEREFERENCE:*  object returned by `pod.getStatus()` could be null and is dereferenced at line 80.", "bodyText": "NULL_DEREFERENCE:  object returned by pod.getStatus() could be null and is dereferenced at line 80.", "bodyHTML": "<p dir=\"auto\"><em>NULL_DEREFERENCE:</em>  object returned by <code>pod.getStatus()</code> could be null and is dereferenced at line 80.</p>", "author": "sonatype-lift", "createdAt": "2020-12-12T03:26:13Z", "path": "oap-server/server-cluster-plugin/cluster-kubernetes-plugin/src/main/java/org/apache/skywalking/oap/server/cluster/plugin/kubernetes/KubernetesCoordinator.java", "diffHunk": "@@ -66,23 +65,25 @@ public KubernetesCoordinator(final ModuleDefineHolder manager,\n             List<V1Pod> pods = NamespacedPodListInformer.INFORMER.listPods().orElseGet(this::selfPod);\n             if (log.isDebugEnabled()) {\n                 List<String> uidList = pods\n-                        .stream()\n-                        .map(item -> item.getMetadata().getUid())\n-                        .collect(Collectors.toList());\n+                    .stream()\n+                    .map(item -> item.getMetadata().getUid())\n+                    .collect(Collectors.toList());\n                 log.debug(\"[kubernetes cluster pods uid list]:{}\", uidList.toString());\n             }\n             if (port == -1) {\n                 port = manager.find(CoreModule.NAME).provider().getService(ConfigService.class).getGRPCPort();\n             }\n-            List<RemoteInstance> remoteInstances =  pods.stream()\n+            List<RemoteInstance> remoteInstances =\n+                pods.stream()\n+                    .filter(pod -> StringUtil.isNotBlank(pod.getStatus().getPodIP()))\n                     .map(pod -> new RemoteInstance(\n-                            new Address(pod.getStatus().getPodIP(), port, pod.getMetadata().getUid().equals(uid))))\n+                        new Address(pod.getStatus().getPodIP(), port, pod.getMetadata().getUid().equals(uid))))", "originalCommit": "34870014eb3facb09954da00490b1ff3291867d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}