{"pr_number": 3967, "pr_title": "refactor(android): represent permission states using enum", "pr_createdAt": "2020-12-18T16:49:44Z", "pr_url": "https://github.com/ionic-team/capacitor/pull/3967", "merge_commit": "67a0eba10a13e1a6354c372059323d5857da2e24", "timeline": [{"oid": "494dbaa1b172ebcfad1e0f337e772f85533a20b0", "url": "https://github.com/ionic-team/capacitor/commit/494dbaa1b172ebcfad1e0f337e772f85533a20b0", "message": "removing requestCode, permissions, grantResults from onRequestPermissionsResult and providing states", "committedDate": "2020-12-17T20:19:28Z", "type": "commit"}, {"oid": "8fb263422d9e014d52c06dc16eaf5b17a945e4c9", "url": "https://github.com/ionic-team/capacitor/commit/8fb263422d9e014d52c06dc16eaf5b17a945e4c9", "message": "saving work so far", "committedDate": "2020-12-17T22:39:48Z", "type": "commit"}, {"oid": "d2b78912c96a9a1526d77a6ff81ef68e0c147713", "url": "https://github.com/ionic-team/capacitor/commit/d2b78912c96a9a1526d77a6ff81ef68e0c147713", "message": "Replace internal use of JSObject with Map", "committedDate": "2020-12-17T23:00:49Z", "type": "commit"}, {"oid": "da44f4453eb43d28870603630b7fe9db1b2e4566", "url": "https://github.com/ionic-team/capacitor/commit/da44f4453eb43d28870603630b7fe9db1b2e4566", "message": "Merge branch 'perm-states-type' into perm-result", "committedDate": "2020-12-17T23:12:14Z", "type": "commit"}, {"oid": "17d6ed5e74d26f9d19d67ac938822a9ba2d448da", "url": "https://github.com/ionic-team/capacitor/commit/17d6ed5e74d26f9d19d67ac938822a9ba2d448da", "message": "new PermissionState enum to represent the permission states possible", "committedDate": "2020-12-17T23:46:18Z", "type": "commit"}, {"oid": "2af06a2add0537f8615240fb05eb1fc78eb9f950", "url": "https://github.com/ionic-team/capacitor/commit/2af06a2add0537f8615240fb05eb1fc78eb9f950", "message": "Merge branch 'perm-states-type' into perm-result", "committedDate": "2020-12-17T23:47:03Z", "type": "commit"}, {"oid": "0d4886efb34918d98cabcd8d575b6566fbec5806", "url": "https://github.com/ionic-team/capacitor/commit/0d4886efb34918d98cabcd8d575b6566fbec5806", "message": "remove JSObject update", "committedDate": "2020-12-18T16:10:21Z", "type": "commit"}, {"oid": "3789cf0c040a4a77d38664dd016402cfd01a7c99", "url": "https://github.com/ionic-team/capacitor/commit/3789cf0c040a4a77d38664dd016402cfd01a7c99", "message": "doc and removed unused import", "committedDate": "2020-12-18T16:45:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExODQwMg==", "url": "https://github.com/ionic-team/capacitor/pull/3967#discussion_r546118402", "body": "We should probably rephrase this to talk about the \"alias\"", "bodyText": "We should probably rephrase this to talk about the \"alias\"", "bodyHTML": "<p dir=\"auto\">We should probably rephrase this to talk about the \"alias\"</p>", "author": "imhoffd", "createdAt": "2020-12-18T22:21:41Z", "path": "android/capacitor/src/main/java/com/getcapacitor/Plugin.java", "diffHunk": "@@ -364,9 +363,9 @@ public void pluginRequestPermission(String permission, int requestCode) {\n      * Helper to check all permissions defined on a plugin and see the state of each.\n      *\n      * @since 3.0.0\n-     * @return an object containing the permission names and the permission result\n+     * @return an map containing the permission names and the permission state", "originalCommit": "3789cf0c040a4a77d38664dd016402cfd01a7c99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "3aafb44c51feecb7c450922a27d00247cb01a43b", "changed_code": [{"header": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\nindex 0bc598d5..cc4578ac 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n", "chunk": "@@ -363,7 +363,7 @@ public class Plugin {\n      * Helper to check all permissions defined on a plugin and see the state of each.\n      *\n      * @since 3.0.0\n-     * @return an map containing the permission names and the permission state\n+     * @return A mapping of permission aliases to the associated granted status.\n      */\n     public Map<String, PermissionState> getPermissionStates() {\n         return bridge.getPermissionStates(this);\n", "next_change": null}]}, "revised_code_in_main": {"commit": "67a0eba10a13e1a6354c372059323d5857da2e24", "changed_code": [{"header": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\nindex 0bc598d5..cc4578ac 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n", "chunk": "@@ -363,7 +363,7 @@ public class Plugin {\n      * Helper to check all permissions defined on a plugin and see the state of each.\n      *\n      * @since 3.0.0\n-     * @return an map containing the permission names and the permission state\n+     * @return A mapping of permission aliases to the associated granted status.\n      */\n     public Map<String, PermissionState> getPermissionStates() {\n         return bridge.getPermissionStates(this);\n", "next_change": {"commit": "0effd1e76cd1de58a581d95d87c0781a87ce9afa", "changed_code": [{"header": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\nindex cc4578ac..bb12a9eb 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n", "chunk": "@@ -363,9 +364,9 @@ public class Plugin {\n      * Helper to check all permissions defined on a plugin and see the state of each.\n      *\n      * @since 3.0.0\n-     * @return A mapping of permission aliases to the associated granted status.\n+     * @return an object containing the permission names and the permission result\n      */\n-    public Map<String, PermissionState> getPermissionStates() {\n+    public JSObject getPermissionStates() {\n         return bridge.getPermissionStates(this);\n     }\n \n", "next_change": {"commit": "cc459de7fc070c0227e066f3e8b92062728ab45d", "changed_code": [{"header": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\nindex bb12a9eb..858a264e 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/Plugin.java\n", "chunk": "@@ -364,9 +552,9 @@ public class Plugin {\n      * Helper to check all permissions defined on a plugin and see the state of each.\n      *\n      * @since 3.0.0\n-     * @return an object containing the permission names and the permission result\n+     * @return A mapping of permission aliases to the associated granted status.\n      */\n-    public JSObject getPermissionStates() {\n+    public Map<String, PermissionState> getPermissionStates() {\n         return bridge.getPermissionStates(this);\n     }\n \n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "67a0eba10a13e1a6354c372059323d5857da2e24", "message": "Merge commit", "committedDate": null}, {"oid": "0effd1e76cd1de58a581d95d87c0781a87ce9afa", "committedDate": "2020-12-23 12:42:49 -0800", "message": "refactor(android): Revert \"represent permission states using enum\" (#3988)"}, {"oid": "cc459de7fc070c0227e066f3e8b92062728ab45d", "committedDate": "2021-01-08 14:03:30 -0800", "message": "feat(android): switch to new callback-style permission requests (#4033)"}, {"oid": "bfd1a571a03d82db7b32f58924f54aa5e5fbb0b5", "committedDate": "2021-01-13 11:00:24 -0800", "message": "refactor(android): remove status parameter from plugin callbacks (#4060)"}, {"oid": "c88c4b46b949a87c1b89476b75273adef725242b", "committedDate": "2021-01-13 11:48:44 -0800", "message": "feat(android): method to check permission for an alias (#4062)"}, {"oid": "b2d915b5908a3de389bd6d620f06bcc5bf7472d1", "committedDate": "2021-01-13 13:59:32 -0600", "message": "refactor(android): fix error msg and comments related to permission callback #4063"}, {"oid": "55ef5ff38e87729412c44bfa4b2f29e53044cecc", "committedDate": "2021-01-21 11:45:53 -0600", "message": "fix(android): requestPermission call rejects if permission missing in manifest"}, {"oid": "002f1e55173a50b9fe918b4eda73b5113b713282", "committedDate": "2021-02-08 09:43:10 -0800", "message": "feat(android): activity result use new API and update permission result callbacks to match (#4127)"}, {"oid": "5510d307098038143f0282a74fbe616bf43e8c28", "committedDate": "2021-02-11 09:20:10 -0800", "message": "refactor(android): permission API cleanup (#4171)"}, {"oid": "a648c51588627404b5ad30c35943fed18af4a546", "committedDate": "2021-03-03 09:33:32 -0600", "message": "feat(android): Unifying saving plugin calls (#4254)"}, {"oid": "502a2d18ddce870f4caf810b405f7363f2340067", "committedDate": "2021-03-04 08:27:03 -0600", "message": "fix(android): calls re-saved during permission/activity result callbacks were being released"}, {"oid": "a9f30a88bf3cf239a59c4e901e2a9a2a141a9044", "committedDate": "2021-03-17 17:11:44 +0100", "message": "fix(android): Release the call after reject/resolve (#4318)"}, {"oid": "ac6c6bc031e0c8236004dfb9e1b04f1f849c1519", "committedDate": "2021-04-12 12:41:42 -0500", "message": "fix(android): resolve issue with activity result API registration for fragments (#4402)"}, {"oid": "2c1eb603c79b94f6fcc74f0cbef523590b656a1e", "committedDate": "2021-09-03 10:57:50 +0200", "message": "fix(android): save activity result launcher calls (#5004)"}, {"oid": "b82bfe0db2e38fa286eb18391b1d5e2f86a1b35c", "committedDate": "2021-10-13 18:09:51 +0200", "message": "fix(android): Avoid ConcurrentModificationException on notifyListeners (#5125)"}, {"oid": "6f4d858ea879d97109c0c7da2d664d04806adc2a", "committedDate": "2022-03-29 14:34:44 +0200", "message": "fix(android): make removeAllListeners return a promise (#5527)"}, {"oid": "84fe693f8d66827dbba733f6e32185ae34a3e41e", "committedDate": "2022-05-17 16:37:37 +0200", "message": "chore: Silence NativePlugin deprecation warnings (#5625)"}, {"oid": "b11a9df070f18a25364a9109e295556fc75ea7f9", "committedDate": "2023-03-08 17:16:08 +0100", "message": "fix(android): handle empty permission list (#6375)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjExOTA3MQ==", "url": "https://github.com/ionic-team/capacitor/pull/3967#discussion_r546119071", "body": "Do we want to call the plugin instance version?\r\n\r\n```suggestion\r\n                        plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, plugin.getInstance().getPermissionStates());\r\n```", "bodyText": "Do we want to call the plugin instance version?\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, getPermissionStates(plugin.getInstance()));\n          \n          \n            \n                                    plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, plugin.getInstance().getPermissionStates());", "bodyHTML": "<p dir=\"auto\">Do we want to call the plugin instance version?</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                        plugin<span class=\"pl-k\">.</span>getInstance()<span class=\"pl-k\">.</span>onRequestPermissionsResult(savedPermissionCall, <span class=\"x x-first x-last\">getPermissionStates(</span>plugin<span class=\"pl-k\">.</span>getInstance()));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                        plugin<span class=\"pl-k\">.</span>getInstance()<span class=\"pl-k\">.</span>onRequestPermissionsResult(savedPermissionCall, plugin<span class=\"pl-k\">.</span>getInstance()<span class=\"pl-k x x-first\">.</span><span class=\"x x-last\">getPermissionStates(</span>));</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "imhoffd", "createdAt": "2020-12-18T22:23:26Z", "path": "android/capacitor/src/main/java/com/getcapacitor/Bridge.java", "diffHunk": "@@ -786,10 +787,10 @@ public void onRequestPermissionsResult(int requestCode, String[] permissions, in\n                 if (validatePermissions(plugin.getInstance(), savedPermissionCall, permissions, grantResults)) {\n                     // handle request permissions call\n                     if (savedPermissionCall.getMethodName().equals(\"requestPermissions\")) {\n-                        savedPermissionCall.resolve(plugin.getInstance().getPermissionStates());\n+                        plugin.getInstance().checkPermissions(savedPermissionCall);\n                     } else {\n                         // handle permission requests by other methods on the plugin\n-                        plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, requestCode, permissions, grantResults);\n+                        plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, getPermissionStates(plugin.getInstance()));", "originalCommit": "3789cf0c040a4a77d38664dd016402cfd01a7c99", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d1e0f3b5d97e6ca0c5eaad4b3e13c6844536aa1a", "changed_code": [{"header": "diff --git a/android/capacitor/src/main/java/com/getcapacitor/Bridge.java b/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\nindex 7dd5f784..14358091 100644\n--- a/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\n+++ b/android/capacitor/src/main/java/com/getcapacitor/Bridge.java\n", "chunk": "@@ -790,7 +790,7 @@ public class Bridge {\n                         plugin.getInstance().checkPermissions(savedPermissionCall);\n                     } else {\n                         // handle permission requests by other methods on the plugin\n-                        plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, getPermissionStates(plugin.getInstance()));\n+                        plugin.getInstance().onRequestPermissionsResult(savedPermissionCall, plugin.getInstance().getPermissionStates());\n \n                         if (!savedPermissionCall.isReleased() && !savedPermissionCall.isSaved()) {\n                             savedPermissionCall.release(this);\n", "next_change": null}]}}, {"oid": "d1e0f3b5d97e6ca0c5eaad4b3e13c6844536aa1a", "url": "https://github.com/ionic-team/capacitor/commit/d1e0f3b5d97e6ca0c5eaad4b3e13c6844536aa1a", "message": "call plugin getPermissionStates\n\nCo-authored-by: Dan Imhoff <dwieeb@gmail.com>", "committedDate": "2020-12-18T22:39:35Z", "type": "commit"}, {"oid": "3aafb44c51feecb7c450922a27d00247cb01a43b", "url": "https://github.com/ionic-team/capacitor/commit/3aafb44c51feecb7c450922a27d00247cb01a43b", "message": "clarified javadoc", "committedDate": "2020-12-18T22:45:15Z", "type": "commit"}]}