{"pr_number": 1239, "pr_title": "Iam carousel page impressions", "pr_author": "emawby", "pr_createdAt": "2020-12-10T18:15:15Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239", "timeline": [{"oid": "142e4b4d124c36096b5aeaf400df6205ad404358", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/142e4b4d124c36096b5aeaf400df6205ad404358", "message": "adding pageIds to OSInAppMessage", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "999ca8d5f4998b5c06575e8f84515994ba36aa5d", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/999ca8d5f4998b5c06575e8f84515994ba36aa5d", "message": "adding page Id to in app message action", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "24d41f005ce9be4b808e2e5bfc95fa90eec78436", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/24d41f005ce9be4b808e2e5bfc95fa90eec78436", "message": "creating OSInAppMessagePage class", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "2d04a710668e95d98d072611488def7a3ee16127", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/2d04a710668e95d98d072611488def7a3ee16127", "message": "adding page impression rest call and page changed logic", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "565f47671c2dfe73426ed0a49471b13d6e12dafb", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/565f47671c2dfe73426ed0a49471b13d6e12dafb", "message": "firing onPageChanged from json event", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "0149a12c6d25806e583d070864564e52fbd0860b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0149a12c6d25806e583d070864564e52fbd0860b", "message": "Unit test for page changed event", "committedDate": "2020-12-09T23:49:27Z", "type": "commit"}, {"oid": "04790085256c86606e69a3f5c622f4a562a2c039", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/04790085256c86606e69a3f5c622f4a562a2c039", "message": "matching json to backend spec change", "committedDate": "2020-12-10T00:14:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r540608267", "body": "Looks like this is a TODO yet?", "bodyText": "Looks like this is a TODO yet?", "bodyHTML": "<p dir=\"auto\">Looks like this is a TODO yet?</p>", "author": "jkasten2", "createdAt": "2020-12-11T00:49:18Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))\n+            return;\n+\n+        message.addPageId(page.getPageId());\n+\n+        try {\n+            JSONObject json = new JSONObject() {{\n+                put(\"app_id\", OneSignal.appId);\n+                put(\"player_id\", OneSignal.getUserId());\n+                put(\"variant_id\", variantId);\n+                put(\"device_type\", new OSUtils().getDeviceType());\n+                put(\"page_id\", pageId);\n+            }};\n+\n+            OneSignalRestClient.post(\"in_app_messages/\" + message.messageId + \"/pageImpression\", json, new ResponseHandler() {\n+                @Override\n+                void onSuccess(String response) {\n+                    printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n+                    /*OneSignalPrefs.saveStringSet(", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDY1Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134653", "bodyText": "Yes this was my question at the end of the PR do we need to save the ids to the prefs?", "author": "emawby", "createdAt": "2020-12-11T18:12:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIzNjAwMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541236001", "bodyText": "The only scenario that I think needs this.\n1 - Opening app\n2 - Display IAM\n3 - Impression sent\n4 - Close application (swipe away) without dismiss IAM\n5 - Open app\n6 - IAM should display again\n7 - Impression shouldn't be sent again", "author": "Jeasmine", "createdAt": "2020-12-11T20:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTM0MTExMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541341110", "bodyText": "Cool confirmed that this is an issue so I will store them in the prefs", "author": "emawby", "createdAt": "2020-12-11T22:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwODI2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "9fd95407f21bc626ef23fb78469313778f582a14", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 87094ca6..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -447,18 +467,14 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n                 @Override\n                 void onSuccess(String response) {\n                     printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n-                    /*OneSignalPrefs.saveStringSet(\n-                            OneSignalPrefs.PREFS_ONESIGNAL,\n-                            OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n-                            // Post success, store impressioned page to disk\n-                            impressionedMessages);*/\n+                    saveViewedPageIdsToPrefs();\n                 }\n \n                 @Override\n                 void onFailure(int statusCode, String response, Throwable throwable) {\n                     printHttpErrorForInAppMessageRequest(\"page impression\", statusCode, response);\n-                    // Post failed, impressionedMessage should be removed and this way another post can be attempted\n-                    message.getViewedPageIds().remove(page.getPageId());\n+                    // Post failed, viewed page should be removed and this way another post can be attempted\n+                    viewedPageIds.remove(messagePrefixedPageId);\n                 }\n             });\n         } catch (JSONException e) {\n", "next_change": {"commit": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 210cd92e..b7fb7934 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -467,14 +443,18 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n                 @Override\n                 void onSuccess(String response) {\n                     printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n-                    saveViewedPageIdsToPrefs();\n+                    /*OneSignalPrefs.saveStringSet(\n+                            OneSignalPrefs.PREFS_ONESIGNAL,\n+                            OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n+                            // Post success, store impressioned page to disk\n+                            impressionedMessages);*/\n                 }\n \n                 @Override\n                 void onFailure(int statusCode, String response, Throwable throwable) {\n                     printHttpErrorForInAppMessageRequest(\"page impression\", statusCode, response);\n-                    // Post failed, viewed page should be removed and this way another post can be attempted\n-                    viewedPageIds.remove(messagePrefixedPageId);\n+                    // Post failed, impressionedMessage should be removed and this way another post can be attempted\n+                    message.getViewedPageIds().remove(page.getPageId());\n                 }\n             });\n         } catch (JSONException e) {\n", "next_change": {"commit": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -443,18 +467,14 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n                 @Override\n                 void onSuccess(String response) {\n                     printHttpSuccessForInAppMessageRequest(\"page impression\", response);\n-                    /*OneSignalPrefs.saveStringSet(\n-                            OneSignalPrefs.PREFS_ONESIGNAL,\n-                            OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n-                            // Post success, store impressioned page to disk\n-                            impressionedMessages);*/\n+                    saveViewedPageIdsToPrefs();\n                 }\n \n                 @Override\n                 void onFailure(int statusCode, String response, Throwable throwable) {\n                     printHttpErrorForInAppMessageRequest(\"page impression\", statusCode, response);\n-                    // Post failed, impressionedMessage should be removed and this way another post can be attempted\n-                    message.getViewedPageIds().remove(page.getPageId());\n+                    // Post failed, viewed page should be removed and this way another post can be attempted\n+                    viewedPageIds.remove(messagePrefixedPageId);\n                 }\n             });\n         } catch (JSONException e) {\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMzUxNA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541133514", "body": "this is marked as notNull but \r\n\r\n`pageId = json.optString(PAGE_ID, null);` it could end being null, maybe set a default value? tr change to Nullable", "bodyText": "this is marked as notNull but\npageId = json.optString(PAGE_ID, null); it could end being null, maybe set a default value? tr change to Nullable", "bodyHTML": "<p dir=\"auto\">this is marked as notNull but</p>\n<p dir=\"auto\"><code>pageId = json.optString(PAGE_ID, null);</code> it could end being null, maybe set a default value? tr change to Nullable</p>", "author": "Jeasmine", "createdAt": "2020-12-11T18:10:23Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java", "diffHunk": "@@ -125,6 +133,11 @@ public String getClickName() {\n         return clickName;\n     }\n \n+    @NonNull", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1OTEwMA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542659100", "bodyText": "fixed!", "author": "emawby", "createdAt": "2020-12-14T19:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzMzUxNA=="}], "type": "inlineReview", "revised_code": {"commit": "9fd95407f21bc626ef23fb78469313778f582a14", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java\nindex f4ab18d9..ad55bb01 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageAction.java\n", "chunk": "@@ -133,7 +133,6 @@ public class OSInAppMessageAction {\n         return clickName;\n     }\n \n-    @NonNull\n     String getPageId() {\n         return pageId;\n     }\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDQ2Ng==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134466", "body": "remove extra enter", "bodyText": "remove extra enter", "bodyHTML": "<p dir=\"auto\">remove extra enter</p>", "author": "Jeasmine", "createdAt": "2020-12-11T18:11:53Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1ODkyOQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542658929", "bodyText": "fixed!", "author": "emawby", "createdAt": "2020-12-14T19:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDQ2Ng=="}], "type": "inlineReview", "revised_code": {"commit": "9fd95407f21bc626ef23fb78469313778f582a14", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 87094ca6..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -420,6 +429,14 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         }\n     }\n \n+    private void saveViewedPageIdsToPrefs() {\n+        OneSignalPrefs.saveStringSet(\n+                OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n+                // Post success, store impressioned pages to disk\n+                viewedPageIds);\n+    }\n+\n     private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n         final String variantId = variantIdForMessage(message);\n         if (variantId == null)\n", "next_change": {"commit": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 210cd92e..b7fb7934 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -429,14 +417,6 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         }\n     }\n \n-    private void saveViewedPageIdsToPrefs() {\n-        OneSignalPrefs.saveStringSet(\n-                OneSignalPrefs.PREFS_ONESIGNAL,\n-                OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n-                // Post success, store impressioned pages to disk\n-                viewedPageIds);\n-    }\n-\n     private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n         final String variantId = variantIdForMessage(message);\n         if (variantId == null)\n", "next_change": {"commit": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -417,6 +429,14 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         }\n     }\n \n+    private void saveViewedPageIdsToPrefs() {\n+        OneSignalPrefs.saveStringSet(\n+                OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n+                // Post success, store impressioned pages to disk\n+                viewedPageIds);\n+    }\n+\n     private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n         final String variantId = variantIdForMessage(message);\n         if (variantId == null)\n", "next_change": null}, {"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -424,11 +444,15 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId))\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n+        }\n \n-        message.addPageId(page.getPageId());\n+        viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": null}]}}, {"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 210cd92e..b7fb7934 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -444,15 +424,11 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n-        final String messagePrefixedPageId = message.messageId + pageId;\n-\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (viewedPageIds.contains(messagePrefixedPageId)) {\n-            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n+        if (message.getViewedPageIds().contains(pageId))\n             return;\n-        }\n \n-        viewedPageIds.add(messagePrefixedPageId);\n+        message.addPageId(page.getPageId());\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": {"commit": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -424,11 +444,15 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId))\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n+        }\n \n-        message.addPageId(page.getPageId());\n+        viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": null}]}}]}}, {"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 87094ca6..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -427,12 +444,15 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n+        final String messagePrefixedPageId = message.messageId + pageId;\n \n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId))\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n+        }\n \n-        message.addPageId(page.getPageId());\n+        viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": {"commit": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 210cd92e..b7fb7934 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -444,15 +424,11 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n-        final String messagePrefixedPageId = message.messageId + pageId;\n-\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (viewedPageIds.contains(messagePrefixedPageId)) {\n-            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n+        if (message.getViewedPageIds().contains(pageId))\n             return;\n-        }\n \n-        viewedPageIds.add(messagePrefixedPageId);\n+        message.addPageId(page.getPageId());\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": {"commit": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -424,11 +444,15 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId))\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n+        }\n \n-        message.addPageId(page.getPageId());\n+        viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDgyNg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541134826", "body": "this is checked under onPageChanged too, is that ok?", "bodyText": "this is checked under onPageChanged too, is that ok?", "bodyHTML": "<p dir=\"auto\">this is checked under onPageChanged too, is that ok?</p>", "author": "Jeasmine", "createdAt": "2020-12-11T18:12:27Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +420,53 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId))", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1MTc2OA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542651768", "bodyText": "Now only checking in the rest method call for consistency with iOS and better separation of concerns", "author": "emawby", "createdAt": "2020-12-14T19:01:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDgyNg=="}], "type": "inlineReview", "revised_code": {"commit": "9fd95407f21bc626ef23fb78469313778f582a14", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 87094ca6..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -427,12 +444,15 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n+        final String messagePrefixedPageId = message.messageId + pageId;\n \n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId))\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n+        }\n \n-        message.addPageId(page.getPageId());\n+        viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": {"commit": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 210cd92e..b7fb7934 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -444,15 +424,11 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n-        final String messagePrefixedPageId = message.messageId + pageId;\n-\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (viewedPageIds.contains(messagePrefixedPageId)) {\n-            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n+        if (message.getViewedPageIds().contains(pageId))\n             return;\n-        }\n \n-        viewedPageIds.add(messagePrefixedPageId);\n+        message.addPageId(page.getPageId());\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": {"commit": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -424,11 +444,15 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId))\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n+        }\n \n-        message.addPageId(page.getPageId());\n+        viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541139337", "body": "is this needed?", "bodyText": "is this needed?", "bodyHTML": "<p dir=\"auto\">is this needed?</p>", "author": "Jeasmine", "createdAt": "2020-12-11T18:20:32Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1ODc1NA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542658754", "bodyText": "yes it crashes without it", "author": "emawby", "createdAt": "2020-12-14T19:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4NzMwNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542687305", "bodyText": "oh, weird \ud83e\udd14  test setup should not break tests, can you point out which error it is?", "author": "Jeasmine", "createdAt": "2020-12-14T19:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyODU4MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542828581", "bodyText": "Ah sorry the crash can be fixed, but you need to initialize to have the player id etc for the request", "author": "emawby", "createdAt": "2020-12-14T21:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTMzNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTgzNw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r541139837", "body": "is ok to test without mocking the IAM display? ", "bodyText": "is ok to test without mocking the IAM display?", "bodyHTML": "<p dir=\"auto\">is ok to test without mocking the IAM display?</p>", "author": "Jeasmine", "createdAt": "2020-12-11T18:21:25Z", "path": "OneSignalSDK/unittest/src/test/java/com/test/onesignal/InAppMessagingUnitTests.java", "diffHunk": "@@ -616,4 +616,19 @@ public void testOnMessageWasShown() throws Exception {\n         assertEquals(1, iamImpressionRequest.payload.get(\"device_type\"));\n         assertEquals(true, iamImpressionRequest.payload.get(\"first_impression\"));\n     }\n+\n+    @Test\n+    public void testOnPageChanged() throws Exception {\n+        threadAndTaskWait();\n+\n+        OneSignalPackagePrivateHelper.onPageChanged(message, InAppMessagingHelpers.buildTestPageJson());", "originalCommit": "04790085256c86606e69a3f5c622f4a562a2c039", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY1NTU2Mw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542655563", "bodyText": "Yes we test without mocking the iam display for clicks as well and they should be entirely independent", "author": "emawby", "createdAt": "2020-12-14T19:04:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTgzNw=="}], "type": "inlineReview", "revised_code": null}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MDA1OQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542690059", "body": "same question as on iOS, see https://github.com/OneSignal/OneSignal-iOS-SDK/pull/735#discussion_r542662673", "bodyText": "same question as on iOS, see OneSignal/OneSignal-iOS-SDK#735 (comment)", "bodyHTML": "<p dir=\"auto\">same question as on iOS, see <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"691495870\" data-permission-text=\"Title is private\" data-url=\"https://github.com/OneSignal/OneSignal-iOS-SDK/issues/735\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/OneSignal/OneSignal-iOS-SDK/pull/735/hovercard?comment_id=542662673&amp;comment_type=review_comment\" href=\"https://github.com/OneSignal/OneSignal-iOS-SDK/pull/735#discussion_r542662673\">OneSignal/OneSignal-iOS-SDK#735 (comment)</a></p>", "author": "Jeasmine", "createdAt": "2020-12-14T19:35:22Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -409,6 +429,62 @@ else if (action.getUrlTarget() == OSInAppMessageAction.OSInAppMessageActionUrlTy\n         }\n     }\n \n+    private void saveViewedPageIdsToPrefs() {\n+        OneSignalPrefs.saveStringSet(\n+                OneSignalPrefs.PREFS_ONESIGNAL,\n+                OneSignalPrefs.PREFS_OS_PAGE_IMPRESSIONED_IAMS,\n+                // Post success, store impressioned pages to disk\n+                viewedPageIds);\n+    }\n+\n+    private void fireRESTCallForPageChange(@NonNull final OSInAppMessage message, @NonNull final OSInAppMessagePage page) {\n+        final String variantId = variantIdForMessage(message);\n+        if (variantId == null)\n+            return;\n+\n+        final String pageId = page.getPageId();\n+\n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n+        // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n+        if (message.getViewedPageIds().contains(pageId) || viewedPageIds.contains(messagePrefixedPageId)) {", "originalCommit": "9a428549751e320600989f56c94f53c976fc4e98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjgyODIwMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r542828203", "bodyText": "same fix as ios. only tracking globally now, but it is still per inapp since we don't want them to affect each other (in local testing I was getting duplicate page ids for different inapps which is why I prefixed the page id with the message id)", "author": "emawby", "createdAt": "2020-12-14T21:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MDA1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "9fd95407f21bc626ef23fb78469313778f582a14", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 86a999e9..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -447,12 +447,11 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n         final String messagePrefixedPageId = message.messageId + pageId;\n \n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId) || viewedPageIds.contains(messagePrefixedPageId)) {\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n             OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n         }\n \n-        message.addPageId(page.getPageId());\n         viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n", "next_change": {"commit": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 210cd92e..b7fb7934 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -444,15 +424,11 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n-        final String messagePrefixedPageId = message.messageId + pageId;\n-\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (viewedPageIds.contains(messagePrefixedPageId)) {\n-            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n+        if (message.getViewedPageIds().contains(pageId))\n             return;\n-        }\n \n-        viewedPageIds.add(messagePrefixedPageId);\n+        message.addPageId(page.getPageId());\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": {"commit": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -424,11 +444,15 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n         final String pageId = page.getPageId();\n \n+        final String messagePrefixedPageId = message.messageId + pageId;\n+\n         // Never send multiple page impressions for the same message UUID unless that page change is from an IAM with redisplay\n-        if (message.getViewedPageIds().contains(pageId))\n+        if (viewedPageIds.contains(messagePrefixedPageId)) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.VERBOSE, \"Already sent page impression for id: \" + pageId);\n             return;\n+        }\n \n-        message.addPageId(page.getPageId());\n+        viewedPageIds.add(messagePrefixedPageId);\n \n         try {\n             JSONObject json = new JSONObject() {{\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NzI0Mg==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r543687242", "body": "can we put some comment over this desition of cleaning impressions, so we know in the future?", "bodyText": "can we put some comment over this desition of cleaning impressions, so we know in the future?", "bodyHTML": "<p dir=\"auto\">can we put some comment over this desition of cleaning impressions, so we know in the future?</p>", "author": "Jeasmine", "createdAt": "2020-12-15T21:08:25Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -494,6 +568,8 @@ private void setDataForRedisplay(OSInAppMessage message) {\n \n                 dismissedMessages.remove(message.messageId);\n                 impressionedMessages.remove(message.messageId);\n+                viewedPageIds.clear();", "originalCommit": "ba6373650125d7b6aa152380d99e949d35f96db5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5ODk5MQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/1239#discussion_r544598991", "bodyText": "done!", "author": "emawby", "createdAt": "2020-12-16T20:24:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY4NzI0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "9fd95407f21bc626ef23fb78469313778f582a14", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex fbf9bd24..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -568,6 +568,8 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n                 dismissedMessages.remove(message.messageId);\n                 impressionedMessages.remove(message.messageId);\n+                // Pages from different IAMs should not impact each other so we can clear the entire\n+                // list when an IAM is dismissed or we are re-displaying the same one\n                 viewedPageIds.clear();\n                 saveViewedPageIdsToPrefs();\n                 message.clearClickIds();\n", "next_change": {"commit": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex 210cd92e..b7fb7934 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -568,11 +548,8 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n                 dismissedMessages.remove(message.messageId);\n                 impressionedMessages.remove(message.messageId);\n-                // Pages from different IAMs should not impact each other so we can clear the entire\n-                // list when an IAM is dismissed or we are re-displaying the same one\n-                viewedPageIds.clear();\n-                saveViewedPageIdsToPrefs();\n                 message.clearClickIds();\n+                message.clearPageIds();\n             }\n         }\n     }\n", "next_change": {"commit": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "changed_code": [{"header": "diff --git a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\nindex b7fb7934..210cd92e 100644\n--- a/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n+++ b/OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java\n", "chunk": "@@ -548,8 +568,11 @@ class OSInAppMessageController implements OSDynamicTriggerControllerObserver, OS\n \n                 dismissedMessages.remove(message.messageId);\n                 impressionedMessages.remove(message.messageId);\n+                // Pages from different IAMs should not impact each other so we can clear the entire\n+                // list when an IAM is dismissed or we are re-displaying the same one\n+                viewedPageIds.clear();\n+                saveViewedPageIdsToPrefs();\n                 message.clearClickIds();\n-                message.clearPageIds();\n             }\n         }\n     }\n", "next_change": null}]}}]}}]}}, {"oid": "9fd95407f21bc626ef23fb78469313778f582a14", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/9fd95407f21bc626ef23fb78469313778f582a14", "message": "adding clarifying comment", "committedDate": "2020-12-16T20:24:24Z", "type": "forcePushed"}, {"oid": "1a8c6a90e71b76cae762afac8ef26460fdc9fa3b", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/1a8c6a90e71b76cae762afac8ef26460fdc9fa3b", "message": "Storing pageIds to prefs to fix double impression", "committedDate": "2020-12-23T22:23:36Z", "type": "forcePushed"}, {"oid": "d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/d865c2202fe3dcf5a7959140f03eec8c4adba4eb", "message": "removing page id check in pageChanged", "committedDate": "2020-12-23T22:24:04Z", "type": "commit"}, {"oid": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "message": "Storing pageIds to prefs to fix double impression", "committedDate": "2020-12-23T22:24:04Z", "type": "commit"}, {"oid": "38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/38ef376becb0ea4cf518f6d2dfb79d42523a2cb0", "message": "Storing pageIds to prefs to fix double impression", "committedDate": "2020-12-23T22:24:04Z", "type": "forcePushed"}]}