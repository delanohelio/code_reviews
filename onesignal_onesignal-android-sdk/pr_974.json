{"pr_number": 974, "pr_title": "Add new features to IAM preview ", "pr_author": "Jeasmine", "pr_createdAt": "2020-03-20T22:42:23Z", "pr_url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974", "timeline": [{"oid": "91b556e07c6555391402b110033a70f7b7b69459", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/91b556e07c6555391402b110033a70f7b7b69459", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview", "committedDate": "2020-03-20T22:43:01Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNjAwMQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396126001", "body": "Don't make it specific to tags and outcomes we might have more things added here eventually\r\n\r\nChange name from `fireTagsAndOutcomeLogs` to\r\n`logInAppMessagePreviewActions` or\r\n`logIamPreviewActions`?", "bodyText": "Don't make it specific to tags and outcomes we might have more things added here eventually\nChange name from fireTagsAndOutcomeLogs to\nlogInAppMessagePreviewActions or\nlogIamPreviewActions?", "bodyHTML": "<p dir=\"auto\">Don't make it specific to tags and outcomes we might have more things added here eventually</p>\n<p dir=\"auto\">Change name from <code>fireTagsAndOutcomeLogs</code> to<br>\n<code>logInAppMessagePreviewActions</code> or<br>\n<code>logIamPreviewActions</code>?</p>", "author": "mikechoch", "createdAt": "2020-03-22T18:31:01Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNjY4MA==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396126680", "body": "way too much extra code here, tags and outcomes are `JSONObjects` so just call `tags.toString()` and print that\r\n with a single log about the tags\r\n\r\nSame exact thing for outcomes, `outcomes.toString()` with a log\r\n\r\nex.\r\n    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\r\n @mikechoch\r\nmikechoch Member Pending\r\nDon't make it specific to tags and outcomes we might have more things added here eventually\r\n\r\nChange name from fireTagsAndOutcomeLogs to\r\nlogInAppMessagePreviewActions or\r\nlogIamPreviewActions?\r\n\r\n```\r\nprivate void logInAppMessagePreviewActions(final OSInAppMessageAction action) {\r\n    JSONObject tags = action.tags;\r\n    if (tags != null)\r\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.toString());\r\n   \r\n    JSONObject outcomes = action.outcomes;\r\n    if (outcomes != null)\r\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcomes detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcomes.toString());\r\n\r\n    // TODO: Add more action payload preview logs here in future\r\n}\r\n```", "bodyText": "way too much extra code here, tags and outcomes are JSONObjects so just call tags.toString() and print that\nwith a single log about the tags\nSame exact thing for outcomes, outcomes.toString() with a log\nex.\nprivate void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n@mikechoch\nmikechoch Member Pending\nDon't make it specific to tags and outcomes we might have more things added here eventually\nChange name from fireTagsAndOutcomeLogs to\nlogInAppMessagePreviewActions or\nlogIamPreviewActions?\nprivate void logInAppMessagePreviewActions(final OSInAppMessageAction action) {\n    JSONObject tags = action.tags;\n    if (tags != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.toString());\n   \n    JSONObject outcomes = action.outcomes;\n    if (outcomes != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcomes detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcomes.toString());\n\n    // TODO: Add more action payload preview logs here in future\n}", "bodyHTML": "<p dir=\"auto\">way too much extra code here, tags and outcomes are <code>JSONObjects</code> so just call <code>tags.toString()</code> and print that<br>\nwith a single log about the tags</p>\n<p dir=\"auto\">Same exact thing for outcomes, <code>outcomes.toString()</code> with a log</p>\n<p dir=\"auto\">ex.<br>\nprivate void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {<br>\n<a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/mikechoch/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/mikechoch\">@mikechoch</a><br>\nmikechoch Member Pending<br>\nDon't make it specific to tags and outcomes we might have more things added here eventually</p>\n<p dir=\"auto\">Change name from fireTagsAndOutcomeLogs to<br>\nlogInAppMessagePreviewActions or<br>\nlogIamPreviewActions?</p>\n<div class=\"snippet-clipboard-content position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"private void logInAppMessagePreviewActions(final OSInAppMessageAction action) {\n    JSONObject tags = action.tags;\n    if (tags != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, &quot;Tags detected inside of the action click payload, ignoring because action came from IAM preview: &quot; + tags.toString());\n   \n    JSONObject outcomes = action.outcomes;\n    if (outcomes != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, &quot;Outcomes detected inside of the action click payload, ignoring because action came from IAM preview: &quot; + outcomes.toString());\n\n    // TODO: Add more action payload preview logs here in future\n}\"><pre><code>private void logInAppMessagePreviewActions(final OSInAppMessageAction action) {\n    JSONObject tags = action.tags;\n    if (tags != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.toString());\n   \n    JSONObject outcomes = action.outcomes;\n    if (outcomes != null)\n        OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcomes detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcomes.toString());\n\n    // TODO: Add more action payload preview logs here in future\n}\n</code></pre></div>", "author": "mikechoch", "createdAt": "2020-03-22T18:38:26Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNzIzMw==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396127233", "body": "rename to `beginProcessingPrompts` that way the next calls make more sense.", "bodyText": "rename to beginProcessingPrompts that way the next calls make more sense.", "bodyHTML": "<p dir=\"auto\">rename to <code>beginProcessingPrompts</code> that way the next calls make more sense.</p>", "author": "mikechoch", "createdAt": "2020-03-22T18:44:41Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }\n+\n+    private void showPrompts(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEyNzIzNQ==", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/pull/974#discussion_r396127235", "body": "Rename to `showMultiplePrompts`", "bodyText": "Rename to showMultiplePrompts", "bodyHTML": "<p dir=\"auto\">Rename to <code>showMultiplePrompts</code></p>", "author": "mikechoch", "createdAt": "2020-03-22T18:44:42Z", "path": "OneSignalSDK/onesignal/src/main/java/com/onesignal/OSInAppMessageController.java", "diffHunk": "@@ -284,19 +285,57 @@ void onMessageActionOccurredOnPreview(@NonNull final OSInAppMessage message, @No\n         action.firstClick = message.takeActionAsUnique();\n \n         firePublicClickHandler(action);\n+        showPrompts(message, action.prompts);\n         fireClickAction(action);\n+        fireTagsAndOutcomeLogs(action);\n     }\n \n-    private void firePrompt(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n-        for (OSInAppMessagePrompt prompt : prompts) {\n+    private void fireTagsAndOutcomeLogs(final OSInAppMessageAction action) {\n+        if (action.tags != null) {\n+            OSInAppMessageTag tags = action.tags;\n+            if (tags.getTagsToAdd() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to add detected inside of the action click payload, ignoring because action came from IAM preview:: \" + tags.getTagsToAdd());\n+            if (tags.getTagsToRemove() != null)\n+                OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Tags to remove detected inside of the action click payload, ignoring because action came from IAM preview: \" + tags.getTagsToRemove());\n+        }\n+\n+        for (OSInAppMessageOutcome outcome : action.outcomes) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"Outcome detected inside of the action click payload, ignoring because action came from IAM preview: \" + outcome.toString());\n+        }\n+    }\n+\n+    private void showPrompts(OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {\n+        if (prompts.size() > 0) {\n+            OneSignal.onesignalLog(OneSignal.LOG_LEVEL.DEBUG, \"IAM showing prompts from IAM: \" + message.toString());\n             // TODO until we don't fix the activity going forward or back dismissing the IAM, we need to auto dismiss\n-            messageWasDismissed(message);\n-            prompt.handlePrompt(new OneSignal.OperationCompletedCallback() {\n+            WebViewManager.dismissCurrentIAM();\n+            handleMultiplePrompts(message, prompts);\n+        }\n+    }\n+\n+    private void handleMultiplePrompts(final OSInAppMessage message, final List<OSInAppMessagePrompt> prompts) {", "originalCommit": "91b556e07c6555391402b110033a70f7b7b69459", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0d451efd6cb66bf95e33d1bca754987dae13b062", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview", "committedDate": "2020-03-23T19:35:40Z", "type": "commit"}, {"oid": "0d451efd6cb66bf95e33d1bca754987dae13b062", "url": "https://github.com/OneSignal/OneSignal-Android-SDK/commit/0d451efd6cb66bf95e33d1bca754987dae13b062", "message": "Add new features to IAM preview\n\n   * Add prompt to IAM preview\n   * Add logs for tags and outcomes\n   * Redisplay, tags, outcomes, impression should not be included on IAM preview", "committedDate": "2020-03-23T19:35:40Z", "type": "forcePushed"}]}