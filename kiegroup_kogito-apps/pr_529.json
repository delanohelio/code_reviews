{"pr_number": 529, "pr_title": "KOGITO-3769 - Make LimeExplainer optionally generate more diverse samples", "pr_author": "tteofili", "pr_createdAt": "2020-11-09T09:04:37Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/529", "timeline": [{"oid": "25b6ab01d9ef0f19869a5f0890252cba8c852d84", "url": "https://github.com/kiegroup/kogito-apps/commit/25b6ab01d9ef0f19869a5f0890252cba8c852d84", "message": "KOGITO-3769 - Make LimeExplainer optionally generate more diverse samples", "committedDate": "2020-11-09T09:00:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5NzcyNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r519997727", "body": "Now we have a single param but this might change in the future so what about create a generic `ExplainerParams`/`ExplainerContext`/`ExplainerDescr` (and use it in the constructor of course)?\r\nIf you think this parameter is Lime-specific fine for me to have a `LimeExplainer*`, up to you :)\r\nPlease create also a `public static final DEFAULT` field in this class with default values like [this example](https://github.com/kiegroup/kogito-runtimes/blob/master/kogito-codegen/src/main/java/org/kie/kogito/codegen/AddonsConfig.java#L20)", "bodyText": "Now we have a single param but this might change in the future so what about create a generic ExplainerParams/ExplainerContext/ExplainerDescr (and use it in the constructor of course)?\nIf you think this parameter is Lime-specific fine for me to have a LimeExplainer*, up to you :)\nPlease create also a public static final DEFAULT field in this class with default values like this example", "bodyHTML": "<p dir=\"auto\">Now we have a single param but this might change in the future so what about create a generic <code>ExplainerParams</code>/<code>ExplainerContext</code>/<code>ExplainerDescr</code> (and use it in the constructor of course)?<br>\nIf you think this parameter is Lime-specific fine for me to have a <code>LimeExplainer*</code>, up to you :)<br>\nPlease create also a <code>public static final DEFAULT</code> field in this class with default values like <a href=\"https://github.com/kiegroup/kogito-runtimes/blob/master/kogito-codegen/src/main/java/org/kie/kogito/codegen/AddonsConfig.java#L20\">this example</a></p>", "author": "danielezonca", "createdAt": "2020-11-09T17:40:23Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/local/lime/LimeExplainer.java", "diffHunk": "@@ -77,6 +77,11 @@\n      */\n     private final PerturbationContext perturbationContext;\n \n+    /**\n+     * Whether the explainer should adapt the variance in the generated (perturbed) data when it's not separable.\n+     */\n+    private final boolean adaptDatasetVariance;", "originalCommit": "25b6ab01d9ef0f19869a5f0890252cba8c852d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2MTcwOQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r520061709", "bodyText": "Ok, it makes perfect sense to have a config / params class for LimeExplainer.", "author": "tteofili", "createdAt": "2020-11-09T19:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5NzcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5OTEzMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r521999132", "bodyText": "I've added now a LimeConfig object.", "author": "tteofili", "createdAt": "2020-11-12T10:27:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk5NzcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwMTg5Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r520001893", "body": "Are you sure of this code? As far as I can see this code will double the size of samples as soon as a `DatasetNotSeparableException` is thrown (regardless if it is the first attempt or similar) and again and again until the generated dataset is separable or that `noOfRetries` will be 0.\r\nIs it the logic you want? Do you expect it is never (or almost never) possible that a new sample of the same size will produce a separated dataset?", "bodyText": "Are you sure of this code? As far as I can see this code will double the size of samples as soon as a DatasetNotSeparableException is thrown (regardless if it is the first attempt or similar) and again and again until the generated dataset is separable or that noOfRetries will be 0.\nIs it the logic you want? Do you expect it is never (or almost never) possible that a new sample of the same size will produce a separated dataset?", "bodyHTML": "<p dir=\"auto\">Are you sure of this code? As far as I can see this code will double the size of samples as soon as a <code>DatasetNotSeparableException</code> is thrown (regardless if it is the first attempt or similar) and again and again until the generated dataset is separable or that <code>noOfRetries</code> will be 0.<br>\nIs it the logic you want? Do you expect it is never (or almost never) possible that a new sample of the same size will produce a separated dataset?</p>", "author": "danielezonca", "createdAt": "2020-11-09T17:46:56Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/local/lime/LimeExplainer.java", "diffHunk": "@@ -154,7 +157,19 @@ public int getNoOfRetries() {\n                         return completedFuture(getSaliencies(targetInput, linearizedTargetInputFeatures, actualOutputs, limeInputsList));\n                     } catch (DatasetNotSeparableException e) {\n                         if (noOfRetries > 0) {\n-                            return explainRetryCycle(model, originalInput, targetInput, linearizedTargetInputFeatures, actualOutputs, noOfRetries - 1);\n+                            PerturbationContext newPerturbationContext;\n+                            int newNoOfSamples;\n+                            if (adaptDatasetVariance) {\n+                                newPerturbationContext = new PerturbationContext(perturbationContext.getRandom(),\n+                                                                                 perturbationContext.getNoOfPerturbations() + 1);\n+                                newNoOfSamples = noOfSamples * 2;\n+                            } else {", "originalCommit": "25b6ab01d9ef0f19869a5f0890252cba8c852d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEwOTM1Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r520109352", "bodyText": "Yes, this is the intent. It might still happen that re-generating a new dataset will produce a separable dataset on a second run. I was however thinking in terms of the cost of this retry mechanism in terms of resources, therefore I was thinking that perhaps it's better to \"spend\" resources (generating perturbed data + computing outputs for each) when you have a higher likelihood of succeeding in the task of getting a separable dataset. That's why I set to do both increased sampling and increased perturbation size.\nBut maybe we can make a compromise and not just double the sample size, but rather increase it by n/100 on each retry where n is the configured number of retries (so that you end up with a doubled dataset size on the final retry, rather than with a n times bigger dataset).\nSame goes for the number of perturbations we can increase it more \"slowly\" and get it at half the no. of features by the last retry.", "author": "tteofili", "createdAt": "2020-11-09T20:46:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwMTg5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExMzc5Mg==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r522113792", "bodyText": "I think I have addressed the above comment in the subsequent commits.", "author": "tteofili", "createdAt": "2020-11-12T13:42:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwMTg5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwMjk5Nw==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r520002997", "body": "Does it make sense to check also if all positive features are stable?", "bodyText": "Does it make sense to check also if all positive features are stable?", "bodyHTML": "<p dir=\"auto\">Does it make sense to check also if all positive features are stable?</p>", "author": "danielezonca", "createdAt": "2020-11-09T17:48:48Z", "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/local/lime/LimeStabilityTest.java", "diffHunk": "@@ -42,70 +44,97 @@\n \n     @Test\n     void testStabilityWithNumericData() throws Exception {\n-        PredictionProvider sumSkipModel = TestUtils.getSumSkipModel(0);\n-        List<Feature> featureList = new LinkedList<>();\n-        for (int i = 0; i < 5; i++) {\n-            featureList.add(TestUtils.getMockedNumericFeature(i));\n+        Random random = new Random();\n+        for (int seed = 0; seed < 5; seed++) {\n+            random.setSeed(seed);\n+            PredictionProvider sumSkipModel = TestUtils.getSumSkipModel(0);\n+            List<Feature> featureList = new LinkedList<>();\n+            for (int i = 0; i < 5; i++) {\n+                featureList.add(TestUtils.getMockedNumericFeature(i));\n+            }\n+            LimeExplainer limeExplainer = new LimeExplainer(10, 1, random);\n+            assertStable(limeExplainer, sumSkipModel, featureList);\n         }\n-        assertStable(sumSkipModel, featureList);\n     }\n \n     @Test\n     void testStabilityWithTextData() throws Exception {\n-        PredictionProvider sumSkipModel = TestUtils.getDummyTextClassifier();\n-        List<Feature> featureList = new LinkedList<>();\n-        for (int i = 0; i < 4; i++) {\n-            featureList.add(TestUtils.getMockedTextFeature(\"foo \" + i));\n+        Random random = new Random();\n+        for (int seed = 0; seed < 5; seed++) {\n+            random.setSeed(seed);\n+            PredictionProvider sumSkipModel = TestUtils.getDummyTextClassifier();\n+            List<Feature> featureList = new LinkedList<>();\n+            for (int i = 0; i < 4; i++) {\n+                featureList.add(TestUtils.getMockedTextFeature(\"foo \" + i));\n+            }\n+            featureList.add(TestUtils.getMockedTextFeature(\"money\"));\n+            LimeExplainer limeExplainer = new LimeExplainer(10, 1, random);\n+            assertStable(limeExplainer, sumSkipModel, featureList);\n         }\n-        featureList.add(TestUtils.getMockedTextFeature(\"money\"));\n-        assertStable(sumSkipModel, featureList);\n     }\n \n-    private void assertStable(PredictionProvider model, List<Feature> featureList) throws Exception {\n+    @Test\n+    void testAdaptiveVariance() throws Exception {\n         Random random = new Random();\n         for (int seed = 0; seed < 5; seed++) {\n             random.setSeed(seed);\n-            LimeExplainer limeExplainer = new LimeExplainer(10, 1, random);\n-            PredictionInput input = new PredictionInput(featureList);\n-            List<PredictionOutput> predictionOutputs = model.predictAsync(List.of(input))\n-                    .get(Config.INSTANCE.getAsyncTimeout(), Config.INSTANCE.getAsyncTimeUnit());\n-            for (PredictionOutput predictionOutput : predictionOutputs) {\n-                Prediction prediction = new Prediction(input, predictionOutput);\n-                List<Saliency> saliencies = new LinkedList<>();\n-                for (int i = 0; i < 100; i++) {\n-                    Map<String, Saliency> saliencyMap = limeExplainer.explainAsync(prediction, model)\n-                            .get(Config.INSTANCE.getAsyncTimeout(), Config.INSTANCE.getAsyncTimeUnit());\n-                    saliencies.addAll(saliencyMap.values());\n-                }\n-                // check that the topmost important feature is stable\n-                List<String> names = new LinkedList<>();\n-                saliencies.stream().map(s -> s.getPositiveFeatures(1)).forEach(f -> names.add(f.get(0).getFeature().getName()));\n-                Map<String, Long> frequencyMap = names.stream().collect(Collectors.groupingBy(Function.identity(), Collectors.counting()));\n-                boolean topFeature = false;\n-                for (Map.Entry<String, Long> entry : frequencyMap.entrySet()) {\n-                    if (entry.getValue() >= TOP_FEATURE_THRESHOLD) {\n-                        topFeature = true;\n-                        break;\n-                    }\n-                }\n-                assertTrue(topFeature);\n+            PerturbationContext perturbationContext = new PerturbationContext(random, 1);\n \n-                // check that the impact is stable\n-                List<Double> impacts = new ArrayList<>(saliencies.size());\n-                for (Saliency saliency : saliencies) {\n-                    double v = ExplainabilityMetrics.impactScore(model, prediction, saliency.getTopFeatures(2));\n-                    impacts.add(v);\n+            int samples = 1;\n+            int retries = 4;\n+\n+            LimeExplainer adaptiveVarianceLE = new LimeExplainer(samples, perturbationContext,\n+                                                            retries, true);\n+\n+            List<Feature> features = new LinkedList<>();\n+            for (int i = 0; i < 4; i++) {\n+                features.add(FeatureFactory.newNumericalFeature(\"f-\"+i,2));\n+            }\n+            PredictionProvider model = TestUtils.getEvenSumModel(0);\n+            assertStable(adaptiveVarianceLE, model, features);\n+        }\n+    }\n+\n+    private void assertStable(LimeExplainer limeExplainer, PredictionProvider model, List<Feature> featureList) throws Exception {\n+        PredictionInput input = new PredictionInput(featureList);\n+        List<PredictionOutput> predictionOutputs = model.predictAsync(List.of(input))\n+                .get(Config.INSTANCE.getAsyncTimeout(), Config.INSTANCE.getAsyncTimeUnit());\n+        for (PredictionOutput predictionOutput : predictionOutputs) {\n+            Prediction prediction = new Prediction(input, predictionOutput);\n+            List<Saliency> saliencies = new LinkedList<>();\n+            for (int i = 0; i < 100; i++) {\n+                Map<String, Saliency> saliencyMap = limeExplainer.explainAsync(prediction, model)\n+                        .get(Config.INSTANCE.getAsyncTimeout(), Config.INSTANCE.getAsyncTimeUnit());\n+                saliencies.addAll(saliencyMap.values());\n+            }\n+            // check that the topmost important feature is stable\n+            List<String> names = new LinkedList<>();\n+            saliencies.stream().map(s -> s.getPositiveFeatures(1)).filter(f -> !f.isEmpty()).forEach(f -> names.add(f.get(0).getFeature().getName()));\n+            Map<String, Long> frequencyMap = names.stream().collect(Collectors.groupingBy(Function.identity(), Collectors.counting()));", "originalCommit": "25b6ab01d9ef0f19869a5f0890252cba8c852d84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDExMDQxNg==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r520110416", "bodyText": "this is better implemented in #530 where the depth at which the stability is checked is made configurable.\nSo I would leave it as it is for now, and then switch to that metric within #530.", "author": "tteofili", "createdAt": "2020-11-09T20:48:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDAwMjk5Nw=="}], "type": "inlineReview"}, {"oid": "b361a169918cd35c57bdda2a71f316db1de4b74f", "url": "https://github.com/kiegroup/kogito-apps/commit/b361a169918cd35c57bdda2a71f316db1de4b74f", "message": "KOGITO-3769 - refactored LIME configuration into a LimeConfig object", "committedDate": "2020-11-12T10:20:59Z", "type": "commit"}, {"oid": "b05000d6ff94287638475d8698eadb2cb249dab8", "url": "https://github.com/kiegroup/kogito-apps/commit/b05000d6ff94287638475d8698eadb2cb249dab8", "message": "KOGITO-3769 - make adaptive sampling generate at most 2*no. of initial samples", "committedDate": "2020-11-12T13:26:48Z", "type": "commit"}, {"oid": "cab8f5ebbb3bb79b71549bb13864ddd6fdb29ff7", "url": "https://github.com/kiegroup/kogito-apps/commit/cab8f5ebbb3bb79b71549bb13864ddd6fdb29ff7", "message": "KOGITO-3769 - better perturbation size increase", "committedDate": "2020-11-12T13:42:01Z", "type": "commit"}, {"oid": "5515b8fb3af4256fe5a4ac651a879c92a2e63b6c", "url": "https://github.com/kiegroup/kogito-apps/commit/5515b8fb3af4256fe5a4ac651a879c92a2e63b6c", "message": "KOGITO-3769 - reducing complexity, javadoc fix", "committedDate": "2020-11-12T15:47:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE3MjcwMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r522172700", "body": "Do we really want to have a default static instance of `PerturbationContext`? I think this could be better to do the `new` directly on `perturbationContext` field at instance level (so two different `LimeConfig` instances will not share it)\r\n```suggestion\r\n\r\n    /**\r\n     * No. of samples to be generated for the local linear model training\r\n     */\r\n    private int noOfSamples = DEFAULT_NO_OF_SAMPLES;\r\n\r\n    /**\r\n     * No. of retries while trying to find a (linearly) separable dataset\r\n     */\r\n    private int noOfRetries = DEFAULT_NO_OF_RETRIES;\r\n\r\n    /**\r\n     * Context object for perturbing features\r\n     */\r\n    private PerturbationContext perturbationContext = new PerturbationContext(new SecureRandom(), 1);\r\n```", "bodyText": "Do we really want to have a default static instance of PerturbationContext? I think this could be better to do the new directly on perturbationContext field at instance level (so two different LimeConfig instances will not share it)\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final PerturbationContext DEFAULT_PERTURBATION_CONTEXT = new PerturbationContext(new SecureRandom(), 1);\n          \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * No. of samples to be generated for the local linear model training\n          \n          \n            \n                 */\n          \n          \n            \n                private int noOfSamples = DEFAULT_NO_OF_SAMPLES;\n          \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * No. of retries while trying to find a (linearly) separable dataset\n          \n          \n            \n                 */\n          \n          \n            \n                private int noOfRetries = DEFAULT_NO_OF_RETRIES;\n          \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * Context object for perturbing features\n          \n          \n            \n                 */\n          \n          \n            \n                private PerturbationContext perturbationContext = DEFAULT_PERTURBATION_CONTEXT;\n          \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * No. of samples to be generated for the local linear model training\n          \n          \n            \n                 */\n          \n          \n            \n                private int noOfSamples = DEFAULT_NO_OF_SAMPLES;\n          \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * No. of retries while trying to find a (linearly) separable dataset\n          \n          \n            \n                 */\n          \n          \n            \n                private int noOfRetries = DEFAULT_NO_OF_RETRIES;\n          \n          \n            \n            \n          \n          \n            \n                /**\n          \n          \n            \n                 * Context object for perturbing features\n          \n          \n            \n                 */\n          \n          \n            \n                private PerturbationContext perturbationContext = new PerturbationContext(new SecureRandom(), 1);", "bodyHTML": "<p dir=\"auto\">Do we really want to have a default static instance of <code>PerturbationContext</code>? I think this could be better to do the <code>new</code> directly on <code>perturbationContext</code> field at instance level (so two different <code>LimeConfig</code> instances will not share it)</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">static</span> <span class=\"pl-k\">final</span> <span class=\"pl-smi\">PerturbationContext</span> <span class=\"pl-c1\">DEFAULT_PERTURBATION_CONTEXT</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">PerturbationContext</span>(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">SecureRandom</span>(), <span class=\"pl-c1\">1</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">No</span>. of samples to be generated <span class=\"pl-k\">for</span> the local linear model training</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">int</span> noOfSamples <span class=\"pl-k\">=</span> <span class=\"pl-c1\">DEFAULT_NO_OF_SAMPLES</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">No</span>. of retries <span class=\"pl-k\">while</span> trying to find a (linearly) separable dataset</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">int</span> noOfRetries <span class=\"pl-k\">=</span> <span class=\"pl-c1\">DEFAULT_NO_OF_RETRIES</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Context</span> object <span class=\"pl-k\">for</span> perturbing features</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">PerturbationContext</span> perturbationContext <span class=\"pl-k\">=</span> <span class=\"pl-c1\">DEFAULT_PERTURBATION_CONTEXT</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">No</span>. of samples to be generated <span class=\"pl-k\">for</span> the local linear model training</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">int</span> noOfSamples <span class=\"pl-k\">=</span> <span class=\"pl-c1\">DEFAULT_NO_OF_SAMPLES</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">No</span>. of retries <span class=\"pl-k\">while</span> trying to find a (linearly) separable dataset</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">int</span> noOfRetries <span class=\"pl-k\">=</span> <span class=\"pl-c1\">DEFAULT_NO_OF_RETRIES</span>;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\"></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-c\"><span class=\"pl-c\">/**</span></span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*</span> <span class=\"pl-smi\">Context</span> object <span class=\"pl-k\">for</span> perturbing features</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">     <span class=\"pl-k\">*/</span></td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-smi\">PerturbationContext</span> perturbationContext <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">PerturbationContext</span>(<span class=\"pl-k\">new</span> <span class=\"pl-smi\">SecureRandom</span>(), <span class=\"pl-c1\">1</span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "danielezonca", "createdAt": "2020-11-12T15:01:54Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/local/lime/LimeConfig.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.local.lime;\n+\n+import java.security.SecureRandom;\n+\n+import org.kie.kogito.explainability.model.PerturbationContext;\n+\n+/**\n+ * Lime explainer configuration parameters.\n+ */\n+public class LimeConfig {\n+\n+    private static final int DEFAULT_NO_OF_SAMPLES = 300;\n+    public static final int DEFAULT_NO_OF_RETRIES = 3;\n+    private static final boolean DEFAULT_ADAPT_DATASET_VARIANCE = false;\n+    private static final PerturbationContext DEFAULT_PERTURBATION_CONTEXT = new PerturbationContext(new SecureRandom(), 1);\n+\n+    /**\n+     * No. of samples to be generated for the local linear model training\n+     */\n+    private int noOfSamples = DEFAULT_NO_OF_SAMPLES;\n+\n+    /**\n+     * No. of retries while trying to find a (linearly) separable dataset\n+     */\n+    private int noOfRetries = DEFAULT_NO_OF_RETRIES;\n+\n+    /**\n+     * Context object for perturbing features\n+     */\n+    private PerturbationContext perturbationContext = DEFAULT_PERTURBATION_CONTEXT;", "originalCommit": "cab8f5ebbb3bb79b71549bb13864ddd6fdb29ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE3MzUwMA==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r522173500", "body": "Please fix formatting", "bodyText": "Please fix formatting", "bodyHTML": "<p dir=\"auto\">Please fix formatting</p>", "author": "danielezonca", "createdAt": "2020-11-12T15:02:59Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/local/lime/LimeExplainer.java", "diffHunk": "@@ -142,9 +106,9 @@ public int getNoOfRetries() {\n             PredictionInput targetInput,\n             List<Feature> linearizedTargetInputFeatures,\n             List<Output> actualOutputs,\n-            int noOfRetries) {\n+            int noOfRetries, int noOfSamples, PerturbationContext perturbationContext) {", "originalCommit": "cab8f5ebbb3bb79b71549bb13864ddd6fdb29ff7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e315a461165a1fde2ca275c735264a837453c353", "url": "https://github.com/kiegroup/kogito-apps/commit/e315a461165a1fde2ca275c735264a837453c353", "message": "Update explainability/explainability-core/src/main/java/org/kie/kogito/explainability/local/lime/LimeConfig.java\n\nCo-authored-by: Daniele Zonca <dzonca@redhat.com>", "committedDate": "2020-11-13T07:14:42Z", "type": "commit"}, {"oid": "adf6fe6cb4848329f3fafb85717fda61495cef73", "url": "https://github.com/kiegroup/kogito-apps/commit/adf6fe6cb4848329f3fafb85717fda61495cef73", "message": "KOGITO-3769 - fixed formatting", "committedDate": "2020-11-13T07:46:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1NTE4MQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r527055181", "body": "What about move this to `LimeConfig` too? Or do you prefer to have this hardcoded?", "bodyText": "What about move this to LimeConfig too? Or do you prefer to have this hardcoded?", "bodyHTML": "<p dir=\"auto\">What about move this to <code>LimeConfig</code> too? Or do you prefer to have this hardcoded?</p>", "author": "danielezonca", "createdAt": "2020-11-19T17:09:22Z", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/local/lime/LimeExplainer.java", "diffHunk": "@@ -58,59 +56,21 @@\n  */\n public class LimeExplainer implements LocalExplainer<Map<String, Saliency>> {\n \n-    public static final int DEFAULT_NO_OF_RETRIES = 3;\n     public static final double SEPARABLE_DATASET_RATIO = 0.99;", "originalCommit": "adf6fe6cb4848329f3fafb85717fda61495cef73", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA3NDc4MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r527074780", "bodyText": "sounds good \ud83d\udc4d", "author": "tteofili", "createdAt": "2020-11-19T17:38:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1NTE4MQ=="}], "type": "inlineReview"}, {"oid": "ddfc44fec8084566ed19a8f37bc019d1e8dca071", "url": "https://github.com/kiegroup/kogito-apps/commit/ddfc44fec8084566ed19a8f37bc019d1e8dca071", "message": "KOGITO-3769 - separable dataset ratio in LimeConfig", "committedDate": "2020-11-19T17:38:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2MzY3Ng==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r529263676", "body": "Is `SecureRandom()` going to make this test non deterministic? ", "bodyText": "Is SecureRandom() going to make this test non deterministic?", "bodyHTML": "<p dir=\"auto\">Is <code>SecureRandom()</code> going to make this test non deterministic?</p>", "author": "r00ta", "createdAt": "2020-11-24T07:47:26Z", "path": "explainability/explainability-integrationtests/explainability-integrationtests-pmml/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/pmml/PmmlLimeExplainerTest.java", "diffHunk": "@@ -107,7 +113,10 @@ void testPMMLRegressionCategorical() throws Exception {\n         features.add(FeatureFactory.newCategoricalFeature(\"mapY\", \"classB\"));\n         PredictionInput input = new PredictionInput(features);\n \n-        LimeExplainer limeExplainer = new LimeExplainer(10, 1);\n+        LimeConfig limeConfig = new LimeConfig()\n+                .withSamples(10)\n+                .withPerturbationContext(new PerturbationContext(new SecureRandom(), 1));", "originalCommit": "ddfc44fec8084566ed19a8f37bc019d1e8dca071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg1OTM3OQ==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r530859379", "bodyText": "correct, I've set it back to use Random with a fixed seed.", "author": "tteofili", "createdAt": "2020-11-26T08:44:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2MzY3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2MzczNw==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r529263737", "body": "Is `SecureRandom()` going to make this test non deterministic? ", "bodyText": "Is SecureRandom() going to make this test non deterministic?", "bodyHTML": "<p dir=\"auto\">Is <code>SecureRandom()</code> going to make this test non deterministic?</p>", "author": "r00ta", "createdAt": "2020-11-24T07:47:32Z", "path": "explainability/explainability-integrationtests/explainability-integrationtests-pmml/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/pmml/PmmlLimeExplainerTest.java", "diffHunk": "@@ -141,7 +150,10 @@ void testPMMLScorecardCategorical() throws Exception {\n         features.add(FeatureFactory.newCategoricalFeature(\"input2\", \"classB\"));\n         PredictionInput input = new PredictionInput(features);\n \n-        LimeExplainer limeExplainer = new LimeExplainer(10, 1);\n+        LimeConfig limeConfig = new LimeConfig()\n+                .withSamples(10)\n+                .withPerturbationContext(new PerturbationContext(new SecureRandom(), 1));", "originalCommit": "ddfc44fec8084566ed19a8f37bc019d1e8dca071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg1OTQ3MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r530859470", "bodyText": "correct, I've set it back to use Random with a fixed seed.", "author": "tteofili", "createdAt": "2020-11-26T08:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2MzczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2MzkzNA==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r529263934", "body": "Is `SecureRandom()` going to make this test non deterministic? ", "bodyText": "Is SecureRandom() going to make this test non deterministic?", "bodyHTML": "<p dir=\"auto\">Is <code>SecureRandom()</code> going to make this test non deterministic?</p>", "author": "r00ta", "createdAt": "2020-11-24T07:48:00Z", "path": "explainability/explainability-integrationtests/explainability-integrationtests-dmn/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/dmn/FraudScoringDmnLimeExplainerTest.java", "diffHunk": "@@ -77,7 +80,10 @@ void testFraudScoringDMNExplanation() throws ExecutionException, InterruptedExce\n         List<PredictionOutput> predictionOutputs = model.predictAsync(List.of(predictionInput))\n                 .get(Config.INSTANCE.getAsyncTimeout(), Config.INSTANCE.getAsyncTimeUnit());\n         Prediction prediction = new Prediction(predictionInput, predictionOutputs.get(0));\n-        LimeExplainer limeExplainer = new LimeExplainer(100, 5);\n+        LimeConfig limeConfig = new LimeConfig()\n+                .withSamples(100)\n+                .withPerturbationContext(new PerturbationContext(new SecureRandom(), 5));", "originalCommit": "ddfc44fec8084566ed19a8f37bc019d1e8dca071", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDg2MDI0MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/529#discussion_r530860240", "bodyText": "correct, I've set it back to use Random with a fixed seed.", "author": "tteofili", "createdAt": "2020-11-26T08:45:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2MzkzNA=="}], "type": "inlineReview"}, {"oid": "64dae1d2d1b850ac8e2c434d74375dcb90467e24", "url": "https://github.com/kiegroup/kogito-apps/commit/64dae1d2d1b850ac8e2c434d74375dcb90467e24", "message": "KOGITO-3769 - made PmmlLimeExplainerTest deterministic", "committedDate": "2020-11-26T08:43:46Z", "type": "commit"}, {"oid": "aee676741b1c0775435d558507246080ddf4ab20", "url": "https://github.com/kiegroup/kogito-apps/commit/aee676741b1c0775435d558507246080ddf4ab20", "message": "KOGITO-3769 - made FraudScoringDmnLimeExplainerTest deterministic", "committedDate": "2020-11-26T08:45:30Z", "type": "commit"}]}