{"pr_number": 469, "pr_title": "[Jobs Service] reschedule operarion on patch API + attributes restriction", "pr_author": "tiagodolphine", "pr_createdAt": "2020-10-01T20:04:39Z", "pr_url": "https://github.com/kiegroup/kogito-apps/pull/469", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MzU4NA==", "url": "https://github.com/kiegroup/kogito-apps/pull/469#discussion_r498653584", "body": "```suggestion\r\n            throw new IllegalArgumentException(\"Patch can only be applied to the Job scheduling trigger attributes\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Patch an only be applied to the Job scheduling trigger attributes\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Patch can only be applied to the Job scheduling trigger attributes\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"93\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalArgumentException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Patch <span class=\"x x-first x-last\">an</span> only be applied to the Job scheduling trigger attributes<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"93\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">throw</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">IllegalArgumentException</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Patch <span class=\"x x-first x-last\">can</span> only be applied to the Job scheduling trigger attributes<span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "sutaakar", "createdAt": "2020-10-02T07:21:12Z", "path": "jobs-service/src/main/java/org/kie/kogito/jobs/service/resource/JobResource.java", "diffHunk": "@@ -73,13 +76,28 @@\n     @Path(\"/{id}\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @Consumes(MediaType.APPLICATION_JSON)\n-    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) {\n+    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) throws Exception {\n         LOGGER.debug(\"REST patch update {}\", job);\n-        return jobRepository.merge(id, ScheduledJobAdapter.to(ScheduledJobBuilder.from(job)))\n-                .thenApply(result -> Optional\n-                        .ofNullable(result)\n-                        .map(ScheduledJobAdapter::of)\n-                        .orElseThrow(() -> new NotFoundException(\"Job not found \" + job)));\n+        JobDetails jobToBeMerged = ScheduledJobAdapter.to(ScheduledJobBuilder.from(job));\n+        //validating allowed patch attributes\n+        if (Objects.nonNull(jobToBeMerged.getPayload())\n+                || StringUtils.isNotEmpty(jobToBeMerged.getId())\n+                || StringUtils.isNotEmpty(jobToBeMerged.getScheduledId())\n+                || StringUtils.isNotEmpty(jobToBeMerged.getCorrelationId())\n+                || (Objects.nonNull(jobToBeMerged.getExecutionCounter()) && jobToBeMerged.getExecutionCounter() > 0)\n+                || Objects.nonNull(jobToBeMerged.getPriority())\n+                || (Objects.nonNull(jobToBeMerged.getRetries()) && jobToBeMerged.getRetries() > 0)\n+                || Objects.nonNull(jobToBeMerged.getRecipient())\n+                || Objects.nonNull(jobToBeMerged.getStatus())\n+        ) {\n+            throw new IllegalArgumentException(\"Patch an only be applied to the Job scheduling trigger attributes\");", "originalCommit": "37d3f63239cc7aa0c042616a0fa179f4287ffcf0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1ODExMg==", "url": "https://github.com/kiegroup/kogito-apps/pull/469#discussion_r498658112", "body": "Wouldn't it have more sense to pass directly Trigger as a request body? That way you can skip these checks.", "bodyText": "Wouldn't it have more sense to pass directly Trigger as a request body? That way you can skip these checks.", "bodyHTML": "<p dir=\"auto\">Wouldn't it have more sense to pass directly Trigger as a request body? That way you can skip these checks.</p>", "author": "sutaakar", "createdAt": "2020-10-02T07:32:35Z", "path": "jobs-service/src/main/java/org/kie/kogito/jobs/service/resource/JobResource.java", "diffHunk": "@@ -73,13 +76,28 @@\n     @Path(\"/{id}\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @Consumes(MediaType.APPLICATION_JSON)\n-    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) {\n+    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) throws Exception {\n         LOGGER.debug(\"REST patch update {}\", job);\n-        return jobRepository.merge(id, ScheduledJobAdapter.to(ScheduledJobBuilder.from(job)))\n-                .thenApply(result -> Optional\n-                        .ofNullable(result)\n-                        .map(ScheduledJobAdapter::of)\n-                        .orElseThrow(() -> new NotFoundException(\"Job not found \" + job)));\n+        JobDetails jobToBeMerged = ScheduledJobAdapter.to(ScheduledJobBuilder.from(job));\n+        //validating allowed patch attributes", "originalCommit": "37d3f63239cc7aa0c042616a0fa179f4287ffcf0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1MDY1MA==", "url": "https://github.com/kiegroup/kogito-apps/pull/469#discussion_r498750650", "bodyText": "@sutaakar it would make sense but if you look at the API the Trigger is not exposed, instead, we have the ScheduledJob class that is exposed in the REST endpoint the idea is to migrate to have the new model JobDetails + Trigger into the REST endpoints but for now, we are not exposing this new model. Thas's why there is the ScheduledJobAdapter class to translate the models.", "author": "tiagodolphine", "createdAt": "2020-10-02T10:50:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1ODExMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxNTM5Mw==", "url": "https://github.com/kiegroup/kogito-apps/pull/469#discussion_r498815393", "bodyText": "ok, thanks", "author": "sutaakar", "createdAt": "2020-10-02T13:18:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1ODExMg=="}], "type": "inlineReview"}, {"oid": "8ad31ae799d019b635b2d8f976ed36d559f35524", "url": "https://github.com/kiegroup/kogito-apps/commit/8ad31ae799d019b635b2d8f976ed36d559f35524", "message": "Adding missing config files for infinispan on docker-compose, for testing", "committedDate": "2020-10-02T17:07:58Z", "type": "forcePushed"}, {"oid": "548158ffe7be1ec53876f30b979e4d8d93ac5576", "url": "https://github.com/kiegroup/kogito-apps/commit/548158ffe7be1ec53876f30b979e4d8d93ac5576", "message": "Adding missing config files for infinispan on docker-compose, for testing\n\nadjusting docker-compose file", "committedDate": "2020-10-02T17:30:33Z", "type": "forcePushed"}, {"oid": "4c9b13d8ef5736dda426db2134d419cdb96e4d8f", "url": "https://github.com/kiegroup/kogito-apps/commit/4c9b13d8ef5736dda426db2134d419cdb96e4d8f", "message": "[Jobs Service] reschedule operarion on patch API + attributes restriction", "committedDate": "2020-10-05T13:14:50Z", "type": "commit"}, {"oid": "e21e85c71461afcadc358af657992deacb9c18f8", "url": "https://github.com/kiegroup/kogito-apps/commit/e21e85c71461afcadc358af657992deacb9c18f8", "message": "Adding missing config files for infinispan on docker-compose, for testing\n\nadjusting docker-compose file", "committedDate": "2020-10-05T13:14:51Z", "type": "commit"}, {"oid": "63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "url": "https://github.com/kiegroup/kogito-apps/commit/63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "message": "fix sonar smells", "committedDate": "2020-10-05T13:14:51Z", "type": "commit"}, {"oid": "63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "url": "https://github.com/kiegroup/kogito-apps/commit/63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "message": "fix sonar smells", "committedDate": "2020-10-05T13:14:51Z", "type": "forcePushed"}]}