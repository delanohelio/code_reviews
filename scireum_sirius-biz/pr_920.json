{"pr_number": 920, "pr_title": "Provides a minimal Redis management / query UI", "pr_author": "andyHa", "pr_createdAt": "2020-11-23T15:05:50Z", "pr_url": "https://github.com/scireum/sirius-biz/pull/920", "timeline": [{"oid": "17854a2566429e295ac002bea54dd339e228676e", "url": "https://github.com/scireum/sirius-biz/commit/17854a2566429e295ac002bea54dd339e228676e", "message": "Uses a more modern approach to directly output an error message.", "committedDate": "2020-11-23T15:03:13Z", "type": "commit"}, {"oid": "750e80f1c0e4aa48023c07f2698ff2edada75aa9", "url": "https://github.com/scireum/sirius-biz/commit/750e80f1c0e4aa48023c07f2698ff2edada75aa9", "message": "Removes debugging code.", "committedDate": "2020-11-23T15:03:26Z", "type": "commit"}, {"oid": "85ebaf4706917abe6aa8458b8e4855af413ca5de", "url": "https://github.com/scireum/sirius-biz/commit/85ebaf4706917abe6aa8458b8e4855af413ca5de", "message": "Provides a minimal Redis management / query UI.", "committedDate": "2020-11-23T15:05:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3NDg1Ng==", "url": "https://github.com/scireum/sirius-biz/pull/920#discussion_r528774856", "body": "ctx -> webContext", "bodyText": "ctx -> webContext", "bodyHTML": "<p dir=\"auto\">ctx -&gt; webContext</p>", "author": "sabieber", "createdAt": "2020-11-23T15:13:17Z", "path": "src/main/java/sirius/biz/util/RedisController.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.util;\n+\n+import redis.clients.jedis.util.SafeEncoder;\n+import sirius.biz.tenants.TenantUserManager;\n+import sirius.biz.web.BizController;\n+import sirius.db.redis.Redis;\n+import sirius.db.redis.RedisDB;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Watch;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.controller.Routed;\n+import sirius.web.health.console.CommandParser;\n+import sirius.web.http.WebContext;\n+import sirius.web.security.Permission;\n+import sirius.web.services.JSONStructuredOutput;\n+\n+import java.util.List;\n+\n+/**\n+ * Provides the management GUI for Redis related activities.\n+ */\n+@Register\n+public class RedisController extends BizController {\n+\n+    public static final String[] EMPTY_STRING_ARRAY = new String[0];\n+    @Part\n+    private Redis redis;\n+\n+    /**\n+     * Renders the query template.\n+     *\n+     * @param webContext the request to respond to\n+     */\n+    @Permission(TenantUserManager.PERMISSION_SYSTEM_ADMINISTRATOR)\n+    @Routed(\"/system/redis\")\n+    public void redis(WebContext webContext) {\n+        webContext.respondWith().template(\"/templates/biz/model/redis.html.pasta\", redis.getPools(), Redis.POOL_SYSTEM);\n+    }\n+\n+    /**\n+     * Executes the given Redis query.\n+     *\n+     * @param ctx the current request\n+     * @param out the JSON response\n+     */\n+    @Permission(TenantUserManager.PERMISSION_SYSTEM_ADMINISTRATOR)\n+    @Routed(value = \"/system/redis/api/execute\", jsonCall = true)\n+    public void executeQuery(WebContext ctx, JSONStructuredOutput out) {", "originalCommit": "85ebaf4706917abe6aa8458b8e4855af413ca5de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3NTY5Nw==", "url": "https://github.com/scireum/sirius-biz/pull/920#discussion_r528775697", "body": "```suggestion\r\n        StringBuilder resultBuilder = new StringBuilder();\r\n        renderResult(result, \"\", resultBuilder);\r\n        out.property(\"result\", resultBuilder.toString());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    StringBuilder sb = new StringBuilder();\n          \n          \n            \n                    renderResult(result, \"\", sb);\n          \n          \n            \n                    out.property(\"result\", sb.toString());\n          \n          \n            \n                    StringBuilder resultBuilder = new StringBuilder();\n          \n          \n            \n                    renderResult(result, \"\", resultBuilder);\n          \n          \n            \n                    out.property(\"result\", resultBuilder.toString());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-smi\">StringBuilder</span> <span class=\"x x-first x-last\">sb</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">StringBuilder</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        renderResult(result, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">sb</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        out<span class=\"pl-k\">.</span>property(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>result<span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>toString());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-smi\">StringBuilder</span> <span class=\"x x-first x-last\">resultBuilder</span> <span class=\"pl-k\">=</span> <span class=\"pl-k\">new</span> <span class=\"pl-smi\">StringBuilder</span>();</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        renderResult(result, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">resultBuilder</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        out<span class=\"pl-k\">.</span>property(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>result<span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>toString());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "sabieber", "createdAt": "2020-11-23T15:14:24Z", "path": "src/main/java/sirius/biz/util/RedisController.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.util;\n+\n+import redis.clients.jedis.util.SafeEncoder;\n+import sirius.biz.tenants.TenantUserManager;\n+import sirius.biz.web.BizController;\n+import sirius.db.redis.Redis;\n+import sirius.db.redis.RedisDB;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Watch;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.controller.Routed;\n+import sirius.web.health.console.CommandParser;\n+import sirius.web.http.WebContext;\n+import sirius.web.security.Permission;\n+import sirius.web.services.JSONStructuredOutput;\n+\n+import java.util.List;\n+\n+/**\n+ * Provides the management GUI for Redis related activities.\n+ */\n+@Register\n+public class RedisController extends BizController {\n+\n+    public static final String[] EMPTY_STRING_ARRAY = new String[0];\n+    @Part\n+    private Redis redis;\n+\n+    /**\n+     * Renders the query template.\n+     *\n+     * @param webContext the request to respond to\n+     */\n+    @Permission(TenantUserManager.PERMISSION_SYSTEM_ADMINISTRATOR)\n+    @Routed(\"/system/redis\")\n+    public void redis(WebContext webContext) {\n+        webContext.respondWith().template(\"/templates/biz/model/redis.html.pasta\", redis.getPools(), Redis.POOL_SYSTEM);\n+    }\n+\n+    /**\n+     * Executes the given Redis query.\n+     *\n+     * @param ctx the current request\n+     * @param out the JSON response\n+     */\n+    @Permission(TenantUserManager.PERMISSION_SYSTEM_ADMINISTRATOR)\n+    @Routed(value = \"/system/redis/api/execute\", jsonCall = true)\n+    public void executeQuery(WebContext ctx, JSONStructuredOutput out) {\n+        Watch watch = Watch.start();\n+\n+        String database = ctx.get(\"pool\").asString(Redis.POOL_SYSTEM);\n+        RedisDB pool = redis.getPool(database);\n+        String query = ctx.get(\"query\").asString();\n+\n+        Object result = pool.query(() -> \"Executing query via /system/redis\", db -> {\n+            try {\n+                CommandParser parser = new CommandParser(query);\n+                db.getClient().sendCommand(() -> SafeEncoder.encode(parser.parseCommand()), parser.getArgArray());\n+\n+                return db.getClient().getOne();\n+            } catch (Exception e) {\n+                // In case of an invalid query, we do not want to log this into the syslog but\n+                // rather just directly output the message to the user....\n+                throw Exceptions.createHandled().error(e).withDirectMessage(e.getMessage()).handle();\n+            }\n+        });\n+        StringBuilder sb = new StringBuilder();\n+        renderResult(result, \"\", sb);\n+        out.property(\"result\", sb.toString());", "originalCommit": "85ebaf4706917abe6aa8458b8e4855af413ca5de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc3NjM0OQ==", "url": "https://github.com/scireum/sirius-biz/pull/920#discussion_r528776349", "body": "```suggestion\r\n    private void renderResult(Object result, String offset, StringBuilder resultBuilder) {\r\n        if (result instanceof List) {\r\n            List<?> results = (List<?>) result;\r\n            for (int i = 0; i < results.size(); i++) {\r\n                if (i > 0) {\r\n                    resultBuilder.append(offset);\r\n                }\r\n                resultBuilder.append(Strings.apply(\"%2d\", i + 1));\r\n                resultBuilder.append(\") \");\r\n                renderResult(results.get(i), offset + \"    \", resultBuilder);\r\n            }\r\n        } else if (result instanceof byte[]) {\r\n            resultBuilder.append(SafeEncoder.encode((byte[]) result));\r\n            resultBuilder.append(\"\\n\");\r\n        } else {\r\n            resultBuilder.append(NLS.toUserString(result));\r\n            resultBuilder.append(\"\\n\");\r\n        }\r\n    }\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void renderResult(Object result, String offset, StringBuilder sb) {\n          \n          \n            \n                    if (result instanceof List) {\n          \n          \n            \n                        List<?> results = (List<?>) result;\n          \n          \n            \n                        for (int i = 0; i < results.size(); i++) {\n          \n          \n            \n                            if (i > 0) {\n          \n          \n            \n                                sb.append(offset);\n          \n          \n            \n                            }\n          \n          \n            \n                            sb.append(Strings.apply(\"%2d\", i + 1));\n          \n          \n            \n                            sb.append(\") \");\n          \n          \n            \n                            renderResult(results.get(i), offset + \"    \", sb);\n          \n          \n            \n                        }\n          \n          \n            \n                    } else if (result instanceof byte[]) {\n          \n          \n            \n                        sb.append(SafeEncoder.encode((byte[]) result));\n          \n          \n            \n                        sb.append(\"\\n\");\n          \n          \n            \n                    } else {\n          \n          \n            \n                        sb.append(NLS.toUserString(result));\n          \n          \n            \n                        sb.append(\"\\n\");\n          \n          \n            \n                    }\n          \n          \n            \n                }\n          \n          \n            \n                private void renderResult(Object result, String offset, StringBuilder resultBuilder) {\n          \n          \n            \n                    if (result instanceof List) {\n          \n          \n            \n                        List<?> results = (List<?>) result;\n          \n          \n            \n                        for (int i = 0; i < results.size(); i++) {\n          \n          \n            \n                            if (i > 0) {\n          \n          \n            \n                                resultBuilder.append(offset);\n          \n          \n            \n                            }\n          \n          \n            \n                            resultBuilder.append(Strings.apply(\"%2d\", i + 1));\n          \n          \n            \n                            resultBuilder.append(\") \");\n          \n          \n            \n                            renderResult(results.get(i), offset + \"    \", resultBuilder);\n          \n          \n            \n                        }\n          \n          \n            \n                    } else if (result instanceof byte[]) {\n          \n          \n            \n                        resultBuilder.append(SafeEncoder.encode((byte[]) result));\n          \n          \n            \n                        resultBuilder.append(\"\\n\");\n          \n          \n            \n                    } else {\n          \n          \n            \n                        resultBuilder.append(NLS.toUserString(result));\n          \n          \n            \n                        resultBuilder.append(\"\\n\");\n          \n          \n            \n                    }\n          \n          \n            \n                }", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"102\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> renderResult(<span class=\"pl-smi\">Object</span> result, <span class=\"pl-smi\">String</span> offset, <span class=\"pl-smi\">StringBuilder</span> <span class=\"x x-first x-last\">sb</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"103\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        <span class=\"pl-k\">if</span> (result <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">List</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"104\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">List&lt;?&gt;</span> results <span class=\"pl-k\">=</span> (<span class=\"pl-k\">List&lt;?&gt;</span>) result;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"105\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-k\">for</span> (<span class=\"pl-k\">int</span> i <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>; i <span class=\"pl-k\">&lt;</span> results<span class=\"pl-k\">.</span>size(); i<span class=\"pl-k\">++</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"106\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">if</span> (i <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"107\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>append(offset);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"108\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"109\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>append(<span class=\"pl-smi\">Strings</span><span class=\"pl-k\">.</span>apply(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>%2d<span class=\"pl-pds\">\"</span></span>, i <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1</span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"110\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>) <span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"111\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                renderResult(results<span class=\"pl-k\">.</span>get(i), offset <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>    <span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">sb</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"112\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"113\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (result <span class=\"pl-k\">instanceof</span> <span class=\"pl-k\">byte</span>[]) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"114\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>append(<span class=\"pl-smi\">SafeEncoder</span><span class=\"pl-k\">.</span>encode((<span class=\"pl-k\">byte</span>[]) result));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"115\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"116\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"117\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>append(<span class=\"pl-c1\">NLS</span><span class=\"pl-k\">.</span>toUserString(result));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"118\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"x x-first x-last\">sb</span><span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"119\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"120\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">    }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"102\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    <span class=\"pl-k\">private</span> <span class=\"pl-k\">void</span> renderResult(<span class=\"pl-smi\">Object</span> result, <span class=\"pl-smi\">String</span> offset, <span class=\"pl-smi\">StringBuilder</span> <span class=\"x x-first x-last\">resultBuilder</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"103\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        <span class=\"pl-k\">if</span> (result <span class=\"pl-k\">instanceof</span> <span class=\"pl-smi\">List</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"104\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">List&lt;?&gt;</span> results <span class=\"pl-k\">=</span> (<span class=\"pl-k\">List&lt;?&gt;</span>) result;</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"105\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-k\">for</span> (<span class=\"pl-k\">int</span> i <span class=\"pl-k\">=</span> <span class=\"pl-c1\">0</span>; i <span class=\"pl-k\">&lt;</span> results<span class=\"pl-k\">.</span>size(); i<span class=\"pl-k\">++</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"106\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">if</span> (i <span class=\"pl-k\">&gt;</span> <span class=\"pl-c1\">0</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"107\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>append(offset);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"108\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"109\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>append(<span class=\"pl-smi\">Strings</span><span class=\"pl-k\">.</span>apply(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>%2d<span class=\"pl-pds\">\"</span></span>, i <span class=\"pl-k\">+</span> <span class=\"pl-c1\">1</span>));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"110\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>) <span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"111\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                renderResult(results<span class=\"pl-k\">.</span>get(i), offset <span class=\"pl-k\">+</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>    <span class=\"pl-pds\">\"</span></span>, <span class=\"x x-first x-last\">resultBuilder</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"112\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"113\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        } <span class=\"pl-k\">else</span> <span class=\"pl-k\">if</span> (result <span class=\"pl-k\">instanceof</span> <span class=\"pl-k\">byte</span>[]) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"114\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>append(<span class=\"pl-smi\">SafeEncoder</span><span class=\"pl-k\">.</span>encode((<span class=\"pl-k\">byte</span>[]) result));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"115\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"116\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"117\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>append(<span class=\"pl-c1\">NLS</span><span class=\"pl-k\">.</span>toUserString(result));</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"118\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"x x-first x-last\">resultBuilder</span><span class=\"pl-k\">.</span>append(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-cce\">\\n</span><span class=\"pl-pds\">\"</span></span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"119\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">        }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"120\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">    }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "sabieber", "createdAt": "2020-11-23T15:15:11Z", "path": "src/main/java/sirius/biz/util/RedisController.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Made with all the love in the world\n+ * by scireum in Remshalden, Germany\n+ *\n+ * Copyright by scireum GmbH\n+ * http://www.scireum.de - info@scireum.de\n+ */\n+\n+package sirius.biz.util;\n+\n+import redis.clients.jedis.util.SafeEncoder;\n+import sirius.biz.tenants.TenantUserManager;\n+import sirius.biz.web.BizController;\n+import sirius.db.redis.Redis;\n+import sirius.db.redis.RedisDB;\n+import sirius.kernel.commons.Strings;\n+import sirius.kernel.commons.Watch;\n+import sirius.kernel.di.std.Part;\n+import sirius.kernel.di.std.Register;\n+import sirius.kernel.health.Exceptions;\n+import sirius.kernel.nls.NLS;\n+import sirius.web.controller.Routed;\n+import sirius.web.health.console.CommandParser;\n+import sirius.web.http.WebContext;\n+import sirius.web.security.Permission;\n+import sirius.web.services.JSONStructuredOutput;\n+\n+import java.util.List;\n+\n+/**\n+ * Provides the management GUI for Redis related activities.\n+ */\n+@Register\n+public class RedisController extends BizController {\n+\n+    public static final String[] EMPTY_STRING_ARRAY = new String[0];\n+    @Part\n+    private Redis redis;\n+\n+    /**\n+     * Renders the query template.\n+     *\n+     * @param webContext the request to respond to\n+     */\n+    @Permission(TenantUserManager.PERMISSION_SYSTEM_ADMINISTRATOR)\n+    @Routed(\"/system/redis\")\n+    public void redis(WebContext webContext) {\n+        webContext.respondWith().template(\"/templates/biz/model/redis.html.pasta\", redis.getPools(), Redis.POOL_SYSTEM);\n+    }\n+\n+    /**\n+     * Executes the given Redis query.\n+     *\n+     * @param ctx the current request\n+     * @param out the JSON response\n+     */\n+    @Permission(TenantUserManager.PERMISSION_SYSTEM_ADMINISTRATOR)\n+    @Routed(value = \"/system/redis/api/execute\", jsonCall = true)\n+    public void executeQuery(WebContext ctx, JSONStructuredOutput out) {\n+        Watch watch = Watch.start();\n+\n+        String database = ctx.get(\"pool\").asString(Redis.POOL_SYSTEM);\n+        RedisDB pool = redis.getPool(database);\n+        String query = ctx.get(\"query\").asString();\n+\n+        Object result = pool.query(() -> \"Executing query via /system/redis\", db -> {\n+            try {\n+                CommandParser parser = new CommandParser(query);\n+                db.getClient().sendCommand(() -> SafeEncoder.encode(parser.parseCommand()), parser.getArgArray());\n+\n+                return db.getClient().getOne();\n+            } catch (Exception e) {\n+                // In case of an invalid query, we do not want to log this into the syslog but\n+                // rather just directly output the message to the user....\n+                throw Exceptions.createHandled().error(e).withDirectMessage(e.getMessage()).handle();\n+            }\n+        });\n+        StringBuilder sb = new StringBuilder();\n+        renderResult(result, \"\", sb);\n+        out.property(\"result\", sb.toString());\n+        out.property(\"duration\", watch.duration());\n+    }\n+\n+    private void renderResult(Object result, String offset, StringBuilder sb) {\n+        if (result instanceof List) {\n+            List<?> results = (List<?>) result;\n+            for (int i = 0; i < results.size(); i++) {\n+                if (i > 0) {\n+                    sb.append(offset);\n+                }\n+                sb.append(Strings.apply(\"%2d\", i + 1));\n+                sb.append(\") \");\n+                renderResult(results.get(i), offset + \"    \", sb);\n+            }\n+        } else if (result instanceof byte[]) {\n+            sb.append(SafeEncoder.encode((byte[]) result));\n+            sb.append(\"\\n\");\n+        } else {\n+            sb.append(NLS.toUserString(result));\n+            sb.append(\"\\n\");\n+        }\n+    }", "originalCommit": "85ebaf4706917abe6aa8458b8e4855af413ca5de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d9e3356ce07266e5e1cade60ed1349bb0454b0ea", "url": "https://github.com/scireum/sirius-biz/commit/d9e3356ce07266e5e1cade60ed1349bb0454b0ea", "message": "Update src/main/java/sirius/biz/util/RedisController.java\n\nCo-authored-by: Sascha Bieberstein <sabieber@users.noreply.github.com>", "committedDate": "2020-11-24T19:53:35Z", "type": "commit"}, {"oid": "fc37919c19119318ab173b1d0de62980e1361cc6", "url": "https://github.com/scireum/sirius-biz/commit/fc37919c19119318ab173b1d0de62980e1361cc6", "message": "Update src/main/java/sirius/biz/util/RedisController.java\n\nCo-authored-by: Sascha Bieberstein <sabieber@users.noreply.github.com>", "committedDate": "2020-11-24T19:53:42Z", "type": "commit"}, {"oid": "ea1201c594a7447e1d7430164b42964bbf78c018", "url": "https://github.com/scireum/sirius-biz/commit/ea1201c594a7447e1d7430164b42964bbf78c018", "message": "Uses a proper variable/parameter name.", "committedDate": "2020-11-24T19:54:47Z", "type": "commit"}, {"oid": "a891a3ad0444006e68697f8dc34516aed821e542", "url": "https://github.com/scireum/sirius-biz/commit/a891a3ad0444006e68697f8dc34516aed821e542", "message": "Merge remote-tracking branch 'origin/master' into aha/redis-ui", "committedDate": "2020-11-26T08:10:34Z", "type": "commit"}, {"oid": "774fdcfcd663aa6e64e2975411fb03303888059e", "url": "https://github.com/scireum/sirius-biz/commit/774fdcfcd663aa6e64e2975411fb03303888059e", "message": "Merge remote-tracking branch 'origin/master' into aha/redis-ui", "committedDate": "2020-11-26T08:19:57Z", "type": "commit"}, {"oid": "8a81c0abd1402035dd068d65a966596071eb168d", "url": "https://github.com/scireum/sirius-biz/commit/8a81c0abd1402035dd068d65a966596071eb168d", "message": "Adds a missing i18n key.", "committedDate": "2020-11-26T08:34:38Z", "type": "commit"}]}