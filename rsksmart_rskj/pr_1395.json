{"pr_number": 1395, "pr_title": "Added Peg-in rejection events", "pr_author": "Vovchyk", "pr_createdAt": "2020-12-22T15:38:19Z", "pr_url": "https://github.com/rsksmart/rskj/pull/1395", "timeline": [{"oid": "e5684be3306fc3c948c9e9118e0ab02254d5fb5c", "url": "https://github.com/rsksmart/rskj/commit/e5684be3306fc3c948c9e9118e0ab02254d5fb5c", "message": "Added unit tests", "committedDate": "2020-12-30T09:39:42Z", "type": "forcePushed"}, {"oid": "9a52062f5feeec9add508bb68f2b820527829e48", "url": "https://github.com/rsksmart/rskj/commit/9a52062f5feeec9add508bb68f2b820527829e48", "message": "Added unit tests", "committedDate": "2021-01-22T14:15:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjcyNTkzOA==", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r562725938", "body": "Could we have an explicit test of event having the signature expected by external tools? ie, an assert equals against a calculated hash. So, we could be sure the event is consumible and queryable by external tools, using a code test. My concert is that, if we apply fuzzy testing to the event function code (and then, changing the resulting signature), all these tests could pass in green", "bodyText": "Could we have an explicit test of event having the signature expected by external tools? ie, an assert equals against a calculated hash. So, we could be sure the event is consumible and queryable by external tools, using a code test. My concert is that, if we apply fuzzy testing to the event function code (and then, changing the resulting signature), all these tests could pass in green", "bodyHTML": "<p dir=\"auto\">Could we have an explicit test of event having the signature expected by external tools? ie, an assert equals against a calculated hash. So, we could be sure the event is consumible and queryable by external tools, using a code test. My concert is that, if we apply fuzzy testing to the event function code (and then, changing the resulting signature), all these tests could pass in green</p>", "author": "ajlopezrsk", "createdAt": "2021-01-22T15:51:36Z", "path": "rskj-core/src/test/java/co/rsk/peg/utils/BridgeEventLoggerImplTest.java", "diffHunk": "@@ -625,6 +625,76 @@ public void logReleaseBtcRequested() {\n         Assert.assertArrayEquals(event.encodeEventData(amount.getValue()), result.getData());\n     }\n \n+    @Test\n+    public void logRejectedPegin() {\n+        // Setup event logger\n+        ActivationConfig.ForBlock activations = mock(ActivationConfig.ForBlock.class);\n+        List<LogInfo> eventLogs = new LinkedList<>();\n+\n+        BridgeEventLogger eventLogger = new BridgeEventLoggerImpl(null, activations, eventLogs);\n+\n+        BtcTransaction btcTx = new BtcTransaction(BridgeRegTestConstants.getInstance().getBtcParams());\n+\n+        eventLogger.logRejectedPegin(btcTx, RejectedPeginReason.PEGIN_CAP_SURPASSED);\n+\n+        Assert.assertEquals(1, eventLogs.size());\n+        LogInfo entry = eventLogs.get(0);\n+\n+        Assert.assertEquals(PrecompiledContracts.BRIDGE_ADDR, new RskAddress(entry.getAddress()));\n+\n+        // Assert address that made the log\n+        LogInfo result = eventLogs.get(0);\n+        Assert.assertArrayEquals(PrecompiledContracts.BRIDGE_ADDR.getBytes(), result.getAddress());\n+\n+        // Assert log topics\n+        Assert.assertEquals(2, result.getTopics().size());\n+        CallTransaction.Function event = BridgeEvents.REJECTED_PEGIN.getEvent();\n+\n+        byte[][] topics = event.encodeEventTopics(btcTx.getHash().getBytes());\n+\n+        for (int i=0; i<topics.length; i++) {\n+            Assert.assertArrayEquals(topics[i], result.getTopics().get(i).getData());\n+        }\n+\n+        // Assert log data\n+        Assert.assertArrayEquals(event.encodeEventData(RejectedPeginReason.PEGIN_CAP_SURPASSED.getValue()), result.getData());", "originalCommit": "9a52062f5feeec9add508bb68f2b820527829e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0Njc4MA==", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564046780", "bodyText": "@ajlopezrsk has a good point here. We are doing this though in the integration tests already, so we can leave this comment as tech debt to be solved by the fed team afterwards", "author": "josedahlquist", "createdAt": "2021-01-25T21:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjcyNTkzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0NTM5Ng==", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564045396", "body": "This is not correct.\r\nThe status of RSKIP170 doesn't ensure the pegin was a pegin-v1. pegin v1 and pegin legacy will co exist after Iris activation.\r\nYou can check the type of pegin using the peginInformation object (see https://github.com/rsksmart/rskj/blob/master/rskj-core/src/main/java/co/rsk/peg/PeginInformation.java#L44 )\r\n```suggestion\r\n                if (peginInformation.getProtocolVersion() == 1) {\r\n                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\r\n                } else {\r\n                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\r\n                }\r\n```\r\nThis could be improved by at least encoding the `1` in an enum. What do you think @marcos-iov ?", "bodyText": "This is not correct.\nThe status of RSKIP170 doesn't ensure the pegin was a pegin-v1. pegin v1 and pegin legacy will co exist after Iris activation.\nYou can check the type of pegin using the peginInformation object (see https://github.com/rsksmart/rskj/blob/master/rskj-core/src/main/java/co/rsk/peg/PeginInformation.java#L44 )\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (activations.isActive(ConsensusRule.RSKIP170)) {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n          \n          \n            \n                            } else {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n          \n          \n            \n                            }\n          \n          \n            \n                            if (peginInformation.getProtocolVersion() == 1) {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n          \n          \n            \n                            } else {\n          \n          \n            \n                                eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n          \n          \n            \n                            }\n          \n      \n    \n    \n  \n\nThis could be improved by at least encoding the 1 in an enum. What do you think @marcos-iov ?", "bodyHTML": "<p dir=\"auto\">This is not correct.<br>\nThe status of RSKIP170 doesn't ensure the pegin was a pegin-v1. pegin v1 and pegin legacy will co exist after Iris activation.<br>\nYou can check the type of pegin using the peginInformation object (see <a href=\"https://github.com/rsksmart/rskj/blob/master/rskj-core/src/main/java/co/rsk/peg/PeginInformation.java#L44\">https://github.com/rsksmart/rskj/blob/master/rskj-core/src/main/java/co/rsk/peg/PeginInformation.java#L44</a> )</p>\n  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"504\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                <span class=\"pl-k\">if</span> (<span class=\"x x-first\">activations</span><span class=\"pl-k x\">.</span><span class=\"x\">isActive(</span><span class=\"pl-smi x\">ConsensusRule</span><span class=\"pl-c1\"><span class=\"pl-k x\">.</span><span class=\"x\">RSKIP170</span></span><span class=\"x x-last\">)</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"505\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    eventLogger<span class=\"pl-k\">.</span>logUnrefundablePegin(btcTx, <span class=\"pl-smi\">UnrefundablePeginReason</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>PEGIN_V1_REFUND_ADDRESS_NOT_SET</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"506\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"507\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                    eventLogger<span class=\"pl-k\">.</span>logUnrefundablePegin(btcTx, <span class=\"pl-smi\">UnrefundablePeginReason</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>LEGACY_PEGIN_UNDETERMINED_SENDER</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"508\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                }</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"504\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                <span class=\"pl-k\">if</span> (<span class=\"x x-first\">peginInformation</span><span class=\"pl-k x\">.</span><span class=\"x\">getProtocolVersion() </span><span class=\"pl-k x\">==</span><span class=\"x\"> </span><span class=\"pl-c1 x x-last\">1</span>) {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"505\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    eventLogger<span class=\"pl-k\">.</span>logUnrefundablePegin(btcTx, <span class=\"pl-smi\">UnrefundablePeginReason</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>PEGIN_V1_REFUND_ADDRESS_NOT_SET</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"506\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                } <span class=\"pl-k\">else</span> {</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"507\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                    eventLogger<span class=\"pl-k\">.</span>logUnrefundablePegin(btcTx, <span class=\"pl-smi\">UnrefundablePeginReason</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>LEGACY_PEGIN_UNDETERMINED_SENDER</span>);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"508\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                }</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n\n<p dir=\"auto\">This could be improved by at least encoding the <code>1</code> in an enum. What do you think <a class=\"user-mention\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/marcos-iov/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/marcos-iov\">@marcos-iov</a> ?</p>", "author": "josedahlquist", "createdAt": "2021-01-25T21:10:34Z", "path": "rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java", "diffHunk": "@@ -475,6 +495,14 @@ private void refundTxSender(\n             generateRejectionRelease(btcTx, btcRefundAddress, rskTx, amount);\n         } else {\n             logger.debug(\"[refundTxSender] No btc refund address provided, couldn't get sender address either. Can't refund\");\n+\n+            if (activations.isActive(ConsensusRule.RSKIP181)) {\n+                if (activations.isActive(ConsensusRule.RSKIP170)) {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.PEGIN_V1_REFUND_ADDRESS_NOT_SET);\n+                } else {\n+                    eventLogger.logUnrefundablePegin(btcTx, UnrefundablePeginReason.LEGACY_PEGIN_UNDETERMINED_SENDER);\n+                }", "originalCommit": "9a52062f5feeec9add508bb68f2b820527829e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA3NTExMA==", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564075110", "bodyText": "Good catch! Yes, an enum with the different peg-in protocol versions (0 and 1 for the moment) should do it", "author": "marcos-iov", "createdAt": "2021-01-25T22:04:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0NTM5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQwNDcwNQ==", "url": "https://github.com/rsksmart/rskj/pull/1395#discussion_r564404705", "bodyText": "thanks @josedahlquist. Applied your suggestion.", "author": "Vovchyk", "createdAt": "2021-01-26T10:27:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA0NTM5Ng=="}], "type": "inlineReview"}, {"oid": "ff56ccc6df30888317cb591ee640b27bbf435a95", "url": "https://github.com/rsksmart/rskj/commit/ff56ccc6df30888317cb591ee640b27bbf435a95", "message": "Added Peg-in rejection events", "committedDate": "2021-02-03T13:33:15Z", "type": "commit"}, {"oid": "f3c53bf0fd9d3219295c13af69fb5217bcb92eec", "url": "https://github.com/rsksmart/rskj/commit/f3c53bf0fd9d3219295c13af69fb5217bcb92eec", "message": "Added HF activation logic", "committedDate": "2021-02-03T13:33:15Z", "type": "commit"}, {"oid": "0e0e7e0268a7e00862a308a0c26924049a86e847", "url": "https://github.com/rsksmart/rskj/commit/0e0e7e0268a7e00862a308a0c26924049a86e847", "message": "Added unit tests", "committedDate": "2021-02-03T13:33:15Z", "type": "commit"}, {"oid": "74aebb6abbb880d53d8f185275774e3057d1ae48", "url": "https://github.com/rsksmart/rskj/commit/74aebb6abbb880d53d8f185275774e3057d1ae48", "message": "Update rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n\nCo-authored-by: josedahlquist <jose.dahlquist@gmail.com>", "committedDate": "2021-02-03T13:33:15Z", "type": "commit"}, {"oid": "74aebb6abbb880d53d8f185275774e3057d1ae48", "url": "https://github.com/rsksmart/rskj/commit/74aebb6abbb880d53d8f185275774e3057d1ae48", "message": "Update rskj-core/src/main/java/co/rsk/peg/BridgeSupport.java\n\nCo-authored-by: josedahlquist <jose.dahlquist@gmail.com>", "committedDate": "2021-02-03T13:33:15Z", "type": "forcePushed"}]}