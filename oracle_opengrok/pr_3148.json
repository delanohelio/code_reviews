{"pr_number": 3148, "pr_title": "Fix another batch of Sonar-identified issues", "pr_author": "idodeclare", "pr_createdAt": "2020-05-09T21:38:17Z", "pr_url": "https://github.com/oracle/opengrok/pull/3148", "timeline": [{"oid": "20463cfe62e8d338ddce6727625e7f840d98355f", "url": "https://github.com/oracle/opengrok/commit/20463cfe62e8d338ddce6727625e7f840d98355f", "message": "Fix another batch of Sonar-identified issues\n\n- Sanitize several user-supplied strings.\n- Fix some scope issues.\n- Prohibit XML external access.", "committedDate": "2020-05-09T21:34:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4MzgwMA==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r422883800", "body": "why is this deleted ?", "bodyText": "why is this deleted ?", "bodyHTML": "<p dir=\"auto\">why is this deleted ?</p>", "author": "vladak", "createdAt": "2020-05-11T08:49:54Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/index/PendingFileCompleter.java", "diffHunk": "@@ -561,7 +554,6 @@ private void findFilelessChildren(SkeletonDirs skels, File directory) {\n \n     /**\n      * Counts segments arising from {@code File.separatorChar} or '\\\\'.\n-     * @param path", "originalCommit": "20463cfe62e8d338ddce6727625e7f840d98355f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQwNTEzMg==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r423405132", "bodyText": "Restored with a comment", "author": "idodeclare", "createdAt": "2020-05-12T01:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4MzgwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4NTk2OQ==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r422885969", "body": "reuse the String literal ?", "bodyText": "reuse the String literal ?", "bodyHTML": "<p dir=\"auto\">reuse the String literal ?</p>", "author": "vladak", "createdAt": "2020-05-11T08:53:10Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/web/LaunderUtil.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Chris Fraire <cfraire@me.com>.\n+ */\n+\n+package org.opengrok.indexer.web;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Represents a container for sanitizing methods for avoiding classifications as\n+ * taint bugs.\n+ */\n+public class LaunderUtil {\n+\n+    /**\n+     * Sanitize {@code value} where it will be used in subsequent OpenGrok\n+     * (non-logging) processing.\n+     * @return {@code null} if null or else {@code value} with \"pattern-breaking\n+     * characters\" (tabs, CR, LF, FF) replaced as underscores (one for one)\n+     */\n+    public static String userInput(String value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        return value.replaceAll(\"[\\\\n\\\\r\\\\t\\\\f]\", \"_\");", "originalCommit": "20463cfe62e8d338ddce6727625e7f840d98355f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5MjQxNg==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r422892416", "bodyText": "also, userInput() and luceneQuery() can be refactored into using common underlying method ?", "author": "vladak", "createdAt": "2020-05-11T09:03:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4NTk2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQwNTE2NQ==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r423405165", "bodyText": "Yes done", "author": "idodeclare", "createdAt": "2020-05-12T01:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4NTk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4Njk4MQ==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r422886981", "body": "```suggestion\r\n            String key = logging(entry.getKey());\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String k = logging(entry.getKey());\n          \n          \n            \n                        String key = logging(entry.getKey());", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">            <span class=\"pl-smi\">String</span> <span class=\"x x-first x-last\">k</span> <span class=\"pl-k\">=</span> logging(entry<span class=\"pl-k\">.</span>getKey());</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">            <span class=\"pl-smi\">String</span> <span class=\"x x-first x-last\">key</span> <span class=\"pl-k\">=</span> logging(entry<span class=\"pl-k\">.</span>getKey());</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "vladak", "createdAt": "2020-05-11T08:54:49Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/web/LaunderUtil.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Chris Fraire <cfraire@me.com>.\n+ */\n+\n+package org.opengrok.indexer.web;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Represents a container for sanitizing methods for avoiding classifications as\n+ * taint bugs.\n+ */\n+public class LaunderUtil {\n+\n+    /**\n+     * Sanitize {@code value} where it will be used in subsequent OpenGrok\n+     * (non-logging) processing.\n+     * @return {@code null} if null or else {@code value} with \"pattern-breaking\n+     * characters\" (tabs, CR, LF, FF) replaced as underscores (one for one)\n+     */\n+    public static String userInput(String value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        return value.replaceAll(\"[\\\\n\\\\r\\\\t\\\\f]\", \"_\");\n+    }\n+\n+    /**\n+     * Sanitize {@code query} where it will be used in a Lucene query.\n+     * @return {@code null} if null or else {@code query} with \"pattern-breaking\n+     * characters\" (tabs, CR, LF, FF) replaced as spaces. Contiguous matches are\n+     * replaced with one space.\n+     */\n+    public static String luceneQuery(String query) {\n+        if (query == null) {\n+            return null;\n+        }\n+        return query.replaceAll(\"[\\\\n\\\\r\\\\t\\\\f]+\", \" \");\n+    }\n+\n+    /**\n+     * Sanitize {@code value} where it will be used in a log message only.\n+     * @return {@code null} if null or else {@code value} with \"pattern-breaking\n+     * characters\" tabs, CR, LF, and FF replaced as {@code \"<TAB>\"},\n+     * {@code \"<CR>\"}, {@code \"<LF>\"}, and {@code \"<FF>\"} resp.\n+     */\n+    public static String logging(String value) {\n+        if (value == null) {\n+            return null;\n+        }\n+        return value.replaceAll(\"\\\\n\", \"<LF>\").\n+                replaceAll(\"\\\\r\", \"<CR>\").\n+                replaceAll(\"\\\\t\", \"<TAB>\").\n+                replaceAll(\"\\\\f\", \"<FF>\");\n+    }\n+\n+    /**\n+     * Sanitize {@code map} where it will be used in a log message only.\n+     * @return {@code null} if null or else {@code map} with keys and values\n+     * sanitized with {@link #logging(String)}. If the sanitizing causes key\n+     * collisions, the colliding keys' values are combined.\n+     */\n+    public static Map<String, String[]> logging(Map<String, String[]> map) {\n+        if (map == null) {\n+            return null;\n+        }\n+\n+        HashMap<String, String[]> safes = new HashMap<>();\n+        for (Map.Entry<String, String[]> entry : map.entrySet()) {\n+            String k = logging(entry.getKey());", "originalCommit": "20463cfe62e8d338ddce6727625e7f840d98355f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQwNTE4Nw==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r423405187", "bodyText": "OK done", "author": "idodeclare", "createdAt": "2020-05-12T01:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4Njk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5MTc0NQ==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r422891745", "body": "perhaps this class should be called Laundromat and have the launder as a method ? :-)", "bodyText": "perhaps this class should be called Laundromat and have the launder as a method ? :-)", "bodyHTML": "<p dir=\"auto\">perhaps this class should be called Laundromat and have the launder as a method ? :-)</p>", "author": "vladak", "createdAt": "2020-05-11T09:02:19Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/web/LaunderUtil.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * CDDL HEADER START\n+ *\n+ * The contents of this file are subject to the terms of the\n+ * Common Development and Distribution License (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ *\n+ * See LICENSE.txt included in this distribution for the specific\n+ * language governing permissions and limitations under the License.\n+ *\n+ * When distributing Covered Code, include this CDDL HEADER in each\n+ * file and include the License file at LICENSE.txt.\n+ * If applicable, add the following below this CDDL HEADER, with the\n+ * fields enclosed by brackets \"[]\" replaced with your own identifying\n+ * information: Portions Copyright [yyyy] [name of copyright owner]\n+ *\n+ * CDDL HEADER END\n+ */\n+\n+/*\n+ * Copyright (c) 2020, Chris Fraire <cfraire@me.com>.\n+ */\n+\n+package org.opengrok.indexer.web;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/**\n+ * Represents a container for sanitizing methods for avoiding classifications as\n+ * taint bugs.\n+ */\n+public class LaunderUtil {", "originalCommit": "20463cfe62e8d338ddce6727625e7f840d98355f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjkwODQzNw==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r422908437", "bodyText": "also, add a simple test ?", "author": "vladak", "createdAt": "2020-05-11T09:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5MTc0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQwNTI2Mg==", "url": "https://github.com/oracle/opengrok/pull/3148#discussion_r423405262", "bodyText": "You got it", "author": "idodeclare", "createdAt": "2020-05-12T01:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg5MTc0NQ=="}], "type": "inlineReview"}, {"oid": "d26fc5a1ed8b18146f36800a57ca77c976332872", "url": "https://github.com/oracle/opengrok/commit/d26fc5a1ed8b18146f36800a57ca77c976332872", "message": "Address review feedback", "committedDate": "2020-05-12T01:06:05Z", "type": "commit"}]}