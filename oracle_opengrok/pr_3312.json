{"pr_number": 3312, "pr_title": "allow to access API using bearer token", "pr_author": "vladak", "pr_createdAt": "2020-10-23T16:07:59Z", "pr_url": "https://github.com/oracle/opengrok/pull/3312", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY1Nzk0OA==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511657948", "body": "could benefit from ConfiguratioChangeListener (https://github.com/oracle/opengrok/pull/3270) so you could cache the tokens as it requires a lock on each secure request which contains the header", "bodyText": "could benefit from ConfiguratioChangeListener (#3270) so you could cache the tokens as it requires a lock on each secure request which contains the header", "bodyHTML": "<p dir=\"auto\">could benefit from ConfiguratioChangeListener (<a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"718254485\" data-permission-text=\"Title is private\" data-url=\"https://github.com/oracle/opengrok/issues/3270\" data-hovercard-type=\"pull_request\" data-hovercard-url=\"/oracle/opengrok/pull/3270/hovercard\" href=\"https://github.com/oracle/opengrok/pull/3270\">#3270</a>) so you could cache the tokens as it requires a lock on each secure request which contains the header</p>", "author": "tulinkry", "createdAt": "2020-10-25T22:33:54Z", "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&\n+                    authHeaderValue.startsWith(BEARER)) {\n+                String tokenValue = authHeaderValue.substring(BEARER.length());\n+                if (RuntimeEnvironment.getInstance().getAuthenticationTokens().contains(tokenValue)) {", "originalCommit": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwMDA4Ng==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511900086", "bodyText": "good idea. Will wait for the PR to land.", "author": "vladak", "createdAt": "2020-10-26T11:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY1Nzk0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NTI3Nw==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r514295277", "bodyText": "@ahornace was so kind to allow me to take the ConfiguratioChangedListener from his PR.", "author": "vladak", "createdAt": "2020-10-29T14:20:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY1Nzk0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Nzk2OQ==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511757969", "body": "I've noticed this construct a few times in OpenGrok and I think it makes things a bit unreadable. Why not rewrite it as:\r\n```java\r\nString authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION);\r\nif (authHeaderValue != null && authHeaderValue.startsWith(BEARER)) {\r\n   ...\r\n```\r\nThen the definition is directly tied to declaration.", "bodyText": "I've noticed this construct a few times in OpenGrok and I think it makes things a bit unreadable. Why not rewrite it as:\nString authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION);\nif (authHeaderValue != null && authHeaderValue.startsWith(BEARER)) {\n   ...\nThen the definition is directly tied to declaration.", "bodyHTML": "<p dir=\"auto\">I've noticed this construct a few times in OpenGrok and I think it makes things a bit unreadable. Why not rewrite it as:</p>\n<div class=\"highlight highlight-source-java position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"String authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION);\nif (authHeaderValue != null &amp;&amp; authHeaderValue.startsWith(BEARER)) {\n   ...\n\"><pre><span class=\"pl-smi\">String</span> authHeaderValue <span class=\"pl-k\">=</span> request<span class=\"pl-k\">.</span>getHeader(<span class=\"pl-smi\">HttpHeaders</span><span class=\"pl-c1\"><span class=\"pl-k\">.</span>AUTHORIZATION</span>);\n<span class=\"pl-k\">if</span> (authHeaderValue <span class=\"pl-k\">!=</span> <span class=\"pl-c1\">null</span> <span class=\"pl-k\">&amp;&amp;</span> authHeaderValue<span class=\"pl-k\">.</span>startsWith(<span class=\"pl-c1\">BEARER</span>)) {\n   <span class=\"pl-c1\">...</span></pre></div>\n<p dir=\"auto\">Then the definition is directly tied to declaration.</p>", "author": "ahornace", "createdAt": "2020-10-26T07:24:05Z", "path": "opengrok-web/src/main/java/org/opengrok/web/api/v1/filter/IncomingFilter.java", "diffHunk": "@@ -86,14 +97,38 @@ public void filter(final ContainerRequestContext context) {\n         if (request == null) { // happens in tests\n             return;\n         }\n+\n         String path = context.getUriInfo().getPath();\n+\n+        if (request.isSecure()) {\n+            String authHeaderValue;\n+            if ((authHeaderValue = request.getHeader(HttpHeaders.AUTHORIZATION)) != null &&", "originalCommit": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg5ODEzMA==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511898130", "bodyText": "yep, that looks nicer.", "author": "vladak", "createdAt": "2020-10-26T11:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1Nzk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1ODQ0OA==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511758448", "body": "Should not we return a copy or at least return an unmodifiable collection? Theoretically, someone could change the content easily.", "bodyText": "Should not we return a copy or at least return an unmodifiable collection? Theoretically, someone could change the content easily.", "bodyHTML": "<p dir=\"auto\">Should not we return a copy or at least return an unmodifiable collection? Theoretically, someone could change the content easily.</p>", "author": "ahornace", "createdAt": "2020-10-26T07:25:25Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -1336,6 +1339,14 @@ public void setDisabledRepositories(Set<String> disabledRepositories) {\n         this.disabledRepositories = disabledRepositories;\n     }\n \n+    public Set<String> getAuthenticationTokens() {", "originalCommit": "a6b0501b8fd2c76955f9f410d8dde2c1fb7b114a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgyOTE3Mg==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511829172", "bodyText": "Good catch ! Definitely something to worry about given these are access tokens.", "author": "vladak", "createdAt": "2020-10-26T09:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1ODQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgzMDg1NQ==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511830855", "bodyText": "Similar to #3312 (comment) but perhaps better to solve it here also", "author": "tulinkry", "createdAt": "2020-10-26T09:43:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc1ODQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwNjU4Nw==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511906587", "body": "// This list of calls is sorted alphabetically so please keep it.", "bodyText": "// This list of calls is sorted alphabetically so please keep it.", "bodyHTML": "<p dir=\"auto\">// This list of calls is sorted alphabetically so please keep it.</p>", "author": "tulinkry", "createdAt": "2020-10-26T11:57:58Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/Configuration.java", "diffHunk": "@@ -564,6 +566,7 @@ public Configuration() {\n         setUserPageSuffix(\"\");\n         setWebappLAF(\"default\");\n         // webappCtags is default(boolean)\n+        setAuthenticationTokens(new HashSet<>());", "originalCommit": "18ca4f4a141c11fa58f17f9e77eda2daababc388", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwODUzMg==", "url": "https://github.com/oracle/opengrok/pull/3312#discussion_r511908532", "bodyText": "fixed", "author": "vladak", "createdAt": "2020-10-26T12:01:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkwNjU4Nw=="}], "type": "inlineReview"}, {"oid": "07dc7f63632205ecc186e28b3e9a975baa3632eb", "url": "https://github.com/oracle/opengrok/commit/07dc7f63632205ecc186e28b3e9a975baa3632eb", "message": "keep it sorted", "committedDate": "2020-10-27T22:18:31Z", "type": "forcePushed"}, {"oid": "b6d868bfae2f626c8852346dce315ce4f43327f4", "url": "https://github.com/oracle/opengrok/commit/b6d868bfae2f626c8852346dce315ce4f43327f4", "message": "initial stab at token authentication\n\nfixes #3222", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "9be003c525a732dd4613cf1cf5b1b91a5076e79e", "url": "https://github.com/oracle/opengrok/commit/9be003c525a732dd4613cf1cf5b1b91a5076e79e", "message": "merge LocalhostFilter and TokenFilter", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "ae297cef72493886df07d27c521b17d98d559895", "url": "https://github.com/oracle/opengrok/commit/ae297cef72493886df07d27c521b17d98d559895", "message": "add configuration", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "2ddfa3e5ba958a4ac84ae1fea5e3a01435cbd470", "url": "https://github.com/oracle/opengrok/commit/2ddfa3e5ba958a4ac84ae1fea5e3a01435cbd470", "message": "add tests", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "c0100aa5b27e9f4f2f0d9bb9f8fe0f3ebcedef20", "url": "https://github.com/oracle/opengrok/commit/c0100aa5b27e9f4f2f0d9bb9f8fe0f3ebcedef20", "message": "mention the tokens", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "b92c6f8fb5cc96bcc4f357bbbab1f7cf4e025f69", "url": "https://github.com/oracle/opengrok/commit/b92c6f8fb5cc96bcc4f357bbbab1f7cf4e025f69", "message": "adjust log message", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "1a4fead3e90eaed2aa6f3379c81b255e93b435aa", "url": "https://github.com/oracle/opengrok/commit/1a4fead3e90eaed2aa6f3379c81b255e93b435aa", "message": "restructure allow cases", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "2d2e66f867a4c1b467cefce2fa5b5b3ad9b14886", "url": "https://github.com/oracle/opengrok/commit/2d2e66f867a4c1b467cefce2fa5b5b3ad9b14886", "message": "simplify conditions", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "57f10954de0bc478950d8a674c7cd3d934bde5da", "url": "https://github.com/oracle/opengrok/commit/57f10954de0bc478950d8a674c7cd3d934bde5da", "message": "deny proxied connections", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "90252cd5b4b7d4057d342675b1f40fb9f58dda79", "url": "https://github.com/oracle/opengrok/commit/90252cd5b4b7d4057d342675b1f40fb9f58dda79", "message": "add comment", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "1eea296754fdbdad68419883cb51be2e7e52afde", "url": "https://github.com/oracle/opengrok/commit/1eea296754fdbdad68419883cb51be2e7e52afde", "message": "bearer token", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "3bab5c139a13cc3f3d7aa219fd91e504689fe34a", "url": "https://github.com/oracle/opengrok/commit/3bab5c139a13cc3f3d7aa219fd91e504689fe34a", "message": "declare+define", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "81ae0366d31ce2ccb4d5a5f4b91f6bd079992e0a", "url": "https://github.com/oracle/opengrok/commit/81ae0366d31ce2ccb4d5a5f4b91f6bd079992e0a", "message": "add comment", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "b14b352f7d203d7d7ab9b9a1bdd0ef1ce3a0479e", "url": "https://github.com/oracle/opengrok/commit/b14b352f7d203d7d7ab9b9a1bdd0ef1ce3a0479e", "message": "cache the tokens\n\nneeds ConfigurationChangeListener", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "e6f7d75feb6357a78eaadead835068d56a655690", "url": "https://github.com/oracle/opengrok/commit/e6f7d75feb6357a78eaadead835068d56a655690", "message": "the token set should not be modifiable", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "bd2631a679033d013b74b5c59e33ffffcfacc263", "url": "https://github.com/oracle/opengrok/commit/bd2631a679033d013b74b5c59e33ffffcfacc263", "message": "keep it sorted", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "f1d08400e4d39bbb32e8334d734f8b32ed38d773", "url": "https://github.com/oracle/opengrok/commit/f1d08400e4d39bbb32e8334d734f8b32ed38d773", "message": "add comma", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "939bd9b0484747f1edf845727c0813fc85a7efda", "url": "https://github.com/oracle/opengrok/commit/939bd9b0484747f1edf845727c0813fc85a7efda", "message": "introduce ConfigurationChangedListener", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "39be1bfbc4ca4b123063c7289319423347435814", "url": "https://github.com/oracle/opengrok/commit/39be1bfbc4ca4b123063c7289319423347435814", "message": "add registerListener()", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "67ca4d503f5f8c3d146b071bc02972cf922cbb82", "url": "https://github.com/oracle/opengrok/commit/67ca4d503f5f8c3d146b071bc02972cf922cbb82", "message": "use ConfigurationChangedListener", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "4958bf626971e8a2ff0f0906e885c28ed9432a1c", "url": "https://github.com/oracle/opengrok/commit/4958bf626971e8a2ff0f0906e885c28ed9432a1c", "message": "add test to cover configuration listener", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "9331fbf4f39b756c3dc590078301cba39e78cff7", "url": "https://github.com/oracle/opengrok/commit/9331fbf4f39b756c3dc590078301cba39e78cff7", "message": "add docs", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "url": "https://github.com/oracle/opengrok/commit/3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "message": "avoid wildcard imports", "committedDate": "2020-11-01T13:39:23Z", "type": "commit"}, {"oid": "3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "url": "https://github.com/oracle/opengrok/commit/3dcc89e1ace5032db3285bfa23214ff2d0c38c7b", "message": "avoid wildcard imports", "committedDate": "2020-11-01T13:39:23Z", "type": "forcePushed"}]}