{"pr_number": 3200, "pr_title": "introduce command timeout types", "pr_createdAt": "2020-08-31T19:18:31Z", "pr_url": "https://github.com/oracle/opengrok/pull/3200", "merge_commit": "e1b8a728de75efbcf65f25a7169ce99443c144ac", "timeline": [{"oid": "de698c4e0851dd700b852933eaf5294549ce2f39", "url": "https://github.com/oracle/opengrok/commit/de698c4e0851dd700b852933eaf5294549ce2f39", "message": "introduce CommandTimeoutType\n\nfixes #3146", "committedDate": "2020-08-31T09:24:02Z", "type": "commit"}, {"oid": "2739a693d632219fc9847688d762477095113ba2", "url": "https://github.com/oracle/opengrok/commit/2739a693d632219fc9847688d762477095113ba2", "message": "report command duration via Statistics", "committedDate": "2020-08-31T18:46:18Z", "type": "commit"}, {"oid": "acb0e685834ecd54cd8e47e665d0b5dd7f0fc471", "url": "https://github.com/oracle/opengrok/commit/acb0e685834ecd54cd8e47e665d0b5dd7f0fc471", "message": "report index time of files with Level.FINEST", "committedDate": "2020-09-02T09:35:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzNjMwMA==", "url": "https://github.com/oracle/opengrok/pull/3200#discussion_r490236300", "body": "Would not `IllegalArgumentException` make more sense? `InvalidParameterException` is from `security` package and is not that commonly used.", "bodyText": "Would not IllegalArgumentException make more sense? InvalidParameterException is from security package and is not that commonly used.", "bodyHTML": "<p dir=\"auto\">Would not <code>IllegalArgumentException</code> make more sense? <code>InvalidParameterException</code> is from <code>security</code> package and is not that commonly used.</p>", "author": "ahornace", "createdAt": "2020-09-17T13:18:22Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/RuntimeEnvironment.java", "diffHunk": "@@ -227,29 +228,59 @@ public void setNestingMaximum(int nestingMaximum) {\n         syncWriteConfiguration(nestingMaximum, Configuration::setNestingMaximum);\n     }\n \n-    public int getCommandTimeout() {\n-        return syncReadConfiguration(Configuration::getCommandTimeout);\n+    public int getCommandTimeout(CommandTimeoutType cmdType) {\n+        switch (cmdType) {\n+            case INDEXER:\n+                return getIndexerCommandTimeout();\n+            case INTERACTIVE:\n+                return getInteractiveCommandTimeout();\n+            case WEBAPP_START:\n+                return getWebappStartCommandTimeout();\n+            case RESTFUL:\n+                return getRestfulCommandTimeout();\n+        }\n+\n+        throw new InvalidParameterException(\"invalid command timeout type\");", "originalCommit": "acb0e685834ecd54cd8e47e665d0b5dd7f0fc471", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM2MTM0OA==", "url": "https://github.com/oracle/opengrok/pull/3200#discussion_r490361348", "bodyText": "sounds reasonable, changed.", "author": "vladak", "createdAt": "2020-09-17T15:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzNjMwMA=="}], "type": "inlineReview", "revised_code": {"commit": "e8c53d06676e666d0146465992e0d9111d9fbeb5", "changed_code": [{"header": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/RuntimeEnvironment.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/RuntimeEnvironment.java\nindex 6514ba33e3..4c0fc77b01 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/RuntimeEnvironment.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/configuration/RuntimeEnvironment.java\n", "chunk": "@@ -240,7 +240,7 @@ public final class RuntimeEnvironment {\n                 return getRestfulCommandTimeout();\n         }\n \n-        throw new InvalidParameterException(\"invalid command timeout type\");\n+        throw new IllegalArgumentException(\"invalid command timeout type\");\n     }\n \n     public int getRestfulCommandTimeout() {\n", "next_change": null}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0MzE0Mg==", "url": "https://github.com/oracle/opengrok/pull/3200#discussion_r490243142", "body": "I know it was like this but since you are touching it, could you please rename to `timeStr` to follow Java standard?", "bodyText": "I know it was like this but since you are touching it, could you please rename to timeStr to follow Java standard?", "bodyHTML": "<p dir=\"auto\">I know it was like this but since you are touching it, could you please rename to <code>timeStr</code> to follow Java standard?</p>", "author": "ahornace", "createdAt": "2020-09-17T13:26:34Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java", "diffHunk": "@@ -28,28 +28,47 @@\n import static org.opengrok.indexer.util.StringUtils.getReadableTime;\n \n public class Statistics {\n-        \n-  private final long startTime;  \n \n-  public Statistics() {\n+    private final long startTime;\n+\n+    public Statistics() {\n       startTime = System.currentTimeMillis();    \n   }\n \n-  public void report(Logger log, String msg) {\n-      long stopTime = System.currentTimeMillis();\n-      String time_str = StringUtils.getReadableTime(stopTime - startTime);\n-      log.log(Level.INFO, msg + \" (took {0})\", time_str);\n-  }\n+    /**\n+     * log a message along with how much time it took since the constructor was called.\n+     * @param logger logger instance\n+     * @param logLevel log level\n+     * @param msg message string\n+     */\n+    public void report(Logger logger, Level logLevel, String msg) {\n+        long stopTime = System.currentTimeMillis();\n+        String time_str = StringUtils.getReadableTime(stopTime - startTime);", "originalCommit": "acb0e685834ecd54cd8e47e665d0b5dd7f0fc471", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM1OTkzMA==", "url": "https://github.com/oracle/opengrok/pull/3200#discussion_r490359930", "bodyText": "sure", "author": "vladak", "createdAt": "2020-09-17T15:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0MzE0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "187f4cd872c1fceca95551343bdb2b9a4df4fc52", "changed_code": [{"header": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\nindex 97ec32f0d1..1949696d92 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n", "chunk": "@@ -43,8 +43,8 @@ public class Statistics {\n      */\n     public void report(Logger logger, Level logLevel, String msg) {\n         long stopTime = System.currentTimeMillis();\n-        String time_str = StringUtils.getReadableTime(stopTime - startTime);\n-        logger.log(Level.INFO, msg + \" (took {0})\", time_str);\n+        String timeStr = StringUtils.getReadableTime(stopTime - startTime);\n+        logger.log(Level.INFO, msg + \" (took {0})\", timeStr);\n     }\n \n     /**\n", "next_change": {"commit": "b08ee2a79de4f1e6f076f2ba617f9aa077ad438f", "changed_code": [{"header": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\nindex 1949696d92..37aafc2645 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n", "chunk": "@@ -42,14 +44,13 @@ public class Statistics {\n      * @param msg message string\n      */\n     public void report(Logger logger, Level logLevel, String msg) {\n-        long stopTime = System.currentTimeMillis();\n-        String timeStr = StringUtils.getReadableTime(stopTime - startTime);\n-        logger.log(Level.INFO, msg + \" (took {0})\", timeStr);\n+        String timeStr = StringUtils.getReadableTime(Duration.between(startTime, Instant.now()).toMillis());\n+        logger.log(logLevel, msg + \" (took {0})\", timeStr);\n     }\n \n     /**\n      * log a message along with how much time it took since the constructor was called.\n-     * The log level is Level.INFO.\n+     * The log level is {@code INFO}.\n      * @param logger logger instance\n      * @param msg message string\n      */\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "e1b8a728de75efbcf65f25a7169ce99443c144ac", "changed_code": [{"header": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\nindex 97ec32f0d1..37aafc2645 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n", "chunk": "@@ -42,14 +44,13 @@ public class Statistics {\n      * @param msg message string\n      */\n     public void report(Logger logger, Level logLevel, String msg) {\n-        long stopTime = System.currentTimeMillis();\n-        String time_str = StringUtils.getReadableTime(stopTime - startTime);\n-        logger.log(Level.INFO, msg + \" (took {0})\", time_str);\n+        String timeStr = StringUtils.getReadableTime(Duration.between(startTime, Instant.now()).toMillis());\n+        logger.log(logLevel, msg + \" (took {0})\", timeStr);\n     }\n \n     /**\n      * log a message along with how much time it took since the constructor was called.\n-     * The log level is Level.INFO.\n+     * The log level is {@code INFO}.\n      * @param logger logger instance\n      * @param msg message string\n      */\n", "next_change": {"commit": "0d7ace53e3bf35d6e3f78d37ef6ea4b1a697fcbe", "changed_code": [{"header": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\nindex 37aafc2645..fb760e9a8a 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n", "chunk": "@@ -53,24 +80,19 @@ public class Statistics {\n      * The log level is {@code INFO}.\n      * @param logger logger instance\n      * @param msg message string\n+     * @param meterName name of the meter\n      */\n-    public void report(Logger logger, String msg) {\n-        report(logger, Level.INFO, msg);\n+    public void report(Logger logger, String msg, String meterName) {\n+        report(logger, Level.INFO, msg, meterName);\n     }\n \n     /**\n-     * log a message along with how much time and memory it took since the constructor was called.\n-     * The message will be logged with the {@code INFO} level.\n+     * log a message along with how much time it took since the constructor was called.\n+     * The log level is {@code INFO}.\n      * @param logger logger instance\n+     * @param msg message string\n      */\n-    public void report(Logger logger) {\n-        logger.log(Level.INFO, \"Total time: {0}\",\n-                getReadableTime(Duration.between(startTime, Instant.now()).toMillis()));\n-\n-        System.gc();\n-        Runtime r = Runtime.getRuntime();\n-        long mb = 1024L * 1024;\n-        logger.log(Level.INFO, \"Final Memory: {0}M/{1}M\",\n-                new Object[]{(r.totalMemory() - r.freeMemory()) / mb, r.totalMemory() / mb});\n+    public void report(Logger logger, String msg) {\n+        report(logger, Level.INFO, msg);\n     }\n }\n", "next_change": null}]}}]}, "commits_in_main": [{"oid": "e1b8a728de75efbcf65f25a7169ce99443c144ac", "message": "Merge commit", "committedDate": null}, {"oid": "0d7ace53e3bf35d6e3f78d37ef6ea4b1a697fcbe", "committedDate": "2020-10-15 12:20:30 +0200", "message": "use statsd for indexer monitoring (#3279)"}, {"oid": "5d9f3aa0ca3da3a714233f987fa732f62c0965f6", "committedDate": "2020-10-26 17:11:42 +0100", "message": "Add copyright part to header check (#3311)"}, {"oid": "5752d8ba1f4fa1892ace5235ae48a63534fd24d3", "committedDate": "2021-02-27 09:01:26 -0500", "message": "report duration for file history cache updates"}, {"oid": "ef6b5de24264d979d0f4e0ef5515d20f1309837b", "committedDate": "2021-03-17 20:50:20 +0100", "message": "add more search.latency categories (#3485)"}, {"oid": "e2f7528863dc2eccfe7204bba2a56a47df14f9f8", "committedDate": "2022-10-24 14:34:36 +0200", "message": "Annotation cache (#4059)"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0OTY2Nw==", "url": "https://github.com/oracle/opengrok/pull/3200#discussion_r490249667", "body": "I still prefer using `Instant` and `Duration` classes for computing the duration as it is more high level. If you do not, then feel free to ignore.", "bodyText": "I still prefer using Instant and Duration classes for computing the duration as it is more high level. If you do not, then feel free to ignore.", "bodyHTML": "<p dir=\"auto\">I still prefer using <code>Instant</code> and <code>Duration</code> classes for computing the duration as it is more high level. If you do not, then feel free to ignore.</p>", "author": "ahornace", "createdAt": "2020-09-17T13:33:46Z", "path": "opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java", "diffHunk": "@@ -28,28 +28,47 @@\n import static org.opengrok.indexer.util.StringUtils.getReadableTime;\n \n public class Statistics {\n-        \n-  private final long startTime;  \n \n-  public Statistics() {\n+    private final long startTime;", "originalCommit": "acb0e685834ecd54cd8e47e665d0b5dd7f0fc471", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM2NTAwOA==", "url": "https://github.com/oracle/opengrok/pull/3200#discussion_r490365008", "bodyText": "why not, changed. I like Duration.between().", "author": "vladak", "createdAt": "2020-09-17T15:58:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0OTY2Nw=="}], "type": "inlineReview", "revised_code": {"commit": "b08ee2a79de4f1e6f076f2ba617f9aa077ad438f", "changed_code": [{"header": "diff --git a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\nindex 97ec32f0d1..37aafc2645 100644\n--- a/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n+++ b/opengrok-indexer/src/main/java/org/opengrok/indexer/util/Statistics.java\n", "chunk": "@@ -23,16 +23,18 @@\n \n package org.opengrok.indexer.util;\n \n+import java.time.Duration;\n+import java.time.Instant;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n import static org.opengrok.indexer.util.StringUtils.getReadableTime;\n \n public class Statistics {\n \n-    private final long startTime;\n+    private final Instant startTime;\n \n     public Statistics() {\n-      startTime = System.currentTimeMillis();    \n+      startTime = Instant.now();\n   }\n \n     /**\n", "next_change": null}]}}, {"oid": "187f4cd872c1fceca95551343bdb2b9a4df4fc52", "url": "https://github.com/oracle/opengrok/commit/187f4cd872c1fceca95551343bdb2b9a4df4fc52", "message": "rename per review comment", "committedDate": "2020-09-17T15:51:13Z", "type": "commit"}, {"oid": "e8c53d06676e666d0146465992e0d9111d9fbeb5", "url": "https://github.com/oracle/opengrok/commit/e8c53d06676e666d0146465992e0d9111d9fbeb5", "message": "use IllegalArgumentException per review comment", "committedDate": "2020-09-17T15:53:14Z", "type": "commit"}, {"oid": "b08ee2a79de4f1e6f076f2ba617f9aa077ad438f", "url": "https://github.com/oracle/opengrok/commit/b08ee2a79de4f1e6f076f2ba617f9aa077ad438f", "message": "use Instant/Duration per review comment", "committedDate": "2020-09-17T15:58:18Z", "type": "commit"}, {"oid": "1a10c24c4b271ec1cf6bfeef17491acc61ce6e85", "url": "https://github.com/oracle/opengrok/commit/1a10c24c4b271ec1cf6bfeef17491acc61ce6e85", "message": "remove unused import", "committedDate": "2020-09-17T17:38:25Z", "type": "commit"}]}