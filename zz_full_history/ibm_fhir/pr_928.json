{"pr_number": 928, "pr_title": "Issue #889 - Initial implementation of ServerRegistryResourceProvider", "pr_author": "JohnTimm", "pr_createdAt": "2020-04-14T21:07:54Z", "pr_url": "https://github.com/IBM/FHIR/pull/928", "timeline": [{"oid": "b935e16770f0c3b2c86633642fa0418307d409bf", "url": "https://github.com/IBM/FHIR/commit/b935e16770f0c3b2c86633642fa0418307d409bf", "message": "Issue #889 - Initial implementation of ServerRegistryResourceProvider\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-14T21:21:57Z", "type": "commit"}, {"oid": "b935e16770f0c3b2c86633642fa0418307d409bf", "url": "https://github.com/IBM/FHIR/commit/b935e16770f0c3b2c86633642fa0418307d409bf", "message": "Issue #889 - Initial implementation of ServerRegistryResourceProvider\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-14T21:21:57Z", "type": "forcePushed"}, {"oid": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "url": "https://github.com/IBM/FHIR/commit/ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "message": "Issue #889 - changed logging from fine to info\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-14T22:33:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk1NjkzNQ==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408956935", "body": "please add the corresponding docs to the user's guide", "bodyText": "please add the corresponding docs to the user's guide", "bodyHTML": "<p dir=\"auto\">please add the corresponding docs to the user's guide</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:01:25Z", "path": "fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java", "diffHunk": "@@ -33,6 +33,7 @@\n     public static final String PROPERTY_ALLOW_CLIENT_HANDLING_PREF = \"fhirServer/core/allowClientHandlingPref\";\n     public static final String PROPERTY_CHECK_REFERENCE_TYPES = \"fhirServer/core/checkReferenceTypes\";\n     public static final String PROPERTY_CONDITIONAL_DELETE_MAX_NUMBER = \"fhirServer/core/conditionalDeleteMaxNumber\";\n+    public static final String PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED = \"fhirServer/core/serverRegistryResourceProviderEnabled\";", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2ODYyOA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408968628", "bodyText": "Added documentation to the user's guide.", "author": "JohnTimm", "createdAt": "2020-04-15T16:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk1NjkzNQ=="}], "type": "inlineReview", "revised_code": {"commit": "aaeda25c8a47775003839dfb40c63d7f8f5c71ee", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex ad0e544f6d..c71ba8fa15 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -33,7 +33,6 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_ALLOW_CLIENT_HANDLING_PREF = \"fhirServer/core/allowClientHandlingPref\";\n     public static final String PROPERTY_CHECK_REFERENCE_TYPES = \"fhirServer/core/checkReferenceTypes\";\n     public static final String PROPERTY_CONDITIONAL_DELETE_MAX_NUMBER = \"fhirServer/core/conditionalDeleteMaxNumber\";\n-    public static final String PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED = \"fhirServer/core/serverRegistryResourceProviderEnabled\";\n \n     public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n \n", "next_change": {"commit": "17d928b933fc9f89127f62c856190b919d8333fd", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex c71ba8fa15..156d88c7b4 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -33,6 +32,7 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_ALLOW_CLIENT_HANDLING_PREF = \"fhirServer/core/allowClientHandlingPref\";\n     public static final String PROPERTY_CHECK_REFERENCE_TYPES = \"fhirServer/core/checkReferenceTypes\";\n     public static final String PROPERTY_CONDITIONAL_DELETE_MAX_NUMBER = \"fhirServer/core/conditionalDeleteMaxNumber\";\n+    public static final String PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED = \"fhirServer/core/serverRegistryResourceProviderEnabled\";\n \n     public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n \n", "next_change": {"commit": "f6751edd844640778e71611f9085267b1ae5566c", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 156d88c7b4..2b21641abb 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -37,8 +37,6 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n \n     // Auth and security properties\n-    public static final String PROPERTY_TRUSTSTORE_LOCATION = \"fhirServer/core/truststoreLocation\";\n-    public static final String PROPERTY_TRUSTSTORE_PASSWORD = \"fhirServer/core/truststorePassword\";\n     public static final String PROPERTY_OAUTH_REGURL = \"fhirServer/oauth/regUrl\";\n     public static final String PROPERTY_OAUTH_AUTHURL = \"fhirServer/oauth/authUrl\";\n     public static final String PROPERTY_OAUTH_TOKENURL = \"fhirServer/oauth/tokenUrl\";\n", "next_change": {"commit": "3c2aa513c6efb34406b89c2f7ebca5b29b6ff5e5", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 2b21641abb..2a6a923132 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -33,6 +33,7 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_CHECK_REFERENCE_TYPES = \"fhirServer/core/checkReferenceTypes\";\n     public static final String PROPERTY_CONDITIONAL_DELETE_MAX_NUMBER = \"fhirServer/core/conditionalDeleteMaxNumber\";\n     public static final String PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED = \"fhirServer/core/serverRegistryResourceProviderEnabled\";\n+    public static final String PROPERTY_CAPABILITY_STATEMENT_CACHE = \"fhirServer/core/capabilityStatementCacheTimeout\";\n \n     public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n \n", "next_change": {"commit": "c20868fe71f7f2e61b5dd98079b35c6be07af4dc", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 2a6a923132..ee69f87bce 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -34,6 +34,7 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_CONDITIONAL_DELETE_MAX_NUMBER = \"fhirServer/core/conditionalDeleteMaxNumber\";\n     public static final String PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED = \"fhirServer/core/serverRegistryResourceProviderEnabled\";\n     public static final String PROPERTY_CAPABILITY_STATEMENT_CACHE = \"fhirServer/core/capabilityStatementCacheTimeout\";\n+    public static final String PROPERTY_EXTENDED_CODEABLE_CONCEPT_VALIDATION = \"fhirServer/core/extendedCodeableConcepValidation\";\n \n     public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n \n", "next_change": {"commit": "dfe67c29576749fc72bc12d24eb37bf4d9810ea4", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex ee69f87bce..4407c56798 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -34,7 +34,7 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_CONDITIONAL_DELETE_MAX_NUMBER = \"fhirServer/core/conditionalDeleteMaxNumber\";\n     public static final String PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED = \"fhirServer/core/serverRegistryResourceProviderEnabled\";\n     public static final String PROPERTY_CAPABILITY_STATEMENT_CACHE = \"fhirServer/core/capabilityStatementCacheTimeout\";\n-    public static final String PROPERTY_EXTENDED_CODEABLE_CONCEPT_VALIDATION = \"fhirServer/core/extendedCodeableConcepValidation\";\n+    public static final String PROPERTY_EXTENDED_CODEABLE_CONCEPT_VALIDATION = \"fhirServer/core/extendedCodeableConceptValidation\";\n \n     public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n \n", "next_change": {"commit": "cabdc2ffc52df961ca93283570815f37222286f8", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 4407c56798..cc5aa3f22a 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -39,13 +39,19 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n \n     // Auth and security properties\n-    public static final String PROPERTY_OAUTH_REGURL = \"fhirServer/oauth/regUrl\";\n-    public static final String PROPERTY_OAUTH_AUTHURL = \"fhirServer/oauth/authUrl\";\n-    public static final String PROPERTY_OAUTH_TOKENURL = \"fhirServer/oauth/tokenUrl\";\n-\n-    public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/authFilter/enabled\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/authFilter/authorizedClientCertClientCN\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_ISSUER_OU = \"fhirServer/authFilter/authorizedClientCertIssuerOU\";\n+    public static final String PROPERTY_SECURITY_CORS = \"fhirServer/security/cors\";\n+    public static final String PROPERTY_SECURITY_BASIC_ENABLED = \"fhirServer/security/basic/enabled\";\n+    public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/cert/enabled\";\n+    public static final String PROPERTY_SECURITY_OAUTH_ENABLED = \"fhirServer/security/oauth/enabled\";\n+    public static final String PROPERTY_SECURITY_SMART_ENABLED = \"fhirServer/security/smart/enabled\";\n+    public static final String PROPERTY_SECURITY_SMART_REGURL = \"fhirServer/security/smart/regUrl\";\n+    public static final String PROPERTY_SECURITY_SMART_AUTHURL = \"fhirServer/security/smart/authUrl\";\n+    public static final String PROPERTY_SECURITY_SMART_TOKENURL = \"fhirServer/security/smart/tokenUrl\";\n+    public static final String PROPERTY_SECURITY_SMART_SCOPES = \"fhirServer/security/smart/scopes\";\n+\n+    public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n+    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n+    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_ISSUER_OU = \"fhirServer/security/cert/authFilter/authorizedClientCertIssuerOU\";\n \n     // Audit config properties\n     public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n", "next_change": {"commit": "90e59c64d59798b6ace71d9816145431402b51b6", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex cc5aa3f22a..259a3f5a46 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -43,11 +43,11 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SECURITY_BASIC_ENABLED = \"fhirServer/security/basic/enabled\";\n     public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/cert/enabled\";\n     public static final String PROPERTY_SECURITY_OAUTH_ENABLED = \"fhirServer/security/oauth/enabled\";\n-    public static final String PROPERTY_SECURITY_SMART_ENABLED = \"fhirServer/security/smart/enabled\";\n-    public static final String PROPERTY_SECURITY_SMART_REGURL = \"fhirServer/security/smart/regUrl\";\n-    public static final String PROPERTY_SECURITY_SMART_AUTHURL = \"fhirServer/security/smart/authUrl\";\n-    public static final String PROPERTY_SECURITY_SMART_TOKENURL = \"fhirServer/security/smart/tokenUrl\";\n-    public static final String PROPERTY_SECURITY_SMART_SCOPES = \"fhirServer/security/smart/scopes\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REGURL = \"fhirServer/security/smart/regUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_AUTHURL = \"fhirServer/security/smart/authUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_TOKENURL = \"fhirServer/security/smart/tokenUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_ENABLED = \"fhirServer/security/oauth/smart/enabled\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/smart/scopes\";\n \n     public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n     public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n", "next_change": {"commit": "8464da0256da607deaa7a04d921432949f2f69e8", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 259a3f5a46..d2aa3a35d7 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -43,11 +43,15 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SECURITY_BASIC_ENABLED = \"fhirServer/security/basic/enabled\";\n     public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/cert/enabled\";\n     public static final String PROPERTY_SECURITY_OAUTH_ENABLED = \"fhirServer/security/oauth/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REGURL = \"fhirServer/security/smart/regUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_AUTHURL = \"fhirServer/security/smart/authUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_TOKENURL = \"fhirServer/security/smart/tokenUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/smart/regUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/smart/authUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/smart/tokenUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/smart/manageUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/smart/introspectUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/smart/revokeUrl\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_ENABLED = \"fhirServer/security/oauth/smart/enabled\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/smart/scopes\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/smart/scopes\";\n \n     public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n     public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n", "next_change": {"commit": "095513ee1979ef823995b998d656ebf6ad0383d2", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex d2aa3a35d7..96eb6db4c3 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -36,22 +36,27 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_CAPABILITY_STATEMENT_CACHE = \"fhirServer/core/capabilityStatementCacheTimeout\";\n     public static final String PROPERTY_EXTENDED_CODEABLE_CONCEPT_VALIDATION = \"fhirServer/core/extendedCodeableConceptValidation\";\n \n-    public static final String PROPERTY_SEARCH_PARAMETER_FILTER = \"fhirServer/searchParameterFilter\";\n+    // Resources properties\n+    public static final String PROPERTY_RESOURCES = \"fhirServer/resources\";\n+    public static final String PROPERTY_FIELD_RESOURCES_OPEN = \"open\";\n+    public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETERS = \"searchParameters\";\n+    public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_URL = \"url\";\n+    public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_REQUIRED = \"required\";\n \n     // Auth and security properties\n     public static final String PROPERTY_SECURITY_CORS = \"fhirServer/security/cors\";\n     public static final String PROPERTY_SECURITY_BASIC_ENABLED = \"fhirServer/security/basic/enabled\";\n     public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/cert/enabled\";\n     public static final String PROPERTY_SECURITY_OAUTH_ENABLED = \"fhirServer/security/oauth/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/smart/regUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/smart/authUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/smart/tokenUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/smart/manageUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/smart/introspectUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/smart/revokeUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/oauth/regUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/oauth/authUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/oauth/tokenUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/oauth/manageUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/oauth/introspectUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/oauth/smart/revokeUrl\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_ENABLED = \"fhirServer/security/oauth/smart/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/smart/scopes\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/smart/scopes\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n \n     public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n     public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n", "next_change": {"commit": "01a95d24049168144cbb0445deaa0277617b2e70", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 96eb6db4c3..5b6a623337 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -42,21 +42,21 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETERS = \"searchParameters\";\n     public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_URL = \"url\";\n     public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_REQUIRED = \"required\";\n-\n+    \n     // Auth and security properties\n     public static final String PROPERTY_SECURITY_CORS = \"fhirServer/security/cors\";\n     public static final String PROPERTY_SECURITY_BASIC_ENABLED = \"fhirServer/security/basic/enabled\";\n     public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/cert/enabled\";\n     public static final String PROPERTY_SECURITY_OAUTH_ENABLED = \"fhirServer/security/oauth/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/oauth/regUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/oauth/authUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/oauth/tokenUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/oauth/manageUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/oauth/introspectUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/oauth/smart/revokeUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/smart/regUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/smart/authUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/smart/tokenUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/smart/manageUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/smart/introspectUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/smart/revokeUrl\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_ENABLED = \"fhirServer/security/oauth/smart/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/smart/scopes\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/smart/scopes\";\n \n     public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n     public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n", "next_change": {"commit": "dc560b6085731cc1af3089eb804ed5223d420a0c", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 5b6a623337..c4701f3e31 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -39,24 +39,25 @@ public class FHIRConfiguration {\n     // Resources properties\n     public static final String PROPERTY_RESOURCES = \"fhirServer/resources\";\n     public static final String PROPERTY_FIELD_RESOURCES_OPEN = \"open\";\n+    public static final String PROPERTY_FIELD_RESOURCES_INTERACTIONS = \"interactions\";\n     public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETERS = \"searchParameters\";\n     public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_URL = \"url\";\n     public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_REQUIRED = \"required\";\n-    \n+\n     // Auth and security properties\n     public static final String PROPERTY_SECURITY_CORS = \"fhirServer/security/cors\";\n     public static final String PROPERTY_SECURITY_BASIC_ENABLED = \"fhirServer/security/basic/enabled\";\n-    public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/cert/enabled\";\n+    public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/certificates/enabled\";\n     public static final String PROPERTY_SECURITY_OAUTH_ENABLED = \"fhirServer/security/oauth/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/smart/regUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/smart/authUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/smart/tokenUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/smart/manageUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/smart/introspectUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/smart/revokeUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/oauth/regUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/oauth/authUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/oauth/tokenUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/oauth/manageUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/oauth/introspectUrl\";\n+    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/oauth/smart/revokeUrl\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_ENABLED = \"fhirServer/security/oauth/smart/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/smart/scopes\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/smart/scopes\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n+    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n \n     public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n     public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n", "next_change": {"commit": "079e06a4cc9756761726e030b33afe98cb6583f7", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex c4701f3e31..32d3a448c2 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -59,10 +64,6 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n \n-    public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_ISSUER_OU = \"fhirServer/security/cert/authFilter/authorizedClientCertIssuerOU\";\n-\n     // Audit config properties\n     public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n     public static final String PROPERTY_AUDIT_SERVICE_PROPERTIES = \"fhirServer/audit/serviceProperties\";\n", "next_change": {"commit": "54719a66578918c37ac8f2a2f3380ac4169a88d9", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 32d3a448c2..62ddcb43b5 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -64,6 +64,10 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n \n+    public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n+    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n+    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_ISSUER_OU = \"fhirServer/security/cert/authFilter/authorizedClientCertIssuerOU\";\n+\n     // Audit config properties\n     public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n     public static final String PROPERTY_AUDIT_SERVICE_PROPERTIES = \"fhirServer/audit/serviceProperties\";\n", "next_change": {"commit": "0c1ca1263909f36c319aec7973d85985ce1f9852", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 62ddcb43b5..8d124eaf46 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -64,10 +64,6 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n \n-    public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_ISSUER_OU = \"fhirServer/security/cert/authFilter/authorizedClientCertIssuerOU\";\n-\n     // Audit config properties\n     public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n     public static final String PROPERTY_AUDIT_SERVICE_PROPERTIES = \"fhirServer/audit/serviceProperties\";\n", "next_change": {"commit": "3c5e29548a919f8cc010e9bb7aa2a8b702ee18c4", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 8d124eaf46..ee55924220 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -64,6 +64,10 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n \n+    public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n+    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n+    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_ISSUER_OU = \"fhirServer/security/cert/authFilter/authorizedClientCertIssuerOU\";\n+\n     // Audit config properties\n     public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n     public static final String PROPERTY_AUDIT_SERVICE_PROPERTIES = \"fhirServer/audit/serviceProperties\";\n", "next_change": {"commit": "fc4a70cbf798e77aaf92b6e09769eed9b999e6a7", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex ee55924220..65d100baf1 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -64,10 +64,6 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n     public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n \n-    public static final String PROPERTY_AUTHFILTER_ENABLED = \"fhirServer/security/cert/authFilter/enabled\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_CLIENT_CN = \"fhirServer/security/cert/authFilter/authorizedClientCertClientCN\";\n-    public static final String PROPERTY_AUTHORIZED_CLIENT_CERT_ISSUER_OU = \"fhirServer/security/cert/authFilter/authorizedClientCertIssuerOU\";\n-\n     // Audit config properties\n     public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n     public static final String PROPERTY_AUDIT_SERVICE_PROPERTIES = \"fhirServer/audit/serviceProperties\";\n", "next_change": {"commit": "a96ea3d45935ca135b2041d0ffed40c2ace9c5ed", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 65d100baf1..216e4419b7 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -68,6 +68,8 @@ public class FHIRConfiguration {\n     public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n     public static final String PROPERTY_AUDIT_SERVICE_PROPERTIES = \"fhirServer/audit/serviceProperties\";\n     public static final String PROPERTY_AUDIT_PATIENT_ID_EXTURL = \"fhirServer/audit/patientIdExtensionUrl\";\n+    public static final String PROPERTY_AUDIT_HOSTNAME = \"fhirServer/audit/hostname\";\n+    public static final String PROPERTY_AUDIT_IP = \"fhirServer/audit/ip\";\n \n     // Notification config properties\n     public static final String PROPERTY_NOTIFICATION_RESOURCE_TYPES = \"fhirServer/notifications/common/includeResourceTypes\";\n", "next_change": {"commit": "ab36ed97210223c518c33e434f75a9ca1be73f20", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\nindex 216e4419b7..0366644072 100644\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n", "chunk": "@@ -73,10 +85,13 @@ public class FHIRConfiguration {\n \n     // Notification config properties\n     public static final String PROPERTY_NOTIFICATION_RESOURCE_TYPES = \"fhirServer/notifications/common/includeResourceTypes\";\n+    public static final String PROPERTY_NOTIFICATION_NOTIFICATION_SIZE_BEHAVIOR = \"fhirServer/notifications/common/maxNotificationSizeBehavior\";\n+    public static final String PROPERTY_NOTIFICATION_MAX_SIZE = \"fhirServer/notifications/common/maxNotificationSizeBytes\";\n     public static final String PROPERTY_WEBSOCKET_ENABLED = \"fhirServer/notifications/websocket/enabled\";\n     public static final String PROPERTY_KAFKA_ENABLED = \"fhirServer/notifications/kafka/enabled\";\n     public static final String PROPERTY_KAFKA_TOPICNAME = \"fhirServer/notifications/kafka/topicName\";\n     public static final String PROPERTY_KAFKA_CONNECTIONPROPS = \"fhirServer/notifications/kafka/connectionProperties\";\n+    public static final String PROPERTY_KAFKA_SYNC = \"fhirServer/notifications/kafka/sync\";\n     public static final String PROPERTY_NATS_ENABLED = \"fhirServer/notifications/nats/enabled\";\n     public static final String PROPERTY_NATS_CLUSTER = \"fhirServer/notifications/nats/cluster\";\n     public static final String PROPERTY_NATS_CHANNEL = \"fhirServer/notifications/nats/channel\";\n", "next_change": {"commit": "e4f30db890b96be3175c03632905cdbc83f1fdd7", "changed_code": [{"header": "diff --git a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java b/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\ndeleted file mode 100644\nindex 0366644072..0000000000\n--- a/fhir-config/src/main/java/com/ibm/fhir/config/FHIRConfiguration.java\n+++ /dev/null\n", "chunk": "@@ -1,275 +0,0 @@\n-/*\n- * (C) Copyright IBM Corp. 2016, 2021\n- *\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n-package com.ibm.fhir.config;\n-\n-import java.io.File;\n-import java.util.ArrayList;\n-import java.util.List;\n-import java.util.logging.Logger;\n-\n-/**\n- * This class serves up a singleton instance of ConfigurationService containing the FHIR Server's configuration.\n- */\n-public class FHIRConfiguration {\n-    private static final Logger log = Logger.getLogger(FHIRConfiguration.class.getName());\n-\n-    public static final String CONFIG_LOCATION = \"config\";\n-    public static final String CONFIG_FILE_BASENAME = \"fhir-server-config.json\";\n-    public static final String DEFAULT_TENANT_ID = \"default\";\n-    public static final String DEFAULT_DATASTORE_ID = \"default\";\n-\n-    // Core server properties\n-    public static final String PROPERTY_ORIGINAL_REQUEST_URI_HEADER_NAME = \"fhirServer/core/originalRequestUriHeaderName\";\n-    public static final String PROPERTY_TENANT_ID_HEADER_NAME = \"fhirServer/core/tenantIdHeaderName\";\n-    public static final String PROPERTY_DATASTORE_ID_HEADER_NAME = \"fhirServer/core/datastoreIdHeaderName\";\n-    public static final String PROPERTY_DEFAULT_TENANT_ID = \"fhirServer/core/defaultTenantId\";\n-    public static final String PROPERTY_DEFAULT_PRETTY_PRINT = \"fhirServer/core/defaultPrettyPrint\";\n-    public static final String PROPERTY_DEFAULT_HANDLING = \"fhirServer/core/defaultHandling\";\n-    public static final String PROPERTY_ALLOW_CLIENT_HANDLING_PREF = \"fhirServer/core/allowClientHandlingPref\";\n-    public static final String PROPERTY_CHECK_REFERENCE_TYPES = \"fhirServer/core/checkReferenceTypes\";\n-    public static final String PROPERTY_CONDITIONAL_DELETE_MAX_NUMBER = \"fhirServer/core/conditionalDeleteMaxNumber\";\n-    public static final String PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED = \"fhirServer/core/serverRegistryResourceProviderEnabled\";\n-    public static final String PROPERTY_SERVER_RESOLVE_FUNCTION_ENABLED = \"fhirServer/core/serverResolveFunctionEnabled\";\n-    public static final String PROPERTY_CAPABILITY_STATEMENT_CACHE = \"fhirServer/core/capabilityStatementCacheTimeout\";\n-    public static final String PROPERTY_EXTENDED_CODEABLE_CONCEPT_VALIDATION = \"fhirServer/core/extendedCodeableConceptValidation\";\n-    public static final String PROPERTY_DISABLED_OPERATIONS = \"fhirServer/core/disabledOperations\";\n-    public static final String PROPERTY_DEFAULT_PAGE_SIZE = \"fhirServer/core/defaultPageSize\";\n-    public static final String PROPERTY_MAX_PAGE_SIZE = \"fhirServer/core/maxPageSize\";\n-    public static final String PROPERTY_MAX_PAGE_INCLUDE_COUNT = \"fhirServer/core/maxPageIncludeCount\";\n-    public static final String PROPERTY_CAPABILITIES_URL = \"fhirServer/core/capabilitiesUrl\";\n-\n-    // Terminology service properties\n-    public static final String PROPERTY_TERM_SERVICE_CAPABILITIES_URL = \"fhirServer/term/capabilitiesUrl\";\n-    public static final String PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_ENABLED = \"fhirServer/term/graphTermServiceProvider/enabled\";\n-    public static final String PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_TIME_LIMIT = \"fhirServer/term/graphTermServiceProvider/timeLimit\";\n-    public static final String PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_CONFIGURATION = \"fhirServer/term/graphTermServiceProvider/configuration\";\n-\n-    // Resources properties\n-    public static final String PROPERTY_RESOURCES = \"fhirServer/resources\";\n-    public static final String PROPERTY_FIELD_RESOURCES_OPEN = \"open\";\n-    public static final String PROPERTY_FIELD_RESOURCES_INTERACTIONS = \"interactions\";\n-    public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETERS = \"searchParameters\";\n-    public static final String PROPERTY_FIELD_RESOURCES_SEARCH_INCLUDES = \"searchIncludes\";\n-    public static final String PROPERTY_FIELD_RESOURCES_SEARCH_REV_INCLUDES = \"searchRevIncludes\";\n-    public static final String PROPERTY_FIELD_RESOURCES_SEARCH_PARAMETER_COMBINATIONS = \"searchParameterCombinations\";\n-    public static final String PROPERTY_FIELD_RESOURCES_PROFILES = \"profiles\";\n-    public static final String PROPERTY_FIELD_RESOURCES_PROFILES_AT_LEAST_ONE = \"atLeastOne\";\n-    public static final String PROPERTY_USE_STORED_COMPARTMENT_PARAM = \"fhirServer/search/useStoredCompartmentParam\";\n-    public static final String PROPERTY_SEARCH_ENABLE_OPT_QUERY_BUILDER = \"fhirServer/search/enableOptQueryBuilder\";\n-\n-    // Auth and security properties\n-    public static final String PROPERTY_SECURITY_CORS = \"fhirServer/security/cors\";\n-    public static final String PROPERTY_SECURITY_BASIC_ENABLED = \"fhirServer/security/basic/enabled\";\n-    public static final String PROPERTY_SECURITY_CERT_ENABLED = \"fhirServer/security/certificates/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_ENABLED = \"fhirServer/security/oauth/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REG_URL = \"fhirServer/security/oauth/regUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_AUTH_URL = \"fhirServer/security/oauth/authUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_TOKEN_URL = \"fhirServer/security/oauth/tokenUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_MANAGE_URL = \"fhirServer/security/oauth/manageUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_INTROSPECT_URL = \"fhirServer/security/oauth/introspectUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_REVOKE_URL = \"fhirServer/security/oauth/smart/revokeUrl\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_ENABLED = \"fhirServer/security/oauth/smart/enabled\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_SCOPES = \"fhirServer/security/oauth/smart/scopes\";\n-    public static final String PROPERTY_SECURITY_OAUTH_SMART_CAPABILITIES = \"fhirServer/security/oauth/smart/capabilities\";\n-\n-    // Audit config properties\n-    public static final String PROPERTY_AUDIT_SERVICE_CLASS_NAME = \"fhirServer/audit/serviceClassName\";\n-    public static final String PROPERTY_AUDIT_SERVICE_PROPERTIES = \"fhirServer/audit/serviceProperties\";\n-    public static final String PROPERTY_AUDIT_PATIENT_ID_EXTURL = \"fhirServer/audit/patientIdExtensionUrl\";\n-    public static final String PROPERTY_AUDIT_HOSTNAME = \"fhirServer/audit/hostname\";\n-    public static final String PROPERTY_AUDIT_IP = \"fhirServer/audit/ip\";\n-\n-    // Notification config properties\n-    public static final String PROPERTY_NOTIFICATION_RESOURCE_TYPES = \"fhirServer/notifications/common/includeResourceTypes\";\n-    public static final String PROPERTY_NOTIFICATION_NOTIFICATION_SIZE_BEHAVIOR = \"fhirServer/notifications/common/maxNotificationSizeBehavior\";\n-    public static final String PROPERTY_NOTIFICATION_MAX_SIZE = \"fhirServer/notifications/common/maxNotificationSizeBytes\";\n-    public static final String PROPERTY_WEBSOCKET_ENABLED = \"fhirServer/notifications/websocket/enabled\";\n-    public static final String PROPERTY_KAFKA_ENABLED = \"fhirServer/notifications/kafka/enabled\";\n-    public static final String PROPERTY_KAFKA_TOPICNAME = \"fhirServer/notifications/kafka/topicName\";\n-    public static final String PROPERTY_KAFKA_CONNECTIONPROPS = \"fhirServer/notifications/kafka/connectionProperties\";\n-    public static final String PROPERTY_KAFKA_SYNC = \"fhirServer/notifications/kafka/sync\";\n-    public static final String PROPERTY_NATS_ENABLED = \"fhirServer/notifications/nats/enabled\";\n-    public static final String PROPERTY_NATS_CLUSTER = \"fhirServer/notifications/nats/cluster\";\n-    public static final String PROPERTY_NATS_CHANNEL = \"fhirServer/notifications/nats/channel\";\n-    public static final String PROPERTY_NATS_CLIENT = \"fhirServer/notifications/nats/client\";\n-    public static final String PROPERTY_NATS_SERVERS = \"fhirServer/notifications/nats/servers\";\n-    public static final String PROPERTY_NATS_TLS_ENABLED = \"fhirServer/notifications/nats/useTLS\";\n-    public static final String PROPERTY_NATS_TRUSTSTORE = \"fhirServer/notifications/nats/truststoreLocation\";\n-    public static final String PROPERTY_NATS_TRUSTSTORE_PW = \"fhirServer/notifications/nats/truststorePassword\";\n-    public static final String PROPERTY_NATS_KEYSTORE = \"fhirServer/notifications/nats/keystoreLocation\";\n-    public static final String PROPERTY_NATS_KEYSTORE_PW = \"fhirServer/notifications/nats/keystorePassword\";\n-\n-    // Persistence layer properties\n-    public static final String PROPERTY_UPDATE_CREATE_ENABLED = \"fhirServer/persistence/common/updateCreateEnabled\";\n-    public static final String PROPERTY_PERSISTENCE_FACTORY = \"fhirServer/persistence/factoryClassname\";\n-    public static final String PROPERTY_DATASOURCES = \"fhirServer/persistence/datasources\";\n-    @Deprecated\n-    public static final String PROPERTY_JDBC_DATASOURCE_JNDINAME = \"fhirServer/persistence/jdbc/dataSourceJndiName\";\n-    @Deprecated\n-    public static final String PROPERTY_JDBC_ENABLE_PROXY_DATASOURCE = \"fhirServer/persistence/jdbc/enableProxyDatasource\";\n-    public static final String PROPERTY_JDBC_ENABLE_READ_ONLY_REPLICAS = \"fhirServer/persistence/jdbc/enableReadOnlyReplicas\";\n-    public static final String PROPERTY_JDBC_ENABLE_CODE_SYSTEMS_CACHE = \"fhirServer/persistence/jdbc/enableCodeSystemsCache\";\n-    public static final String PROPERTY_JDBC_ENABLE_PARAMETER_NAMES_CACHE = \"fhirServer/persistence/jdbc/enableParameterNamesCache\";\n-    public static final String PROPERTY_JDBC_ENABLE_RESOURCE_TYPES_CACHE = \"fhirServer/persistence/jdbc/enableResourceTypesCache\";\n-    public static final String PROPERTY_JDBC_EXTERNAL_REF_SYSTEM_CACHE_SIZE = \"fhirServer/persistence/jdbc/externalRefSystemCacheSize\";\n-    public static final String PROPERTY_JDBC_EXTERNAL_REF_VALUE_CACHE_SIZE = \"fhirServer/persistence/jdbc/externalRefValueCacheSize\";\n-\n-    // Optimizer options within a datasource definition\n-    public static final String PROPERTY_JDBC_SEARCH_OPTIMIZER_OPTIONS = \"searchOptimizerOptions\";\n-\n-    // fhir-search - Bounding area\n-    public static final String PROPERTY_SEARCH_BOUNDING_AREA_RADIUS_TYPE = \"fhirServer/search/useBoundingRadius\";\n-\n-    // bulkdata\n-    // JavaBatch Job id encryption key\n-    public static final String PROPERTY_BULKDATA_BATCHJOBID_ENCRYPTION_KEY = \"fhirServer/bulkdata/bulkDataBatchJobIdEncryptionKey\";\n-    // JavaBatch Job parameters\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_PARAMETERS  = \"fhirServer/bulkdata/jobParameters\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_APPLICATIONNAME = \"fhirServer/bulkdata/applicationName\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_MODULENAME = \"fhirServer/bulkdata/moduleName\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_JOBXMLNAME = \"fhirServer/bulkdata/jobXMLName\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_IMPTYPE = \"fhirServer/bulkdata/implementation_type\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_BATCHURI = \"fhirServer/bulkdata/batch-uri\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_BATCHUSER = \"fhirServer/bulkdata/batch-user\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_BATCHUSERPWD = \"fhirServer/bulkdata/batch-user-password\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_BATCHTRUSTSTORE = \"fhirServer/bulkdata/batch-truststore\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_BATCHTRUSTSTOREPWD = \"fhirServer/bulkdata/batch-truststore-password\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_USEFHIRSERVERTRUSTSTORE = \"fhirServer/bulkdata/useFhirServerTrustStore\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_ENABLEPARQUET = \"fhirServer/bulkdata/enableParquet\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_SYSTEMEXPIMPL = \"fhirServer/bulkdata/systemExportImpl\";\n-\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_VALID_BASE_URLS = \"fhirServer/bulkdata/validBaseUrls\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_VALID_URLS_DISABLED = \"fhirServer/bulkdata/validBaseUrlsDisabled\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_MAX_INPUT_PER_TENANT =\n-            \"fhirServer/bulkdata/maxInputPerRequest\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_COSFILEMAXSIZE = \"fhirServer/bulkdata/cosFileMaxSize\";\n-    public static final String PROPERTY_BULKDATA_BATCHJOB_COSFILEMAXRESOURCES = \"fhirServer/bulkdata/cosFileMaxResources\";\n-    public static final String PROPERTY_BULKDATA_PATIENTEXPORT_PAGESIZE = \"fhirServer/bulkdata/patientExportPageSize\";\n-    // Control if push OperationOutcomes to COS/S3.\n-    public static final String PROPERTY_BULKDATA_IGNORE_IMPORT_OPERATION_OUTCOMES = \"fhirServer/bulkdata/ignoreImportOutcomes\";\n-\n-    // Custom header names\n-    public static final String DEFAULT_TENANT_ID_HEADER_NAME = \"X-FHIR-TENANT-ID\";\n-    public static final String DEFAULT_DATASTORE_ID_HEADER_NAME = \"X-FHIR-DSID\";\n-    public static final String DEFAULT_PRETTY_RESPONSE_HEADER_NAME = \"X-FHIR-FORMATTED\";\n-\n-    public static final String FHIR_SERVER_DEFAULT_CONFIG = \"config/default/fhir-server-config.json\";\n-\n-    // Optional \"home directory\" for config files.  Defaults to current directory.\n-    private static String configHome = \"\";\n-\n-    private static FHIRConfiguration _instance = new FHIRConfiguration();\n-\n-    public static FHIRConfiguration getInstance() {\n-        return _instance;\n-    }\n-\n-    /**\n-     * This is our in-memory cache of PropertyGroup's keyed by tenant-id.\n-     */\n-    private TenantSpecificPropertyGroupCache configCache = new TenantSpecificPropertyGroupCache();\n-\n-    /**\n-     * This method is used to configure an explicit top-level directory where FHIR Server configuration\n-     * information is expected to reside.\n-     * <p>\n-     * For example, by calling this method with value \"/mydir\", then we'd expect\n-     * to find config files whose names are of the form: {@code \"/mydir/config/<tenant-id>/fhir-server-config.json\"}\n-     * <p>\n-     * The default location for config files is the current working directory (i.e. \"\" - the empty string).\n-     * @param s the new config home directory name\n-     */\n-    public static void setConfigHome(String s) {\n-        if (s == null) {\n-            s = \"\";\n-        }\n-        if (!s.isEmpty() && !s.endsWith(File.separator)) {\n-            s += File.separator;\n-        }\n-\n-        configHome = s;\n-    }\n-\n-    /**\n-     * Returns the \"home\" directory for FHIR Server configuration information (this directory will contain\n-     * the \"config\" directory, etc.).\n-     * <p>\n-     * The default value of this property is \"\" which is interpreted to mean the current working directory\n-     * (which for a running FHIR Server will be $WLP_HOME/wlp/usr/servers/fhir-server).\n-     */\n-    public static String getConfigHome() {\n-        return configHome;\n-    }\n-\n-    /**\n-     * Retrieves the FHIR Server default configuration and returns it as a PropertyGroup.\n-     *\n-     * @return the top-level property group of the default tenant or null if it doesn't exist\n-     * @throws Exception if the configuration file was found but couldn't be loaded\n-     */\n-    public PropertyGroup loadConfiguration() throws Exception {\n-        return loadConfigurationForTenant(DEFAULT_TENANT_ID);\n-    }\n-\n-    /**\n-     * Loads the configuration for the specified tenant id.\n-     *\n-     * @param tenantId\n-     *            a shortname representing the tenant whose configuration will be loaded\n-     * @return the top-level property group representing this tenant's configuration or null if it doesn't exist\n-     * @throws Exception\n-     */\n-    public PropertyGroup loadConfigurationForTenant(String tenantId) throws Exception {\n-        return configCache.getCachedObjectForTenant(tenantId);\n-    }\n-\n-    /**\n-     * Clears the entire cache of configuration objects. This can be used perhaps during testing when you need to clear\n-     * and re-load the configuration.\n-     */\n-    public void clearConfiguration() {\n-        synchronized (configCache) {\n-            configCache.clearCache();\n-        }\n-    }\n-\n-    /**\n-     * This method returns the list of tenant id's for which a configuration exists.\n-     * @return\n-     */\n-    public List<String> getConfiguredTenants() {\n-        log.entering(this.getClass().getName(), \"getConfiguredTenants\");\n-\n-        try {\n-            List<String> result = new ArrayList<>();\n-\n-            // 'configDir' represents the directory that contains the tenant ids\n-            // Example: \"/opt/ibm/fhir-server/wlp/usr/servers/fhir-server/config\".\n-            File configDir = new File(getConfigHome() + CONFIG_LOCATION);\n-            log.fine(\"Listing tenant id's rooted at directory: \" + configDir.getName());\n-\n-            // List the directories within 'configDir' that contain a fhir-server-config.json file.\n-            for (File f : configDir.listFiles()) {\n-                // For a directory, let's verify that a config exists within it.\n-                // If yes, then add the name of the directory to the result list, as that\n-                // represents a tenant id.\n-                if (f.isDirectory()) {\n-                    File configFile = new File(f, CONFIG_FILE_BASENAME);\n-                    if (configFile.exists() && configFile.isFile()) {\n-                        result.add(f.getName());\n-                    }\n-                }\n-            }\n-\n-            log.fine(\"Returning list of tenant ids: \" + result.toString());\n-\n-            return result;\n-        } finally {\n-            log.exiting(this.getClass().getName(), \"getConfiguredTenants\");\n-        }\n-    }\n-}\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MDA5Nw==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408960097", "body": "javadoc?", "bodyText": "javadoc?", "bodyHTML": "<p dir=\"auto\">javadoc?</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:06:12Z", "path": "fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java", "diffHunk": "@@ -108,7 +108,13 @@ public static boolean isDefinitionalResource(Resource resource) {\n         return isDefinitionalResourceType(resource.getClass());\n     }\n \n-    private static boolean isDefinitionalResourceType(Class<?> resourceType) {\n+    public static void requireDefinitionalResourceType(Class<? extends Resource> resourceType) {", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk5MTgxOA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408991818", "bodyText": "Added Javadoc to both methods", "author": "JohnTimm", "createdAt": "2020-04-15T16:55:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MDA5Nw=="}], "type": "inlineReview", "revised_code": {"commit": "15dbedca4fc5f06a49056334b10579d5d126d2eb", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\nindex 0326c7e6a4..126f35ad33 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\n", "chunk": "@@ -108,12 +108,28 @@ public final class FHIRRegistryUtil {\n         return isDefinitionalResourceType(resource.getClass());\n     }\n \n+    /**\n+     * Throw an {@link IllegalArgumentException} if the resource type is not a definitional resource type per:\n+     * <a href=\"http://hl7.org/fhir/definition.html\">http://hl7.org/fhir/definition.html</a>\n+     *\n+     * @param resourceType\n+     *     the resourceType\n+     */\n     public static void requireDefinitionalResourceType(Class<? extends Resource> resourceType) {\n         if (!isDefinitionalResourceType(resourceType)) {\n             throw new IllegalArgumentException(resourceType.getSimpleName() + \" is not a definitional resource type\");\n         }\n     }\n \n+    /**\n+     * Indicates whether the resource type is a definitional resource type per:\n+     * <a href=\"http://hl7.org/fhir/definition.html\">http://hl7.org/fhir/definition.html</a>\n+     *\n+     * @param resourceType\n+     *     the resource type\n+     * @return\n+     *     true if the resource type is a definitional resource, false otherwise\n+     */\n     public static boolean isDefinitionalResourceType(Class<? extends Resource> resourceType) {\n         return DEFINITIONAL_RESOURCE_TYPES.contains(resourceType);\n     }\n", "next_change": {"commit": "8199e7f1bff5e1eb3cbc9e33e5fc0138bf180801", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\nindex 126f35ad33..75c8c525f3 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\n", "chunk": "@@ -138,7 +139,7 @@ public final class FHIRRegistryUtil {\n         try (BufferedReader reader = new BufferedReader(new InputStreamReader(FHIRRegistryUtil.class.getClassLoader().getResourceAsStream(path), StandardCharsets.UTF_8))) {\n             return FHIRParser.parser(Format.JSON).parse(reader);\n         } catch (Exception e) {\n-            log.warning(\"Unable to load resource: \" + path + \" due to the following exception: \" + e.getMessage());\n+            log.log(Level.WARNING, \"Unable to load resource: \" + path, e);\n         }\n         return null;\n     }\n", "next_change": {"commit": "4b1806fd7fc34ac7cd2c581a3a89cabe8c5222cc", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\nindex 75c8c525f3..905b99e620 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/util/FHIRRegistryUtil.java\n", "chunk": "@@ -136,8 +133,12 @@ public final class FHIRRegistryUtil {\n     }\n \n     public static Resource loadResource(String path) {\n-        try (BufferedReader reader = new BufferedReader(new InputStreamReader(FHIRRegistryUtil.class.getClassLoader().getResourceAsStream(path), StandardCharsets.UTF_8))) {\n-            return FHIRParser.parser(Format.JSON).parse(reader);\n+        try (InputStream in = FHIRRegistryUtil.class.getClassLoader().getResourceAsStream(path)) {\n+            if (in == null) {\n+                log.log(Level.WARNING, \"Resource at '\" + path + \"' was not found\");\n+                return null;\n+            }\n+            return FHIRParser.parser(Format.JSON).parse(in);\n         } catch (Exception e) {\n             log.log(Level.WARNING, \"Unable to load resource: \" + path, e);\n         }\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MTI0Mg==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408961242", "body": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyText": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyHTML": "<p dir=\"auto\">Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:07:53Z", "path": "fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java", "diffHunk": "@@ -143,6 +157,7 @@ public String getLatestVersion(String url, Class<? extends Resource> resourceTyp\n      */", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3MDQ5Mw==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408970493", "bodyText": "An IllegalArgumentException will not be thrown if the resource isn't definitional for this method. The method will simply return null.", "author": "JohnTimm", "createdAt": "2020-04-15T16:21:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MTI0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "15dbedca4fc5f06a49056334b10579d5d126d2eb", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 75e62e7965..1b2c9d2c34 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -154,6 +169,8 @@ public final class FHIRRegistry {\n      *     the resource type\n      * @return\n      *     the resources for the given resource type\n+     * @throws IllegalArgumentException\n+     *     if the resource type is not a definitional resource type\n      */\n     public <T extends Resource> Collection<T> getResources(Class<T> resourceType) {\n         Objects.requireNonNull(resourceType);\n", "next_change": {"commit": "b7b48408b2ca1692a2f173a3318675fda505f212", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 1b2c9d2c34..1c6d139ae7 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -175,11 +179,13 @@ public final class FHIRRegistry {\n     public <T extends Resource> Collection<T> getResources(Class<T> resourceType) {\n         Objects.requireNonNull(resourceType);\n         requireDefinitionalResourceType(resourceType);\n-        return providers.stream()\n-                .map(provider -> provider.getRegistryResources(resourceType))\n-                .flatMap(Collection::stream)\n-                .map(registryResource -> resourceType.cast(registryResource.getResource()))\n-                .collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList));\n+        List<T> resources = new ArrayList<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            for (FHIRRegistryResource registryResource : provider.getRegistryResources(resourceType)) {\n+                resources.add(resourceType.cast(registryResource.getResource()));\n+            }\n+        }\n+        return Collections.unmodifiableList(resources);\n     }\n \n     /**\n", "next_change": {"commit": "5fa8f939c9d735b62db82465a2c92c4ee0b0c62a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 1c6d139ae7..d37b38e44b 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -188,31 +184,6 @@ public final class FHIRRegistry {\n         return Collections.unmodifiableList(resources);\n     }\n \n-    /**\n-     * Get the profiles that constrain the given resource type as a collection of {@link Canonical} URLs\n-     *\n-     * @param type\n-     *     the constrained resource type\n-     * @return\n-     *     the profiles that constrain the given type as a collection of {@link Canonical} URLs\n-     */\n-    public Collection<Canonical> getProfiles(String type) {\n-        Objects.requireNonNull(type);\n-        if (!ModelSupport.isResourceType(type)) {\n-            throw new IllegalArgumentException(\"The type argument must be a valid FHIR resource type name\");\n-        }\n-        List<FHIRRegistryResource> registryResources = new ArrayList<>();\n-        for (FHIRRegistryResourceProvider provider : providers) {\n-            registryResources.addAll(provider.getProfileResources(type));\n-        }\n-        Collections.sort(registryResources);\n-        List<Canonical> profiles = new ArrayList<>();\n-        for (FHIRRegistryResource registryResource : registryResources) {\n-            profiles.add(Canonical.of(registryResource.getUrl(), registryResource.getVersion().toString()));\n-        }\n-        return Collections.unmodifiableList(profiles);\n-    }\n-\n     /**\n      * Get the search parameters with the given search parameter type (e.g. string, token, etc.)\n      *\n", "next_change": {"commit": "4fb5d81909a40293d4f8783c035b6207515ace3a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex d37b38e44b..1786a1d5de 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -184,6 +186,28 @@ public final class FHIRRegistry {\n         return Collections.unmodifiableList(resources);\n     }\n \n+    /**\n+     * Get the registry resources for the given resource type\n+     *\n+     * <p>Use this method to get FHIR registry resources (metadata) and not actual FHIR resources\n+     *\n+     * @param resourceType\n+     *     the resource type\n+     * @return\n+     *     the registry resources for the given resource type\n+     * @throws IllegalArgumentException\n+     *     if the resource type is not a definitional resource type\n+     */\n+    public Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType) {\n+        Objects.requireNonNull(resourceType);\n+        requireDefinitionalResourceType(resourceType);\n+        List<FHIRRegistryResource> registryResources = new ArrayList<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            registryResources.addAll(provider.getRegistryResources(resourceType));\n+        }\n+        return registryResources;\n+    }\n+\n     /**\n      * Get the search parameters with the given search parameter type (e.g. string, token, etc.)\n      *\n", "next_change": {"commit": "e4f30db890b96be3175c03632905cdbc83f1fdd7", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\ndeleted file mode 100644\nindex 1786a1d5de..0000000000\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ /dev/null\n", "chunk": "@@ -1,332 +0,0 @@\n-/*\n- * (C) Copyright IBM Corp. 2019, 2021\n- *\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n-package com.ibm.fhir.registry;\n-\n-import static com.ibm.fhir.registry.util.FHIRRegistryUtil.isDefinitionalResourceType;\n-import static com.ibm.fhir.registry.util.FHIRRegistryUtil.requireDefinitionalResourceType;\n-\n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.HashSet;\n-import java.util.LinkedHashSet;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Objects;\n-import java.util.ServiceLoader;\n-import java.util.Set;\n-import java.util.concurrent.CopyOnWriteArrayList;\n-import java.util.logging.Logger;\n-\n-import com.ibm.fhir.model.resource.DomainResource;\n-import com.ibm.fhir.model.resource.Resource;\n-import com.ibm.fhir.model.resource.SearchParameter;\n-import com.ibm.fhir.model.type.Canonical;\n-import com.ibm.fhir.model.type.code.SearchParamType;\n-import com.ibm.fhir.model.util.ModelSupport;\n-import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n-import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n-\n-/**\n- * A singleton registry for FHIR definitional resources: <a href=\"http://hl7.org/fhir/definition.html\">http://hl7.org/fhir/definition.html</a>\n- */\n-public final class FHIRRegistry {\n-    private static final Logger log = Logger.getLogger(FHIRRegistry.class.getName());\n-\n-    private static final FHIRRegistry INSTANCE = new FHIRRegistry();\n-\n-    private final List<FHIRRegistryResourceProvider> providers;\n-\n-    private FHIRRegistry() {\n-        providers = new CopyOnWriteArrayList<>(loadProviders());\n-    }\n-\n-    /**\n-     * Add a registry resource provider to the registry\n-     *\n-     * @implNote\n-     *     This method should not be called by consumers that make their registry resource providers available through\n-     *     the service loader\n-     * @param provider\n-     *     the registry resource provider to be added\n-     */\n-    public void addProvider(FHIRRegistryResourceProvider provider) {\n-        Objects.requireNonNull(provider);\n-        providers.add(provider);\n-    }\n-\n-    /**\n-     * Get the latest version of a resource for the given url and resource type\n-     *\n-     * @param url\n-     *     the url\n-     * @param resourceType\n-     *     the resource type\n-     * @return\n-     *     the latest version of a resource for the given url and resource type if exists, null otherwise\n-     */\n-    public String getLatestVersion(String url, Class<? extends Resource> resourceType) {\n-        if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return null;\n-        }\n-\n-        int index = url.indexOf(\"|\");\n-        if (index != -1) {\n-            url = url.substring(0, index);\n-        }\n-\n-        FHIRRegistryResource resource = findRegistryResource(resourceType, url, null);\n-        return (resource != null) ? resource.getVersion().toString() : null;\n-    }\n-\n-    /**\n-     * Get a map containing sets of type specific canonical URLs for all profile resources across all providers.\n-     *\n-     * @return\n-     *     the map of sets\n-     */\n-    public Map<String, Set<Canonical>> getProfiles() {\n-        Map<String, Set<Canonical>> map = new HashMap<>();\n-        for (FHIRRegistryResourceProvider provider : providers) {\n-            for (FHIRRegistryResource r : provider.getProfileResources()) {\n-                map.computeIfAbsent(r.getType(), k -> new LinkedHashSet<>())\n-                    .add(Canonical.of(r.getUrl(), r.getVersion().toString()));\n-            }\n-        }\n-        return map;\n-    }\n-\n-    /**\n-     * Get the profiles that constrain the given resource type as a collection of {@link Canonical} URLs\n-     *\n-     * @param type\n-     *     the constrained resource type\n-     * @return\n-     *     the profiles that constrain the given type as a collection of {@link Canonical} URLs\n-     */\n-    public Collection<Canonical> getProfiles(String type) {\n-        Objects.requireNonNull(type);\n-        if (!ModelSupport.isResourceType(type)) {\n-            throw new IllegalArgumentException(\"The type argument must be a valid FHIR resource type name\");\n-        }\n-        List<FHIRRegistryResource> registryResources = new ArrayList<>();\n-        for (FHIRRegistryResourceProvider provider : providers) {\n-            registryResources.addAll(provider.getProfileResources(type));\n-        }\n-        Collections.sort(registryResources);\n-        List<Canonical> profiles = new ArrayList<>();\n-        for (FHIRRegistryResource registryResource : registryResources) {\n-            profiles.add(Canonical.of(registryResource.getUrl(), registryResource.getVersion().toString()));\n-        }\n-        return Collections.unmodifiableList(profiles);\n-    }\n-\n-    /**\n-     * Get the resource for the given canonical url and resource type\n-     *\n-     * @param url\n-     *     the canonical url\n-     * @param resourceType\n-     *     the resource type\n-     * @return\n-     *     the resource for the given canonical url and resource type if exists, null otherwise\n-     * @throws ClassCastException\n-     *     if the resource exists in the registry but its type does not match given resource type\n-     * @throws IllegalArgumentException\n-     *     if the resource type is not a definitional resource type\n-     */\n-    public <T extends Resource> T getResource(String url, Class<T> resourceType) {\n-        Objects.requireNonNull(url);\n-        Objects.requireNonNull(resourceType);\n-        requireDefinitionalResourceType(resourceType);\n-\n-        String id = null;\n-        int index = url.indexOf(\"#\");\n-        if (index != -1) {\n-            id = url.substring(index + 1);\n-            url = url.substring(0, index);\n-        }\n-\n-        String version = null;\n-        index = url.indexOf(\"|\");\n-        if (index != -1) {\n-            version = url.substring(index + 1);\n-            url = url.substring(0, index);\n-        }\n-\n-        return resourceType.cast(getResource(findRegistryResource(resourceType, url, version), url, id));\n-    }\n-\n-    /**\n-     * Get the resources for the given resource type\n-     *\n-     * <p>Use this method to get actual FHIR resources and not FHIR registry resources (metadata)\n-     *\n-     * @param resourceType\n-     *     the resource type\n-     * @return\n-     *     the resources for the given resource type\n-     * @throws IllegalArgumentException\n-     *     if the resource type is not a definitional resource type\n-     */\n-    public <T extends Resource> Collection<T> getResources(Class<T> resourceType) {\n-        Objects.requireNonNull(resourceType);\n-        requireDefinitionalResourceType(resourceType);\n-        List<T> resources = new ArrayList<>();\n-        for (FHIRRegistryResourceProvider provider : providers) {\n-            for (FHIRRegistryResource registryResource : provider.getRegistryResources(resourceType)) {\n-                resources.add(resourceType.cast(registryResource.getResource()));\n-            }\n-        }\n-        return Collections.unmodifiableList(resources);\n-    }\n-\n-    /**\n-     * Get the registry resources for the given resource type\n-     *\n-     * <p>Use this method to get FHIR registry resources (metadata) and not actual FHIR resources\n-     *\n-     * @param resourceType\n-     *     the resource type\n-     * @return\n-     *     the registry resources for the given resource type\n-     * @throws IllegalArgumentException\n-     *     if the resource type is not a definitional resource type\n-     */\n-    public Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType) {\n-        Objects.requireNonNull(resourceType);\n-        requireDefinitionalResourceType(resourceType);\n-        List<FHIRRegistryResource> registryResources = new ArrayList<>();\n-        for (FHIRRegistryResourceProvider provider : providers) {\n-            registryResources.addAll(provider.getRegistryResources(resourceType));\n-        }\n-        return registryResources;\n-    }\n-\n-    /**\n-     * Get the search parameters with the given search parameter type (e.g. string, token, etc.)\n-     *\n-     * <p>The method {@link FHIRRegistry#getResources(Class)} can be used to get all search parameters regardless of type\n-     *\n-     * @param type\n-     *     the search parameter type\n-     * @return\n-     *     the search parameters with the given search parameter type\n-     */\n-    public Collection<SearchParameter> getSearchParameters(String type) {\n-        Objects.requireNonNull(type);\n-        SearchParamType.Value.from(type);\n-        List<SearchParameter> searchParameters = new ArrayList<>();\n-        for (FHIRRegistryResourceProvider provider : providers) {\n-            for (FHIRRegistryResource registryResource : provider.getSearchParameterResources(type)) {\n-                searchParameters.add(registryResource.getResource().as(SearchParameter.class));\n-            }\n-        }\n-        return Collections.unmodifiableList(searchParameters);\n-\n-    }\n-\n-    /**\n-     * Indicates whether a resource for the given canonical url and resource type exists in the registry\n-     *\n-     * @param url\n-     *     the canonical url\n-     * @param resourceType\n-     *     the resource type\n-     * @return\n-     *     true if a resource for the given canonical url and resource type exists in the registry, false otherwise\n-     */\n-    public boolean hasResource(String url, Class<? extends Resource> resourceType) {\n-        if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return false;\n-        }\n-\n-        String id = null;\n-        int index = url.indexOf(\"#\");\n-        if (index != -1) {\n-            id = url.substring(index + 1);\n-            url = url.substring(0, index);\n-        }\n-\n-        String version = null;\n-        index = url.indexOf(\"|\");\n-        if (index != -1) {\n-            version = url.substring(index + 1);\n-            url = url.substring(0, index);\n-        }\n-\n-        FHIRRegistryResource registryResource = findRegistryResource(resourceType, url, version);\n-        return (id != null) ? (getResource(registryResource, url, id) != null) : (registryResource != null);\n-    }\n-\n-    private FHIRRegistryResource findRegistryResource(Class<? extends Resource> resourceType, String url, String version) {\n-        if (version == null) {\n-            // find the latest version of the registry resource with the specified resourceType and url (across all providers)\n-            Set<FHIRRegistryResource> distinct = new HashSet<>();\n-            for (FHIRRegistryResourceProvider provider : providers) {\n-                FHIRRegistryResource registryResource = provider.getRegistryResource(resourceType, url, version);\n-                if (registryResource != null) {\n-                    distinct.add(registryResource);\n-                }\n-            }\n-            List<FHIRRegistryResource> registryResources = new ArrayList<>(distinct);\n-            Collections.sort(registryResources);\n-            return !registryResources.isEmpty() ? registryResources.get(registryResources.size() - 1) : null;\n-        }\n-        // find the first registry resource with the specified resourceType, url, and version\n-        for (FHIRRegistryResourceProvider provider : providers) {\n-            FHIRRegistryResource registryResource = provider.getRegistryResource(resourceType, url, version);\n-            if (registryResource != null) {\n-                return registryResource;\n-            }\n-        }\n-        return null;\n-    }\n-\n-    private Resource getResource(FHIRRegistryResource registryResource, String url, String id) {\n-        if (registryResource == null) {\n-            return null;\n-        }\n-        Resource resource = registryResource.getResource();\n-        if (resource != null && id != null) {\n-            if (resource.is(DomainResource.class)) {\n-                for (Resource contained : resource.as(DomainResource.class).getContained()) {\n-                    if (id.equals(contained.getId())) {\n-                        return contained;\n-                    }\n-                }\n-                log.warning(\"Unable to find contained resource with id: \" + id + \" in resource: \" + url);\n-            } else {\n-                log.warning(\"Resource: \" + url + \" is not a DomainResource\");\n-            }\n-            return null;\n-        }\n-        return resource;\n-    }\n-\n-    private List<FHIRRegistryResourceProvider> loadProviders() {\n-        List<FHIRRegistryResourceProvider> providers = new ArrayList<>();\n-        for (FHIRRegistryResourceProvider provider : ServiceLoader.load(FHIRRegistryResourceProvider.class)) {\n-            providers.add(provider);\n-        }\n-        return providers;\n-    }\n-\n-    /**\n-     * Get the singleton instance of this class\n-     *\n-     * <p>This first time that this method is called, all registry resource providers made available through the\n-     * service loader are added to the registry\n-     *\n-     * @return\n-     *     the singleton instance of this class\n-     */\n-    public static FHIRRegistry getInstance() {\n-        return INSTANCE;\n-    }\n-}\n", "next_change": null}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MjUxMw==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408962513", "body": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyText": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyHTML": "<p dir=\"auto\">Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:09:46Z", "path": "fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java", "diffHunk": "@@ -115,6 +128,7 @@ public String getLatestVersion(String url, Class<? extends Resource> resourceTyp\n     public <T extends Resource> T getResource(String url, Class<T> resourceType) {", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3NDc0MA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408974740", "bodyText": "Added Javadoc", "author": "JohnTimm", "createdAt": "2020-04-15T16:28:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MjUxMw=="}], "type": "inlineReview", "revised_code": {"commit": "15dbedca4fc5f06a49056334b10579d5d126d2eb", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 75e62e7965..1b2c9d2c34 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -124,6 +137,8 @@ public final class FHIRRegistry {\n      *     the resource for the given canonical url and resource type if exists, null otherwise\n      * @throws ClassCastException\n      *     if the resource exists in the registry but its type does not match given resource type\n+     * @throws IllegalArgumentException\n+     *     if the resource type is not a definitional resource type\n      */\n     public <T extends Resource> T getResource(String url, Class<T> resourceType) {\n         Objects.requireNonNull(url);\n", "next_change": {"commit": "0995e95d2f72ac3ba1b7aaea305e4c7b86db961a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 1b2c9d2c34..a8f939b499 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -140,7 +162,7 @@ public final class FHIRRegistry {\n      * @throws IllegalArgumentException\n      *     if the resource type is not a definitional resource type\n      */\n-    public <T extends Resource> T getResource(String url, Class<T> resourceType) {\n+    public <T extends Resource> T getResource(String url, Class<T> resourceType, String providerName) {\n         Objects.requireNonNull(url);\n         Objects.requireNonNull(resourceType);\n         requireDefinitionalResourceType(resourceType);\n", "next_change": {"commit": "83d05e4d53abfafbb8b8520f1def3e74d5365e1e", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex a8f939b499..539591bb64 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -162,7 +160,7 @@ public final class FHIRRegistry {\n      * @throws IllegalArgumentException\n      *     if the resource type is not a definitional resource type\n      */\n-    public <T extends Resource> T getResource(String url, Class<T> resourceType, String providerName) {\n+    public <T extends Resource> T getResource(String url, Class<T> resourceType, String providerNameToExclude) {\n         Objects.requireNonNull(url);\n         Objects.requireNonNull(resourceType);\n         requireDefinitionalResourceType(resourceType);\n", "next_change": null}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MjY2Mw==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408962663", "body": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyText": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyHTML": "<p dir=\"auto\">Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:10:01Z", "path": "fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java", "diffHunk": "@@ -87,7 +100,7 @@ public boolean hasResource(String url, Class<? extends Resource> resourceType) {\n      *     the latest version of a resource for the given url and resource type if exists, null otherwise\n      */\n     public String getLatestVersion(String url, Class<? extends Resource> resourceType) {", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3NTQxNQ==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408975415", "bodyText": "Added Javadoc", "author": "JohnTimm", "createdAt": "2020-04-15T16:29:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MjY2Mw=="}], "type": "inlineReview", "revised_code": {"commit": "5fa8f939c9d735b62db82465a2c92c4ee0b0c62a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 75e62e7965..d37b38e44b 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -42,75 +46,84 @@ public final class FHIRRegistry {\n         providers = new CopyOnWriteArrayList<>(loadProviders());\n     }\n \n-    public static FHIRRegistry getInstance() {\n-        return INSTANCE;\n-    }\n-\n     /**\n-     * Register a provider\n+     * Add a registry resource provider to the registry\n      *\n+     * @implNote\n+     *     This method should not be called by consumers that make their registry resource providers available through\n+     *     the service loader\n      * @param provider\n-     *     the provider to register\n+     *     the registry resource provider to be added\n      */\n-    public void register(FHIRRegistryResourceProvider provider) {\n+    public void addProvider(FHIRRegistryResourceProvider provider) {\n+        Objects.requireNonNull(provider);\n         providers.add(provider);\n     }\n \n     /**\n-     * Indicates whether a resource for the given canonical url and resource type exists in the registry\n+     * Get the latest version of a resource for the given url and resource type\n      *\n      * @param url\n-     *     the canonical url\n+     *     the url\n      * @param resourceType\n      *     the resource type\n      * @return\n-     *     true if a resource for the given canonical url and resource type exists in the registry, false otherwise\n+     *     the latest version of a resource for the given url and resource type if exists, null otherwise\n      */\n-    public boolean hasResource(String url, Class<? extends Resource> resourceType) {\n+    public String getLatestVersion(String url, Class<? extends Resource> resourceType) {\n         if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return false;\n-        }\n-\n-        String id = null;\n-        int index = url.indexOf(\"#\");\n-        if (index != -1) {\n-            id = url.substring(index + 1);\n-            url = url.substring(0, index);\n+            return null;\n         }\n \n-        String version = null;\n-        index = url.indexOf(\"|\");\n+        int index = url.indexOf(\"|\");\n         if (index != -1) {\n-            version = url.substring(index + 1);\n             url = url.substring(0, index);\n         }\n \n-        FHIRRegistryResource registryResource = findRegistryResource(resourceType, url, version);\n-        return (id != null) ? (getResource(registryResource, url, id) != null) : (registryResource != null);\n+        FHIRRegistryResource resource = findRegistryResource(resourceType, url, null);\n+        return (resource != null) ? resource.getVersion().toString() : null;\n     }\n \n     /**\n-     * Get the latest version of a resource for the given url and resource type\n+     * Get a map containing sets of type specific canonical URLs for all profile resources across all providers.\n      *\n-     * @param url\n-     *     the url\n-     * @param resourceType\n-     *     the resource type\n      * @return\n-     *     the latest version of a resource for the given url and resource type if exists, null otherwise\n+     *     the map of sets\n      */\n-    public String getLatestVersion(String url, Class<? extends Resource> resourceType) {\n-        if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return null;\n+    public Map<String, Set<Canonical>> getProfiles() {\n+        Map<String, Set<Canonical>> map = new HashMap<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            for (FHIRRegistryResource r : provider.getProfileResources()) {\n+                map.computeIfAbsent(r.getType(), k -> new LinkedHashSet<>())\n+                    .add(Canonical.of(r.getUrl(), r.getVersion().toString()));\n+            }\n         }\n+        return map;\n+    }\n \n-        int index = url.indexOf(\"|\");\n-        if (index != -1) {\n-            url = url.substring(0, index);\n+    /**\n+     * Get the profiles that constrain the given resource type as a collection of {@link Canonical} URLs\n+     *\n+     * @param type\n+     *     the constrained resource type\n+     * @return\n+     *     the profiles that constrain the given type as a collection of {@link Canonical} URLs\n+     */\n+    public Collection<Canonical> getProfiles(String type) {\n+        Objects.requireNonNull(type);\n+        if (!ModelSupport.isResourceType(type)) {\n+            throw new IllegalArgumentException(\"The type argument must be a valid FHIR resource type name\");\n         }\n-\n-        FHIRRegistryResource resource = findRegistryResource(resourceType, url, null);\n-        return (resource != null) ? resource.getVersion().toString() : null;\n+        List<FHIRRegistryResource> registryResources = new ArrayList<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            registryResources.addAll(provider.getProfileResources(type));\n+        }\n+        Collections.sort(registryResources);\n+        List<Canonical> profiles = new ArrayList<>();\n+        for (FHIRRegistryResource registryResource : registryResources) {\n+            profiles.add(Canonical.of(registryResource.getUrl(), registryResource.getVersion().toString()));\n+        }\n+        return Collections.unmodifiableList(profiles);\n     }\n \n     /**\n", "next_change": {"commit": "95d1278d95698fa4d33c0b8cc0513e88ca6fbdec", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex d37b38e44b..3a851627db 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -130,7 +130,7 @@ public final class FHIRRegistry {\n      * Get the resource for the given canonical url and resource type\n      *\n      * @param url\n-     *     the canonical url\n+     *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n      * @return\n", "next_change": {"commit": "0995e95d2f72ac3ba1b7aaea305e4c7b86db961a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 3a851627db..a8f939b499 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -133,6 +133,8 @@ public final class FHIRRegistry {\n      *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n+     * @param providerName\n+     *     the canonical class name of the provider that is calling get resources\n      * @return\n      *     the resource for the given canonical url and resource type if exists, null otherwise\n      * @throws ClassCastException\n", "next_change": {"commit": "f99d231e4481ef29321c4c5829b8652e7316fc88", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex a8f939b499..62288c377a 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -133,8 +133,6 @@ public final class FHIRRegistry {\n      *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n-     * @param providerName\n-     *     the canonical class name of the provider that is calling get resources\n      * @return\n      *     the resource for the given canonical url and resource type if exists, null otherwise\n      * @throws ClassCastException\n", "next_change": {"commit": "27a82bc37e8a7728efe4f286d9e71efba7df29b0", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 62288c377a..eca94070c0 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -130,7 +131,7 @@ public final class FHIRRegistry {\n      * Get the resource for the given canonical url and resource type\n      *\n      * @param url\n-     *     the canonical url (with optional version postfix)\n+     *     the canonical url (with optional version postfix and optional fragment id for contained resources)\n      * @param resourceType\n      *     the resource type\n      * @return\n", "next_change": null}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MjcyNA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408962724", "body": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyText": "Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException", "bodyHTML": "<p dir=\"auto\">Add documentation that says you can only call this for definitional resource types and that otherwise it will throw an IllegalArgumentException</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:10:09Z", "path": "fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java", "diffHunk": "@@ -54,7 +67,7 @@ public static FHIRRegistry getInstance() {\n      *     true if a resource for the given canonical url and resource type exists in the registry, false otherwise\n      */\n     public boolean hasResource(String url, Class<? extends Resource> resourceType) {", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3NTkxOA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408975918", "bodyText": "An IllegalArgumentException will not be thrown if the resource isn't definitional for this method. The method will simple return false.", "author": "JohnTimm", "createdAt": "2020-04-15T16:30:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk2MjcyNA=="}], "type": "inlineReview", "revised_code": {"commit": "5fa8f939c9d735b62db82465a2c92c4ee0b0c62a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 75e62e7965..d37b38e44b 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -42,75 +46,84 @@ public final class FHIRRegistry {\n         providers = new CopyOnWriteArrayList<>(loadProviders());\n     }\n \n-    public static FHIRRegistry getInstance() {\n-        return INSTANCE;\n-    }\n-\n     /**\n-     * Register a provider\n+     * Add a registry resource provider to the registry\n      *\n+     * @implNote\n+     *     This method should not be called by consumers that make their registry resource providers available through\n+     *     the service loader\n      * @param provider\n-     *     the provider to register\n+     *     the registry resource provider to be added\n      */\n-    public void register(FHIRRegistryResourceProvider provider) {\n+    public void addProvider(FHIRRegistryResourceProvider provider) {\n+        Objects.requireNonNull(provider);\n         providers.add(provider);\n     }\n \n     /**\n-     * Indicates whether a resource for the given canonical url and resource type exists in the registry\n+     * Get the latest version of a resource for the given url and resource type\n      *\n      * @param url\n-     *     the canonical url\n+     *     the url\n      * @param resourceType\n      *     the resource type\n      * @return\n-     *     true if a resource for the given canonical url and resource type exists in the registry, false otherwise\n+     *     the latest version of a resource for the given url and resource type if exists, null otherwise\n      */\n-    public boolean hasResource(String url, Class<? extends Resource> resourceType) {\n+    public String getLatestVersion(String url, Class<? extends Resource> resourceType) {\n         if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return false;\n-        }\n-\n-        String id = null;\n-        int index = url.indexOf(\"#\");\n-        if (index != -1) {\n-            id = url.substring(index + 1);\n-            url = url.substring(0, index);\n+            return null;\n         }\n \n-        String version = null;\n-        index = url.indexOf(\"|\");\n+        int index = url.indexOf(\"|\");\n         if (index != -1) {\n-            version = url.substring(index + 1);\n             url = url.substring(0, index);\n         }\n \n-        FHIRRegistryResource registryResource = findRegistryResource(resourceType, url, version);\n-        return (id != null) ? (getResource(registryResource, url, id) != null) : (registryResource != null);\n+        FHIRRegistryResource resource = findRegistryResource(resourceType, url, null);\n+        return (resource != null) ? resource.getVersion().toString() : null;\n     }\n \n     /**\n-     * Get the latest version of a resource for the given url and resource type\n+     * Get a map containing sets of type specific canonical URLs for all profile resources across all providers.\n      *\n-     * @param url\n-     *     the url\n-     * @param resourceType\n-     *     the resource type\n      * @return\n-     *     the latest version of a resource for the given url and resource type if exists, null otherwise\n+     *     the map of sets\n      */\n-    public String getLatestVersion(String url, Class<? extends Resource> resourceType) {\n-        if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return null;\n+    public Map<String, Set<Canonical>> getProfiles() {\n+        Map<String, Set<Canonical>> map = new HashMap<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            for (FHIRRegistryResource r : provider.getProfileResources()) {\n+                map.computeIfAbsent(r.getType(), k -> new LinkedHashSet<>())\n+                    .add(Canonical.of(r.getUrl(), r.getVersion().toString()));\n+            }\n         }\n+        return map;\n+    }\n \n-        int index = url.indexOf(\"|\");\n-        if (index != -1) {\n-            url = url.substring(0, index);\n+    /**\n+     * Get the profiles that constrain the given resource type as a collection of {@link Canonical} URLs\n+     *\n+     * @param type\n+     *     the constrained resource type\n+     * @return\n+     *     the profiles that constrain the given type as a collection of {@link Canonical} URLs\n+     */\n+    public Collection<Canonical> getProfiles(String type) {\n+        Objects.requireNonNull(type);\n+        if (!ModelSupport.isResourceType(type)) {\n+            throw new IllegalArgumentException(\"The type argument must be a valid FHIR resource type name\");\n         }\n-\n-        FHIRRegistryResource resource = findRegistryResource(resourceType, url, null);\n-        return (resource != null) ? resource.getVersion().toString() : null;\n+        List<FHIRRegistryResource> registryResources = new ArrayList<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            registryResources.addAll(provider.getProfileResources(type));\n+        }\n+        Collections.sort(registryResources);\n+        List<Canonical> profiles = new ArrayList<>();\n+        for (FHIRRegistryResource registryResource : registryResources) {\n+            profiles.add(Canonical.of(registryResource.getUrl(), registryResource.getVersion().toString()));\n+        }\n+        return Collections.unmodifiableList(profiles);\n     }\n \n     /**\n", "next_change": {"commit": "95d1278d95698fa4d33c0b8cc0513e88ca6fbdec", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex d37b38e44b..3a851627db 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -130,7 +130,7 @@ public final class FHIRRegistry {\n      * Get the resource for the given canonical url and resource type\n      *\n      * @param url\n-     *     the canonical url\n+     *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n      * @return\n", "next_change": {"commit": "0995e95d2f72ac3ba1b7aaea305e4c7b86db961a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 3a851627db..a8f939b499 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -133,6 +133,8 @@ public final class FHIRRegistry {\n      *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n+     * @param providerName\n+     *     the canonical class name of the provider that is calling get resources\n      * @return\n      *     the resource for the given canonical url and resource type if exists, null otherwise\n      * @throws ClassCastException\n", "next_change": {"commit": "f99d231e4481ef29321c4c5829b8652e7316fc88", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex a8f939b499..62288c377a 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -133,8 +133,6 @@ public final class FHIRRegistry {\n      *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n-     * @param providerName\n-     *     the canonical class name of the provider that is calling get resources\n      * @return\n      *     the resource for the given canonical url and resource type if exists, null otherwise\n      * @throws ClassCastException\n", "next_change": {"commit": "27a82bc37e8a7728efe4f286d9e71efba7df29b0", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 62288c377a..eca94070c0 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -130,7 +131,7 @@ public final class FHIRRegistry {\n      * Get the resource for the given canonical url and resource type\n      *\n      * @param url\n-     *     the canonical url (with optional version postfix)\n+     *     the canonical url (with optional version postfix and optional fragment id for contained resources)\n      * @param resourceType\n      *     the resource type\n      * @return\n", "next_change": null}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3MDM0Mg==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408970342", "body": "maybe overload the constructor to let the user pass in the cache size?", "bodyText": "maybe overload the constructor to let the user pass in the cache size?", "bodyHTML": "<p dir=\"auto\">maybe overload the constructor to let the user pass in the cache size?</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:21:35Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.server.registry;\n+\n+import static com.ibm.fhir.registry.util.FHIRRegistryUtil.getUrl;\n+import static com.ibm.fhir.registry.util.FHIRRegistryUtil.isDefinitionalResource;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import com.ibm.fhir.core.util.LRUCache;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.resource.SearchParameter;\n+import com.ibm.fhir.model.resource.StructureDefinition;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.MultiResourceResult;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.persistence.helper.PersistenceHelper;\n+import com.ibm.fhir.persistence.interceptor.FHIRPersistenceEvent;\n+import com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptor;\n+import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n+import com.ibm.fhir.registry.resource.FHIRRegistryResource.Version;\n+import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvider, FHIRPersistenceInterceptor {\n+    public static final Logger log = Logger.getLogger(ServerRegistryResourceProvider.class.getName());\n+\n+    private final PersistenceHelper persistenceHelper;\n+    private final Map<String, List<FHIRRegistryResource>> registryResourceMap = LRUCache.createLRUCache(1024);", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3NjI3OA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408976278", "bodyText": "This is used internally and is not intended to be configured / controlled by the user.", "author": "JohnTimm", "createdAt": "2020-04-15T16:30:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3MDM0Mg=="}], "type": "inlineReview", "revised_code": {"commit": "21beff5026a437c3ba291decc9555fd540fbecbd", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex 3b1fe9881e..a70be18da2 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -42,7 +44,7 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n     public static final Logger log = Logger.getLogger(ServerRegistryResourceProvider.class.getName());\n \n     private final PersistenceHelper persistenceHelper;\n-    private final Map<String, List<FHIRRegistryResource>> registryResourceMap = LRUCache.createLRUCache(1024);\n+    private final Map<String, Map<String, List<FHIRRegistryResource>>> registryResourceMap = new ConcurrentHashMap<>();\n \n     public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n         try {\n", "next_change": {"commit": "557470aee0e286572ba9610b842aca85198dcb41", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex a70be18da2..2a550920b0 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -1,50 +1,44 @@\n /*\n- * (C) Copyright IBM Corp. 2020\n+ * (C) Copyright IBM Corp. 2020, 2021\n  *\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n package com.ibm.fhir.server.registry;\n \n-import static com.ibm.fhir.registry.util.FHIRRegistryUtil.getUrl;\n-import static com.ibm.fhir.registry.util.FHIRRegistryUtil.isDefinitionalResource;\n-\n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.Collection;\n import java.util.Collections;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n-import java.util.concurrent.ConcurrentHashMap;\n import java.util.logging.Level;\n import java.util.logging.Logger;\n import java.util.stream.Collectors;\n \n-import com.ibm.fhir.config.FHIRRequestContext;\n-import com.ibm.fhir.core.util.LRUCache;\n import com.ibm.fhir.model.resource.Resource;\n import com.ibm.fhir.model.resource.SearchParameter;\n import com.ibm.fhir.model.resource.StructureDefinition;\n+import com.ibm.fhir.model.type.code.ResourceType;\n import com.ibm.fhir.persistence.FHIRPersistence;\n import com.ibm.fhir.persistence.MultiResourceResult;\n import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.exception.FHIRPersistenceException;\n import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n import com.ibm.fhir.persistence.helper.PersistenceHelper;\n-import com.ibm.fhir.persistence.interceptor.FHIRPersistenceEvent;\n-import com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptor;\n import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n import com.ibm.fhir.registry.resource.FHIRRegistryResource.Version;\n import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n import com.ibm.fhir.search.context.FHIRSearchContext;\n import com.ibm.fhir.search.util.SearchUtil;\n \n-public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvider, FHIRPersistenceInterceptor {\n+public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvider {\n     public static final Logger log = Logger.getLogger(ServerRegistryResourceProvider.class.getName());\n \n     private final PersistenceHelper persistenceHelper;\n-    private final Map<String, Map<String, List<FHIRRegistryResource>>> registryResourceMap = new ConcurrentHashMap<>();\n \n     public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n         try {\n", "next_change": {"commit": "e635bdc373005dfd39a5cbaf8bb33760a8be9090", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex 2a550920b0..9bae54819e 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -40,6 +47,8 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n \n     private final PersistenceHelper persistenceHelper;\n \n+    private final Map<CacheKey, List<FHIRRegistryResource>> registryResourceCache = createCacheAsMap(1024, Duration.of(1, ChronoUnit.MINUTES));\n+\n     public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n         try {\n             this.persistenceHelper = Objects.requireNonNull(persistenceHelper);\n", "next_change": {"commit": "b3f10c83e3bdad3e95140dda9381319b906e1f81", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex 9bae54819e..03a1ebb6eb 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -37,17 +38,17 @@ import com.ibm.fhir.persistence.exception.FHIRPersistenceException;\n import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n import com.ibm.fhir.persistence.helper.PersistenceHelper;\n import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n-import com.ibm.fhir.registry.resource.FHIRRegistryResource.Version;\n-import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n+import com.ibm.fhir.registry.spi.AbstractRegistryResourceProvider;\n import com.ibm.fhir.search.context.FHIRSearchContext;\n import com.ibm.fhir.search.util.SearchUtil;\n \n-public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvider {\n+public class ServerRegistryResourceProvider extends AbstractRegistryResourceProvider {\n     public static final Logger log = Logger.getLogger(ServerRegistryResourceProvider.class.getName());\n \n-    private final PersistenceHelper persistenceHelper;\n+    public static final String REGISTRY_RESOURCE_CACHE_NAME = \"com.ibm.fhir.server.registry.ServerRegistryResourceProvider.registryResourceCache\";\n+    public static final Configuration REGISTRY_RESOURCE_CACHE_CONFIGURATION = Configuration.of(1024, Duration.of(1, ChronoUnit.MINUTES));\n \n-    private final Map<CacheKey, List<FHIRRegistryResource>> registryResourceCache = createCacheAsMap(1024, Duration.of(1, ChronoUnit.MINUTES));\n+    private final PersistenceHelper persistenceHelper;\n \n     public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n         try {\n", "next_change": {"commit": "634e61f02756e8731c12be1196d876def7236c82", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex 03a1ebb6eb..3932ad6490 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -49,21 +49,23 @@ public class ServerRegistryResourceProvider extends AbstractRegistryResourceProv\n     public static final Configuration REGISTRY_RESOURCE_CACHE_CONFIGURATION = Configuration.of(1024, Duration.of(1, ChronoUnit.MINUTES));\n \n     private final PersistenceHelper persistenceHelper;\n+    private final SearchUtil searchHelper;\n \n-    public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n-        try {\n-            this.persistenceHelper = Objects.requireNonNull(persistenceHelper);\n-        } catch (Exception e) {\n-            throw new Error(e);\n-        }\n+    public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper, SearchUtil searchHelper) {\n+        this.persistenceHelper = Objects.requireNonNull(persistenceHelper);\n+        this.searchHelper = Objects.requireNonNull(searchHelper);\n     }\n \n     @Override\n     protected List<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType, String url) {\n         String dataStoreId = FHIRRequestContext.get().getDataStoreId();\n         CacheKey key = key(dataStoreId, url);\n-        Map<CacheKey, List<FHIRRegistryResource>> cacheAsMap = CacheManager.getCacheAsMap(REGISTRY_RESOURCE_CACHE_NAME, REGISTRY_RESOURCE_CACHE_CONFIGURATION);\n-        return cacheAsMap.computeIfAbsent(key, k -> computeRegistryResources(resourceType, url));\n+        try {\n+            Map<CacheKey, List<FHIRRegistryResource>> cacheAsMap = CacheManager.getCacheAsMap(REGISTRY_RESOURCE_CACHE_NAME, REGISTRY_RESOURCE_CACHE_CONFIGURATION);\n+            return cacheAsMap.computeIfAbsent(key, k -> computeRegistryResources(resourceType, url));\n+        } finally {\n+            CacheManager.reportCacheStats(log, REGISTRY_RESOURCE_CACHE_NAME);\n+        }\n     }\n \n     @Override\n", "next_change": null}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3Mzk5NA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408973994", "body": "maybe a comment here to explain that getInstance() loads all the static providers", "bodyText": "maybe a comment here to explain that getInstance() loads all the static providers", "bodyHTML": "<p dir=\"auto\">maybe a comment here to explain that getInstance() loads all the static providers</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:27:14Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java", "diffHunk": "@@ -127,6 +131,14 @@ public void contextInitialized(ServletContextEvent event) {\n             log.fine(\"Initializing FHIRRegistry...\");\n             FHIRRegistry.getInstance();\n \n+            Boolean serverRegistryResourceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED, Boolean.FALSE);\n+            if (serverRegistryResourceProviderEnabled) {\n+                log.info(\"Registering ServerRegistryResourceProvider...\");\n+                ServerRegistryResourceProvider provider = new ServerRegistryResourceProvider(persistenceHelper);\n+                FHIRRegistry.getInstance().register(provider);", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk4ODgxNg==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408988816", "bodyText": "Added Javadoc", "author": "JohnTimm", "createdAt": "2020-04-15T16:50:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3Mzk5NA=="}], "type": "inlineReview", "revised_code": {"commit": "93f7ef50f6b5276d3a04a39fb1c351b33302ada5", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 7afd94b1e2..b44bf944f5 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -139,6 +209,20 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 FHIRPersistenceInterceptorMgr.getInstance().addInterceptor(provider);\n             }\n \n+            Boolean graphTermServiceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_ENABLED, Boolean.FALSE);\n+            if (graphTermServiceProviderEnabled) {\n+                log.info(\"Adding GraphTermServiceProvider...\");\n+                PropertyGroup propertyGroup = fhirConfig.getPropertyGroup(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_CONFIGURATION);\n+                if (propertyGroup == null) {\n+                    log.log(Level.WARNING, \"GraphTermServiceProvider configuration not found\");\n+                } else {\n+                    Map<String, Object> map = new HashMap<>();\n+                    propertyGroup.getProperties().stream().forEach(entry -> map.put(entry.getName(), entry.getValue()));\n+                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map));\n+                    FHIRTermService.getInstance().addProvider(graphTermServiceProvider);\n+                }\n+            }\n+\n             // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n         } catch(Throwable t) {\n", "next_change": {"commit": "28a6ad48105d0acb7747dc80c1ee1a2834ce29d8", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex b44bf944f5..c656a82cf3 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -209,20 +188,6 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 FHIRPersistenceInterceptorMgr.getInstance().addInterceptor(provider);\n             }\n \n-            Boolean graphTermServiceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_ENABLED, Boolean.FALSE);\n-            if (graphTermServiceProviderEnabled) {\n-                log.info(\"Adding GraphTermServiceProvider...\");\n-                PropertyGroup propertyGroup = fhirConfig.getPropertyGroup(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_CONFIGURATION);\n-                if (propertyGroup == null) {\n-                    log.log(Level.WARNING, \"GraphTermServiceProvider configuration not found\");\n-                } else {\n-                    Map<String, Object> map = new HashMap<>();\n-                    propertyGroup.getProperties().stream().forEach(entry -> map.put(entry.getName(), entry.getValue()));\n-                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map));\n-                    FHIRTermService.getInstance().addProvider(graphTermServiceProvider);\n-                }\n-            }\n-\n             // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n         } catch(Throwable t) {\n", "next_change": {"commit": "7ca7f7ed1a9707fca4a7d31a75b27d2ad3eeca9c", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex c656a82cf3..5a59a7b8fe 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -188,6 +198,20 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 FHIRPersistenceInterceptorMgr.getInstance().addInterceptor(provider);\n             }\n \n+            Boolean graphTermServiceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_ENABLED, Boolean.FALSE);\n+            if (graphTermServiceProviderEnabled) {\n+                log.info(\"Adding GraphTermServiceProvider...\");\n+                PropertyGroup propertyGroup = fhirConfig.getPropertyGroup(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_CONFIGURATION);\n+                if (propertyGroup == null) {\n+                    log.log(Level.WARNING, \"GraphTermServiceProvider configuration not found\");\n+                } else {\n+                    Map<String, Object> map = new HashMap<>();\n+                    propertyGroup.getProperties().stream().forEach(entry -> map.put(entry.getName(), entry.getValue()));\n+                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map));\n+                    FHIRTermService.getInstance().addProvider(graphTermServiceProvider);\n+                }\n+            }\n+\n             // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n         } catch(Throwable t) {\n", "next_change": {"commit": "809f55cbe99ea4d40ed38fe1a5da3cd24286d42b", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 5a59a7b8fe..d7a568d25a 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -198,20 +186,6 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 FHIRPersistenceInterceptorMgr.getInstance().addInterceptor(provider);\n             }\n \n-            Boolean graphTermServiceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_ENABLED, Boolean.FALSE);\n-            if (graphTermServiceProviderEnabled) {\n-                log.info(\"Adding GraphTermServiceProvider...\");\n-                PropertyGroup propertyGroup = fhirConfig.getPropertyGroup(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_CONFIGURATION);\n-                if (propertyGroup == null) {\n-                    log.log(Level.WARNING, \"GraphTermServiceProvider configuration not found\");\n-                } else {\n-                    Map<String, Object> map = new HashMap<>();\n-                    propertyGroup.getProperties().stream().forEach(entry -> map.put(entry.getName(), entry.getValue()));\n-                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map));\n-                    FHIRTermService.getInstance().addProvider(graphTermServiceProvider);\n-                }\n-            }\n-\n             // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n         } catch(Throwable t) {\n", "next_change": {"commit": "22b10795eab90d2a759e71f981f70e2b2595057c", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex d7a568d25a..cca6a759e9 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -186,6 +195,20 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 FHIRPersistenceInterceptorMgr.getInstance().addInterceptor(provider);\n             }\n \n+            Boolean graphTermServiceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_ENABLED, Boolean.FALSE);\n+            if (graphTermServiceProviderEnabled) {\n+                log.info(\"Adding GraphTermServiceProvider...\");\n+                PropertyGroup propertyGroup = fhirConfig.getPropertyGroup(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_CONFIGURATION);\n+                if (propertyGroup == null) {\n+                    log.log(Level.WARNING, \"GraphTermServiceProvider configuration not found\");\n+                } else {\n+                    Map<String, Object> map = new HashMap<>();\n+                    propertyGroup.getProperties().stream().forEach(entry -> map.put(entry.getName(), entry.getValue()));\n+                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map));\n+                    FHIRTermService.getInstance().addProvider(graphTermServiceProvider);\n+                }\n+            }\n+\n             // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n         } catch(Throwable t) {\n", "next_change": {"commit": "f79a867e3e12230e4b218145d0e1a7cdcc152de1", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex cca6a759e9..2163a7ba33 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -204,7 +205,8 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 } else {\n                     Map<String, Object> map = new HashMap<>();\n                     propertyGroup.getProperties().stream().forEach(entry -> map.put(entry.getName(), entry.getValue()));\n-                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map));\n+                    int timeLimit = fhirConfig.getIntProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_TIME_LIMIT, GraphTermServiceProvider.DEFAULT_TIME_LIMIT);\n+                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map), timeLimit);\n                     FHIRTermService.getInstance().addProvider(graphTermServiceProvider);\n                 }\n             }\n", "next_change": {"commit": "bc7c3c32f9811843c72a84216bd099f064e5096f", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 2163a7ba33..5f3966f2f9 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -211,6 +220,61 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 }\n             }\n \n+            PropertyGroup termPropertyGroup = fhirConfig.getPropertyGroup(\"fhirServer/term\");\n+            if (termPropertyGroup != null) {\n+                Object[] remoteTermServiceProvidersArray = termPropertyGroup.getArrayProperty(\"remoteTermServiceProviders\");\n+                if (remoteTermServiceProvidersArray != null) {\n+                    for (Object remoteTermServiceProviderObject : remoteTermServiceProvidersArray) {\n+                        PropertyGroup remoteTermServiceProviderPropertyGroup = (PropertyGroup) remoteTermServiceProviderObject;\n+                        try {\n+                            Configuration.Builder builder = Configuration.builder();\n+\n+                            builder.base(remoteTermServiceProviderPropertyGroup.getStringProperty(\"base\"));\n+\n+                            PropertyGroup trustStorePropertyGroup = remoteTermServiceProviderPropertyGroup.getPropertyGroup(\"trustStore\");\n+                            if (trustStorePropertyGroup != null) {\n+                                builder.trustStore(TrustStore.builder()\n+                                    .location(trustStorePropertyGroup.getStringProperty(\"location\"))\n+                                    .password(trustStorePropertyGroup.getStringProperty(\"password\"))\n+                                    .type(trustStorePropertyGroup.getStringProperty(\"type\", TrustStore.DEFAULT_TYPE))\n+                                    .build());\n+                            }\n+\n+                            builder.hostnameVerificationEnabled(remoteTermServiceProviderPropertyGroup.getBooleanProperty(\"hostnameVerificationEnabled\", Configuration.DEFAULT_HOSTNAME_VERIFICATION_ENABLED));\n+\n+                            PropertyGroup basicAuthPropertyGroup = remoteTermServiceProviderPropertyGroup.getPropertyGroup(\"basicAuth\");\n+                            if (basicAuthPropertyGroup != null) {\n+                                builder.basicAuth(BasicAuth.builder()\n+                                    .username(basicAuthPropertyGroup.getStringProperty(\"username\"))\n+                                    .password(basicAuthPropertyGroup.getStringProperty(\"password\"))\n+                                    .build());\n+                            }\n+\n+                            builder.httpTimeout(remoteTermServiceProviderPropertyGroup.getIntProperty(\"httpTimeout\", Configuration.DEFAULT_HTTP_TIMEOUT));\n+\n+                            Object[] supportsArray = remoteTermServiceProviderPropertyGroup.getArrayProperty(\"supports\");\n+                            if (supportsArray != null) {\n+                                for (Object supportsObject : supportsArray) {\n+                                    PropertyGroup supportsPropertyGroup = (PropertyGroup) supportsObject;\n+                                    builder.supports(Supports.builder()\n+                                        .system(supportsPropertyGroup.getStringProperty(\"system\"))\n+                                        .version(supportsPropertyGroup.getStringProperty(\"version\"))\n+                                        .build());\n+                                }\n+                            }\n+\n+                            Configuration configuration = builder.build();\n+\n+                            RemoteTermServiceProvider remoteTermServiceProvider = new RemoteTermServiceProvider(configuration);\n+                            FHIRTermService.getInstance().addProvider(remoteTermServiceProvider);\n+                            remoteTermServiceProviders.add(remoteTermServiceProvider);\n+                        } catch (Exception e) {\n+                            log.log(Level.WARNING, \"Unable to create RemoteTermServiceProvider from configuration property group: \" + remoteTermServiceProviderPropertyGroup, e);\n+                        }\n+                    }\n+                }\n+            }\n+\n             // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n         } catch(Throwable t) {\n", "next_change": {"commit": "aa3901cdc664baaa6d5d29f270506d267d4463c0", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 5f3966f2f9..f995fc2847 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -200,80 +199,10 @@ public class FHIRServletContextListener implements ServletContextListener {\n             Boolean serverRegistryResourceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_SERVER_REGISTRY_RESOURCE_PROVIDER_ENABLED, Boolean.FALSE);\n             if (serverRegistryResourceProviderEnabled) {\n                 log.info(\"Registering ServerRegistryResourceProvider...\");\n-                ServerRegistryResourceProvider provider = new ServerRegistryResourceProvider(persistenceHelper);\n-                FHIRRegistry.getInstance().addProvider(provider);\n-                FHIRPersistenceInterceptorMgr.getInstance().addInterceptor(provider);\n+                FHIRRegistry.getInstance().addProvider(new ServerRegistryResourceProvider(persistenceHelper));\n             }\n \n-            Boolean graphTermServiceProviderEnabled = fhirConfig.getBooleanProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_ENABLED, Boolean.FALSE);\n-            if (graphTermServiceProviderEnabled) {\n-                log.info(\"Adding GraphTermServiceProvider...\");\n-                PropertyGroup propertyGroup = fhirConfig.getPropertyGroup(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_CONFIGURATION);\n-                if (propertyGroup == null) {\n-                    log.log(Level.WARNING, \"GraphTermServiceProvider configuration not found\");\n-                } else {\n-                    Map<String, Object> map = new HashMap<>();\n-                    propertyGroup.getProperties().stream().forEach(entry -> map.put(entry.getName(), entry.getValue()));\n-                    int timeLimit = fhirConfig.getIntProperty(PROPERTY_GRAPH_TERM_SERVICE_PROVIDER_TIME_LIMIT, GraphTermServiceProvider.DEFAULT_TIME_LIMIT);\n-                    graphTermServiceProvider = new GraphTermServiceProvider(new MapConfiguration(map), timeLimit);\n-                    FHIRTermService.getInstance().addProvider(graphTermServiceProvider);\n-                }\n-            }\n-\n-            PropertyGroup termPropertyGroup = fhirConfig.getPropertyGroup(\"fhirServer/term\");\n-            if (termPropertyGroup != null) {\n-                Object[] remoteTermServiceProvidersArray = termPropertyGroup.getArrayProperty(\"remoteTermServiceProviders\");\n-                if (remoteTermServiceProvidersArray != null) {\n-                    for (Object remoteTermServiceProviderObject : remoteTermServiceProvidersArray) {\n-                        PropertyGroup remoteTermServiceProviderPropertyGroup = (PropertyGroup) remoteTermServiceProviderObject;\n-                        try {\n-                            Configuration.Builder builder = Configuration.builder();\n-\n-                            builder.base(remoteTermServiceProviderPropertyGroup.getStringProperty(\"base\"));\n-\n-                            PropertyGroup trustStorePropertyGroup = remoteTermServiceProviderPropertyGroup.getPropertyGroup(\"trustStore\");\n-                            if (trustStorePropertyGroup != null) {\n-                                builder.trustStore(TrustStore.builder()\n-                                    .location(trustStorePropertyGroup.getStringProperty(\"location\"))\n-                                    .password(trustStorePropertyGroup.getStringProperty(\"password\"))\n-                                    .type(trustStorePropertyGroup.getStringProperty(\"type\", TrustStore.DEFAULT_TYPE))\n-                                    .build());\n-                            }\n-\n-                            builder.hostnameVerificationEnabled(remoteTermServiceProviderPropertyGroup.getBooleanProperty(\"hostnameVerificationEnabled\", Configuration.DEFAULT_HOSTNAME_VERIFICATION_ENABLED));\n-\n-                            PropertyGroup basicAuthPropertyGroup = remoteTermServiceProviderPropertyGroup.getPropertyGroup(\"basicAuth\");\n-                            if (basicAuthPropertyGroup != null) {\n-                                builder.basicAuth(BasicAuth.builder()\n-                                    .username(basicAuthPropertyGroup.getStringProperty(\"username\"))\n-                                    .password(basicAuthPropertyGroup.getStringProperty(\"password\"))\n-                                    .build());\n-                            }\n-\n-                            builder.httpTimeout(remoteTermServiceProviderPropertyGroup.getIntProperty(\"httpTimeout\", Configuration.DEFAULT_HTTP_TIMEOUT));\n-\n-                            Object[] supportsArray = remoteTermServiceProviderPropertyGroup.getArrayProperty(\"supports\");\n-                            if (supportsArray != null) {\n-                                for (Object supportsObject : supportsArray) {\n-                                    PropertyGroup supportsPropertyGroup = (PropertyGroup) supportsObject;\n-                                    builder.supports(Supports.builder()\n-                                        .system(supportsPropertyGroup.getStringProperty(\"system\"))\n-                                        .version(supportsPropertyGroup.getStringProperty(\"version\"))\n-                                        .build());\n-                                }\n-                            }\n-\n-                            Configuration configuration = builder.build();\n-\n-                            RemoteTermServiceProvider remoteTermServiceProvider = new RemoteTermServiceProvider(configuration);\n-                            FHIRTermService.getInstance().addProvider(remoteTermServiceProvider);\n-                            remoteTermServiceProviders.add(remoteTermServiceProvider);\n-                        } catch (Exception e) {\n-                            log.log(Level.WARNING, \"Unable to create RemoteTermServiceProvider from configuration property group: \" + remoteTermServiceProviderPropertyGroup, e);\n-                        }\n-                    }\n-                }\n-            }\n+            configureTermServiceCapabilities(fhirConfig);\n \n             // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n", "next_change": {"commit": "8e589c46210614fafbd29e1defb8152751d7b5dc", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex f995fc2847..9dc06b39d8 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -202,6 +204,12 @@ public class FHIRServletContextListener implements ServletContextListener {\n                 FHIRRegistry.getInstance().addProvider(new ServerRegistryResourceProvider(persistenceHelper));\n             }\n \n+            Boolean serverResolveFunctionEnabled = fhirConfig.getBooleanProperty(PROPERTY_SERVER_RESOLVE_FUNCTION_ENABLED, Boolean.FALSE);\n+            if (serverResolveFunctionEnabled) {\n+                log.info(\"Registering ServerResolveFunction...\");\n+                FHIRPathFunctionRegistry.getInstance().register(new ServerResolveFunction(persistenceHelper));\n+            }\n+\n             configureTermServiceCapabilities(fhirConfig);\n \n             // Finally, set our \"initComplete\" flag to true.\n", "next_change": {"commit": "338590ddfea42ba0958b899a30ea4cd3f478978a", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 9dc06b39d8..d9b43f085e 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -212,8 +219,11 @@ public class FHIRServletContextListener implements ServletContextListener {\n \n             configureTermServiceCapabilities(fhirConfig);\n \n-            // Finally, set our \"initComplete\" flag to true.\n+            // Set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n+\n+            // Now init is complete, tell all registered callbacks\n+            EventManagerImpl.serverReady(serviceManagerId);\n         } catch(Throwable t) {\n             String msg = \"Encountered an exception while initializing the servlet context.\";\n             log.log(Level.SEVERE, msg, t);\n", "next_change": {"commit": "3d12455051019e10dc6b24827b8a23a04d4b5d77", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex d9b43f085e..80d7382acd 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -223,7 +223,7 @@ public class FHIRServletContextListener implements ServletContextListener {\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n \n             // Now init is complete, tell all registered callbacks\n-            EventManagerImpl.serverReady(serviceManagerId);\n+            EventManager.serverReady(serviceManagerId);\n         } catch(Throwable t) {\n             String msg = \"Encountered an exception while initializing the servlet context.\";\n             log.log(Level.SEVERE, msg, t);\n", "next_change": {"commit": "bcba89404d7752d545897bcd507bd0ed80b7a389", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 80d7382acd..69104abcc6 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -219,11 +221,8 @@ public class FHIRServletContextListener implements ServletContextListener {\n \n             configureTermServiceCapabilities(fhirConfig);\n \n-            // Set our \"initComplete\" flag to true.\n+            // Finally, set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n-\n-            // Now init is complete, tell all registered callbacks\n-            EventManager.serverReady(serviceManagerId);\n         } catch(Throwable t) {\n             String msg = \"Encountered an exception while initializing the servlet context.\";\n             log.log(Level.SEVERE, msg, t);\n", "next_change": {"commit": "1e8e6f4c1a2f8b8b3a57401f5aa26a21f84877f7", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\nindex 69104abcc6..3282e77006 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/listener/FHIRServletContextListener.java\n", "chunk": "@@ -221,8 +227,11 @@ public class FHIRServletContextListener implements ServletContextListener {\n \n             configureTermServiceCapabilities(fhirConfig);\n \n-            // Finally, set our \"initComplete\" flag to true.\n+            // Set our \"initComplete\" flag to true.\n             event.getServletContext().setAttribute(FHIR_SERVER_INIT_COMPLETE, Boolean.TRUE);\n+\n+            // Now init is complete, tell all registered callbacks\n+            EventManager.serverReady(serviceManagerId);\n         } catch(Throwable t) {\n             String msg = \"Encountered an exception while initializing the servlet context.\";\n             log.log(Level.SEVERE, msg, t);\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3NTgwNA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408975804", "body": "Maybe explain that this shouldn't be called by consumers and that they should use the ServiceLoader to make their static RegistryResourceProviders available instead", "bodyText": "Maybe explain that this shouldn't be called by consumers and that they should use the ServiceLoader to make their static RegistryResourceProviders available instead", "bodyHTML": "<p dir=\"auto\">Maybe explain that this shouldn't be called by consumers and that they should use the ServiceLoader to make their static RegistryResourceProviders available instead</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:29:57Z", "path": "fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java", "diffHunk": "@@ -36,13 +39,23 @@\n     private final List<FHIRRegistryResourceProvider> providers;\n \n     private FHIRRegistry() {\n-        providers = loadProviders();\n+        providers = new CopyOnWriteArrayList<>(loadProviders());\n     }\n \n     public static FHIRRegistry getInstance() {\n         return INSTANCE;\n     }\n \n+    /**\n+     * Register a provider\n+     *\n+     * @param provider\n+     *     the provider to register\n+     */\n+    public void register(FHIRRegistryResourceProvider provider) {", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk4ODY5MA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408988690", "bodyText": "Added Javadoc", "author": "JohnTimm", "createdAt": "2020-04-15T16:50:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3NTgwNA=="}], "type": "inlineReview", "revised_code": {"commit": "15dbedca4fc5f06a49056334b10579d5d126d2eb", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 75e62e7965..1b2c9d2c34 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -42,17 +42,30 @@ public final class FHIRRegistry {\n         providers = new CopyOnWriteArrayList<>(loadProviders());\n     }\n \n+    /**\n+     * Get the singleton instance of this class\n+     *\n+     * <p>This first time that this method is called, all registry resource providers made available through the\n+     * service loader are added to the registry\n+     *\n+     * @return\n+     *     the singleton instance of this class\n+     */\n     public static FHIRRegistry getInstance() {\n         return INSTANCE;\n     }\n \n     /**\n-     * Register a provider\n+     * Add a registry resource provider to the registry\n      *\n+     * @implNote\n+     *     This method should not be called by consumers that make their registry resource providers available through\n+     *     the service loader\n      * @param provider\n-     *     the provider to register\n+     *     the registry resource provider to be added\n      */\n     public void register(FHIRRegistryResourceProvider provider) {\n+        Objects.requireNonNull(provider);\n         providers.add(provider);\n     }\n \n", "next_change": {"commit": "b7b48408b2ca1692a2f173a3318675fda505f212", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 1b2c9d2c34..1c6d139ae7 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -64,7 +68,7 @@ public final class FHIRRegistry {\n      * @param provider\n      *     the registry resource provider to be added\n      */\n-    public void register(FHIRRegistryResourceProvider provider) {\n+    public void addProvider(FHIRRegistryResourceProvider provider) {\n         Objects.requireNonNull(provider);\n         providers.add(provider);\n     }\n", "next_change": {"commit": "5fa8f939c9d735b62db82465a2c92c4ee0b0c62a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 1c6d139ae7..d37b38e44b 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -74,60 +61,69 @@ public final class FHIRRegistry {\n     }\n \n     /**\n-     * Indicates whether a resource for the given canonical url and resource type exists in the registry\n+     * Get the latest version of a resource for the given url and resource type\n      *\n      * @param url\n-     *     the canonical url\n+     *     the url\n      * @param resourceType\n      *     the resource type\n      * @return\n-     *     true if a resource for the given canonical url and resource type exists in the registry, false otherwise\n+     *     the latest version of a resource for the given url and resource type if exists, null otherwise\n      */\n-    public boolean hasResource(String url, Class<? extends Resource> resourceType) {\n+    public String getLatestVersion(String url, Class<? extends Resource> resourceType) {\n         if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return false;\n-        }\n-\n-        String id = null;\n-        int index = url.indexOf(\"#\");\n-        if (index != -1) {\n-            id = url.substring(index + 1);\n-            url = url.substring(0, index);\n+            return null;\n         }\n \n-        String version = null;\n-        index = url.indexOf(\"|\");\n+        int index = url.indexOf(\"|\");\n         if (index != -1) {\n-            version = url.substring(index + 1);\n             url = url.substring(0, index);\n         }\n \n-        FHIRRegistryResource registryResource = findRegistryResource(resourceType, url, version);\n-        return (id != null) ? (getResource(registryResource, url, id) != null) : (registryResource != null);\n+        FHIRRegistryResource resource = findRegistryResource(resourceType, url, null);\n+        return (resource != null) ? resource.getVersion().toString() : null;\n     }\n \n     /**\n-     * Get the latest version of a resource for the given url and resource type\n+     * Get a map containing sets of type specific canonical URLs for all profile resources across all providers.\n      *\n-     * @param url\n-     *     the url\n-     * @param resourceType\n-     *     the resource type\n      * @return\n-     *     the latest version of a resource for the given url and resource type if exists, null otherwise\n+     *     the map of sets\n      */\n-    public String getLatestVersion(String url, Class<? extends Resource> resourceType) {\n-        if (url == null || resourceType == null || !isDefinitionalResourceType(resourceType)) {\n-            return null;\n+    public Map<String, Set<Canonical>> getProfiles() {\n+        Map<String, Set<Canonical>> map = new HashMap<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            for (FHIRRegistryResource r : provider.getProfileResources()) {\n+                map.computeIfAbsent(r.getType(), k -> new LinkedHashSet<>())\n+                    .add(Canonical.of(r.getUrl(), r.getVersion().toString()));\n+            }\n         }\n+        return map;\n+    }\n \n-        int index = url.indexOf(\"|\");\n-        if (index != -1) {\n-            url = url.substring(0, index);\n+    /**\n+     * Get the profiles that constrain the given resource type as a collection of {@link Canonical} URLs\n+     *\n+     * @param type\n+     *     the constrained resource type\n+     * @return\n+     *     the profiles that constrain the given type as a collection of {@link Canonical} URLs\n+     */\n+    public Collection<Canonical> getProfiles(String type) {\n+        Objects.requireNonNull(type);\n+        if (!ModelSupport.isResourceType(type)) {\n+            throw new IllegalArgumentException(\"The type argument must be a valid FHIR resource type name\");\n         }\n-\n-        FHIRRegistryResource resource = findRegistryResource(resourceType, url, null);\n-        return (resource != null) ? resource.getVersion().toString() : null;\n+        List<FHIRRegistryResource> registryResources = new ArrayList<>();\n+        for (FHIRRegistryResourceProvider provider : providers) {\n+            registryResources.addAll(provider.getProfileResources(type));\n+        }\n+        Collections.sort(registryResources);\n+        List<Canonical> profiles = new ArrayList<>();\n+        for (FHIRRegistryResource registryResource : registryResources) {\n+            profiles.add(Canonical.of(registryResource.getUrl(), registryResource.getVersion().toString()));\n+        }\n+        return Collections.unmodifiableList(profiles);\n     }\n \n     /**\n", "next_change": {"commit": "95d1278d95698fa4d33c0b8cc0513e88ca6fbdec", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex d37b38e44b..3a851627db 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -130,7 +130,7 @@ public final class FHIRRegistry {\n      * Get the resource for the given canonical url and resource type\n      *\n      * @param url\n-     *     the canonical url\n+     *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n      * @return\n", "next_change": {"commit": "0995e95d2f72ac3ba1b7aaea305e4c7b86db961a", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 3a851627db..a8f939b499 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -133,6 +133,8 @@ public final class FHIRRegistry {\n      *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n+     * @param providerName\n+     *     the canonical class name of the provider that is calling get resources\n      * @return\n      *     the resource for the given canonical url and resource type if exists, null otherwise\n      * @throws ClassCastException\n", "next_change": {"commit": "f99d231e4481ef29321c4c5829b8652e7316fc88", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex a8f939b499..62288c377a 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -133,8 +133,6 @@ public final class FHIRRegistry {\n      *     the canonical url (with optional version postfix)\n      * @param resourceType\n      *     the resource type\n-     * @param providerName\n-     *     the canonical class name of the provider that is calling get resources\n      * @return\n      *     the resource for the given canonical url and resource type if exists, null otherwise\n      * @throws ClassCastException\n", "next_change": {"commit": "27a82bc37e8a7728efe4f286d9e71efba7df29b0", "changed_code": [{"header": "diff --git a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\nindex 62288c377a..eca94070c0 100644\n--- a/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n+++ b/fhir-registry/src/main/java/com/ibm/fhir/registry/FHIRRegistry.java\n", "chunk": "@@ -130,7 +131,7 @@ public final class FHIRRegistry {\n      * Get the resource for the given canonical url and resource type\n      *\n      * @param url\n-     *     the canonical url (with optional version postfix)\n+     *     the canonical url (with optional version postfix and optional fragment id for contained resources)\n      * @param resourceType\n      *     the resource type\n      * @return\n", "next_change": null}]}}]}}]}}]}}]}}]}}]}}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3ODg1OQ==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408978859", "body": "Was debating whether INFO level here is appropriate...we try to be very sparse with those.", "bodyText": "Was debating whether INFO level here is appropriate...we try to be very sparse with those.", "bodyHTML": "<p dir=\"auto\">Was debating whether INFO level here is appropriate...we try to be very sparse with those.</p>", "author": "lmsurpre", "createdAt": "2020-04-15T16:34:57Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * (C) Copyright IBM Corp. 2020\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package com.ibm.fhir.server.registry;\n+\n+import static com.ibm.fhir.registry.util.FHIRRegistryUtil.getUrl;\n+import static com.ibm.fhir.registry.util.FHIRRegistryUtil.isDefinitionalResource;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+\n+import com.ibm.fhir.core.util.LRUCache;\n+import com.ibm.fhir.model.resource.Resource;\n+import com.ibm.fhir.model.resource.SearchParameter;\n+import com.ibm.fhir.model.resource.StructureDefinition;\n+import com.ibm.fhir.persistence.FHIRPersistence;\n+import com.ibm.fhir.persistence.MultiResourceResult;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n+import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n+import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n+import com.ibm.fhir.persistence.helper.PersistenceHelper;\n+import com.ibm.fhir.persistence.interceptor.FHIRPersistenceEvent;\n+import com.ibm.fhir.persistence.interceptor.FHIRPersistenceInterceptor;\n+import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n+import com.ibm.fhir.registry.resource.FHIRRegistryResource.Version;\n+import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n+import com.ibm.fhir.search.context.FHIRSearchContext;\n+import com.ibm.fhir.search.util.SearchUtil;\n+\n+public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvider, FHIRPersistenceInterceptor {\n+    public static final Logger log = Logger.getLogger(ServerRegistryResourceProvider.class.getName());\n+\n+    private final PersistenceHelper persistenceHelper;\n+    private final Map<String, List<FHIRRegistryResource>> registryResourceMap = LRUCache.createLRUCache(1024);\n+\n+    public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n+        try {\n+            this.persistenceHelper = Objects.requireNonNull(persistenceHelper);\n+        } catch (Exception e) {\n+            throw new Error(e);\n+        }\n+    }\n+\n+    @Override\n+    public FHIRRegistryResource getRegistryResource(Class<? extends Resource> resourceType, String url, String version) {\n+        List<FHIRRegistryResource> registryResources = registryResourceMap.computeIfAbsent(url, k -> computeRegistryResources(resourceType, url));\n+        if (!registryResources.isEmpty()) {\n+            if (version != null) {\n+                Version v = Version.from(version);\n+                for (FHIRRegistryResource resource : registryResources) {\n+                    if (resource.getVersion().equals(v)) {\n+                        return resource;\n+                    }\n+                }\n+                log.warning(\"Unable to find resource: \" + url + \" with version: \" + version);\n+            } else {\n+                return registryResources.get(registryResources.size() - 1);\n+            }\n+        }\n+        return null;\n+    }\n+\n+    @Override\n+    public Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType) {\n+        try {\n+            return getRegistryResources(resourceType, Collections.emptyMap());\n+        } catch (Exception e) {\n+            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    @Override\n+    public Collection<FHIRRegistryResource> getRegistryResources() {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public Collection<FHIRRegistryResource> getProfileResources(String type) {\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+        queryParameters.put(\"type\", Collections.singletonList(type));\n+        queryParameters.put(\"kind\", Collections.singletonList(\"resource\"));\n+        queryParameters.put(\"derivation\", Collections.singletonList(\"constraint\"));\n+        return getRegistryResources(StructureDefinition.class, queryParameters);\n+    }\n+\n+    @Override\n+    public Collection<FHIRRegistryResource> getSearchParameterResources(String type) {\n+        Map<String, List<String>> queryParameters = new HashMap<>();\n+        queryParameters.put(\"type\", Collections.singletonList(type));\n+        return getRegistryResources(SearchParameter.class, queryParameters);\n+    }\n+\n+    @Override\n+    public void afterCreate(FHIRPersistenceEvent event) {\n+        updateRegistryResourceMap(event);\n+    }\n+\n+    @Override\n+    public void afterUpdate(FHIRPersistenceEvent event) {\n+        updateRegistryResourceMap(event);\n+    }\n+\n+    @Override\n+    public void afterDelete(FHIRPersistenceEvent event) {\n+        updateRegistryResourceMap(event);\n+    }\n+\n+    private List<FHIRRegistryResource> computeRegistryResources(Class<? extends Resource> resourceType, String url) {\n+        FHIRTransactionHelper transactionHelper = null;\n+        try {\n+            FHIRPersistence persistence = persistenceHelper.getFHIRPersistenceImplementation();\n+            transactionHelper = new FHIRTransactionHelper(persistence.getTransaction());\n+\n+            transactionHelper.begin();\n+\n+            FHIRSearchContext searchContext = SearchUtil.parseQueryParameters(resourceType, Collections.singletonMap(\"url\", Collections.singletonList(url)));\n+            searchContext.setPageSize(1000);\n+\n+            FHIRPersistenceContext context = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+            MultiResourceResult<Resource> result = persistence.search(context, resourceType);\n+\n+            if (result.isSuccess()) {\n+                transactionHelper.commit();\n+                transactionHelper = null;\n+\n+                return result.getResource().stream()\n+                        .map(ServerRegistryResource::from)\n+                        .filter(Objects::nonNull)\n+                        .sorted()\n+                        .collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList));\n+            }\n+        } catch (Exception e) {\n+            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n+        } finally {\n+            if (transactionHelper != null) {\n+                transactionHelper.rollback();\n+            }\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    private Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType, Map<String, List<String>> queryParameters) {\n+        FHIRTransactionHelper transactionHelper = null;\n+        try {\n+            FHIRPersistence persistence = persistenceHelper.getFHIRPersistenceImplementation();\n+            transactionHelper = new FHIRTransactionHelper(persistence.getTransaction());\n+\n+            transactionHelper.begin();\n+\n+            FHIRSearchContext searchContext = SearchUtil.parseQueryParameters(resourceType, queryParameters);\n+            searchContext.setPageSize(1000);\n+\n+            FHIRPersistenceContext context = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n+            MultiResourceResult<Resource> result = persistence.search(context, resourceType);\n+\n+            if (result.isSuccess()) {\n+                List<FHIRRegistryResource> registryResources = new ArrayList<>(searchContext.getTotalCount());\n+                registryResources.addAll(result.getResource().stream()\n+                        .map(ServerRegistryResource::from)\n+                        .filter(Objects::nonNull)\n+                        .collect(Collectors.toList()));\n+\n+                int pageNumber = 1;\n+                int lastPageNumber = searchContext.getLastPageNumber();\n+                while (pageNumber < lastPageNumber) {\n+                    searchContext.setPageNumber(++pageNumber);\n+                    result = persistence.search(context, resourceType);\n+                    registryResources.addAll(result.getResource().stream()\n+                            .map(ServerRegistryResource::from)\n+                            .filter(Objects::nonNull)\n+                            .collect(Collectors.toList()));\n+                }\n+\n+                transactionHelper.commit();\n+                transactionHelper = null;\n+\n+                return Collections.unmodifiableList(registryResources);\n+            }\n+        } catch (Exception e) {\n+            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n+        } finally {\n+            if (transactionHelper != null) {\n+                transactionHelper.rollback();\n+            }\n+        }\n+\n+        return Collections.emptyList();\n+    }\n+\n+    private void updateRegistryResourceMap(FHIRPersistenceEvent event) {\n+        if (event == null || event.getFhirResource() == null || !isDefinitionalResource(event.getFhirResource())) {\n+            return;\n+        }\n+        Resource resource = event.getFhirResource();\n+        String url = getUrl(resource);\n+        if (url != null) {\n+            List<FHIRRegistryResource> previous = registryResourceMap.remove(url);\n+            if (previous != null && !previous.isEmpty()) {\n+                log.info(\"Removed registry resource(s) with url: \" + url);", "originalCommit": "ef0c6da2031624d19ef1446c7a0ea9af18a2d35a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk4NjQ0NA==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408986444", "bodyText": "As discussed on slack, please also make it clear we're just removing them from the cache...not from the registry or the db or something", "author": "lmsurpre", "createdAt": "2020-04-15T16:46:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3ODg1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk5MTcwNw==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r408991707", "bodyText": "Changed to fine", "author": "JohnTimm", "createdAt": "2020-04-15T16:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk3ODg1OQ=="}], "type": "inlineReview", "revised_code": {"commit": "15dbedca4fc5f06a49056334b10579d5d126d2eb", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex 3b1fe9881e..b2c37942a9 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -208,7 +208,7 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n         if (url != null) {\n             List<FHIRRegistryResource> previous = registryResourceMap.remove(url);\n             if (previous != null && !previous.isEmpty()) {\n-                log.info(\"Removed registry resource(s) with url: \" + url);\n+                log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");\n             }\n         }\n     }\n", "next_change": {"commit": "21beff5026a437c3ba291decc9555fd540fbecbd", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex b2c37942a9..a70be18da2 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -206,7 +212,10 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n         Resource resource = event.getFhirResource();\n         String url = getUrl(resource);\n         if (url != null) {\n-            List<FHIRRegistryResource> previous = registryResourceMap.remove(url);\n+            String tenantId = FHIRRequestContext.get().getTenantId();\n+            String dataStoreId = FHIRRequestContext.get().getDataStoreId();\n+            String key = tenantId + \":\" + dataStoreId;\n+            List<FHIRRegistryResource> previous = registryResourceMap.getOrDefault(key, Collections.emptyMap()).remove(url);\n             if (previous != null && !previous.isEmpty()) {\n                 log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");\n             }\n", "next_change": {"commit": "557470aee0e286572ba9610b842aca85198dcb41", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex a70be18da2..2a550920b0 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -198,27 +187,14 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n             log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n         } finally {\n             if (transactionHelper != null) {\n-                transactionHelper.rollback();\n+                try {\n+                    transactionHelper.rollback();\n+                } catch (FHIRPersistenceException e) {\n+                    log.log(Level.WARNING, \"An error occurred ending the current transaction\", e);\n+                }\n             }\n         }\n \n         return Collections.emptyList();\n     }\n-\n-    private void updateRegistryResourceMap(FHIRPersistenceEvent event) {\n-        if (event == null || event.getFhirResource() == null || !isDefinitionalResource(event.getFhirResource())) {\n-            return;\n-        }\n-        Resource resource = event.getFhirResource();\n-        String url = getUrl(resource);\n-        if (url != null) {\n-            String tenantId = FHIRRequestContext.get().getTenantId();\n-            String dataStoreId = FHIRRequestContext.get().getDataStoreId();\n-            String key = tenantId + \":\" + dataStoreId;\n-            List<FHIRRegistryResource> previous = registryResourceMap.getOrDefault(key, Collections.emptyMap()).remove(url);\n-            if (previous != null && !previous.isEmpty()) {\n-                log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");\n-            }\n-        }\n-    }\n }\n", "next_change": {"commit": "e4f30db890b96be3175c03632905cdbc83f1fdd7", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\ndeleted file mode 100644\nindex 2a550920b0..0000000000\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ /dev/null\n", "chunk": "@@ -1,200 +0,0 @@\n-/*\n- * (C) Copyright IBM Corp. 2020, 2021\n- *\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n-package com.ibm.fhir.server.registry;\n-\n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Objects;\n-import java.util.logging.Level;\n-import java.util.logging.Logger;\n-import java.util.stream.Collectors;\n-\n-import com.ibm.fhir.model.resource.Resource;\n-import com.ibm.fhir.model.resource.SearchParameter;\n-import com.ibm.fhir.model.resource.StructureDefinition;\n-import com.ibm.fhir.model.type.code.ResourceType;\n-import com.ibm.fhir.persistence.FHIRPersistence;\n-import com.ibm.fhir.persistence.MultiResourceResult;\n-import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n-import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n-import com.ibm.fhir.persistence.exception.FHIRPersistenceException;\n-import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n-import com.ibm.fhir.persistence.helper.PersistenceHelper;\n-import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n-import com.ibm.fhir.registry.resource.FHIRRegistryResource.Version;\n-import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n-import com.ibm.fhir.search.context.FHIRSearchContext;\n-import com.ibm.fhir.search.util.SearchUtil;\n-\n-public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvider {\n-    public static final Logger log = Logger.getLogger(ServerRegistryResourceProvider.class.getName());\n-\n-    private final PersistenceHelper persistenceHelper;\n-\n-    public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n-        try {\n-            this.persistenceHelper = Objects.requireNonNull(persistenceHelper);\n-        } catch (Exception e) {\n-            throw new Error(e);\n-        }\n-    }\n-\n-    @Override\n-    public FHIRRegistryResource getRegistryResource(Class<? extends Resource> resourceType, String url, String version) {\n-        List<FHIRRegistryResource> registryResources = getRegistryResources(resourceType, url);\n-        if (!registryResources.isEmpty()) {\n-            if (version != null) {\n-                Version v = Version.from(version);\n-                for (FHIRRegistryResource resource : registryResources) {\n-                    if (resource.getVersion().equals(v)) {\n-                        return resource;\n-                    }\n-                }\n-                log.warning(\"Unable to find resource: \" + url + \" with version: \" + version);\n-            } else {\n-                return registryResources.get(registryResources.size() - 1);\n-            }\n-        }\n-        return null;\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType) {\n-        try {\n-            return getRegistryResources(resourceType, Collections.emptyMap());\n-        } catch (Exception e) {\n-            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n-        }\n-        return Collections.emptyList();\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getRegistryResources() {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getProfileResources() {\n-        Map<String, List<String>> queryParameters = new HashMap<>();\n-        String types = Arrays.asList(ResourceType.ValueSet.values()).stream().map(r -> r.value()).collect(Collectors.joining(\",\"));\n-        queryParameters.put(\"type\", Collections.singletonList(types));\n-        queryParameters.put(\"kind\", Collections.singletonList(\"resource\"));\n-        queryParameters.put(\"derivation\", Collections.singletonList(\"constraint\"));\n-        return getRegistryResources(StructureDefinition.class, queryParameters);\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getProfileResources(String type) {\n-        Map<String, List<String>> queryParameters = new HashMap<>();\n-        queryParameters.put(\"type\", Collections.singletonList(type));\n-        queryParameters.put(\"kind\", Collections.singletonList(\"resource\"));\n-        queryParameters.put(\"derivation\", Collections.singletonList(\"constraint\"));\n-        return getRegistryResources(StructureDefinition.class, queryParameters);\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getSearchParameterResources(String type) {\n-        Map<String, List<String>> queryParameters = new HashMap<>();\n-        queryParameters.put(\"type\", Collections.singletonList(type));\n-        return getRegistryResources(SearchParameter.class, queryParameters);\n-    }\n-\n-    private List<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType, String url) {\n-        FHIRTransactionHelper transactionHelper = null;\n-        try {\n-            FHIRPersistence persistence = persistenceHelper.getFHIRPersistenceImplementation();\n-            transactionHelper = new FHIRTransactionHelper(persistence.getTransaction());\n-\n-            transactionHelper.begin();\n-\n-            FHIRSearchContext searchContext = SearchUtil.parseQueryParameters(resourceType, Collections.singletonMap(\"url\", Collections.singletonList(url)));\n-            searchContext.setPageSize(1000);\n-\n-            FHIRPersistenceContext context = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n-            MultiResourceResult<Resource> result = persistence.search(context, resourceType);\n-\n-            if (result.isSuccess()) {\n-                transactionHelper.commit();\n-                transactionHelper = null;\n-\n-                return result.getResource().stream()\n-                        .map(FHIRRegistryResource::from)\n-                        .filter(Objects::nonNull)\n-                        .sorted()\n-                        .collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList));\n-            }\n-        } catch (Exception e) {\n-            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n-        } finally {\n-            if (transactionHelper != null) {\n-                try {\n-                    transactionHelper.rollback();\n-                } catch (FHIRPersistenceException e) {\n-                    log.log(Level.WARNING, \"An error occurred ending the current transaction\", e);\n-                }\n-            }\n-        }\n-        return Collections.emptyList();\n-    }\n-\n-    private Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType, Map<String, List<String>> queryParameters) {\n-        FHIRTransactionHelper transactionHelper = null;\n-        try {\n-            FHIRPersistence persistence = persistenceHelper.getFHIRPersistenceImplementation();\n-            transactionHelper = new FHIRTransactionHelper(persistence.getTransaction());\n-\n-            transactionHelper.begin();\n-\n-            FHIRSearchContext searchContext = SearchUtil.parseQueryParameters(resourceType, queryParameters);\n-            searchContext.setPageSize(1000);\n-\n-            FHIRPersistenceContext context = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n-            MultiResourceResult<Resource> result = persistence.search(context, resourceType);\n-\n-            if (result.isSuccess()) {\n-                List<FHIRRegistryResource> registryResources = new ArrayList<>(searchContext.getTotalCount() != null ? searchContext.getTotalCount() : result.getResource().size());\n-                registryResources.addAll(result.getResource().stream()\n-                        .map(FHIRRegistryResource::from)\n-                        .filter(Objects::nonNull)\n-                        .collect(Collectors.toList()));\n-\n-                int pageNumber = 1;\n-                int lastPageNumber = searchContext.getLastPageNumber();\n-                while (pageNumber < lastPageNumber) {\n-                    searchContext.setPageNumber(++pageNumber);\n-                    result = persistence.search(context, resourceType);\n-                    registryResources.addAll(result.getResource().stream()\n-                            .map(FHIRRegistryResource::from)\n-                            .filter(Objects::nonNull)\n-                            .collect(Collectors.toList()));\n-                }\n-\n-                transactionHelper.commit();\n-                transactionHelper = null;\n-\n-                return Collections.unmodifiableList(registryResources);\n-            }\n-        } catch (Exception e) {\n-            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n-        } finally {\n-            if (transactionHelper != null) {\n-                try {\n-                    transactionHelper.rollback();\n-                } catch (FHIRPersistenceException e) {\n-                    log.log(Level.WARNING, \"An error occurred ending the current transaction\", e);\n-                }\n-            }\n-        }\n-\n-        return Collections.emptyList();\n-    }\n-}\n", "next_change": null}]}}]}}]}}]}}, {"oid": "a9796bd65cc265950463b7ec06fae8f973627c92", "url": "https://github.com/IBM/FHIR/commit/a9796bd65cc265950463b7ec06fae8f973627c92", "message": "Issue #889 - changes per PR feedback\n\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>", "committedDate": "2020-04-15T16:59:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTAxMDExMg==", "url": "https://github.com/IBM/FHIR/pull/928#discussion_r409010112", "body": "```suggestion\r\n                log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");\r\n```", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            log.fine(\"Removed registry resource(s) with url: \" + url);\n          \n          \n            \n                            log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");", "bodyHTML": "  <div class=\"my-2 border rounded-1 js-suggested-changes-blob diff-view js-check-bidi\" id=\"\">\n    <div class=\"f6 p-2 lh-condensed border-bottom d-flex\">\n      <div class=\"flex-auto flex-items-center color-fg-muted\">\n        Suggested change\n        <span class=\"tooltipped tooltipped-multiline tooltipped-s\" aria-label=\"This code change can be committed by users with write permissions.\">\n          <svg aria-hidden=\"true\" height=\"16\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" data-view-component=\"true\" class=\"octicon octicon-info hide-sm\">\n    <path fill-rule=\"evenodd\" d=\"M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z\"></path>\n</svg>\n        </span>\n      </div>\n    </div>\n    <div itemprop=\"text\" class=\"blob-wrapper data file\" style=\"margin: 0; border: none; overflow-y: visible; overflow-x: auto;\">\n      <table class=\"d-table tab-size mb-0 width-full\" data-paste-markdown-skip=\"\">\n          <tbody><tr class=\"border-0\">\n            <td class=\"blob-num blob-num-deletion text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-deletion js-blob-code-deletion blob-code-marker-deletion\">                log<span class=\"pl-k\">.</span>fine(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Removed registry resource(s) with url<span class=\"x x-first x-last\">: </span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> url);</td>\n          </tr>\n          <tr class=\"border-0\">\n            <td class=\"blob-num blob-num-addition text-right border-0 px-2 py-1 lh-default\" data-line-number=\"\"></td>\n            <td class=\"border-0 px-2 py-1 blob-code-inner blob-code-addition js-blob-code-addition blob-code-marker-addition\">                log<span class=\"pl-k\">.</span>fine(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>Removed registry resource(s) with url<span class=\"x x-first x-last\"> '</span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-k\">+</span> url<span class=\"x x-first\"> </span><span class=\"pl-k x\">+</span><span class=\"x\"> </span><span class=\"pl-s\"><span class=\"pl-pds x\">\"</span><span class=\"x\">' from the ServerRegistryResourceProvider cache</span><span class=\"pl-pds x x-last\">\"</span></span>);</td>\n          </tr>\n      </tbody></table>\n    </div>\n    <div class=\"js-apply-changes\"></div>\n  </div>\n", "author": "lmsurpre", "createdAt": "2020-04-15T17:25:05Z", "path": "fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java", "diffHunk": "@@ -208,7 +208,7 @@ private void updateRegistryResourceMap(FHIRPersistenceEvent event) {\n         if (url != null) {\n             List<FHIRRegistryResource> previous = registryResourceMap.remove(url);\n             if (previous != null && !previous.isEmpty()) {\n-                log.info(\"Removed registry resource(s) with url: \" + url);\n+                log.fine(\"Removed registry resource(s) with url: \" + url);", "originalCommit": "a9796bd65cc265950463b7ec06fae8f973627c92", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "15dbedca4fc5f06a49056334b10579d5d126d2eb", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex 59d41a5ab8..b2c37942a9 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -208,7 +208,7 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n         if (url != null) {\n             List<FHIRRegistryResource> previous = registryResourceMap.remove(url);\n             if (previous != null && !previous.isEmpty()) {\n-                log.fine(\"Removed registry resource(s) with url: \" + url);\n+                log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");\n             }\n         }\n     }\n", "next_change": {"commit": "21beff5026a437c3ba291decc9555fd540fbecbd", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex b2c37942a9..a70be18da2 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -206,7 +212,10 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n         Resource resource = event.getFhirResource();\n         String url = getUrl(resource);\n         if (url != null) {\n-            List<FHIRRegistryResource> previous = registryResourceMap.remove(url);\n+            String tenantId = FHIRRequestContext.get().getTenantId();\n+            String dataStoreId = FHIRRequestContext.get().getDataStoreId();\n+            String key = tenantId + \":\" + dataStoreId;\n+            List<FHIRRegistryResource> previous = registryResourceMap.getOrDefault(key, Collections.emptyMap()).remove(url);\n             if (previous != null && !previous.isEmpty()) {\n                 log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");\n             }\n", "next_change": {"commit": "557470aee0e286572ba9610b842aca85198dcb41", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\nindex a70be18da2..2a550920b0 100644\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n", "chunk": "@@ -198,27 +187,14 @@ public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvi\n             log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n         } finally {\n             if (transactionHelper != null) {\n-                transactionHelper.rollback();\n+                try {\n+                    transactionHelper.rollback();\n+                } catch (FHIRPersistenceException e) {\n+                    log.log(Level.WARNING, \"An error occurred ending the current transaction\", e);\n+                }\n             }\n         }\n \n         return Collections.emptyList();\n     }\n-\n-    private void updateRegistryResourceMap(FHIRPersistenceEvent event) {\n-        if (event == null || event.getFhirResource() == null || !isDefinitionalResource(event.getFhirResource())) {\n-            return;\n-        }\n-        Resource resource = event.getFhirResource();\n-        String url = getUrl(resource);\n-        if (url != null) {\n-            String tenantId = FHIRRequestContext.get().getTenantId();\n-            String dataStoreId = FHIRRequestContext.get().getDataStoreId();\n-            String key = tenantId + \":\" + dataStoreId;\n-            List<FHIRRegistryResource> previous = registryResourceMap.getOrDefault(key, Collections.emptyMap()).remove(url);\n-            if (previous != null && !previous.isEmpty()) {\n-                log.fine(\"Removed registry resource(s) with url '\" + url + \"' from the ServerRegistryResourceProvider cache\");\n-            }\n-        }\n-    }\n }\n", "next_change": {"commit": "e4f30db890b96be3175c03632905cdbc83f1fdd7", "changed_code": [{"header": "diff --git a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java b/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\ndeleted file mode 100644\nindex 2a550920b0..0000000000\n--- a/fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\n+++ /dev/null\n", "chunk": "@@ -1,200 +0,0 @@\n-/*\n- * (C) Copyright IBM Corp. 2020, 2021\n- *\n- * SPDX-License-Identifier: Apache-2.0\n- */\n-\n-package com.ibm.fhir.server.registry;\n-\n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.Collection;\n-import java.util.Collections;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Objects;\n-import java.util.logging.Level;\n-import java.util.logging.Logger;\n-import java.util.stream.Collectors;\n-\n-import com.ibm.fhir.model.resource.Resource;\n-import com.ibm.fhir.model.resource.SearchParameter;\n-import com.ibm.fhir.model.resource.StructureDefinition;\n-import com.ibm.fhir.model.type.code.ResourceType;\n-import com.ibm.fhir.persistence.FHIRPersistence;\n-import com.ibm.fhir.persistence.MultiResourceResult;\n-import com.ibm.fhir.persistence.context.FHIRPersistenceContext;\n-import com.ibm.fhir.persistence.context.FHIRPersistenceContextFactory;\n-import com.ibm.fhir.persistence.exception.FHIRPersistenceException;\n-import com.ibm.fhir.persistence.helper.FHIRTransactionHelper;\n-import com.ibm.fhir.persistence.helper.PersistenceHelper;\n-import com.ibm.fhir.registry.resource.FHIRRegistryResource;\n-import com.ibm.fhir.registry.resource.FHIRRegistryResource.Version;\n-import com.ibm.fhir.registry.spi.FHIRRegistryResourceProvider;\n-import com.ibm.fhir.search.context.FHIRSearchContext;\n-import com.ibm.fhir.search.util.SearchUtil;\n-\n-public class ServerRegistryResourceProvider implements FHIRRegistryResourceProvider {\n-    public static final Logger log = Logger.getLogger(ServerRegistryResourceProvider.class.getName());\n-\n-    private final PersistenceHelper persistenceHelper;\n-\n-    public ServerRegistryResourceProvider(PersistenceHelper persistenceHelper) {\n-        try {\n-            this.persistenceHelper = Objects.requireNonNull(persistenceHelper);\n-        } catch (Exception e) {\n-            throw new Error(e);\n-        }\n-    }\n-\n-    @Override\n-    public FHIRRegistryResource getRegistryResource(Class<? extends Resource> resourceType, String url, String version) {\n-        List<FHIRRegistryResource> registryResources = getRegistryResources(resourceType, url);\n-        if (!registryResources.isEmpty()) {\n-            if (version != null) {\n-                Version v = Version.from(version);\n-                for (FHIRRegistryResource resource : registryResources) {\n-                    if (resource.getVersion().equals(v)) {\n-                        return resource;\n-                    }\n-                }\n-                log.warning(\"Unable to find resource: \" + url + \" with version: \" + version);\n-            } else {\n-                return registryResources.get(registryResources.size() - 1);\n-            }\n-        }\n-        return null;\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType) {\n-        try {\n-            return getRegistryResources(resourceType, Collections.emptyMap());\n-        } catch (Exception e) {\n-            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n-        }\n-        return Collections.emptyList();\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getRegistryResources() {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getProfileResources() {\n-        Map<String, List<String>> queryParameters = new HashMap<>();\n-        String types = Arrays.asList(ResourceType.ValueSet.values()).stream().map(r -> r.value()).collect(Collectors.joining(\",\"));\n-        queryParameters.put(\"type\", Collections.singletonList(types));\n-        queryParameters.put(\"kind\", Collections.singletonList(\"resource\"));\n-        queryParameters.put(\"derivation\", Collections.singletonList(\"constraint\"));\n-        return getRegistryResources(StructureDefinition.class, queryParameters);\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getProfileResources(String type) {\n-        Map<String, List<String>> queryParameters = new HashMap<>();\n-        queryParameters.put(\"type\", Collections.singletonList(type));\n-        queryParameters.put(\"kind\", Collections.singletonList(\"resource\"));\n-        queryParameters.put(\"derivation\", Collections.singletonList(\"constraint\"));\n-        return getRegistryResources(StructureDefinition.class, queryParameters);\n-    }\n-\n-    @Override\n-    public Collection<FHIRRegistryResource> getSearchParameterResources(String type) {\n-        Map<String, List<String>> queryParameters = new HashMap<>();\n-        queryParameters.put(\"type\", Collections.singletonList(type));\n-        return getRegistryResources(SearchParameter.class, queryParameters);\n-    }\n-\n-    private List<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType, String url) {\n-        FHIRTransactionHelper transactionHelper = null;\n-        try {\n-            FHIRPersistence persistence = persistenceHelper.getFHIRPersistenceImplementation();\n-            transactionHelper = new FHIRTransactionHelper(persistence.getTransaction());\n-\n-            transactionHelper.begin();\n-\n-            FHIRSearchContext searchContext = SearchUtil.parseQueryParameters(resourceType, Collections.singletonMap(\"url\", Collections.singletonList(url)));\n-            searchContext.setPageSize(1000);\n-\n-            FHIRPersistenceContext context = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n-            MultiResourceResult<Resource> result = persistence.search(context, resourceType);\n-\n-            if (result.isSuccess()) {\n-                transactionHelper.commit();\n-                transactionHelper = null;\n-\n-                return result.getResource().stream()\n-                        .map(FHIRRegistryResource::from)\n-                        .filter(Objects::nonNull)\n-                        .sorted()\n-                        .collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList));\n-            }\n-        } catch (Exception e) {\n-            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n-        } finally {\n-            if (transactionHelper != null) {\n-                try {\n-                    transactionHelper.rollback();\n-                } catch (FHIRPersistenceException e) {\n-                    log.log(Level.WARNING, \"An error occurred ending the current transaction\", e);\n-                }\n-            }\n-        }\n-        return Collections.emptyList();\n-    }\n-\n-    private Collection<FHIRRegistryResource> getRegistryResources(Class<? extends Resource> resourceType, Map<String, List<String>> queryParameters) {\n-        FHIRTransactionHelper transactionHelper = null;\n-        try {\n-            FHIRPersistence persistence = persistenceHelper.getFHIRPersistenceImplementation();\n-            transactionHelper = new FHIRTransactionHelper(persistence.getTransaction());\n-\n-            transactionHelper.begin();\n-\n-            FHIRSearchContext searchContext = SearchUtil.parseQueryParameters(resourceType, queryParameters);\n-            searchContext.setPageSize(1000);\n-\n-            FHIRPersistenceContext context = FHIRPersistenceContextFactory.createPersistenceContext(null, searchContext);\n-            MultiResourceResult<Resource> result = persistence.search(context, resourceType);\n-\n-            if (result.isSuccess()) {\n-                List<FHIRRegistryResource> registryResources = new ArrayList<>(searchContext.getTotalCount() != null ? searchContext.getTotalCount() : result.getResource().size());\n-                registryResources.addAll(result.getResource().stream()\n-                        .map(FHIRRegistryResource::from)\n-                        .filter(Objects::nonNull)\n-                        .collect(Collectors.toList()));\n-\n-                int pageNumber = 1;\n-                int lastPageNumber = searchContext.getLastPageNumber();\n-                while (pageNumber < lastPageNumber) {\n-                    searchContext.setPageNumber(++pageNumber);\n-                    result = persistence.search(context, resourceType);\n-                    registryResources.addAll(result.getResource().stream()\n-                            .map(FHIRRegistryResource::from)\n-                            .filter(Objects::nonNull)\n-                            .collect(Collectors.toList()));\n-                }\n-\n-                transactionHelper.commit();\n-                transactionHelper = null;\n-\n-                return Collections.unmodifiableList(registryResources);\n-            }\n-        } catch (Exception e) {\n-            log.log(Level.WARNING, \"An error occurred during a search interaction\", e);\n-        } finally {\n-            if (transactionHelper != null) {\n-                try {\n-                    transactionHelper.rollback();\n-                } catch (FHIRPersistenceException e) {\n-                    log.log(Level.WARNING, \"An error occurred ending the current transaction\", e);\n-                }\n-            }\n-        }\n-\n-        return Collections.emptyList();\n-    }\n-}\n", "next_change": null}]}}]}}]}}]}}, {"oid": "862315bd01fbd4e8533307a528b6b9ee75a1aa74", "url": "https://github.com/IBM/FHIR/commit/862315bd01fbd4e8533307a528b6b9ee75a1aa74", "message": "Update fhir-server/src/main/java/com/ibm/fhir/server/registry/ServerRegistryResourceProvider.java\r\n\r\nSigned-off-by: John T.E. Timm <johntimm@us.ibm.com>\n\nCo-Authored-By: Lee Surprenant <lmsurpre@us.ibm.com>", "committedDate": "2020-04-15T17:28:33Z", "type": "commit"}]}