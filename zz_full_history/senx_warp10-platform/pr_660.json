{"pr_number": 660, "pr_title": "Change JSON lib from Boon to Jackson", "pr_author": "ftence", "pr_createdAt": "2020-02-10T12:34:07Z", "pr_url": "https://github.com/senx/warp10-platform/pull/660", "merge_commit": "dbf783479129092534c50c80dd028be72aafea63", "timeline": [{"oid": "72fcbd29969f17d9fd2fb891a1195f4b92bc9a88", "url": "https://github.com/senx/warp10-platform/commit/72fcbd29969f17d9fd2fb891a1195f4b92bc9a88", "message": "Abstract all JSON ser/deser and switch to Jackson", "committedDate": "2019-09-04T08:02:39Z", "type": "commit"}, {"oid": "2f3e7f10a9bb6e0f21f4c5b0abccfb3a56f8246e", "url": "https://github.com/senx/warp10-platform/commit/2f3e7f10a9bb6e0f21f4c5b0abccfb3a56f8246e", "message": "Merge branch 'master' of github.com:senx/warp10-platform into json_lib", "committedDate": "2019-12-16T10:55:10Z", "type": "commit"}, {"oid": "e09b1fc193dc78d4d6c692ef8297982b8debe725", "url": "https://github.com/senx/warp10-platform/commit/e09b1fc193dc78d4d6c692ef8297982b8debe725", "message": "Bump Jackson version to 2.10 and simplify API", "committedDate": "2019-12-17T16:40:36Z", "type": "commit"}, {"oid": "0fc5eae82563d568fb22fd36f61009b7dd1cbd19", "url": "https://github.com/senx/warp10-platform/commit/0fc5eae82563d568fb22fd36f61009b7dd1cbd19", "message": "Delegate the stricness to the json serialization lib", "committedDate": "2019-12-20T08:30:44Z", "type": "commit"}, {"oid": "d3a5ceea84749557542a05bcad6b8249668b92c2", "url": "https://github.com/senx/warp10-platform/commit/d3a5ceea84749557542a05bcad6b8249668b92c2", "message": "Small fixes", "committedDate": "2019-12-30T16:22:02Z", "type": "commit"}, {"oid": "aba33e8de08c07f4b5bc28f7c8ec77df52f481fc", "url": "https://github.com/senx/warp10-platform/commit/aba33e8de08c07f4b5bc28f7c8ec77df52f481fc", "message": "Internalize json serialization", "committedDate": "2019-12-31T14:59:23Z", "type": "commit"}, {"oid": "f05ca021c8062c2f90bd08b61b2a4798b4bb141e", "url": "https://github.com/senx/warp10-platform/commit/f05ca021c8062c2f90bd08b61b2a4798b4bb141e", "message": "Use Jackson for serialization because it is faster this way.", "committedDate": "2020-01-03T16:23:41Z", "type": "commit"}, {"oid": "e982250dcfc5cf2b6c07f4baa75b1f63784b8f8e", "url": "https://github.com/senx/warp10-platform/commit/e982250dcfc5cf2b6c07f4baa75b1f63784b8f8e", "message": "Add and improve comments", "committedDate": "2020-01-06T09:00:44Z", "type": "commit"}, {"oid": "2b158c9e42492a5b89aaf5ca7d4d943fefeac1c9", "url": "https://github.com/senx/warp10-platform/commit/2b158c9e42492a5b89aaf5ca7d4d943fefeac1c9", "message": "Merge branch 'master' of github.com:senx/warp10-platform into json_lib", "committedDate": "2020-02-06T08:47:20Z", "type": "commit"}, {"oid": "d3a95b491e62c0301642aaf9dcf8569c39c825a9", "url": "https://github.com/senx/warp10-platform/commit/d3a95b491e62c0301642aaf9dcf8569c39c825a9", "message": "Better handling of max json size and the errors it generates.", "committedDate": "2020-02-07T13:57:12Z", "type": "commit"}, {"oid": "f5173f5e590145bff64573c2728fab88e1517849", "url": "https://github.com/senx/warp10-platform/commit/f5173f5e590145bff64573c2728fab88e1517849", "message": "Add a way to register custom serializers.", "committedDate": "2020-02-07T15:10:51Z", "type": "commit"}, {"oid": "3176c4b51b3f984bda46d6f270530cb6933f0c1d", "url": "https://github.com/senx/warp10-platform/commit/3176c4b51b3f984bda46d6f270530cb6933f0c1d", "message": "Optimization and more conservative limits", "committedDate": "2020-02-10T10:19:32Z", "type": "commit"}, {"oid": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "url": "https://github.com/senx/warp10-platform/commit/1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "message": "Code style and comments", "committedDate": "2020-02-10T10:26:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2NDg4Mw==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377064883", "body": "Comment can be removed.", "bodyText": "Comment can be removed.", "bodyHTML": "<p dir=\"auto\">Comment can be removed.</p>", "author": "hbs", "createdAt": "2020-02-10T13:35:51Z", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1451,7 +1443,7 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n             pw.print(Boolean.TRUE.equals(value) ? \"true\" : \"false\");\n           } else {\n             //pw.print(gson.toJson(value.toString()));", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex f5a2737b..3868365c 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1442,7 +1442,6 @@ public class EgressFetchHandler extends AbstractHandler {\n           } else if (value instanceof Boolean) {\n             pw.print(Boolean.TRUE.equals(value) ? \"true\" : \"false\");\n           } else {\n-            //pw.print(gson.toJson(value.toString()));\n             pw.print(JsonUtils.objectToJson(value.toString()));\n           }\n           pw.print(\"]\");\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex f5a2737b..1ebf4bab 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1442,7 +1460,6 @@ public class EgressFetchHandler extends AbstractHandler {\n           } else if (value instanceof Boolean) {\n             pw.print(Boolean.TRUE.equals(value) ? \"true\" : \"false\");\n           } else {\n-            //pw.print(gson.toJson(value.toString()));\n             pw.print(JsonUtils.objectToJson(value.toString()));\n           }\n           pw.print(\"]\");\n", "next_change": {"commit": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 1ebf4bab..8818617f 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1463,8 +1656,8 @@ public class EgressFetchHandler extends AbstractHandler {\n             pw.print(JsonUtils.objectToJson(value.toString()));\n           }\n           pw.print(\"]\");\n-        } while (decoder.next());        \n-        \n+        } while (decoder.next());\n+\n         if (count >= 0) {\n           currentCount += decoded;\n         }\n", "next_change": {"commit": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8818617f..8f5a7546 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1656,8 +1587,8 @@ public class EgressFetchHandler extends AbstractHandler {\n             pw.print(JsonUtils.objectToJson(value.toString()));\n           }\n           pw.print(\"]\");\n-        } while (decoder.next());\n-\n+        } while (decoder.next());        \n+        \n         if (count >= 0) {\n           currentCount += decoded;\n         }\n", "next_change": {"commit": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8f5a7546..c726bf26 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1587,8 +1654,8 @@ public class EgressFetchHandler extends AbstractHandler {\n             pw.print(JsonUtils.objectToJson(value.toString()));\n           }\n           pw.print(\"]\");\n-        } while (decoder.next());        \n-        \n+        } while (decoder.next());\n+\n         if (count >= 0) {\n           currentCount += decoded;\n         }\n", "next_change": null}, {"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8f5a7546..c726bf26 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1597,34 +1664,34 @@ public class EgressFetchHandler extends AbstractHandler {\n         // If displayName is still true it means we should have displayed the name but no value matched,\n         // so set name to null so we correctly display the name for the next decoder if it has values\n         //\n-        \n+\n         if (displayName) {\n           name = null;\n         }\n       }\n-            \n+\n     } catch (Throwable t) {\n       throw t;\n     } finally {\n       if (hasValues) {\n         pw.print(\"]}\");\n       }\n-      pw.print(\"]\");      \n+      pw.print(\"]\");\n     }\n-    \n+\n     lastMeta.set(lastMetadata);\n     lastCount.set(currentCount);\n   }\n-  \n+\n   /**\n    * Output a tab separated version of fetched data. Deduplication is done on the fly so we don't decode twice.\n-   * \n+   *\n    */\n   private static void tsvDump(PrintWriter pw, GTSDecoderIterator iter, long now, long count, boolean raw, boolean dedup, boolean signed, AtomicReference<Metadata> lastMeta, AtomicLong lastCount, boolean sortMeta, boolean expose) throws IOException {\n-    \n+\n     String name = null;\n     Map<String,String> labels = null;\n-    \n+\n     StringBuilder classSB = new StringBuilder();\n     StringBuilder labelsSB = new StringBuilder();\n     StringBuilder attributesSB = new StringBuilder();\n", "next_change": null}]}}, {"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8818617f..8f5a7546 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1666,34 +1597,34 @@ public class EgressFetchHandler extends AbstractHandler {\n         // If displayName is still true it means we should have displayed the name but no value matched,\n         // so set name to null so we correctly display the name for the next decoder if it has values\n         //\n-\n+        \n         if (displayName) {\n           name = null;\n         }\n       }\n-\n+            \n     } catch (Throwable t) {\n       throw t;\n     } finally {\n       if (hasValues) {\n         pw.print(\"]}\");\n       }\n-      pw.print(\"]\");\n+      pw.print(\"]\");      \n     }\n-\n+    \n     lastMeta.set(lastMetadata);\n     lastCount.set(currentCount);\n   }\n-\n+  \n   /**\n    * Output a tab separated version of fetched data. Deduplication is done on the fly so we don't decode twice.\n-   *\n+   * \n    */\n   private static void tsvDump(PrintWriter pw, GTSDecoderIterator iter, long now, long count, boolean raw, boolean dedup, boolean signed, AtomicReference<Metadata> lastMeta, AtomicLong lastCount, boolean sortMeta, boolean expose) throws IOException {\n-\n+    \n     String name = null;\n     Map<String,String> labels = null;\n-\n+    \n     StringBuilder classSB = new StringBuilder();\n     StringBuilder labelsSB = new StringBuilder();\n     StringBuilder attributesSB = new StringBuilder();\n", "next_change": {"commit": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8f5a7546..c726bf26 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1597,34 +1664,34 @@ public class EgressFetchHandler extends AbstractHandler {\n         // If displayName is still true it means we should have displayed the name but no value matched,\n         // so set name to null so we correctly display the name for the next decoder if it has values\n         //\n-        \n+\n         if (displayName) {\n           name = null;\n         }\n       }\n-            \n+\n     } catch (Throwable t) {\n       throw t;\n     } finally {\n       if (hasValues) {\n         pw.print(\"]}\");\n       }\n-      pw.print(\"]\");      \n+      pw.print(\"]\");\n     }\n-    \n+\n     lastMeta.set(lastMetadata);\n     lastCount.set(currentCount);\n   }\n-  \n+\n   /**\n    * Output a tab separated version of fetched data. Deduplication is done on the fly so we don't decode twice.\n-   * \n+   *\n    */\n   private static void tsvDump(PrintWriter pw, GTSDecoderIterator iter, long now, long count, boolean raw, boolean dedup, boolean signed, AtomicReference<Metadata> lastMeta, AtomicLong lastCount, boolean sortMeta, boolean expose) throws IOException {\n-    \n+\n     String name = null;\n     Map<String,String> labels = null;\n-    \n+\n     StringBuilder classSB = new StringBuilder();\n     StringBuilder labelsSB = new StringBuilder();\n     StringBuilder attributesSB = new StringBuilder();\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "0cc5249f912650f67b1605f475e90937754ed0c9", "committedDate": "2020-03-02 13:42:32 +0100", "message": "Added support for nocache/nopersist configuration in /api/v0/fetch"}, {"oid": "50c35198c720f21a47f14286ba7799822e244f9a", "committedDate": "2020-03-03 17:03:51 +0100", "message": "Fixes #680 - Only check if count is specified when timespan is negative."}, {"oid": "c494c8bf67504de418d5571c37caf21fb892250e", "committedDate": "2020-03-24 16:56:46 +0100", "message": "Merge pull request #666 from hbs/inmem-accelerator"}, {"oid": "62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "committedDate": "2020-04-09 22:22:15 +0200", "message": "Fixes #716 - Modified exit checks. Converted boundary length to long."}, {"oid": "5952e81ef72f0596e474e20819d453ec2546ad8d", "committedDate": "2020-04-22 15:59:02 +0200", "message": "Simplify constant conditions and constant variables"}, {"oid": "83020139d04c19ab0291fb87d2d520c341426a2b", "committedDate": "2020-05-01 15:37:35 +0200", "message": "Added support for configuring default accelerator strategies"}, {"oid": "4dac47241a0bdb230d8bd58bf7b17bfe571308b5", "committedDate": "2020-05-05 13:11:23 +0200", "message": "Merge branch 'master' into accelerator.default"}, {"oid": "679a16a39c683e77dde83246cad5aeb0a0ae46a2", "committedDate": "2020-05-05 13:21:42 +0200", "message": "Addressed PR comments"}, {"oid": "d4c86f2381b31511a8923160ab63640e3afc1c3b", "committedDate": "2020-05-05 21:01:23 +0200", "message": "Remove archive endpoint"}, {"oid": "72096842f568b1d3aecfeb24a5f4ce4952aea4b6", "committedDate": "2020-05-06 17:19:15 +0200", "message": "Merge pull request #751 from hbs/accelerator.default"}, {"oid": "96b8866ee9d3c86265a6b85dec2ff08962a73d97", "committedDate": "2020-05-27 11:33:52 +0200", "message": "Refactored Accelerator Config for WarpScript lib compatibility"}, {"oid": "590b26d2cbe9c6cbd9e134169a3eb34c7e59f79c", "committedDate": "2020-06-05 23:25:29 +0200", "message": "Initial commit of step and timestep support for data retrieval"}, {"oid": "dfd6e2f4e27c476f431638e3fe5b52d541af13f7", "committedDate": "2020-06-06 09:28:59 +0200", "message": "Refactored to introduce FetchRequest to simplify signatures"}, {"oid": "e07598603051ad7fa838f08bfec01a2aa247f958", "committedDate": "2020-06-09 23:01:26 +0200", "message": "Added support for advanced fetch parameters in Warp10InputFormat"}, {"oid": "879ad4092491eda3b08f942710d5bdc6b1e90c69", "committedDate": "2020-06-19 19:06:51 +0200", "message": "Addressed PR comments"}, {"oid": "a0ce525c9e1ce3800077185cdcb8e40b012ea9ba", "committedDate": "2020-07-16 15:47:06 +0200", "message": "Added fix for split fetching in which case rtoken is null"}, {"oid": "0ccbdeb7d82c7c49179bf1dfb45a9f2bc7b4e22a", "committedDate": "2020-09-18 12:30:12 +0200", "message": "Reuse Random instance for onetimepad generation"}, {"oid": "be074ce3244a4dd07116f984d387c2f102ae7baf", "committedDate": "2020-09-18 12:34:32 +0200", "message": "Use ThreadLocalRandom to avoid contention"}, {"oid": "551d6c7b184d9874baa236fb282d165fb4c8fc19", "committedDate": "2020-10-09 11:22:20 +0200", "message": "Added support for fetching HBase cell TTLs."}, {"oid": "aa34e708809bd88e4d61ed05e78594349ad8bc53", "committedDate": "2020-11-09 17:14:53 +0100", "message": "400 error codes and clearer status messages for bad parameters"}, {"oid": "7b68e8cd0a3fbbede7181a68ac308ca213e762bc", "committedDate": "2020-11-10 17:18:57 +0100", "message": "More detailled error messages for /update"}, {"oid": "2c4cb6dd7d03ffc3cff1bcc54acc7d5ea63a1721", "committedDate": "2020-12-08 11:59:58 +0100", "message": "Remove dead code"}, {"oid": "5391746198caf205379f27ed8869286209c6bc54", "committedDate": "2021-04-21 11:26:20 +0200", "message": "Add .noauth, .nometa and .nofetch attributes for read tokens"}, {"oid": "fcf98bc9b20399739c3007cceb18e129dc683b3e", "committedDate": "2021-04-27 12:32:10 +0200", "message": "Change .nometa to .nofind for read tokens"}, {"oid": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "committedDate": "2021-07-09 10:53:57 +0200", "message": "Added support for token attributes in EgressFetchHandler"}, {"oid": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "committedDate": "2021-07-12 15:23:43 +0200", "message": "Remove unused variables and fields"}, {"oid": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "committedDate": "2021-07-13 11:12:49 +0200", "message": "Addressed PR comments"}, {"oid": "f21f8f77ac3618283721a8321564afa8a332dad0", "committedDate": "2021-07-16 14:11:10 +0200", "message": "Resolved merge conflict"}, {"oid": "757d17217c94c854df32481d400ca77850496e82", "committedDate": "2021-10-14 00:40:43 +0200", "message": "Added gskip/gcount parameters"}, {"oid": "a736b000b485c80f73ff1212f27ec3c7f4873ae9", "committedDate": "2021-10-19 16:22:11 +0200", "message": "Addressed PR comments. Added params gskip/gcount to FETCH and FIND"}, {"oid": "3eb7452f98d09229b0fbe0e73f83827fb2560c5e", "committedDate": "2021-10-20 15:27:36 +0200", "message": "Fixed conditional bug. Changed HashSet instances into LinkedHashSet to retain order"}, {"oid": "cf48879d1384d14870b40e2a67ce12043c685acf", "committedDate": "2022-01-25 23:16:11 +0100", "message": "Modified the cases when the GTS cache file is used"}, {"oid": "f879aefc9399136e4fd07b5a58f1b2b8cecf879b", "committedDate": "2022-05-09 17:39:32 +0200", "message": "Added buffered version of encodeTo{Stream,Writer}. Changed EgressFetchHandler to use it with 100000 bytes buffer."}, {"oid": "f394f837d748835f9afdf8d6b1b6df9b4faec875", "committedDate": "2022-05-20 17:06:22 +0200", "message": "Modified to use stable buffer"}, {"oid": "11df13673124d676b001c194be72b18a655b3ca0", "committedDate": "2022-06-23 09:56:13 +0200", "message": "Added header indicating the time unit used by the platform"}, {"oid": "9cd68aa9bce8b19e1c990f5ddd2b1fc473b60dd2", "committedDate": "2022-08-29 13:58:00 +0200", "message": "Added propagation of ReadToken in GTSSplit"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2OTAxNA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377069014", "body": "Add a comment indicating whether start/end are inclusive or exclusive", "bodyText": "Add a comment indicating whether start/end are inclusive or exclusive", "bodyHTML": "<p dir=\"auto\">Add a comment indicating whether start/end are inclusive or exclusive</p>", "author": "hbs", "createdAt": "2020-02-10T13:43:18Z", "path": "warp10/src/main/java/io/warp10/json/BoundedWriter.java", "diffHunk": "@@ -0,0 +1,64 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import java.io.IOException;\n+import java.io.Writer;\n+\n+/**\n+ * A wrapper for Writers to limit the number of written chars.\n+ * When the number of chars that should be written exceeds the given limit, a WriterBoundReachedException is thrown.\n+ */\n+public class BoundedWriter extends Writer {\n+\n+  public static class WriterBoundReachedException extends IOException {\n+\n+    public WriterBoundReachedException(String message) {\n+      super(message);\n+    }\n+\n+  }\n+\n+  protected final Writer writer;\n+  protected final long maxWrittenChars;\n+  protected long currentWrittenChars;\n+\n+  public BoundedWriter(Writer writer, long maxAppendedChars) {\n+    this.writer = writer;\n+    this.maxWrittenChars = maxAppendedChars;\n+    this.currentWrittenChars = 0;\n+  }\n+\n+  @Override\n+  public void write(char[] chars, int start, int end) throws IOException {", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/BoundedWriter.java b/warp10/src/main/java/io/warp10/json/BoundedWriter.java\nindex 6fdb2138..f7e6ce8a 100644\n--- a/warp10/src/main/java/io/warp10/json/BoundedWriter.java\n+++ b/warp10/src/main/java/io/warp10/json/BoundedWriter.java\n", "chunk": "@@ -43,13 +43,21 @@ public class BoundedWriter extends Writer {\n     this.currentWrittenChars = 0;\n   }\n \n+  /**\n+   * Writes a portion of an array of characters.\n+   * @param cbuf Array of characters\n+   * @param off Offset from which to start writing characters\n+   * @param len Number of characters to write\n+   * @throws WriterBoundReachedException if this write would exceed the maximum number of written characters to this writer.\n+   * @throws IOException if this the underlying writer throws an IOException.\n+   */\n   @Override\n-  public void write(char[] chars, int start, int end) throws IOException {\n-    if (end - start + currentWrittenChars - maxWrittenChars > 0) {\n+  public void write(char[] cbuf, int off, int len) throws IOException {\n+    if (len + currentWrittenChars - maxWrittenChars > 0) {\n       throw new WriterBoundReachedException(\"Cannot write, maximum number of characters written :\" + this.maxWrittenChars);\n     }\n-    this.currentWrittenChars += end - start;\n-    writer.write(chars, start, end);\n+    this.currentWrittenChars += len;\n+    writer.write(cbuf, off, len);\n   }\n \n   @Override\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/BoundedWriter.java b/warp10/src/main/java/io/warp10/json/BoundedWriter.java\nindex 6fdb2138..f7e6ce8a 100644\n--- a/warp10/src/main/java/io/warp10/json/BoundedWriter.java\n+++ b/warp10/src/main/java/io/warp10/json/BoundedWriter.java\n", "chunk": "@@ -43,13 +43,21 @@ public class BoundedWriter extends Writer {\n     this.currentWrittenChars = 0;\n   }\n \n+  /**\n+   * Writes a portion of an array of characters.\n+   * @param cbuf Array of characters\n+   * @param off Offset from which to start writing characters\n+   * @param len Number of characters to write\n+   * @throws WriterBoundReachedException if this write would exceed the maximum number of written characters to this writer.\n+   * @throws IOException if this the underlying writer throws an IOException.\n+   */\n   @Override\n-  public void write(char[] chars, int start, int end) throws IOException {\n-    if (end - start + currentWrittenChars - maxWrittenChars > 0) {\n+  public void write(char[] cbuf, int off, int len) throws IOException {\n+    if (len + currentWrittenChars - maxWrittenChars > 0) {\n       throw new WriterBoundReachedException(\"Cannot write, maximum number of characters written :\" + this.maxWrittenChars);\n     }\n-    this.currentWrittenChars += end - start;\n-    writer.write(chars, start, end);\n+    this.currentWrittenChars += len;\n+    writer.write(cbuf, off, len);\n   }\n \n   @Override\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MDMxMg==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377070312", "body": "How are .producer/.owner labels handled? The check for their exposure should probably be performed here too as this method might be called in the future from other places and responsability for exposing those labels might not be logical to implement in the caller.", "bodyText": "How are .producer/.owner labels handled? The check for their exposure should probably be performed here too as this method might be called in the future from other places and responsability for exposing those labels might not be logical to implement in the caller.", "bodyHTML": "<p dir=\"auto\">How are .producer/.owner labels handled? The check for their exposure should probably be performed here too as this method might be called in the future from other places and responsability for exposing those labels might not be logical to implement in the caller.</p>", "author": "hbs", "createdAt": "2020-02-10T13:45:39Z", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyMTI2MQ==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377521261", "bodyText": "Problem is that we don't  have access to the token here, so we can't know if internal labels should be exposed or not.", "author": "ftence", "createdAt": "2020-02-11T09:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MDMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyODQzNg==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377528436", "bodyText": "Actually it should be fine since the labels will have been removed just after the FETCH if they needed to be.", "author": "hbs", "createdAt": "2020-02-11T09:46:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MDMxMg=="}], "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 8abdca6a..22967896 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -27,21 +28,18 @@ import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n+\n+  protected GTSEncoderSerializer() {\n+    super(GTSEncoder.class);\n+  }\n \n   @Override\n   public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n     Metadata metadata = encoder.getMetadata();\n-    String name = metadata.getName();\n-    if (null == name) {\n-      name = \"\";\n-    }\n \n     gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n     gen.writeFieldName(\"v\");\n     gen.writeStartArray();\n \n", "next_change": {"commit": "d19b437e1adfcd813f5f6be5453372c73dfc4e00", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 22967896..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -40,7 +40,7 @@ public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n \n     gen.writeStartObject();\n     MetadataSerializer.serializeMetadataFields(metadata, gen);\n-    gen.writeFieldName(\"v\");\n+    gen.writeFieldName(GeoTimeSerieSerializer.FIELD_VALUES);\n     gen.writeStartArray();\n \n     GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 8abdca6a..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -27,22 +28,19 @@ import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n+\n+  protected GTSEncoderSerializer() {\n+    super(GTSEncoder.class);\n+  }\n \n   @Override\n   public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n     Metadata metadata = encoder.getMetadata();\n-    String name = metadata.getName();\n-    if (null == name) {\n-      name = \"\";\n-    }\n \n     gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeFieldName(\"v\");\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n+    gen.writeFieldName(GeoTimeSerieSerializer.FIELD_VALUES);\n     gen.writeStartArray();\n \n     GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377071392", "body": "This introduces a different handling of byte arrays whether it appears in a GTS/GTSEncoder or outside of one. Everywhere else byte arrays are serialized as b64, but here they will be serialized as an ISO-8859-1 string?", "bodyText": "This introduces a different handling of byte arrays whether it appears in a GTS/GTSEncoder or outside of one. Everywhere else byte arrays are serialized as b64, but here they will be serialized as an ISO-8859-1 string?", "bodyHTML": "<p dir=\"auto\">This introduces a different handling of byte arrays whether it appears in a GTS/GTSEncoder or outside of one. Everywhere else byte arrays are serialized as b64, but here they will be serialized as an ISO-8859-1 string?</p>", "author": "hbs", "createdAt": "2020-02-10T13:47:30Z", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());\n+    gen.writeObjectField(\"a\", metadata.getAttributes());\n+    gen.writeNumberField(\"la\", metadata.getLastActivity());\n+    gen.writeFieldName(\"v\");\n+    gen.writeStartArray();\n+\n+    GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n+    while (decoder.next()) {\n+      long ts = decoder.getTimestamp();\n+      long location = decoder.getLocation();\n+      long elevation = decoder.getElevation();\n+      // We do not call getBinaryValue because JSON cannot represent byte arrays", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4OTU2OA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377189568", "bodyText": "You're right.\nIf you're fine with the b64 serialization of byte[] we could call getBinaryValue here and b64 encode if the returned value it byte[].\nHowever, in the case of a GTS, we're stuck with an ISO-8859-1 string, correct me if I'm wrong.", "author": "ftence", "createdAt": "2020-02-10T16:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzUyODk5OQ==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377528999", "bodyText": "I am not too fond of emitting b64 content for byte arrays, why not simply output an ISO-8859-1 string?", "author": "hbs", "createdAt": "2020-02-11T09:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYwMjMxNg==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377602316", "bodyText": "This would unify the GTS, Encoder and byte[] representation for binary data which is nice.\nThere is a slight downside as it will produce a lot of special characters which will be escaped in JSON, making that not very compact. I think it's fine because JSON shouldn't be used for large transfer of binary data.", "author": "ftence", "createdAt": "2020-02-11T12:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MTM5Mg=="}], "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 8abdca6a..22967896 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -50,7 +48,7 @@ public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n       long ts = decoder.getTimestamp();\n       long location = decoder.getLocation();\n       long elevation = decoder.getElevation();\n-      // We do not call getBinaryValue because JSON cannot represent byte arrays\n+      // We do not call getBinaryValue because JSON will also encode byte[] as IS0-8859-1\n       Object v = decoder.getValue();\n \n       gen.writeStartArray();\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 8abdca6a..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -27,22 +28,19 @@ import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n+\n+  protected GTSEncoderSerializer() {\n+    super(GTSEncoder.class);\n+  }\n \n   @Override\n   public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n     Metadata metadata = encoder.getMetadata();\n-    String name = metadata.getName();\n-    if (null == name) {\n-      name = \"\";\n-    }\n \n     gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeFieldName(\"v\");\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n+    gen.writeFieldName(GeoTimeSerieSerializer.FIELD_VALUES);\n     gen.writeStartArray();\n \n     GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n", "next_change": null}, {"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 8abdca6a..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -50,7 +48,7 @@ public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n       long ts = decoder.getTimestamp();\n       long location = decoder.getLocation();\n       long elevation = decoder.getElevation();\n-      // We do not call getBinaryValue because JSON cannot represent byte arrays\n+      // We do not call getBinaryValue because JSON will also encode byte[] as IS0-8859-1\n       Object v = decoder.getValue();\n \n       gen.writeStartArray();\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MjQxMA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377072410", "body": "Those strings should be externalized as constants since they are used in at least the two serializers", "bodyText": "Those strings should be externalized as constants since they are used in at least the two serializers", "bodyHTML": "<p dir=\"auto\">Those strings should be externalized as constants since they are used in at least the two serializers</p>", "author": "hbs", "createdAt": "2020-02-10T13:49:16Z", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,86 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 8abdca6a..22967896 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -27,21 +28,18 @@ import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n+\n+  protected GTSEncoderSerializer() {\n+    super(GTSEncoder.class);\n+  }\n \n   @Override\n   public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n     Metadata metadata = encoder.getMetadata();\n-    String name = metadata.getName();\n-    if (null == name) {\n-      name = \"\";\n-    }\n \n     gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n     gen.writeFieldName(\"v\");\n     gen.writeStartArray();\n \n", "next_change": {"commit": "d19b437e1adfcd813f5f6be5453372c73dfc4e00", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 22967896..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -40,7 +40,7 @@ public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n \n     gen.writeStartObject();\n     MetadataSerializer.serializeMetadataFields(metadata, gen);\n-    gen.writeFieldName(\"v\");\n+    gen.writeFieldName(GeoTimeSerieSerializer.FIELD_VALUES);\n     gen.writeStartArray();\n \n     GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 8abdca6a..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -27,22 +28,19 @@ import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class GTSEncoderSerializer extends JsonSerializer<GTSEncoder> {\n+public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n+\n+  protected GTSEncoderSerializer() {\n+    super(GTSEncoder.class);\n+  }\n \n   @Override\n   public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n     Metadata metadata = encoder.getMetadata();\n-    String name = metadata.getName();\n-    if (null == name) {\n-      name = \"\";\n-    }\n \n     gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeFieldName(\"v\");\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n+    gen.writeFieldName(GeoTimeSerieSerializer.FIELD_VALUES);\n     gen.writeStartArray();\n \n     GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3MzI2OQ==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377073269", "body": "Same question about exposing .producer/.owner", "bodyText": "Same question about exposing .producer/.owner", "bodyHTML": "<p dir=\"auto\">Same question about exposing .producer/.owner</p>", "author": "hbs", "createdAt": "2020-02-10T13:50:53Z", "path": "warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java", "diffHunk": "@@ -0,0 +1,88 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSHelper;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GeoTimeSerieSerializer extends JsonSerializer<GeoTimeSerie> {\n+\n+  @Override\n+  public void serialize(GeoTimeSerie gts, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = gts.getMetadata();\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);\n+    gen.writeObjectField(\"l\", metadata.getLabels());", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java b/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\nindex 679f75ae..4b0601f5 100644\n--- a/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\n", "chunk": "@@ -26,22 +26,21 @@ import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class GeoTimeSerieSerializer extends JsonSerializer<GeoTimeSerie> {\n+public class GeoTimeSerieSerializer extends StdSerializer<GeoTimeSerie> {\n+\n+  public static final String FIELD_VALUES = \"v\";\n+\n+  protected GeoTimeSerieSerializer() {\n+    super(GeoTimeSerie.class);\n+  }\n \n   @Override\n   public void serialize(GeoTimeSerie gts, JsonGenerator gen, SerializerProvider provider) throws IOException {\n     Metadata metadata = gts.getMetadata();\n-    String name = metadata.getName();\n-    if (null == name) {\n-      name = \"\";\n-    }\n \n     gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeFieldName(\"v\");\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n+    gen.writeFieldName(FIELD_VALUES);\n     gen.writeStartArray();\n \n     for (int i = 0; i < gts.size(); i++) {\n", "next_change": {"commit": "d19b437e1adfcd813f5f6be5453372c73dfc4e00", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java b/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\nindex 4b0601f5..9a6bb146 100644\n--- a/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\n", "chunk": "@@ -41,7 +41,7 @@ public class GeoTimeSerieSerializer extends StdSerializer<GeoTimeSerie> {\n     gen.writeStartObject();\n     MetadataSerializer.serializeMetadataFields(metadata, gen);\n     gen.writeFieldName(FIELD_VALUES);\n-    gen.writeStartArray();\n+    gen.writeStartArray(gts.size());\n \n     for (int i = 0; i < gts.size(); i++) {\n       long ts = GTSHelper.tickAtIndex(gts, i);\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java b/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\nindex 679f75ae..9a6bb146 100644\n--- a/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GeoTimeSerieSerializer.java\n", "chunk": "@@ -26,23 +26,22 @@ import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class GeoTimeSerieSerializer extends JsonSerializer<GeoTimeSerie> {\n+public class GeoTimeSerieSerializer extends StdSerializer<GeoTimeSerie> {\n+\n+  public static final String FIELD_VALUES = \"v\";\n+\n+  protected GeoTimeSerieSerializer() {\n+    super(GeoTimeSerie.class);\n+  }\n \n   @Override\n   public void serialize(GeoTimeSerie gts, JsonGenerator gen, SerializerProvider provider) throws IOException {\n     Metadata metadata = gts.getMetadata();\n-    String name = metadata.getName();\n-    if (null == name) {\n-      name = \"\";\n-    }\n \n     gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeFieldName(\"v\");\n-    gen.writeStartArray();\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n+    gen.writeFieldName(FIELD_VALUES);\n+    gen.writeStartArray(gts.size());\n \n     for (int i = 0; i < gts.size(); i++) {\n       long ts = GTSHelper.tickAtIndex(gts, i);\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3NTM5NQ==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377075395", "body": "Constants should be externalized.", "bodyText": "Constants should be externalized.", "bodyHTML": "<p dir=\"auto\">Constants should be externalized.</p>", "author": "hbs", "createdAt": "2020-02-10T13:54:49Z", "path": "warp10/src/main/java/io/warp10/json/MetadataSerializer.java", "diffHunk": "@@ -0,0 +1,42 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class MetadataSerializer extends JsonSerializer<Metadata> {\n+\n+  @Override\n+  public void serialize(Metadata metadata, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    String name = metadata.getName();\n+    if (null == name) {\n+      name = \"\";\n+    }\n+\n+    gen.writeStartObject();\n+    gen.writeStringField(\"c\", name);", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\nindex 011c061f..2d03bed7 100644\n--- a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n", "chunk": "@@ -19,24 +19,38 @@ package io.warp10.json;\n import com.fasterxml.jackson.core.JsonGenerator;\n import com.fasterxml.jackson.databind.JsonSerializer;\n import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class MetadataSerializer extends JsonSerializer<Metadata> {\n+public class MetadataSerializer extends StdSerializer<Metadata> {\n+\n+  public static final String FIELD_NAME = \"c\";\n+  public static final String FIELD_LABELS = \"l\";\n+  public static final String FIELD_ATTRIBUTES = \"a\";\n+  public static final String FIELD_LASTACTIVITY = \"la\";\n+\n+  protected MetadataSerializer() {\n+    super(Metadata.class);\n+  }\n \n   @Override\n   public void serialize(Metadata metadata, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    gen.writeStartObject();\n+    serializeMetadataFields(metadata, gen);\n+    gen.writeEndObject();\n+  }\n+\n+  public static void serializeMetadataFields(Metadata metadata, JsonGenerator gen) throws IOException {\n     String name = metadata.getName();\n     if (null == name) {\n       name = \"\";\n     }\n \n-    gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeEndObject();\n+    gen.writeStringField(FIELD_NAME, name);\n+    gen.writeObjectField(FIELD_LABELS, metadata.getLabels());\n+    gen.writeObjectField(FIELD_ATTRIBUTES, metadata.getAttributes());\n+    gen.writeNumberField(FIELD_LASTACTIVITY, metadata.getLastActivity());\n   }\n }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\nindex 011c061f..2d03bed7 100644\n--- a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n", "chunk": "@@ -19,24 +19,38 @@ package io.warp10.json;\n import com.fasterxml.jackson.core.JsonGenerator;\n import com.fasterxml.jackson.databind.JsonSerializer;\n import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class MetadataSerializer extends JsonSerializer<Metadata> {\n+public class MetadataSerializer extends StdSerializer<Metadata> {\n+\n+  public static final String FIELD_NAME = \"c\";\n+  public static final String FIELD_LABELS = \"l\";\n+  public static final String FIELD_ATTRIBUTES = \"a\";\n+  public static final String FIELD_LASTACTIVITY = \"la\";\n+\n+  protected MetadataSerializer() {\n+    super(Metadata.class);\n+  }\n \n   @Override\n   public void serialize(Metadata metadata, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    gen.writeStartObject();\n+    serializeMetadataFields(metadata, gen);\n+    gen.writeEndObject();\n+  }\n+\n+  public static void serializeMetadataFields(Metadata metadata, JsonGenerator gen) throws IOException {\n     String name = metadata.getName();\n     if (null == name) {\n       name = \"\";\n     }\n \n-    gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeEndObject();\n+    gen.writeStringField(FIELD_NAME, name);\n+    gen.writeObjectField(FIELD_LABELS, metadata.getLabels());\n+    gen.writeObjectField(FIELD_ATTRIBUTES, metadata.getAttributes());\n+    gen.writeNumberField(FIELD_LASTACTIVITY, metadata.getLastActivity());\n   }\n }\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3NzczNw==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377077737", "body": "Missing whitespace", "bodyText": "Missing whitespace", "bodyHTML": "<p dir=\"auto\">Missing whitespace</p>", "author": "hbs", "createdAt": "2020-02-10T13:58:47Z", "path": "warp10/src/main/java/io/warp10/script/functions/JSONTO.java", "diffHunk": "@@ -51,19 +46,13 @@ public Object apply(WarpScriptStack stack) throws WarpScriptException {\n       throw new WarpScriptException(getName() + \" expects a string on top of the stack.\");\n     }\n     \n-    JsonParser parser = BOON_PARSER_FACTORY.create();\n-    \n-    Object json = null;\n-    \n     try {\n-      json = parser.parse(o.toString());\n-    } catch(JsonException je) {      \n-      // We don't include the original message as it can be very long\n-      throw new WarpScriptException(\"Error parsing JSON\", je);\n+      Object json = JsonUtils.jsonToObject(o.toString());\n+      stack.push(transform(json));\n+    } catch (IOException ioe) {\n+      throw new WarpScriptException(getName() + \"failed to parse JSON\", ioe);", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/script/functions/JSONTO.java b/warp10/src/main/java/io/warp10/script/functions/JSONTO.java\nindex d9a1cc44..dc173943 100644\n--- a/warp10/src/main/java/io/warp10/script/functions/JSONTO.java\n+++ b/warp10/src/main/java/io/warp10/script/functions/JSONTO.java\n", "chunk": "@@ -50,7 +50,7 @@ public class JSONTO extends NamedWarpScriptFunction implements WarpScriptStackFu\n       Object json = JsonUtils.jsonToObject(o.toString());\n       stack.push(transform(json));\n     } catch (IOException ioe) {\n-      throw new WarpScriptException(getName() + \"failed to parse JSON\", ioe);\n+      throw new WarpScriptException(getName() + \" failed to parse JSON\", ioe);\n     }\n \n     return stack;\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/script/functions/JSONTO.java b/warp10/src/main/java/io/warp10/script/functions/JSONTO.java\nindex d9a1cc44..dc173943 100644\n--- a/warp10/src/main/java/io/warp10/script/functions/JSONTO.java\n+++ b/warp10/src/main/java/io/warp10/script/functions/JSONTO.java\n", "chunk": "@@ -50,7 +50,7 @@ public class JSONTO extends NamedWarpScriptFunction implements WarpScriptStackFu\n       Object json = JsonUtils.jsonToObject(o.toString());\n       stack.push(transform(json));\n     } catch (IOException ioe) {\n-      throw new WarpScriptException(getName() + \"failed to parse JSON\", ioe);\n+      throw new WarpScriptException(getName() + \" failed to parse JSON\", ioe);\n     }\n \n     return stack;\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3OTY5MA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377079690", "body": "This call will fail with an NPE if the stack attribute retrieved above is not set. It is set in the case of MemoryWarpScriptStack instances but potentially not in other implementations of WarpScriptStack.\r\n\r\nSame in MAXJSON", "bodyText": "This call will fail with an NPE if the stack attribute retrieved above is not set. It is set in the case of MemoryWarpScriptStack instances but potentially not in other implementations of WarpScriptStack.\nSame in MAXJSON", "bodyHTML": "<p dir=\"auto\">This call will fail with an NPE if the stack attribute retrieved above is not set. It is set in the case of MemoryWarpScriptStack instances but potentially not in other implementations of WarpScriptStack.</p>\n<p dir=\"auto\">Same in MAXJSON</p>", "author": "hbs", "createdAt": "2020-02-10T14:02:21Z", "path": "warp10/src/main/java/io/warp10/script/functions/TOJSON.java", "diffHunk": "@@ -43,120 +37,22 @@ public TOJSON(String name) {\n   public Object apply(WarpScriptStack stack) throws WarpScriptException {\n     Object o = stack.pop();\n \n-    JsonSerializer parser = BOON_SERIALIZER_FACTORY.create();\n-\n     //\n     // Only allow the serialization of simple lists and maps, otherwise JSON might\n     // expose internals\n     //\n \n-    if (!validate(o)) {\n-      throw new WarpScriptException(getName() + \" can only serialize structures containing numbers, strings, booleans, lists and maps which do not reference the same list/map multiple times.\");\n+    try {\n+      Long maxJsonSize = (Long)stack.getAttribute(WarpScriptStack.ATTRIBUTE_JSON_MAXSIZE);\n+      String json = JsonUtils.objectToJson(o, false, maxJsonSize);", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE4NjU1OQ==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377186559", "bodyText": "I think this is the case for all other limits.\nIt this is not set, what should be the value? The default one or the max one?", "author": "ftence", "createdAt": "2020-02-10T16:51:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3OTY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYxOTE3OA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377619178", "bodyText": "Better fix that in another PR as all other limit attributes suffer from the same problem.", "author": "ftence", "createdAt": "2020-02-11T13:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA3OTY5MA=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": {"commit": "c0ebb0e20bf459cb985b81f2ff2afef0d2917fb4", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/script/functions/TOJSON.java b/warp10/src/main/java/io/warp10/script/functions/TOJSON.java\nindex 763774b6..bc4d2e31 100644\n--- a/warp10/src/main/java/io/warp10/script/functions/TOJSON.java\n+++ b/warp10/src/main/java/io/warp10/script/functions/TOJSON.java\n", "chunk": "@@ -44,7 +44,10 @@ public class TOJSON extends NamedWarpScriptFunction implements WarpScriptStackFu\n \n     try {\n       Long maxJsonSize = (Long)stack.getAttribute(WarpScriptStack.ATTRIBUTE_JSON_MAXSIZE);\n-      String json = JsonUtils.objectToJson(o, false, maxJsonSize);\n+      boolean strictJSON = Boolean.TRUE.equals(stack.getAttribute(WarpScriptStack.ATTRIBUTE_JSON_STRICT));\n+      boolean prettyJSON = Boolean.TRUE.equals(stack.getAttribute(WarpScriptStack.ATTRIBUTE_JSON_PRETTY));\n+\n+      String json = JsonUtils.objectToJson(o, strictJSON, prettyJSON, maxJsonSize);\n       stack.push(json);\n     } catch (IOException ioe) {\n       throw new WarpScriptException(getName() + \" failed with to convert to JSON.\", ioe);\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "c0ebb0e20bf459cb985b81f2ff2afef0d2917fb4", "committedDate": "2021-04-27 15:11:01 +0200", "message": "Add JSONPRETTY/JSONCOMPACT to prettify or not JSON output"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA4OTQ3Mg==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377089472", "body": "Won't that surround sb's content with double quotes and escape it? This might not be what is expected.", "bodyText": "Won't that surround sb's content with double quotes and escape it? This might not be what is expected.", "bodyHTML": "<p dir=\"auto\">Won't that surround sb's content with double quotes and escape it? This might not be what is expected.</p>", "author": "hbs", "createdAt": "2020-02-10T14:19:39Z", "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -0,0 +1,211 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonFactoryBuilder;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.StreamWriteFeature;\n+import com.fasterxml.jackson.core.json.JsonReadFeature;\n+import com.fasterxml.jackson.core.json.JsonWriteFeature;\n+import com.fasterxml.jackson.databind.BeanDescription;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationConfig;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.module.SimpleModule;\n+import com.fasterxml.jackson.databind.ser.BeanSerializer;\n+import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;\n+import com.fasterxml.jackson.databind.ser.impl.UnknownSerializer;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class JsonUtils {\n+\n+  /**\n+   * A serializer for null keys.\n+   * Outputs \"null\" because most javascript engines coerce null to \"null\" when using it as a key.\n+   */\n+  private static class NullKeySerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      gen.writeFieldName(\"null\");\n+    }\n+  }\n+\n+  /**\n+   * Used to swap UnknownSerializer and BeanSerializer for CustomEncodersSerializer.\n+   */\n+  public static class NotSerializedToCustomSerializedModifier extends BeanSerializerModifier {\n+    @Override\n+    public JsonSerializer<?> modifySerializer(SerializationConfig config, BeanDescription beanDesc, JsonSerializer<?> serializer) {\n+      if (serializer instanceof UnknownSerializer || serializer instanceof BeanSerializer) {\n+        return customEncodersSerializer;\n+      } else {\n+        return serializer;\n+      }\n+    }\n+  }\n+\n+  public static class CustomEncodersSerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      if (null != encoders && !encoders.isEmpty()) {\n+        StringBuilder sb = new StringBuilder();\n+        boolean encoded = false;\n+        for (JsonEncoder encoder: encoders) {\n+          encoded = encoder.addElement(sb, value);\n+          if (encoded) {\n+            break;\n+          }\n+        }\n+        if (encoded) {\n+          gen.writeString(sb.toString());", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/JsonUtils.java b/warp10/src/main/java/io/warp10/json/JsonUtils.java\nindex 1936d6ac..03ca781d 100644\n--- a/warp10/src/main/java/io/warp10/json/JsonUtils.java\n+++ b/warp10/src/main/java/io/warp10/json/JsonUtils.java\n", "chunk": "@@ -83,7 +83,7 @@ public class JsonUtils {\n           }\n         }\n         if (encoded) {\n-          gen.writeString(sb.toString());\n+          gen.writeRaw(sb.toString());\n         } else {\n           // No custom encoders able to encode this object, write null.\n           gen.writeNull();\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/JsonUtils.java b/warp10/src/main/java/io/warp10/json/JsonUtils.java\nindex 1936d6ac..3bebd63c 100644\n--- a/warp10/src/main/java/io/warp10/json/JsonUtils.java\n+++ b/warp10/src/main/java/io/warp10/json/JsonUtils.java\n", "chunk": "@@ -83,7 +83,7 @@ public class JsonUtils {\n           }\n         }\n         if (encoded) {\n-          gen.writeString(sb.toString());\n+          gen.writeRaw(sb.toString());\n         } else {\n           // No custom encoders able to encode this object, write null.\n           gen.writeNull();\n", "next_change": {"commit": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/JsonUtils.java b/warp10/src/main/java/io/warp10/json/JsonUtils.java\nindex 3bebd63c..ad88aec4 100644\n--- a/warp10/src/main/java/io/warp10/json/JsonUtils.java\n+++ b/warp10/src/main/java/io/warp10/json/JsonUtils.java\n", "chunk": "@@ -57,33 +52,35 @@ public class JsonUtils {\n   }\n \n   /**\n-   * Used to swap UnknownSerializer and BeanSerializer for CustomEncodersSerializer.\n+   * Used to swap UnknownSerializer and BeanSerializer for CustomSerializer.\n    */\n   public static class NotSerializedToCustomSerializedModifier extends BeanSerializerModifier {\n     @Override\n     public JsonSerializer<?> modifySerializer(SerializationConfig config, BeanDescription beanDesc, JsonSerializer<?> serializer) {\n       if (serializer instanceof UnknownSerializer || serializer instanceof BeanSerializer) {\n-        return customEncodersSerializer;\n+        return CUSTOM_SERIALIZER;\n       } else {\n         return serializer;\n       }\n     }\n   }\n \n-  public static class CustomEncodersSerializer extends JsonSerializer<Object> {\n+  /**\n+   * Handles custom serialization based on transformers.\n+   */\n+  public static class CustomSerializer extends JsonSerializer<Object> {\n     @Override\n     public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n-      if (null != encoders && !encoders.isEmpty()) {\n-        StringBuilder sb = new StringBuilder();\n-        boolean encoded = false;\n-        for (JsonEncoder encoder: encoders) {\n-          encoded = encoder.addElement(sb, value);\n-          if (encoded) {\n+      if (null != transformers && !transformers.isEmpty()) {\n+        JsonTransformer.TransformationResult transfRes = null;\n+        for (JsonTransformer transformer: transformers) {\n+          transfRes = transformer.transform(value);\n+          if (null != transfRes && transfRes.transformed) {\n             break;\n           }\n         }\n-        if (encoded) {\n-          gen.writeRaw(sb.toString());\n+        if (null != transfRes && transfRes.transformed) {\n+          gen.writeObject(transfRes.result);\n         } else {\n           // No custom encoders able to encode this object, write null.\n           gen.writeNull();\n", "next_change": {"commit": "6835df3dc2909fb96adc75236ecaee559e56638d", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/JsonUtils.java b/warp10/src/main/java/io/warp10/json/JsonUtils.java\nindex ad88aec4..f8b2a372 100644\n--- a/warp10/src/main/java/io/warp10/json/JsonUtils.java\n+++ b/warp10/src/main/java/io/warp10/json/JsonUtils.java\n", "chunk": "@@ -80,7 +80,11 @@ public class JsonUtils {\n           }\n         }\n         if (null != transfRes && transfRes.transformed) {\n-          gen.writeObject(transfRes.result);\n+          if (transfRes.raw && transfRes.result instanceof String) {\n+            gen.writeRawValue((String) transfRes.result);\n+          } else {\n+            gen.writeObject(transfRes.result);\n+          }\n         } else {\n           // No custom encoders able to encode this object, write null.\n           gen.writeNull();\n", "next_change": null}]}}]}}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}, {"oid": "6835df3dc2909fb96adc75236ecaee559e56638d", "committedDate": "2020-08-03 17:01:23 +0200", "message": "Add possibility for transformers to output raw JSON"}, {"oid": "d7f8c648fec765ee18bd4d7d4e9de73e07ecc539", "committedDate": "2020-08-05 14:10:24 +0200", "message": "Make fields private and add Javadoc"}, {"oid": "c0ebb0e20bf459cb985b81f2ff2afef0d2917fb4", "committedDate": "2021-04-27 15:11:01 +0200", "message": "Add JSONPRETTY/JSONCOMPACT to prettify or not JSON output"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA5MDg4NQ==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377090885", "body": "Why isn't this called by the serializer for GTS and GTS Encoders?\r\n", "bodyText": "Why isn't this called by the serializer for GTS and GTS Encoders?", "bodyHTML": "<p dir=\"auto\">Why isn't this called by the serializer for GTS and GTS Encoders?</p>", "author": "hbs", "createdAt": "2020-02-10T14:21:54Z", "path": "warp10/src/main/java/io/warp10/json/MetadataSerializer.java", "diffHunk": "@@ -0,0 +1,42 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class MetadataSerializer extends JsonSerializer<Metadata> {", "originalCommit": "1b27cd97ec7375ab4d2ab7a6d62ef1c7597e9137", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "c3df08c5715d884834a21c0047d407763459db95", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\nindex 011c061f..2d03bed7 100644\n--- a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n", "chunk": "@@ -19,24 +19,38 @@ package io.warp10.json;\n import com.fasterxml.jackson.core.JsonGenerator;\n import com.fasterxml.jackson.databind.JsonSerializer;\n import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class MetadataSerializer extends JsonSerializer<Metadata> {\n+public class MetadataSerializer extends StdSerializer<Metadata> {\n+\n+  public static final String FIELD_NAME = \"c\";\n+  public static final String FIELD_LABELS = \"l\";\n+  public static final String FIELD_ATTRIBUTES = \"a\";\n+  public static final String FIELD_LASTACTIVITY = \"la\";\n+\n+  protected MetadataSerializer() {\n+    super(Metadata.class);\n+  }\n \n   @Override\n   public void serialize(Metadata metadata, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    gen.writeStartObject();\n+    serializeMetadataFields(metadata, gen);\n+    gen.writeEndObject();\n+  }\n+\n+  public static void serializeMetadataFields(Metadata metadata, JsonGenerator gen) throws IOException {\n     String name = metadata.getName();\n     if (null == name) {\n       name = \"\";\n     }\n \n-    gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeEndObject();\n+    gen.writeStringField(FIELD_NAME, name);\n+    gen.writeObjectField(FIELD_LABELS, metadata.getLabels());\n+    gen.writeObjectField(FIELD_ATTRIBUTES, metadata.getAttributes());\n+    gen.writeNumberField(FIELD_LASTACTIVITY, metadata.getLastActivity());\n   }\n }\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\nindex 011c061f..2d03bed7 100644\n--- a/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/MetadataSerializer.java\n", "chunk": "@@ -19,24 +19,38 @@ package io.warp10.json;\n import com.fasterxml.jackson.core.JsonGenerator;\n import com.fasterxml.jackson.databind.JsonSerializer;\n import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n import io.warp10.continuum.store.thrift.data.Metadata;\n \n import java.io.IOException;\n \n-public class MetadataSerializer extends JsonSerializer<Metadata> {\n+public class MetadataSerializer extends StdSerializer<Metadata> {\n+\n+  public static final String FIELD_NAME = \"c\";\n+  public static final String FIELD_LABELS = \"l\";\n+  public static final String FIELD_ATTRIBUTES = \"a\";\n+  public static final String FIELD_LASTACTIVITY = \"la\";\n+\n+  protected MetadataSerializer() {\n+    super(Metadata.class);\n+  }\n \n   @Override\n   public void serialize(Metadata metadata, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    gen.writeStartObject();\n+    serializeMetadataFields(metadata, gen);\n+    gen.writeEndObject();\n+  }\n+\n+  public static void serializeMetadataFields(Metadata metadata, JsonGenerator gen) throws IOException {\n     String name = metadata.getName();\n     if (null == name) {\n       name = \"\";\n     }\n \n-    gen.writeStartObject();\n-    gen.writeStringField(\"c\", name);\n-    gen.writeObjectField(\"l\", metadata.getLabels());\n-    gen.writeObjectField(\"a\", metadata.getAttributes());\n-    gen.writeNumberField(\"la\", metadata.getLastActivity());\n-    gen.writeEndObject();\n+    gen.writeStringField(FIELD_NAME, name);\n+    gen.writeObjectField(FIELD_LABELS, metadata.getLabels());\n+    gen.writeObjectField(FIELD_ATTRIBUTES, metadata.getAttributes());\n+    gen.writeNumberField(FIELD_LASTACTIVITY, metadata.getLastActivity());\n   }\n }\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}]}, {"oid": "c3df08c5715d884834a21c0047d407763459db95", "url": "https://github.com/senx/warp10-platform/commit/c3df08c5715d884834a21c0047d407763459db95", "message": "Address PR comments and other fixes", "committedDate": "2020-02-11T13:07:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MTM0OA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377671348", "body": "Use the constant", "bodyText": "Use the constant", "bodyHTML": "<p dir=\"auto\">Use the constant</p>", "author": "hbs", "createdAt": "2020-02-11T14:34:36Z", "path": "warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java", "diffHunk": "@@ -0,0 +1,84 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+import com.geoxp.GeoXPLib;\n+import io.warp10.continuum.gts.GTSDecoder;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+\n+import java.io.IOException;\n+\n+public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n+\n+  protected GTSEncoderSerializer() {\n+    super(GTSEncoder.class);\n+  }\n+\n+  @Override\n+  public void serialize(GTSEncoder encoder, JsonGenerator gen, SerializerProvider provider) throws IOException {\n+    Metadata metadata = encoder.getMetadata();\n+\n+    gen.writeStartObject();\n+    MetadataSerializer.serializeMetadataFields(metadata, gen);\n+    gen.writeFieldName(\"v\");", "originalCommit": "c3df08c5715d884834a21c0047d407763459db95", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d19b437e1adfcd813f5f6be5453372c73dfc4e00", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 22967896..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -40,7 +40,7 @@ public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n \n     gen.writeStartObject();\n     MetadataSerializer.serializeMetadataFields(metadata, gen);\n-    gen.writeFieldName(\"v\");\n+    gen.writeFieldName(GeoTimeSerieSerializer.FIELD_VALUES);\n     gen.writeStartArray();\n \n     GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\nindex 22967896..b168c3f2 100644\n--- a/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n+++ b/warp10/src/main/java/io/warp10/json/GTSEncoderSerializer.java\n", "chunk": "@@ -40,7 +40,7 @@ public class GTSEncoderSerializer extends StdSerializer<GTSEncoder> {\n \n     gen.writeStartObject();\n     MetadataSerializer.serializeMetadataFields(metadata, gen);\n-    gen.writeFieldName(\"v\");\n+    gen.writeFieldName(GeoTimeSerieSerializer.FIELD_VALUES);\n     gen.writeStartArray();\n \n     GTSDecoder decoder = encoder.getUnsafeDecoder(false);\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY3MzYzNQ==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r377673635", "body": "Use the constants defined in the MetadataSerializer?", "bodyText": "Use the constants defined in the MetadataSerializer?", "bodyHTML": "<p dir=\"auto\">Use the constants defined in the MetadataSerializer?</p>", "author": "hbs", "createdAt": "2020-02-11T14:38:19Z", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1341,8 +1338,7 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n           \n           sb.append(\"{\\\"c\\\":\");", "originalCommit": "c3df08c5715d884834a21c0047d407763459db95", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "d19b437e1adfcd813f5f6be5453372c73dfc4e00", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 3868365c..869f0e26 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1335,15 +1337,19 @@ public class EgressFetchHandler extends AbstractHandler {\n           name = decoder.getName();\n           labels = lbls;\n           sb.setLength(0);\n-          \n-          sb.append(\"{\\\"c\\\":\");\n-      \n+\n+          sb.append(\"{\\\"\");\n+          sb.append(MetadataSerializer.FIELD_NAME);\n+          sb.append(\"\\\":\");\n+\n           sb.append(JsonUtils.objectToJson(name));\n \n           boolean first = true;\n-          \n-          sb.append(\",\\\"l\\\":{\");\n-          \n+\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_LABELS);\n+          sb.append(\"\\\":{\");\n+\n           for (Entry<String, String> entry: lbls.entrySet()) {\n             //\n             // Skip owner/producer labels and any other 'private' labels\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 3868365c..1ebf4bab 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1335,20 +1341,24 @@ public class EgressFetchHandler extends AbstractHandler {\n           name = decoder.getName();\n           labels = lbls;\n           sb.setLength(0);\n-          \n-          sb.append(\"{\\\"c\\\":\");\n-      \n+\n+          sb.append(\"{\\\"\");\n+          sb.append(MetadataSerializer.FIELD_NAME);\n+          sb.append(\"\\\":\");\n+\n           sb.append(JsonUtils.objectToJson(name));\n \n           boolean first = true;\n-          \n-          sb.append(\",\\\"l\\\":{\");\n-          \n+\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_LABELS);\n+          sb.append(\"\\\":{\");\n+\n           for (Entry<String, String> entry: lbls.entrySet()) {\n             //\n             // Skip owner/producer labels and any other 'private' labels\n             //\n-            if (!signed) {\n+            if (!signed && !Constants.EXPOSE_OWNER_PRODUCER && !expose) {\n               if (Constants.PRODUCER_LABEL.equals(entry.getKey())) {\n                 continue;\n               }\n", "next_change": {"commit": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 1ebf4bab..8818617f 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1364,13 +1557,13 @@ public class EgressFetchHandler extends AbstractHandler {\n               }\n               if (Constants.OWNER_LABEL.equals(entry.getKey())) {\n                 continue;\n-              }            \n+              }\n             }\n-            \n+\n             if (!first) {\n               sb.append(\",\");\n             }\n-            \n+\n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n", "next_change": {"commit": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8818617f..8f5a7546 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1557,13 +1488,13 @@ public class EgressFetchHandler extends AbstractHandler {\n               }\n               if (Constants.OWNER_LABEL.equals(entry.getKey())) {\n                 continue;\n-              }\n+              }            \n             }\n-\n+            \n             if (!first) {\n               sb.append(\",\");\n             }\n-\n+            \n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n", "next_change": {"commit": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8f5a7546..c726bf26 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1488,13 +1555,13 @@ public class EgressFetchHandler extends AbstractHandler {\n               }\n               if (Constants.OWNER_LABEL.equals(entry.getKey())) {\n                 continue;\n-              }            \n+              }\n             }\n-            \n+\n             if (!first) {\n               sb.append(\",\");\n             }\n-            \n+\n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "0cc5249f912650f67b1605f475e90937754ed0c9", "committedDate": "2020-03-02 13:42:32 +0100", "message": "Added support for nocache/nopersist configuration in /api/v0/fetch"}, {"oid": "50c35198c720f21a47f14286ba7799822e244f9a", "committedDate": "2020-03-03 17:03:51 +0100", "message": "Fixes #680 - Only check if count is specified when timespan is negative."}, {"oid": "c494c8bf67504de418d5571c37caf21fb892250e", "committedDate": "2020-03-24 16:56:46 +0100", "message": "Merge pull request #666 from hbs/inmem-accelerator"}, {"oid": "62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "committedDate": "2020-04-09 22:22:15 +0200", "message": "Fixes #716 - Modified exit checks. Converted boundary length to long."}, {"oid": "5952e81ef72f0596e474e20819d453ec2546ad8d", "committedDate": "2020-04-22 15:59:02 +0200", "message": "Simplify constant conditions and constant variables"}, {"oid": "83020139d04c19ab0291fb87d2d520c341426a2b", "committedDate": "2020-05-01 15:37:35 +0200", "message": "Added support for configuring default accelerator strategies"}, {"oid": "4dac47241a0bdb230d8bd58bf7b17bfe571308b5", "committedDate": "2020-05-05 13:11:23 +0200", "message": "Merge branch 'master' into accelerator.default"}, {"oid": "679a16a39c683e77dde83246cad5aeb0a0ae46a2", "committedDate": "2020-05-05 13:21:42 +0200", "message": "Addressed PR comments"}, {"oid": "d4c86f2381b31511a8923160ab63640e3afc1c3b", "committedDate": "2020-05-05 21:01:23 +0200", "message": "Remove archive endpoint"}, {"oid": "72096842f568b1d3aecfeb24a5f4ce4952aea4b6", "committedDate": "2020-05-06 17:19:15 +0200", "message": "Merge pull request #751 from hbs/accelerator.default"}, {"oid": "96b8866ee9d3c86265a6b85dec2ff08962a73d97", "committedDate": "2020-05-27 11:33:52 +0200", "message": "Refactored Accelerator Config for WarpScript lib compatibility"}, {"oid": "590b26d2cbe9c6cbd9e134169a3eb34c7e59f79c", "committedDate": "2020-06-05 23:25:29 +0200", "message": "Initial commit of step and timestep support for data retrieval"}, {"oid": "dfd6e2f4e27c476f431638e3fe5b52d541af13f7", "committedDate": "2020-06-06 09:28:59 +0200", "message": "Refactored to introduce FetchRequest to simplify signatures"}, {"oid": "e07598603051ad7fa838f08bfec01a2aa247f958", "committedDate": "2020-06-09 23:01:26 +0200", "message": "Added support for advanced fetch parameters in Warp10InputFormat"}, {"oid": "879ad4092491eda3b08f942710d5bdc6b1e90c69", "committedDate": "2020-06-19 19:06:51 +0200", "message": "Addressed PR comments"}, {"oid": "a0ce525c9e1ce3800077185cdcb8e40b012ea9ba", "committedDate": "2020-07-16 15:47:06 +0200", "message": "Added fix for split fetching in which case rtoken is null"}, {"oid": "0ccbdeb7d82c7c49179bf1dfb45a9f2bc7b4e22a", "committedDate": "2020-09-18 12:30:12 +0200", "message": "Reuse Random instance for onetimepad generation"}, {"oid": "be074ce3244a4dd07116f984d387c2f102ae7baf", "committedDate": "2020-09-18 12:34:32 +0200", "message": "Use ThreadLocalRandom to avoid contention"}, {"oid": "551d6c7b184d9874baa236fb282d165fb4c8fc19", "committedDate": "2020-10-09 11:22:20 +0200", "message": "Added support for fetching HBase cell TTLs."}, {"oid": "aa34e708809bd88e4d61ed05e78594349ad8bc53", "committedDate": "2020-11-09 17:14:53 +0100", "message": "400 error codes and clearer status messages for bad parameters"}, {"oid": "7b68e8cd0a3fbbede7181a68ac308ca213e762bc", "committedDate": "2020-11-10 17:18:57 +0100", "message": "More detailled error messages for /update"}, {"oid": "2c4cb6dd7d03ffc3cff1bcc54acc7d5ea63a1721", "committedDate": "2020-12-08 11:59:58 +0100", "message": "Remove dead code"}, {"oid": "5391746198caf205379f27ed8869286209c6bc54", "committedDate": "2021-04-21 11:26:20 +0200", "message": "Add .noauth, .nometa and .nofetch attributes for read tokens"}, {"oid": "fcf98bc9b20399739c3007cceb18e129dc683b3e", "committedDate": "2021-04-27 12:32:10 +0200", "message": "Change .nometa to .nofind for read tokens"}, {"oid": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "committedDate": "2021-07-09 10:53:57 +0200", "message": "Added support for token attributes in EgressFetchHandler"}, {"oid": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "committedDate": "2021-07-12 15:23:43 +0200", "message": "Remove unused variables and fields"}, {"oid": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "committedDate": "2021-07-13 11:12:49 +0200", "message": "Addressed PR comments"}, {"oid": "f21f8f77ac3618283721a8321564afa8a332dad0", "committedDate": "2021-07-16 14:11:10 +0200", "message": "Resolved merge conflict"}, {"oid": "757d17217c94c854df32481d400ca77850496e82", "committedDate": "2021-10-14 00:40:43 +0200", "message": "Added gskip/gcount parameters"}, {"oid": "a736b000b485c80f73ff1212f27ec3c7f4873ae9", "committedDate": "2021-10-19 16:22:11 +0200", "message": "Addressed PR comments. Added params gskip/gcount to FETCH and FIND"}, {"oid": "3eb7452f98d09229b0fbe0e73f83827fb2560c5e", "committedDate": "2021-10-20 15:27:36 +0200", "message": "Fixed conditional bug. Changed HashSet instances into LinkedHashSet to retain order"}, {"oid": "cf48879d1384d14870b40e2a67ce12043c685acf", "committedDate": "2022-01-25 23:16:11 +0100", "message": "Modified the cases when the GTS cache file is used"}, {"oid": "f879aefc9399136e4fd07b5a58f1b2b8cecf879b", "committedDate": "2022-05-09 17:39:32 +0200", "message": "Added buffered version of encodeTo{Stream,Writer}. Changed EgressFetchHandler to use it with 100000 bytes buffer."}, {"oid": "f394f837d748835f9afdf8d6b1b6df9b4faec875", "committedDate": "2022-05-20 17:06:22 +0200", "message": "Modified to use stable buffer"}, {"oid": "11df13673124d676b001c194be72b18a655b3ca0", "committedDate": "2022-06-23 09:56:13 +0200", "message": "Added header indicating the time unit used by the platform"}, {"oid": "9cd68aa9bce8b19e1c990f5ddd2b1fc473b60dd2", "committedDate": "2022-08-29 13:58:00 +0200", "message": "Added propagation of ReadToken in GTSSplit"}]}, {"oid": "d19b437e1adfcd813f5f6be5453372c73dfc4e00", "url": "https://github.com/senx/warp10-platform/commit/d19b437e1adfcd813f5f6be5453372c73dfc4e00", "message": "Add RealVector and RealMatrix serialization, use of constants and minor fixes", "committedDate": "2020-02-12T14:24:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MzAyMg==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r378543022", "body": "FIELD_ID", "bodyText": "FIELD_ID", "bodyHTML": "<p dir=\"auto\">FIELD_ID</p>", "author": "hbs", "createdAt": "2020-02-12T22:12:04Z", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1365,38 +1367,40 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           sb.append(\"}\");\n-          \n-          sb.append(\",\\\"a\\\":{\");\n+\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_ATTRIBUTES);\n+          sb.append(\"\\\":{\");\n \n           first = true;\n           for (Entry<String, String> entry: decoder.getMetadata().getAttributes().entrySet()) {\n             if (!first) {\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           \n           sb.append(\"}\");\n           sb.append(\",\\\"i\\\":\\\"\");", "originalCommit": "d19b437e1adfcd813f5f6be5453372c73dfc4e00", "replyToReviewId": null, "replies": null, "type": "inlineReview", "revised_code": {"commit": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 869f0e26..f92ae13d 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1391,7 +1391,9 @@ public class EgressFetchHandler extends AbstractHandler {\n           }\n           \n           sb.append(\"}\");\n-          sb.append(\",\\\"i\\\":\\\"\");\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_LABELSID);\n+          sb.append(\"\\\":\\\"\");\n           sb.append(decoder.getLabelsId() & mask);\n           sb.append(\"\\\",\\\"\");\n           sb.append(MetadataSerializer.FIELD_LASTACTIVITY);\n", "next_change": {"commit": "654d9c9a61c765bbeb10bfea9d42a23d54e72092", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex f92ae13d..74e6949c 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1392,7 +1394,7 @@ public class EgressFetchHandler extends AbstractHandler {\n           \n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n-          sb.append(MetadataSerializer.FIELD_LABELSID);\n+          sb.append(FIELD_ID);\n           sb.append(\"\\\":\\\"\");\n           sb.append(decoder.getLabelsId() & mask);\n           sb.append(\"\\\",\\\"\");\n", "next_change": null}]}}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 869f0e26..1ebf4bab 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1391,7 +1395,9 @@ public class EgressFetchHandler extends AbstractHandler {\n           }\n           \n           sb.append(\"}\");\n-          sb.append(\",\\\"i\\\":\\\"\");\n+          sb.append(\",\\\"\");\n+          sb.append(FIELD_ID);\n+          sb.append(\"\\\":\\\"\");\n           sb.append(decoder.getLabelsId() & mask);\n           sb.append(\"\\\",\\\"\");\n           sb.append(MetadataSerializer.FIELD_LASTACTIVITY);\n", "next_change": {"commit": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 1ebf4bab..8818617f 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1387,13 +1580,13 @@ public class EgressFetchHandler extends AbstractHandler {\n             if (!first) {\n               sb.append(\",\");\n             }\n-            \n+\n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n-          \n+\n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n           sb.append(FIELD_ID);\n", "next_change": {"commit": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8818617f..8f5a7546 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1580,13 +1511,13 @@ public class EgressFetchHandler extends AbstractHandler {\n             if (!first) {\n               sb.append(\",\");\n             }\n-\n+            \n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n-\n+          \n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n           sb.append(FIELD_ID);\n", "next_change": {"commit": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8f5a7546..c726bf26 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1511,13 +1578,13 @@ public class EgressFetchHandler extends AbstractHandler {\n             if (!first) {\n               sb.append(\",\");\n             }\n-            \n+\n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n-          \n+\n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n           sb.append(FIELD_ID);\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "0cc5249f912650f67b1605f475e90937754ed0c9", "committedDate": "2020-03-02 13:42:32 +0100", "message": "Added support for nocache/nopersist configuration in /api/v0/fetch"}, {"oid": "50c35198c720f21a47f14286ba7799822e244f9a", "committedDate": "2020-03-03 17:03:51 +0100", "message": "Fixes #680 - Only check if count is specified when timespan is negative."}, {"oid": "c494c8bf67504de418d5571c37caf21fb892250e", "committedDate": "2020-03-24 16:56:46 +0100", "message": "Merge pull request #666 from hbs/inmem-accelerator"}, {"oid": "62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "committedDate": "2020-04-09 22:22:15 +0200", "message": "Fixes #716 - Modified exit checks. Converted boundary length to long."}, {"oid": "5952e81ef72f0596e474e20819d453ec2546ad8d", "committedDate": "2020-04-22 15:59:02 +0200", "message": "Simplify constant conditions and constant variables"}, {"oid": "83020139d04c19ab0291fb87d2d520c341426a2b", "committedDate": "2020-05-01 15:37:35 +0200", "message": "Added support for configuring default accelerator strategies"}, {"oid": "4dac47241a0bdb230d8bd58bf7b17bfe571308b5", "committedDate": "2020-05-05 13:11:23 +0200", "message": "Merge branch 'master' into accelerator.default"}, {"oid": "679a16a39c683e77dde83246cad5aeb0a0ae46a2", "committedDate": "2020-05-05 13:21:42 +0200", "message": "Addressed PR comments"}, {"oid": "d4c86f2381b31511a8923160ab63640e3afc1c3b", "committedDate": "2020-05-05 21:01:23 +0200", "message": "Remove archive endpoint"}, {"oid": "72096842f568b1d3aecfeb24a5f4ce4952aea4b6", "committedDate": "2020-05-06 17:19:15 +0200", "message": "Merge pull request #751 from hbs/accelerator.default"}, {"oid": "96b8866ee9d3c86265a6b85dec2ff08962a73d97", "committedDate": "2020-05-27 11:33:52 +0200", "message": "Refactored Accelerator Config for WarpScript lib compatibility"}, {"oid": "590b26d2cbe9c6cbd9e134169a3eb34c7e59f79c", "committedDate": "2020-06-05 23:25:29 +0200", "message": "Initial commit of step and timestep support for data retrieval"}, {"oid": "dfd6e2f4e27c476f431638e3fe5b52d541af13f7", "committedDate": "2020-06-06 09:28:59 +0200", "message": "Refactored to introduce FetchRequest to simplify signatures"}, {"oid": "e07598603051ad7fa838f08bfec01a2aa247f958", "committedDate": "2020-06-09 23:01:26 +0200", "message": "Added support for advanced fetch parameters in Warp10InputFormat"}, {"oid": "879ad4092491eda3b08f942710d5bdc6b1e90c69", "committedDate": "2020-06-19 19:06:51 +0200", "message": "Addressed PR comments"}, {"oid": "a0ce525c9e1ce3800077185cdcb8e40b012ea9ba", "committedDate": "2020-07-16 15:47:06 +0200", "message": "Added fix for split fetching in which case rtoken is null"}, {"oid": "0ccbdeb7d82c7c49179bf1dfb45a9f2bc7b4e22a", "committedDate": "2020-09-18 12:30:12 +0200", "message": "Reuse Random instance for onetimepad generation"}, {"oid": "be074ce3244a4dd07116f984d387c2f102ae7baf", "committedDate": "2020-09-18 12:34:32 +0200", "message": "Use ThreadLocalRandom to avoid contention"}, {"oid": "551d6c7b184d9874baa236fb282d165fb4c8fc19", "committedDate": "2020-10-09 11:22:20 +0200", "message": "Added support for fetching HBase cell TTLs."}, {"oid": "aa34e708809bd88e4d61ed05e78594349ad8bc53", "committedDate": "2020-11-09 17:14:53 +0100", "message": "400 error codes and clearer status messages for bad parameters"}, {"oid": "7b68e8cd0a3fbbede7181a68ac308ca213e762bc", "committedDate": "2020-11-10 17:18:57 +0100", "message": "More detailled error messages for /update"}, {"oid": "2c4cb6dd7d03ffc3cff1bcc54acc7d5ea63a1721", "committedDate": "2020-12-08 11:59:58 +0100", "message": "Remove dead code"}, {"oid": "5391746198caf205379f27ed8869286209c6bc54", "committedDate": "2021-04-21 11:26:20 +0200", "message": "Add .noauth, .nometa and .nofetch attributes for read tokens"}, {"oid": "fcf98bc9b20399739c3007cceb18e129dc683b3e", "committedDate": "2021-04-27 12:32:10 +0200", "message": "Change .nometa to .nofind for read tokens"}, {"oid": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "committedDate": "2021-07-09 10:53:57 +0200", "message": "Added support for token attributes in EgressFetchHandler"}, {"oid": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "committedDate": "2021-07-12 15:23:43 +0200", "message": "Remove unused variables and fields"}, {"oid": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "committedDate": "2021-07-13 11:12:49 +0200", "message": "Addressed PR comments"}, {"oid": "f21f8f77ac3618283721a8321564afa8a332dad0", "committedDate": "2021-07-16 14:11:10 +0200", "message": "Resolved merge conflict"}, {"oid": "757d17217c94c854df32481d400ca77850496e82", "committedDate": "2021-10-14 00:40:43 +0200", "message": "Added gskip/gcount parameters"}, {"oid": "a736b000b485c80f73ff1212f27ec3c7f4873ae9", "committedDate": "2021-10-19 16:22:11 +0200", "message": "Addressed PR comments. Added params gskip/gcount to FETCH and FIND"}, {"oid": "3eb7452f98d09229b0fbe0e73f83827fb2560c5e", "committedDate": "2021-10-20 15:27:36 +0200", "message": "Fixed conditional bug. Changed HashSet instances into LinkedHashSet to retain order"}, {"oid": "cf48879d1384d14870b40e2a67ce12043c685acf", "committedDate": "2022-01-25 23:16:11 +0100", "message": "Modified the cases when the GTS cache file is used"}, {"oid": "f879aefc9399136e4fd07b5a58f1b2b8cecf879b", "committedDate": "2022-05-09 17:39:32 +0200", "message": "Added buffered version of encodeTo{Stream,Writer}. Changed EgressFetchHandler to use it with 100000 bytes buffer."}, {"oid": "f394f837d748835f9afdf8d6b1b6df9b4faec875", "committedDate": "2022-05-20 17:06:22 +0200", "message": "Modified to use stable buffer"}, {"oid": "11df13673124d676b001c194be72b18a655b3ca0", "committedDate": "2022-06-23 09:56:13 +0200", "message": "Added header indicating the time unit used by the platform"}, {"oid": "9cd68aa9bce8b19e1c990f5ddd2b1fc473b60dd2", "committedDate": "2022-08-29 13:58:00 +0200", "message": "Added propagation of ReadToken in GTSSplit"}]}, {"oid": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4", "url": "https://github.com/senx/warp10-platform/commit/f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4", "message": "Add constant for labels ids field name", "committedDate": "2020-02-14T10:42:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2OTEwOA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379369108", "body": "It is a an id, not directly the labelsId, so better call this field FIELD_ID as it could very well not stay related to the labels id only", "bodyText": "It is a an id, not directly the labelsId, so better call this field FIELD_ID as it could very well not stay related to the labels id only", "bodyHTML": "<p dir=\"auto\">It is a an id, not directly the labelsId, so better call this field FIELD_ID as it could very well not stay related to the labels id only</p>", "author": "hbs", "createdAt": "2020-02-14T10:55:15Z", "path": "warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java", "diffHunk": "@@ -1365,38 +1367,42 @@ static void jsonDump(PrintWriter pw, Iterator<GTSDecoder> iter, long now, long c\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           sb.append(\"}\");\n-          \n-          sb.append(\",\\\"a\\\":{\");\n+\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_ATTRIBUTES);\n+          sb.append(\"\\\":{\");\n \n           first = true;\n           for (Entry<String, String> entry: decoder.getMetadata().getAttributes().entrySet()) {\n             if (!first) {\n               sb.append(\",\");\n             }\n             \n-            //sb.append(gson.toJson(entry.getKey()));\n-            sb.append(serializer.serialize(entry.getKey()));\n+            sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n-            //sb.append(gson.toJson(entry.getValue()));\n-            sb.append(serializer.serialize(entry.getValue()));\n+            sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n           \n           sb.append(\"}\");\n-          sb.append(\",\\\"i\\\":\\\"\");\n+          sb.append(\",\\\"\");\n+          sb.append(MetadataSerializer.FIELD_LABELSID);", "originalCommit": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MjE4OA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379372188", "bodyText": "True. As this is not related to Metadata, I have to put this constant in EgressFetchHandler.", "author": "ftence", "createdAt": "2020-02-14T11:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM2OTEwOA=="}], "type": "inlineReview", "revised_code": {"commit": "654d9c9a61c765bbeb10bfea9d42a23d54e72092", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex f92ae13d..74e6949c 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1392,7 +1394,7 @@ public class EgressFetchHandler extends AbstractHandler {\n           \n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n-          sb.append(MetadataSerializer.FIELD_LABELSID);\n+          sb.append(FIELD_ID);\n           sb.append(\"\\\":\\\"\");\n           sb.append(decoder.getLabelsId() & mask);\n           sb.append(\"\\\",\\\"\");\n", "next_change": null}]}, "revised_code_in_main": {"commit": "dbf783479129092534c50c80dd028be72aafea63", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex f92ae13d..1ebf4bab 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1392,7 +1396,7 @@ public class EgressFetchHandler extends AbstractHandler {\n           \n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n-          sb.append(MetadataSerializer.FIELD_LABELSID);\n+          sb.append(FIELD_ID);\n           sb.append(\"\\\":\\\"\");\n           sb.append(decoder.getLabelsId() & mask);\n           sb.append(\"\\\",\\\"\");\n", "next_change": {"commit": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 1ebf4bab..8818617f 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1387,13 +1580,13 @@ public class EgressFetchHandler extends AbstractHandler {\n             if (!first) {\n               sb.append(\",\");\n             }\n-            \n+\n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n-          \n+\n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n           sb.append(FIELD_ID);\n", "next_change": {"commit": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8818617f..8f5a7546 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1580,13 +1511,13 @@ public class EgressFetchHandler extends AbstractHandler {\n             if (!first) {\n               sb.append(\",\");\n             }\n-\n+            \n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n-\n+          \n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n           sb.append(FIELD_ID);\n", "next_change": {"commit": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\nindex 8f5a7546..c726bf26 100644\n--- a/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n+++ b/warp10/src/main/java/io/warp10/continuum/egress/EgressFetchHandler.java\n", "chunk": "@@ -1511,13 +1578,13 @@ public class EgressFetchHandler extends AbstractHandler {\n             if (!first) {\n               sb.append(\",\");\n             }\n-            \n+\n             sb.append(JsonUtils.objectToJson(entry.getKey()));\n             sb.append(\":\");\n             sb.append(JsonUtils.objectToJson(entry.getValue()));\n             first = false;\n           }\n-          \n+\n           sb.append(\"}\");\n           sb.append(\",\\\"\");\n           sb.append(FIELD_ID);\n", "next_change": null}]}}]}}]}}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "0cc5249f912650f67b1605f475e90937754ed0c9", "committedDate": "2020-03-02 13:42:32 +0100", "message": "Added support for nocache/nopersist configuration in /api/v0/fetch"}, {"oid": "50c35198c720f21a47f14286ba7799822e244f9a", "committedDate": "2020-03-03 17:03:51 +0100", "message": "Fixes #680 - Only check if count is specified when timespan is negative."}, {"oid": "c494c8bf67504de418d5571c37caf21fb892250e", "committedDate": "2020-03-24 16:56:46 +0100", "message": "Merge pull request #666 from hbs/inmem-accelerator"}, {"oid": "62c43870228a003a9bc4b002d4c1dd8ad28de5dc", "committedDate": "2020-04-09 22:22:15 +0200", "message": "Fixes #716 - Modified exit checks. Converted boundary length to long."}, {"oid": "5952e81ef72f0596e474e20819d453ec2546ad8d", "committedDate": "2020-04-22 15:59:02 +0200", "message": "Simplify constant conditions and constant variables"}, {"oid": "83020139d04c19ab0291fb87d2d520c341426a2b", "committedDate": "2020-05-01 15:37:35 +0200", "message": "Added support for configuring default accelerator strategies"}, {"oid": "4dac47241a0bdb230d8bd58bf7b17bfe571308b5", "committedDate": "2020-05-05 13:11:23 +0200", "message": "Merge branch 'master' into accelerator.default"}, {"oid": "679a16a39c683e77dde83246cad5aeb0a0ae46a2", "committedDate": "2020-05-05 13:21:42 +0200", "message": "Addressed PR comments"}, {"oid": "d4c86f2381b31511a8923160ab63640e3afc1c3b", "committedDate": "2020-05-05 21:01:23 +0200", "message": "Remove archive endpoint"}, {"oid": "72096842f568b1d3aecfeb24a5f4ce4952aea4b6", "committedDate": "2020-05-06 17:19:15 +0200", "message": "Merge pull request #751 from hbs/accelerator.default"}, {"oid": "96b8866ee9d3c86265a6b85dec2ff08962a73d97", "committedDate": "2020-05-27 11:33:52 +0200", "message": "Refactored Accelerator Config for WarpScript lib compatibility"}, {"oid": "590b26d2cbe9c6cbd9e134169a3eb34c7e59f79c", "committedDate": "2020-06-05 23:25:29 +0200", "message": "Initial commit of step and timestep support for data retrieval"}, {"oid": "dfd6e2f4e27c476f431638e3fe5b52d541af13f7", "committedDate": "2020-06-06 09:28:59 +0200", "message": "Refactored to introduce FetchRequest to simplify signatures"}, {"oid": "e07598603051ad7fa838f08bfec01a2aa247f958", "committedDate": "2020-06-09 23:01:26 +0200", "message": "Added support for advanced fetch parameters in Warp10InputFormat"}, {"oid": "879ad4092491eda3b08f942710d5bdc6b1e90c69", "committedDate": "2020-06-19 19:06:51 +0200", "message": "Addressed PR comments"}, {"oid": "a0ce525c9e1ce3800077185cdcb8e40b012ea9ba", "committedDate": "2020-07-16 15:47:06 +0200", "message": "Added fix for split fetching in which case rtoken is null"}, {"oid": "0ccbdeb7d82c7c49179bf1dfb45a9f2bc7b4e22a", "committedDate": "2020-09-18 12:30:12 +0200", "message": "Reuse Random instance for onetimepad generation"}, {"oid": "be074ce3244a4dd07116f984d387c2f102ae7baf", "committedDate": "2020-09-18 12:34:32 +0200", "message": "Use ThreadLocalRandom to avoid contention"}, {"oid": "551d6c7b184d9874baa236fb282d165fb4c8fc19", "committedDate": "2020-10-09 11:22:20 +0200", "message": "Added support for fetching HBase cell TTLs."}, {"oid": "aa34e708809bd88e4d61ed05e78594349ad8bc53", "committedDate": "2020-11-09 17:14:53 +0100", "message": "400 error codes and clearer status messages for bad parameters"}, {"oid": "7b68e8cd0a3fbbede7181a68ac308ca213e762bc", "committedDate": "2020-11-10 17:18:57 +0100", "message": "More detailled error messages for /update"}, {"oid": "2c4cb6dd7d03ffc3cff1bcc54acc7d5ea63a1721", "committedDate": "2020-12-08 11:59:58 +0100", "message": "Remove dead code"}, {"oid": "5391746198caf205379f27ed8869286209c6bc54", "committedDate": "2021-04-21 11:26:20 +0200", "message": "Add .noauth, .nometa and .nofetch attributes for read tokens"}, {"oid": "fcf98bc9b20399739c3007cceb18e129dc683b3e", "committedDate": "2021-04-27 12:32:10 +0200", "message": "Change .nometa to .nofind for read tokens"}, {"oid": "74a9671e6abedd2b5bb1f0baa0dcadf72f0f3d58", "committedDate": "2021-07-09 10:53:57 +0200", "message": "Added support for token attributes in EgressFetchHandler"}, {"oid": "e826ea374df18f9d0ff413872ebf5ddd1ad0bd17", "committedDate": "2021-07-12 15:23:43 +0200", "message": "Remove unused variables and fields"}, {"oid": "ca6bdb3976d3b4a2f7bc13725de60be114969521", "committedDate": "2021-07-13 11:12:49 +0200", "message": "Addressed PR comments"}, {"oid": "f21f8f77ac3618283721a8321564afa8a332dad0", "committedDate": "2021-07-16 14:11:10 +0200", "message": "Resolved merge conflict"}, {"oid": "757d17217c94c854df32481d400ca77850496e82", "committedDate": "2021-10-14 00:40:43 +0200", "message": "Added gskip/gcount parameters"}, {"oid": "a736b000b485c80f73ff1212f27ec3c7f4873ae9", "committedDate": "2021-10-19 16:22:11 +0200", "message": "Addressed PR comments. Added params gskip/gcount to FETCH and FIND"}, {"oid": "3eb7452f98d09229b0fbe0e73f83827fb2560c5e", "committedDate": "2021-10-20 15:27:36 +0200", "message": "Fixed conditional bug. Changed HashSet instances into LinkedHashSet to retain order"}, {"oid": "cf48879d1384d14870b40e2a67ce12043c685acf", "committedDate": "2022-01-25 23:16:11 +0100", "message": "Modified the cases when the GTS cache file is used"}, {"oid": "f879aefc9399136e4fd07b5a58f1b2b8cecf879b", "committedDate": "2022-05-09 17:39:32 +0200", "message": "Added buffered version of encodeTo{Stream,Writer}. Changed EgressFetchHandler to use it with 100000 bytes buffer."}, {"oid": "f394f837d748835f9afdf8d6b1b6df9b4faec875", "committedDate": "2022-05-20 17:06:22 +0200", "message": "Modified to use stable buffer"}, {"oid": "11df13673124d676b001c194be72b18a655b3ca0", "committedDate": "2022-06-23 09:56:13 +0200", "message": "Added header indicating the time unit used by the platform"}, {"oid": "9cd68aa9bce8b19e1c990f5ddd2b1fc473b60dd2", "committedDate": "2022-08-29 13:58:00 +0200", "message": "Added propagation of ReadToken in GTSSplit"}]}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MDM0Mg==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379370342", "body": "Are integer numbers correctly converted to LONGs by this?", "bodyText": "Are integer numbers correctly converted to LONGs by this?", "bodyHTML": "<p dir=\"auto\">Are integer numbers correctly converted to LONGs by this?</p>", "author": "hbs", "createdAt": "2020-02-14T10:58:03Z", "path": "warp10/src/main/java/io/warp10/json/JsonUtils.java", "diffHunk": "@@ -0,0 +1,214 @@\n+//\n+//   Copyright 2020  SenX S.A.S.\n+//\n+//   Licensed under the Apache License, Version 2.0 (the \"License\");\n+//   you may not use this file except in compliance with the License.\n+//   You may obtain a copy of the License at\n+//\n+//     http://www.apache.org/licenses/LICENSE-2.0\n+//\n+//   Unless required by applicable law or agreed to in writing, software\n+//   distributed under the License is distributed on an \"AS IS\" BASIS,\n+//   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+//   See the License for the specific language governing permissions and\n+//   limitations under the License.\n+//\n+\n+package io.warp10.json;\n+\n+import com.fasterxml.jackson.core.JsonFactoryBuilder;\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.StreamWriteFeature;\n+import com.fasterxml.jackson.core.json.JsonReadFeature;\n+import com.fasterxml.jackson.core.json.JsonWriteFeature;\n+import com.fasterxml.jackson.databind.BeanDescription;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.SerializationConfig;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.module.SimpleModule;\n+import com.fasterxml.jackson.databind.ser.BeanSerializer;\n+import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;\n+import com.fasterxml.jackson.databind.ser.impl.UnknownSerializer;\n+import io.warp10.continuum.gts.GTSEncoder;\n+import io.warp10.continuum.gts.GeoTimeSerie;\n+import io.warp10.continuum.store.thrift.data.Metadata;\n+import io.warp10.script.NamedWarpScriptFunction;\n+import io.warp10.script.WarpScriptStack;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+import java.io.Writer;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class JsonUtils {\n+\n+  /**\n+   * A serializer for null keys.\n+   * Outputs \"null\" because most javascript engines coerce null to \"null\" when using it as a key.\n+   */\n+  private static class NullKeySerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      gen.writeFieldName(\"null\");\n+    }\n+  }\n+\n+  /**\n+   * Used to swap UnknownSerializer and BeanSerializer for CustomEncodersSerializer.\n+   */\n+  public static class NotSerializedToCustomSerializedModifier extends BeanSerializerModifier {\n+    @Override\n+    public JsonSerializer<?> modifySerializer(SerializationConfig config, BeanDescription beanDesc, JsonSerializer<?> serializer) {\n+      if (serializer instanceof UnknownSerializer || serializer instanceof BeanSerializer) {\n+        return customEncodersSerializer;\n+      } else {\n+        return serializer;\n+      }\n+    }\n+  }\n+\n+  public static class CustomEncodersSerializer extends JsonSerializer<Object> {\n+    @Override\n+    public void serialize(Object value, JsonGenerator gen, SerializerProvider serializers) throws IOException {\n+      if (null != encoders && !encoders.isEmpty()) {\n+        StringBuilder sb = new StringBuilder();\n+        boolean encoded = false;\n+        for (JsonEncoder encoder: encoders) {\n+          encoded = encoder.addElement(sb, value);\n+          if (encoded) {\n+            break;\n+          }\n+        }\n+        if (encoded) {\n+          gen.writeRaw(sb.toString());\n+        } else {\n+          // No custom encoders able to encode this object, write null.\n+          gen.writeNull();\n+        }\n+      } else {\n+        // No custom encoders defined, write null.\n+        gen.writeNull();\n+      }\n+    }\n+  }\n+\n+  public static final NullKeySerializer nullKeySerializer = new NullKeySerializer();\n+  public static final CustomEncodersSerializer customEncodersSerializer = new CustomEncodersSerializer();\n+\n+  //\n+  // ObjectMapper instances are thread-safe, so we can safely use a single static instance.\n+  //\n+  private static final ObjectMapper strictMapper;\n+  private static final ObjectMapper looseMapper;\n+\n+  public interface JsonEncoder {\n+    boolean addElement(StringBuilder sb, Object o);\n+  }\n+\n+  private static List<JsonEncoder> encoders;\n+\n+  static {\n+    //\n+    // Configure a module to handle the serialization of non-base classes.\n+    //\n+    SimpleModule module = new SimpleModule();\n+    // Add the NotSerializedToCustomSerializedModifier instance\n+    module.setSerializerModifier(new NotSerializedToCustomSerializedModifier());\n+    // Add core custom serializers\n+    module.addSerializer(new GeoTimeSerieSerializer());\n+    module.addSerializer(new GTSEncoderSerializer());\n+    module.addSerializer(new MetadataSerializer());\n+    module.addSerializer(new NamedWarpScriptFunctionSerializer());\n+    module.addSerializer(new MacroSerializer());\n+    module.addSerializer(new BytesSerializer());\n+    module.addSerializer(new RealVectorSerializer());\n+    module.addSerializer(new RealMatrixSerializer());\n+\n+    //\n+    // Common configuration for both strict and loose mappers.\n+    //\n+    JsonFactoryBuilder builder = new JsonFactoryBuilder();\n+    builder.enable(JsonReadFeature.ALLOW_NON_NUMERIC_NUMBERS);\n+    builder.enable(JsonReadFeature.ALLOW_MISSING_VALUES);\n+    builder.enable(JsonWriteFeature.ESCAPE_NON_ASCII);\n+    builder.disable(JsonWriteFeature.WRITE_NUMBERS_AS_STRINGS);\n+    builder.disable(StreamWriteFeature.AUTO_CLOSE_TARGET);\n+\n+    //\n+    // Configure strict mapper\n+    //\n+    builder.enable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n+    strictMapper = new ObjectMapper(builder.build());\n+    strictMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n+    strictMapper.registerModule(module);\n+\n+    //\n+    // Configure loose mapper\n+    //\n+    builder.disable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n+    looseMapper = new ObjectMapper(builder.build());\n+    looseMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n+    looseMapper.registerModule(module);\n+  }\n+\n+  //\n+  // Method to deserialize JSON to Objects.\n+  //\n+\n+  public static Object jsonToObject(String json) throws JsonProcessingException {\n+    return strictMapper.readValue(json, Object.class);", "originalCommit": "f4e1b2b6977dd432d50ccb33033ffd53d5bd55d4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MzY5OA==", "url": "https://github.com/senx/warp10-platform/pull/660#discussion_r379373698", "bodyText": "Yes, and floating-point numbers to Double.", "author": "ftence", "createdAt": "2020-02-14T11:05:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTM3MDM0Mg=="}], "type": "inlineReview", "revised_code": null, "revised_code_in_main": {"commit": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/JsonUtils.java b/warp10/src/main/java/io/warp10/json/JsonUtils.java\nindex 3bebd63c..ad88aec4 100644\n--- a/warp10/src/main/java/io/warp10/json/JsonUtils.java\n+++ b/warp10/src/main/java/io/warp10/json/JsonUtils.java\n", "chunk": "@@ -141,17 +157,17 @@ public class JsonUtils {\n     // Configure strict mapper\n     //\n     builder.enable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n-    strictMapper = new ObjectMapper(builder.build());\n-    strictMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n-    strictMapper.registerModule(module);\n+    STRICT_MAPPER = new ObjectMapper(builder.build());\n+    STRICT_MAPPER.getSerializerProvider().setNullKeySerializer(NULL_KEY_SERIALIZER);\n+    STRICT_MAPPER.registerModule(module);\n \n     //\n     // Configure loose mapper\n     //\n     builder.disable(JsonWriteFeature.WRITE_NAN_AS_STRINGS);\n-    looseMapper = new ObjectMapper(builder.build());\n-    looseMapper.getSerializerProvider().setNullKeySerializer(nullKeySerializer);\n-    looseMapper.registerModule(module);\n+    LOOSE_MAPPER = new ObjectMapper(builder.build());\n+    LOOSE_MAPPER.getSerializerProvider().setNullKeySerializer(NULL_KEY_SERIALIZER);\n+    LOOSE_MAPPER.registerModule(module);\n   }\n \n   //\n", "next_change": {"commit": "c0ebb0e20bf459cb985b81f2ff2afef0d2917fb4", "changed_code": [{"header": "diff --git a/warp10/src/main/java/io/warp10/json/JsonUtils.java b/warp10/src/main/java/io/warp10/json/JsonUtils.java\nindex ad88aec4..afec8cb4 100644\n--- a/warp10/src/main/java/io/warp10/json/JsonUtils.java\n+++ b/warp10/src/main/java/io/warp10/json/JsonUtils.java\n", "chunk": "@@ -168,6 +200,11 @@ public class JsonUtils {\n     LOOSE_MAPPER = new ObjectMapper(builder.build());\n     LOOSE_MAPPER.getSerializerProvider().setNullKeySerializer(NULL_KEY_SERIALIZER);\n     LOOSE_MAPPER.registerModule(module);\n+    // Pretty version\n+    LOOSE_MAPPER_PRETTY = new ObjectMapper(builder.build());\n+    LOOSE_MAPPER_PRETTY.enable(SerializationFeature.INDENT_OUTPUT);\n+    LOOSE_MAPPER_PRETTY.getSerializerProvider().setNullKeySerializer(NULL_KEY_SERIALIZER);\n+    LOOSE_MAPPER_PRETTY.registerModule(module);\n   }\n \n   //\n", "next_change": null}]}}, {"header": "diff --git a/warp10/src/main/java/io/warp10/json/JsonUtils.java b/warp10/src/main/java/io/warp10/json/JsonUtils.java\nindex 3bebd63c..ad88aec4 100644\n--- a/warp10/src/main/java/io/warp10/json/JsonUtils.java\n+++ b/warp10/src/main/java/io/warp10/json/JsonUtils.java\n", "chunk": "@@ -159,7 +175,7 @@ public class JsonUtils {\n   //\n \n   public static Object jsonToObject(String json) throws JsonProcessingException {\n-    return strictMapper.readValue(json, Object.class);\n+    return STRICT_MAPPER.readValue(json, Object.class);\n   }\n \n   //\n", "next_change": null}]}, "commits_in_main": [{"oid": "dbf783479129092534c50c80dd028be72aafea63", "message": "Merge commit", "committedDate": null}, {"oid": "e9d71aecbb13e7b31824d1c9cea15c622d7b4ee6", "committedDate": "2020-07-29 16:56:20 +0200", "message": "Modify custom serialization and code clean up"}, {"oid": "6835df3dc2909fb96adc75236ecaee559e56638d", "committedDate": "2020-08-03 17:01:23 +0200", "message": "Add possibility for transformers to output raw JSON"}, {"oid": "d7f8c648fec765ee18bd4d7d4e9de73e07ecc539", "committedDate": "2020-08-05 14:10:24 +0200", "message": "Make fields private and add Javadoc"}, {"oid": "c0ebb0e20bf459cb985b81f2ff2afef0d2917fb4", "committedDate": "2021-04-27 15:11:01 +0200", "message": "Add JSONPRETTY/JSONCOMPACT to prettify or not JSON output"}]}, {"oid": "654d9c9a61c765bbeb10bfea9d42a23d54e72092", "url": "https://github.com/senx/warp10-platform/commit/654d9c9a61c765bbeb10bfea9d42a23d54e72092", "message": "Fix constant name and place to reflect the fact it is a generic id", "committedDate": "2020-02-14T11:08:38Z", "type": "commit"}]}